# Story 2.7: 平台治理前端工作台（平台用户管理 + 平台角色管理）

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 在平台入口使用统一治理工作台完成平台用户与平台角色管理,  
so that 平台治理能力可以在前端完整落地并可直接验收。

## Acceptance Criteria

1. **Given** 平台管理员进入平台工作台并打开“平台用户管理”  
   **When** 执行列表、筛选、分页、创建与状态切换  
   **Then** 前端完成对应治理操作并返回可追踪结果  
   **And** 新建/编辑使用 Modal，详情使用 Drawer
2. **Given** 平台管理员进入“平台角色管理”  
   **When** 执行角色创建、编辑、删除（受保护角色除外）  
   **Then** 前端与服务端约束保持一致  
   **And** 受保护角色仅允许授权分配，不允许修改角色定义
3. **Given** 平台管理员配置平台角色权限树并向平台用户分配 1 到 5 个角色  
   **When** 保存与分配请求成功  
   **Then** 用户平台域权限即时生效  
   **And** 超出权限范围的操作被一致拒绝
4. **Given** Story 2.7 进入交付验收  
   **When** 执行真实 Chrome Playwright 前端回归  
   **Then** 用户管理、角色管理、权限分配关键路径全部通过  
   **And** 失败项阻断 Story 完成

## Tasks / Subtasks

- [x] 任务 1：搭建平台治理前端工作台骨架（AC: 1, 2, 3）
  - [x] 在 `platform` 入口登录后的 dashboard 路径挂载“平台用户管理 / 平台角色管理”双子模块，保持当前登录与会话链路不回归。
  - [x] 复用现有 AntD 基础组件与 `Custom*` 组件（`CustomLayout`、`CustomCardTable`、`CustomFilter`、`CustomForm`），避免在 `App.jsx` 内继续堆叠超大内联 UI 逻辑。
  - [x] 建立统一页面状态骨架：列表区、筛选区、操作区、详情区（Drawer）、编辑区（Modal）、全局反馈区（message）。
  - [x] 确保平台域 UI 不依赖 tenant 上下文字段（`active_tenant_id`、`tenant_permission_context`），避免域语义混用。

- [x] 任务 2：补齐平台用户管理闭环（AC: 1）
  - [x] 对接现有用户写接口：`POST /platform/users`、`POST /platform/users/status`、`DELETE /platform/users/{user_id}`。
  - [x] 新建用户流程：Modal 提交手机号（11 位）后，展示 `created_user/reused_existing_user/request_id` 结果语义。
  - [x] 状态切换流程：支持 `active/disabled` 切换，提交时携带可选 `reason`，并在列表中即时刷新。
  - [x] 详情流程：使用 Drawer 展示用户状态、最近治理动作结果与 `request_id`（不新开详情页）。
  - [x] **差距识别（必须处理）**：当前公开契约缺少“平台用户列表/筛选/分页”读接口；在本故事内补齐最小读能力（建议 `GET /platform/users` + `GET /platform/users/{user_id}`），并同步 OpenAPI 与测试。

- [x] 任务 3：补齐平台角色管理闭环（AC: 2）
  - [x] 对接角色目录接口：`GET /platform/roles`、`POST /platform/roles`、`PATCH /platform/roles/{role_id}`、`DELETE /platform/roles/{role_id}`。
  - [x] 创建/编辑角色统一用 Modal，字段约束与服务端一致（`role_id/code/name/status`）。
  - [x] 角色详情使用 Drawer，展示角色元数据、状态、是否系统角色（`is_system`）及最近操作结果。
  - [x] 删除/编辑受保护角色（如 `sys_admin`）时，前端按后端 `ROLE-403-SYSTEM-ROLE-PROTECTED` 返回做一致拒绝提示，不在前端自造“伪成功”分支。
  - [x] 统一处理 400/401/403/404/409/413/503 错误映射，保持 Problem Details 语义直通。

- [x] 任务 4：权限树配置与角色分配生效（AC: 3）
  - [x] 权限树读写：`GET /platform/roles/{role_id}/permissions`、`PUT /platform/roles/{role_id}/permissions`。
  - [x] 权限树保存只提交最终授权 `permission_codes`（仅 `platform.*`），不提交 UI 中间态节点。
  - [x] 角色分配：对接 `POST /auth/platform/role-facts/replace`，严格执行 1-5 角色约束与去重语义。
  - [x] 分配成功后触发平台权限上下文刷新，验证“可见菜单/可操作按钮”即时变化，确保与服务端授权一致。
  - [x] 越权操作分支需保持 fail-closed：服务端拒绝即前端拒绝，不允许本地缓存权限导致误放行。

- [x] 任务 5：UX 一致性与交互约束落实（AC: 1, 2, 3）
  - [x] 新建/编辑/导入统一 Modal；详情统一 Drawer（使用 `size`，不自定义 `width`）。
  - [x] 提交按钮统一 loading + 防重复提交；回车提交同样遵守防重复。
  - [x] 字段错误走字段级提示，全局失败走 `message`，避免重复叠加噪声。
  - [x] 失败文案遵循“原因 + 请稍后重试”；成功后刷新列表并保持筛选/分页上下文不丢失。

- [x] 任务 6：真实 Chrome Playwright 门禁（AC: 4）
  - [x] 新增/扩展前端回归用例，覆盖：列表加载、筛选、分页、新建、编辑、详情 Drawer、状态切换、权限树保存、角色分配、越权拒绝。
  - [x] 仅以真实 Chrome 运行结果作为页面验收依据（`--project=chrome` 或 `channel: "chrome"`），非真实浏览器结果不得替代。
  - [x] 回归失败禁止将 Story 标记为 `done`，并将测试证据（日志/截图/trace）归档到 implementation artifacts。
  - [x] 保证 `apps/web` 现有登录/组织选择/组织切换链路回归不退化。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复内存存储层平台用户读接口状态归一化函数错误引用，避免 `listPlatformUsers` 运行时异常。[`apps/api/src/modules/auth/auth.store.memory.js:2804`]
- [x] [AI-Review][MEDIUM] 统一内存存储层关键字过滤为大小写不敏感，避免与 MySQL 读路径行为漂移。[`apps/api/src/modules/auth/auth.store.memory.js:2814`]
- [x] [AI-Review][MEDIUM] 修复平台用户列表刷新通过 `key` 重挂载导致分页上下文重置问题，改为请求函数刷新触发。[`apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx:340`]
- [x] [AI-Review][MEDIUM] 修复创建/状态变更后自动打开详情时 `latest_action` 可能读取旧快照的问题。[`apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx:194`]
- [x] [AI-Review][MEDIUM] 补充回归：内存存储层平台用户读能力测试 + Chrome 创建后详情 `latest_action` 断言。[`apps/api/test/auth.store.memory.platform-user-read.test.js:26`], [`apps/web/test/chrome.playwright.test.js:2380`]
- [x] [AI-Review][HIGH] 修复平台治理前端 API 文件以 `.js` 承载 `import.meta` 导致 `apps/web` lint 阻断的问题，改为 ESM 文件扩展并同步导入路径。[`apps/web/src/api/platform-governance.mjs:1`], [`apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx:23`]
- [x] [AI-Review][MEDIUM] 修复平台用户列表审计事件记录查询关键字明文导致潜在手机号暴露风险，统一脱敏写入审计元数据。[`apps/api/src/modules/platform/user.service.js:54`], [`apps/api/test/platform.user.api.test.js:191`]
- [x] [AI-Review][MEDIUM] 修复平台用户读模型对 `phone` 字段校验缺口，避免返回与 OpenAPI 契约不一致的空值读模型。[`apps/api/src/modules/platform/user.service.js:413`], [`apps/api/test/platform.user.api.test.js:211`], [`apps/api/test/platform.user.api.test.js:262`]

## Dev Notes

### Developer Context（开发者必须先读）

- 当前 `apps/web/src/App.jsx` 为单文件实现，核心覆盖“登录 + tenant 选择/切换 + tenant 权限展示”；平台治理工作台尚未落地。
- 代码库已存在可复用的 AntD 组件封装（`apps/web/src/components/CustomCardTable.tsx`、`apps/web/src/components/CustomFilter.tsx`、`apps/web/src/components/CustomForm.tsx`、`apps/web/src/components/CustomLayout.tsx` 等），应优先复用而不是重造。
- 后端平台治理能力已具备用户写接口与角色全量治理接口，但平台用户“读列表/筛选/分页”公开接口缺口仍在；本故事需补齐该缺口以满足 AC1。
- Story 2.6 / 2.5 的经验表明：接口契约、路由权限声明、OpenAPI、自动化测试必须同 PR 同步，不能后补。

### Technical Requirements（实现硬约束）

- API 字段遵循 `snake_case`；前端内部状态可用 `camelCase`，但必须经映射层显式转换。
- 写接口全部支持 `Idempotency-Key`：前端治理动作需统一注入，避免重复提交导致语义漂移。
- 错误处理统一按 Problem Details：至少消费 `status/detail/error_code/request_id/retryable`。
- 平台域权限边界硬约束：
  - 权限树提交仅允许 `platform.*`。
  - 角色分配仅允许平台角色事实，不得越域注入 `tenant.*` 能力。
- 角色分配必须满足 1-5 条约束（`ReplacePlatformRoleFactsRequest`）。
- 受保护角色（`sys_admin`）不允许编辑/删除角色定义，但允许分配。
- UI 必须反映服务端最终授权结果；禁止只靠前端本地状态推断“已生效”。

### Architecture Compliance（架构对齐清单）

- 前端分层建议：`page/container`（编排）+ `feature`（用户/角色/权限树业务）+ `api mapper`（契约映射）+ `components`（展示）。
- 后端若新增平台用户读接口，必须同步：
  - `apps/api/src/modules/platform/user.constants.js`
  - `apps/api/src/modules/platform/user.routes.js`
  - `apps/api/src/modules/platform/user.service.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
- 保持 `route-permissions` 与运行时路由一一对应，避免受保护接口漏声明。
- 继续沿用既有审计/错误码/幂等等语义，不引入第二套治理语义。

### Library & Framework Requirements（库与框架要求）

- 当前仓库版本（本地）：
  - `react`: `19.2.4`
  - `react-dom`: `19.2.4`
  - `vite`: `7.3.1`
  - `@vitejs/plugin-react`: `5.1.3`
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新核验（2026-02-23, +0800）：
  - Node.js Latest `v25.6.1`，Latest LTS `v24.13.1`（Krypton）
  - `antd`: `6.3.0`
  - `@tanstack/react-query`: `5.90.21`
  - `zustand`: `5.0.11`
  - `@playwright/test`: `1.58.2`
  - `@vitejs/plugin-react`: `5.1.4`
  - `@nestjs/core`: `11.1.14`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
- 本故事策略：
  - 功能交付优先，除前端确需引入（`antd`、状态管理）外，不做大规模依赖升级。
  - 如引入新依赖，必须同步锁文件与回归门禁。

### File Structure Requirements（建议变更落点）

- 前端（必改）：
  - `apps/web/src/App.jsx`（入口编排，减少业务堆叠）
  - `apps/web/src/components/CustomCardTable.tsx`
  - `apps/web/src/components/CustomFilter.tsx`
  - `apps/web/src/components/CustomForm.tsx`
  - `apps/web/src/components/CustomLayout.tsx`
  - `apps/web/src/features/platform-governance/*`（建议新增）
  - `apps/web/src/api/*`（建议新增：平台用户/角色接口映射）
- 前端测试（必改）：
  - `apps/web/test/chrome.playwright.test.js`（可拆分新文件，需保留现有覆盖）
  - `apps/web/test/server.test.js`（若新增前端 server 代理逻辑）
- 后端（按缺口补齐，建议改）：
  - `apps/api/src/modules/platform/user.constants.js`
  - `apps/api/src/modules/platform/user.routes.js`
  - `apps/api/src/modules/platform/user.service.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
- 后端测试（按缺口补齐，建议改）：
  - `apps/api/test/platform.user.api.test.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- AC1（平台用户管理）：
  - 列表/筛选/分页可用。
  - 新建用户（手机号）成功与失败路径完整。
  - 状态切换与软删除语义正确，返回字段可追踪（含 `request_id`）。
  - Modal + Drawer 交互符合 UX 规范。
- AC2（平台角色管理）：
  - 角色列表、创建、编辑、删除全覆盖。
  - 受保护角色编辑/删除被一致拒绝，提示语义稳定。
  - 详情 Drawer 可读并与列表状态一致。
- AC3（权限树 + 分配生效）：
  - 权限树读取、编辑、保存成功并可回读。
  - 角色分配严格 1-5，越界/重复/非法输入失败。
  - 分配后平台权限即时生效；越权按钮不可操作且后端拒绝一致。
- AC4（发布门禁）：
  - 必须通过真实 Chrome Playwright。
  - 覆盖关键交互：Modal、Drawer、message、loading 防重复。
  - 失败项阻断 story 完成。

### Previous Story Intelligence

- 来自 Story 2.6：
  - 高风险路径下必须保持“成功/失败全分支稳定契约”，尤其是 400/401/403/404/409/413/503。
  - 幂等键处理与路径参数规范化要从入口统一，避免大小写/路径变体绕过。
  - 任何路由改动都要同步 `route-permissions + openapi + 回归测试`，否则极易漂移。
- 来自 Story 2.5：
  - 权限相关逻辑必须以服务端授权事实为准，避免前端缓存过期导致误判。
  - `permission_codes` 只提交最终授权结果，且要有数量/格式边界防护。
  - 依赖退化必须 fail-closed（503），不能 fallback 为“假成功”。

### Git Intelligence Summary

- 最近 5 次提交主要集中在 Epic 5 的平台集成治理链路（contract/recovery/freeze）与对应测试扩展。
- 可执行结论：
  - 平台治理后端模块仍在活跃演进，新增用户读接口时应复用近期在 `platform/*` 中已稳定的错误/幂等/测试模式。
  - 前端工作台应独立落在 `apps/web`，避免耦合到集成治理分支未完成的临时实现。

### Latest Tech Information（Web Research Completed）

- Node.js 发布索引：Latest `v25.6.1`，Latest LTS `v24.13.1`（Krypton）。
- npm 最新：
  - `antd 6.3.0`
  - `@tanstack/react-query 5.90.21`
  - `zustand 5.0.11`
  - `@playwright/test 1.58.2`
  - `@vitejs/plugin-react 5.1.4`
  - `@nestjs/core 11.1.14`
  - `typeorm 0.3.28`
  - `mysql2 3.17.4`
  - `ioredis 5.9.3`
- 结论：故事实现阶段优先保持与当前工程版本兼容，仅增量引入 UI/状态管理必要依赖。

### Project Context Reference

- 未发现 `**/project-context.md` 文件。
- 本故事上下文来源：
  - `epics.md`
  - `prd.md`
  - `architecture.md`
  - `ux-design-specification.md`
  - 前序故事 `2-6-平台侧负责人变更入口.md`
  - 前序故事 `2-5-平台权限树配置与角色分配生效.md`
  - 最近 5 次 git 提交变更

### Story Completion Status

- Story 文档状态：`review`
- Completion Note：`平台治理前端工作台与平台用户读接口已落地，API/Web 回归与真实 Chrome 回归均通过。`

### Project Structure Notes

- 现状：`apps/web` 已有 AntD 组件封装，但业务页仍集中在 `App.jsx`，适合在本故事中完成“业务分层抽离 + 工作台落地”。
- 约束：保持双域边界清晰，平台治理 UI 不应侵入 tenant 侧状态机。
- 风险点：平台用户列表读能力缺口若不补齐，AC1 无法闭环；需优先解决。

### References

- Story 2.7 用户故事与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.7: 平台治理前端工作台（平台用户管理 + 平台角色管理）]
- Journey 2（平台治理主线）  
  [Source: _bmad-output/planning-artifacts/prd.md#Journey 2: 平台管理员 - 平台自身治理（Platform Governance）]
- 平台治理能力 FR13-FR18  
  [Source: _bmad-output/planning-artifacts/prd.md#平台治理能力（Platform Governance）]
- FR27（菜单/按钮/操作按权限控制）  
  [Source: _bmad-output/planning-artifacts/prd.md#权限与授权执行]
- 架构约束（Problem Details、Idempotency、路由权限门禁、Chrome Playwright）  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 约束（Modal/Drawer/message/loading、防重复、真实 Chrome）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#UX Consistency Patterns]
- 当前平台后端契约与接口  
  [Source: apps/api/src/openapi.js]
- 当前平台路由权限声明  
  [Source: apps/api/src/route-permissions.js]
- 平台用户与角色服务实现  
  [Source: apps/api/src/modules/platform/user.service.js]  
  [Source: apps/api/src/modules/platform/role.service.js]
- 前端现状与可复用组件  
  [Source: apps/web/src/App.jsx]  
  [Source: apps/web/src/components/CustomCardTable.tsx]  
  [Source: apps/web/src/components/CustomFilter.tsx]  
  [Source: apps/web/src/components/CustomForm.tsx]  
  [Source: apps/web/src/components/CustomLayout.tsx]
- 前序故事经验  
  [Source: _bmad-output/implementation-artifacts/2-6-平台侧负责人变更入口.md]  
  [Source: _bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md]
- 版本核验来源  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/react/latest]  
  [Source: https://registry.npmjs.org/vite/latest]  
  [Source: https://registry.npmjs.org/antd/latest]  
  [Source: https://registry.npmjs.org/@tanstack/react-query/latest]  
  [Source: https://registry.npmjs.org/zustand/latest]  
  [Source: https://registry.npmjs.org/@playwright/test/latest]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-7-平台治理前端工作台-平台用户管理-平台角色管理`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- implementation coverage:
  - 平台用户读接口：`GET /platform/users`、`GET /platform/users/:user_id`
  - 平台治理前端模块：`平台用户管理 + 平台角色管理 + 权限收敛面板`
  - 真实 Chrome 回归新增平台治理路径（Modal/Drawer/权限树/角色分配）
- targeted verification:
  - `pnpm --dir apps/api exec node --test test/auth.store.memory.platform-user-read.test.js test/platform.user.api.test.js test/route-permissions.test.js`（通过，89/89）
  - `pnpm --dir apps/web exec node --test test/chrome.playwright.test.js`（通过，3/3）
  - `pnpm --dir apps/web test`（历史通过，11 + 3）
- regression fix notes:
  - 修复 `apps/web/test/chrome.playwright.test.js` 中正则字面量误转义导致的语法错误。
  - 修复平台治理用例流程：创建后改校验详情抽屉并清空筛选，再执行状态切换断言。
  - 修复 `PlatformGovernanceWorkbench` 缺失 `Spin` 导入问题。
  - 调整平台治理 API stub 新建 billing 角色默认权限，确保角色分配后权限收敛断言可验证。

### Completion Notes List

- ✅ 后端补齐平台用户最小读能力：`GET /platform/users`、`GET /platform/users/:user_id`，并同步路由、权限声明、OpenAPI、memory/mysql 存储实现与回归测试。
- ✅ 前端新增平台治理 API 映射层与 `PlatformGovernanceWorkbench` 功能模块，落地用户管理（列表/筛选/创建/状态切换/详情/软删除）与角色管理（列表/创建/编辑/删除/详情/权限树/角色分配）。
- ✅ `platform` 入口下挂载治理工作台，保持 tenant 侧登录与组织切换链路不回归。
- ✅ 扩展真实 Chrome 回归，覆盖平台治理关键路径并归档证据到 `artifacts/chrome-platform-governance`。
- ✅ 代码审查阶段补齐并修复：内存存储读路径状态归一化异常、关键字匹配语义漂移、前端列表刷新分页上下文重置、详情抽屉 `latest_action` 旧快照问题。
- ✅ 代码审查补充修复：`apps/web` lint 阻断（ESM 扩展名）、平台用户列表关键字审计脱敏、平台用户读模型 `phone` 契约校验。
- ✅ 当前会话验证通过：`apps/api` 目标回归 92/92、`apps/web` chrome 回归 3/3，`apps/api`/`apps/web` lint 全通过。

### File List

- `apps/api/src/modules/platform/user.constants.js`
- `apps/api/src/modules/platform/user.routes.js`
- `apps/api/src/modules/platform/user.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.user.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/auth.store.memory.platform-user-read.test.js`
- `apps/web/src/api/platform-governance.mjs`
- `apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx`
- `apps/web/src/App.jsx`
- `apps/web/test/chrome.playwright.test.js`
- `apps/web/package.json`
- `pnpm-lock.yaml`
- `_bmad-output/implementation-artifacts/2-7-平台治理前端工作台-平台用户管理-平台角色管理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-22：完成 Story 2.7 开发交付，补齐平台用户读接口与平台治理前端工作台；通过 API 关键回归、Web 全量测试与真实 Chrome 回归，故事状态更新为 `review`。
- 2026-02-22：完成 CR 复核与修复，补充内存存储读路径回归测试与前端详情动作断言；故事状态更新为 `done`。
- 2026-02-22：完成 CR 第二轮修复，处理 Web lint ESM 兼容、平台用户查询关键字审计脱敏、平台用户读模型 `phone` 契约校验，并补充回归测试。
