# Story 1.10: 认证错误码与可重试语义统一映射

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 前后端协作开发者,  
I want 认证与鉴权失败返回统一错误码和 `retryable` 语义,  
so that 前端可以稳定映射动作，运维可以快速定位问题。

## Acceptance Criteria

1. 认证或鉴权链路失败时，服务端返回统一错误码体系与 Problem Details 结构，并包含可重试语义分层字段供前端动作映射。
2. 密码错误、验证码错误、验证码过期或已使用时，外显文案遵循统一口径；服务端日志保留细分失败原因用于审计。
3. 认证接口触发限流时，返回标准限流错误码；前端可基于错误码展示一致反馈与引导。
4. 客户端对关键写接口携带幂等键重复提交时，系统返回与首次请求一致的结果语义，且不产生重复写入副作用。
5. Layer A（FR9, FR80）必须通过：Problem Details + 统一错误码契约完整性。
6. Layer B（FR62, FR63）必须通过：认证限流反馈与前端动作映射一致性。
7. Layer C（FR52, FR69）必须通过：关键写接口幂等重复请求一致语义。

## Tasks / Subtasks

- [x] 任务 1：统一认证错误目录与对外语义（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.service.js` 收敛错误出口，确保 `AuthProblemError` 覆盖认证/鉴权核心失败分支。
  - [x] 对外失败语义统一输出 Problem Details（`application/problem+json`），并稳定返回 `error_code` 与 `request_id`。
  - [x] 保持“外显文案统一、日志原因细分”：对用户返回统一提示，对审计日志保留细粒度 reason（不泄露敏感内部细节）。

- [x] 任务 2：落地可重试语义分层（AC: 1, 3）
  - [x] 在 Problem Details 中统一输出 `retryable`（布尔）并保留限流/降级扩展字段（如 `retry_after_seconds`、`degradation_reason`）。
  - [x] 建立可重试分层规则并固化到实现与测试：
    - [x] L0（不可重试）：参数错误、凭证错误、权限错误、业务冲突（如 `AUTH-400-*`、`AUTH-401-*`、`AUTH-403-*`、`AUTH-409-*`）。
    - [x] L1（延迟后可重试）：限流（`AUTH-429-RATE-LIMITED`，必须包含 `retry_after_seconds`）。
    - [x] L2（瞬时故障可重试）：服务降级/不可用（`AUTH-503-*`）。
  - [x] 保证 `apps/api/src/openapi.js` 的 ProblemDetails schema 与示例与运行时一致。

- [x] 任务 3：限流错误码与前端动作映射一致性（AC: 3, 6）
  - [x] 统一登录/OTP 发送/OTP 登录限流分支返回 `AUTH-429-RATE-LIMITED`。
  - [x] 保证 `rate_limit_action`、`rate_limit_limit`、`rate_limit_window_seconds` 与 `retry_after_seconds` 完整输出。
  - [x] 前端可直接按 `error_code + retryable + retry_after_seconds` 做动作映射（禁用按钮/倒计时/提示重试）。

- [x] 任务 4：关键写接口幂等一致语义（AC: 4, 7）
  - [x] 对关键写接口保持 `Idempotency-Key` 约束并验证重复提交返回一致语义。
  - [x] 覆盖并发重放、乱序重放、超时重试场景，确保“无重复写入副作用”。
  - [x] 幂等命中/冲突进入审计事件，便于运维排障与回放。

- [x] 任务 5：契约与门禁回归（AC: 5, 6, 7）
  - [x] Layer A：补齐 Problem Details + `error_code/retryable/request_id` 合约断言（API + OpenAPI）。
  - [x] Layer B：补齐限流映射断言（password_login / otp_send / otp_login）。
  - [x] Layer C：补齐幂等重复提交一致性断言（返回一致 + 无重复写）。
  - [x] 保持门禁通过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 幂等作用域从 `Authorization` 原串改为“会话/主体上下文优先”，修复 refresh 轮换后同会话重试不命中问题。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] OpenAPI 补齐 `provision-user` 的 `AUTH-409-IDEMPOTENCY-CONFLICT` 示例，并同步 429/503 `retryable` 与降级字段示例。[`apps/api/src/openapi.js`]
- [x] [AI-Review][MEDIUM] 增补“refresh 后重试命中幂等”和 tenant `provision-user` 幂等冲突回归测试，补齐 Layer C 证据链。[`apps/api/test/auth.api.test.js`]
- [x] [AI-Review][HIGH] 幂等键缺少输入合法性边界（空值/超长）校验，存在 DoS 与契约漂移风险；新增 `AUTH-400-IDEMPOTENCY-KEY-INVALID` 并拦截非法请求。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] 幂等请求哈希直接使用 `JSON.stringify`，对 JSON 键序敏感，导致语义等价请求误判冲突；改为稳定键序哈希。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] OpenAPI 429 示例缺少 `rate_limit_limit/rate_limit_window_seconds`，与运行时契约不一致；补齐示例并新增断言。[`apps/api/src/openapi.js`]
- [x] [AI-Review][HIGH] 幂等重放响应复用首次 `request_id`，导致单次请求可追踪性被破坏；重放路径改为保留业务语义同时刷新当前请求 `request_id`。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] OpenAPI `ProblemDetails` 已声明 `retryable` 为必填，但大量 `application/problem+json` 示例缺失该字段；补齐示例默认值并保持 429/503 显式值不被覆盖。[`apps/api/src/openapi.js`]
- [x] [AI-Review][MEDIUM] 缺少“Problem 示例必须包含 `retryable`”自动化防回归断言；新增统一校验测试，阻断后续契约漂移。[`apps/api/test/server.test.js`]
- [x] [AI-Review][HIGH] `Idempotency-Key` 多值/逗号拼接歧义未被拒绝，存在代理链路语义分裂风险；新增歧义输入拦截并统一返回 `AUTH-400-IDEMPOTENCY-KEY-INVALID`。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] `dispatchApiRoute` 仅识别小写 `x-request-id`，直接调用场景大小写不一致会导致 trace 串联漂移；改为大小写无关读取请求头。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] Express 限流回归仅校验响应体，缺少 `Retry-After/X-RateLimit-*` HTTP 头契约断言；新增端到端断言并与响应体字段逐项对齐。[`apps/api/test/auth.rate-limit.test.js`]
- [x] [AI-Review][HIGH] 幂等缓存错误持久化 `5xx` 响应，导致可重试故障恢复后同键请求仍返回旧失败；改为仅缓存 `<500` 响应并保留并发同飞一致性。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] `handleApiRoute` 仍仅识别小写 `x-request-id`，与 `dispatchApiRoute` 行为不一致；统一为大小写无关解析并补回归测试。[`apps/api/src/server.js`]
- [x] [AI-Review][MEDIUM] OpenAPI `Idempotency-Key` 头参数未声明“禁止逗号/纯空白”约束，与运行时校验存在契约漂移；补齐 `pattern` 并新增断言。[`apps/api/src/openapi.js`]
- [x] [AI-Review][MEDIUM] `POST /auth/platform/role-facts/replace` 缺少同键重放回归，无法证明“结果一致且仅执行一次副作用”；新增 API 级重放断言与审计侧证据。[`apps/api/test/auth.api.test.js`]
- [x] [AI-Review][MEDIUM] `POST /auth/platform/role-facts/replace` 缺少同键载荷漂移冲突回归，无法阻断 `AUTH-409-IDEMPOTENCY-CONFLICT` 语义回退；新增冲突断言与副作用不重复校验。[`apps/api/test/auth.api.test.js`]
- [x] [AI-Review][MEDIUM] Story File List 与 git 真实变更不一致，遗漏 `app.js` 与新增幂等 Redis 文件/测试，审计链路不完整；已补齐文件清单与记录。[`_bmad-output/implementation-artifacts/1-10-认证错误码与可重试语义统一映射.md`]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 1.9 刚完成 auth 域高强度加固，改动热点已稳定在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js`、`apps/api/test/auth*.test.js`；Story 1.10 必须增量演进，不做目录级重构。
- 当前系统已大量依赖 `error_code` 与 Problem Details 响应；本故事目标是“统一与补齐 retryable 分层语义”，不是推翻现有错误模型。
- 本故事是后续平台治理/组织治理错误反馈一致性的基线，必须先把“契约一致 + 测试可阻断”做扎实。

### Technical Requirements（实现硬约束）

- Problem Details 输出保持统一入口：`apps/api/src/common/problem-details.js` + `apps/api/src/app.js` 全局错误处理，不允许分散拼装多套错误格式。
- 认证链路错误返回至少包含：`title`、`status`、`detail`、`request_id`、`error_code`、`retryable`（以及场景扩展字段）。
- 限流错误（429）必须包含：`retry_after_seconds`、`rate_limit_action`、`rate_limit_limit`、`rate_limit_window_seconds`，并明确 `retryable=true`。
- 幂等场景必须满足“重复请求语义一致 + 无重复写入副作用”；若实现选择返回冲突码，也必须保证可判定且可恢复。
- 对用户外显文案保持统一口径；细粒度失败原因进入日志/审计，不直接透出内部异常细节。
- 兼容性要求：保留现有 `error_code` 字段语义，避免对现有测试与调用方造成破坏性变更。

### Architecture Compliance（架构对齐清单）

- 对齐架构文档既定错误模型：Problem Details + 统一错误码 + 可重试语义（`_bmad-output/planning-artifacts/architecture.md`）。
- 变更边界优先在 `modules/auth`、`common/problem-details`、`openapi`、`auth 相关测试` 内闭环，避免跨模块扩散。
- 维持外部契约 `snake_case`（如 `error_code`、`request_id`），不得引入同层混用格式。
- 契约先行：运行时行为变更必须同步 OpenAPI 与测试断言，防止“实现变了，文档没变”。

### Library & Framework Requirements（库与框架要求）

- 当前项目依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-16 最新核验：
  - Node.js：`v25.6.1`（Current），`v24.13.1`（LTS/Krypton）
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.1`
  - `ioredis`: `5.9.3`
- 标准参考：RFC 9457（已废止 RFC 7807），Problem Details 实现应与 RFC 9457 术语和字段语义保持一致。

### File Structure Requirements（建议变更落点）

- 核心实现：
  - `apps/api/src/common/problem-details.js`
  - `apps/api/src/app.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.routes.js`
- 契约与权限：
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`（如涉及路由声明变化）
  - `apps/api/src/http-routes.js`（如涉及路由挂载或中间件次序）
- 测试：
  - `apps/api/test/problem-details.test.js`
  - `apps/api/test/auth.api.test.js`
  - `apps/api/test/auth.express.api.test.js`
  - `apps/api/test/auth.rate-limit.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- Layer A（契约完整性，阻断项）：
  - 认证/鉴权失败统一为 `application/problem+json`
  - `error_code/retryable/request_id` 存在且语义正确
  - OpenAPI `ProblemDetails` schema 与运行时一致
- Layer B（限流映射一致性，阻断项）：
  - 登录、OTP 发送、OTP 登录三类限流统一错误码
  - `retry_after_seconds` 与 action/limit/window 字段完整且可断言
- Layer C（幂等一致性，阻断项）：
  - 同一 `Idempotency-Key` 并发/重放返回一致语义
  - 数据层无重复写，审计链路可追踪
- 回归命令（必须）：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Previous Story Intelligence

- Story 1.9 的主要教训：
  - 评审高频问题集中在“契约漂移、双存储语义不一致、失败补偿遗漏”；Story 1.10 需避免再次出现。
  - fail-closed 与统一错误语义必须在 service/store/API 多层同时成立，不能只在单层补丁式修复。
  - 变更应保持在 `modules/auth` 热区，减少跨模块重构带来的回归面。
- 可复用模式：
  - “小步增量 + 契约同步 + 全链路回归 + CR 问题闭环”已被验证可行，继续沿用。

### Git Intelligence Summary

- 最近 5 次提交显示：工作持续集中在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js`、`apps/api/src/route-permissions.js`、`apps/api/test/auth*.test.js`。
- 结论：
  - Story 1.10 应继续采用“在 auth 主链路内收敛语义”的策略。
  - 优先追加契约/错误码/限流/幂等测试，不引入目录重排与大规模重构。

### Latest Tech Information（2026-02-16）

- Node.js 发布索引显示：
  - Current: `v25.6.1`
  - LTS: `v24.13.1`（Krypton）
- npm registry 最新：
  - `@nestjs/core 11.1.13`
  - `typeorm 0.3.28`
  - `mysql2 3.17.1`
  - `ioredis 5.9.3`
- RFC 标准：
  - RFC 9457《Problem Details for HTTP APIs》已废止 RFC 7807。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：`epics.md`、`prd.md`、`architecture.md`、`ux-design-specification.md`、Story 1.9、最近 5 次提交记录与当前代码基线。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review fixes applied and validated with full API gates.`

### Project Structure Notes

- 本故事优先保障认证域错误语义一致，不扩展到平台/组织治理模块实现细节。
- 对外错误契约保持 `snake_case`；内部可按现有风格维持 camelCase 到 snake_case 映射层。
- 若需引入 `retryable` 至全局错误处理，请确保非 auth 路径也能稳定输出该字段或在 OpenAPI 明确作用范围。

### References

- Story 1.10 定义与分层验收  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 1.10: 认证错误码与可重试语义统一映射]
- FR52/FR62/FR63/FR69/FR80 与发布门禁口径  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 架构错误模型与边界约束  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 失败反馈与可重试提示一致性  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事经验（Story 1.9）  
  [Source: _bmad-output/implementation-artifacts/1-9-默认密码策略与用户创建一致性.md]
- 当前实现（错误模型与认证服务）  
  [Source: apps/api/src/common/problem-details.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/openapi.js]
- Node.js Releases  
  [Source: https://nodejs.org/dist/index.json]
- RFC 9457  
  [Source: https://www.rfc-editor.org/rfc/rfc9457]
- npm registry  
  [Source: https://www.npmjs.com/package/@nestjs/core]  
  [Source: https://www.npmjs.com/package/typeorm]  
  [Source: https://www.npmjs.com/package/mysql2]  
  [Source: https://www.npmjs.com/package/ioredis]

## Senior Developer Review (AI)

- 结论：`Changes Requested` 问题已全部修复并回归通过，当前可判定为 `Approve`。
- 发现并修复的问题：
  - `HIGH`：幂等作用域依赖 `Authorization` 原串，导致 refresh 后同会话重试可能失去幂等命中。
  - `MEDIUM`：`provision-user` 接口 OpenAPI 缺失 `AUTH-409-IDEMPOTENCY-CONFLICT` 契约示例，429/503 示例未完整体现 `retryable` 语义。
  - `MEDIUM`：测试覆盖缺失 tenant 幂等重放与 refresh 后重试命中场景。
  - `HIGH`：`Idempotency-Key` 缺少长度与空值校验，非法输入可进入幂等缓存路径并放大资源占用。
  - `MEDIUM`：幂等哈希对 JSON 键序敏感，语义等价重放可能误判为 `AUTH-409-IDEMPOTENCY-CONFLICT`。
  - `MEDIUM`：OpenAPI 429 示例缺少 `rate_limit_limit/rate_limit_window_seconds` 字段，和运行时输出不一致。
  - `HIGH`：幂等重放响应复用首次请求 `request_id`，使二次请求日志追踪与响应体 request_id 对不上；已改为重放时刷新当前请求 `request_id` 且保持业务结果一致。
  - `MEDIUM`：OpenAPI `ProblemDetails` schema 要求 `retryable` 必填，但多个错误示例缺失该字段；已在构建阶段统一补齐缺省 `retryable=false` 并保留显式值。
  - `MEDIUM`：缺少“所有 `application/problem+json` 示例都必须包含布尔 `retryable`”的自动化护栏；已新增断言防止后续回归。
  - `HIGH`：`Idempotency-Key` 允许歧义多值（数组或逗号拼接）透传，代理/网关合并策略差异可能造成幂等判定不一致；已统一拒绝歧义值并返回 `AUTH-400-IDEMPOTENCY-KEY-INVALID`。
  - `MEDIUM`：`dispatchApiRoute` 直接调用场景下 `X-Request-Id` 大小写敏感，导致同请求链路出现 request_id 漂移；已改为大小写无关解析。
  - `MEDIUM`：Express 限流回归未覆盖 `Retry-After/X-RateLimit-*` 头部契约，存在“响应体正确但头部回归”漏检风险；已补齐 headers 与 body 一致性断言。
  - `HIGH`：幂等缓存会持久化 `5xx` 响应，导致依赖恢复后同键重试仍命中旧失败；已改为仅缓存 `<500` 响应并保留并发同飞一致性。
  - `MEDIUM`：`handleApiRoute` 仍仅识别小写 `x-request-id`，与 `dispatchApiRoute` 行为不一致；已统一为大小写无关解析并补测试。
  - `MEDIUM`：OpenAPI 的 `Idempotency-Key` 参数未声明“禁止逗号/纯空白”约束，和运行时校验存在契约漂移；已补齐 `pattern` 并新增断言。
- 复核结果：
  - `pnpm --dir apps/api check:route-permissions` 通过
  - `pnpm --dir apps/api test` 通过（`345` 通过，`0` 失败）
  - `pnpm --dir apps/api lint` 通过

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `apps/api/src/common/problem-details.js`: Problem Details 默认注入 `retryable=false`，并允许扩展字段显式覆盖。
- `apps/api/src/modules/auth/auth.service.js`: 统一 429/503 `retryable` 语义；新增 `recordIdempotencyEvent` 审计入口。
- `apps/api/src/server.js`: 为关键写接口新增 `Idempotency-Key` 幂等重放缓存、并发去重、载荷漂移冲突（`AUTH-409-IDEMPOTENCY-CONFLICT`）；幂等作用域改为会话/主体上下文优先，支持 refresh 后同会话重试命中；新增幂等键输入合法性校验、稳定键序请求哈希与歧义多值拦截；重放命中时改为刷新当前请求 `request_id`（不破坏业务响应语义）；`dispatchApiRoute` 与 `handleApiRoute` 均改为大小写无关读取 `x-request-id`；幂等缓存仅持久化 `<500` 响应，避免可重试错误被旧失败响应粘滞。
- `apps/api/src/http-routes.js`: 暴露 `recordAuthIdempotencyEvent` 供路由层幂等审计调用。
- `apps/api/src/openapi.js`: ProblemDetails 补齐 `retryable`/`degradation_reason`；关键写接口补齐 `Idempotency-Key` 头参数与 409 幂等冲突契约；补齐 `AUTH-400-IDEMPOTENCY-KEY-INVALID` 与 429 `rate_limit_limit/rate_limit_window_seconds` 示例；新增 OpenAPI 构建期归一化，确保所有 `application/problem+json` 示例均含布尔 `retryable`；补齐 `Idempotency-Key` schema `pattern`（禁止逗号/纯空白）以对齐运行时校验。
- `apps/api/test/auth.api.test.js`: 新增 refresh 轮换后同会话幂等命中、tenant provision 幂等重放与载荷漂移冲突测试；新增“键序等价重放命中”与“非法幂等键拒绝”回归；新增断言要求幂等重放语义一致但 `request_id` 为当前请求值；补齐 `platform role-facts replace` 的同键重放/载荷漂移冲突断言与“仅一次副作用”审计证据。
- `apps/api/src/app.js`: 应用装配层接入 Redis 幂等存储创建与注入，确保与 OTP/限流存储同生命周期管理。
- `apps/api/src/modules/auth/auth.idempotency.redis.js`: 新增 Redis 幂等存储实现（claim/read/resolve/release）与按作用域窗口容量淘汰策略。
- `apps/api/test/auth.idempotency.redis.test.js`: 新增 Redis 幂等存储跨实例重放与窗口淘汰回归测试。
- `apps/api/test/http-routes.test.js`: 新增 `createRouteHandlers` 暴露 `authIdempotencyStore` 能力契约测试。
- `apps/api/test/auth.rate-limit.test.js`: 新增 Express 限流响应头（`Retry-After/X-RateLimit-*`）与响应体字段一致性断言，补齐 Layer B 头部契约防回归。
- `apps/api/test/server.test.js`: 新增 OpenAPI 幂等冲突示例、`AUTH-400-IDEMPOTENCY-KEY-INVALID` 示例以及 429 限流扩展字段契约断言；新增“所有 problem 示例必须包含布尔 `retryable`”护栏断言；新增 `X-Request-Id` 大小写兼容与 `Idempotency-Key` 歧义多值拦截回归；新增 `handleApiRoute` 大小写请求头回归与“`5xx` 不进入幂等持久缓存”回归测试。
- 测试门禁执行通过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`。

### Completion Notes List

- ✅ 统一错误响应语义：认证/鉴权链路 Problem Details 稳定输出 `error_code`、`request_id`、`retryable`。
- ✅ 完成可重试分层：L0（400/401/403/409）不可重试、L1（429）延迟可重试、L2（503）瞬时故障可重试。
- ✅ 限流语义契约闭环：`AUTH-429-RATE-LIMITED` + `retry_after_seconds/rate_limit_action/rate_limit_limit/rate_limit_window_seconds`。
- ✅ 关键写接口幂等落地：`Idempotency-Key` 支持重复提交一致语义、并发去重、载荷漂移冲突判定。
- ✅ 幂等审计闭环：新增 `auth.idempotency.hit` / `auth.idempotency.conflict` 审计事件。
- ✅ 评审闭环：修复 refresh 后重试幂等命中缺陷，补齐 tenant 场景测试与 OpenAPI 409 冲突示例。
- ✅ 幂等输入安全闭环：新增 `Idempotency-Key` 空值/超长输入拒绝与 `AUTH-400-IDEMPOTENCY-KEY-INVALID` 契约。
- ✅ 幂等语义稳定性闭环：请求哈希改为稳定键序计算，避免 JSON 键序差异导致误冲突。
- ✅ 限流示例契约闭环：OpenAPI 429 示例补齐 `rate_limit_limit/rate_limit_window_seconds` 并通过断言保护。
- ✅ 幂等重放可追踪性闭环：重放响应保留相同业务结果并刷新当前请求 `request_id`，避免 trace 归因混淆。
- ✅ OpenAPI 示例一致性闭环：`application/problem+json` 示例统一补齐布尔 `retryable`，新增自动化断言持续守护。
- ✅ 幂等键歧义输入闭环：拒绝多值/逗号拼接 `Idempotency-Key`，消除代理合并差异导致的幂等判定分裂风险。
- ✅ request_id 头读取一致性闭环：`dispatchApiRoute` 支持大小写无关 `x-request-id`，避免直接调用链路 trace 漂移。
- ✅ 限流头契约闭环：补齐 `Retry-After/X-RateLimit-*` 端到端断言，确保响应头与响应体语义一致。
- ✅ 可重试失败语义闭环：幂等缓存不再持久化 `5xx`，避免可恢复故障在缓存窗口内被错误放大。
- ✅ 直接调用链路 trace 闭环：`handleApiRoute` 与 `dispatchApiRoute` 统一大小写无关读取 `X-Request-Id`。
- ✅ Idempotency-Key 文档契约闭环：OpenAPI 头参数新增 `pattern`，与运行时“禁止逗号/纯空白”校验保持一致。
- ✅ Role-facts 幂等证据闭环：补齐 `POST /auth/platform/role-facts/replace` 的同键重放与载荷漂移冲突回归，并验证副作用仅执行一次。
- ✅ 评审可追溯性闭环：Story File List 补齐 `app.js` 与新增幂等 Redis 文件/测试，保证 git 与文档一致。
- ✅ 回归门禁全绿：Layer A/B/C 新增断言通过，且全量测试/权限声明检查/Lint 全通过。

### File List

- apps/api/src/common/problem-details.js
- apps/api/src/app.js
- apps/api/src/http-routes.js
- apps/api/src/modules/auth/auth.idempotency.redis.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/openapi.js
- apps/api/src/server.js
- apps/api/test/auth.api.test.js
- apps/api/test/auth.idempotency.redis.test.js
- apps/api/test/auth.rate-limit.test.js
- apps/api/test/http-routes.test.js
- apps/api/test/problem-details.test.js
- apps/api/test/server.test.js
- _bmad-output/implementation-artifacts/1-10-认证错误码与可重试语义统一映射.md
- _bmad-output/implementation-artifacts/sprint-status.yaml

### Change Log

- 2026-02-16: 完成 Story 1.10 实现，补齐 retryable 分层语义、关键写接口幂等与审计、OpenAPI 契约与测试门禁回归。
- 2026-02-16: 完成 Code Review 修复：幂等作用域升级为会话上下文优先、补齐 OpenAPI 冲突/可重试示例、补齐 tenant + refresh 幂等回归测试。
- 2026-02-16: 完成追加 Code Review 修复：新增 `Idempotency-Key` 合法性校验、稳定键序幂等哈希、429 示例 `rate_limit_limit/rate_limit_window_seconds` 契约与对应回归测试。
- 2026-02-16: 完成本轮 Code Review 收口：修复幂等重放 `request_id` 复用问题，新增 OpenAPI problem 示例 `retryable` 归一化与防回归断言。
- 2026-02-16: 完成再一轮 Code Review 收口：新增 `Idempotency-Key` 歧义多值拦截、`X-Request-Id` 大小写兼容、Express 限流响应头契约断言。
- 2026-02-16: 完成最新 Code Review 收口：修复 `5xx` 幂等缓存粘滞问题、补齐 `handleApiRoute` 大小写请求头一致性、补齐 `Idempotency-Key` OpenAPI `pattern` 契约并新增回归测试。
- 2026-02-16: 完成新一轮 Code Review 收口：补齐 `platform role-facts replace` 幂等重放/冲突回归测试，补齐 Story File List 与真实变更对齐。
