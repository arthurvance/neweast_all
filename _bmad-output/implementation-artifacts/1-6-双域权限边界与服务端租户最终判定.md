# Story 1.6: 双域权限边界与服务端租户最终判定

Status: done
Story ID: 1.6
Story Key: 1-6-双域权限边界与服务端租户最终判定

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台与组织治理操作者,
I want 平台域与组织域权限命名空间强隔离，并由服务端最终判定租户上下文,
so that 系统可以稳定防止跨域越权与伪造租户上下文访问。

## Acceptance Criteria

1. **Given** 平台域权限与组织域权限并存
   **When** 用户在平台域执行操作
   **Then** 系统仅使用 `platform` 命名空间权限参与判定
   **And** `tenant` 命名空间权限不会提升平台域访问能力

2. **Given** 用户在组织域执行操作
   **When** 请求携带组织上下文
   **Then** 系统仅信任服务端确认的有效租户上下文进行最终鉴权
   **And** 对客户端伪造租户标识的请求一律拒绝

3. **Given** 用户仅具平台身份且无组织成员关系
   **When** 用户尝试进入组织工作台或访问组织域接口
   **Then** 系统拒绝访问并返回统一错误语义
   **And** 不会因为平台高权限而越过组织域边界

4. **Given** 角色状态或授权关系发生变化
   **When** 用户再次访问受保护能力
   **Then** 系统按最新有效权限进行判定
   **And** 禁用角色不参与权限计算

5. **Given** 平台用户被分配多个平台角色
   **When** 系统计算平台域有效权限
   **Then** 按角色权限并集得到最终可访问能力
   **And** 不使用显式 deny 规则覆盖并集结果

6. **Given** 用户仅具组织身份且无平台域权限
   **When** 用户尝试进入平台工作台或访问平台域接口
   **Then** 系统拒绝访问并返回统一错误语义
   **And** 不会因为组织高权限而越过平台域边界

7. **Given** 组织用户在同一组织被分配多个组织角色
   **When** 系统计算该组织下有效权限
   **Then** 按组织角色权限并集得到最终可访问能力
   **And** 不使用显式 deny 规则覆盖并集结果

8. **Given** 平台域权限与组织域权限并存
   **When** 用户在组织域执行操作
   **Then** 系统仅使用 `tenant` 命名空间权限参与判定
   **And** `platform` 命名空间权限不会提升组织域访问能力

## Tasks / Subtasks

- [x] 任务 1：固化双域权限命名空间与 scope 门禁（AC: 1, 2, 5, 8）
  - [x] 确保所有受保护路由声明的 `scope` 与 `permission_code` 兼容（`route-permissions` 预检必过）
  - [x] 明确平台域权限与组织域权限不可混用，新增/补齐跨域误声明回归用例
  - [x] 对 tenant scope 路由在 platform 入口下统一返回 `AUTH-403-NO-DOMAIN`

- [x] 任务 2：服务端最终租户上下文判定与防伪造（AC: 2, 3）
  - [x] 所有 tenant 鉴权仅依赖服务端会话中的 `entry_domain + active_tenant_id`
  - [x] tenant 选择/切换只允许命中服务端 `tenant_options`；客户端 body/query 的伪造租户标识不可绕过
  - [x] 对无活跃组织上下文且不在白名单权限（如 tenant context read/switch）的请求统一拒绝

- [x] 任务 3：统一拒绝语义与审计可观测（AC: 2, 3, 4, 6）
  - [x] 保持 `AUTH-403-NO-DOMAIN` 与 `AUTH-403-FORBIDDEN` 语义分层稳定
  - [x] 所有拒绝审计记录必须带 `request_id`、`permission_code`、`entry_domain`、`tenant_id`
  - [x] OpenAPI 403 示例与真实错误响应字段保持一致

- [x] 任务 4：角色状态变更与权限生效一致性（AC: 4, 5, 7）
  - [x] 确保禁用角色不参与有效权限计算（tenant/platform 两域一致）
  - [x] 明确并验证“并集模型，无显式 deny 覆盖”的平台域与组织域判定规则
  - [x] 若会话上下文与最新权限事实源不一致，按 fail-closed 处理并触发上下文收敛

- [x] 任务 5：前端双域可见性与操作一致性（AC: 1, 2, 3）
  - [x] tenant 入口下菜单/按钮仅由服务端权限快照驱动，不做前端本地提权推导
  - [x] 组织切换后即时刷新 `tenant_permission_context` 并同步 UI
  - [x] 无域权限场景提供统一错误提示与可恢复引导

- [x] 任务 6：测试与门禁（AC: 1, 2, 3, 4, 5, 6, 7, 8）
  - [x] API：tenant scope 在 platform 入口拒绝、无 active_tenant 拒绝、伪造 tenant 拒绝
  - [x] API：platform scope 在 tenant-only 身份下拒绝，tenant scope 在 platform-only 身份下拒绝
  - [x] API：权限快照拒绝返回 `AUTH-403-FORBIDDEN`，域拒绝返回 `AUTH-403-NO-DOMAIN`
  - [x] API：平台域与组织域多角色并集规则各自成立，且不存在跨域提权
  - [x] API：路由声明门禁（缺失/未知码/scope 不兼容）阻断
  - [x] Web Chrome：双域入口与组织切换后权限可见性正确且无状态漂移

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] MySQL 路径缺少 `auth_user_domain_access` 平台权限快照列迁移，平台域鉴权会长期 fail-closed；已补齐 `0006` 正/反向迁移并纳入 schema preflight。[`apps/api/migrations/0006_auth_platform_permission_snapshot.sql:1`, `apps/api/migrations/0006_auth_platform_permission_snapshot.down.sql:1`, `apps/api/src/app.js:49`]
- [x] [AI-Review][MEDIUM] MySQL 集成测试建表与 information_schema mock 未覆盖新增必需列，无法验证真实 preflight 行为；已补齐测试常量、建表与 mock。[`apps/api/test/auth.express.api.test.js:56`, `apps/api/test/auth.express.api.test.js:261`, `apps/api/test/auth.express.api.test.js:1029`]
- [x] [AI-Review][MEDIUM] 缺少平台 probe 在 MySQL 路径的 NO-DOMAIN/FORBIDDEN/ALLOW 三态回归，双域边界缺少端到端保障；已新增集成用例。[`apps/api/test/auth.express.api.test.js:843`]
- [x] [AI-Review][LOW] 迁移基线未覆盖 `0006` 版本与 SQL 关键断言，回滚/升级门禁可能漏检；已补齐测试。[`apps/api/test/migrate-baseline.test.js:36`, `apps/api/test/migrate-baseline.test.js:102`]
- [x] [AI-Review][HIGH] 无外部同步器时，平台权限“角色事实源 -> 快照”无同事务收敛链路；已新增 `auth_user_platform_roles` 事实表与事务内快照同步方法，平台 probe 改为基于角色事实自动收敛快照后判定。[`apps/api/migrations/0007_auth_platform_role_facts.sql:1`, `apps/api/src/modules/auth/auth.store.mysql.js:131`, `apps/api/src/modules/auth/auth.service.js:736`, `apps/api/test/auth.express.api.test.js:955`]
- [x] [AI-Review][HIGH] 启动期 schema preflight 未纳入 `auth_user_platform_roles`，存在“未执行 `0007` 仍可启动”的漂移窗口；已补齐必需表/列校验并新增缺表失败回归。[`apps/api/src/app.js:47`, `apps/api/test/auth.express.api.test.js:1302`]
- [x] [AI-Review][HIGH] 鉴权前快照同步在“角色事实为空”时默认不收敛，可能残留历史高权快照导致越权；已改为鉴权前强制空事实收敛并补齐 MySQL/API/Service 回归。[`apps/api/src/modules/auth/auth.service.js:760`, `apps/api/test/auth.express.api.test.js:1001`, `apps/api/test/auth.service.test.js:1373`]
- [x] [AI-Review][MEDIUM] `domain/tenant` 状态判定对 `enabled` 兼容不一致，可能导致同一用户跨链路语义漂移；已统一为 `active|enabled` 并补齐单测。[`apps/api/src/modules/auth/auth.store.mysql.js:367`, `apps/api/test/auth.store.mysql.test.js:28`]
- [x] [AI-Review][HIGH] 平台角色事实同步在 MySQL upsert 路径会将既有 `auth_user_domain_access.status` 回写为 `active`，可能误恢复已禁用平台域访问；已改为仅更新权限快照列，不覆盖域状态，并补齐回归断言。[`apps/api/src/modules/auth/auth.store.mysql.js:286`, `apps/api/test/auth.store.mysql.test.js:346`]
- [x] [AI-Review][MEDIUM] 内存存储对 tenant 关系状态仍只识别 `active`，未兼容 `enabled`，与 MySQL 行为不一致；已统一为 `active|enabled` 并新增登录回归。[`apps/api/src/modules/auth/auth.store.memory.js:246`, `apps/api/test/auth.service.test.js:484`]
- [x] [AI-Review][LOW] Story `File List` 与 git 实际改动存在漂移（缺少已删除文件记录），影响审查可追踪性；已补齐文件清单记录。[`_bmad-output/implementation-artifacts/1-6-双域权限边界与服务端租户最终判定.md:324`]
- [x] [AI-Review][MEDIUM] `sprint-status.yaml` 的 `story_location` 指向旧工作目录（`/Users/helloworld/Documents/project_code/neweast`），会导致工具链定位漂移；已统一为当前仓库路径。[`_bmad-output/implementation-artifacts/sprint-status.yaml:40`]
- [x] [AI-Review][MEDIUM] Story 顶部状态为 `done`，但“Story Completion Status”仍写 `ready-for-dev`，状态元数据自相矛盾；已更正为 `done`。[`_bmad-output/implementation-artifacts/1-6-双域权限边界与服务端租户最终判定.md:241`]
- [x] [AI-Review][LOW] 运行时 413 `detail` 与 OpenAPI 示例不一致（`JSON payload exceeds {n} bytes` vs `JSON payload exceeds allowed size`），存在契约漂移；已统一文案并补齐断言回归。[`apps/api/src/app.js:359`, `apps/api/src/server.js:323`, `apps/api/test/server.test.js:160`, `apps/api/test/auth.express.api.test.js:1398`]
- [x] [AI-Review][HIGH] `0006` 迁移直接 `ADD COLUMN` 不具幂等保护，在“列已存在/半手工修复环境”会触发重复列错误并阻断发布；已改为 `information_schema + PREPARE` 受保护 DDL（兼容当前 MySQL 版本）。[`apps/api/migrations/0006_auth_platform_permission_snapshot.sql:1`]
- [x] [AI-Review][MEDIUM] `0006` 回滚脚本直接 `DROP COLUMN`，在列缺失时会导致回滚失败；已改为受保护回滚 DDL，避免回滚过程被非关键差异阻断。[`apps/api/migrations/0006_auth_platform_permission_snapshot.down.sql:1`]
- [x] [AI-Review][LOW] 迁移基线测试未锁定 `0006` 的守卫式 DDL 约束，未来易回归为非幂等写法；已补充守卫语义断言。[`apps/api/test/migrate-baseline.test.js:103`]
- [x] [AI-Review][HIGH] `0007` 仅建表未回填历史平台快照，启用“鉴权前强制同步”后会把存量用户平台权限清零；已在迁移中补齐 legacy 快照回填并加基线断言。[`apps/api/migrations/0007_auth_platform_role_facts.sql:17`, `apps/api/test/migrate-baseline.test.js:145`]
- [x] [AI-Review][HIGH] `replacePlatformRolesAndSyncSnapshot` 在空角色集场景会通过 upsert 新建 `platform` 域记录，可能误授予平台域入口；已改为空角色仅更新既有快照，不再新建域记录，并补齐回归。[`apps/api/src/modules/auth/auth.store.mysql.js:231`, `apps/api/test/auth.store.mysql.test.js:433`]
- [x] [AI-Review][MEDIUM] 平台快照同步每次鉴权都无差异写库，存在高频写放大；已增加“仅值变化时更新”的条件写入并补齐断言。[`apps/api/src/modules/auth/auth.store.mysql.js:197`, `apps/api/test/auth.store.mysql.test.js:270`]
- [x] [AI-Review][MEDIUM] `replacePlatformRolesAndSyncSnapshot` 在“空角色集 + 快照无变化”场景仍会执行无差异 UPDATE，存在不必要写放大；已补齐值差异守卫条件并新增断言。[`apps/api/src/modules/auth/auth.store.mysql.js:335`, `apps/api/test/auth.store.mysql.test.js:500`]
- [x] [AI-Review][MEDIUM] 平台角色事实输入若包含重复 `role_id`，旧实现会顺序依赖并造成重复写库；已在内存/MySQL 双存储统一按 `role_id` 去重（latest payload wins）并补齐回归。[`apps/api/src/modules/auth/auth.store.mysql.js:129`, `apps/api/src/modules/auth/auth.store.memory.js:81`, `apps/api/test/auth.store.mysql.test.js:436`, `apps/api/test/auth.service.test.js:1577`]
- [x] [AI-Review][LOW] 平台权限快照查询使用 `SELECT *`，字段面过宽且不利于约束检查；已收敛为显式列查询并在 SQL 层加入 `active|enabled` 过滤。[`apps/api/src/modules/auth/auth.store.mysql.js:634`]
- [x] [AI-Review][MEDIUM] 平台路由鉴权每次都会全量读取角色事实并尝试快照同步，读路径存在高频放大风险；已改为“快照行 + 角色事实摘要（COUNT/MAX）”的增量判定，仅在事实源变更时才全量读取角色行并同步。[`apps/api/src/modules/auth/auth.store.mysql.js:194`, `apps/api/test/auth.store.mysql.test.js:270`]
- [x] [AI-Review][MEDIUM] 平台角色事实 `status` 缺少白名单校验，非法值会被静默写入并导致权限结果不可预期；已在内存/MySQL 双存储统一增加 `active|enabled|disabled` 校验并补齐拒绝回归。[`apps/api/src/modules/auth/auth.store.mysql.js:108`, `apps/api/src/modules/auth/auth.store.memory.js:16`, `apps/api/test/auth.store.mysql.test.js:635`]
- [x] [AI-Review][LOW] `0007` 迁移回填使用通用 `role_id` 字面量，存在与业务角色编码碰撞风险；已改为保留命名空间 `__migr_0007_legacy_snapshot__` 并更新基线断言。[`apps/api/migrations/0007_auth_platform_role_facts.sql:28`, `apps/api/test/migrate-baseline.test.js:145`]
- [x] [AI-Review][MEDIUM] 平台快照同步存在“摘要读取 -> 角色读取 -> 快照写入”竞态窗口，在角色事实并发变更下可能回写旧快照；已增加数据库侧摘要守卫（`COUNT + MAX(DATE_FORMAT(updated_at))`）与服务层单次重试，并补齐并发回归测试。[`apps/api/src/modules/auth/auth.store.mysql.js:194`, `apps/api/src/modules/auth/auth.service.js:770`, `apps/api/test/auth.store.mysql.test.js:472`]
- [x] [AI-Review][HIGH] 平台鉴权对 `concurrent-role-facts-update` 仅重试一次后直接继续判定，二次并发冲突场景可能基于旧快照授权；已改为连续冲突时 fail-closed 返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 并记录退化审计。[`apps/api/src/modules/auth/auth.service.js:781`, `apps/api/test/auth.service.test.js:1572`]
- [x] [AI-Review][MEDIUM] `/auth/platform/member-admin/probe` OpenAPI 缺少 503 退化响应契约，运行时与文档不一致；已补齐 503 响应与示例并新增契约断言。[`apps/api/src/openapi.js:702`, `apps/api/test/server.test.js:56`]
- [x] [AI-Review][LOW] Story `File List` 漏登记 `apps/api/scripts/stress-platform-sync-mysql.js`，与 git 实际改动不一致；已补齐文件清单记录。[`_bmad-output/implementation-artifacts/1-6-双域权限边界与服务端租户最终判定.md:363`]
- [x] [AI-Review][LOW] 平台快照同步“未知 reason 退化分支”缺少独立回归，后续若改动 accepted reason 集合易出现静默回归；已补齐 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 单测并校验审计 `degradation_reason`。[`apps/api/test/auth.service.test.js:1684`]
- [x] [AI-Review][HIGH] 平台快照同步返回空 `reason` 时被 `acceptedSyncReasons` 视为可接受，存在异常状态 fail-open 风险；已改为仅接受显式白名单 reason，空 reason 一律按 503 退化 fail-closed 处理并补齐回归。[`apps/api/src/modules/auth/auth.service.js:851`, `apps/api/test/auth.service.test.js:1743`]
- [x] [AI-Review][MEDIUM] 平台快照“snapshot 时间戳 == 角色事实时间戳”会被提前判定 `up-to-date`，可能跳过必要重算；已改为仅 `snapshot > role_facts` 才短路，并补齐等时戳回归。[`apps/api/src/modules/auth/auth.store.mysql.js:582`, `apps/api/test/auth.store.mysql.test.js:470`]
- [x] [AI-Review][MEDIUM] `0007` 迁移回填在重复执行时会把既有 `auth_user_platform_roles.status` 覆盖为 `active`，存在状态漂移风险；已改为重复执行仅回填权限位，不覆盖角色状态，并补齐基线断言。[`apps/api/migrations/0007_auth_platform_role_facts.sql:1`, `apps/api/test/migrate-baseline.test.js:145`]
- [x] [AI-Review][HIGH] schema preflight 未校验 `auth_user_domain_access.updated_at`，与运行期快照同步查询依赖不一致，可能出现“启动通过但鉴权时 SQL 异常”；已补齐 preflight 必需列与集成测试常量。[`apps/api/src/app.js:60`, `apps/api/test/auth.express.api.test.js:56`]
- [x] [AI-Review][HIGH] schema preflight 未校验 `auth_user_platform_roles.updated_at`，与角色事实摘要读取依赖不一致，可能在运行时触发 fail-late；已补齐 preflight 必需列与集成测试常量。[`apps/api/src/app.js:79`, `apps/api/test/auth.express.api.test.js:73`]
- [x] [AI-Review][MEDIUM] 平台快照并发守卫仅比较 `COUNT + MAX(updated_at)`，在“计数/最大时戳不变但角色集合变化”场景可能漏检并发漂移；已补充 `role_facts_checksum` 守卫并新增同时戳同计数变更回归用例。[`apps/api/src/modules/auth/auth.store.mysql.js:414`, `apps/api/src/modules/auth/auth.store.mysql.js:691`, `apps/api/test/auth.store.mysql.test.js:642`]
- [x] [AI-Review][HIGH] `ensureDefaultDomainAccessForUser` 的并发重复键分支会把既有 `platform` 域状态回写为 `active`，存在误恢复禁用域的风险；已改为 `INSERT IGNORE` 且不覆盖状态，并新增并发分支回归断言。[`apps/api/src/modules/auth/auth.store.mysql.js:1059`, `apps/api/test/auth.store.mysql.test.js:151`]
- [x] [AI-Review][MEDIUM] `replacePlatformRolesAndSyncSnapshot` 在权限位无变化时不会推进 `auth_user_domain_access.updated_at`，会导致后续鉴权持续误判“快照未新于事实源”并重复读取角色事实；已在 upsert 路径显式推进 `updated_at` 并补齐 SQL 断言回归。[`apps/api/src/modules/auth/auth.store.mysql.js:846`, `apps/api/test/auth.store.mysql.test.js:822`]
- [x] [AI-Review][LOW] 死锁退避抖动对 `random()` 非法返回值未做有限值收敛，可能产出 `NaN` 延迟与指标字段；已增加非有限值兜底并补齐单测。[`apps/api/src/modules/auth/auth.store.mysql.js:332`, `apps/api/test/auth.store.mysql.test.js:1032`]

## Dev Notes

### Developer Context（开发者必须先读）

- 本故事是 Story 1.5（菜单/按钮/API 访问控制与统一拒绝语义）的直接延续，重点是把“权限声明 + 统一拒绝”推进到“服务端最终租户判定 + 双域边界不可绕过”。
- 目标是边界与一致性，不是堆叠新功能。优先复用现有 `authorizeRoute`、route declaration preflight、Problem Details、审计字段链路。
- 核心风险：跨域提权、伪造租户上下文、会话上下文与权限事实源漂移。

### Technical Requirements（实现硬约束）

- tenant scope 受保护路由必须满足：
  - 入口域为 `tenant`
  - `active_tenant_id` 有效（白名单权限除外）
  - 服务端可解析到租户权限快照
- platform scope 受保护路由必须满足：
  - 入口域为 `platform`（或 `session` 级场景）
  - 不得因 tenant 角色/权限存在而放行平台域操作
- 客户端提供的 `tenant_id` 仅可作为“请求意图”，不可作为最终鉴权依据。
- 所有拒绝语义统一使用 Problem Details，禁止裸文本/非标准 JSON。
- 403 分层规则：
  - 域/租户上下文不满足：`AUTH-403-NO-DOMAIN`
  - 有域但权限不足：`AUTH-403-FORBIDDEN`
- 权限计算规则：
  - 平台域：平台角色并集
  - 组织域：同一组织内组织角色并集
  - 两域均不使用显式 deny 覆盖并集
- Fail-closed 为默认策略：上下文缺失、声明缺失、权限码未知、scope 不兼容均拒绝。

### Architecture Compliance（架构对齐清单）

- 双域 RBAC 强隔离：`platform.*` 与 `tenant.*` 不得互相提升能力。
- 对称域拒绝：platform-only 不得进入 tenant 域；tenant-only 不得进入 platform 域。
- 受保护接口必须声明权限码；门禁校验失败必须阻断运行/发布。
- 错误结构必须包含：`type/title/status/detail/error_code/request_id`。
- 关键审计字段必须可追踪：`request_id`、`entry_domain`、`tenant_id`、`permission_code`。
- 禁用角色不参与权限计算，保持“并集模型、无显式 deny”。

### Library & Framework Requirements（库与框架要求）

- 工程基线：
  - Node.js: `>=24.0.0`（项目约束）
  - NestJS: `11.1.13`
  - React: `19.2.4`
  - Vite: `7.3.1`
  - TypeORM: `0.3.28`
  - MySQL driver: `mysql2 ^3.17.0`
  - Redis client: `ioredis 5.9.2`
- 最新核验（2026-02-14）：
  - Node 下载页显示：`v24.13.1 (LTS)`，`v25.6.1 (Current)`
  - MySQL 8.4 Release Notes 最新小版本：`8.4.8 (2026-01-20, LTS)`
  - npm registry：`ioredis 5.9.3`、`mysql2 3.17.1`
- 版本策略建议：
  - 本故事不做大版本升级。
  - 可选补丁升级：`ioredis 5.9.2 -> 5.9.3`，`mysql2` 锁文件对齐到 `3.17.1`。

### File Structure Requirements（建议变更落点）

- 后端核心
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`（如需补强事实源查询）
- 测试
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.express.api.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/web/test/server.test.js`
  - `apps/web/test/chrome.playwright.test.js`
- 迁移（仅在数据结构需补强时）
  - `apps/api/migrations/*`

### Testing Requirements（测试要求）

- API 单元/集成
  - tenant scope 路由在 platform 入口必须返回 `AUTH-403-NO-DOMAIN`
  - tenant scope 路由在 tenant 入口但无 `active_tenant_id` 必须返回 `AUTH-403-NO-DOMAIN`
  - 有域但权限不足必须返回 `AUTH-403-FORBIDDEN`
  - tenant 选择/切换对越权 tenant_id 必须拒绝
- 门禁
  - `check:route-permissions` 必须覆盖：缺失声明、未知权限码、scope 不兼容、声明/可执行不一致
- OpenAPI
  - `/auth/tenant/*` 与受保护 probe 的 403 示例必须与实现一致
- Web Chrome
  - tenant 入口组织切换后菜单/按钮可见性与后端快照一致
  - stale response 不得覆盖最新上下文（latest-request 机制持续生效）

### Previous Story Intelligence（来自 Story 1.5）

- 已沉淀能力：
  - 路由声明预检与 `authorizeRoute` 能力已落地
  - 403 语义分层已建立（`NO-DOMAIN` vs `FORBIDDEN`）
  - CORS allowlist 与 fail-closed 方向已收敛
  - tenant mutation UI 漂移问题已有修复
- 可直接复用的工程经验：
  - “实现 + 契约 + 测试”三层同步提交，避免单层漂移
  - story `File List` 与 git 实际变更保持一致，减少评审成本

### Git Intelligence Summary

- 最近 5 次提交显示实现重心持续在：
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/web/src/App.jsx`
  - 对应 API/Web 测试集
- 推断（基于近 3 个提交）：
  - 当前仓库对“鉴权边界 + 测试门禁”已有稳定节奏，Story 1.6 适合延续该改造路径，而非大规模重构目录。

### Latest Tech Information（2026-02-14 核验）

- Node.js（官方）
  - `v24.13.1 (LTS)`，`v25.6.1 (Current)`
- MySQL（官方）
  - `MySQL 8.4.8` 为最新 8.4 LTS 小版本（发布日期 2026-01-20）
- npm registry（`pnpm view`）
  - `@nestjs/core 11.1.13`
  - `react 19.2.4`（稳定版）
  - `vite 7.3.1`（`8.0.0-beta.*` 已存在，当前不建议迁移）
  - `typeorm 0.3.28`（稳定版）
  - `ioredis 5.9.3`（项目当前 5.9.2）
  - `mysql2 3.17.1`（项目范围 `^3.17.0`）
- 安全核查说明：
  - 尝试执行 `pnpm --dir apps/api audit --prod --json`，因 DNS 解析失败（`ENOTFOUND registry.npmjs.org`）未能获取审计结果。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源以 `epics/prd/architecture/ux` + Story 1.5 + 当前代码基线为准。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Ultimate context engine analysis completed - comprehensive developer guide created`

### Project Structure Notes

- 现状对齐：
  - 认证/会话/租户上下文主逻辑集中在 `apps/api/src/modules/auth/*`
  - 路由声明与执行路由映射分离（`route-permissions` + `server`）
  - 前端主状态仍集中在 `apps/web/src/App.jsx`，tenant 变更逻辑已抽离到 `tenant-mutation.mjs`
- 注意事项：
  - 若本故事需要新增 platform 受保护业务接口，必须先补齐 route declaration 与 permission scope 规则，再接入 handler。
  - 不建议在本故事引入大规模目录重构；先保证双域边界稳定与可测试。

### References

- Story 1.6 定义与 AC
  [Source: _bmad-output/planning-artifacts/epics.md#Story 1.6: 双域权限边界与服务端租户最终判定]
- 双域边界与租户最终判定要求（FR26/FR51/FR70）
  [Source: _bmad-output/planning-artifacts/prd.md]
- 架构硬约束（双域 RBAC、Problem Details、门禁）
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 一致性约束（反馈语义、提交防重、Chrome 回归）
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事实现与复盘
  [Source: _bmad-output/implementation-artifacts/1-5-菜单-按钮-api-访问控制与统一拒绝语义.md]
- Node.js 官方版本页
  [Source: https://nodejs.org/en/download/current]
- MySQL 8.4 Release Notes
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

gpt-5-codex

### Debug Log References

- `cat _bmad-output/implementation-artifacts/sprint-status.yaml`
- `cat _bmad-output/planning-artifacts/epics.md`
- `cat _bmad-output/planning-artifacts/prd.md`
- `cat _bmad-output/planning-artifacts/architecture.md`
- `cat _bmad-output/planning-artifacts/ux-design-specification.md`
- `cat _bmad-output/implementation-artifacts/1-5-菜单-按钮-api-访问控制与统一拒绝语义.md`
- `git log --oneline -n 5`
- `git show --name-only --pretty=format:'COMMIT %H%nTITLE %s%nDATE %cI%n' -n 5`
- `pnpm view @nestjs/core version`
- `pnpm view react version`
- `pnpm view typeorm version`
- `pnpm view vite version`
- `pnpm view ioredis version`
- `pnpm view mysql2 version`
- `pnpm view ioredis time`
- `pnpm view mysql2 time`
- `pnpm view @nestjs/core time`
- `pnpm view react time`
- `pnpm view vite time`
- `pnpm view typeorm time`
- `pnpm --dir apps/api audit --prod --json` (failed: `ENOTFOUND registry.npmjs.org`)
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.domain.api.test.js test/route-permissions.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/web exec node --test --test-force-exit test/chrome.playwright.test.js`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web lint`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/auth.express.api.test.js`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/server.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api check:route-permissions`

### Completion Notes List

- ✅ 已完成 Story 1.6 的全量上下文编制：业务目标、AC、任务拆分、架构护栏、测试策略、前序情报、版本核验。
- ✅ 已基于当前仓库实现给出可执行变更落点（API、Web、测试、门禁）。
- ✅ 已完成最新版本与官方来源核验（Node/MySQL/npm registry）。
- ⚠️ `validate-workflow.xml` 在 `_bmad/core/tasks/` 下不存在，已按 `checklist.md` 执行手工校验替代并保留说明。
- ✅ 新增 `platform` scope 路由与权限码，固化 `platform`/`tenant` 双域权限命名空间隔离与 scope 门禁。
- ✅ `authorizeRoute` 增加平台域判定与对称跨域拒绝：tenant 入口访问 platform scope 统一返回 `AUTH-403-NO-DOMAIN`。
- ✅ 新增平台权限并集模型（支持多角色并集，禁用角色不参与，显式 deny 字段不覆盖并集）。
- ✅ 审计字段补齐：域拒绝路径增加 `permission_code` 字段（空值语义保留）。
- ✅ OpenAPI 新增平台 probe 403 示例，保证 `AUTH-403-NO-DOMAIN` / `AUTH-403-FORBIDDEN` 与实现一致。
- ✅ 完成 API/Web 回归：`apps/api` 全测、`apps/web` 全测（含 chrome）、lint 与 `check:route-permissions` 全通过。
- ✅ Story 状态更新为 `review`，可进入 code-review。
- ✅ Code Review 修复：移除平台权限默认全放行（内存与 MySQL 路径均 fail-closed），补齐 `auth.domain.rejected` 的 `permission_code` 审计字段，并新增回归测试。
- ✅ Code Review 二轮修复：补齐 MySQL `auth_user_domain_access` 平台权限快照迁移（`0006`）与 preflight 必需列，补齐集成与迁移基线回归，`apps/api` 全测通过（173/173）。
- ✅ Code Review 三轮修复：在无外部同步器前提下补齐平台权限事实源与快照收敛链路（`0007`），新增“角色写入同事务同步快照 + 鉴权前快照同步（有事实源时）”，并补齐审计 `permission_code` 与迁移/存储回归测试。
- ✅ Code Review 四轮修复：补齐 `auth_user_platform_roles` 启动期 preflight、收敛“空角色事实残留快照”风险，并统一 `enabled` 状态兼容语义与回归测试。
- ✅ Code Review 五轮修复：修复 MySQL 平台角色同步误恢复域状态风险，统一内存存储 `enabled` 兼容语义，并补齐回归；`apps/api` 全测通过（182/182）。
- ✅ Code Review 六轮修复：修正 `sprint-status.yaml` 路径漂移与 Story 状态元数据不一致，统一 413 错误 `detail` 与 OpenAPI 契约并补齐 API/Express 回归断言。
- ✅ Code Review 七轮修复：补齐 `0006` 迁移/回滚幂等守卫（`information_schema + PREPARE`）并新增基线守卫断言；`apps/api` 全测通过（183/183）。
- ✅ Code Review 八轮复审：执行 `check:route-permissions` + 迁移基线 + `apps/api` 全量测试，未发现新增问题（High/Medium/Low = 0）。
- ✅ Code Review 九轮修复：补齐 `0007` 历史快照回填、修复空角色集误授予平台域入口、收敛平台快照无差异写入放大；`apps/api` 全测通过（184/184）。
- ✅ Code Review 十轮复审：执行 `check:route-permissions` + 迁移基线 + `auth.store.mysql` 组合回归 + `apps/api` 全量测试，未发现新增问题（High/Medium/Low = 0）。
- ✅ Code Review 十一轮修复：修复空角色快照无差异写放大、平台角色重复 `role_id` 顺序依赖与重复写库、平台权限 `SELECT *` 过宽查询；新增回归后 `apps/api` 全测通过（189/189）。
- ✅ Code Review 十二轮修复：补齐平台快照增量同步（避免每次鉴权全量读取角色事实）、统一平台角色事实状态白名单校验、迁移回填 `role_id` 保留命名空间；新增回归后 `apps/api` 全测通过（191/191），`apps/web` 全测通过（13/13）。
- ✅ Code Review 十三轮修复：补齐平台权限快照同步并发守卫，防止角色事实并发变更时回写旧快照；新增并发回归后 `apps/api` 全测通过（193/193）。
- ✅ Code Review 十四轮修复：连续并发冲突场景改为 fail-closed（503 退化）并补齐 OpenAPI 503 契约，修复 Story `File List` 漏登记；新增回归后 `apps/api` 全测通过（199/199）。
- ✅ Code Review 十五轮补测：补齐平台快照同步未知 reason 退化分支回归，复跑 `apps/api` 全测（203/203）与 `apps/web` 全测（13/13）通过。
- ✅ Code Review 十六轮修复：收敛空 reason fail-open 风险、修正快照等时戳短路判定、修复 `0007` 重复执行状态覆盖风险；补齐回归后 `apps/api` 全测通过（205/205），`apps/web` 全测通过（13/13）。
- ✅ Code Review 十七轮修复：补齐 schema preflight 对 `updated_at` 必需列校验，并增强平台快照并发守卫为 `COUNT + MAX(updated_at) + checksum`；新增同计数同最大时戳并发漂移回归后 `apps/api` 全测通过（206/206）。
- ✅ Code Review 十八轮修复：修复默认平台域并发插入分支误恢复状态风险、补齐角色事实 upsert 路径 `updated_at` 推进、增强死锁退避随机值容错；新增回归后 `apps/api` 全测通过（208/208），`apps/web` 全测通过（13/13）。

### File List

- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/app.js
- apps/api/src/route-permissions.js
- apps/api/src/server.js
- apps/api/src/http-routes.js
- apps/api/src/openapi.js
- apps/api/migrations/0006_auth_platform_permission_snapshot.sql
- apps/api/migrations/0006_auth_platform_permission_snapshot.down.sql
- apps/api/migrations/0007_auth_platform_role_facts.sql
- apps/api/migrations/0007_auth_platform_role_facts.down.sql
- apps/api/scripts/stress-platform-sync-mysql.js
- apps/api/test/auth.service.test.js
- apps/api/test/auth.domain.api.test.js
- apps/api/test/auth.express.api.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/migrate-baseline.test.js
- apps/api/test/route-permissions.test.js
- apps/api/test/server.test.js
- _bmad-output/implementation-artifacts/1-6-双域权限边界与服务端租户最终判定.md
- _bmad-output/implementation-artifacts/code-review-1-3.md (deleted)
- _bmad-output/implementation-artifacts/sprint-status.yaml
- _bmad-output/planning-artifacts/epics.md
- _bmad-output/planning-artifacts/prd.md

### Change Log

- 2026-02-14：完成 Story 1.6 实现与测试，状态从 `ready-for-dev` 更新为 `review`。
- 2026-02-14：完成 Code Review 修复与补测，状态从 `review` 更新为 `review`。
- 2026-02-14：完成 Code Review 二轮修复（迁移 + MySQL 集成回归 + preflight 对齐），状态从 `review` 更新为 `done`。
- 2026-02-14：完成 Code Review 三轮修复（平台角色事实源 + 事务内快照同步 + 鉴权前快照收敛 + 审计字段补齐），状态保持 `done`。
- 2026-02-14：完成 Code Review 四轮修复（`auth_user_platform_roles` preflight + 空角色事实强制收敛 + `enabled` 语义一致性），状态保持 `done`。
- 2026-02-14：完成 Code Review 五轮修复（平台域状态回写保护 + 内存存储 `enabled` 兼容 + 文件清单漂移修复），状态保持 `done`。
- 2026-02-14：完成 Code Review 六轮修复（路径元数据对齐 + Story 状态元数据收敛 + 413 错误文案契约对齐），状态保持 `done`。
- 2026-02-14：完成 Code Review 七轮修复（`0006` 迁移/回滚幂等守卫 + 迁移基线守卫断言），状态保持 `done`。
- 2026-02-14：完成 Code Review 八轮复审（高/中/低问题均为 0），状态保持 `done`。
- 2026-02-14：完成 Code Review 九轮修复（`0007` 回填 + 空角色集域记录保护 + 平台快照条件更新），状态保持 `done`。
- 2026-02-14：完成 Code Review 十轮复审（高/中/低问题均为 0），状态保持 `done`。
- 2026-02-14：完成 Code Review 十一轮修复（去重 + 写放大收敛 + 查询面收敛），状态保持 `done`。
- 2026-02-15：完成 Code Review 十二轮修复（平台快照增量同步 + 角色事实状态白名单 + `0007` 回填 `role_id` 保留命名空间），状态保持 `done`。
- 2026-02-15：完成 Code Review 十三轮修复（平台快照同步并发守卫 + 服务层单次重试 + 并发回归），状态保持 `done`。
- 2026-02-15：完成 Code Review 十四轮修复（连续并发冲突 fail-closed + OpenAPI 503 契约补齐 + File List 对齐），状态保持 `done`。
- 2026-02-15：完成 Code Review 十五轮补测（平台快照同步未知 reason 回归补齐 + API/Web 全量回归），状态保持 `done`。
- 2026-02-15：完成 Code Review 十六轮修复（空 reason fail-closed、等时戳重算、防止 `0007` 重跑覆盖角色状态）并复跑 API/Web 全量回归，状态保持 `done`。
- 2026-02-15：完成 Code Review 十七轮修复（preflight `updated_at` 列对齐 + 平台快照 checksum 并发守卫）并复跑 `apps/api` 全量回归，状态保持 `done`。
- 2026-02-15：完成 Code Review 十八轮修复（默认平台域并发插入状态保护 + 平台快照 upsert 时间戳推进 + 死锁退避随机值容错）并复跑 `apps/api`/`apps/web` 全量回归，状态保持 `done`。

## Senior Developer Review (AI)

### Reviewer

老大（AI）

### Date

2026-02-14

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0（已修复 2）
2. [MEDIUM] 0（已修复 1）
3. [LOW] 0

### Validation

- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`

以上命令通过（184/184）。

### Re-Review (Round 10)

### Date

2026-02-14

### Outcome

Approve（复审未发现新增问题）

### Findings

1. [HIGH] 0
2. [MEDIUM] 0
3. [LOW] 0

### Validation

- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`

以上命令通过（`apps/api` 187/187，`apps/web` 13/13）。

### Re-Review (Round 11)

### Date

2026-02-14

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0
2. [MEDIUM] 0（已修复 2）
3. [LOW] 0（已修复 1）

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api test`

以上命令通过（`apps/api` 189/189）。

### Re-Review (Round 12)

### Date

2026-02-15

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0
2. [MEDIUM] 0（已修复 2）
3. [LOW] 0（已修复 1）

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`

以上命令通过（`apps/api` 191/191，`apps/web` 13/13）。

### Re-Review (Round 13)

### Date

2026-02-15

### Outcome

Approve（本轮发现 1 项问题并已修复）

### Findings

1. [HIGH] 0
2. [MEDIUM] 0（已修复 1）
3. [LOW] 0

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js test/auth.express.api.test.js`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

以上命令通过（`apps/api` 193/193）。

### Re-Review (Round 14)

### Date

2026-02-15

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0（已修复 1）
2. [MEDIUM] 0（已修复 1）
3. [LOW] 0（已修复 1）

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/server.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`

以上命令通过（`apps/api` 199/199）。

### Re-Review (Round 15)

### Date

2026-02-15

### Outcome

Approve（本轮发现 1 项问题并已修复）

### Findings

1. [HIGH] 0
2. [MEDIUM] 0
3. [LOW] 0（已修复 1）

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`

以上命令通过（`apps/api` 203/203，`apps/web` 13/13）。

### Re-Review (Round 16)

### Date

2026-02-15

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0（已修复 1）
2. [MEDIUM] 0（已修复 2）
3. [LOW] 0

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.store.mysql.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`

以上命令通过（`apps/api` 205/205，`apps/web` 13/13）。

### Re-Review (Round 18)

### Date

2026-02-15

### Outcome

Approve（本轮发现 3 项问题并已全部修复）

### Findings

1. [HIGH] 0（已修复 1）
2. [MEDIUM] 0（已修复 1）
3. [LOW] 0（已修复 1）

### Validation

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`

以上命令通过（`apps/api` 208/208，`apps/web` 13/13）。
