# Story 2.5: 平台权限树配置与角色分配生效

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 配置平台角色权限树并向平台用户分配角色,  
so that 新老平台成员都能在授权范围内执行操作。

## Acceptance Criteria

1. **Given** 平台管理员编辑角色权限树  
   **When** 保存权限配置  
   **Then** 系统持久化最终授权结果  
   **And** 权限变更可被后续鉴权即时读取
2. **Given** 平台管理员向用户分配 1 到 5 个平台角色  
   **When** 分配请求通过校验  
   **Then** 系统完成角色绑定  
   **And** 用户有效权限按并集模型重算
3. **Given** 新增平台成员已完成角色分配  
   **When** 该成员登录平台入口  
   **Then** 成员可以进入平台并执行授权范围内动作  
   **And** 超出权限范围操作被一致拒绝

## Tasks / Subtasks

- [x] 任务 1：实现平台角色权限树配置能力（AC: 1）
  - [x] 为平台角色新增“权限授予结果”持久化模型（建议新增 `platform_role_permission_grants`，按 `role_id + permission_code` 唯一约束）。
  - [x] 新增/扩展角色权限配置接口（建议 `GET /platform/roles/:role_id/permissions`、`PUT /platform/roles/:role_id/permissions`）。
  - [x] 保存策略必须“仅落最终授权结果”（叶子权限码），不得持久化仅用于 UI 展示的父节点状态（对齐 FR74）。
  - [x] 权限码来源必须来自服务端统一权限清单，且仅允许 `platform.*` 命名空间（对齐 FR26/FR73）。
  - [x] 受保护角色（如 `sys_admin`）允许配置权限授予，但不得破坏 Story 2.4 已交付的“不可编辑/删除角色定义”约束。

- [x] 任务 2：收敛平台角色分配为“服务端角色定义驱动”并维持 1-5 约束（AC: 2）
  - [x] 复用现有分配主链路 `authService.replacePlatformRolesAndSyncSnapshot`，禁止新造第二套角色分配引擎。
  - [x] 分配请求只接受 `role_id` 列表语义（1-5 个、去重、均为 `platform` 且状态为 `active`），拒绝客户端直接提交权限快照字段。
  - [x] 分配成功后按“角色 -> 权限授予结果 -> 用户有效权限并集”重算，并更新平台权限上下文快照。
  - [x] 对角色不存在、角色禁用、越域角色、数量越界、重复角色等输入返回稳定 Problem Details 语义。

- [x] 任务 3：实现“权限树变更后即时可读”的鉴权生效路径（AC: 1, 2, 3）
  - [x] 角色权限授予更新后，触发受影响平台用户的权限快照刷新与会话收敛（`session_version` 联动），确保后续鉴权即时读到新权限。
  - [x] 刷新/收敛链路在依赖退化时必须 fail-closed（返回 503），不得出现 silent fail-open。
  - [x] 审计最小事件集至少覆盖：角色权限树保存、角色分配更新、权限快照重算成功/失败（含 `request_id`、操作者、目标对象、失败原因）。

- [x] 任务 4：补齐契约、路由权限声明与权限清单一致性（AC: 1, 2, 3）
  - [x] 更新 OpenAPI：新增/更新权限树配置与角色分配接口请求响应、错误示例（400/401/403/404/409/413/503）。
  - [x] 更新 `route-permissions`：所有新增受保护接口显式声明 `permission_code` 与 `scope=platform`。
  - [x] 校验“权限清单-路由声明-鉴权 evaluator”三方一致，避免出现未知权限码或错误 scope。
  - [x] 外部字段保持 `snake_case`，内部命名维持现有风格，通过映射层转换。

- [x] 任务 5：交付回归矩阵（API + 鉴权 + 会话一致性）（AC: 1, 2, 3）
  - [x] AC1 回归：权限树保存成功、保存后读取一致、非法权限码拒绝、跨域权限码拒绝。
  - [x] AC2 回归：1-5 角色分配成功，0 或 >5 失败，重复角色失败，禁用角色失败，越域角色失败。
  - [x] AC2 并集回归：多角色权限并集计算正确，不引入显式 deny，禁用角色不参与有效权限。
  - [x] AC3 回归：新成员分配角色后平台入口可访问；未授权平台动作一致拒绝（`AUTH-403-FORBIDDEN` 或等价标准语义）。
  - [x] 一致性回归：权限树更新后已登录用户权限即时收敛，不出现旧会话持续放行。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 角色分配空列表未被拒绝，与 AC2“1-5 个角色”不一致，已在强校验路径增加最小数量约束并补回归用例（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][MEDIUM] 权限码大小写在内存/数据库存储语义不一致，已统一权限码规范化为小写并补回归用例（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][MEDIUM] 权限授予写入在重算依赖预检前执行，可能出现“返回 503 但已落库”部分提交，已前置依赖能力与受影响用户查询预检并补回归用例（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][HIGH] 权限授予重算链路复用预写入角色快照，存在并发场景覆盖新角色事实的风险；已改为写入后重新加载用户角色事实再执行重算，并补针对性回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 权限授予写入阶段遇到“角色已被并发删除”时返回 400，语义不稳定；已映射为稳定 404 并补 API 回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/src/modules/platform/role.service.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][LOW] Story 2.5 的建议变更落点残留未实际变更文件（`apps/api/test/auth.store.mysql.test.js`）；已同步文档保持实现/文档一致（`_bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md`）。
- [x] [AI-Review][MEDIUM] 权限授予更新仅使用写入前受影响用户集，存在并发角色分配用户遗漏重算风险；已在写入后二次加载并合并受影响用户再执行重算，并补回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] 角色分配强校验路径允许大小写 `role_id` 原样落库，可能导致目录与事实层表示漂移；已统一为小写规范化持久化，并补回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] `platform_role_permission_grants` 的 schema preflight 未校验写入必需列（`created_by_user_id`/`updated_by_user_id`），可能启动通过但运行写入失败；已补列校验与 express preflight 回归（`apps/api/src/app.js`、`apps/api/test/auth.express.api.test.js`）。
- [x] [AI-Review][MEDIUM] `PUT /platform/roles/:role_id/permissions` 幂等范围未对 `role_id` 路径参数做大小写规范化，同键可通过路径大小写变体绕过冲突检测；已补 `role_id` 规范化并新增回归（`apps/api/src/server.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][MEDIUM] MySQL `listUserIdsByPlatformRoleId` 使用 `LOWER(role_id)` 过滤，存在高频重算路径下的可预见性能退化；已改为 `role_id = ?` 等值过滤（`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][LOW] 内存/MySQL store 对权限码归一化策略不一致（保留输入大小写），存在实现层语义漂移风险；已统一写入前归一化为小写（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][HIGH] 权限授予重算仅以用户当前快照权限作为非目标角色权限来源，存在“过期快照覆盖角色授权事实”风险；已改为按角色授权事实源重建每个角色权限并补回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 权限授予重算阶段遇到存量脏 role facts 时返回 400，未满足依赖退化 fail-closed 语义；已映射为稳定 503 并补回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] `platform_role_permission_grants` preflight 仍未校验 `created_at`，存在“启动可过但时间字段不完整”隐患；已补列校验并同步 express 夹具（`apps/api/src/app.js`、`apps/api/test/auth.express.api.test.js`）。
- [x] [AI-Review][HIGH] 权限树读写复用“仅 active 角色可用”校验，导致 `disabled` 角色无法配置权限树，与角色治理预期不一致；已为权限树读写链路放宽为“允许 disabled 且 scope=platform”并补 API 回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/platform.role.api.test.js`）。
- [x] [AI-Review][MEDIUM] 权限授予查询链路对 store 返回畸形 grants 结构映射为 400/404，未满足依赖异常 fail-closed 503 语义；已统一映射为稳定 503 并补服务层回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] `permission_codes` 请求数组缺少上限约束，存在可预见的无效负载放大风险；已增加 `maxItems=64` 与服务端硬校验并补 API/OpenAPI 回归（`apps/api/src/modules/platform/role.service.js`、`apps/api/src/openapi.js`、`apps/api/test/platform.role.api.test.js`、`apps/api/test/server.test.js`）。
- [x] [AI-Review][HIGH] 权限授予写入与受影响用户快照收敛存在崩溃中间态窗口；已在 MySQL store 引入单事务原子更新（写 grants + 收敛快照）并设置受影响用户上限（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.service.js`）。
- [x] [AI-Review][MEDIUM] `auth_user_platform_roles` 缺少 `role_id` 前导索引，导致受影响用户查询存在可预见扫描退化；已新增复合索引迁移（`apps/api/migrations/0011_auth_user_platform_roles_role_id_index.sql`）。

## Dev Notes

### Developer Context（开发者必须先读）

- Story 2.4 已交付平台角色目录治理（`/platform/roles`）与受保护角色约束，当前故事必须在该基线上增量演进，禁止推翻既有接口语义。
- 当前已有角色分配入口 `POST /auth/platform/role-facts/replace` 与快照同步链路；本故事应复用该链路并收敛为“服务端角色定义驱动”，不要并行建设第二套分配引擎。
- 现有权限判定核心在 `auth.service` 的权限 evaluator 与 scope 规则；权限树能力必须接入统一清单与 evaluator，避免“可配置但不可鉴权”的漂移。
- 平台域与组织域边界是硬约束：`platform.*` 与 `tenant.*` 独立配置、独立生效、不得越域提升能力。

### Technical Requirements（实现硬约束）

- 统一错误契约：`application/problem+json`，至少包含 `status`、`detail`、`error_code`、`request_id`、`retryable`（适用时）。
- 权限树保存仅落“最终授权结果”（权限码集合），不落中间树态（父子联动仅用于前端交互态）。
- 平台角色权限仅允许 `platform.*`；任何 `tenant.*` 或未知权限码必须拒绝。
- 平台用户角色分配数量必须严格限制在 1-5，且为去重后的有效角色集合。
- 分配时服务端必须按角色定义解析权限，不接受客户端直传权限快照以防越权注入。
- 有效权限按角色并集计算（FR49），不引入显式 deny；禁用角色不得贡献有效权限（FR75）。
- 角色权限或角色绑定变更后必须触发会话收敛并可被后续鉴权即时读取（FR30/FR79 对齐）。
- 依赖退化（权限目录不可用、快照重算失败等）必须 fail-closed，返回稳定 503 语义，禁止静默放行。

### Architecture Compliance（架构对齐清单）

- 能力归属保持在 `modules/platform`（治理编排）+ `modules/auth`（鉴权/快照）边界内，不在路由层散落业务逻辑。
- 受保护接口必须经 `route-permissions` 声明并通过预检，不允许“实现有接口、声明无权限码”。
- 模块间通信仅通过 service 边界；禁止跨模块直接操作私有 store/repository 实现。
- 保持 Problem Details、幂等语义、审计事件、`request_id` 贯穿与既有实现一致。
- 保持 MySQL 与 in-memory store 语义一致，避免“本地可过、集成失效”。

### Library & Framework Requirements（库与框架要求）

- 仓库当前基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-18 实时核验（官方源）：
  - Node.js Latest: `v25.6.1`
  - Node.js Latest LTS: `v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
- 本故事策略：不做依赖升级；在当前锁定版本上完成权限树与角色分配生效闭环。

### File Structure Requirements（建议变更落点）

- 迁移（新增）：
  - `apps/api/migrations/0010_platform_role_permission_grants.sql`
  - `apps/api/migrations/0010_platform_role_permission_grants.down.sql`
- 平台角色治理（修改/新增）：
  - `apps/api/src/modules/platform/role.constants.js`
  - `apps/api/src/modules/platform/role.routes.js`
  - `apps/api/src/modules/platform/role.service.js`
- 鉴权与快照（修改）：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 路由与契约（修改）：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/openapi.js`
- 测试（新增/修改）：
  - `apps/api/test/platform.role.api.test.js`
  - `apps/api/test/auth.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- AC1：权限树配置
  - 角色权限树保存成功并持久化为最终授权结果。
  - 再次读取与保存结果一致（幂等）。
  - 非法权限码、跨域权限码、未知权限码均被拒绝。
- AC2：角色分配与并集生效
  - 1-5 个有效角色分配成功并返回稳定语义。
  - 0 个、超过 5 个、重复角色、禁用角色、不存在角色、跨域角色均失败并返回稳定错误码。
  - 多角色权限并集计算正确，且禁用角色不计入有效权限。
- AC3：登录后授权行为
  - 新平台成员分配角色后可进入平台入口。
  - 未授权动作被一致拒绝，授权动作可执行。
  - 角色权限树更新后，既有会话权限可在收敛后即时反映。
- 回归与门禁
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence

- 来自 Story 2.4 的关键约束必须继承：
  - 路由参数规范化与幂等作用域要一致，避免路径变体绕过。
  - 目录/查询依赖异常必须 fail-closed，不得 fallback 为隐式放行。
  - `role_id` 可寻址规则（格式、编码解码、安全性）必须持续保持。
  - OpenAPI、实现与回归三方需同步，防止契约漂移。
- 对 Story 2.5 的直接启发：
  - 权限模型变更要以“可回归增量”推进，不做破坏性重构。
  - 所有高风险路径（分配、鉴权、快照收敛）必须有针对性回归用例覆盖。

### Git Intelligence Summary

- 最近 5 次提交热点集中在：
  - `apps/api/src/modules/platform/*`
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可执行结论：
  - 优先采用“平台治理编排 + auth 快照联动 + 契约/测试同步”的小步增量。
  - 避免一次性大改鉴权主链路，确保每步变更都可独立回归。

### Latest Tech Information（2026-02-18）

- Node.js 官方发布索引：Latest `v25.6.1`；Latest LTS `v24.13.1`。
- npm registry 最新版本：`@nestjs/core 11.1.14`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`。
- 当前仓库运行环境（本地）：`node v25.2.1`。
- 结论：以现有锁定版本实现故事，暂不引入升级风险。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 当前故事上下文来源：
  - `epics.md`
  - `prd.md`
  - `prd-appendix-legacy-inputs.md`
  - `architecture.md`
  - `ux-design-specification.md`
  - 前序故事 `2-4-平台角色管理与受保护角色约束.md`
  - 最近 5 次 git 提交历史与当前代码结构

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed with all HIGH/MEDIUM findings fixed and regression suite passing`

### Project Structure Notes

- 当前仓库已具备 `platform/org`、`platform/user`、`platform/role` 模块化分层；Story 2.5 应在既有模块内扩展，避免横向散落。
- 角色分配主链路建议继续复用 `auth/platform/role-facts/replace` 的服务能力，由平台治理层负责输入收敛与语义编排。
- 权限树能力优先落“最终授权结果 + 鉴权可读 + 回归可证”，UI 树态联动仅作为展示与编辑体验层，不进入后端事实存储。

### References

- Epic 2 / Story 2.5（用户故事与 AC）  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.5: 平台权限树配置与角色分配生效]
- FR16/FR17/FR18、FR26、FR49、FR74、FR75（平台权限树与角色分配约束）  
  [Source: _bmad-output/planning-artifacts/prd.md#平台治理能力（Platform Governance）]  
  [Source: _bmad-output/planning-artifacts/prd.md#权限与授权执行]
- 数据模型与权限树落库参考（roles/permissions/role_permissions/user_roles）  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Database Entity Field Catalog (Detailed)]
- 架构边界、命名规范、权限声明门禁  
  [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries]  
  [Source: _bmad-output/planning-artifacts/architecture.md#Enforcement Guidelines]
- UX 交互一致性（提交 loading、防重复提交）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Journey Patterns]
- 前序故事经验（Story 2.4）  
  [Source: _bmad-output/implementation-artifacts/2-4-平台角色管理与受保护角色约束.md]
- 现有实现基线  
  [Source: apps/api/src/modules/platform/role.service.js]  
  [Source: apps/api/src/modules/auth/auth.routes.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/openapi.js]
- 版本核验来源  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex (CLI)

### Debug Log References

- `pnpm --dir apps/api check:route-permissions`（通过）
- `pnpm --dir apps/api lint`（通过，51 files checked）
- `pnpm --dir apps/api test`（通过，548 passed / 0 failed）
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`（通过，136 passed / 0 failed）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`（通过，50 passed / 0 failed）
- `pnpm --dir apps/api exec node --test --test-force-exit test/platform.role.api.test.js`（通过，26 passed / 0 failed）
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/auth.service.test.js test/server.test.js`（通过，221 passed / 0 failed）

### Completion Notes List

- ✅ 完成平台角色权限授予结果持久化：新增 `platform_role_permission_grants` 迁移，并接入启动期 schema preflight。
- ✅ 新增角色权限树接口：`GET/PUT /platform/roles/:role_id/permissions`，仅接受并返回 `platform.*` 最终授权权限码集合。
- ✅ 角色分配收敛到“服务端角色定义驱动”：`POST /auth/platform/role-facts/replace` 在启用校验路径下仅接受角色事实（`role_id`/`status`），拒绝客户端权限快照注入。
- ✅ 分配与权限变更后执行权限并集重算、快照同步与会话收敛（`session_version` 变更触发旧会话失效），并对依赖退化保持 fail-closed（503）。
- ✅ 补齐 OpenAPI、路由权限声明与运行时路由映射一致性；新增权限路由幂等声明与响应语义。
- ✅ 回归覆盖 AC1/AC2/AC3 与一致性场景：新增/扩展 platform role API、route-permissions、server/openapi 与 mysql preflight 测试。
- ✅ 代码评审修复：强校验路径下角色分配最小数量改为 1（拒绝空列表），与 AC2 对齐。
- ✅ 代码评审修复：权限码统一小写规范化，消除 in-memory 与 mysql 在大小写输入下的语义漂移。
- ✅ 代码评审修复：权限授予更新链路前置依赖与受影响用户预检，避免 503 场景下先落库后失败。
- ✅ 代码评审修复：权限授予重算在写入后重新读取角色事实，避免复用陈旧快照覆盖并发更新。
- ✅ 代码评审修复：权限授予写入阶段角色并发删除统一返回 404 语义，并补接口回归测试。
- ✅ 文档修复：移除建议变更落点中未实际变更的 `auth.store.mysql.test.js`，保持文档与实现一致。
- ✅ 代码评审修复：权限授予写入后新增“受影响用户二次加载并合并重算”流程，降低并发角色分配下的漏重算风险。
- ✅ 代码评审修复：角色分配强校验链路的 `role_id` 统一小写落库，消除目录/事实层大小写表示漂移。
- ✅ 代码评审修复：`platform_role_permission_grants` preflight 增补写入必需列校验（`created_by_user_id`、`updated_by_user_id`），并同步 MySQL express 回归夹具。
- ✅ 代码评审修复：新增权限树写接口幂等路径参数规范化（`role_id` 大小写统一）并补 API 回归，阻断同键路径变体绕过幂等冲突检测。
- ✅ 代码评审修复：MySQL 受影响用户查询移除 `LOWER(role_id)` 包裹，改为等值过滤，降低权限授予重算路径扫描开销。
- ✅ 代码评审修复：统一 in-memory / MySQL 权限码写入归一化为小写，消除底层实现语义漂移。
- ✅ 代码评审修复：权限授予重算不再依赖非目标角色的快照权限，改为按角色授权事实源重建，避免过期快照覆盖并发/历史授权事实。
- ✅ 代码评审修复：权限授予重算阶段存量脏 role facts 统一按依赖退化映射为 503，避免内部数据异常对外暴露 400 误导语义。
- ✅ 代码评审修复：`platform_role_permission_grants` schema preflight 补齐 `created_at` 必需列校验，并同步 express schema 夹具。
- ✅ 代码评审修复：权限树读写链路允许 `disabled` 平台角色配置权限授予，避免角色禁用态下无法预配置权限树。
- ✅ 代码评审修复：权限授予查询链路对畸形 grants 返回统一按依赖退化映射为 503，避免错误分类为 400/404。
- ✅ 代码评审修复：`permission_codes` 增加最大数量约束（`64`）并同步 OpenAPI，抑制异常大负载输入。
- ✅ 代码评审修复：MySQL 路径将“权限授予写入 + 受影响用户快照收敛”收敛为单事务原子操作，避免崩溃中间态。
- ✅ 代码评审修复：为 `auth_user_platform_roles` 增补 `role_id` 前导索引并接入迁移/回归，稳定角色维度查询性能。

### Senior Developer Review (AI)

- 审查结论：`Changes Requested`（已修复并重新验证）
- Findings：
  - `HIGH`：权限授予重算链路复用预写入角色快照，存在并发覆盖风险。
  - `MEDIUM`：权限授予写入阶段角色并发删除返回 400，错误语义不稳定。
  - `LOW`：建议变更落点文档残留未实际变更文件，存在文档漂移。
  - `MEDIUM`：权限授予更新仅使用写入前受影响用户集，并发角色分配存在漏重算窗口。
  - `LOW`：角色分配强校验路径未统一 `role_id` 大小写持久化，存在表示漂移风险。
  - `MEDIUM`：`platform_role_permission_grants` preflight 列校验不完整，存在启动后运行期写入失败窗口。
  - `MEDIUM`：权限树写接口幂等路径参数未规范化，存在同键路径变体绕过冲突检测风险。
  - `MEDIUM`：受影响用户查询使用 `LOWER(role_id)`，在重算高频路径存在可预见性能退化。
  - `LOW`：in-memory / MySQL store 权限码归一化策略不一致，存在实现层语义漂移风险。
  - `HIGH`：权限授予重算对非目标角色复用快照权限，存在授权事实回退与覆盖风险。
  - `MEDIUM`：权限授予重算阶段 role facts 脏数据映射为 400，未满足 fail-closed 503 语义。
  - `LOW`：`platform_role_permission_grants` preflight 未覆盖 `created_at` 列，存在时间字段契约漏检窗口。
  - `HIGH`：权限树读写链路误复用 active-only 角色校验，导致 disabled 角色无法配置权限树。
  - `MEDIUM`：权限授予查询链路对畸形 grants 结构错误映射为 400/404，未 fail-closed 到 503。
  - `LOW`：`permission_codes` 缺少上限约束，存在可预见的异常负载放大风险。
- Resolution：以上问题已全部修复，并新增/更新针对性回归测试，当前无未解决 HIGH/MEDIUM 问题。

### File List

- `apps/api/migrations/0010_platform_role_permission_grants.sql`
- `apps/api/migrations/0010_platform_role_permission_grants.down.sql`
- `apps/api/migrations/0011_auth_user_platform_roles_role_id_index.sql`
- `apps/api/migrations/0011_auth_user_platform_roles_role_id_index.down.sql`
- `apps/api/src/app.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/platform/role.constants.js`
- `apps/api/src/modules/platform/role.routes.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.api.test.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/platform.role.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md`

### Change Log

- 2026-02-18：完成 Story 2.5（权限树配置、角色分配生效、会话收敛、契约与回归矩阵），状态更新为 `review`。
- 2026-02-18：执行代码评审并完成修复（空角色分配约束、权限码规范化、权限授予写入前预检），状态更新为 `done`。
- 2026-02-18：执行复审并完成修复（重算并发覆盖风险、角色并发删除 404 语义、文档落点漂移修正），状态维持 `done`。
- 2026-02-18：执行复审并完成修复（写入后二次加载受影响用户并重算、`role_id` 小写规范化落库、权限授予 preflight 列校验补齐），状态维持 `done`。
- 2026-02-18：执行复审并完成修复（权限树写接口幂等路径参数规范化、MySQL 受影响用户查询性能修正、store 权限码归一化一致性修正），状态维持 `done`。
- 2026-02-18：执行复审并完成修复（非目标角色按授权事实源重建权限、role facts 脏数据 fail-closed 503 映射、preflight 增补 `created_at` 校验），状态维持 `done`。
- 2026-02-18：执行复审并完成修复（disabled 角色权限树可配置、畸形 grants 结构 fail-closed 503、`permission_codes` 上限约束与 OpenAPI 对齐），状态维持 `done`。
- 2026-02-18：执行复审并完成修复（权限授予写入与快照收敛单事务原子化、`auth_user_platform_roles` 增补 `role_id` 前导索引与迁移回归），状态维持 `done`。
