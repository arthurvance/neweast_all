# Story 2.6: 平台侧负责人变更入口

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 在平台侧发起组织负责人变更,  
so that 组织治理责任可以被安全移交，并与 Epic 3 的接管闭环通过明确契约衔接。

## Acceptance Criteria

1. **Given** 平台管理员具备负责人变更权限  
   **When** 发起负责人变更请求  
   **Then** 系统进入受控变更流程  
   **And** 变更结果返回可识别状态
2. **Given** 负责人变更请求不满足前置条件  
   **When** 系统校验失败  
   **Then** 系统拒绝变更  
   **And** 返回标准错误码与可恢复提示
3. **Given** Story 2.6 已进入交付验收  
   **When** 评估本故事完成边界  
   **Then** 本故事仅交付平台侧发起入口与请求校验能力  
   **And** 不承诺在 Epic 2 内完成接管闭环能力
4. **Given** 平台侧发起负责人变更请求  
   **When** 进入跨 Epic 协作链路  
   **Then** 输出固定契约字段：`request_id`、`org_id`、`old_owner_user_id`、`new_owner_user_id`、`result_status`、`error_code`、`retryable`  
   **And** 并发冲突返回可识别冲突语义并支持安全重试
5. **Given** 负责人变更请求全链路执行  
   **When** 关键节点发生状态变化  
   **Then** 审计最小事件集必须完整：发起、校验失败、冲突、成功提交  
   **And** 自动入组/自动授权/接管完成能力在 Epic 3 对应故事验收，不在 Story 2.6 内实现

## Tasks / Subtasks

- [x] 任务 1：新增“平台侧负责人变更入口”路由与契约（AC: 1, 4）
  - [x] 在 `platform org` 现有治理链路上新增入口（建议 `POST /platform/orgs/owner-transfer`），保持与 `POST /platform/orgs`、`POST /platform/orgs/status` 一致的鉴权与幂等接入方式。
  - [x] 请求体建议最小字段：`org_id`、`new_owner_phone`（可选 `reason`）；字段校验沿用现有 `org.service` 的严格风格（类型、空白、控制字符、长度）。
  - [x] 响应体必须稳定输出：`request_id`、`org_id`、`old_owner_user_id`、`new_owner_user_id`、`result_status`、`error_code`、`retryable`。
  - [x] OpenAPI 必须补齐该接口的 200/400/401/403/404/409/413/503 示例，确保 `Problem Details` 与 `retryable` 语义可直接驱动前端动作。

- [x] 任务 2：实现受控前置校验与边界控制（AC: 1, 2, 3）
  - [x] 仅交付“发起入口 + 前置校验 + 结果契约”，不在本故事内完成 owner 真正切换、自动入组、自动授权等 Epic 3 责任能力。
  - [x] 前置校验至少覆盖：组织存在性、组织状态、候选新负责人状态、操作者权限、请求字段合法性。
  - [x] 对不满足前置条件场景返回稳定标准错误码（`error_code`）与可恢复提示，并保证 `retryable` 值与错误语义一致。
  - [x] 校验失败时审计必须记录“拒绝事件”，并附最小定位字段（`request_id`、`operator_user_id`、`org_id`、失败原因）。

- [x] 任务 3：并发冲突语义与幂等语义落地（AC: 4, 5）
  - [x] 同一组织并发发起时返回可识别冲突语义（409 + 可机器识别 `error_code`），并明确 `retryable`。
  - [x] 复用现有关键写接口幂等机制（`Idempotency-Key`），保持“同键同载荷可重放、同键异载荷冲突”的既有约束。
  - [x] 并发/冲突路径下同样需要审计，至少覆盖：发起、冲突、成功提交、校验失败四类事件。
  - [x] 结果 `result_status` 需可用于后续 Epic 3 编排衔接（例如 `accepted`/`rejected`/`conflict`）。

- [x] 任务 4：服务与存储层扩展保持 memory/mysql 语义一致（AC: 1, 2, 4）
  - [x] 在 `platform org service` 中新增 owner-transfer 处理函数，保持与现有 `createOrg`/`updateOrgStatus` 一致的错误映射模式。
  - [x] 在 `auth.service` 增加“负责人变更发起/校验”服务能力，并通过显式 service 边界与 `platform` 模块协作。
  - [x] 若存储层需要新增方法（如 org 级串行化校验/冲突判定），必须同时实现 `auth.store.memory` 与 `auth.store.mysql`，避免本地/集成语义漂移。
  - [x] 如果引入新持久化结构（如变更请求记录），迁移脚本必须纳入 `apps/api/migrations` 并接入回归。

- [x] 任务 5：测试与回归门禁（AC: 1-5）
  - [x] API 回归：成功发起、前置校验失败、未授权、组织不存在、冲突重试、幂等重放。
  - [x] 契约回归：响应字段固定性（含 `result_status/error_code/retryable`）与 OpenAPI 示例一致。
  - [x] 安全回归：路由权限声明完整，缺失声明时门禁阻断。
  - [x] 一致性回归：memory/mysql 在校验失败、冲突、成功路径下行为一致。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] `owner-transfer` 的 `ORG-400-INVALID-PAYLOAD` 分支未稳定输出七字段契约，已在服务层统一补齐（`apps/api/src/modules/platform/org.service.js:1089`）。
- [x] [AI-Review][HIGH] `AUTH-404-ORG-NOT-FOUND` 映射到 `ORG-404-ORG-NOT-FOUND` 时缺少七字段契约，已在映射层统一补齐（`apps/api/src/modules/platform/org.service.js:578`）。
- [x] [AI-Review][MEDIUM] 上游异常映射 `503` 时缺少七字段契约导致消费方分支漂移，已在统一包装器补齐并加回归（`apps/api/src/modules/platform/org.service.js:122`，`apps/api/test/platform.org.api.test.js:1584`）。
- [x] [AI-Review][MEDIUM] `owner-transfer` 锁键对 `org_id` 强制小写导致大小写敏感 ID 误冲突，已改为保留原始大小写并补并发回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] same-owner/候选人禁用等校验失败未透传 owner 标识，已在 `auth.service` 错误扩展补齐并在平台映射层继承（`apps/api/src/modules/auth/auth.service.js`，`apps/api/src/modules/platform/org.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] OpenAPI 在 `/platform/orgs` 与 `/platform/orgs/status` 误注入 owner-transfer 七字段示例，已清理避免契约漂移（`apps/api/src/openapi.js`）。
- [x] [AI-Review][CRITICAL] `owner-transfer` 解析仍对 `org_id` 强制小写，导致故事“保留原始大小写”声明与实现不一致；已改为保留原值并更新大小写并发回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][HIGH] `/platform/orgs/owner-transfer` 在 JSON 过大等早期解析失败分支未稳定输出七字段契约；已在 server parse-error 响应层补齐并新增回归（`apps/api/src/server.js`，`apps/api/test/server.test.js`）。
- [x] [AI-Review][MEDIUM] OpenAPI 对 `PlatformOrgOwnerTransferRequest.org_id` 约束弱于实现且 413 示例缺少契约字段；已同步补齐 schema 与示例（`apps/api/src/openapi.js`，`apps/api/test/server.test.js`）。
- [x] [AI-Review][HIGH] `auth.store.mysql` 对 `org_id` 查询使用默认排序规则，可能与 memory 大小写敏感语义漂移；已改为 `BINARY id` 精确匹配并补 SQL 断言回归（`apps/api/src/modules/auth/auth.store.mysql.js`，`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][MEDIUM] OpenAPI 的 owner-transfer 入参约束对 `org_id`/`reason` 仍允许前后空白，弱于服务端校验；已收紧 schema pattern 并补契约断言（`apps/api/src/openapi.js`，`apps/api/test/server.test.js`）。
- [x] [AI-Review][LOW] OpenAPI 的 owner-transfer `400` 响应描述未覆盖 `Idempotency-Key` 非法分支；已修正文案避免契约说明歧义（`apps/api/src/openapi.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 的 `reason` 在 API 层会被静默 `trim` 后放行，导致实现与 OpenAPI “前后空白非法”约束不一致；已改为直接拒绝并补 API 回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] `auth.service.validateOwnerTransferRequest` 对 `reason` 使用宽松 `String(...).trim()`，内部调用可绕过字符串类型与前后空白约束；已改为严格校验并补服务层回归（`apps/api/src/modules/auth/auth.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] 缺少 `owner-transfer.reason` 边界回归（前后空白、非字符串）会导致同类契约漂移难以及时发现；已补 API + service 双层回归（`apps/api/test/platform.org.api.test.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] `auth.service.validateOwnerTransferRequest` 仍未限制 `reason` 控制字符与最大长度，内部调用可绕过 API 层将异常值写入审计元数据；已补 fail-closed 校验并新增服务层回归（`apps/api/src/modules/auth/auth.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] OpenAPI `/platform/orgs` 的 `413` 示例误注入 owner-transfer 专属字段（`old_owner_user_id/new_owner_user_id/result_status`），与运行时响应契约不一致；已清理示例字段（`apps/api/src/openapi.js`）。
- [x] [AI-Review][LOW] 缺少“非 owner-transfer 接口不得出现 owner-transfer 字段”的契约守卫断言，文档漂移无法被快速拦截；已补 OpenAPI 回归断言（`apps/api/test/server.test.js`）。
- [x] [AI-Review][HIGH] `/platform/orgs/owner-transfer` 在授权前置 `401` 分支未输出七字段契约，导致运行时与契约预期漂移；已在路由分发授权失败分支统一补齐 owner-transfer 契约包装（`apps/api/src/server.js`）。
- [x] [AI-Review][HIGH] `/platform/orgs/owner-transfer` 在授权前置 `403` 分支未输出七字段契约，跨 Epic 消费侧无法稳定按契约分支；已与 `401` 同路径修复并统一输出（`apps/api/src/server.js`）。
- [x] [AI-Review][MEDIUM] 缺少 owner-transfer `401/403` 契约回归，导致授权前置路径字段漂移无法被门禁拦截；已补 API 回归测试（`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 的可重试冲突（`ORG-409-OWNER-TRANSFER-CONFLICT`）被幂等层缓存，导致同一 `Idempotency-Key` 重试只会重放冲突结果；已将该路由 `409` 设为非缓存并补回归（`apps/api/src/server.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] `auth.service.validateOwnerTransferRequest` 对 `orgId` 使用宽松 `trim` 归一化，内部调用可绕过“前后空白非法”契约；已改为严格拒绝并补服务层回归（`apps/api/src/modules/auth/auth.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] `auth.service.validateOwnerTransferRequest` 对 `newOwnerPhone` 允许前后空白输入被静默归一化，存在内部调用契约漂移；已改为 strict-equal 校验并补服务层回归（`apps/api/src/modules/auth/auth.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 对上游 `AUTH-400-INVALID-PAYLOAD` 误映射为 `ORG-503-DEPENDENCY-UNAVAILABLE`，导致可修复输入错误被误判为依赖故障；已修正为 `ORG-400-INVALID-PAYLOAD` 并补 API 回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] `owner-transfer` 将所有 `409` 统一设为幂等非缓存，导致 same-owner / 组织禁用等非可重试冲突无法满足“同键同载荷重放”语义；已改为仅 `ORG-409-OWNER-TRANSFER-CONFLICT` 非缓存，并新增 same-owner 幂等重放回归（`apps/api/src/server.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] `owner-transfer` 在 payload 校验失败时会将非法 `org_id`（非字符串/超长/含控制字符）回显到契约字段，存在类型与契约漂移风险；已改为非法值统一回落 `null`（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][LOW] `owner-transfer` 的幂等前置错误（如 `AUTH-400-IDEMPOTENCY-KEY-INVALID`）会透出未校验 `org_id`，可能扩大无效输入回显面；已在 server 侧补齐 `org_id` 约束归一并新增回归（`apps/api/src/server.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] `owner-transfer.org_id` 仅拒绝前后空白，仍允许内部空白字符，导致“严格 ID 校验”与运行时行为不一致；已在 `platform/auth/server` 三层收紧为“任意空白均拒绝”并补 API + service + OpenAPI 回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/src/modules/auth/auth.service.js`，`apps/api/src/server.js`，`apps/api/src/openapi.js`，`apps/api/test/platform.org.api.test.js`，`apps/api/test/auth.service.test.js`，`apps/api/test/server.test.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 未映射上游 `AUTH-409-OWNER-TRANSFER-CONFLICT`，会被误归类为 `503` 依赖故障，破坏“并发冲突可识别 + 可重试”语义；已补齐 `ORG-409-OWNER-TRANSFER-CONFLICT` 映射并新增回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][LOW] 上游并发冲突映射路径的审计 `detail` 被误写为 dependency unavailable，降低排障可读性；已修正为冲突语义文案并补断言（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 锁仅在 `platform.org.service` 进程内生效，跨实例并发会出现双成功；已将锁能力下沉到 `auth.service/auth.store`（memory 共享锁 + mysql `GET_LOCK/RELEASE_LOCK`）并新增跨 service 实例并发回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/src/modules/auth/auth.service.js`，`apps/api/src/modules/auth/auth.store.memory.js`，`apps/api/src/modules/auth/auth.store.mysql.js`，`apps/api/test/platform.org.api.test.js`，`apps/api/test/auth.service.test.js`，`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] `owner-transfer` 获取锁异常发生在主流程 `try/catch` 之外，导致 `AUTH-503-OWNER-TRANSFER-LOCK-UNAVAILABLE` 路径未映射为平台稳定契约；已将锁异常纳入统一映射与审计分支并补回归（`apps/api/src/modules/platform/org.service.js`，`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] 缺少“锁服务返回上游冲突错误（`AUTH-409-OWNER-TRANSFER-CONFLICT`）”的入口层回归，冲突语义可能回退为通用失败；已补冲突契约回归并断言审计事件类型（`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][MEDIUM] 缺少“锁服务抛出非 `AuthProblemError` 异常”场景回归，可能导致稳定契约与审计字段漂移；已补 503 契约 + 审计 `upstream_error_code` 回归（`apps/api/test/platform.org.api.test.js`）。
- [x] [AI-Review][HIGH] `auth.service` 对同一 `org_id` 的锁获取完全信任存储层返回，遇到可重入锁实现会出现同实例并发双成功窗口；已在 service 层增加进程内锁栅栏并补回归（`apps/api/src/modules/auth/auth.service.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] `auth.store.memory` 将 owner-transfer 锁定义为模块级全局 `Map`，导致跨 store 实例状态污染；已改为 store 实例级锁容器并补隔离回归（`apps/api/src/modules/auth/auth.store.memory.js`，`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][LOW] `platform.org.service` 在锁释放仅返回 `false` 时无可观测信号；已补充 release 未确认 warning 日志（`apps/api/src/modules/platform/org.service.js`）。

## Dev Notes

### Developer Context（开发者必须先读）

- 当前 `platform org` 模块已交付两个治理入口：`POST /platform/orgs` 与 `POST /platform/orgs/status`；Story 2.6 应在同一模块内增量扩展，避免平行新栈。
- 现有 `org.service` 已具备成熟的 payload 校验、鉴权上下文处理、错误码映射、审计写入模式；负责人变更入口应复用该风格，不应重写第二套错误语义。
- `auth.store` 已具备组织主档 `owner_user_id` 与成员关系基础数据能力，但 Story 2.6 明确边界是“入口 + 校验 + 契约输出”，完整接管闭环留给 Epic 3。
- 已完成 Story 2.4/2.5 的经验显示：必须同步维护 `route-permissions`、`server` 分发、`openapi`、API 回归，否则容易出现契约漂移与幂等绕过。

### Technical Requirements（实现硬约束）

- 错误输出统一 `application/problem+json`，并保持 `error_code`、`request_id`、`retryable` 可稳定消费。
- 外部 API 字段统一 `snake_case`，不要在同层混用 `camelCase`。
- 新增受保护接口必须声明权限码（建议沿用 `platform.member_admin.operate` 与 `scope=platform`）。
- 负责人变更入口必须接入 `Idempotency-Key` 语义，不允许写接口裸奔。
- AC4 规定的七个输出字段必须完整且稳定，禁止按场景缺失关键字段。
- 并发冲突必须返回可识别语义，且与 `retryable` 标记一致。
- 审计最小事件集必须覆盖：发起、校验失败、冲突、成功提交。
- Story 2.6 不实现 owner 真正切换与自动接管动作，避免提前侵入 Epic 3 的事务闭环责任。

### Architecture Compliance（架构对齐清单）

- 能力落点保持在 `modules/platform/org.*`（接口编排）+ `modules/auth/*`（鉴权与域服务），禁止在 `http-routes.js`/`server.js` 塞业务逻辑。
- 模块间仅通过 service 边界通信，不跨模块直接操作私有 store。
- Problem Details、权限声明门禁、幂等处理、审计写入与现有 org 治理链路保持一致。
- 如需并发串行化，优先采用现有存储事务/锁语义实现，避免引入无法回归的新并发模型。
- 保持 memory/mysql 语义对齐，避免“本地通过、集成失败”。

### Library & Framework Requirements（库与框架要求）

- 仓库当前 API 依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-18 实时核验：
  - Node.js Latest: `v25.6.1`
  - Node.js Latest LTS: `v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
- 本故事策略：不做依赖升级；在当前锁定版本上交付入口、校验、契约与回归。

### File Structure Requirements（建议变更落点）

- 平台组织治理：
  - `apps/api/src/modules/platform/org.constants.js`
  - `apps/api/src/modules/platform/org.routes.js`
  - `apps/api/src/modules/platform/org.service.js`
- 鉴权与领域服务（按需）：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 路由分发与门禁：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
- 契约：
  - `apps/api/src/openapi.js`
- 测试：
  - `apps/api/test/platform.org.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
- 若引入新的变更请求持久化结构，再新增对应 migration。

### Testing Requirements（测试要求）

- AC1（受控流程入口）：
  - 有权限操作者发起成功，返回可识别结果状态与固定字段集。
- AC2（前置校验失败）：
  - 组织不存在、组织禁用、候选负责人状态不满足、参数非法均返回稳定错误码与 `retryable`。
- AC3（故事边界）：
  - 本故事仅验证入口与校验，不应在用例中断言“接管闭环已完成”。
- AC4（契约与冲突）：
  - 响应字段完整性断言（七字段）；并发冲突返回可识别语义；幂等冲突语义稳定。
- AC5（审计最小事件集）：
  - 发起、校验失败、冲突、成功提交四类事件可检索。
- 回归门禁：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence

- Story 2.5 显示高风险写路径必须坚持 fail-closed 与稳定错误语义，避免依赖异常时 silent fail-open。
- 路由参数规范化、幂等作用域构建、OpenAPI/实现/测试三方一致是近期反复踩坑点，Story 2.6 必须从一开始同步落实。
- memory/mysql 双实现语义漂移会直接导致回归不稳定，本故事新增路径要同步补齐双存储测试。
- 权限与治理链路变更后，应优先选择“最小侵入增量”而非重构鉴权主链路。

### Git Intelligence Summary

- 最近提交热点集中在 `platform/*`、`auth/*`、`route-permissions`、`server`、`openapi`、`test/*`。
- 可执行结论：沿用“模块内增量 + 契约同步 + 回归先行”的模式，风险最低、交付最快。

### Latest Tech Information（2026-02-18）

- Node 官方索引显示：Latest `v25.6.1`，Latest LTS `v24.13.1`。
- npm registry 最新：`@nestjs/core 11.1.14`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`。
- 当前仓库 API 依赖仍可满足 Story 2.6，无需为本故事引入版本升级风险。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、前序故事 `2-5-平台权限树配置与角色分配生效.md`、最近 5 次提交历史。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed; owner-transfer error contract stabilized across 400/401/403/404/503 and verified by regression tests.`

### Project Structure Notes

- 现有 `platform org` 治理入口风格成熟（鉴权、幂等、审计、Problem Details），Story 2.6 应完全复用该骨架。
- 建议新增接口继续沿用 `org.service` 的“严格 payload 校验 + 标准错误映射 + 审计事件”模式。
- Story 2.6 输出契约应为 Epic 3 预留稳定衔接点，避免在本故事提前落地跨 Epic 复杂事务。

### References

- Story 2.6 用户故事与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.6: 平台侧负责人变更入口]
- Journey 4（负责人变更高风险链路）  
  [Source: _bmad-output/planning-artifacts/prd.md#Journey 4: 平台管理员高风险操作旅程（负责人变更）]
- FR12/FR54/FR71/FR76（需求与并发冲突约束）  
  [Source: _bmad-output/planning-artifacts/prd.md#平台治理能力（Platform Governance）]  
  [Source: _bmad-output/planning-artifacts/prd.md#安全一致性与发布门禁]
- 负责人变更详细规则（串行化、事务一致、状态前置约束）  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Organization Creation & Owner Transfer Rules (Detailed)]
- 错误格式、幂等、事件命名、架构边界  
  [Source: _bmad-output/planning-artifacts/architecture.md#Format Patterns]  
  [Source: _bmad-output/planning-artifacts/architecture.md#Process Patterns]  
  [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries]
- 负责人变更 UX 流程（冲突可恢复）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#平台管理员-负责人变更（冲突可恢复）]
- 前序故事经验（2.5）  
  [Source: _bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md]
- 当前实现基线  
  [Source: apps/api/src/modules/platform/org.service.js]  
  [Source: apps/api/src/modules/platform/org.routes.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/modules/auth/auth.store.mysql.js]  
  [Source: apps/api/src/modules/auth/auth.store.memory.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/server.js]  
  [Source: apps/api/src/openapi.js]
- 版本核验来源  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-6-平台侧负责人变更入口`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- loaded artifacts: `epics.md` + `prd.md` + `prd-appendix-legacy-inputs.md` + `architecture.md` + `ux-design-specification.md`
- previous story analyzed: `_bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md`
- recent git commits analyzed: `048e6ae`, `88f32ec`, `fbea8a5`, `c1927c8`, `819a4b1`
- live version checks: `nodejs.org/dist/index.json` + `pnpm view`
- implementation verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/route-permissions.test.js test/server.test.js test/auth.service.test.js test/auth.store.mysql.test.js`（通过，368/368）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`（通过，58/58）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js test/server.test.js`（通过，262/262）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`（通过，122/122）
- review fixes verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/server.test.js`（通过，125/125）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`（通过，62/62）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js`（通过，208/208）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`（通过，125/125）
- gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- gate checks: `pnpm --dir apps/api lint`（通过，51 files checked）
- gate checks: `pnpm --dir apps/api test`（通过，575/575）
- gate checks: `pnpm --dir apps/api test`（通过，578/578）
- gate checks: `pnpm --dir apps/api test`（通过，580/580）
- review fixes verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/server.test.js`（通过，207/207）
- gate checks: `pnpm --dir apps/api test`（通过，582/582）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`（通过，66/66）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/route-permissions.test.js test/server.test.js test/auth.service.test.js test/auth.store.mysql.test.js`（通过，381/381）
- gate checks: `pnpm --dir apps/api test`（通过，583/583）
- review fixes verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.org.api.test.js`（通过，216/216）
- gate checks: `pnpm --dir apps/api test`（通过，586/586）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`（通过，129/129）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/route-permissions.test.js`（通过，386/386）
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js test/server.test.js`（通过，282/282）
- gate checks: `pnpm --dir apps/api test`（通过，592/592）
- lock fix verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js`（通过，294/294）
- gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- gate checks: `pnpm --dir apps/api lint`（通过，51 files checked）
- gate checks: `pnpm --dir apps/api test`（通过，599/599）
- cross-instance pressure recheck: `node` 双实例并发脚本（3000/3001）`pair_race: bothAccepted=0, acceptedAndConflict=40`；`mixed_load: 600@120 -> 409=311, 200=289`
- review fixes verification: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`（通过，76/76）
- gate checks: `pnpm --dir apps/api test`（通过，602/602）
- review fixes verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.org.api.test.js`（通过，231/231）
- gate checks: `pnpm --dir apps/api test`（通过，604/604）

### Completion Notes List

- ✅ 新增平台侧负责人变更入口：`POST /platform/orgs/owner-transfer`，接入既有鉴权、权限声明与幂等处理链路。
- ✅ 完成请求字段严格校验与稳定响应契约，输出固定字段：`request_id`、`org_id`、`old_owner_user_id`、`new_owner_user_id`、`result_status`、`error_code`、`retryable`。
- ✅ 在 `platform org service` 实现前置校验、错误码映射、同组织并发冲突控制与审计最小事件集（发起/拒绝/冲突/提交）。
- ✅ 在 `auth.service` 增加负责人变更校验能力，并补齐 `auth.store.memory` / `auth.store.mysql` 组织查询能力以保持双实现一致。
- ✅ 补齐 OpenAPI 契约（200/400/401/403/404/409/413/503）与错误示例，保持与实际实现和测试一致。
- ✅ 新增并扩展 API/服务/门禁/契约回归用例，覆盖成功、前置失败、冲突、幂等重放与同键异载荷冲突场景。
- ✅ 代码评审修复：统一补齐 owner-transfer 失败路径的七字段契约输出（400/404/503），避免消费方分支漂移。
- ✅ 代码评审修复：消除 owner-transfer 锁键大小写误冲突、补齐校验失败 owner 标识透传、清理非 owner-transfer 接口的错误示例漂移。
- ✅ 代码评审修复（三次）：保留 `org_id` 原始大小写、补齐 owner-transfer 早期 413 解析失败契约字段、同步 OpenAPI `org_id` 约束与 413 示例。
- ✅ 代码评审修复（四次）：`auth.store.mysql` 的组织查询/更新改为 `BINARY id`，消除 memory/mysql 大小写语义漂移并补 MySQL SQL 断言回归。
- ✅ 代码评审修复（四次）：owner-transfer OpenAPI 入参 pattern 与服务端前后空白约束对齐，且 `400` 响应描述覆盖 `Idempotency-Key` 非法分支。
- ✅ 代码评审修复（五次）：收紧 owner-transfer `reason` 约束（拒绝前后空白/非字符串），并补齐 API + service 边界回归。
- ✅ 代码评审修复（六次）：补齐 service 层 `reason` 控制字符与长度上限校验，清理 `/platform/orgs` `413` 示例误注入字段并新增契约守卫断言回归。
- ✅ 代码评审修复（七次）：补齐 owner-transfer 在授权前置 `401/403` 路径的七字段契约输出，并新增对应 API 回归。
- ✅ 代码评审修复（八次）：将 owner-transfer 的可重试冲突 `409` 设为幂等非缓存响应，避免同键重试永久重放冲突并补并发+幂等回归。
- ✅ 代码评审修复（九次）：收紧 `auth.service.validateOwnerTransferRequest` 对 `orgId/newOwnerPhone` 的内部输入边界（拒绝前后空白），并将上游 `AUTH-400-INVALID-PAYLOAD` 映射修正为 `ORG-400-INVALID-PAYLOAD`。
- ✅ 代码评审修复（十次）：按错误码细化 owner-transfer `409` 幂等缓存策略（仅可重试冲突非缓存），并收敛非法 `org_id` 在校验失败/幂等前置失败下的契约回显（统一回落 `null`）。
- ✅ 代码评审修复（十一次）：收紧 `owner-transfer.org_id` 任意空白校验（platform/auth/server 一致），补齐上游 `AUTH-409-OWNER-TRANSFER-CONFLICT` 映射与冲突审计语义，并通过定向 + 全量回归。
- ✅ 代码评审修复（十二次）：将 owner-transfer 冲突锁下沉到 `auth.service/auth.store`，mysql 使用 `GET_LOCK/RELEASE_LOCK` 实现跨实例串行化，`platform.org.service` 复用统一锁能力并补跨实例并发回归。
- ✅ 代码评审修复（十三次）：补齐 owner-transfer 锁获取异常的统一错误映射（冲突/依赖故障）与审计分支，新增三条锁异常路径回归并通过全量门禁。
- ✅ 代码评审修复（十四次）：补齐同实例锁重入防护（service 进程内锁栅栏）、修复 memory 锁全局污染，并增强 lock release 未确认可观测性，完成定向 + 全量回归。
- ✅ 通过故事门禁：`check:route-permissions`、`lint`、`apps/api` 全量测试。

### File List

- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/platform/org.constants.js`
- `apps/api/src/modules/platform/org.routes.js`
- `apps/api/src/modules/platform/org.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/platform.org.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `_bmad-output/implementation-artifacts/2-6-平台侧负责人变更入口.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-18：完成 Story 2.6（平台侧负责人变更入口、前置校验、并发冲突与幂等语义、OpenAPI 契约与回归测试），状态更新为 `review`。
- 2026-02-18：完成 CR 修复（owner-transfer 失败路径七字段契约统一补齐 + 回归），状态更新为 `done`。
- 2026-02-18：完成 CR 二次修复（锁键大小写误冲突、owner 标识透传、OpenAPI 示例清理）并通过定向回归。
- 2026-02-18：完成 CR 三次修复（保留 `org_id` 原始大小写、补齐 owner-transfer 413 早期失败契约、同步 OpenAPI schema 约束）并通过全量回归。
- 2026-02-18：完成 CR 四次修复（MySQL `org_id` 比较改为 `BINARY` 以对齐 memory 语义；owner-transfer OpenAPI `org_id/reason` 约束与 `400` 描述补齐）并通过定向回归。
- 2026-02-18：完成 CR 五次修复（owner-transfer `reason` 前后空白与非字符串输入 fail-closed，补齐 API+service 回归）并通过全量回归。
- 2026-02-18：完成 CR 六次修复（service 层 `reason` 控制字符/长度 fail-closed；清理 `/platform/orgs` `413` 示例误注入字段；新增契约守卫断言）并通过定向回归。
- 2026-02-18：完成 CR 七次修复（补齐 owner-transfer 授权前置 `401/403` 七字段契约；新增对应 API 回归）并通过全量回归。
- 2026-02-18：完成 CR 八次修复（owner-transfer 可重试冲突 `409` 改为幂等非缓存，避免同键重试冲突重放）并通过全量回归。
- 2026-02-18：完成 CR 九次修复（收紧 `validateOwnerTransferRequest` 的 `orgId/newOwnerPhone` 输入边界并修正 `AUTH-400`→`ORG-400` 映射）并通过全量回归。
- 2026-02-18：完成 CR 十次修复（owner-transfer `409` 按错误码细化幂等缓存；非法 `org_id` 在校验失败与幂等前置失败场景统一回落 `null`）并通过全量回归。
- 2026-02-18：完成 CR 十一次修复（收紧 `owner-transfer.org_id` 内部空白校验、补齐 `AUTH-409-OWNER-TRANSFER-CONFLICT` 映射与冲突审计语义）并通过定向回归与 `apps/api` 全量测试。
- 2026-02-18：完成 CR 十二次修复（owner-transfer 锁下沉至 `auth.service/auth.store`，mysql `GET_LOCK/RELEASE_LOCK` 跨实例串行化，新增跨实例并发回归与真实双实例压测复核）并通过全量门禁。
- 2026-02-18：完成 CR 十三次修复（owner-transfer 锁获取异常统一映射到稳定契约并补齐冲突/异常回归），通过 `platform.org` 定向回归与 `apps/api` 全量测试。
- 2026-02-18：完成 CR 十四次修复（同实例锁重入防护 + memory 锁作用域收敛 + release 未确认日志补齐），通过 `auth.service + platform.org` 定向回归与 `apps/api` 全量测试。

### Senior Developer Review (AI)

- Outcome: Approve
- Findings: `HIGH=0`, `MEDIUM=0`, `LOW=0`（本轮新增 3 项问题均已修复）
- AC 覆盖结论：AC1-AC5 满足；owner-transfer 成功/失败路径均输出稳定契约字段并保持冲突重试语义。
- Evidence: `apps/api/src/modules/platform/org.service.js`, `apps/api/src/modules/auth/auth.service.js`, `apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/src/server.js`, `apps/api/src/openapi.js`, `apps/api/test/platform.org.api.test.js`, `apps/api/test/auth.service.test.js`, `apps/api/test/auth.store.mysql.test.js`, `apps/api/test/server.test.js`
