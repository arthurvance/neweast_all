# Story 4.4: 受保护角色约束与角色状态失效

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台治理操作者,  
I want 对受保护系统角色实施不可编辑/删除约束，并在角色禁用后权限立即失效,  
so that 核心权限模型安全稳定。

## Acceptance Criteria

1. **Given** 操作者尝试编辑或删除受保护系统角色  
   **When** 请求执行  
   **Then** 系统拒绝操作  
   **And** 返回标准错误码与原因
2. **Given** 某角色状态变更为禁用  
   **When** 变更提交成功  
   **Then** 该角色不再参与权限计算并立即生效  
   **And** 历史绑定关系保留用于审计

## Tasks / Subtasks

- [x] 任务 1：固化受保护角色“不可改定义”边界（AC: 1）
  - [x] 平台角色路径保持受保护约束：`sys_admin` 禁止编辑/删除（`PATCH/DELETE /platform/roles/:role_id`）。
  - [x] 组织角色路径保持受保护约束：`tenant_owner`、`tenant_admin`、`tenant_member` 禁止创建/编辑/删除（`POST/PATCH/DELETE /tenant/roles*`）。
  - [x] 受保护角色清单仅在常量层维护（`platform/role.constants.js`、`tenant/role.constants.js`），禁止业务层散落硬编码。
  - [x] 保持“可分配但不可改定义”边界：受保护角色可通过既有分配链路使用，但不得通过角色目录接口改定义。

- [x] 任务 2：平台域角色禁用后权限即时失效（AC: 2）
  - [x] 在角色状态变更为 `disabled`（含删除语义）时，同步处理受影响平台用户权限快照，不允许等待下一次异步流程才生效。
  - [x] 对平台权限判定链路增加 fail-closed 校验：即使历史 role facts 仍在，也不能因目录角色已禁用而继续授权。
  - [x] 对受影响会话执行一致性收敛：至少保证下一次受保护请求立即按禁用后权限判定。
  - [x] 保留 `auth_user_platform_roles` 绑定关系用于审计取证，不做物理删除。

- [x] 任务 3：组织域角色禁用后权限即时失效（AC: 2）
  - [x] 在租户角色状态变更为 `disabled` 时，同步处理受影响成员权限快照（`auth_user_tenants` 的权限字段与角色绑定有效性）。
  - [x] 组织域权限判定链路对禁用角色严格 fail-closed，避免旧快照继续放行。
  - [x] 保持 `auth_tenant_membership_roles` 历史绑定可追溯，不清理历史关系。
  - [x] 确保角色禁用后的 tenant 域拒绝语义稳定（统一 Problem Details + 标准错误码）。

- [x] 任务 4：审计与追踪闭环（AC: 1, 2）
  - [x] 角色保护拒绝与角色禁用生效链路都记录审计事件，包含 `request_id`、`traceparent`、操作者、目标角色、结果与原因。
  - [x] 对“角色状态变更”记录 before/after（至少 `status`、`scope`、`tenant_id`、`affected_user_count/affected_membership_count`）。
  - [x] 审计语义与 4.1/4.2/4.3 对齐，不新增第二套事件结构。

- [x] 任务 5：契约与门禁一致性（AC: 1, 2）
  - [x] OpenAPI 对齐：补齐受保护角色拒绝与禁用后拒绝访问示例，保持 `application/problem+json` 一致。
  - [x] 检查 `route-permissions` 声明覆盖完整，确保新增/改动受保护路由无漏声明。
  - [x] 保持幂等与路径规范化策略不回退（沿用 Story 2.4 已固化规则）。

- [x] 任务 6：测试与回归门禁（AC: 1, 2）
  - [x] API 回归：平台/组织受保护角色编辑删除被拒绝（403 + 标准错误码）。
  - [x] API 回归：用户已绑定角色后，将该角色禁用，应在下一次受保护请求中立即拒绝。
  - [x] Store/Service 回归：角色禁用触发权限快照重算（平台与租户），并保持历史绑定可追溯。
  - [x] 兼容回归：内存与 MySQL store 在“禁用后权限判定”语义一致。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][Medium] 平台域状态同步结果中 `affected_membership_count` 误用用户计数，导致审计与响应语义不准确（应为 `0`）。[`apps/api/src/modules/auth/auth.service.js:5441`]
- [x] [AI-Review][Medium] `PATCH role.status` 在状态未变化时仍触发 resync，产生不必要的快照重算与审计噪音。[`apps/api/src/modules/auth/auth.service.js:5379`]
- [x] [AI-Review][Low] 状态同步内部入口缺少 scope 合法性兜底校验，存在防御性不足。[`apps/api/src/modules/auth/auth.service.js:6439`]
- [x] [AI-Review][Medium] 当更新前状态查询失败时，`status=disabled` 可能被误判为“状态未变化”并跳过 resync，存在禁用后权限未即时失效风险。[`apps/api/src/modules/auth/auth.service.js:5379`]
- [x] [AI-Review][Medium] 平台角色删除的 fallback 审计 `beforeState` 错误引用删除后对象，可能把删除前 `active` 误记为 `disabled`。[`apps/api/src/modules/auth/auth.service.js:5568`]
- [x] [AI-Review][Medium] `createPlatformRoleCatalogEntry` 将未规范化的 `operatorUserId/operatorSessionId` 直接传入 store 写路径，可能导致审计主体与落库主体不一致（空白污染）。[`apps/api/src/modules/auth/auth.service.js:5181`]
- [x] [AI-Review][Medium] `updatePlatformRoleCatalogEntry` 将未规范化的操作者标识传入 store，可能写入带前后空白的 `updated_by_*` 字段，破坏追踪一致性。[`apps/api/src/modules/auth/auth.service.js:5332`]
- [x] [AI-Review][Medium] `deletePlatformRoleCatalogEntry` 将未规范化的操作者标识传入 store，删除审计与状态同步链路可能出现主体字段不一致。[`apps/api/src/modules/auth/auth.service.js:5513`]
- [x] [AI-Review][Medium] OpenAPI `POST /tenant/roles` 的 403 缺少受保护角色拒绝示例（`TROLE-403-SYSTEM-ROLE-PROTECTED`），与实现语义不对齐。[`apps/api/src/openapi.js:2630`]
- [x] [AI-Review][Medium] OpenAPI `PATCH/DELETE /tenant/roles/{role_id}` 缺少受保护角色 403 与删除前置条件 409（`TROLE-409-DELETE-CONDITION-NOT-MET`）示例，削弱契约可读性与前端错误映射稳定性。[`apps/api/src/openapi.js:2726`]
- [x] [AI-Review][Medium] OpenAPI `DELETE /platform/roles/{role_id}` 缺少受保护角色 403 示例，导致平台 PATCH/DELETE 错误契约示例不一致。[`apps/api/src/openapi.js:4090`]
- [x] [AI-Review][Medium] 平台角色服务缺少目录记录结构校验，`mapRoleCatalogEntry` 的兜底会掩盖上游脏数据，导致 list/create/update/delete 未严格 fail-closed。[`apps/api/src/modules/platform/role.service.js:425`]
- [x] [AI-Review][Medium] 平台角色权限授予 `GET/PUT` 路径缺少下游结果结构与目标一致性校验，脏载荷可能被当作成功返回，未严格 fail-closed。[`apps/api/src/modules/platform/role.service.js:770`]
- [x] [AI-Review][Medium] `GET /platform/roles` 在目录依赖返回非数组载荷时被静默映射为空列表，未严格 fail-closed。[`apps/api/src/modules/platform/role.service.js:670`]
- [x] [AI-Review][Medium] `GET /platform/roles/{role_id}/permissions` 未校验下游权限是否属于平台权限目录，未知权限码可能被透传。[`apps/api/src/modules/platform/role.service.js:825`]
- [x] [AI-Review][Medium] `PUT /platform/roles/{role_id}/permissions` 读取权限目录依赖异常时未统一映射 `ROLE-503-DEPENDENCY-UNAVAILABLE`，错误语义不稳定。[`apps/api/src/modules/platform/role.service.js:1009`]
- [x] [AI-Review][Medium] `GET /tenant/roles/{role_id}/permissions` 缺少租户权限目录基线校验，未知权限码可能被透传。[`apps/api/src/modules/tenant/role.service.js:1568`]
- [x] [AI-Review][Medium] `PUT /tenant/roles/{role_id}/permissions` 读取租户权限目录依赖异常时未统一映射 `TROLE-503-DEPENDENCY-UNAVAILABLE`，错误语义不稳定。[`apps/api/src/modules/tenant/role.service.js:1730`]
- [x] [AI-Review][High] Dev Agent Record `File List` 误记 `_bmad-output/implementation-artifacts/sprint-status.yaml` 为本次改动文件，但 Git 无对应变更，审查追踪存在假阳性。[`_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`]
- [x] [AI-Review][Medium] Dev Agent Record `File List` 漏记 `apps/api/src/modules/tenant/role.service.js`，与 Git 实际改动不一致，影响变更可追溯性。[`_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`]
- [x] [AI-Review][Medium] Dev Agent Record `Debug Log References` 漏记 `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`，验证证据链不完整。[`_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 2.4 已交付“受保护角色不可编辑/删除”的基础能力（平台与组织角色目录），Story 4.4 的重点是把“角色禁用立即失效”做成端到端一致行为。
- Story 4.1/4.2/4.3 已形成“审计 + trace + Problem Details + 路由声明门禁”的统一实现模式，本故事必须复用该模式，不另起协议。
- 当前代码中，平台与组织权限均存在“目录状态、角色事实、权限快照”三层数据，4.4 需要确保三层在“角色禁用”后不产生可授权漂移。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR47`、`FR75`。
- 强相关：`FR49`（并集权限模型）、`FR50`（状态变更即时重算）、`FR72`（受保护接口声明）、`FR80`（统一错误语义）。
- 关键 NFR：`NFR6`（域边界强隔离）、`NFR7`（受保护接口默认拒绝）、`NFR22`（验证证据可归档）。

### Architecture Compliance（架构对齐清单）

- 鉴权入口统一走 `route-permissions` + `authorizeRoute`，禁止在路由处理器里写私有绕过逻辑。
- 角色禁用后的权限失效必须 fail-closed；不能依赖“下次人工刷新”或“后续批处理”才生效。
- 错误结构统一 Problem Details（`error_code`、`request_id`、`retryable` 等字段语义保持稳定）。
- 审计事件必须可按域检索，且可通过 `request_id`/`traceparent` 与日志链路关联。

### Library & Framework Requirements（库与框架要求）

- 当前工程基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新稳定核验（2026-02-21）：
  - Node.js LTS: `v24.13.1`（Krypton，2026-02-09）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
- 本故事目标是修正权限时效性与安全边界，不以依赖升级为前置条件。

### File Structure Requirements（建议变更落点）

- 角色目录与受保护约束：
  - `apps/api/src/modules/platform/role.constants.js`
  - `apps/api/src/modules/platform/role.service.js`
  - `apps/api/src/modules/tenant/role.constants.js`
  - `apps/api/src/modules/tenant/role.service.js`
- 权限快照与失效收敛核心：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约与门禁：
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
- 测试：
  - `apps/api/test/platform.role.api.test.js`
  - `apps/api/test/tenant.role.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/auth.express.api.test.js`
  - `apps/api/test/route-permissions.test.js`

### Testing Requirements（必须覆盖）

- AC1（受保护角色不可改定义）
  - 平台与组织角色的 protected 目标在编辑/删除（及组织侧创建）均被拒绝。
  - 错误码稳定：`ROLE-403-SYSTEM-ROLE-PROTECTED` / `TROLE-403-SYSTEM-ROLE-PROTECTED`。
- AC2（禁用即时失效）
  - 已绑定角色的用户在角色禁用后，下一次访问受保护接口立即被拒绝。
  - 平台域与组织域分别覆盖“目录状态变更 -> 权限判定变化 -> 审计记录”闭环。
  - 历史绑定关系仍可查询用于审计，不发生物理删除导致证据缺失。
- 回归门禁
  - 通过 `check:route-permissions`、`lint`、`test`，并补充针对性并发/一致性断言（防止竞态恢复旧权限）。

### Previous Story Intelligence（来自 4.3 / 2.4）

- 先保证 fail-closed，再补齐回归：当依赖不可用或数据异常时优先拒绝放行，而不是“尽力放行”。
- 路由声明、OpenAPI、实现和测试必须同批更新，否则极易出现契约漂移。
- in-memory 与 MySQL store 必须语义一致，尤其是 `status`、`scope`、`tenant_id` 的判定规则。
- 受保护角色约束已在 2.4 形成稳定模式，4.4 重点不是重写接口，而是补齐“禁用后即时失效”的一致性链路。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交：
  - `b13e910`（Story 4.3）
  - `f77e412`（Story 4.2）
  - `2e5f0a1`（Story 4.1）
  - `785fa46`（Story 3.7）
  - `86ac800`（Story 3.6）
- 高频改动热点：
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/modules/platform/*`
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/test/*`
- 可执行建议：沿用“store 原子改动 + service fail-closed 包装 + 契约同步 + 全量回归”节奏，避免只改单层造成权限漂移。

### Latest Tech Information（外部核验）

- Node.js LTS：`v24.13.1`（Krypton，2026-02-09）。
- npm registry 最新：
  - `@nestjs/core` `11.1.14`
  - `typeorm` `0.3.28`
  - `mysql2` `3.17.4`
  - `ioredis` `5.9.3`
- 本故事不做版本升级，聚焦权限正确性与即时失效语义。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文依据：
  - `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.4）
  - `_bmad-output/planning-artifacts/prd.md`（FR47、FR75）
  - `_bmad-output/planning-artifacts/architecture.md`（权限门禁、Problem Details、审计追踪）
  - `_bmad-output/planning-artifacts/ux-design-specification.md`（一致反馈与治理操作模式）
  - `_bmad-output/implementation-artifacts/2-4-平台角色管理与受保护角色约束.md`
  - `_bmad-output/implementation-artifacts/4-3-受控系统配置治理.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed with adversarial findings fixed; AC1/AC2 validated against implementation and regression tests.`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.4）
- `_bmad-output/planning-artifacts/prd.md`（FR47、FR75、FR49、FR50）
- `_bmad-output/planning-artifacts/architecture.md`（权限声明门禁、错误模型、审计追踪）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（反馈一致性与操作容器规范）
- `_bmad-output/implementation-artifacts/2-4-平台角色管理与受保护角色约束.md`
- `_bmad-output/implementation-artifacts/4-3-受控系统配置治理.md`
- `apps/api/src/modules/platform/role.constants.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/tenant/role.constants.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.role.api.test.js test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 新增平台/租户角色禁用后的权限收敛实现：角色状态变更与删除后会同步重算受影响快照，并立即使旧会话在下一次受保护请求时失效。
- 平台权限判定补齐目录状态 fail-closed 约束：历史 role facts 仍存在时，若目录角色已禁用则不再授予权限。
- 新增并通过平台与租户 API 回归用例：已绑定用户在角色禁用后立即从 200 收敛为 401。
- 为状态同步链路补充持久审计事件（`auth.role.catalog.status_synced`）及 `affected_user_count/affected_membership_count` 元数据。
- 修复并更新 `auth.service` 相关单测桩以覆盖新增状态同步与审计行为；`check:route-permissions`、`lint`、`test` 全部通过（`992 passed`）。
- Code Review 修复：平台域 `affected_membership_count` 归零语义修正、状态不变跳过 resync、防御性 scope 校验补齐；增量回归 `367 passed`。
- Code Review 加固：前置状态查询失败时强制执行状态 resync（fail-closed），避免 `status=disabled` 漏失效；增量回归 `368 passed`。
- Code Review-3 修复：平台角色删除 fallback 审计改为优先使用删除前快照构造 `beforeState`，避免 `before/after` 状态同值污染；新增回归并通过（增量 `369 passed`，全量 `993 passed`）。
- Code Review-4 修复：角色目录 create/update/delete 三条写路径统一向 store 传递规范化 `operatorUserId/operatorSessionId`，避免主体字段空白污染；新增 3 条回归并通过（增量 `288 passed`，全量 `996 passed`）。
- Code Review-5 修复：补齐租户/平台角色 OpenAPI 受保护角色与删除前置条件错误示例，并新增契约断言；`server.test` 增量通过（`72 passed`），全量门禁复核 `996 passed`。
- Code Review-6 修复：平台角色 list/create/update/delete 统一增加目录记录结构校验与目标一致性校验，脏数据按 `ROLE-503-DEPENDENCY-UNAVAILABLE` fail-closed；新增 4 条平台 API 回归并通过（增量 `34 passed`，全量 `1000 passed`）。
- Code Review-7 修复：平台角色权限授予 `GET/PUT` 路径补齐返回载荷结构校验与目标一致性校验（`role_id`、`permission_codes`、`available_permission_codes`、`affected_user_count`），脏数据统一 `ROLE-503-DEPENDENCY-UNAVAILABLE` fail-closed；新增 3 条平台 API 回归并通过（增量 `37 passed`，全量 `962 passed`）。
- Code Review-8 修复：平台角色目录 `list` 非数组载荷改为显式 `503 fail-closed`；权限读取路径新增“目录权限基线校验”；权限写入路径补齐目录依赖异常的统一 `503` 映射；新增 3 条平台 API 回归并通过（增量 `40 passed`，全量 `1006 passed`）。
- Code Review-9 修复：租户角色权限读取路径补齐“租户权限目录基线”校验并统一目录依赖异常映射；权限写入路径补齐目录依赖异常的统一 `503` 映射；新增 3 条租户 API 回归并通过（增量 `57 passed`，全量 `1009 passed`）。
- Code Review-10 修复：对齐 story 追踪记录与 Git 真实变更（移除误记 `sprint-status.yaml`、补记 `apps/api/src/modules/tenant/role.service.js`、补齐租户回归单跑命令）。

### File List

- `_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/platform.role.api.test.js`
- `apps/api/test/tenant.role.api.test.js`
- `apps/api/src/openapi.js`
- `apps/api/test/server.test.js`

## Senior Developer Review (AI)

### Review Summary

- Outcome: **Approved (with fixes applied in this review pass)**
- AC Validation:
  - AC1（受保护角色不可改定义）已由既有 API 回归覆盖并保持稳定。
  - AC2（禁用后即时失效）已通过平台/租户 API + service 回归验证。

### Findings and Fixes

1. **[MEDIUM] 平台域 `affected_membership_count` 语义错误**  
   - 现象：平台域响应/审计将 membership 计数错误映射为 user 计数。  
   - 修复：状态同步链路拆分 `affectedUserCount`/`affectedMembershipCount`，平台域固定 membership=0。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5441`, `apps/api/src/modules/auth/auth.service.js:5590`, `apps/api/src/modules/auth/auth.service.js:6497`

2. **[MEDIUM] 状态未变化仍触发 resync**  
   - 现象：`status` 字段存在即执行 resync，即便前后状态一致。  
   - 修复：增加前后状态比较，未变化直接跳过 resync。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5373`, `apps/api/src/modules/auth/auth.service.js:5379`

3. **[LOW] resync 入口缺少 scope 防御性校验**  
   - 现象：内部函数未显式拦截非法 scope。  
   - 修复：补齐 `VALID_PLATFORM_ROLE_CATALOG_SCOPE` 断言。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:6439`

4. **[MEDIUM] 前置状态查询失败时可能跳过禁用 resync**  
   - 现象：更新前查询异常被吞掉后，`status=disabled` 可能被误判为前后状态一致，导致不触发 resync。  
   - 修复：引入“前置状态是否可判定”判断；若前值未知则强制执行 resync，保持 fail-closed。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5373`, `apps/api/src/modules/auth/auth.service.js:5379`, `apps/api/test/auth.service.test.js:10296`

5. **[MEDIUM] 平台角色删除 fallback 审计 `beforeState` 取值错误**  
   - 现象：`deletePlatformRoleCatalogEntry` 在 fallback 审计分支中使用删除后对象构造 `beforeState`，可导致删除前状态被误记为 `disabled`。  
   - 修复：`beforeState` 改为优先取删除前查询快照（`previousRole`），仅在缺失时回退到删除结果对象。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5568`, `apps/api/src/modules/auth/auth.service.js:5584`, `apps/api/test/auth.service.test.js:10594`

6. **[MEDIUM] create 路径未规范化操作者标识直接下传 store**  
   - 现象：`createPlatformRoleCatalogEntry` 下游写入使用原始 `operatorUserId/operatorSessionId`，与已规范化审计上下文可能不一致。  
   - 修复：store 写路径改为统一使用 `normalizedOperatorUserId/normalizedOperatorSessionId`。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5181`, `apps/api/test/auth.service.test.js:10105`

7. **[MEDIUM] update 路径未规范化操作者标识直接下传 store**  
   - 现象：`updatePlatformRoleCatalogEntry` 可能把前后空白主体值写入 `updated_by_*`。  
   - 修复：store 写路径统一传递规范化主体标识。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5332`, `apps/api/test/auth.service.test.js:10281`

8. **[MEDIUM] delete 路径未规范化操作者标识直接下传 store**  
   - 现象：`deletePlatformRoleCatalogEntry` 删除链路与审计链路存在主体字段不一致风险。  
   - 修复：store 写路径统一传递规范化主体标识。  
   - 证据：`apps/api/src/modules/auth/auth.service.js:5513`, `apps/api/test/auth.service.test.js:10611`

9. **[MEDIUM] OpenAPI 缺失租户角色创建受保护拒绝示例**  
   - 现象：`POST /tenant/roles` 的 403 未给出 `TROLE-403-SYSTEM-ROLE-PROTECTED` 示例，契约不完整。  
   - 修复：补齐 403 example，并在 `server.test.js` 增加断言。  
   - 证据：`apps/api/src/openapi.js:2630`, `apps/api/test/server.test.js:1386`

10. **[MEDIUM] OpenAPI 缺失租户角色修改/删除关键错误示例**  
    - 现象：`PATCH/DELETE /tenant/roles/{role_id}` 未覆盖受保护角色 403 与删除前置条件 409 示例。  
    - 修复：补齐 `TROLE-403-SYSTEM-ROLE-PROTECTED` 与 `TROLE-409-DELETE-CONDITION-NOT-MET` 示例并补断言。  
    - 证据：`apps/api/src/openapi.js:2726`, `apps/api/src/openapi.js:2862`, `apps/api/test/server.test.js:1391`

11. **[MEDIUM] OpenAPI 平台角色 PATCH/DELETE 示例不一致**  
    - 现象：`PATCH /platform/roles/{role_id}` 有受保护角色 403 示例，`DELETE /platform/roles/{role_id}` 缺失。  
    - 修复：补齐 DELETE 403 示例并新增断言。  
    - 证据：`apps/api/src/openapi.js:4090`, `apps/api/test/server.test.js:1406`

12. **[MEDIUM] 平台角色目录返回缺少结构级 fail-closed 校验**  
    - 现象：`platform.role.service` 在 list/create/update/delete 中直接使用 `mapRoleCatalogEntry` 返回结果；当上游返回缺字段/脏字段时会被默认值掩盖，可能“成功返回”。  
    - 修复：新增 `isValidRoleCatalogEntry` 与 `isExpectedMutationTarget`，在 list/create/update/delete 全链路执行结构与目标一致性校验；异常统一映射 `ROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/platform/role.service.js:436`, `apps/api/src/modules/platform/role.service.js:620`, `apps/api/test/platform.role.api.test.js:537`

13. **[MEDIUM] 平台角色权限授予读写路径缺少结果级 fail-closed 校验**  
    - 现象：`GET/PUT /platform/roles/{role_id}/permissions` 仅依赖下游成功返回；若返回 `role_id` 不匹配、权限码结构异常、`affected_user_count` 非法，可能被错误当作成功。  
    - 修复：新增严格权限码/计数归一化校验，并校验目标 `role_id` 与请求一致；读路径增加已授予权限必须属于可用目录约束；写路径增加“请求权限集合与下游返回集合完全一致”校验，异常统一映射 `ROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/platform/role.service.js:503`, `apps/api/src/modules/platform/role.service.js:777`, `apps/api/src/modules/platform/role.service.js:968`, `apps/api/test/platform.role.api.test.js:1123`

14. **[MEDIUM] 目录 list 返回非数组时未 fail-closed**  
    - 现象：`GET /platform/roles` 当依赖返回对象/空值时被静默映射为 `[]` 并返回 200，掩盖上游异常。  
    - 修复：对 `listPlatformRoleCatalogEntries` 返回值增加数组类型断言；非数组直接审计拒绝并返回 `ROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/platform/role.service.js:665`, `apps/api/src/modules/platform/role.service.js:670`, `apps/api/test/platform.role.api.test.js:571`

15. **[MEDIUM] 权限读取链路缺少“目录基线”约束**  
    - 现象：`GET /platform/roles/{role_id}/permissions` 仅校验“已授予权限 ⊆ 下游 available”，若下游同时返回未知权限码，会被当作合法结果透传。  
    - 修复：引入 `listPlatformPermissionCatalog` 基线；`available_permission_codes` 必须属于平台权限目录，违规即 `ROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/platform/role.service.js:754`, `apps/api/src/modules/platform/role.service.js:825`, `apps/api/test/platform.role.api.test.js:1203`

16. **[MEDIUM] 权限写入链路目录依赖异常未统一映射 503**  
    - 现象：`PUT /platform/roles/{role_id}/permissions` 读取目录时若依赖抛错，会直接冒泡为未处理异常，错误语义不稳定。  
    - 修复：为目录读取增加显式 try/catch；统一审计拒绝并映射 `ROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/platform/role.service.js:999`, `apps/api/src/modules/platform/role.service.js:1009`, `apps/api/test/platform.role.api.test.js:1359`

17. **[MEDIUM] 租户权限读取链路缺少“目录基线”约束**  
    - 现象：`GET /tenant/roles/{role_id}/permissions` 仅校验“已授予权限 ⊆ 下游 available”，若下游同时返回未知权限码，会被当作合法结果透传。  
    - 修复：引入 `listTenantPermissionCatalog` 基线；`available_permission_codes` 必须属于租户权限目录，违规即 `TROLE-503-DEPENDENCY-UNAVAILABLE`；目录依赖异常统一映射 `503`。  
    - 证据：`apps/api/src/modules/tenant/role.service.js:1497`, `apps/api/src/modules/tenant/role.service.js:1568`, `apps/api/test/tenant.role.api.test.js:2458`, `apps/api/test/tenant.role.api.test.js:2513`

18. **[MEDIUM] 租户权限写入链路目录依赖异常未统一映射 503**  
    - 现象：`PUT /tenant/roles/{role_id}/permissions` 读取目录时若依赖抛错，会直接冒泡为未处理异常，错误语义不稳定。  
    - 修复：为目录读取增加显式 try/catch；统一审计拒绝并映射 `TROLE-503-DEPENDENCY-UNAVAILABLE`。  
    - 证据：`apps/api/src/modules/tenant/role.service.js:1720`, `apps/api/src/modules/tenant/role.service.js:1730`, `apps/api/test/tenant.role.api.test.js:2790`

19. **[HIGH] Story `File List` 声称 `sprint-status.yaml` 发生改动，但 Git 无证据**  
    - 现象：`Dev Agent Record > File List` 包含 `_bmad-output/implementation-artifacts/sprint-status.yaml`，但当前工作树无该文件改动。  
    - 修复：从 `File List` 删除该条误记，避免变更追踪假阳性。  
    - 证据：`_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`, `git diff --name-only`

20. **[MEDIUM] Story `File List` 漏记真实改动文件**  
    - 现象：`apps/api/src/modules/tenant/role.service.js` 已发生改动，但未记录在 `File List`。  
    - 修复：将 `apps/api/src/modules/tenant/role.service.js` 补入 `File List`。  
    - 证据：`apps/api/src/modules/tenant/role.service.js`, `_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`, `git diff --name-only`

21. **[MEDIUM] Story `Debug Log References` 缺少租户回归单跑命令**  
    - 现象：`Validation` 声明已执行 `test/tenant.role.api.test.js`，但 `Debug Log References` 未记录对应命令。  
    - 修复：补充 `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`。  
    - 证据：`_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`

### Validation

- `pnpm --dir apps/api exec node --test test/auth.service.test.js --test-name-pattern "operator identifiers before store write"` → `288 passed`
- `pnpm --dir apps/api exec node --test test/server.test.js` → `72 passed`
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js` → `40 passed`
- `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js` → `57 passed`
- `pnpm --dir apps/api check:route-permissions` → `passed`
- `pnpm --dir apps/api lint` → `Lint passed (73 files checked)`
- `pnpm --dir apps/api test` → `1009 passed`

## Change Log

- 2026-02-21：实现角色状态变更/删除后的权限快照同步与会话收敛；新增平台/租户禁用即时失效回归测试；补齐状态同步审计与影响计数返回字段；通过全部门禁检查。
- 2026-02-21（Code Review）：修复平台域 membership 计数语义、状态不变跳过 resync、补齐 resync scope 防御校验；新增并通过对应回归测试。
- 2026-02-21（Code Review-2）：修复前置状态查询失败时 `status=disabled` 误判导致的 resync 漏触发；新增 fail-closed 回归测试并通过（`368 passed`）。
- 2026-02-21（Code Review-2 门禁复核）：`check:route-permissions`、`lint`、`test` 复跑通过（`992 passed`）。
- 2026-02-21（Code Review-3）：修复平台角色删除 fallback 审计 `beforeState` 取值错误，避免删除前状态被误记；新增回归并通过（`369 passed`）。
- 2026-02-21（Code Review-3 门禁复核）：`check:route-permissions`、`lint`、`test` 复跑通过（`993 passed`）。
- 2026-02-21（Code Review-4）：修复角色目录 create/update/delete 写路径操作者标识未规范化问题，统一传递规范化主体字段；新增 3 条回归并通过（`288 passed`）。
- 2026-02-21（Code Review-4 门禁复核）：`check:route-permissions`、`lint`、`test` 复跑通过（`996 passed`）。
- 2026-02-21（Code Review-5）：补齐 `POST /tenant/roles`、`PATCH/DELETE /tenant/roles/{role_id}`、`DELETE /platform/roles/{role_id}` 的受保护角色/删除前置条件 OpenAPI 示例，并补充契约断言。
- 2026-02-21（Code Review-5 门禁复核）：`node --test test/server.test.js`、`check:route-permissions`、`lint`、`test` 复跑通过（`72 passed` / `996 passed`）。
- 2026-02-21（Code Review-6）：为平台角色 list/create/update/delete 补齐目录记录结构校验与目标一致性校验，遇到脏记录统一 fail-closed（`ROLE-503-DEPENDENCY-UNAVAILABLE`）；新增 4 条平台 API 回归。
- 2026-02-21（Code Review-6 门禁复核）：`node --test test/platform.role.api.test.js`、`check:route-permissions`、`lint`、`test` 复跑通过（`34 passed` / `1000 passed`）。
- 2026-02-21（Code Review-7）：为平台角色权限授予 `GET/PUT` 路径补齐结果结构与目标一致性校验，异常统一 fail-closed（`ROLE-503-DEPENDENCY-UNAVAILABLE`）；新增 3 条平台 API 回归。
- 2026-02-21（Code Review-7 门禁复核）：`node --test test/platform.role.api.test.js`、`check:route-permissions`、`lint`、`test` 复跑通过（`37 passed` / `962 passed`）。
- 2026-02-21（Code Review-8）：修复平台角色目录 list 非数组载荷未 fail-closed、权限读取链路缺少目录基线校验、权限写入链路目录依赖异常映射不稳定三项问题；新增 3 条平台 API 回归并通过（`40 passed`）。
- 2026-02-21（Code Review-8 门禁复核）：`check:route-permissions`、`lint`、`test` 复跑通过（`1006 passed`）。
- 2026-02-21（Code Review-9）：修复租户角色权限读取链路缺少目录基线校验、租户权限读写链路目录依赖异常映射不稳定两项问题；新增 3 条租户 API 回归并通过（`57 passed`）。
- 2026-02-21（Code Review-9 门禁复核）：`node --test test/tenant.role.api.test.js`、`check:route-permissions`、`lint`、`test` 复跑通过（`57 passed` / `1009 passed`）。
- 2026-02-21（Code Review-10）：修复 story 追踪记录偏差：删除 `File List` 中误记的 `sprint-status.yaml`、补记 `apps/api/src/modules/tenant/role.service.js`、补充租户回归单跑命令到 `Debug Log References`。
