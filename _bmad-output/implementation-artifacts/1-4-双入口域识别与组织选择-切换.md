# Story 1.4: 双入口域识别与组织选择/切换

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 多组织用户,  
I want 系统根据入口识别访问域，并在登录后支持组织选择与会话内切换,  
so that 我能在正确域上下文进入工作台并减少误入与越域操作。

## Acceptance Criteria

1. **Given** 用户从平台入口或组织入口发起登录  
   **When** 登录成功  
   **Then** 系统按入口识别并绑定目标访问域（`platform`/`tenant`）  
   **And** 若无对应域有效权限则拒绝进入并返回 `AUTH-403-NO-DOMAIN`

2. **Given** 用户在组织域存在多个有效组织关系  
   **When** 登录成功进入组织域  
   **Then** 系统展示组织选择页并要求用户选择目标组织后进入工作台  
   **And** 选择结果进入服务端会话上下文用于后续鉴权

3. **Given** 用户在组织域仅有一个有效组织关系  
   **When** 登录成功  
   **Then** 系统可直接进入该组织工作台  
   **And** 会话中仍提供“切换组织”入口并可回到组织选择页

4. **Given** 用户在会话内切换组织  
   **When** 选择新的目标组织  
   **Then** 系统更新会话中的组织上下文并即时生效  
   **And** 页面权限可见性与可操作性按新组织权限重算

## Tasks / Subtasks

- [x] 会话上下文模型扩展（AC: 1,2,3,4）
  - [x] 为 `auth_sessions` 增加域与组织上下文字段（建议：`entry_domain`、`active_tenant_id`），并补充 migration 与回滚策略
  - [x] 在 `auth.store.mysql.js` 与 `auth.store.memory.js` 增加会话上下文字段读写能力，保持接口一致
  - [x] 确保会话上下文只由服务端更新，不采信客户端直接透传租户上下文

- [x] 登录链路接入入口域识别（AC: 1,2,3）
  - [x] 在 `/auth/login` 与 `/auth/otp/login` 请求中引入入口域参数（建议 `entry_domain`）
  - [x] 登录成功后将入口域写入服务端会话上下文
  - [x] 对无有效域权限用户返回 `AUTH-403-NO-DOMAIN`（Problem Details 结构）

- [x] 组织选择与切换接口（AC: 2,3,4）
  - [x] 新增组织候选查询与选择接口（建议：`/auth/tenant/options`、`/auth/tenant/select`）
  - [x] 新增会话内切换接口（建议：`/auth/tenant/switch`）
  - [x] 选择或切换后更新 `auth_sessions.active_tenant_id` 并返回最新会话上下文

- [x] 前端双入口与组织切换流程（AC: 1,2,3,4）
  - [x] 在 Web 登录页支持入口域选择（平台入口/组织入口）
  - [x] 组织入口登录后，按组织候选数量执行“直接进入”或“组织选择页”
  - [x] 在已登录态提供“切换组织”入口，并在切换后刷新权限相关页面状态

- [x] 鉴权与拒绝语义统一（AC: 1,4）
  - [x] 统一 `AUTH-403-NO-DOMAIN` 的错误码、文案与 Problem Details 字段
  - [x] 组织切换后的接口鉴权必须读取服务端会话上下文，不信任客户端租户参数

- [x] OpenAPI 契约与文档同步（AC: 1,2,3,4）
  - [x] 在 `openapi.js` 中补齐新增字段与新增接口契约、示例、错误响应
  - [x] 补充 `AUTH-403-NO-DOMAIN` 与组织切换相关错误示例

- [x] 审计与可观测（AC: 1,2,4）
  - [x] 记录 `auth.domain.bound`、`auth.tenant.selected`、`auth.tenant.switched`、`auth.domain.rejected` 审计事件
  - [x] 审计与错误日志均带 `request_id`、`session_id`、`entry_domain`、`tenant_id`（如有）

- [x] 测试与门禁（AC: 1,2,3,4）
  - [x] API 测试：双入口识别、无域权限拒绝、多组织选择、单组织直入、切换即时生效
  - [x] 回归测试：不破坏 Story 1.2/1.3（密码/验证码登录、refresh/logout、限流）
  - [x] Web Chrome 真实浏览器测试：入口切换、组织选择、组织切换、错误反馈统一语义

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 在 MySQL 存储实现真实域权限查询与组织候选查询；当前固定返回会导致持久化路径下 AC2/AC3 不成立 [apps/api/src/modules/auth/auth.store.mysql.js:146]
- [x] [AI-Review][HIGH] 在组织切换后补齐权限可见性/可操作性重算链路；当前仅刷新租户上下文文本 [apps/web/src/App.jsx:430]
- [x] [AI-Review][HIGH] 补齐 migration 回滚策略与执行入口；当前仅有正向迁移与正向执行 [apps/api/scripts/migrate-baseline.js:75]
- [x] [AI-Review][MEDIUM] 对齐 OpenAPI 与实现的 `entry_domain` 必填/默认语义，避免契约漂移 [apps/api/src/openapi.js:804]
- [x] [AI-Review][MEDIUM] 提升迁移幂等与原子性：索引创建避免重复失败并保证多语句事务一致 [apps/api/migrations/0004_auth_session_domain_tenant_context.sql:5]
- [x] [AI-Review][MEDIUM] 修正 Story File List 与 git 现实不一致的记录，确保变更透明 [_bmad-output/implementation-artifacts/1-4-双入口域识别与组织选择-切换.md:261]

### Review Follow-ups (AI) - Round 2

- [x] [AI-Review][HIGH] 修正“无显式域权限记录”时默认放行平台域的问题，满足 AC1 的“无对应域权限应拒绝”语义 [apps/api/src/modules/auth/auth.store.mysql.js:177]
- [x] [AI-Review][HIGH] 将组织切换后的权限重算改为基于服务端真实权限结果，而非前端按 `tenant_id` 后缀推导的本地快照 [apps/web/src/App.jsx:81]
- [x] [AI-Review][MEDIUM] 约束 `migrate:down --version` 仅允许回滚最新已应用版本，避免中间版本回滚造成迁移历史与 Schema 漂移 [apps/api/scripts/migrate-baseline.js:221]
- [x] [AI-Review][MEDIUM] 补齐 MySQL 持久化路径下的租户接口集成测试（`/auth/tenant/options|select|switch`），当前 express 集成仅覆盖 login/refresh [apps/api/test/auth.express.api.test.js:337]

### Review Follow-ups (AI) - Round 3

- [x] [AI-Review][HIGH] `tenant_permission_context` 在权限数据缺失时仍使用 tenantId 后缀推导“允许”权限（`A/B/默认`），可能导致权限高估；需改为服务端真实权限缺失即直接拒绝（403），禁止降级放行 [apps/api/src/modules/auth/auth.service.js:315]
- [x] [AI-Review][HIGH] 未对会话中的 `active_tenant_id` 做“仍在可选组织列表中”的一致性校验；成员关系变更后可能继续返回过期组织上下文 [apps/api/src/modules/auth/auth.service.js:1450]
- [x] [AI-Review][HIGH] 将“域权限/租户权限依赖表缺失”改为启动期 schema preflight 硬失败（不允许服务启动）；禁止运行期默认放行 [apps/api/src/app.js:87]
- [x] [AI-Review][MEDIUM] 补齐 schema preflight 测试：缺失 `auth_user_domain_access` / `auth_user_tenants`（及权限列）时启动失败，错误信息可观测 [apps/api/test/auth.express.api.test.js:450]
- [x] [AI-Review][MEDIUM] Story File List 仍与 git 现实不完全一致：`.gitignore` 已变更但未记录，变更透明性不足 [_bmad-output/implementation-artifacts/1-4-双入口域识别与组织选择-切换.md:289]

### Review Follow-ups (AI) - Round 4

- [x] [AI-Review][HIGH] `getDomainAccessForUser` 在 `authStore.findDomainAccessByUserId` 缺失时默认返回 `{ platform: true, tenant: true }`，属于 fail-open；需改为 fail-closed 并拒绝登录 [apps/api/src/modules/auth/auth.service.js:525]
- [x] [AI-Review][MEDIUM] 启动期 schema preflight 仅校验 4 个权限列，未覆盖运行期查询依赖的基础列（如 `status`、`tenant_id`、`tenant_name`），仍可能“启动成功但运行时 SQL 失败” [apps/api/src/app.js:34]
- [x] [AI-Review][MEDIUM] `auth_user_domain_access` 仅在迁移阶段回填，当前代码无新增/变更写入路径；后续新建用户可能无平台域记录而被拒绝登录，需补齐域权限写入策略 [apps/api/migrations/0005_auth_domain_tenant_membership.sql:26]
- [x] [AI-Review][MEDIUM] Story 任务虽已全 `[x]`，但关键集成测试依赖（MySQL）未在本地门禁跑通；需明确“环境未就绪”下的评审准入与完成标准 [apps/api/test/auth.express.api.test.js:378]

### Review Follow-ups (AI) - Round 5

- [x] [AI-Review][HIGH] `0005_auth_domain_tenant_membership.sql` 创建 `auth_user_tenants` 时未包含运行期依赖的权限列（`can_view_member_admin`、`can_operate_member_admin`、`can_view_billing`、`can_operate_billing`）；而启动期 schema preflight 明确要求这些列，导致“全新库按迁移初始化后服务无法启动” [apps/api/migrations/0005_auth_domain_tenant_membership.sql:13]
- [x] [AI-Review][MEDIUM] `auth.express.api.test.js` 在测试初始化阶段会为 `auth_user_tenants` 动态补齐缺失权限列，掩盖了迁移脚本缺陷；需增加“仅执行正式迁移后直接启动 createApiApp”的契约回归，防止再次出现迁移/运行期契约漂移 [apps/api/test/auth.express.api.test.js:176]

### Review Follow-ups (AI) - Round 6

- [x] [AI-Review][HIGH] `0005` 迁移仅回填 `platform` 域权限，且当前代码无 `tenant` 域权限写入路径；`findDomainAccessByUserId` 在存在任意域记录时不会再用 `auth_user_tenants` 回退判定，导致“有组织关系但无 tenant 域记录”的用户在组织入口被拒绝（AC2/AC3 受影响） [apps/api/migrations/0005_auth_domain_tenant_membership.sql:30] [apps/api/src/modules/auth/auth.store.mysql.js:161] [apps/api/src/modules/auth/auth.store.mysql.js:177]
- [x] [AI-Review][MEDIUM] 迁移执行器将 DDL 包裹在事务语义中，但 MySQL DDL 隐式提交，无法保证“全成功/全回滚”；故障中断时可能留下部分已执行 schema，增加恢复复杂度 [apps/api/scripts/migrate-baseline.js:133] [apps/api/scripts/migrate-baseline.js:231]
- [x] [AI-Review][MEDIUM] `/auth/tenant/options` 在平台入口会话下仍返回完整 `tenant_options`，存在跨入口最小暴露边界不清风险；需明确是否应在 `entry_domain=platform` 时返回空列表 [apps/api/src/modules/auth/auth.service.js:1568] [apps/api/src/modules/auth/auth.service.js:1591]
- [x] [AI-Review][MEDIUM] Story File List 与当前 git 现实仍不一致：存在 14 个未记录的 `_bmad-output/*` 变更文件，评审可追溯性不足 [_bmad-output/implementation-artifacts/1-4-双入口域识别与组织选择-切换.md:366]

### Review Follow-ups (AI) - Round 7

- [x] [AI-Review][HIGH] `login/loginWithOtp` 在域权限校验前无条件执行 `ensureDefaultDomainAccessForUser`，会在“组织入口登录失败”路径上写入 `platform` 域权限，产生越权扩权副作用（失败请求不应提升权限） [apps/api/src/modules/auth/auth.service.js:949] [apps/api/src/modules/auth/auth.service.js:1211]
- [x] [AI-Review][HIGH] Mock/In-Memory 存储未实现 `ensureTenantDomainAccessForUser`，导致“有活跃组织关系但无显式 tenant 域记录”的用户在内存路径下被拒绝组织入口登录，与 MySQL 路径行为不一致 [apps/api/src/modules/auth/auth.service.js:551] [apps/api/src/modules/auth/auth.store.memory.js:54]
- [x] [AI-Review][MEDIUM] 启动期 schema preflight 未覆盖 `auth_sessions.entry_domain/active_tenant_id`，在迁移部分执行或历史库缺列时可能出现“启动成功但登录链路运行期 SQL 失败” [apps/api/src/app.js:33] [apps/api/src/modules/auth/auth.store.mysql.js:105]
- [x] [AI-Review][MEDIUM] MySQL 持久化集成测试仅断言 `tenant_selection_required/active_tenant_id`，未断言 `tenant_permission_context` 的真实权限值，无法防止 AC4（切换后可见性/可操作性重算）在持久化路径退化 [apps/api/test/auth.express.api.test.js:525] [apps/api/test/auth.express.api.test.js:572]

### Review Follow-ups (AI) - Round 8

- [x] [AI-Review][MEDIUM] `createApiApp boots with auth schema created only from official migrations` 用例仅执行 `0005` 且未重建/校验 `auth_sessions`，无法覆盖 `0004` 迁移退化；需新增“从空库执行官方迁移链后启动 `createApiApp` 并校验登录链路”的契约回归 [apps/api/test/auth.express.api.test.js:662] [apps/api/test/auth.express.api.test.js:684]
- [x] [AI-Review][MEDIUM] 启动期 schema preflight 对 `auth_sessions` 仅校验 `entry_domain/active_tenant_id`，未覆盖运行期 SQL 必需列（`session_id`、`user_id`、`session_version`、`status`、`revoked_reason`、`updated_at`）；存在“启动通过但登录/刷新运行期失败”窗口 [apps/api/src/app.js:34] [apps/api/src/modules/auth/auth.store.mysql.js:105]

## Dev Notes

### Developer Context（开发者必须先读）

- 这是认证域能力增强故事，不是平台/组织治理功能故事。优先在 `auth` 聚合内完成“域绑定 + 会话上下文 + 选择/切换”闭环，不扩散到无关模块。
- 当前仓库已稳定提供 `login/otp/refresh/logout/change-password` 链路，Story 1.4 要在现有链路上扩展，不要平行造一套登录或会话逻辑。
- 组织域最终判定必须基于服务端会话上下文，不可通过客户端传入 `tenant_id` 直接决定鉴权结果。

### Technical Requirements（实现硬约束）

- 入口域识别：
  - 支持 `platform` 与 `tenant` 两类入口。
  - 登录成功后会话必须绑定入口域。
- 无域权限拒绝：
  - 当目标入口无有效权限时，统一返回 `AUTH-403-NO-DOMAIN`。
  - 响应使用 Problem Details，错误语义与前端动作映射一致。
- 组织选择/切换：
  - 多组织用户在组织域登录后必须先选组织再进入工作台。
  - 单组织用户可直接进入，但仍提供切换入口。
  - 切换结果持久化在服务端会话上下文并即时生效。
- 安全边界：
  - 组织域鉴权仅信任服务端确认的有效租户上下文。
  - 禁止将客户端租户参数作为最终鉴权依据。

### Architecture Compliance（架构对齐清单）

- 遵循 `platform.*` / `tenant.*` 双域 RBAC 强隔离约束。
- 延续 `REST + OpenAPI + Problem Details + request_id` 契约与错误模型。
- 保持认证核心逻辑在 `apps/api/src/modules/auth` 聚合内。
- 关键上下文变更需可观测、可审计、可回归验证。

### Library & Framework Requirements（库与框架要求）

- Story 内不做主栈升级，沿用仓库锁定版本：
  - `@nestjs/core`: `11.1.13`
  - `react`: `19.2.4`
  - `typeorm`: `0.3.28`
  - `ioredis`: `5.9.2`
  - `vite`: `7.3.1`
  - `mysql2`: `3.17.0`
- 如必须新增依赖，需说明“新增原因 + 回归影响面”，并补齐测试。

### File Structure Requirements（建议变更落点）

- 后端：
  - `apps/api/src/modules/auth/auth.routes.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/openapi.js`
  - `apps/api/migrations/*.sql`（新增会话上下文字段 migration）
- 前端：
  - `apps/web/src/App.jsx`（或后续拆分后的 auth 页面目录）
  - `apps/web/test/chrome.playwright.test.js`
- 测试：
  - `apps/api/test/auth.express.api.test.js`
  - 新增域识别/组织选择/切换专项测试文件（建议 `auth.domain.api.test.js`）

### Testing Requirements（测试要求）

- API 必测：
  - 平台入口登录成功且会话写入 `entry_domain=platform`
  - 组织入口登录时多组织返回“需选择组织”
  - 组织入口登录时单组织直接进入并写入 `active_tenant_id`
  - 无域权限拒绝返回 `AUTH-403-NO-DOMAIN`
  - 组织切换后会话上下文更新且后续接口按新组织上下文判定
- 回归必测：
  - Story 1.2/1.3 既有认证链路全部通过
  - 错误语义与 OpenAPI 示例一致
- Web 必测（Chrome）：
  - 入口域切换
  - 组织选择页流程
  - 会话内组织切换与即时反馈
  - 失败语义“原因 + 请稍后重试”、字段级错误不重复叠加

### Previous Story Intelligence（来自 Story 1.3）

- 已有能力可复用：
  - 统一认证错误模型（Problem Details + 业务错误码）
  - 登录/刷新/登出与会话持久化链路
  - 请求级 `request_id` 与审计事件框架
  - Web 端登录模式切换、提交防重复、失败语义框架
- 落地经验：
  - 不要在 `app.js`/`server.js` 维持两套分叉逻辑，应复用统一路由分发。
  - 门禁测试不能靠默认 `skip` 路径“误绿”。

### Git Intelligence Summary

- 最近可见提交历史仅 `initial commit`，缺少可参考的提交模式序列。
- 可确认的稳定实现边界：
  - 认证与会话集中在 `modules/auth`
  - 路由调度集中在 `http-routes.js` + `server.js`
  - Web 当前登录入口在 `App.jsx`，可在该基础上继续演进

### Latest Tech Information（2026-02-12 核验）

- npm registry 实时核验结果：
  - `@nestjs/core`: `11.1.13`
  - `react`: `19.2.4`
  - `typeorm`: `0.3.28`
  - `ioredis`: `5.9.2`
  - `vite`: `7.3.1`
  - `mysql2`: `3.17.0`
- Node 发布线：`v24` 为 Active LTS，项目 `node >=24` 约束对齐。
- MySQL 8.4 LTS 当前补丁线为 `8.4.8`（建议 compose 固定 patch，减少漂移）。

### Project Context Reference

- 未发现 `project-context.md`（匹配模式：`**/project-context.md`）。
- 本故事上下文以 `epics/prd/architecture/ux` 与 Story 1.2/1.3 为准。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Round 9 code review approved; Story 1.4 marked done`

### Project Structure Notes

- Story 1.4 以认证域“域识别 + 会话上下文”扩展为主，避免提前实现 Epic 2/3 的完整治理能力。
- 数据结构演进以最小可支持“组织选择/切换”为目标，复杂治理字段留给后续故事增量扩展。

### References

- Story 1.4 定义与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 1.4: 双入口域识别与组织选择/切换]
- FR 约束（FR6/FR7/FR8/FR9/FR68）  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 双域隔离与服务端租户最终判定  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 一致性（反馈、提交防重、流程连续性）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 上一故事实现上下文  
  [Source: _bmad-output/implementation-artifacts/1-3-验证码登录与发送频控.md]
- npm package metadata（实时版本）  
  [Source: https://www.npmjs.com/package/@nestjs/core]  
  [Source: https://www.npmjs.com/package/react]  
  [Source: https://www.npmjs.com/package/typeorm]  
  [Source: https://www.npmjs.com/package/ioredis]  
  [Source: https://www.npmjs.com/package/vite]  
  [Source: https://www.npmjs.com/package/mysql2]
- Node 发布线  
  [Source: https://nodejs.org/en/about/previous-releases]
- MySQL 8.4 release notes  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

gpt-5-codex

### Debug Log References

- `cat _bmad-output/implementation-artifacts/sprint-status.yaml`
- `cat _bmad-output/planning-artifacts/epics.md`
- `cat _bmad-output/planning-artifacts/prd.md`
- `cat _bmad-output/planning-artifacts/architecture.md`
- `cat _bmad-output/planning-artifacts/ux-design-specification.md`
- `cat _bmad-output/implementation-artifacts/1-3-验证码登录与发送频控.md`
- `git log --oneline -n 5`
- `pnpm view @nestjs/core version`
- `pnpm view react version`
- `pnpm view typeorm version`
- `pnpm view ioredis version`
- `pnpm view vite version`
- `pnpm view mysql2 version`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.express.api.test.js --test-name-pattern "createApiApp"`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api test`
- `docker version`
- `docker compose version`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js test/auth.domain.api.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js --test-name-pattern "official migrations"`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/web test`
- `cd apps/api && node --test --test-force-exit $(ls test/*.test.js | grep -v 'auth.express.api.test.js' | grep -v 'auth.otp.redis.api.test.js')`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web lint`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js test/auth.domain.api.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/web exec node --test test/chrome.playwright.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- `docker compose up -d mysql redis`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js test/auth.express.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js --test-name-pattern "0005 migration defines"`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js --test-name-pattern "official migrations"`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/auth.express.api.test.js --test-name-pattern "0005 migration defines|official migrations"`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.domain.api.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/web lint`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/web test`
- `pnpm --dir apps/api lint`

### Completion Notes List

- 已完成 Story 1.4 的上下文分析、架构护栏提炼与最新技术信息核验。
- 已生成 `ready-for-dev` 级别开发指导，覆盖后端/前端/契约/测试与回归要求。
- 已给出可执行的最小落地路径，避免提前引入 Epic 2/3 的范围膨胀。
- 已实现会话上下文字段扩展：`auth_sessions.entry_domain`、`auth_sessions.active_tenant_id`，并补充 migration `0004_auth_session_domain_tenant_context.sql`。
- 已在登录链路接入 `entry_domain`，实现 `AUTH-403-NO-DOMAIN` 统一拒绝语义，并写入 `auth.domain.bound` / `auth.domain.rejected` 审计事件。
- 已新增 `/auth/tenant/options`、`/auth/tenant/select`、`/auth/tenant/switch`，并在服务端会话中持久化与切换 `active_tenant_id`。
- 已完成 OpenAPI 契约同步（新增字段、接口、403 示例）并更新路由分发层。
- 已实现 Web 端双入口选择、组织选择页、会话内组织切换及即时反馈；Chrome 回归覆盖入口切换/组织选择/组织切换/错误反馈语义。
- ✅ Resolved review finding [HIGH]: MySQL 存储已接入真实域权限/租户候选查询，并在缺失新表时提供兼容回退，避免持久化路径错误拒绝。
- ✅ Resolved review finding [HIGH]: 前端组织切换后增加权限可见性/可操作性重算，切换租户后功能入口状态即时更新。
- ✅ Resolved review finding [HIGH]: 迁移补齐回滚链路（`0004.down`、`0005.down`）与 `migrate:down` 执行入口，`migrate-baseline.js` 支持 up/down 与目标版本回滚。
- ✅ Resolved review finding [MEDIUM]: OpenAPI `entry_domain` 契约调整为可选 + 默认 `platform`，与运行时语义对齐。
- ✅ Resolved review finding [MEDIUM]: `0004` 迁移增加索引幂等创建与执行原子性保护，降低重复执行失败风险。
- ✅ Resolved review finding [MEDIUM]: Story `File List` 已与当前代码改动对齐，移除不一致记录。
- ✅ Resolved review finding [HIGH]: 修复 MySQL 域权限空记录默认放行平台域的问题，`auth_user_domain_access` 无记录时按“无域权限”拒绝。
- ✅ Resolved review finding [HIGH]: 组织权限重算改为服务端返回 `tenant_permission_context`，前端不再按 `tenant_id` 后缀本地推导。
- ✅ Resolved review finding [MEDIUM]: `migrate:down --version` 仅允许回滚最新已应用版本，并新增 `migrate-baseline` 单测覆盖。
- ✅ Resolved review finding [MEDIUM]: 新增 MySQL 持久化路径下 `/auth/tenant/options|select|switch` express 集成测试。
- 测试结果：`pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js test/auth.domain.api.test.js test/migrate-baseline.test.js` 通过（36/36）；`pnpm --dir apps/web exec node --test test/chrome.playwright.test.js` 通过（1/1）；`pnpm --dir apps/web test`、`pnpm --dir apps/api lint`、`pnpm --dir apps/web lint` 通过；`apps/api` 全量测试仍受本地 MySQL/Redis 不可达影响失败（`ECONNREFUSED 127.0.0.1:3306`、Redis connection closed）。
- 2026-02-12 Round 3 代码审查新增 5 条待处理项（3 High / 2 Medium）；Story 状态回退为 `in-progress`，待修复后再进 `review`。
- 2026-02-12 决策记录：对“权限依赖表缺失”的处理采用启动期 schema preflight 硬失败策略（不采用运行期容错放行），本轮仅更新 Story 行动项，暂不改代码。
- Round 3 测试核验：`pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js test/auth.domain.api.test.js test/migrate-baseline.test.js` 通过（36/36）；`pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js` 在本地 MySQL 不可用下失败（4 fail, `ECONNREFUSED 127.0.0.1:3306`）。
- ✅ Resolved review finding [HIGH]: 移除 `tenant_permission_context` 的 tenantId 后缀兜底推导；无真实权限上下文时统一返回 `AUTH-403-NO-DOMAIN`，禁止降级放行。
- ✅ Resolved review finding [HIGH]: 新增会话 `active_tenant_id` 一致性收敛；`tenant/options` 与 `refresh` 会校验租户仍在可选列表，失效时服务端重置并即时生效。
- ✅ Resolved review finding [HIGH]: 新增启动期 schema preflight（`auth_user_domain_access`、`auth_user_tenants` 与 4 个权限列），缺失即启动失败；移除运行期默认放行分支。
- ✅ Resolved review finding [MEDIUM]: 补齐 schema preflight 测试（缺表、缺权限列）及相关 store/service 单测，覆盖错误可观测与拒绝语义。
- ✅ Resolved review finding [MEDIUM]: `File List` 补齐 `.gitignore`，与当前 git 变更保持一致。
- 本轮测试结果：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js` 通过（31/31）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）；`pnpm --dir apps/api test` 因本地 MySQL/Redis 不可用失败（7 fail，`ECONNREFUSED 127.0.0.1:3306`、Redis connection closed），且 Docker daemon 不可用导致无法拉起依赖。
- Round 4 测试核验：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js` 通过（28/28）；`pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js` 在本地 MySQL 不可用下失败（4 fail，`ECONNREFUSED 127.0.0.1:3306`）。
- ✅ Resolved review finding [HIGH]: `getDomainAccessForUser` 在 store contract 缺失时改为 fail-closed（默认拒绝），不再默认放行双域登录。
- ✅ Resolved review finding [MEDIUM]: schema preflight 扩展为双表基础列 + 权限列全量校验，覆盖 `auth_user_domain_access(user_id,domain,status)` 与 `auth_user_tenants(user_id,tenant_id,tenant_name,status,can_*)`。
- ✅ Resolved review finding [MEDIUM]: 新增域权限写入策略 `ensureDefaultDomainAccessForUser`，当用户无任何域记录时自动补齐 `platform` 有效域并审计 `auth.domain.default_granted`。
- ✅ Resolved review finding [MEDIUM]: 明确评审准入标准（依赖环境未就绪时）：
  - 代码级准入：`apps/api` lint 通过，`auth.service/auth.store.mysql/auth.domain` 单测全绿，schema preflight 用例全绿。
  - 环境级准入：MySQL/Redis 集成门禁受本机依赖可用性约束；若 `ECONNREFUSED`/Redis closed，允许以“受环境阻塞”进入 review，但需在 Story 明确记录失败原因与复跑命令。
  - 发布前准入：必须在具备 MySQL/Redis 的 CI 或本地可用环境复跑 `pnpm --dir apps/api test` 全绿。
- Round 4 测试结果：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js` 通过（35/35）；`pnpm --dir apps/api exec node --test test/auth.express.api.test.js --test-name-pattern "createApiApp"` 通过相关 preflight 用例（5/5）；`pnpm --dir apps/api lint`、`pnpm --dir apps/web test` 通过；`pnpm --dir apps/api test` 仍因本机 MySQL/Redis 不可达失败（7 fail）。
- ✅ Resolved gate finding [HIGH]: 修复 `ensureAuthSchemaPreflight` 对真实 MySQL `information_schema` 返回大写键（`TABLE_NAME`/`COLUMN_NAME`）的兼容性，消除“缺表/缺列”误判。
- ✅ Resolved gate finding [MEDIUM]: 修复 `auth.express.api.test.js` 的 MySQL 预置 SQL 兼容性（移除 `ADD COLUMN IF NOT EXISTS` 组合语法），并补齐 `auth_sessions.entry_domain/active_tenant_id` 缺列回填逻辑。
- 最终门禁结果（本机 MySQL/Redis 已可用）：`pnpm --dir apps/api test` 通过（85/85），`pnpm --dir apps/api lint` 通过，`pnpm --dir apps/web test` 通过（4/4）。
- Round 5 测试核验（2026-02-12）：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.domain.api.test.js test/migrate-baseline.test.js` 通过（42/42）；`pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js` 通过（10/10）；`pnpm --dir apps/api test` 通过（85/85）；`pnpm --dir apps/api lint`、`pnpm --dir apps/web test` 通过。
- Round 5 代码审查结论：发现迁移与运行期 schema preflight 存在结构性漂移（`0005` 缺失 `can_*` 权限列），当前仅更新 Story 行动项，暂不改业务代码。
- ✅ Resolved review finding [HIGH]: 修复 `0005_auth_domain_tenant_membership.sql`，在 `auth_user_tenants` 正式迁移中补齐 `can_view_member_admin`、`can_operate_member_admin`、`can_view_billing`、`can_operate_billing` 四个运行期必需权限列。
- ✅ Resolved review finding [MEDIUM]: 新增“仅执行正式迁移后启动 `createApiApp`”契约回归测试，防止测试初始化动态补列掩盖迁移缺陷；并新增 `0005` 迁移静态契约断言。
- Round 5 Follow-ups 收尾核验（2026-02-12）：`pnpm --dir apps/api test` 通过（87/87）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）。
- ✅ Resolved review finding [HIGH]: `0005` 迁移新增 tenant 域回填（基于 `auth_user_tenants`），并在 MySQL 存储层补齐“无 tenant 域记录但有活跃组织关系”的安全回退判定，同时新增 `ensureTenantDomainAccessForUser` 运行期写入路径。
- ✅ Resolved review finding [MEDIUM]: 迁移执行器新增 `shouldRunStatementsInTransaction` 判定；包含 DDL 的迁移改为非事务执行并记录告警，移除误导性的“DDL 原子事务”语义。
- ✅ Resolved review finding [MEDIUM]: `/auth/tenant/options` 在 `entry_domain=platform` 会话下返回空 `tenant_options`，并固定 `tenant_selection_required=false`、`active_tenant_id=null`，收敛跨入口信息暴露。
- ✅ Resolved review finding [MEDIUM]: Story `File List` 对齐当前 git 现实，补齐 14 个 `_bmad-output/*` 变更文件。
- Round 6 Follow-ups 收尾核验（2026-02-12）：`pnpm --dir apps/api test` 通过（92/92）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）。
- ✅ Resolved review finding [HIGH]: `login/loginWithOtp` 仅在 `entry_domain=platform` 时执行 `ensureDefaultDomainAccessForUser`，tenant 入口失败路径不再写入 `platform` 域权限。
- ✅ Resolved review finding [HIGH]: In-Memory 存储补齐 `ensureTenantDomainAccessForUser`，并对租户 `status` 做 active 过滤，tenant 入口行为与 MySQL 路径对齐。
- ✅ Resolved review finding [MEDIUM]: 启动期 schema preflight 扩展 `auth_sessions(entry_domain, active_tenant_id)` 必需列校验，并补齐缺列失败测试。
- ✅ Resolved review finding [MEDIUM]: MySQL 持久化集成测试新增 `tenant_permission_context` 值级断言（登录未选组织、select tenant-a、switch tenant-b）。
- Round 7 Follow-ups 收尾核验（2026-02-12）：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.domain.api.test.js` 通过（30/30）；`pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js` 通过（12/12）；`pnpm --dir apps/api test` 通过（95/95）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）；`pnpm --dir apps/web lint` 通过。
- Definition of Done（Enhanced Checklist）核验结论：PASS（关键质量门禁、文档追踪、状态流转均满足）。
- Round 8 测试核验（2026-02-12）：`pnpm --dir apps/api test` 通过（95/95）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）。
- Round 8 代码审查结论：新增 2 条 Review Follow-ups（0 High / 2 Medium），主要为迁移契约覆盖与 `auth_sessions` preflight 列覆盖缺口；Story 状态更新为 `in-progress`。
- ✅ Resolved review finding [MEDIUM]: 官方迁移链集成测试扩展为从近空库执行 `0002/0003/0004/0005`，并通过真实 `/auth/login` 校验迁移到运行期链路；迁移 SQL 执行器改为 `query` 以兼容 `PREPARE` 语句。
- ✅ Resolved review finding [MEDIUM]: 启动期 schema preflight 扩展 `auth_sessions` 运行期必需列（`session_id`、`user_id`、`session_version`、`entry_domain`、`active_tenant_id`、`status`、`revoked_reason`、`updated_at`），并同步缺列失败测试桩。
- ✅ Resolved review finding [MEDIUM]: `0004` 迁移改为 `information_schema` 守卫式补列（移除 MySQL 不兼容 `ADD COLUMN IF NOT EXISTS` 语法），并新增迁移静态守护测试防回归。
- Round 8 Follow-ups 收尾核验（2026-02-12）：`pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js` 通过（12/12）；`pnpm --dir apps/api test` 通过（96/96）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）；`pnpm --dir apps/web lint` 通过。
- Round 9 代码审查核验（2026-02-12）：`pnpm --dir apps/api test` 通过（96/96）；`pnpm --dir apps/api lint` 通过；`pnpm --dir apps/web test` 通过（4/4）；本轮无新增 follow-ups。

### Senior Developer Review (AI)

- Date: 2026-02-12
- Reviewer: 老大
- Outcome: Approved
- Summary:
  - Round 9：复核 Round 8 修复项后，官方迁移链契约覆盖（含 `0004`）与 `auth_sessions` preflight 运行期列覆盖均已到位。
  - Round 9：未发现新的功能回归或契约漂移风险；门禁结果保持全绿（API 全量测试、API lint、Web 测试）。

### File List

- _bmad-output/implementation-artifacts/1-4-双入口域识别与组织选择-切换.md
- _bmad-output/implementation-artifacts/sprint-status.yaml
- _bmad-output/implementation-artifacts/1-1-基座初始化与全-docker-本地环境.md
- _bmad-output/implementation-artifacts/1-2-密码登录-会话刷新与当前会话登出.md
- _bmad-output/implementation-artifacts/1-3-验证码登录与发送频控.md
- _bmad-output/implementation-artifacts/code-review-1-3.md
- _bmad-output/implementation-artifacts/workflow-execution-log.md
- _bmad-output/planning-artifacts/architecture.md
- _bmad-output/planning-artifacts/epics.md
- _bmad-output/planning-artifacts/implementation-readiness-report-2026-02-11.md
- _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md
- _bmad-output/planning-artifacts/prd.md
- _bmad-output/planning-artifacts/sprint-change-proposal-2026-02-11.md
- _bmad-output/planning-artifacts/ux-color-themes.html
- _bmad-output/planning-artifacts/ux-design-directions.html
- _bmad-output/planning-artifacts/ux-design-specification.md
- apps/api/migrations/0004_auth_session_domain_tenant_context.sql
- apps/api/migrations/0004_auth_session_domain_tenant_context.down.sql
- apps/api/migrations/0005_auth_domain_tenant_membership.sql
- apps/api/migrations/0005_auth_domain_tenant_membership.down.sql
- apps/api/package.json
- apps/api/scripts/migrate-baseline.js
- apps/api/src/app.js
- apps/api/src/http-routes.js
- apps/api/src/modules/auth/auth.routes.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/openapi.js
- apps/api/src/server.js
- apps/api/test/auth.domain.api.test.js
- apps/api/test/auth.express.api.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/auth.service.test.js
- apps/api/test/migrate-baseline.test.js
- .gitignore
- package.json
- apps/web/src/App.jsx
- apps/web/test/chrome.playwright.test.js

### Change Log

- 2026-02-12: 完成 Story 1.4 实现，新增域上下文会话模型、组织选择/切换接口、前端双入口与组织切换流程、OpenAPI 契约及专项测试覆盖。
- 2026-02-12: 完成 Review Follow-ups（10/10）；修复域权限默认放行、权限重算服务端化、迁移回滚版本约束与 MySQL 租户接口集成测试覆盖，状态更新为 `review`。
- 2026-02-12: 完成 Round 3 代码审查，新增 4 条 Review Follow-ups（3 High / 1 Medium），状态更新为 `in-progress`。
- 2026-02-12: 完成 Round 3 Review Follow-ups（5/5）；修复权限缺失降级放行、会话租户一致性、启动期 schema preflight 与测试补齐，状态更新为 `review`。
- 2026-02-12: 完成 Round 4 代码审查，新增 4 条 Review Follow-ups（1 High / 3 Medium），状态更新为 `in-progress`。
- 2026-02-12: 完成 Round 4 Review Follow-ups（4/4）；修复域权限判定 fail-open、补齐域权限默认写入策略、扩展 schema preflight 列覆盖并明确“环境阻塞”评审准入标准，状态更新为 `review`。
- 2026-02-12: 修复 MySQL 真实环境下的门禁闭环问题（information_schema 大写键兼容、集成测试建表 SQL 兼容与 auth_sessions 缺列回填）；`apps/api` 全量测试、`apps/api` lint、`apps/web` 测试均通过。
- 2026-02-12: 完成 Round 5 代码审查，新增 2 条 Review Follow-ups（1 High / 1 Medium）；定位迁移 `0005` 与运行期 schema preflight 的列契约漂移，状态更新为 `in-progress`。
- 2026-02-12: 完成 Round 5 Review Follow-ups（2/2）；补齐 `0005` 权限列迁移与 migration-to-runtime 契约回归测试，`apps/api` 全量测试与 lint、`apps/web` 测试均通过，状态更新为 `review`。
- 2026-02-12: 完成 Round 6 代码审查，新增 4 条 Review Follow-ups（1 High / 3 Medium）；Story 状态更新为 `in-progress`，待修复后回到 `review`。
- 2026-02-12: 完成 Round 6 Review Follow-ups（4/4）；补齐 tenant 域回填/运行期写入路径、DDL 非事务执行策略、平台入口 `tenant_options` 最小暴露策略，并同步 Story File List 文档工件，状态更新为 `review`。
- 2026-02-12: 完成 Round 7 代码审查，新增 4 条 Review Follow-ups（2 High / 2 Medium）；Story 状态更新为 `in-progress`。
- 2026-02-12: 完成 Round 7 Review Follow-ups（4/4）；修复 tenant 失败登录副作用写入、补齐 In-Memory tenant 域写入路径、扩展 `auth_sessions` schema preflight，并增强 MySQL 持久化 `tenant_permission_context` 值级断言，状态更新为 `review`。
- 2026-02-12: 完成 Round 8 代码审查，新增 2 条 Review Follow-ups（0 High / 2 Medium）；聚焦官方迁移链契约覆盖与 `auth_sessions` preflight 运行期列覆盖缺口，状态更新为 `in-progress`。
- 2026-02-12: 完成 Round 8 Review Follow-ups（2/2）；补齐官方迁移链（含 `0004`）+ 登录链路契约回归、扩展 `auth_sessions` 启动期 preflight 运行期必需列、修复 `0004` MySQL 兼容语法并新增迁移静态守护测试；`apps/api` 全量测试与 lint、`apps/web` 测试与 lint 通过，状态更新为 `review`。
- 2026-02-12: 完成 Round 9 代码审查；无新增 follow-ups，审查结论 `Approved`，Story 状态更新为 `done`。
