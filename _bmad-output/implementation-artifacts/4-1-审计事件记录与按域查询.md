# Story 4.1: 审计事件记录与按域查询

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 审计操作者,
I want 系统记录关键治理事件并支持按平台域/组织域查询,
so that 事故追责和排障分析有完整证据链。

## Acceptance Criteria

1. **Given** 认证、授权变更、负责人变更或关键配置变更发生  
   **When** 事件落库  
   **Then** 审计记录包含动作主体、对象、时间、结果与 before/after  
   **And** 记录可按 request_id 关联检索
2. **Given** 审计操作者按域和条件查询  
   **When** 执行查询请求  
   **Then** 系统返回对应域的事件列表  
   **And** 结果支持分页、筛选与时间范围过滤

## Tasks / Subtasks

- [x] 任务 1：建立审计事件持久化模型与迁移（AC: 1）
  - [x] 新增迁移 `apps/api/migrations/0018_audit_events.sql`（及对应 `.down.sql`），创建 `audit_events` 表与必要索引（`domain+occurred_at`、`request_id`、`tenant_id+occurred_at`）。
  - [x] 字段最小集覆盖：`event_id`、`domain`、`tenant_id`、`request_id`、`traceparent`、`event_type`、`actor_user_id`、`actor_session_id`、`target_type`、`target_id`、`result`、`before_state`、`after_state`、`metadata`、`occurred_at`。
  - [x] JSON 字段统一保存脱敏后的 before/after，禁止落明文密码、token、密钥等敏感内容。

- [x] 任务 2：落地写侧审计事件采集（AC: 1）
  - [x] 在现有高风险写链路接入统一审计写入（优先复用公共 helper，避免散落实现）：认证相关、权限/角色变更、负责人变更、组织状态关键变更。
  - [x] 事件必须包含“谁（actor）对什么（target）在何时（occurred_at）做了什么（event_type）结果如何（result）”。
  - [x] 事件需携带 `request_id`，并尽可能透传 `traceparent`（若缺失则显式置空，禁止伪造）。
  - [x] 对审计写入失败执行 fail-closed（关键写链路返回依赖不可用），避免“业务成功但审计缺失”。

- [x] 任务 3：实现按域查询接口与过滤器（AC: 2）
  - [x] 新增平台域查询接口（建议：`GET /platform/audit/events`），仅返回平台域及可选 tenant 过滤结果。
  - [x] 新增组织域查询接口（建议：`GET /tenant/audit/events`），强制绑定 `active_tenant_id`，禁止跨租户读取。
  - [x] 支持分页与筛选：`page`、`page_size`、`from`、`to`、`event_type`、`result`、`request_id`、`actor_user_id`、`target_type`、`target_id`。
  - [x] 统一返回结构：`{ domain, page, page_size, total, events, request_id }`，并按 `occurred_at DESC` 排序。

- [x] 任务 4：接入路由权限与分发链路（AC: 1, 2）
  - [x] 新增 `apps/api/src/modules/audit/audit.constants.js`、`apps/api/src/modules/audit/audit.routes.js`、`apps/api/src/modules/audit/audit.service.js`。
  - [x] 在 `apps/api/src/http-routes.js`、`apps/api/src/server.js`、`apps/api/src/route-permissions.js` 注册路由与 handler。
  - [x] 权限声明保持 fail-closed 并使用现有可支持权限码（建议：平台 `platform.member_admin.view`，组织 `tenant.member_admin.view`），避免引入未声明权限码导致预检失败。

- [x] 任务 5：补齐 OpenAPI 与错误契约（AC: 2）
  - [x] 更新 `apps/api/src/openapi.js`，新增审计查询路径、请求参数、响应 schema 与示例。
  - [x] 统一 Problem Details：参数非法 `AUTH-400-INVALID-PAYLOAD`、无权限 `AUTH-403-*`、依赖异常 `AUTH-503-AUDIT-DEPENDENCY-UNAVAILABLE`。
  - [x] 明确 `request_id` 在成功与失败响应中必返。

- [x] 任务 6：测试与门禁（AC: 1, 2）
  - [x] 新增 `apps/api/test/audit.api.test.js`（或等价测试文件）覆盖平台域/组织域查询、分页、时间范围、过滤组合、跨域访问拦截。
  - [x] 更新 `apps/api/test/route-permissions.test.js`，验证新受保护路由权限声明完整且 scope 正确。
  - [x] 更新 `apps/api/test/server.test.js`，验证 OpenAPI 路径暴露、schema、错误示例与 request_id 语义。
  - [x] 补充写侧回归（可在现有模块测试中断言审计落库结果），确保认证/授权/负责人变更链路产生可检索审计事件。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] `createPlatformRoleCatalogEntry` 在角色创建后提前 `return`，导致 `recordPersistentAuditEvent` 永远不执行，出现“业务成功但审计缺失”；已改为先写审计再返回。 [`apps/api/src/modules/auth/auth.service.js:4670`] [`apps/api/src/modules/auth/auth.service.js:4681`]
- [x] [AI-Review][MEDIUM] 关键写链路缺少 `traceparent` 透传，审计事件无法稳定关联跨链路追踪；已在 `server`→`http-routes`→`*.routes`→`*.service`→`auth.service` 全链路补齐透传与规范化。 [`apps/api/src/server.js:1467`] [`apps/api/src/http-routes.js:786`] [`apps/api/src/modules/platform/role.routes.js:79`] [`apps/api/src/modules/platform/org.service.js:821`] [`apps/api/src/modules/tenant/role.service.js:844`]
- [x] [AI-Review][MEDIUM] 写侧回归未覆盖“角色创建审计必须落库且保留 `request_id+traceparent`”，导致上游缺陷未被门禁拦截；已新增平台/组织角色创建审计断言用例。 [`apps/api/test/platform.role.api.test.js:132`] [`apps/api/test/tenant.role.api.test.js:144`]
- [x] [AI-Review][HIGH] `/auth/platform/role-facts/replace` 仅写入内存审计，不落持久审计事件，导致关键权限收敛链路缺少可检索证据；已补齐 `auth.platform_role_facts.updated` 持久化审计写入（含 before/after）。 [`apps/api/src/modules/auth/auth.service.js:3844`] [`apps/api/src/modules/auth/auth.service.js:3884`]
- [x] [AI-Review][HIGH] `changePassword` 直接以 `entry_domain=tenant` 写 tenant 审计时，在 `active_tenant_id` 为空场景会触发 `audit-tenant-id-missing`，导致改密误返回 503；已改为 tenant 无活跃组织时回退平台域审计。 [`apps/api/src/modules/auth/auth.service.js:3021`] [`apps/api/src/modules/auth/auth.service.js:3068`]
- [x] [AI-Review][MEDIUM] `/auth/change-password` 与 `/auth/platform/role-facts/replace` 链路缺少 `traceparent` 透传，导致认证/授权关键写操作与追踪链路断裂；已补齐 `server -> http-routes -> auth.routes -> auth.service` 透传。 [`apps/api/src/server.js:2365`] [`apps/api/src/http-routes.js:889`] [`apps/api/src/modules/auth/auth.routes.js:182`]
- [x] [AI-Review][HIGH] `POST /platform/users/status` 与 `PUT /tenant/members/:membership_id/roles` 在 `server` 分发层漏传 `traceparent`，导致下游 auth 写链路审计事件追踪字段变为 `null`；已在路由分发补齐参数并新增透传回归。 [`apps/api/src/server.js:2047`] [`apps/api/src/server.js:2343`] [`apps/api/test/platform.user.api.test.js:437`] [`apps/api/test/tenant.member.api.test.js:2112`]
- [x] [AI-Review][MEDIUM] `Dev Agent Record -> File List` 未登记 `apps/api/test/audit.service.test.js`，与 git 实际变更不一致；已补齐文件清单并完成回归复验。 [`_bmad-output/implementation-artifacts/4-1-审计事件记录与按域查询.md:222`]
- [x] [AI-Review][MEDIUM] `Dev Agent Record -> File List` 未登记 `apps/api/test/auth.store.mysql.test.js`，导致变更追踪缺口；已补齐文件清单并完成回归复验。 [`_bmad-output/implementation-artifacts/4-1-审计事件记录与按域查询.md:222`]
- [x] [AI-Review][LOW] `Dev Agent Record -> Debug Log References` 缺少本轮 CR 执行命令记录；已补充本轮审查回归命令。 [`_bmad-output/implementation-artifacts/4-1-审计事件记录与按域查询.md:195`]

## Dev Notes

### Developer Context（开发者必须先读）

- 当前代码库已在多个 service 内维护内存 `auditTrail` 与结构化日志，但缺少统一可查询的持久审计事件存储；本故事目标是补齐“可追溯 + 可检索”闭环。
- 现有路由权限体系为强预检（`route-permissions` + `authorizeRoute`），新增审计接口必须完整声明，不能绕开。
- Story 4.1 是 Epic 4 第一个故事，后续 4.2（链路追踪）与 4.3（配置治理）会复用本故事的审计数据模型，需优先保证模型稳定与扩展性。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR42`、`FR43`、`FR45`。
- 相关 NFR/门禁约束：
  - `NFR3`（查询分页性能稳定）
  - `NFR22`（关键 NFR 证据归档）
  - 发布阻断项需可追溯 `request_id` / `traceparent`（与 Epic 4 可观测要求一致）。
- 审计内容必须满足：
  - 事件主体（operator）可追踪；
  - 事件对象（resource）可定位；
  - 变更前后（before/after）可比对；
  - 结果状态（success/rejected/failed）可检索；
  - request 关联（`request_id`）可串联日志与错误响应。

### Architecture Compliance（架构对齐清单）

- 目录与边界：
  - 新能力放置于 `apps/api/src/modules/audit/*`；
  - 路由编排仍由 `server.js` + `http-routes.js` 驱动；
  - 错误输出统一复用 Problem Details，不在模块内定义第二套错误结构。
- 数据与事务：
  - MySQL 为审计事实源；
  - 关键写链路要么业务与审计同成败，要么失败回滚并返回依赖不可用。
- 安全与隔离：
  - tenant 查询必须由服务端 `active_tenant_id` 决定，不信任客户端租户输入。
  - 平台域与组织域审计查询需明确边界，禁止越域聚合泄漏。

### Library & Framework Requirements（库与框架要求）

- 当前工程版本：
  - Node: `>=24.0.0`
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新稳定核验（2026-02-20）：
  - Node LTS: `v24.13.1 (Krypton)`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
- 本故事以功能交付为先，不强制升级依赖；若升级仅允许 patch 级并需跑全量 API 测试回归。

### File Structure Requirements（建议变更落点）

- 新增模块：
  - `apps/api/src/modules/audit/audit.constants.js`
  - `apps/api/src/modules/audit/audit.routes.js`
  - `apps/api/src/modules/audit/audit.service.js`
- 路由与权限接线：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
- 持久层能力：
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`（mock/backends 对齐）
- 契约与文档：
  - `apps/api/src/openapi.js`
- 迁移：
  - `apps/api/migrations/0018_audit_events.sql`
  - `apps/api/migrations/0018_audit_events.down.sql`
- 测试：
  - `apps/api/test/audit.api.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
  - 相关链路测试文件（`platform.org.api.test.js`、`platform.role.api.test.js`、`tenant.member.api.test.js` 等）按需补审计断言。

### Testing Requirements（必须覆盖）

- AC1 写侧覆盖：
  - 认证/授权/负责人变更链路至少各 1 条成功与 1 条失败样例审计事件；
  - before/after 字段形状与脱敏规则；
  - `request_id` 关联可检索。
- AC2 读侧覆盖：
  - 平台域与组织域接口权限校验；
  - 分页、时间范围、过滤条件组合；
  - tenant 越权查询拦截与 fail-closed 行为。
- 回归覆盖：
  - OpenAPI 路径与 schema；
  - route permission 预检；
  - 依赖异常映射为标准 Problem Details。

### Latest Tech Information（外部最新信息）

- Node.js LTS 线：`v24.13.1 (Krypton)`，与当前工程 `>=24` 约束兼容。
- MySQL 8.4 LTS 最新发布包含 `8.4.8`（8.4.x 线）。
- MySQL 锁函数 `GET_LOCK()/RELEASE_LOCK()` 仍为会话级语义，可作为并发治理补充手段，但本故事不建议引入额外分布式锁复杂度。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 当前 Story 以上下文文档为准：`epics.md`、`prd.md`、`architecture.md`、`ux-design-specification.md`。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review fixes completed: repaired platform role create/role-facts audit persistence, fixed tenant-entry password-change audit domain fallback, completed traceparent propagation for auth/platform/tenant mutation routes (including server dispatch), and added regression coverage for request_id/traceparent persistence.`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.1）
- `_bmad-output/planning-artifacts/prd.md`（FR42/FR43/FR45、审计与可追踪性、NFR）
- `_bmad-output/planning-artifacts/architecture.md`（模块边界、路由契约、可观测与审计约束）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（Journey 6 非 UI 闭环与可追踪要求）
- `https://nodejs.org/dist/index.json`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`
- `https://dev.mysql.com/doc/refman/8.4/en/locking-functions.html`
- `https://www.npmjs.com/package/@nestjs/core`
- `https://www.npmjs.com/package/typeorm`
- `https://www.npmjs.com/package/mysql2`
- `https://www.npmjs.com/package/ioredis`

## Senior Developer Review (AI)

- Reviewer: `老大`
- Date: `2026-02-21`
- Outcome: `Approve (after fixes)`
- Git vs Story Discrepancies: `3`（均已修复）
- Findings:
  - `[MEDIUM]` File List missing `apps/api/test/audit.service.test.js`（已修复）
  - `[MEDIUM]` File List missing `apps/api/test/auth.store.mysql.test.js`（已修复）
  - `[LOW]` Debug Log References missing current CR command set（已修复）
- Verification:
  - `AC1` 写侧审计字段与 `request_id/traceparent` 可检索链路维持通过
  - `AC2` 平台域/组织域查询、分页筛选、租户边界与 fail-closed 行为回归通过
  - 审计相关回归与扩展回归均通过，无剩余 HIGH/MEDIUM 阻断项

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex

### Debug Log References

- `node --test apps/api/test/audit.api.test.js apps/api/test/route-permissions.test.js apps/api/test/server.test.js`（pass）
- `node --test apps/api/test/auth.service.test.js`（pass）
- `node --test apps/api/test/auth.service.test.js apps/api/test/platform.org.api.test.js apps/api/test/platform.role.api.test.js apps/api/test/tenant.role.api.test.js apps/api/test/migrate-baseline.test.js`（pass）
- `node --test apps/api/test/auth.service.test.js apps/api/test/platform.org.api.test.js apps/api/test/platform.role.api.test.js apps/api/test/tenant.role.api.test.js apps/api/test/migrate-baseline.test.js apps/api/test/audit.api.test.js apps/api/test/route-permissions.test.js apps/api/test/server.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/tenant.role.api.test.js test/platform.org.api.test.js test/audit.api.test.js test/server.test.js test/route-permissions.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/auth.api.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/tenant.role.api.test.js test/platform.org.api.test.js test/audit.api.test.js test/server.test.js test/route-permissions.test.js test/auth.api.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/tenant.member.api.test.js test/auth.service.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/audit.api.test.js test/audit.service.test.js test/route-permissions.test.js test/server.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/auth.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/platform.role.api.test.js test/platform.user.api.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js test/migrate-baseline.test.js`（pass）
- `pnpm --dir apps/api lint`（pass）

### Completion Notes List

- 新增审计持久化迁移 `0018_audit_events`（含 down），并在基线迁移测试中纳入校验。
- 在 `auth.service` 的高风险写路径接入持久化审计落库（组织创建、组织状态、负责人接管、平台/组织角色权限变更），并透传 `request_id/traceparent`。
- 新增按域查询能力：`GET /platform/audit/events` 与 `GET /tenant/audit/events`，支持分页、过滤、时间范围，tenant 侧强制绑定 `active_tenant_id`。
- 已完成路由分发、权限声明、OpenAPI schema/示例同步，错误契约覆盖 `AUTH-400-INVALID-PAYLOAD` 与 `AUTH-503-AUDIT-DEPENDENCY-UNAVAILABLE`。
- 补齐/更新 API 与契约测试，覆盖审计查询、路由权限、OpenAPI 暴露、写侧回归；并通过目标回归与 lint。
- 修复平台角色创建链路审计漏写：`createPlatformRoleCatalogEntry` 改为“落审计成功后再返回”，避免 fail-open。
- 修复关键治理写链路的 `traceparent` 丢失，补齐从 HTTP 入站到审计落库的端到端透传。
- 新增平台/组织角色创建审计回归，显式断言 `request_id` 与 `traceparent` 可检索。
- 补齐平台角色事实替换链路持久审计（`auth.platform_role_facts.updated`），覆盖 before/after 角色事实与 session_version。
- 修复 tenant 入口无 `active_tenant_id` 时改密审计落库失败（503）的问题，改为平台域回退策略并保持 fail-closed。
- 将 `traceparent` 透传扩展到 `/auth/change-password` 与 `/auth/platform/role-facts/replace`，并新增对应回归测试。
- 补齐平台用户状态更新与组织成员角色绑定写链路的持久审计落库（含 before/after、`request_id`、`traceparent`），并修复 `server` 分发层两条路由 `traceparent` 丢参问题。

### File List

- `_bmad-output/implementation-artifacts/4-1-审计事件记录与按域查询.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0018_audit_events.sql`
- `apps/api/migrations/0018_audit_events.down.sql`
- `apps/api/src/modules/audit/audit.constants.js`
- `apps/api/src/modules/audit/audit.routes.js`
- `apps/api/src/modules/audit/audit.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/platform/org.routes.js`
- `apps/api/src/modules/platform/org.service.js`
- `apps/api/src/modules/platform/role.routes.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/platform/user.routes.js`
- `apps/api/src/modules/platform/user.service.js`
- `apps/api/src/modules/tenant/member.routes.js`
- `apps/api/src/modules/tenant/member.service.js`
- `apps/api/src/modules/tenant/role.routes.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/audit.api.test.js`
- `apps/api/test/audit.service.test.js`
- `apps/api/test/auth.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/platform.role.api.test.js`
- `apps/api/test/platform.user.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/tenant.member.api.test.js`
- `apps/api/test/tenant.role.api.test.js`

## Change Log

- 2026-02-20：完成 Story 4.1 实现，新增审计事件持久化模型、写侧采集、按域查询接口、路由权限接线与 OpenAPI 契约。
- 2026-02-20：补齐审计 API 与契约回归测试；修复 `replacePlatformRolePermissionGrants` 回归并通过目标测试集与 lint，状态更新为 `review`。
- 2026-02-20：完成 CR 修复：修复平台角色创建审计漏写、补齐关键写链路 `traceparent` 透传与角色创建审计回归，状态更新为 `done`。
- 2026-02-20：继续 CR 修复：补齐 `platform role-facts replace` 持久审计、修复 tenant 无活跃组织改密 503、扩展 auth 关键写链路 `traceparent` 透传并补充回归。
- 2026-02-20：继续 CR 修复：补齐平台用户状态更新与组织成员角色绑定写链路持久审计，并修复 `server` 分发层两条路由 `traceparent` 丢参，相关 API/服务回归通过。
- 2026-02-21：执行自动 CR（Story 4.1）并完成文档一致性修复：补齐 `File List` 漏登记测试文件、补充本轮 `Debug Log References`、新增 `Senior Developer Review (AI)` 审查记录；审计与扩展回归通过，状态保持 `done`。
