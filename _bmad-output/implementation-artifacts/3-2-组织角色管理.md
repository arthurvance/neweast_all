# Story 3.2: 组织角色管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 组织负责人或组织管理员,  
I want 创建和维护组织角色,  
so that 组织内权限模型能贴合业务分工。

## Acceptance Criteria

1. **Given** 组织管理员提交角色创建信息  
   **When** 校验通过  
   **Then** 系统创建组织角色  
   **And** 角色可用于后续授权分配
2. **Given** 组织管理员编辑或删除普通组织角色  
   **When** 请求符合约束  
   **Then** 系统允许操作  
   **And** 变更记录进入审计
3. **Given** 角色处于禁用或删除条件不满足  
   **When** 请求不合法  
   **Then** 系统拒绝操作  
   **And** 返回标准错误信息

## Tasks / Subtasks

- [x] 任务 1：交付组织角色目录治理 API（AC: 1, 2）
  - [x] 新增 tenant 角色治理路由（建议：`GET /tenant/roles`、`POST /tenant/roles`、`PATCH /tenant/roles/:role_id`、`DELETE /tenant/roles/:role_id`），并保持 `Problem Details`、鉴权、幂等语义一致。
  - [x] 角色模型至少包含：`role_id`、`tenant_id`、`code`、`name`、`status`、`is_system`、`created_at`、`updated_at`（外部字段统一 `snake_case`）。
  - [x] 角色编码唯一性必须限定在“同一 tenant 内”并做大小写归一化，避免跨组织串扰。
  - [x] 所有 tenant 写接口仅信任服务端会话 `active_tenant_id`，禁止从请求体/查询参数采信租户上下文。

- [x] 任务 2：落实“受保护系统角色不可编辑/删除”约束（AC: 2, 3）
  - [x] 明确 tenant 域受保护角色清单（至少覆盖负责人治理所需内置角色），通过常量集中维护，避免散落硬编码。
  - [x] 对受保护角色执行编辑/删除时统一 fail-closed，返回稳定错误码与 `retryable=false`。
  - [x] 明确边界：受保护角色“定义不可变更”，但后续故事中的授权分配能力应允许按策略继续使用。
  - [x] 审计事件至少覆盖：角色创建成功、编辑成功、删除成功、受保护角色拒绝、依赖不可用拒绝。

- [x] 任务 3：实现删除/状态变更前置校验与组织域一致性（AC: 2, 3）
  - [x] 删除前校验角色状态与约束条件（如：受保护角色、非法状态流转、已软删除、未来绑定约束）。
  - [x] 对“不满足删除条件”统一返回可回归的冲突/校验失败语义，避免 500 漂移。
  - [x] 角色状态变化后确保组织域权限判定可即时反映（对齐 FR29/FR30/FR50/FR75）。
  - [x] 为 Story 3.3 的角色分配与权限树能力预留稳定角色标识和查询入口，避免后续返工。

- [x] 任务 4：对齐现有模块边界与复用策略（AC: 1, 2, 3）
  - [x] 新增 `modules/tenant/role.*`，沿用 `platform/role.*` 与 `tenant/member.*` 的 handler/service 组织模式。
  - [x] 复用 `auth.service`/`auth.store` 现有角色目录能力时，严格传递并校验 `scope='tenant'`，不得污染 `platform` 数据路径。
  - [x] 若复用现有角色目录表结构，必须补齐 tenant 级隔离字段与唯一性约束；若新建 tenant 角色表，需保证与现有快照/审计能力一致接入。
  - [x] 保持 MySQL 与 memory store 语义一致，并新增回归覆盖防止实现漂移。

- [x] 任务 5：契约、门禁与回归矩阵（AC: 1-3）
  - [x] OpenAPI 补齐 tenant 角色治理接口请求/响应/错误示例（400/401/403/404/409/413/503），并声明 `retryable` 语义。
  - [x] `route-permissions` 显式声明所有新增受保护接口权限码与 `scope=tenant`，确保 `check:route-permissions` 可阻断漏声明。
  - [x] 幂等回归：同键同载荷重放一致；同键异载荷冲突；仅 `retryable=true` 的冲突允许“不缓存失败”。
  - [x] 安全回归：跨租户上下文伪造、非规范路径、编码参数、畸形输入均应 fail-closed。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 已修复 tenant 角色目录映射的 fail-open：下游缺失 `status` 或 `is_system` 不再默认放行，统一 fail-closed 返回稳定 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 OpenAPI 契约与实现不一致：`PATCH /tenant/roles/{role_id}` 的请求体新增 `minProperties: 1`，与服务端“至少一个可更新字段”校验对齐。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][MEDIUM] 已修复回滚迁移脆弱点：`0013` down 迁移在恢复全局唯一索引前先清理 tenant scoped 重码数据，并补齐回归断言，避免回滚失败。`apps/api/migrations/0013_platform_role_catalog_tenant_isolation.down.sql`, `apps/api/test/migrate-baseline.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 系统角色保护缺口：`PATCH` 现在会先读取目标角色并对 `is_system=true` 统一拒绝，避免“非内置白名单但系统角色”被编辑。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 tenant 角色更新结果完整性缺口：`PATCH` 现在校验下游返回记录必须与请求 `role_id + tenant_id` 一致，不一致时 fail-closed 返回 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 tenant 角色删除后置条件缺口：`DELETE` 现在校验返回记录必须匹配目标角色且状态为 `disabled`，否则 fail-closed 返回 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 受保护角色创建缺口：`POST /tenant/roles` 现在会拒绝保留系统角色 `role_id`（如 `tenant_owner`），避免创建阶段绕过“系统角色定义不可变更”约束。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 tenant 角色创建返回 fail-open：下游创建结果缺失 `created_at` / `updated_at` 时不再放行，统一 fail-closed 返回稳定 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][LOW] 已修复 OpenAPI 删除响应契约漂移：`DeleteTenantRoleResponse.status` 收敛为实现真实语义 `['disabled']`。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 `role_id` 冲突回归：新增同租户重复 `role_id` 创建断言，稳定校验 `TROLE-409-ROLE-ID-CONFLICT`，防止 memory/mysql 语义漂移。`apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐跨租户变更隔离回归：tenant A 对 tenant B 角色执行 `PATCH/DELETE` 必须 `404`，防止 `role_id` 猜测导致越权变更。`apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][LOW] 已补齐伪造系统标记入参回归：`POST /tenant/roles` 携带 `is_system=true` 稳定拒绝 `TROLE-400-INVALID-PAYLOAD`。`apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已收紧 tenant 角色创建入参：`POST /tenant/roles` 现在对 `is_system` 字段一律 fail-closed（含 `false`），避免客户端可写系统字段导致策略歧义。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 OpenAPI `code` 字段约束漂移：`TenantRoleCatalogItem/CreateTenantRoleRequest/UpdateTenantRoleRequest` 统一禁止控制字符并与服务端校验一致。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][MEDIUM] 已补齐跨租户同 `role_id` 冲突回归：锁定共享角色目录键约束，防止后续实现漂移引入不兼容行为。`apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复预授权上下文异常误降级：`active_tenant_id` 非法且路由已预授权时，不再回落空 token 二次鉴权导致 `401`，统一返回 `AUTH-403-NO-DOMAIN`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 tenant 角色目录映射下游字段完整性缺口：下游 `code/name` 含控制字符时统一 fail-closed 返回稳定 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 tenant 角色更新幂等缓存策略：`PATCH /tenant/roles/:role_id` 对 `retryable=true` 的 `409` 不再缓存重放结果。`apps/api/src/server.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][LOW] 已补齐 `createRouteHandlers` 对 `tenantRoleService` 的 authService 复用回归，防止后续重构破坏默认共享鉴权依赖。`apps/api/test/server.test.js`
- [x] [AI-Review][LOW] 已补齐 `createRouteHandlers` 对“注入 `authService` 与 `tenantRoleService` 内部 authService 不一致”场景的 fail-fast 回归，防止运行期鉴权实例漂移。`apps/api/test/server.test.js`
- [x] [AI-Review][LOW] 已补齐 `tenantMemberService` 与 `tenantRoleService` 双服务 authService 不一致场景的 fail-fast 回归，防止 mixed authService 组合被静默放行。`apps/api/test/server.test.js`
- [x] [AI-Review][HIGH] 已修复 preauthorized 场景下 `POST /tenant/roles` 的操作者标识透传缺口：`user_id/session_id='unknown'` 不再被接受，统一返回 `AUTH-403-FORBIDDEN`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 preauthorized 场景下 `PATCH /tenant/roles/:role_id` 的操作者标识透传缺口：`user_id/session_id='unknown'` 不再被接受，统一返回 `AUTH-403-FORBIDDEN`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 preauthorized 场景下 `DELETE /tenant/roles/:role_id` 的操作者标识透传缺口：`user_id/session_id='unknown'` 不再被接受，统一返回 `AUTH-403-FORBIDDEN`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 角色创建后置校验缺口：`POST /tenant/roles` 在下游回传 `is_system=true` 时不再放行，统一 fail-closed 返回 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 角色更新后置校验缺口：`PATCH /tenant/roles/:role_id` 在下游回传 `is_system=true` 时不再放行，统一 fail-closed 返回 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 角色删除后置校验缺口：`DELETE /tenant/roles/:role_id` 在下游回传 `is_system=true` 时不再放行，统一 fail-closed 返回 `503`。`apps/api/src/modules/tenant/role.service.js`, `apps/api/test/tenant.role.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 Platform Role OpenAPI `code` 字段约束过宽：`PlatformRoleCatalogItem/CreatePlatformRoleRequest/UpdatePlatformRoleRequest` 统一禁止控制字符并与服务端校验一致。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `UpdatePlatformRoleRequest` 契约缺口：补齐 `minProperties: 1`，与服务端“至少一个可更新字段”校验一致，避免空对象误导客户端。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][LOW] 已修复 `DeletePlatformRoleResponse.status` 枚举漂移：收敛为实现真实语义 `['disabled']`。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`

## Dev Notes

### Developer Context（开发者必须先读）

- 当前仓库已完成 Story 3.1（组织成员治理），`modules/tenant/member.*` 已建立完整的 tenant 路由/鉴权/幂等/审计/契约模式。
- Epic 3 的 Story 3.2 是 Story 3.3（组织权限树与成员角色分配）的前置能力，必须先稳定“组织角色目录”与“受保护约束”。
- 现有平台角色能力在 `modules/platform/role.*`，可复用其工程结构，但不能直接复用平台域语义到 tenant 域。
- `platform_role_catalog` 当前虽含 `scope` 字段，但历史实现更偏平台场景；组织角色若要复用该表，必须补齐 tenant 级隔离与唯一性约束，避免跨组织污染。

### Technical Requirements（实现硬约束）

- 双域边界：tenant 角色治理仅影响 tenant 域，不得影响 platform 域访问判定（FR26/FR70）。
- 失败语义：统一 `application/problem+json` + 稳定错误码 + `retryable`（适用时）。
- 受保护约束：受保护系统角色在 tenant 域仅允许分配，不允许编辑/删除定义本身（FR21 扩展约束）。
- 一致性：角色禁用后必须从组织域权限计算中排除并即时生效（FR29/FR30/FR50/FR75）。
- 幂等语义：关键写接口支持 `Idempotency-Key`，同键同载荷重放一致、同键异载荷冲突。
- 安全策略：所有 tenant 写接口仅信任服务端 `active_tenant_id`，拒绝客户端伪造租户上下文（FR51/FR70）。

### Architecture Compliance（架构对齐清单）

- 模块边界：新增 `modules/tenant/role.constants.js`、`modules/tenant/role.routes.js`、`modules/tenant/role.service.js`，与 `tenant/member.*` 同级。
- 服务边界：复用 `auth.service` 的角色目录能力时，必须显式 `scope='tenant'`，禁止绕过 service 层直连 store 私有实现。
- 路由边界：新增接口必须同步更新 `http-routes.js`、`server.js`、`route-permissions.js`、`openapi.js`。
- 数据边界：角色目录必须具备 tenant 级唯一性与隔离能力；不可仅靠全局 role_id/code 防止串租户。
- 工程边界：MySQL/memory 双实现语义一致，新增回归覆盖 fail-open 风险。

### Library & Framework Requirements（库与框架要求）

- 仓库当前 API 依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-19 官方源核验：
  - Node.js Latest LTS：`v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - Redis OSS：`8.6.0`
  - MySQL 8.4 Release Notes 最新可见补丁：`8.4.8`
- 本故事策略：不做依赖升级，优先在当前锁定版本交付 tenant 角色治理能力与回归闭环。

### File Structure Requirements（建议变更落点）

- 建议新增：
  - `apps/api/src/modules/tenant/role.constants.js`
  - `apps/api/src/modules/tenant/role.routes.js`
  - `apps/api/src/modules/tenant/role.service.js`
- 建议修改：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 建议迁移（按实现方案二选一或组合）：
  - 方案 A（复用现有角色目录）：新增迁移补齐 tenant 级隔离字段与唯一索引（如 `tenant_id + scope + code_normalized`）。
  - 方案 B（独立 tenant 角色目录）：新增 tenant 角色目录与约束迁移，并保留与现有权限快照链路的对接点。
- 建议新增/修改测试：
  - `apps/api/test/tenant.role.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（测试要求）

- AC1（创建角色）：
  - 同租户创建普通角色成功。
  - 同租户角色编码冲突返回稳定 409。
  - 跨租户同编码可并存（若需求允许），不得误判冲突。
- AC2（编辑/删除普通角色）：
  - 普通角色编辑成功，审计记录完整。
  - 普通角色删除成功（或软删除成功），返回语义稳定。
- AC3（非法条件拒绝）：
  - 受保护角色编辑/删除被拒绝。
  - 不满足删除条件（非法状态/不存在/约束未满足）被拒绝且错误码稳定。
- 安全与一致性回归：
  - 非法 path、损坏 URL 编码、控制字符、空白字符输入均 fail-closed。
  - tenant 域鉴权仅基于服务端上下文，跨租户伪造请求被拒绝。
  - OpenAPI、路由声明、实现行为三方一致。

### Previous Story Intelligence（来自 Story 3.1）

- 已形成稳定模式：`tenant/member` 采用 constants + routes + service 分层，且强依赖 `route-permissions` 与 `authorizeRoute`。
- 已验证的关键实践：
  - 对下游返回内容做“字段完整性 + 租户一致性”双重校验，异常统一 fail-closed。
  - 非规范参数（重复 query、控制字符、损坏编码）必须在入口阻断。
  - 幂等语义要区分 retryable 与 non-retryable 冲突，避免缓存策略漂移。
- 与本故事直接相关：
  - Story 3.1 已预留“成员关系主键（membership_id）”以支撑后续角色绑定；Story 3.2 应继续沿该主键思路设计角色关联。

### Git Intelligence Summary（最近 5 次提交模式）

- 提交热点集中在：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/modules/platform/*` / `apps/api/src/modules/tenant/*`
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可复用结论：
  - 采用“小步增量 + 强回归”策略；每次能力变更同时更新实现、契约、权限声明与测试。
  - 避免一次性大重构，优先复用现有模块模式并补足 tenant 专属约束。

### Latest Tech Information（2026-02-19）

- 版本现状与建议：
  - Node LTS 建议保持 `v24` 线（官方 LTS：`v24.13.1`）。
  - `@nestjs/core` 仅存在小版本补丁差异（`11.1.13` -> `11.1.14`），本故事不做升级。
  - `typeorm` 当前已对齐最新 `0.3.28`。
  - `mysql2`、`ioredis` 存在补丁可跟进（`3.17.2`、`5.9.3`），建议独立维护任务升级，不与本故事耦合。
  - MySQL 与 Redis 均有新补丁版本（8.4.8 / 8.6.0），本故事关注语义正确性与回归稳定性，暂不做基础设施升级。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`CR 3-2 九次复检已闭环：修复 Platform Role OpenAPI 契约漂移（code 控制字符约束、PATCH 最小字段约束、DELETE 状态枚举）；并通过 apps/api server.test（65/65）与 apps/api test（720/720）。`

### Project Structure Notes

- 现有 API 代码已形成 `platform/*` 与 `tenant/member.*` 的对称模块模式，Story 3.2 建议新增 `tenant/role.*` 以保持结构一致。
- 角色目录当前能力与命名偏平台化（`platform_role_catalog`），在 tenant 场景必须补齐租户隔离约束，防止跨组织角色串扰。
- Story 3.3 将继续交付权限树与成员角色分配，Story 3.2 不应提前耦合完整授权树，但必须提供稳定角色主键与治理边界。

### References

- Epic 3 / Story 3.2（用户故事与 AC）  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 3.2: 组织角色管理]
- FR21、FR26、FR29、FR30、FR50、FR51、FR70、FR72、FR75（组织角色与鉴权边界）  
  [Source: _bmad-output/planning-artifacts/prd.md#组织治理能力（Org Governance）]
- 数据模型与级联约束（`roles`、`membership_roles`、`role_permissions`）  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Database Entity Field Catalog (Detailed)]
- 架构边界与门禁要求（模块边界、权限声明、Problem Details、幂等）  
  [Source: _bmad-output/planning-artifacts/architecture.md#Service Boundaries]
- UX 约束（列表主页面 + Modal/Drawer + message + loading 防重）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Journey Patterns]
- 前序故事经验（tenant 成员治理、fail-closed、幂等与契约收敛）  
  [Source: _bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md]
- 最新版本信息（官方源）  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]  
  [Source: https://api.github.com/repos/redis/redis/releases/latest]  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/route-permissions.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/route-permissions.test.js test/server.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js test/route-permissions.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js test/server.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 已交付 tenant 角色治理模块：`role.constants`、`role.routes`、`role.service`，并接入主路由调度。
- 已补齐 tenant 路由声明、幂等接入、OpenAPI 契约与 schema（含 `tenant_id` 字段与 role_id pattern）。
- 已扩展 auth 角色目录能力支持 `scope=tenant + tenantId`，并新增 `findPlatformRoleCatalogEntryByRoleId` 服务能力。
- 已对齐 memory/mysql store 的 tenant 级 code 唯一性（同 tenant 内大小写归一，跨 tenant 可并存）。
- 已新增迁移 `0013_platform_role_catalog_tenant_isolation`，补齐 `platform_role_catalog.tenant_id` 与 scoped unique key。
- 已修复 MySQL express 集成测试基线迁移链，确保执行到 0013。
- 已修复 tenant 角色目录映射对下游畸形记录的 fail-open（缺失 `status` / `is_system` 时统一 fail-closed）。
- 已修复 `PATCH /tenant/roles/{role_id}` OpenAPI 请求体契约漂移（新增 `minProperties: 1`）。
- 已修复 `0013` down 迁移在 tenant scoped 重码场景的回滚失败风险，并补齐基线回归断言。
- 已修复 tenant 系统角色 PATCH 保护缺口：非白名单但 `is_system=true` 的角色定义同样 fail-closed 拒绝编辑。
- 已修复 tenant 角色 PATCH 下游返回结果完整性缺口：强制校验返回记录与请求目标 `role_id + tenant_id` 一致。
- 已修复 tenant 角色 DELETE 下游返回结果完整性缺口：强制校验返回记录为目标角色且删除后状态为 `disabled`。
- 已修复 tenant 受保护角色创建绕过缺口：创建时拒绝保留系统角色 `role_id`（如 `tenant_owner`）。
- 已修复 tenant 角色创建返回 fail-open：下游返回缺失 `created_at` / `updated_at` 时统一 fail-closed 拒绝。
- 已修复 OpenAPI `DeleteTenantRoleResponse.status` 契约漂移：删除响应状态枚举收敛为 `disabled`。
- 已补齐 tenant 角色关键语义回归：同租户重复 `role_id` 冲突、跨租户 `PATCH/DELETE` 隔离、`is_system=true` 伪造入参拒绝。
- 已收紧 tenant 角色创建入参：`is_system` 字段（含 `false`）不再接受，统一按非法载荷拒绝。
- 已修复 Tenant Role OpenAPI `code` 字段约束漂移：契约与服务端一致禁止控制字符。
- 已补齐跨租户同 `role_id` 冲突回归，锁定共享角色目录键约束行为。
- 已修复预授权上下文异常误降级：`active_tenant_id` 非法且已预授权时，不再回落空 token 二次鉴权导致 401，统一返回 `AUTH-403-NO-DOMAIN`。
- 已修复 tenant 角色目录下游字段完整性缺口：`code/name` 含控制字符时统一 fail-closed 返回 `503`。
- 已修复 tenant 角色更新幂等缓存策略：`PATCH` 对 `retryable=true` 的 `409` 不再缓存，避免错误重放命中。
- 已补齐 `createRouteHandlers` 的 tenantRole 依赖注入回归：覆盖 authService 复用、注入错配 fail-fast、tenantMember/tenantRole 双服务错配 fail-fast。
- 已修复 preauthorized unknown 操作者标识透传缺口：`POST/PATCH/DELETE /tenant/roles` 在预授权场景下强制校验 `operator_user_id/operator_session_id`，非法值统一 `403` fail-closed。
- 已修复 tenant 角色创建/更新/删除后置校验缺口：下游回传 `is_system=true` 时统一 fail-closed 返回 `503`，避免系统角色定义被异常回包放行。
- 已修复 Platform Role OpenAPI `code` 字段契约过宽：`PlatformRoleCatalogItem/CreatePlatformRoleRequest/UpdatePlatformRoleRequest` 统一禁止控制字符并与服务端校验一致。
- 已修复 `UpdatePlatformRoleRequest` 契约缺口：补齐 `minProperties: 1`，与服务端“至少一个可更新字段”校验一致。
- 已修复 `DeletePlatformRoleResponse.status` 契约漂移：收敛为实现真实语义 `disabled`。
- 门禁通过：`check:route-permissions`、`lint`、`test`。

### File List

- `_bmad-output/implementation-artifacts/3-2-组织角色管理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/tenant/role.constants.js`
- `apps/api/src/modules/tenant/role.routes.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/migrations/0013_platform_role_catalog_tenant_isolation.sql`
- `apps/api/migrations/0013_platform_role_catalog_tenant_isolation.down.sql`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/tenant.role.api.test.js`

### Change Log

- 2026-02-19：完成 Story 3.2 实现与回归收口（tenant 角色治理 API、tenant 隔离唯一性、受保护角色约束、契约与门禁），状态更新为 `review`。
- 2026-02-19：执行 Code Review（CR 3-2），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复角色目录映射 fail-open、补齐 `PATCH /tenant/roles/{role_id}` `minProperties` 契约、加固 `0013` down 迁移回滚可靠性；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（693/693），状态更新为 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）复检，新增发现 3 项（1 HIGH / 2 MEDIUM）：修复系统角色 PATCH 保护缺口、PATCH/DELETE 返回目标一致性缺口与 DELETE 后置状态校验缺口；补齐回归并通过 `apps/api test`（696/696），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）二次复检，新增发现 3 项（1 HIGH / 1 MEDIUM / 1 LOW）：修复受保护角色创建绕过、创建返回缺失时间戳 fail-open 与 DELETE 响应契约漂移；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（678/678），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）三次复检，新增发现 3 项（2 MEDIUM / 1 LOW）：补齐 `role_id` 冲突、跨租户变更隔离与 `is_system` 伪造入参拒绝回归；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（664/664），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）四次复检，新增发现 3 项（1 HIGH / 2 MEDIUM）：收紧 `is_system` 可写入参、修复 Tenant Role OpenAPI `code` 控制字符约束漂移，并补齐跨租户同 `role_id` 冲突回归；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（706/706），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）五次复检，新增发现 3 项（1 HIGH / 2 MEDIUM）：修复预授权异常误降级 401、修复下游 `code/name` 控制字符 fail-open，并修复 `PATCH /tenant/roles/:role_id` 对 `retryable=true` 的 409 幂等缓存策略；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（711/711），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）六次复检，新增发现 3 项（3 LOW）：补齐 `createRouteHandlers` 的 tenantRole authService 对齐回归（复用、注入错配、双服务错配 fail-fast）；补齐回归并通过 `pnpm --dir apps/api exec node --test test/server.test.js`（65/65），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）七次复检，新增发现 3 项（3 HIGH）：修复 preauthorized 上下文 `user_id/session_id='unknown'` 仍可执行 `POST/PATCH/DELETE /tenant/roles` 的鉴权完整性缺口；补齐回归并通过 `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`（32/32）与 `pnpm --dir apps/api test`（717/717），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）八次复检，新增发现 3 项（3 HIGH）：修复 tenant 角色创建/更新/删除在下游回传 `is_system=true` 时的后置校验缺口，统一 fail-closed `503`；补齐回归并通过 `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`（35/35）与 `pnpm --dir apps/api test`（720/720），状态保持 `done`。
- 2026-02-19：执行 Code Review（CR 3-2）九次复检，新增发现 3 项（2 MEDIUM / 1 LOW）：修复 Platform Role OpenAPI `code` 控制字符约束漂移、补齐 `UpdatePlatformRoleRequest.minProperties` 契约，并收敛 `DeletePlatformRoleResponse.status` 枚举；补齐回归并通过 `pnpm --dir apps/api exec node --test test/server.test.js`（65/65）与 `pnpm --dir apps/api test`（720/720），状态保持 `done`。

### Senior Developer Review (AI)

- Reviewer: 老大（AI）
- Date: 2026-02-19
- Outcome: Approved
- Summary: 本轮 CR 3-2（九次复检）发现 3 项问题（MEDIUM 2 / LOW 1，均为 Platform Role OpenAPI 契约漂移：`code` 控制字符约束、`PATCH` 最小字段约束、`DELETE` 状态枚举）已全部修复并补齐回归；AC1-AC3 与任务声明一致，Git 变更与 Story File List 一致，故事可关闭。
- Verification:
  - `pnpm --dir apps/api exec node --test test/server.test.js`：通过（65/65）
  - `pnpm --dir apps/api test`：通过（720/720）
