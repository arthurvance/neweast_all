# Story 3.5: 负责人变更后的接管保障

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 新任组织负责人,  
I want 在负责人变更后立即具备最小治理权限并完成接管,  
so that 组织治理不会因交接中断。

## Acceptance Criteria

1. **Given** 负责人变更请求通过前置状态校验  
   **When** 变更事务提交成功  
   **Then** 系统完成负责人身份切换  
   **And** 自动补齐必要成员关系与角色关系
2. **Given** 新负责人完成切换  
   **When** 访问组织治理能力  
   **Then** 新负责人具备最小治理权限并可立即执行管理动作  
   **And** 旧负责人权限不自动移除（按策略保留）
3. **Given** 组织状态或新负责人状态不满足前置条件  
   **When** 发起变更  
   **Then** 系统拒绝变更  
   **And** 返回可识别错误码与原因

## Tasks / Subtasks

- [x] 任务 1：将 `owner-transfer` 从“仅预检受理”升级为“事务内完成接管闭环”（AC: 1, 2, 3）
  - [x] 继续使用 `POST /platform/orgs/owner-transfer` 与现有七字段响应契约，不新增平行入口。
  - [x] `platformOrgService.ownerTransfer` 在通过校验后，必须调用 auth 域“执行接管”能力，不再停留在 `submitted for downstream orchestration`。
  - [x] 成功场景保持 `result_status='accepted'` 与 `error_code='ORG-200-OWNER-TRANSFER-ACCEPTED'`（兼容既有消费方），但语义更新为“已完成事务提交与接管补齐”。
  - [x] 审计事件补齐“接管提交成功/事务失败回滚”语义，不弱化既有 `initiated/conflict/rejected` 事件。

- [x] 任务 2：在 `auth.service` 新增负责人接管执行用例（AC: 1, 2, 3）
  - [x] 新增显式 service 能力（建议：`executeOwnerTransferTakeover`），输入至少包含 `requestId/orgId/newOwnerPhone/operatorUserId/operatorSessionId/reason`。
  - [x] 先复用既有 `validateOwnerTransferRequest`，再在同一业务链路执行 owner 切换，避免双轨校验漂移。
  - [x] 保持 fail-closed：任一步骤返回畸形结构或关键字段缺失，统一映射稳定 `AuthProblemError` 并中止。

- [x] 任务 3：补齐“成员关系 + 角色关系”自动化收敛（AC: 1, 2）
  - [x] 负责人切换成功后，确保新负责人在目标组织存在可用成员关系（`auth_user_tenants`）：不存在则创建、`left/disabled` 则按策略恢复为可用。
  - [x] 负责人切换成功后，确保新负责人具备至少一条有效组织角色绑定（`auth_tenant_membership_roles`），并通过既有快照同步链路落到 `auth_user_tenants` 权限事实。
  - [x] 最小治理权限至少覆盖：`tenant.member_admin.view`、`tenant.member_admin.operate`。
  - [x] 如受保护角色定义缺失（如 `tenant_owner`），需在后端内部补齐可用定义与最小权限授予，禁止依赖人工先建。
  - [x] 明确“旧负责人权限不自动移除”：不得在本事务自动解绑旧负责人的成员关系、角色绑定或权限快照。

- [x] 任务 4：存储层实现事务原子化与并发安全（AC: 1, 3）
  - [x] 在 `auth.store.mysql` 新增负责人接管原子写能力：`orgs.owner_user_id` 变更、成员关系补齐、角色关系补齐、权限快照同步必须全成功/全回滚。
  - [x] MySQL 路径维持现有并发策略：结合 `GET_LOCK/RELEASE_LOCK` 与事务内行锁（`FOR UPDATE`）防止同组织双写。
  - [x] `auth.store.memory` 同步实现等价能力，保持本地测试与 MySQL 语义一致。
  - [x] 保留并复用现有死锁重试/fail-closed 处理，不引入新的“写后再失败”窗口。

- [x] 任务 5：契约与文档对齐（AC: 1, 2, 3）
  - [x] 更新 OpenAPI：`/platform/orgs/owner-transfer` 的 summary/description 由“entry + precheck only”改为“完成接管闭环”。
  - [x] 更新 200/409/503 示例，明确“成功即已提交事务”，并保持 `retryable` 语义与错误码映射稳定。
  - [x] 保持路由权限声明不回退：仍受 `platform.member_admin.operate` 保护。

- [x] 任务 6：回归矩阵（必须覆盖 AC 及关键风险）
  - [x] API 正向：负责人切换后读取组织 owner、成员关系、角色绑定、权限快照均已生效。
  - [x] AC2 正向：新负责人可立刻通过 tenant 域受保护能力校验；旧负责人不因本接口被自动移除权限。
  - [x] AC3 负向：组织禁用、新负责人禁用/不存在、同 owner、非法载荷、依赖畸形回包均返回可识别错误。
  - [x] 并发/幂等：同组织并发冲突仍返回 `ORG-409-OWNER-TRANSFER-CONFLICT`；同键同载荷重放一致；同键异载荷冲突稳定。
  - [x] 事务一致性：注入中途失败时验证 `orgs.owner_user_id`、成员关系、角色绑定均未部分落库。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复负责人接管角色固定 `role_id='tenant_owner'` 导致跨组织接管冲突；改为按 `org_id` 派生稳定且租户隔离的接管角色 ID（`apps/api/src/modules/auth/auth.service.js`）。
- [x] [AI-Review][HIGH] 修复 MySQL 接管链路对已存在 `tenant` 域访问为 disabled 的用户无法恢复为 active；改为复用 `ensureTenantDomainAccessForUserTx` 的 upsert 激活语义（`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][MEDIUM] 补齐防回归用例：覆盖跨组织连续接管不冲突、以及接管链路 tenant 域访问 upsert 行为（`apps/api/test/auth.service.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][MEDIUM] 修复接管链路对“已存在但语义错误”的接管角色定义缺少 `code` 校验；新增 `ERR_OWNER_TRANSFER_TAKEOVER_ROLE_INVALID` 防护与稳定错误映射（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.service.js`）。
- [x] [AI-Review][MEDIUM] 修复 `0017` 迁移仅检查 `role_id` 冲突、未显式检查同租户 `code_normalized='tenant_owner'` 冲突的问题；新增 tenant code collision guard（`apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql`、`apps/api/test/migrate-baseline.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 Story File List 与 git 实际改动不一致：补充迁移与基线测试变更记录（`_bmad-output/implementation-artifacts/3-5-负责人变更后的接管保障.md`）。
- [x] [AI-Review][MEDIUM] 修复 MySQL 接管角色插入遇到 duplicate 时未二次解析 `role_id` 的分支，避免将租户 `TENANT_OWNER` 编码冲突退化为通用 DB 异常；并对 memory 实现统一映射为 `ERR_OWNER_TRANSFER_TAKEOVER_ROLE_INVALID`（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/test/auth.store.mysql.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 `0017` 迁移复制旧 `tenant_owner` 授权码时未做白名单过滤的问题，避免历史未知权限码扩散到新接管角色并触发后续严格校验失败（`apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql`、`apps/api/test/migrate-baseline.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 `0017` 迁移对白名单授权码只做 `LOWER` 未做 `TRIM` 的兼容性问题，避免带空格历史授权码被误丢；迁移时统一写入 canonical 小写码（`apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql`、`apps/api/test/migrate-baseline.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 MySQL 接管链路在 `auth_user_tenants` 并发插入命中 duplicate 时缺少容错、导致可恢复竞态被误判失败；duplicate 分支改为重查成员后继续事务，并补充回归测试（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.store.mysql.test.js`）。

## Dev Notes

### Developer Context（开发者必须先读）

- Story 2.6 已交付 `owner-transfer` 入口、并发锁、前置校验和七字段契约，但当前成功路径仅到 `validateOwnerTransferRequest`，仍是“受理+预检”语义。
- 当前 `platformOrgService.ownerTransfer` 成功审计为 `org.owner_transfer.submitted`，且 OpenAPI 明确写了 `entry + precheck only`。
- `auth.service` 已有：`acquireOwnerTransferLock`、`releaseOwnerTransferLock`、`validateOwnerTransferRequest`；尚无“执行 owner 切换 + 自动接管补齐”的聚合用例。
- 组织成员/角色链路已成熟：`createTenantMembershipForUser`、`replaceTenantMemberRoleBindings`、`replaceTenantRolePermissionGrants`、权限快照同步与会话收敛已在 Story 3.1-3.4 反复加固。

### Technical Requirements（实现硬约束）

- 本故事直接覆盖：`FR25`、`FR35`、`FR65`、`FR76`。
- 保持关键写接口约束：`Idempotency-Key`、Problem Details、`error_code/request_id/retryable`。
- 变更必须“事务全成功/全回滚”，不得出现 owner 已切换但成员/角色未补齐的半成功状态。
- 新负责人最小治理权限必须可立即用于 tenant 域管理能力（至少 member_admin view/operate）。
- 旧负责人权限不自动移除是显式验收条件，禁止在该接口中做自动解绑清理。

### Architecture Compliance（架构对齐清单）

- 模块边界不变：
  - `modules/platform/org.service` 负责入口编排、错误映射、审计和契约输出。
  - `modules/auth/auth.service` 负责接管业务用例与校验聚合。
  - `modules/auth/auth.store.*` 负责事务与数据一致性。
- 必须维持 memory/mysql 双实现同语义。
- 必须维持 fail-closed：依赖层回包畸形、字段缺失、跨租户不一致均拒绝并返回稳定 503。
- 不在 `server.js` / `http-routes.js` 增加业务分支，保持分发层薄逻辑。

### Library & Framework Requirements（库与框架要求）

- 依赖基线（`apps/api/package.json`）：
  - `@nestjs/core` `11.1.13`
  - `typeorm` `^0.3.28`
  - `mysql2` `^3.17.0`
  - `ioredis` `5.9.2`
- 本故事不做依赖升级，优先在现有稳定版本上完成接管闭环。

### File Structure Requirements（建议变更落点）

- 平台组织编排：
  - `apps/api/src/modules/platform/org.service.js`
- 鉴权与领域服务：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约与路由门禁：
  - `apps/api/src/openapi.js`
  - `apps/api/src/server.js`（仅在幂等缓存策略或错误包装需要时）
  - `apps/api/src/route-permissions.js`（预计无需变更，但需回归）
- 测试：
  - `apps/api/test/platform.org.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/route-permissions.test.js`

### Testing Requirements（必须覆盖）

- AC1：预检通过后，owner 切换与成员/角色补齐在同一次请求中完成。
- AC2：新负责人最小治理权限即时生效；旧负责人权限保持不自动移除。
- AC3：组织状态或候选人状态非法时，拒绝并返回可识别错误码。
- 并发安全：同组织并发请求仅一个成功，其余冲突可识别且可安全重试。
- 幂等一致：同键同载荷重放一致，同键异载荷冲突稳定，retryable 409 缓存策略不回退。
- 回滚一致：任意中途失败不产生脏关系写入（owner/member/role/snapshot 任一不可部分提交）。

### Previous Story Intelligence（跨故事关键信息）

- 来自 Story 2.6：
  - 入口契约（七字段）和冲突语义已稳定，3.5 必须在此基础上“补能力，不破契约”。
  - 已有跨实例锁与冲突重试机制，避免重复造轮子。
- 来自 Story 3.3：
  - 成员角色绑定与权限快照同步已具备原子写 + fail-closed 基线，应直接复用。
- 来自 Story 3.4：
  - store/service 对下游回包字段完整性必须严格校验，不能 trim/默认值容忍。
- 来自 Story 2.1：
  - 高风险写链路必须维持“失败即回滚/补偿”的原子性策略。

### Git Intelligence Summary（最近 5 次提交模式）

- 最近提交：
  - `34c00dd feat(api): complete story 3-4 member profile maintenance hardening`
  - `95f8335 feat(auth): complete tenant role grants and membership role bindings`
  - `4061e3d feat(api): complete story 3.2 tenant role governance and review closure`
  - `4e6c145 feat(api): implement tenant member lifecycle and auth enhancements`
  - `c76ff2c feat(api): 完成 Story 2.6 平台侧负责人变更入口与回归`
- 模式结论：
  - 高频改动集中在 `platform/org`、`auth service/store`、`openapi`、`server` 与 `test/*`。
  - 成功交付模式是“先实现主链路，再做 fail-closed 加固，再补契约与回归”。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 当前故事上下文基线：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、已完成故事文档与当前代码实现。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed and all HIGH/MEDIUM findings resolved: takeover role ID tenant-scoped, MySQL tenant-domain access reactivation fixed, takeover role definition/duplicate-branch fail-closed validation added, migration collision guard plus canonical grant whitelist migration added, takeover membership duplicate-insert race tolerance fixed, and regression tests refreshed.`

### References

- 用户故事与验收条件：`_bmad-output/planning-artifacts/epics.md`（Story 3.5）
- FR 口径：`_bmad-output/planning-artifacts/prd.md`（FR25/FR35/FR65/FR76）
- 负责人变更规则（串行化、事务一致、旧负责人不自动移除）：`_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
- 架构边界与门禁：`_bmad-output/planning-artifacts/architecture.md`
- UX 冲突可恢复与失败语义：`_bmad-output/planning-artifacts/ux-design-specification.md`
- 上一边界故事（仅入口+预检）：`_bmad-output/implementation-artifacts/2-6-平台侧负责人变更入口.md`
- 近期 tenant 角色/成员链路经验：
  - `_bmad-output/implementation-artifacts/3-3-组织权限树与成员角色分配.md`
  - `_bmad-output/implementation-artifacts/3-4-组织成员资料维护.md`
- 现有实现落点：
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/platform.org.api.test.js`

## Senior Developer Review (AI)

### Outcome

- Changes Requested（本轮问题已全部修复并复测通过）

### Findings

- [HIGH] 接管角色使用固定 `role_id='tenant_owner'`，与 `platform_role_catalog.role_id` 全局主键语义冲突，导致跨组织二次接管失败（已修复）。
- [HIGH] MySQL 接管写链路未激活已存在但 disabled 的 `tenant` 域访问，可能导致新负责人无法立即进入组织域（已修复）。
- [MEDIUM] 缺少上述两类风险的回归测试，无法防止后续回归（已补齐）。
- [MEDIUM] 接管链路未验证“既有接管角色定义的 code 一致性”，存在角色定义被污染时被错误复用的风险（已修复）。
- [MEDIUM] `0017` 迁移缺少同租户 `code_normalized='tenant_owner'` 冲突显式守卫，异常数据下可能以通用重复键错误中断迁移（已修复）。
- [MEDIUM] Story 文件清单未覆盖迁移与基线测试新增改动，文档与 git 事实不一致（已修复）。
- [MEDIUM] MySQL 接管角色创建分支在 duplicate 后未二次解析目标 `role_id`，可能将租户编码冲突暴露为非稳定错误语义（已修复）。
- [MEDIUM] `0017` 迁移在迁移旧 `tenant_owner` 授权码时未过滤未知权限，可能把历史脏数据扩散到新接管角色并在后续严格校验下触发 fail-closed（已修复）。
- [MEDIUM] `0017` 迁移对白名单权限仅做 `LOWER` 未做 `TRIM`，带空格历史授权码会被误丢，导致迁移后权限收敛偏差（已修复）。
- [MEDIUM] MySQL 接管链路在新负责人成员关系并发写入命中 duplicate 时未做容错重查，可能将可恢复竞态误报为失败（已修复）。

### Validation

- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/auth.store.mysql.test.js test/auth.service.test.js`（380/380）
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js`（351/351）
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（103/103）
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`（248/248）
- `pnpm --dir apps/api test`（833/833）
- `pnpm --dir apps/api lint`（passed）

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`

### Completion Notes List

- 已实现 `auth.service.executeOwnerTransferTakeover`，复用预检并收敛 owner 切换执行链路，补齐 fail-closed 返回校验与错误映射。
- 已将 `platformOrgService.ownerTransfer` 从预检调用切换为执行接管调用，保持七字段响应契约不变并更新成功语义。
- 已在 `auth.store.mysql` 与 `auth.store.memory` 落地接管原子写（owner 切换、成员/角色/权限收敛、回滚与一致性保护）。
- 已更新 `/platform/orgs/owner-transfer` OpenAPI 文案到“完成接管闭环”语义。
- 代码审查修复：接管角色 ID 改为租户隔离派生值，消除跨组织 `role_id` 冲突导致的接管失败风险。
- 代码审查修复：MySQL 接管链路复用 tenant 域访问 upsert 激活逻辑，确保 disabled 记录可恢复为 active。
- 代码审查修复：接管写链路在 memory/mysql 双实现新增 takeover 角色 `code` 一致性校验，防止异常角色定义被错误复用。
- 代码审查修复：`0017` 迁移新增 tenant code collision guard，异常数据下 fail-closed 且错误语义清晰。
- 代码审查修复：MySQL 接管角色 insert duplicate 分支补齐二次 `role_id` 解析与 fail-closed 错误归一，避免租户编码冲突泄漏通用 DB 异常；memory 分支同步语义对齐。
- 代码审查修复：`0017` 迁移复制旧授权码时增加已知权限白名单过滤，避免历史未知权限码扩散到新接管角色。
- 代码审查修复：`0017` 迁移对旧授权码执行 `LOWER(TRIM(...))` 规范化，避免带空格历史授权码遗漏并统一迁移后编码形态。
- 代码审查修复：MySQL 接管链路在 `auth_user_tenants` 并发 duplicate 插入时改为容错重查并继续事务，避免将可恢复竞态误判为写失败。
- 新增防回归测试并通过：`380/380`（目标集合）、`833/833`（apps/api 全量）、`lint` 通过。

### File List

- `_bmad-output/implementation-artifacts/3-5-负责人变更后的接管保障.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.down.sql`
- `apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/platform/org.service.js`
- `apps/api/src/openapi.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/platform.org.api.test.js`
- `apps/api/test/server.test.js`

## Change Log

- 2026-02-20: 完成 Story 3.5（负责人变更后接管闭环），新增 auth 执行用例与 store 原子接管实现，更新平台入口调用与 OpenAPI 文案，补齐并通过回归测试。
- 2026-02-20: 完成 CR 复审闭环；修复跨组织接管 `role_id` 冲突与 tenant 域访问恢复缺陷，补齐回归测试，Story 状态更新为 `done`。
- 2026-02-20: 完成 CR 3-5 自动继续复审闭环；新增 takeover 角色 `code` 完整性校验、`0017` 迁移 tenant code collision guard、并补齐迁移基线测试与文档文件清单一致性。
- 2026-02-20: 继续 CR 3-5 复审并收敛 duplicate 分支语义；修复 MySQL 接管角色 duplicate 后缺少 `role_id` 二次解析问题，统一 memory/mysql 失败语义并补齐回归测试。
- 2026-02-20: 继续 CR 3-5 复审并收敛迁移数据兼容性；修复 `0017` 迁移未过滤未知权限码的问题，避免脏授权扩散至新接管角色并补齐基线断言。
- 2026-02-20: 继续 CR 3-5 复审并收敛迁移编码规范化；修复 `0017` 对旧授权码未 `TRIM` 导致的兼容性问题，统一使用 `LOWER(TRIM(permission_code))`。
