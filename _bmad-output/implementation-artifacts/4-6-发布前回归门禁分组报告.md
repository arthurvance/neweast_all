# Story 4.6: 发布前回归门禁分组报告

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 发布与运维负责人,  
I want 发布前自动输出关键能力回归结果并形成分组报告,  
so that 发布质量可验证且未通过能力可直接阻断上线。

## Acceptance Criteria

1. **Given** 发布流程进入门禁阶段  
   **When** 执行关键能力回归  
   **Then** 系统输出按能力分组的结果报告  
   **And** 未通过门禁则阻断发布
2. **Given** 发布门禁结果生成完成  
   **When** 发布负责人审阅门禁报告  
   **Then** 可按能力分组定位失败项并确定阻断原因  
   **And** 门禁结果可归档用于发布复盘

## Tasks / Subtasks

- [x] 任务 1：定义能力分组与门禁报告契约（AC: 1, 2）
  - [x] 定义门禁能力分组（至少覆盖 `lint`、`build`、`test`、`smoke`），并建立组内检查项与 FR 映射（FR48 + 高风险门禁表）。
  - [x] 设计统一报告 Schema（JSON）与人类可读摘要（Markdown），至少包含：`run_id`、`generated_at`、`git_sha`、`groups[]`、`blocking`、`failed_checks[]`、`evidence_paths[]`。
  - [x] 定义阻断规则：任一阻断组失败即 `blocking=true`，流程退出码非 0。

- [x] 任务 2：实现门禁执行与聚合器（AC: 1）
  - [x] 复用现有命令链路执行基础门禁：`pnpm nx lint`、`pnpm nx build`、`pnpm nx test`、`pnpm nx smoke`。
  - [x] 采集每个门禁项的退出码、耗时、关键输出片段与失败原因分类。
  - [x] 聚合 `artifacts/smoke/*.json` 与 `artifacts/chrome-regression/*.json` 作为证据输入，不重复造轮子。

- [x] 任务 3：输出“按能力分组”报告并归档（AC: 1, 2）
  - [x] 将聚合结果输出到固定归档目录（建议：`artifacts/release-gates/`）并按时间戳命名。
  - [x] 报告中必须包含“分组维度失败定位”（组 -> 检查项 -> 失败原因 -> 证据路径）。
  - [x] 报告中加入 `request_id` / 关键链路标识引用（来自 smoke 报告）以支撑复盘追踪。

- [x] 任务 4：CI 集成与阻断落地（AC: 1）
  - [x] 在 CI 中新增/接入“门禁分组报告”步骤，确保失败时阻断合并/发布。
  - [x] 保留现有 `quality-gates` 基础矩阵行为，不破坏已验证流水线；分组报告作为统一汇总层。
  - [x] 上传归档产物（JSON/Markdown），确保发布记录可追溯。

- [x] 任务 5：测试与回归（AC: 1, 2）
  - [x] 正向：全部门禁通过时，报告分组全部 `passed` 且 `blocking=false`。
  - [x] 负向：任一门禁失败时，报告准确标注分组失败原因，且流程返回非 0。
  - [x] 证据完整性：若 smoke/chrome 证据缺失或陈旧，报告应明确失败并阻断。
  - [x] 稳定性：报告分组顺序与输出字段稳定（便于审计比对与自动解析）。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复 `smoke` 证据校验失败时仍可能保持 `group.status=passed` 导致 `blocking` 误判的逻辑。[`tools/release-gate-report.js:472`]
- [x] [AI-Review][MEDIUM] 修复 `RELEASE_GATE_EVIDENCE_STALE_WINDOW_MS` 为非数字时 `NaN` 失效导致陈旧证据窗口保护被绕过的问题。[`tools/release-gate-report.js:108`]
- [x] [AI-Review][MEDIUM] 补充阻断语义与 stale 配置解析的回归测试，覆盖失败证据场景和配置异常场景。[`apps/api/test/release-gate-report.test.js:126`], [`apps/api/test/release-gate-report.test.js:340`]
- [x] [AI-Review][HIGH] 修复 `WORKSPACE_ROOT=process.cwd()` 导致在子目录执行时证据目录与产物归档路径误判的问题，改为基于仓库根目录解析并提供回退策略。[`tools/release-gate-report.js:20`]
- [x] [AI-Review][MEDIUM] 修复证据新鲜度仅依赖文件 `mtime` 可被触碰绕过的问题，新增 `generated_at` 语义校验并纳入 fail-closed。[`tools/release-gate-report.js:258`], [`tools/release-gate-report.js:371`], [`tools/release-gate-report.js:442`]
- [x] [AI-Review][MEDIUM] 修复命令执行硬编码 `zsh` 的环境耦合，支持 `RELEASE_GATE_SHELL` / `SHELL` 解析并在缺失时回退 `sh`，补充对应回归测试。[`tools/release-gate-report.js:131`], [`apps/api/test/release-gate-report.test.js:29`]
- [x] [AI-Review][MEDIUM] 修复 `smoke` 已声明 `chrome_regression.report` 但路径缺失时回退“最新 chrome 证据”的跨运行拼接风险，改为严格绑定并 fail-closed。[`tools/release-gate-report.js:404`], [`apps/api/test/release-gate-report.test.js:411`]
- [x] [AI-Review][LOW] 修复 `smoke` 显式引用 `chrome` 报告缺失场景下附带输出误导性二次错误（“目录无 chrome 报告”）的问题，改为仅输出单一、准确失败原因，避免复盘误判。[`tools/release-gate-report.js:429`], [`apps/api/test/release-gate-report.test.js:449`]
- [x] [AI-Review][HIGH] 修复 `smoke` 命令退出码为 0 但报告 `passed=false`（含 `skipped=true`）时聚合器仍可能判定通过的问题，新增基于 smoke 报告语义的 fail-closed 校验并补充回归测试。[`tools/release-gate-report.js:403`], [`apps/api/test/release-gate-report.test.js:371`], [`apps/api/test/release-gate-report.test.js:416`]
- [x] [AI-Review][MEDIUM] 修复 CI 产物上传未强制存在门禁报告文件的问题，新增 `if-no-files-found: error` 保障“无归档即失败”。[`.github/workflows/ci.yml:63`]
- [x] [AI-Review][HIGH] 修复 `generated_at` 可被未来时间戳伪造绕过陈旧证据窗口的问题，新增“未来时间漂移”fail-closed 校验并补充回归测试。[`tools/release-gate-report.js:423`], [`tools/release-gate-report.js:546`], [`apps/api/test/release-gate-report.test.js:372`], [`apps/api/test/release-gate-report.test.js:413`]
- [x] [AI-Review][HIGH] 修复 `smoke` 可引用 `chrome` 目录外报告导致外部证据注入风险，新增目录边界校验并禁止回退扫描。[`tools/release-gate-report.js:464`], [`apps/api/test/release-gate-report.test.js:625`]
- [x] [AI-Review][MEDIUM] 修复 `chrome` 截图路径未限制目录导致任意文件可被误当证据的问题，新增截图路径边界校验并补充回归测试。[`tools/release-gate-report.js:575`], [`apps/api/test/release-gate-report.test.js:706`]
- [x] [AI-Review][MEDIUM] 修复 CI `quality-gates` 使用 `fail-fast=true` 在首个失败后提前取消矩阵的问题，调整为 `fail-fast=false` 以保留四类门禁完整结果集。[`.github/workflows/ci.yml:12`]
- [x] [AI-Review][LOW] 修复同 `mtime` 证据文件选择非确定性问题，新增稳定二级排序与回归测试，避免审计结果抖动。[`tools/release-gate-report.js:249`], [`apps/api/test/release-gate-report.test.js:748`]
- [x] [AI-Review][HIGH] 修复 `chrome` 报告路径边界校验仅基于 `resolve()` 可被符号链接绕过的问题，改为 `realpath` 级校验并补充“目录内链接指向目录外”回归测试。[`tools/release-gate-report.js:353`], [`tools/release-gate-report.js:515`], [`apps/api/test/release-gate-report.test.js:674`]
- [x] [AI-Review][MEDIUM] 修复 `chrome` 截图路径可通过符号链接绕过目录边界的问题，新增 `realpath` 边界校验并补充回归测试。[`tools/release-gate-report.js:636`], [`apps/api/test/release-gate-report.test.js:799`]
- [x] [AI-Review][MEDIUM] 修复 `chrome` 截图为目录/非常规文件时仍可能被当作有效证据的问题，新增“regular file”强校验与回归测试。[`tools/release-gate-report.js:361`], [`tools/release-gate-report.js:645`], [`apps/api/test/release-gate-report.test.js:843`]
- [x] [AI-Review][MEDIUM] 修复门禁命令统一使用 `-lc` 导致最小 `sh/dash` 环境兼容性风险的问题，按 shell 类型切换为 `-c`/`-lc` 并补充回归测试。[`tools/release-gate-report.js:146`], [`tools/release-gate-report.js:169`], [`apps/api/test/release-gate-report.test.js:42`]
- [x] [AI-Review][HIGH] 修复 `latest smoke` 回退分支未校验 `realpath` 目录边界，导致目录内符号链接可引用目录外证据的问题，新增 fail-closed 校验与回归测试。[`tools/release-gate-report.js:405`], [`tools/release-gate-report.js:423`], [`apps/api/test/release-gate-report.test.js:719`]
- [x] [AI-Review][HIGH] 修复 `latest chrome` 回退分支未校验 `realpath` 目录边界，导致目录内符号链接可注入目录外报告的问题，新增 fail-closed 校验与回归测试。[`tools/release-gate-report.js:561`], [`tools/release-gate-report.js:562`], [`apps/api/test/release-gate-report.test.js:750`]
- [x] [AI-Review][MEDIUM] 修复 shell 参数策略默认 `-lc` 对未知 shell（如 fish）兼容性不稳定的问题，调整为仅对登录 shell 使用 `-lc`、其余默认 `-c`，并补充回归测试。[`tools/release-gate-report.js:146`], [`apps/api/test/release-gate-report.test.js:42`]
- [x] [AI-Review][HIGH] 修复 `0020` 迁移在“仅存在非最终授权权限”场景下可能因行数保护条件跳过清理的问题；改为按作用域与 allowlist 执行强制清理，并补充非规范 `permission_code`（大小写/空白）归一化删除条件。[`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:55`], [`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:147`]
- [x] [AI-Review][MEDIUM] 修复门禁命令子进程输出缓冲区过小（20MB）在高日志量场景触发 `ENOBUFS` 误判失败的问题，提升到 200MB 以降低假失败风险。[`tools/release-gate-report.js:43`], [`tools/release-gate-report.js:166`]
- [x] [AI-Review][MEDIUM] 补充 `0020` 迁移静态断言，覆盖“allowlist 外权限清理 + 非规范 permission_code 清理”语义，防止后续回归引入漏清理风险。[`apps/api/test/migrate-baseline.test.js:523`], [`apps/api/test/migrate-baseline.test.js:537`]
- [x] [AI-Review][HIGH] 修复 `0020` 迁移对“非规范 permission_code”仅使用非二进制比较导致在大小写不敏感排序规则下可能漏删的问题；改为 `BINARY` 精确比较，确保大小写/尾空白异常值被强制清理后再归一化回填。[`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:69`], [`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:159`]
- [x] [AI-Review][MEDIUM] 修复门禁 shell 参数策略对 Windows `bash.exe` 识别失败导致未使用登录 shell 参数的问题；新增 `.exe` 归一化并补充回归测试。[`tools/release-gate-report.js:154`], [`apps/api/test/release-gate-report.test.js:46`]
- [x] [AI-Review][MEDIUM] 修复 `generated_at` 使用宽松 `Date.parse` 解析引入无时区时间歧义的问题；改为仅接受带时区的 ISO 时间并补充回归测试，避免跨时区误判证据新鲜度。[`tools/release-gate-report.js:44`], [`tools/release-gate-report.js:307`], [`apps/api/test/release-gate-report.test.js:50`]
- [x] [AI-Review][HIGH] 修复 `smoke` 显式引用 `chrome` 报告时仅校验目录边界、未校验文件命名契约导致目录内任意 JSON 可被注入为有效证据的问题；新增 `chrome-regression-*.json` 模式强校验并补充回归测试。[`tools/release-gate-report.js:47`], [`tools/release-gate-report.js:570`], [`apps/api/test/release-gate-report.test.js:729`]
- [x] [AI-Review][MEDIUM] 修复 `request_id` 聚合仅覆盖少数字段导致 `steps`/嵌套结构中的链路标识丢失问题；改为深度遍历提取 `request_id/*_request_id` 并补充回归测试。[`tools/release-gate-report.js:333`], [`apps/api/test/release-gate-report.test.js:296`]
- [x] [AI-Review][MEDIUM] 修复时区严格解析后仅接受毫秒精度导致微秒/纳秒 ISO 时间被误判为无效证据的问题；扩展到 1-9 位小数秒并补充回归测试。[`tools/release-gate-report.js:45`], [`apps/api/test/release-gate-report.test.js:52`]
- [x] [AI-Review][HIGH] 修复 `chrome` 截图证据仅校验“存在且非空”，未校验文件命名契约导致目录内任意 `.png` 可被注入为有效截图的问题；新增 `chrome-regression-*.png` 模式强校验并补充回归测试。[`tools/release-gate-report.js:48`], [`tools/release-gate-report.js:725`], [`apps/api/test/release-gate-report.test.js:1026`]
- [x] [AI-Review][MEDIUM] 修复 `request_id` 提取对 camelCase / `request_ids[]` 不兼容导致链路标识遗漏的问题；新增键名归一化与数组值提取，并补充回归测试。[`tools/release-gate-report.js:350`], [`tools/release-gate-report.js:358`], [`apps/api/test/release-gate-report.test.js:304`]
- [x] [AI-Review][MEDIUM] 修复时间戳格式仅接受大写 `Z` 导致小写 `z`（仍可被 `Date.parse` 解析）被误判为无效证据的问题；扩展时区后缀兼容并补充回归测试。[`tools/release-gate-report.js:45`], [`apps/api/test/release-gate-report.test.js:52`]
- [x] [AI-Review][HIGH] 修复门禁聚合器未强绑定本次执行 `run_id` 的问题：新增 `release_gate_run_id` 证据校验，缺失或不匹配均 fail-closed，防止跨运行报告混入本次门禁结论。[`tools/release-gate-report.js:449`], [`tools/release-gate-report.js:569`], [`tools/release-gate-report.js:1104`], [`tools/smoke.js:47`], [`tools/smoke.js:828`]
- [x] [AI-Review][MEDIUM] 修复 `smoke` 报告缺失 `chrome_regression.report` 时仍回退“最新 chrome 报告”导致跨运行证据拼接风险，调整为缺失即失败（fail-closed）并补充回归测试。[`tools/release-gate-report.js:607`], [`apps/api/test/release-gate-report.test.js:904`]
- [x] [AI-Review][MEDIUM] 补充 `release_gate_run_id` 缺失/不匹配回归测试，确保 run-level 证据绑定语义被持续守护。[`apps/api/test/release-gate-report.test.js:320`], [`apps/api/test/release-gate-report.test.js:362`]
- [x] [AI-Review][HIGH] 修复 `tools/smoke.js` 对 chrome 截图仅校验存在/非空，未校验“位于报告目录内”与文件命名契约的问题，避免目录外或任意命名截图被注入为有效 smoke 证据。[`tools/smoke.js:717`], [`tools/smoke.js:720`], [`apps/api/test/smoke.helpers.test.js:55`], [`apps/api/test/smoke.helpers.test.js:78`]
- [x] [AI-Review][MEDIUM] 修复 `getLatestChromeRegressionArtifact()` 同 `mtime` 候选选择非确定性问题，新增稳定二级路径排序以避免 smoke 证据选择抖动。[`tools/smoke.js:89`], [`apps/api/test/smoke.helpers.test.js:110`]
- [x] [AI-Review][MEDIUM] 修复 `getLatestChromeRegressionArtifact()` 在损坏符号链接/不可读候选文件场景可能抛异常中断的问题，改为跳过异常候选并继续选择可用证据。[`tools/smoke.js:75`], [`tools/smoke.js:84`], [`apps/api/test/smoke.helpers.test.js:125`]

## Dev Notes

### Developer Context（开发者先读）

- 本故事目标是“汇总与可追踪”，不是重写现有门禁实现。现有门禁链路已具备执行能力（`lint/build/test/smoke`），需要补“按能力分组的统一报告层”。
- 现有 `tools/smoke.js` 已输出结构化 JSON，包含 `steps`、`online_drill`、`chrome_regression`、`passed`，应直接复用这些字段构建分组结果。
- 现有 CI 已有 `quality-gates` 矩阵，门禁执行本身不缺，缺口是“面向发布负责人的分组视图 + 统一归档 + 阻断原因可读化”。
- 设计上必须 fail-closed：证据缺失、解析失败、命令异常均应视为门禁失败，而不是降级放行。

### Technical Requirements（硬约束）

- 直接覆盖：`FR48`（发布前能力回归门禁并输出按能力分组结果）。
- 强关联：`FR49-FR54`、`FR72-FR73`、`FR77-FR79`（高风险 FR 门禁表中的阻断能力）。
- NFR 对齐：`NFR22`（证据可归档可审计）、`NFR33`（发布门禁检查为强制项）。

### Architecture Compliance（架构对齐清单）

- 门禁分组报告必须与现有 Monorepo 流程兼容，不绕开 `pnpm nx` 与既有 CI 门禁。
- 失败阻断必须可机器判定（退出码 + 结构化字段），不能仅靠人工阅读日志。
- 前端相关门禁必须继续以真实 Chrome（Playwright）证据为准，禁止改回“历史报告复用即通过”的弱校验。
- 产物需可追踪（包含时间戳、提交信息、证据路径、关键 request_id）。

### Library & Framework Requirements（库与运行时要求）

- 当前仓库依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新 registry 核验（2026-02-21）：
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - `vite`: `7.3.1`
  - `react`: `19.2.4`
- Node 版本对齐：
  - CI 基线：Node 24（`.github/workflows/ci.yml`）
  - 本地当前：`v25.2.1`
  - 本故事不要求立即升级依赖；优先保证门禁报告语义与阻断行为稳定。

### File Structure Requirements（建议变更落点）

- 门禁报告聚合主入口（建议新增）：
  - `tools/release-gate-report.js`
- 现有门禁执行编排（按需扩展）：
  - `tools/nx.js`
- smoke 证据读取与聚合：
  - `tools/smoke.js`
- CI 集成与产物上传：
  - `.github/workflows/ci.yml`
- 质量门禁与权限声明检查（复用）：
  - `apps/api/scripts/check-route-permissions.js`
- 产物归档目录（建议新增）：
  - `artifacts/release-gates/`

### Testing Requirements（必须覆盖）

- 报告结构测试：
  - 分组字段齐全，且至少覆盖 `lint/build/test/smoke`。
  - `failed_checks` 与 `blocking` 语义一致。
- 失败路径测试：
  - 任一门禁失败时，报告准确定位失败分组/检查项，并返回非 0 退出码。
- 证据链测试：
  - smoke/chrome 证据缺失、过期、结构异常时应阻断并输出明确失败原因。
- 回归测试：
  - 不破坏现有 `pnpm nx lint/build/test/smoke` 行为与现有产物格式。

### Previous Story Intelligence（来自 4.5）

- 严格 fail-closed 一致性要优先于“宽松可用性”；任何不确定状态不得放行。
- 输出与契约必须稳定（排序、字段、语义一致），否则会导致报告解析与复盘不可靠。
- 审计可追踪字段（before/after、request_id、证据路径）必须完整保留。

### Git Intelligence Summary（最近提交模式）

- 最近提交持续聚焦“权限与门禁一致性加固”，核心文件集中在：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/platform/role.service.js`
  - `apps/api/src/modules/tenant/role.service.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可沿用当前节奏：先定义契约与失败语义，再补测试，最后再接入流水线汇总输出。

### Latest Tech Information（外部核验）

- npm registry（2026-02-21）核验通过：`@nestjs/core@11.1.14`、`typeorm@0.3.28`、`mysql2@3.17.4`、`ioredis@5.9.3`、`vite@7.3.1`、`react@19.2.4`。
- 鉴于本故事目标是门禁报告能力，建议优先交付“分组报告与阻断规则”；依赖升级可独立成后续维护任务，避免扩大回归面。

### Project Structure Notes

- 当前仓库无 `docs/` 目录，发布证据主要沉淀在 `artifacts/`。
- 已存在高价值证据：
  - `artifacts/smoke/*.json|*.log`
  - `artifacts/chrome-regression/*.json|*.png`
- 本故事应在此基础上新增“可读的分组汇总层”，避免分散查阅多个原始报告文件。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.6）
  - `_bmad-output/planning-artifacts/prd.md`（FR48、发布门禁与高风险 FR 阻断规则）
  - `_bmad-output/planning-artifacts/architecture.md`（CI/CD 基线、门禁分层、产物归档）
  - `_bmad-output/planning-artifacts/ux-design-specification.md`（运维治理流程中“核对门禁/能力分组结果”）
  - `_bmad-output/implementation-artifacts/4-5-权限树最终授权落库.md`（前序故事经验）
  - `.github/workflows/ci.yml`、`tools/smoke.js`（当前可复用实现）

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review issues fixed with tests; release-gate fail-closed blocking semantics validated.`

### References

- `_bmad-output/planning-artifacts/epics.md`（`Epic 4` / `Story 4.6`）
- `_bmad-output/planning-artifacts/prd.md`（`FR48`、`安全一致性与发布门禁`、`高风险 FR 专项发布门禁`）
- `_bmad-output/planning-artifacts/architecture.md`（`PR Quality Gates`、`CI/CD baseline`、`产物归档`）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（`核对发布门禁/能力分组结果`）
- `_bmad-output/implementation-artifacts/4-5-权限树最终授权落库.md`
- `.github/workflows/ci.yml`
- `tools/nx.js`
- `tools/smoke.js`
- `apps/api/scripts/check-route-permissions.js`
- `apps/api/package.json`
- `package.json`

## Senior Developer Review (AI)

### Review Date

2026-02-22

### Reviewer

老大（AI Code Review Workflow）

### Findings

1. `[HIGH][Fixed]` `tools/release-gate-report.js` 在组状态已预设为 `passed` 时会优先信任该状态，导致新增失败检查（如 `smoke.evidence`）不一定将 `blocking` 置为 `true`。已改为“任一检查失败即组失败”，并在证据附加后强制重算 `smoke` 组状态。证据：`tools/release-gate-report.js:455`, `tools/release-gate-report.js:472`
2. `[MEDIUM][Fixed]` `RELEASE_GATE_EVIDENCE_STALE_WINDOW_MS` 读取为非数字时会产生 `NaN`，从而使陈旧证据比较条件失效。已引入安全解析函数并设置下限 60s。证据：`tools/release-gate-report.js:108`, `tools/release-gate-report.js:720`
3. `[MEDIUM][Fixed]` 缺少覆盖“证据失败反向影响 blocking”与“stale 窗口配置异常”的专门回归测试。已补齐两条测试并通过。证据：`apps/api/test/release-gate-report.test.js:126`, `apps/api/test/release-gate-report.test.js:340`
4. `[HIGH][Fixed]` 报告脚本将 `WORKSPACE_ROOT` 绑定为 `process.cwd()`，在子目录触发时会将 `artifacts/*` 解析到错误位置并导致错误阻断。已改为优先通过 `git rev-parse --show-toplevel` 解析仓库根目录并回退到脚本相对路径。证据：`tools/release-gate-report.js:20`, `tools/release-gate-report.js:35`
5. `[MEDIUM][Fixed]` 证据新鲜度仅校验文件 `mtime`，可通过 `touch` 伪造“新鲜”文件绕过门禁。已新增对 `generated_at` 的时间语义校验（predates/stale window）并纳入 fail-closed。证据：`tools/release-gate-report.js:258`, `tools/release-gate-report.js:371`, `tools/release-gate-report.js:442`
6. `[MEDIUM][Fixed]` 门禁命令执行硬编码 `zsh`，在无 `zsh` 环境会造成全部检查误失败。已支持 `RELEASE_GATE_SHELL`/`SHELL` 并在 `ENOENT` 时回退 `sh`。证据：`tools/release-gate-report.js:131`, `tools/release-gate-report.js:145`
7. `[MEDIUM][Fixed]` 当 `smoke` 报告显式引用的 `chrome` 报告路径不存在时，旧逻辑会回退扫描目录最新 `chrome` 报告，可能把不同运行证据拼接进同一次门禁结论。已改为“若显式引用缺失则直接记失败，不再回退”。证据：`tools/release-gate-report.js:404`, `apps/api/test/release-gate-report.test.js:411`
8. `[LOW][Fixed]` 在“显式引用缺失”场景下，旧逻辑还会额外追加一条“目录无 chrome 报告”的泛化错误，哪怕目录中存在其他报告，导致失败根因描述不准确。已调整为该场景仅保留“引用缺失”这一条错误。证据：`tools/release-gate-report.js:429`, `apps/api/test/release-gate-report.test.js:449`
9. `[HIGH][Fixed]` 聚合器此前仅依据 `pnpm nx smoke` 进程退出码判断检查通过，未强校验 `smoke` 报告的 `passed`/`skipped` 语义；在 `SMOKE_ALLOW_DOCKER_UNAVAILABLE=true` 等场景可能出现“命令成功但报告失败”的假通过。已新增 smoke 报告语义校验：`passed!==true`（含 `skipped=true`）即阻断。证据：`tools/release-gate-report.js:403`, `apps/api/test/release-gate-report.test.js:371`, `apps/api/test/release-gate-report.test.js:416`
10. `[MEDIUM][Fixed]` CI 上传门禁报告产物步骤使用默认缺省策略，异常情况下可能出现“未生成归档但流程未因上传步骤失败”风险，不满足 AC2 的可追溯要求。已设置 `if-no-files-found: error`，保证归档缺失时直接失败。证据：`.github/workflows/ci.yml:63`
11. `[HIGH][Fixed]` 证据时间仅校验“过旧”未校验“未来漂移”，攻击者可伪造未来 `generated_at` 规避 stale 窗口。已新增未来时间漂移上限（5 分钟）并 fail-closed，同时补充 smoke/chrome 双路径测试。证据：`tools/release-gate-report.js:423`, `tools/release-gate-report.js:546`, `apps/api/test/release-gate-report.test.js:372`, `apps/api/test/release-gate-report.test.js:413`
12. `[HIGH][Fixed]` `smoke` 报告中的 `chrome_regression.report` 允许指向 `artifacts/chrome-regression` 目录外文件，存在跨目录证据注入风险。已新增目录边界校验，越界即判定 `invalid-chrome-evidence` 且禁止回退扫描。证据：`tools/release-gate-report.js:464`, `apps/api/test/release-gate-report.test.js:625`
13. `[MEDIUM][Fixed]` `chrome` 截图路径仅校验存在性与大小，未校验目录边界，可能把外部文件误判为有效证据。已新增截图路径边界校验并补充回归。证据：`tools/release-gate-report.js:575`, `apps/api/test/release-gate-report.test.js:706`
14. `[MEDIUM][Fixed]` CI `quality-gates` 矩阵启用 `fail-fast=true` 时会在首个失败后取消后续门禁，不满足“四类门禁结果完整可审阅”的发布复盘要求。已调整为 `fail-fast=false`。证据：`.github/workflows/ci.yml:12`
15. `[LOW][Fixed]` 最新证据选择仅按 `mtime` 排序，在同 `mtime` 场景下选择结果不稳定，可能导致审计输出抖动。已增加二级路径排序并补充确定性测试。证据：`tools/release-gate-report.js:249`, `apps/api/test/release-gate-report.test.js:748`
16. `[HIGH][Fixed]` `chrome` 报告路径边界校验仅基于 `resolve()`，无法识别“目录内符号链接指向目录外”场景，存在证据注入绕过风险。已改为 `realpath` 级边界校验并补充回归测试。证据：`tools/release-gate-report.js:353`, `tools/release-gate-report.js:515`, `apps/api/test/release-gate-report.test.js:674`
17. `[MEDIUM][Fixed]` `chrome` 截图路径同样存在符号链接越界绕过风险；旧逻辑只校验路径文本和文件存在性。已补齐 `realpath` 目录边界校验并新增回归测试。证据：`tools/release-gate-report.js:636`, `apps/api/test/release-gate-report.test.js:799`
18. `[MEDIUM][Fixed]` `chrome` 截图若为目录（非普通文件）时，旧逻辑可能仅凭 `size>0` 视为有效证据，导致证据完整性误判。已新增 regular-file 强校验并补回归。证据：`tools/release-gate-report.js:361`, `tools/release-gate-report.js:645`, `apps/api/test/release-gate-report.test.js:843`
19. `[MEDIUM][Fixed]` 门禁命令统一使用 `-lc`，在最小 shell（如 `sh/dash`）下存在兼容性误失败风险。已新增 shell 参数选择策略（`-c`/`-lc`）并补回归测试。证据：`tools/release-gate-report.js:146`, `tools/release-gate-report.js:169`, `apps/api/test/release-gate-report.test.js:42`
20. `[HIGH][Fixed]` `latest smoke` 回退分支对候选文件缺少 `realpath` 目录边界校验，目录内符号链接可把目录外文件当作当前运行证据。已新增 fail-closed 校验并补回归测试。证据：`tools/release-gate-report.js:405`, `tools/release-gate-report.js:423`, `apps/api/test/release-gate-report.test.js:719`
21. `[HIGH][Fixed]` `latest chrome` 回退分支同样缺少 `realpath` 目录边界校验，目录内符号链接可注入目录外 chrome 报告。已新增 fail-closed 校验并补回归测试。证据：`tools/release-gate-report.js:561`, `tools/release-gate-report.js:562`, `apps/api/test/release-gate-report.test.js:750`
22. `[MEDIUM][Fixed]` shell 参数策略默认 `-lc` 对未知 shell（如 `fish`）存在兼容性风险。已改为仅对登录 shell 使用 `-lc`，其余默认 `-c` 并补回归测试。证据：`tools/release-gate-report.js:146`, `apps/api/test/release-gate-report.test.js:42`
23. `[HIGH][Fixed]` `0020` 迁移删除逻辑依赖 `@has_*_rows > 0` 保护条件，在“仅有非最终授权数据”时会跳过清理，导致越权权限残留。已改为按 `platform/tenant` 作用域直接清理 allowlist 外权限，并强制删除非规范 `permission_code` 以确保归一化落库。证据：`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:55`, `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:147`
24. `[MEDIUM][Fixed]` 门禁命令执行 `spawnSync` 输出缓冲上限仅 20MB，在大规模 `nx test/build` 日志场景可能触发 `ENOBUFS` 并被误判为门禁失败。已将缓冲上限提升为 200MB，降低高噪声 CI 场景误阻断风险。证据：`tools/release-gate-report.js:43`, `tools/release-gate-report.js:166`
25. `[MEDIUM][Fixed]` `0020` 迁移测试原先仅校验“存在行数保护变量”，未覆盖“allowlist 外清理 + 非规范 permission_code 清理”核心语义。已更新断言，锁定最终授权清理行为，防止回归。证据：`apps/api/test/migrate-baseline.test.js:523`, `apps/api/test/migrate-baseline.test.js:537`
26. `[HIGH][Fixed]` `0020` 迁移对非规范 `permission_code` 的删除条件使用普通字符串比较，在大小写不敏感排序规则下可能把 `Platform.System_Config.View` 等异常值误判为“已规范”而残留。已改为 `BINARY` 精确比较，确保大小写/尾空白偏差均被清理并由临时表统一回填规范值。证据：`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:69`, `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:159`
27. `[MEDIUM][Fixed]` shell 参数策略未兼容 `bash.exe`，在 Windows Git Bash 场景会误走 `-c` 分支，导致与登录 shell 行为不一致。已增加 `.exe` 归一化识别并补充回归测试。证据：`tools/release-gate-report.js:154`, `apps/api/test/release-gate-report.test.js:46`
28. `[MEDIUM][Fixed]` `generated_at` 解析依赖宽松 `Date.parse`，会接受无时区时间字符串（如 `2026-02-21T00:00:00`），在不同时区节点产生新鲜度判定偏差。已改为仅接受带时区 ISO 时间并补回归测试。证据：`tools/release-gate-report.js:44`, `tools/release-gate-report.js:307`, `apps/api/test/release-gate-report.test.js:50`
29. `[HIGH][Fixed]` `smoke` 显式引用 `chrome` 报告时此前未校验文件命名契约，目录内任意 JSON（满足最小结构）都可能被当作有效证据，存在证据注入风险。已新增 `chrome-regression-*.json` 模式校验并 fail-closed。证据：`tools/release-gate-report.js:47`, `tools/release-gate-report.js:570`, `apps/api/test/release-gate-report.test.js:729`
30. `[MEDIUM][Fixed]` `request_id` 提取逻辑仅覆盖固定字段，`steps` 或更深层结构中的链路标识会丢失，影响复盘追踪完整性。已改为递归提取 `request_id/*_request_id` 并补回归测试。证据：`tools/release-gate-report.js:333`, `apps/api/test/release-gate-report.test.js:296`
31. `[MEDIUM][Fixed]` 时间戳格式校验仅支持 3 位小数秒，微秒/纳秒精度的合法 ISO 时间会被误判为无效证据并触发误阻断。已扩展为支持 1-9 位小数秒并补回归测试。证据：`tools/release-gate-report.js:45`, `apps/api/test/release-gate-report.test.js:52`
32. `[HIGH][Fixed]` `chrome` 截图证据此前仅校验路径边界、存在性与文件大小，未校验文件命名契约，导致目录内任意 `.png` 文件可被注入并伪装为有效截图证据。已新增 `chrome-regression-*.png` 模式校验并 fail-closed。证据：`tools/release-gate-report.js:48`, `tools/release-gate-report.js:725`, `apps/api/test/release-gate-report.test.js:1026`
33. `[MEDIUM][Fixed]` `request_id` 聚合对 camelCase（`requestId`）与数组字段（`request_ids`）兼容不足，可能遗漏链路标识。已新增键名归一化与数组提取，并补回归测试。证据：`tools/release-gate-report.js:350`, `tools/release-gate-report.js:358`, `apps/api/test/release-gate-report.test.js:304`
34. `[MEDIUM][Fixed]` 时间戳正则仅接受大写 `Z`，会把小写 `z` 的合法 UTC 时间误判为无效并触发误阻断。已扩展 `Z/z` 兼容并补回归测试。证据：`tools/release-gate-report.js:45`, `apps/api/test/release-gate-report.test.js:52`
35. `[HIGH][Fixed]` 门禁聚合器此前仅通过时间窗口推断证据归属，未强绑定当前执行 `run_id`；攻击者可构造“时间新鲜但非本次运行”的 smoke 报告混入结论。已新增 `release_gate_run_id` 强校验（缺失/不匹配均 fail-closed），并由 smoke 产物写入当前 run_id。证据：`tools/release-gate-report.js:449`, `tools/release-gate-report.js:569`, `tools/release-gate-report.js:1104`, `tools/smoke.js:47`, `tools/smoke.js:828`
36. `[MEDIUM][Fixed]` `smoke` 报告缺失 `chrome_regression.report` 时旧逻辑会回退扫描目录最新 chrome 证据，可能跨运行拼接。已改为缺失即报错并阻断。证据：`tools/release-gate-report.js:607`, `apps/api/test/release-gate-report.test.js:904`
37. `[MEDIUM][Fixed]` 缺少 run_id 绑定语义测试，回归风险较高。已补齐“缺失 run_id”和“run_id 不匹配”两类回归测试。证据：`apps/api/test/release-gate-report.test.js:320`, `apps/api/test/release-gate-report.test.js:362`
38. `[HIGH][Fixed]` `tools/smoke.js` 预检 chrome 证据时只检查截图存在/非空，未限制截图必须位于报告目录且满足命名契约，存在目录外图片注入风险。已新增目录边界与命名模式双重校验并补回归测试。证据：`tools/smoke.js:717`, `tools/smoke.js:720`, `apps/api/test/smoke.helpers.test.js:55`, `apps/api/test/smoke.helpers.test.js:78`
39. `[MEDIUM][Fixed]` `getLatestChromeRegressionArtifact()` 仅按 `mtime` 排序，在同时间戳场景下选择不稳定，可能导致 smoke 复盘结果抖动。已新增二级路径排序确保确定性。证据：`tools/smoke.js:89`, `apps/api/test/smoke.helpers.test.js:110`
40. `[MEDIUM][Fixed]` `getLatestChromeRegressionArtifact()` 对候选文件 `stat` 异常未降级处理，损坏符号链接可导致 smoke 预检异常退出。已改为跳过异常候选并继续评估可用证据。证据：`tools/smoke.js:75`, `tools/smoke.js:84`, `apps/api/test/smoke.helpers.test.js:125`

### Outcome

Approve（已修复全部 HIGH/MEDIUM 项，且相关测试通过）

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `git log --oneline -n 8`
- `pnpm view @nestjs/core version`
- `pnpm view typeorm version`
- `pnpm view mysql2 version`
- `pnpm view ioredis version`
- `pnpm view vite version`
- `pnpm view react version`
- `node -v`
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`
- `pnpm nx lint`
- `pnpm nx build`
- `pnpm nx test`
- `node tools/release-gate-report.js`
- `pnpm nx smoke`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/release-gate-report.test.js`
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-2）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review-2）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-3）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review-3）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-4）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review-4）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-5）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review-5）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-6）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（re-review-6）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（re-review-8）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/release-gate-report.test.js`（re-review-8）
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`（cr-auto-4-6）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js`（cr-auto-4-6）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js test/migrate-baseline.test.js`（cr-auto-4-6-re-review）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js test/migrate-baseline.test.js`（cr-auto-4-6-re-review-2）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js test/migrate-baseline.test.js`（cr-auto-4-6-re-review-3）
- `pnpm --dir apps/api exec node --test test/release-gate-report.test.js test/migrate-baseline.test.js`（cr-auto-4-6-re-review-4）
- `pnpm --dir apps/api exec node --test test/smoke.helpers.test.js test/release-gate-report.test.js test/migrate-baseline.test.js`（cr-auto-4-6-re-review-5）

### Completion Notes List

- 已完成 Story 4.6 全量上下文分析与开发护栏编制。
- 已对齐现有门禁实现与可复用证据链，形成可直接开发的任务拆解。
- 已新增 `tools/release-gate-report.js`，实现门禁分组契约、执行链路复用、证据聚合、JSON/Markdown 归档与阻断退出码。
- 已新增 `apps/api/test/release-gate-report.test.js`，覆盖正向/负向、证据缺失与陈旧、输出稳定性与分组语义。
- 已更新 `.github/workflows/ci.yml`，保留既有 `quality-gates` 矩阵并新增统一分组报告与产物上传步骤。
- 已修复 `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql` 的 MySQL 临时表二次引用问题（`Can't reopen table: 'normalized'`），并同步 `apps/api/test/migrate-baseline.test.js` 断言。
- 本地验证已通过 `pnpm nx smoke` 与 `node tools/release-gate-report.js` 正向场景，最新分组报告 `blocking=false`、`4/4` 通过。
- 代码评审阶段修复了 `blocking` 误判与 stale 配置解析缺陷，并新增回归测试覆盖。
- 复审阶段补齐了仓库根目录解析、`generated_at` 证据新鲜度校验与 shell 回退策略，新增 5 条回归测试并验证通过。
- 复审第二轮修复了 `smoke` 显式证据路径缺失时的错误回退策略，新增回归测试验证“禁止跨运行证据拼接”。
- 复审第三轮修复了 `smoke` 显式引用缺失场景下的误导性二次错误输出，确保失败原因单一且可操作。
- 复审第四轮补齐了 smoke 报告 `passed/skipped` 语义强校验，修复“命令成功但报告失败”潜在假通过风险，并补充回归测试。
- 复审第五轮补齐 CI 归档强约束，确保门禁报告缺失时流水线明确失败，避免无证据放行。
- 复审第六轮补齐了未来时间戳绕过、证据目录边界校验与同 `mtime` 选择稳定性，新增 6 条回归测试并通过。
- 复审第六轮将 CI `quality-gates` 调整为 `fail-fast=false`，确保发布复盘可获取完整门禁矩阵结果。
- 复审第七轮补齐符号链接边界防护（chrome 报告与截图）、截图 regular-file 强校验及最小 shell 参数兼容策略，新增 4 条回归测试并通过。
- 复审第八轮补齐 `latest smoke/chrome` 回退分支的符号链接越界防护，并将 shell 参数策略默认值调整为 `-c`（登录 shell 仍用 `-lc`），新增 3 条回归测试并通过。
- CR 自动续审补丁：修复 `0020` 迁移在非最终授权数据场景可能漏清理的问题；提升门禁命令日志缓冲上限并补齐迁移语义断言，相关回归测试通过。
- CR 自动续审补丁（二）：修复 `0020` 迁移在大小写不敏感排序规则下可能漏删非规范权限码的问题（改为 `BINARY` 比较）；补齐 Windows `bash.exe` shell 参数识别与 `generated_at` 时区严格解析回归测试，相关用例通过。
- CR 自动续审补丁（三）：修复 `chrome` 证据命名契约缺失导致的目录内 JSON 注入风险，增强 `request_id` 递归提取覆盖并放宽到 1-9 位小数秒 ISO 时间，补充回归测试并通过。
- CR 自动续审补丁（四）：补齐 `chrome` 截图命名契约校验（`chrome-regression-*.png`）并增强 `request_id` 提取对 camelCase/数组兼容，同时修复小写 `z` 时区后缀误判问题，相关回归测试通过。
- CR 自动续审补丁（五）：补齐 run-level 证据绑定，新增 `release_gate_run_id` 生成与校验并禁止“缺失 chrome 引用”回退，补充 3 条回归测试并通过。
- CR 自动续审补丁（六）：补齐 `tools/smoke.js` 侧证据硬化（截图目录边界 + 命名契约）、最新证据选择稳定性（同 `mtime` 二级排序）与损坏符号链接候选降级处理，补充 `smoke.helpers` 回归测试并通过。

### File List

- `.github/workflows/ci.yml`
- `apps/api/test/release-gate-report.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/smoke.helpers.test.js`
- `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql`
- `tools/release-gate-report.js`
- `tools/smoke.js`
- `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-21: 完成 Story 4.6 门禁分组报告实现、CI 接入、迁移修复与回归验证，状态更新为 `review`。
- 2026-02-21: 完成代码评审修复（blocking 判定、stale 配置解析、回归测试补齐），状态更新为 `done`。
- 2026-02-21: 复审补丁：修复 cwd 路径耦合、`generated_at` 新鲜度绕过与 shell 兼容性问题，补充对应回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（二）：修复 smoke->chrome 证据错误回退导致的跨运行证据拼接风险，补充回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（三）：修复显式引用缺失场景的误导性重复错误输出，补充回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（四）：修复 smoke 报告语义未纳入阻断判定导致的潜在假通过，补充回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（五）：修复 CI 上传产物缺失未强制失败问题，强化归档可追溯门禁，状态维持 `done`。
- 2026-02-21: 复审补丁（六）：修复未来时间戳绕过、证据目录越界与同 `mtime` 非确定性选择问题，补齐回归测试并将 CI `quality-gates` 调整为 `fail-fast=false`，状态维持 `done`。
- 2026-02-21: 复审补丁（七）：修复符号链接越界绕过与截图非常规文件误判问题，新增 shell 参数兼容策略与 4 条回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（八）：修复 `latest smoke/chrome` 回退分支的符号链接越界绕过，并优化未知 shell 参数策略（默认 `-c`），新增 3 条回归测试，状态维持 `done`。
- 2026-02-21: 复审补丁（九）：修复 `0020` 迁移行数保护导致的漏清理风险，强化非规范权限码清理语义；提升门禁命令输出缓冲上限并更新迁移语义断言，状态维持 `done`。
- 2026-02-22: CR 自动续审补丁（十）：修复 `0020` 迁移在大小写不敏感排序规则下的非规范权限码漏清理风险（`BINARY` 比较），并补齐 `bash.exe` shell 识别与 `generated_at` 时区严格解析回归测试，状态维持 `done`。
- 2026-02-22: CR 自动续审补丁（十一）：修复 `chrome` 显式证据文件名未校验导致的目录内 JSON 注入风险，补齐 `request_id` 递归提取与高精度时间戳解析支持（1-9 位小数秒），状态维持 `done`。
- 2026-02-22: CR 自动续审补丁（十二）：修复 `chrome` 截图命名契约缺失导致目录内任意图片可被注入为证据的问题；增强 `request_id` 对 camelCase/数组提取兼容，并补齐小写 `z` 时区时间戳兼容，状态维持 `done`。
- 2026-02-22: CR 自动续审补丁（十三）：新增 `release_gate_run_id` 证据绑定并在聚合器中执行强校验，修复缺失 `chrome_regression.report` 回退导致的跨运行证据拼接风险，补齐回归测试，状态维持 `done`。
- 2026-02-22: CR 自动续审补丁（十四）：修复 `tools/smoke.js` 截图边界/命名契约校验缺失、同 `mtime` 证据选择非确定性与损坏符号链接候选异常中断问题，补齐 `smoke.helpers` 回归测试，状态维持 `done`。
