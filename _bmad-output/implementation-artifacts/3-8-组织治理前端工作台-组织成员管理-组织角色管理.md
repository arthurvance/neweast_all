# Story 3.8: 组织治理前端工作台（组织成员管理 + 组织角色管理）

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 组织负责人或组织管理员,  
I want 在组织入口使用统一治理工作台完成成员与角色治理,  
so that 组织治理能力在前端形成可执行闭环。

## Acceptance Criteria

1. **Given** 组织管理员进入“成员管理”  
   **When** 执行列表、筛选、分页、新增、状态切换与资料维护  
   **Then** 前端页面能力与服务端契约一致  
   **And** 新建/编辑使用 Modal，详情使用 Drawer
2. **Given** 组织管理员进入“角色管理”  
   **When** 执行角色创建、编辑、删除与权限树配置  
   **Then** 权限树仅保存最终授权结果（叶子权限）  
   **And** 前端保持父子联动展示一致
3. **Given** 管理员为成员分配 1 到 5 个组织角色  
   **When** 分配请求成功  
   **Then** 成员权限按并集即时生效  
   **And** 越权访问被一致拒绝并可追踪
4. **Given** Story 3.8 进入交付验收  
   **When** 执行真实 Chrome Playwright 前端回归  
   **Then** 成员治理、角色治理、权限分配关键路径全部通过  
   **And** 失败项阻断 Story 完成

## Tasks / Subtasks

- [x] 任务 1：搭建 tenant 治理工作台骨架并接入 dashboard（AC: 1, 2, 3）
  - [x] 在 `apps/web/src/features/tenant-governance/` 新增 `TenantGovernanceWorkbench.jsx`，结构对齐 `PlatformGovernanceWorkbench`，避免在 `App.jsx` 继续堆叠复杂 UI 逻辑。
  - [x] 在 `apps/web/src/App.jsx` 的 tenant dashboard 区块挂载工作台入口（成员管理 / 角色管理）并保留现有组织切换流程。
  - [x] 继续沿用 AntD + 现有 `CustomCardTable`、`CustomFilter`、`CustomForm` 组件组合，不新增脱离 AntD 的独立组件体系。
  - [x] 统一交互骨架：列表工作台 + Modal（新建/编辑）+ Drawer（详情）+ message（全局反馈）。

- [x] 任务 2：实现组织成员管理闭环（AC: 1, 3）
  - [x] 新增 `apps/web/src/api/tenant-governance.mjs`，封装成员相关接口：
    - `GET /tenant/members`
    - `POST /tenant/members`
    - `GET /tenant/members/:membership_id`
    - `PATCH /tenant/members/:membership_id/status`
    - `PATCH /tenant/members/:membership_id/profile`
    - `GET /tenant/members/:membership_id/roles`
    - `PUT /tenant/members/:membership_id/roles`
  - [x] 成员列表支持分页/筛选（按 OpenAPI `page/page_size` 语义），并保持筛选上下文。
  - [x] 新增成员仅提交 `phone`，对齐服务端校验（11 位手机号）。
  - [x] 状态切换与资料维护分别走对应 PATCH 接口，错误返回按 Problem Details 映射。
  - [x] 成员详情统一 Drawer 展示 `membership_id/user_id/status/display_name/department_name/request_id`。

- [x] 任务 3：实现组织角色治理闭环（AC: 2）
  - [x] 在 `tenant-governance.mjs` 封装角色相关接口：
    - `GET /tenant/roles`
    - `POST /tenant/roles`
    - `PATCH /tenant/roles/:role_id`
    - `DELETE /tenant/roles/:role_id`
    - `GET /tenant/roles/:role_id/permissions`
    - `PUT /tenant/roles/:role_id/permissions`
  - [x] 角色创建/编辑统一 Modal，字段约束对齐 OpenAPI（`role_id/code/name/status`）。
  - [x] 角色详情统一 Drawer，展示角色元信息与权限树。
  - [x] 对受保护角色（`tenant_owner/tenant_admin/tenant_member`）保持后端约束：前端不可“伪成功”，要透传 `TROLE-403-SYSTEM-ROLE-PROTECTED` 语义。

- [x] 任务 4：权限树与成员角色分配即时生效（AC: 2, 3）
  - [x] 权限树保存只提交最终授权 `permission_codes`，且仅允许 `tenant.*` 叶子权限码。
  - [x] 成员角色分配严格 1-5 条约束，提交体为 `role_ids`，并处理去重/格式错误。
  - [x] 分配成功后触发 tenant 权限上下文刷新（`/auth/tenant/options`），验证菜单/按钮可见性即时收敛。
  - [x] 越权与依赖失败分支 fail-closed，禁止前端缓存权限导致误放行。

- [x] 任务 5：统一交互与错误语义（AC: 1, 2, 3）
  - [x] 所有写操作注入 `Idempotency-Key`，防重复提交导致语义漂移。
  - [x] 失败文案统一“原因 + 请稍后重试”，成功后回到列表并保持上下文。
  - [x] 保持字段错误走字段级提示，全局错误走 message；不重复叠加噪音反馈。
  - [x] Drawer 一律使用 `size`，不自定义 `width` 数值。

- [x] 任务 6：真实 Chrome 门禁与测试归档（AC: 4）
  - [x] 扩展 `apps/web/test/chrome.playwright.test.js`：新增 tenant 治理工作台端到端用例（成员 + 角色 + 权限树 + 角色分配）。
  - [x] 增加 tenant 治理 API stub（可参考 `createPlatformGovernanceApiServer`），覆盖成功/失败/越权路径。
  - [x] 验证关键交互：列表加载、筛选、分页、Modal、Drawer、message、loading 防重复。
  - [x] 归档 Chrome 回归证据到 implementation artifacts，失败即阻断 story 完成。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 成员列表筛选仅覆盖当前页且 `total` 使用当前页长度，导致分页语义失真；已改为跨页聚合筛选 + 无 `total` 契约下的 look-ahead 分页推断。`apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
- [x] [AI-Review][MEDIUM] tenant 权限刷新失败时全局提示与局部提示重复叠加，违反“避免噪音反馈”；已通过 `uiMessageHandled` 标记实现提示去重。`apps/web/src/App.jsx`, `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
- [x] [AI-Review][MEDIUM] Chrome 回归对分页语义与写接口幂等头断言不足；已补充分页翻页链路与 `Idempotency-Key` 校验。`apps/web/test/chrome.playwright.test.js`
- [x] [AI-Review][HIGH] tenant 治理 Chrome 用例在“角色分配后权限刷新”步骤存在竞态：`waitForRequest` 可命中历史 `/auth/tenant/options` 请求，导致门禁等待不稳定；已改为基于本次操作前计数的“新增请求”判定。`apps/web/test/chrome.playwright.test.js`
- [x] [AI-Review][MEDIUM] 用例在断言权限收敛前未确认角色分配写接口返回 200，失败路径下仍可能继续执行后续断言；已补充 `PUT /tenant/members/:membership_id/roles` 成功响应等待。`apps/web/test/chrome.playwright.test.js`
- [x] [AI-Review][MEDIUM] Story 测试证据未体现本轮稳定性修复后的全量回归结果；已补充最新 `apps/web` 与仓库级测试通过记录。`_bmad-output/implementation-artifacts/3-8-组织治理前端工作台-组织成员管理-组织角色管理.md`

## Dev Notes

### Developer Context（开发者必须先读）

- Story 3.8 是 Story 2.7（平台治理工作台）的 tenant 域对称实现，优先复用 `PlatformGovernanceWorkbench` 的分层与交互模式，而不是重写一套新框架。
- 后端 tenant 成员/角色能力已在 Story 3.1-3.4 打通，本故事主要是前端治理闭环与真实 Chrome 门禁，不应回退到“仅展示权限按钮”的简化态。
- 现有 `App.jsx` 已实现 tenant 登录/选组/切组与权限上下文刷新；3.8 需在此基础上扩展治理页面，不破坏既有登录与切组链路。
- Story 3.7 刚完成生命周期级联与 fail-closed 加固，当前基线强调“严格契约 + request_id 可追踪 + 不静默降级”。

### Technical Requirements（实现硬约束）

- 接口契约以 `apps/api/src/openapi.js` 为准，前端对外字段保持 `snake_case`。
- tenant 成员接口关键契约：
  - 列表：`TenantMemberListResponse`（`tenant_id/page/page_size/members/request_id`）
  - 详情：`TenantMemberDetailResponse`
  - 角色绑定：`TenantMemberRoleBindingsResponse`
- tenant 角色接口关键契约：
  - 目录：`TenantRoleListResponse`
  - 权限树：`TenantRolePermissionGrantsReadResponse` / `TenantRolePermissionGrantsWriteResponse`
- 写接口幂等要求：所有关键写操作（创建/更新/删除/分配/权限树保存）必须携带 `Idempotency-Key`。
- 错误处理统一 Problem Details：至少消费 `status/detail/error_code/request_id/retryable`；禁止吞错或本地伪成功。
- 成员角色分配硬约束：`role_ids` 数量必须在 1..5。
- 权限树保存硬约束：仅提交 `tenant.*` 最终授权（叶子）集合。

### Architecture Compliance（架构对齐清单）

- 前端边界保持：
  - `apps/web/src/features/*` 承载业务模块
  - `apps/web/src/api/*` 承载契约映射
  - `apps/web/src/components/*` 承载复用 UI
- tenant 业务落点建议：
  - `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
  - `apps/web/src/api/tenant-governance.mjs`
- 后端变更原则：
  - 本故事默认不新增 tenant 接口；若发现契约缺口，必须同步更新 `http-routes`、`route-permissions`、`openapi` 与对应测试。
- 安全边界：
  - tenant 前端只调用 tenant 域接口；不得通过 `platform.*` 角色事实影响 tenant 权限判定。

### Library & Framework Requirements（库与框架要求）

- 当前工程（apps/web / apps/api）：
  - `react 19.2.4`
  - `react-dom 19.2.4`
  - `antd 6.3.0`
  - `@ant-design/icons 6.1.0`
  - `vite 7.3.1`
  - `@vitejs/plugin-react 5.1.3`
  - `@nestjs/core 11.1.13`
  - `typeorm 0.3.28`
  - `mysql2 ^3.17.0`
  - `ioredis 5.9.2`
- 最新核验（2026-02-22）：
  - Node.js Latest LTS：`v24.13.1 (Krypton)`；Current：`v25.6.1`
  - `@vitejs/plugin-react`：`5.1.4`
  - `@nestjs/core`：`11.1.14`
  - `mysql2`：`3.17.4`
  - `ioredis`：`5.9.3`
  - `@playwright/test`：`1.58.2`
- 本故事策略：以功能交付为主，除必要 patch 升级外不做大规模依赖改造。

### File Structure Requirements（建议变更落点）

- 前端（必改）：
  - `apps/web/src/App.jsx`
  - `apps/web/src/api/tenant-governance.mjs`（新增）
  - `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`（新增）
- 前端（复用参考）：
  - `apps/web/src/api/platform-governance.mjs`
  - `apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx`
  - `apps/web/src/components/CustomCardTable.tsx`
  - `apps/web/src/components/CustomFilter.tsx`
  - `apps/web/src/components/CustomForm.tsx`
- 测试（必改）：
  - `apps/web/test/chrome.playwright.test.js`
  - `apps/web/test/server.test.js`（如新增纯函数或映射逻辑）
- 契约参考（只读）：
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`

### Testing Requirements（必须覆盖）

- AC1 成员治理：
  - 列表加载、筛选、分页、创建成员、状态切换、资料维护、详情 Drawer。
  - 成员接口错误语义映射（400/401/403/404/409/503）。
- AC2 角色治理：
  - 角色创建、编辑、删除、详情 Drawer、权限树读取/保存。
  - 受保护角色约束（403）与依赖退化（503）路径。
- AC3 分配与权限生效：
  - 成员角色分配 1..5 成功与越界失败路径。
  - 分配后 tenant 权限上下文刷新与 UI 可见性/可操作性收敛。
- AC4 Chrome 门禁：
  - 真实 Chrome 回归用例必须覆盖 Modal/Drawer/message/loading 防重复。
  - 测试失败不得标记 story 为 done。

### Previous Story Intelligence（跨故事关键信息）

- 来自 Story 3.7（上一故事）：
  - 关键链路全部采用 fail-closed，异常返回必须可追踪（`request_id` + 标准错误码）。
  - 领域服务/存储已强化“结果形状校验”，前端不得假设“部分成功”语义。
- 来自 Story 2.7（同类前端工作台）：
  - 以 `PlatformGovernanceWorkbench` 为成熟模板最稳。
  - Modal/Drawer/testid/ProblemDetails 映射与 Chrome 测试闭环已有可复用实践。
  - 权限树只提交最终授权 `permission_codes`，前端负责展示联动而非提交中间态。

### Git Intelligence Summary（最近 5 次提交模式）

- 最近 5 次提交集中在 Epic 5 的集成治理后端（contract/recovery/freeze），前端 tenant 治理暂无同类增量。
- 高频改动模块：`apps/api/src/modules/auth/*`、`apps/api/src/modules/platform/*`、`apps/api/src/openapi.js`、`apps/api/test/*`。
- 结论：3.8 前端实现应尽量复用 2.7 的模式，避免引入与当前后端主线无关的大改动。

### Latest Tech Information（Web Research Completed）

- Ant Design Drawer 官方文档明确：`width/height` 已标注建议改用 `size`，且 `size` 支持预设与自定义值。
- Playwright 官方文档明确支持 Chrome 渠道执行（`channel: 'chrome'`），可用于“真实 Chrome”门禁。
- npm registry 最新版本核验（2026-02-22）：
  - `react 19.2.4`（与当前一致）
  - `antd 6.3.0`（与当前一致）
  - `vite 7.3.1`（与当前一致）
  - `@vitejs/plugin-react 5.1.4`（当前 5.1.3，可选 patch 升级）
  - `@nestjs/core 11.1.14`（当前 11.1.13，可选 patch 升级）
  - `mysql2 3.17.4`（当前范围覆盖）
  - `ioredis 5.9.3`（当前 5.9.2，可选 patch 升级）

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事主要上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/3-7-组织软删除级联一致性.md`
  - `_bmad-output/implementation-artifacts/2-7-平台治理前端工作台-平台用户管理-平台角色管理.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed; all HIGH/MEDIUM findings fixed and validated, including tenant governance Chrome gate stabilization.`

### References

- Story 3.8 用户故事与 AC：`_bmad-output/planning-artifacts/epics.md`
- Journey 3 与 FR 基线：`_bmad-output/planning-artifacts/prd.md`
- 架构与边界约束：`_bmad-output/planning-artifacts/architecture.md`
- UX 交互与 Chrome 门禁：`_bmad-output/planning-artifacts/ux-design-specification.md`
- tenant 成员接口契约：`apps/api/src/openapi.js`
- tenant 角色接口契约：`apps/api/src/openapi.js`
- tenant 路由权限声明：`apps/api/src/route-permissions.js`
- tenant 路由常量：`apps/api/src/modules/tenant/member.constants.js`
- tenant 路由常量：`apps/api/src/modules/tenant/role.constants.js`
- 平台工作台实现参考：`apps/web/src/features/platform-governance/PlatformGovernanceWorkbench.jsx`
- 平台 API 映射参考：`apps/web/src/api/platform-governance.mjs`
- Chrome 回归参考：`apps/web/test/chrome.playwright.test.js`
- Node 发布索引：`https://nodejs.org/dist/index.json`
- Node 发布计划：`https://raw.githubusercontent.com/nodejs/Release/main/schedule.json`
- npm registry 查询（通过 `pnpm view`）：`https://registry.npmjs.org/`
- Ant Design Drawer 文档（官方仓库）：`https://raw.githubusercontent.com/ant-design/ant-design/master/components/drawer/index.en-US.md`
- Playwright Browsers 文档：`https://playwright.dev/docs/browsers`
- Playwright test options channel 文档：`https://playwright.dev/docs/api/class-testoptions`

## Senior Developer Review (AI)

### Review Date

- 2026-02-23

### Reviewer

- GPT-5 Codex（Adversarial CR）

### Outcome

- Approve（所有 HIGH/MEDIUM 问题已修复）
- Story Status：`done`
- Action Items Created：`0`

### Findings & Resolutions

- [HIGH] 成员列表筛选与分页语义不一致（筛选仅在当前页执行，`total` 计算错误）；已修复为跨页聚合筛选 + look-ahead 分页推断。`apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
- [MEDIUM] 权限刷新失败时重复错误提示（global + local message）；已通过错误标记避免二次提示。`apps/web/src/App.jsx`, `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
- [MEDIUM] 回归测试未校验分页翻页和写请求幂等头；已补全分页翻页、请求头采集与 `Idempotency-Key` 断言。`apps/web/test/chrome.playwright.test.js`
- [HIGH] tenant 治理用例对 `/auth/tenant/options` 的等待存在历史请求命中竞态，导致权限收敛断言偶发超时；已改为“记录基线计数 + 等待新增请求”。`apps/web/test/chrome.playwright.test.js`
- [MEDIUM] 角色分配后直接断言权限收敛，未先确认写接口成功响应，失败路径可产生误导；已新增 `PUT /tenant/members/:membership_id/roles` 200 响应门禁。`apps/web/test/chrome.playwright.test.js`
- [MEDIUM] 回归证据未显式反映本轮稳定性修复验证；已补齐 `pnpm --dir apps/web test` 与 `pnpm test` 最新通过结果。`_bmad-output/implementation-artifacts/3-8-组织治理前端工作台-组织成员管理-组织角色管理.md`

### AC Validation

- AC1：已实现并验证成员列表加载/筛选/分页/新增/状态切换/资料维护/详情 Drawer。
- AC2：已实现并验证角色创建/编辑/受保护角色约束/权限树读写。
- AC3：已实现并验证 1..5 角色分配与权限上下文即时收敛。
- AC4：已实现并验证真实 Chrome 门禁回归。

### Test Evidence

- `pnpm --dir apps/web lint` ✅
- `pnpm --dir apps/web test` ✅
- `pnpm test` ✅

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（CLI）

### Debug Log References

- `pnpm --dir apps/web lint`
- `pnpm --dir apps/web test`
- `pnpm test`

### Completion Notes List

- 已新增 tenant 治理 API 映射层 `apps/web/src/api/tenant-governance.mjs`，覆盖成员/角色/权限树与角色分配接口，并为所有写操作注入 `Idempotency-Key`。
- 已新增 `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`，实现成员管理与角色管理双模块，统一列表 + Modal + Drawer + message 交互，完成 Problem Details 映射。
- 已在 `apps/web/src/App.jsx` 挂载 tenant 治理工作台入口，保留组织切换流程，并在权限上下文刷新失败时执行 fail-closed（清空 tenant 权限上下文）。
- 已扩展 `apps/web/test/chrome.playwright.test.js`：新增 tenant 治理 API stub 与真实 Chrome 回归用例，覆盖成功/失败/越权路径及权限收敛链路。
- 已完成 adversarial CR 修复：成员筛选分页语义、权限刷新失败噪音提示、Chrome 分页与幂等头断言。
- 已修复 tenant 治理 Chrome 门禁竞态：角色分配后权限刷新必须等待“新增 `/auth/tenant/options` 请求 + 角色分配 200 响应”。
- 回归结果：`apps/web` lint/test 通过；仓库级 `pnpm test` 通过。

### File List

- `_bmad-output/implementation-artifacts/3-8-组织治理前端工作台-组织成员管理-组织角色管理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/web/src/App.jsx`
- `apps/web/src/api/tenant-governance.mjs`
- `apps/web/src/features/tenant-governance/TenantGovernanceWorkbench.jsx`
- `apps/web/test/chrome.playwright.test.js`

### Change Log

- 2026-02-22：创建 Story 3.8 上下文文档并标记 `ready-for-dev`，补齐 tenant 前端治理闭环的实现护栏、测试门禁与外部版本核验。
- 2026-02-22：完成 Story 3.8 开发实现并更新为 `review`，交付 tenant 治理工作台、API 封装、真实 Chrome 回归与 fail-closed 权限收敛链路。
- 2026-02-23：完成 CR（3-8 自动继续）并修复 3 项问题：成员分页筛选语义、权限刷新错误提示去重、Chrome 分页与幂等头门禁；状态更新为 `done`。
- 2026-02-23：补充 CR 稳定性修复：解决 tenant Chrome 回归中历史请求命中竞态，新增角色分配成功响应门禁，并完成 `pnpm --dir apps/web test` 与 `pnpm test` 全量验证。
