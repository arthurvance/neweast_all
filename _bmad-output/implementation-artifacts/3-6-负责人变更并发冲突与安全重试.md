# Story 3.6: 负责人变更并发冲突与安全重试

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台治理操作者,  
I want 负责人变更在并发场景下返回可识别冲突并支持安全重试,  
so that 高风险链路可恢复且保持事务一致性。

## Acceptance Criteria

1. **Given** 同一组织存在并发负责人变更请求  
   **When** 请求同时到达  
   **Then** 系统仅允许一个请求成功  
   **And** 其余请求返回可识别冲突结果
2. **Given** 请求因并发冲突失败  
   **When** 操作者按指引重试  
   **Then** 系统支持安全重试并保持结果一致  
   **And** 不产生重复或脏关系写入
3. **Given** 变更链路执行中发生异常  
   **When** 事务结束  
   **Then** 系统满足全成功或全回滚  
   **And** 审计中可追踪冲突与恢复过程

## Tasks / Subtasks

- [x] 任务 1：收敛并发冲突语义与稳定响应契约（AC: 1, 2）
  - [x] 对同组织并发请求统一返回 `ORG-409-OWNER-TRANSFER-CONFLICT`，并保持 `retryable=true`、`result_status='conflict'`。
  - [x] 锁冲突、上游冲突、预条件冲突的对外语义统一为可识别冲突；非冲突错误继续走 `ORG-503-DEPENDENCY-UNAVAILABLE`。
  - [x] 保持负责人变更 7 字段响应契约稳定：`request_id/org_id/old_owner_user_id/new_owner_user_id/result_status/error_code/retryable`。

- [x] 任务 2：完善安全重试与幂等协同策略（AC: 1, 2）
  - [x] `POST /platform/orgs/owner-transfer` 的重试型冲突（409 + retryable=true）不得进入幂等重放缓存。
  - [x] 同幂等键同载荷成功结果可重放；同幂等键异载荷保持 `AUTH-409-IDEMPOTENCY-CONFLICT`。
  - [x] 冲突后重试必须可再次进入执行链路，且成功后返回 accepted 语义，不受上一次冲突污染。

- [x] 任务 3：固化事务一致性与无脏写保障（AC: 2, 3）
  - [x] 在 `executeOwnerTransferTakeover` 持续使用事务内 `FOR UPDATE` + precondition（`old_owner_user_id`）校验。
  - [x] 负责人切换、成员关系收敛、角色绑定、权限快照同步维持同事务提交，失败统一回滚。
  - [x] 复用并保持 MySQL `GET_LOCK/RELEASE_LOCK` 串行化语义，避免跨实例同组织并发双写。

- [x] 任务 4：补齐冲突/重试可观测与审计证据（AC: 2, 3）
  - [x] 审计事件最小集：`initiated/conflict/rejected/submitted`，包含 `request_id/org_id/error_code/retryable/upstream_error_code`。
  - [x] 冲突后重试成功需可从审计链路关联同组织同阶段事件，支持事后排障。
  - [x] 维持错误返回 Problem Details 扩展字段一致性，避免前端恢复路径分叉。

- [x] 任务 5：契约文档与门禁同步（AC: 1, 2, 3）
  - [x] OpenAPI 明确负责人变更冲突与可重试示例，保持 `retryable` 含义稳定。
  - [x] 路由权限声明保持 `platform.member_admin.operate`，禁止回退受保护接口声明覆盖。
  - [x] 门禁侧补齐/更新并发冲突重试专项用例，纳入发布阻断集合。

- [x] 任务 6：回归矩阵（必须覆盖 AC 与高风险回归）
  - [x] 并发同组织双请求：严格 `200 + 409`，冲突返回标准错误码。
  - [x] 冲突后重试：后续请求可成功，且不产生重复成员关系/角色绑定写入。
  - [x] 跨实例并发：共享锁后端下保持同组织冲突一致性。
  - [x] 幂等行为：成功重放、载荷冲突拒绝、重试型冲突不缓存。
  - [x] 事务回滚：注入故障验证 `owner/membership/role/permission` 无半成功落库。

### Review Follow-ups (AI)

- [x] [AI-Review][MEDIUM] `org.owner_transfer.conflict` 在锁返回 `false` 的冲突分支缺少 `upstream_error_code`，导致冲突审计载荷字段不一致（已补齐为 `AUTH-409-OWNER-TRANSFER-CONFLICT`）。[`apps/api/src/modules/platform/org.service.js:1238`]
- [x] [AI-Review][MEDIUM] Story `File List` 未覆盖当前 git 工作区中的实际变更文件（缺少 `3-5` 文档条目），已补齐。[`_bmad-output/implementation-artifacts/3-6-负责人变更并发冲突与安全重试.md:233`]
- [x] [AI-Review][LOW] Story 内 `Story Completion Status` 与顶部 `Status` 不一致，已统一为完成状态。[`_bmad-output/implementation-artifacts/3-6-负责人变更并发冲突与安全重试.md:167`]
- [x] [AI-Review][MEDIUM] `0017` 迁移在同连接重试场景可能复用旧临时表数据（`CREATE TEMPORARY TABLE IF NOT EXISTS`），已在迁移开头补 `DROP TEMPORARY TABLE IF EXISTS` 并新增基线断言。[`apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql:1`]
- [x] [AI-Review][MEDIUM] `org.owner_transfer.rejected` 在“鉴权失败/载荷校验失败”分支缺少 `upstream_error_code`，导致 rejected 审计字段集合不一致；已补齐并新增回归断言。[`apps/api/src/modules/platform/org.service.js:1141`][`apps/api/test/platform.org.api.test.js:1600`]
- [x] [AI-Review][MEDIUM] takeover 返回畸形结果时存在“双重 rejected 审计”风险（分支先写审计再抛错，catch 再写一次），并导致该路径字段一致性不可控；已收敛为单次审计并固定 `retryable/upstream_error_code`，新增回归用例覆盖该路径且断言 rejected 事件数为 1。[`apps/api/src/modules/platform/org.service.js:1286`][`apps/api/test/platform.org.api.test.js:1847`]
- [x] [AI-Review][MEDIUM] owner-transfer 锁后端能力检查存在“单边方法注入”隐患：仅存在 `releaseOwnerTransferLock` 时会导致本地锁无法释放并持续冲突。已改为仅在 `acquire/release` 成对存在时启用外部锁，否则回退进程内锁，并补回归测试覆盖。[`apps/api/src/modules/platform/org.service.js:552`][`apps/api/test/platform.org.api.test.js:157`]
- [x] [AI-Review][MEDIUM] MySQL `executeOwnerTransferTakeover` 在新负责人成员状态为 `left` 的重入路径中，历史归档读取列不全，可能导致 `auth_user_tenant_membership_history` 快照字段缺失。已补齐 membership 读取列并新增回归测试锁定归档字段完整性。[`apps/api/src/modules/auth/auth.store.mysql.js:3487`][`apps/api/test/auth.store.mysql.test.js:3303`]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 3.5 已交付“负责人变更接管闭环”，本故事是并发冲突与安全重试加固，不是重写接管流程。
- 当前主链路已具备：平台入口 `ownerTransfer`、auth 域 `executeOwnerTransferTakeover`、store 事务写入、审计事件落点。
- 现有测试已覆盖基础并发冲突与部分重试语义，本故事需把“冲突可识别 + 可安全重试 + 无脏写”作为发布级约束收敛到位。

### Technical Requirements（实现硬约束）

- 本故事直接覆盖：`FR54`、`FR71`，并与 `FR76`（前置校验）协同执行。
- 必须遵守关键写接口约束：`Idempotency-Key`、Problem Details、`error_code/request_id/retryable`。
- 冲突语义与失败语义必须可区分：冲突走 `ORG-409-OWNER-TRANSFER-CONFLICT`，依赖故障走 `ORG-503-DEPENDENCY-UNAVAILABLE`。
- 变更链路必须保证全成功/全回滚，半成功计数目标为 0（NFR12）。
- 冲突后重试必须不重复写入、不破坏一致性（NFR14）。

### Architecture Compliance（架构对齐清单）

- 模块边界不变：
  - `modules/platform/org.service`：入口编排、错误映射、审计事件。
  - `modules/auth/auth.service`：并发语义映射、领域校验聚合。
  - `modules/auth/auth.store.mysql|memory`：事务原子写与锁实现。
- 错误结构统一通过 Problem Details 扩展输出，保持 `retryable` 语义稳定。
- 并发串行化与幂等必须平台级统一，不得新增旁路实现。
- 审计事件保留 `request_id` 贯穿，支持冲突与恢复追踪。

### Library & Framework Requirements（库与框架要求）

- 当前工程版本（`apps/api/package.json`）：
  - `@nestjs/core` `11.1.13`
  - `typeorm` `^0.3.28`
  - `mysql2` `^3.17.0`
  - `ioredis` `5.9.2`
- 最新稳定校验（2026-02-20）：
  - `@nestjs/core` `11.1.14`（patch 可升级）
  - `typeorm` `0.3.28`（已对齐）
  - `mysql2` `3.17.3`（patch 可升级）
  - `ioredis` `5.9.3`（patch 可升级）
- 本故事优先交付并发/一致性能力，不强制版本升级；若升级仅允许 patch 级并需回归全量关键链路。

### File Structure Requirements（建议变更落点）

- 平台入口与契约映射：
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/platform/org.routes.js`
  - `apps/api/src/openapi.js`
- 领域并发与事务落点：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 幂等与请求处理：
  - `apps/api/src/server.js`
  - `apps/api/src/modules/auth/auth.idempotency.redis.js`
- 测试：
  - `apps/api/test/platform.org.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（必须覆盖）

- AC1：
  - 同组织并发双请求只允许一个成功，另一个冲突。
  - 跨实例共享锁后端下同样满足冲突语义。
- AC2：
  - 冲突后重试可成功，不产生重复成员关系/角色绑定/权限快照写入。
  - 幂等键策略满足“成功可重放、重试型冲突不缓存、异载荷冲突拒绝”。
- AC3：
  - 注入中途失败验证全链路回滚，无 owner 与关系分叉。
  - 审计日志可完整追踪冲突与恢复过程，并保持 request_id 关联。

### Previous Story Intelligence（跨故事关键信息）

- Story 3.5 已完成 `executeOwnerTransferTakeover` 与接管闭环，不可重复造轮子。
- 3.5 已修复多个高风险点（接管角色租户隔离、成员关系 duplicate 竞态容错、迁移冲突守卫）；3.6 必须在此基线上扩展并发重试，不得回退这些修复。
- 入口契约已被多轮回归固定，3.6 需“补语义与补门禁”，不是“改协议字段”。

### Git Intelligence Summary（最近 5 次提交模式）

- 最近提交集中在 `platform/org`、`auth service/store`、`openapi`、`server` 与 `test/*`。
- 模式结论：
  - 先收敛主链路语义，再做 fail-closed 与竞态兜底，最后补齐契约/测试/门禁。
  - 负责人变更链路历史上问题主要来自“并发窗口 + 映射语义 + 事务边界”，本故事需重点防回归这些点。

### Latest Tech Information（外部最新信息）

- Node.js：当前最新 LTS 为 `v24.13.1`（Krypton），工程 `engines.node >=24.0.0` 与之兼容。
- MySQL 8.4：官方 8.4 LTS 发布说明当前含 `8.4.8`（2026-01-20）；并发锁实现应持续遵循官方 `GET_LOCK/RELEASE_LOCK` 语义：
  - `GET_LOCK(name, timeout)`：成功 `1`，超时 `0`，错误 `NULL`
  - 锁为会话级独占锁，获取顺序未定义，且不随事务提交/回滚自动释放
- NestJS / TypeORM / ioredis / mysql2：均存在更高 patch 版本，故事实现要避免依赖未验证升级行为。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文来源以 `epics.md`、`prd.md`、`architecture.md`、`prd-appendix-legacy-inputs.md`、`ux-design-specification.md`、以及 `3-5` 交付文档与当前代码为准。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code-review completed; conflict audit payload shape aligned across lock conflict branches, story records synchronized with git reality, and regression gates for Story 3.6 remain passing.`

### References

- 用户故事与验收条件：`_bmad-output/planning-artifacts/epics.md`（Story 3.6）
- 旅程与高风险门禁：`_bmad-output/planning-artifacts/prd.md`（Journey 4, FR54, FR71, NFR12, NFR14）
- 串行化与事务规则：`_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`（Owner Transfer Rules）
- 架构边界与幂等规范：`_bmad-output/planning-artifacts/architecture.md`
- UX 冲突恢复路径：`_bmad-output/planning-artifacts/ux-design-specification.md`
- 上一故事经验：`_bmad-output/implementation-artifacts/3-5-负责人变更后的接管保障.md`
- 当前实现落点：
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/server.js`
  - `apps/api/test/platform.org.api.test.js`
- 外部技术来源：
  - Node.js 发布索引：`https://nodejs.org/dist/index.json`
  - MySQL 8.4 Release Notes：`https://docs.oracle.com/cd/E17952_01/mysql-8.4-relnotes-en/`
  - MySQL 锁函数文档：`https://dev.mysql.com/doc/refman/8.4/en/locking-functions.html`
  - NestJS releases：`https://github.com/nestjs/nest/releases`
  - TypeORM releases：`https://github.com/typeorm/typeorm/releases`
  - ioredis releases：`https://github.com/redis/ioredis/releases`
  - mysql2 releases：`https://github.com/sidorares/node-mysql2/releases`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.store.mysql.test.js test/platform.org.api.test.js test/server.test.js test/migrate-baseline.test.js`（pass）
- `pnpm --dir apps/api test`（pass，883/883）
- `pnpm --dir apps/api exec node --test --test-force-exit test/migrate-baseline.test.js`（pass，29/29）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.store.mysql.test.js test/platform.org.api.test.js test/server.test.js test/migrate-baseline.test.js`（pass，522/522）
- `pnpm --dir apps/api test`（pass，883/883）
- `pnpm --dir apps/api lint`（pass）
- `pnpm --dir apps/api run check:route-permissions`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js`（pass，104/104）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js`（pass，249/249）
- `pnpm --dir apps/api exec node --test --test-force-exit test/platform.org.api.test.js`（pass，79/79）
- `pnpm --dir apps/api lint`（pass）
- `pnpm --dir apps/api run check:route-permissions`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.store.mysql.test.js test/platform.org.api.test.js test/server.test.js test/migrate-baseline.test.js`（pass，526/526）
- `pnpm --dir apps/api lint`（pass）
- `pnpm --dir apps/api run check:route-permissions`（pass）

### Implementation Plan

- 在 `platform/org` 入口保持 7 字段稳定响应契约，统一并发冲突到 `ORG-409-OWNER-TRANSFER-CONFLICT`，并透传 `retryable/result_status`。
- 在 `auth.service` 新增 `executeOwnerTransferTakeover` 编排，收敛 precheck + store 事务执行 + 错误码映射 + 审计。
- 在 `auth.store.mysql|memory` 固化 takeover 原子流程：`FOR UPDATE` precondition、角色/成员/权限快照同事务、失败回滚。
- 门禁补齐：API/服务/存储层并发冲突、重试、回滚、角色冲突与畸形回包 fail-closed；OpenAPI 契约文案同步。
- 增加迁移 `0017`，将 legacy `tenant_owner` 绑定收敛至按租户 hash 的 takeover role id，并提供 no-op down 标记。

### Completion Notes List

- 已完成 AC1：同组织并发冲突统一映射为 `ORG-409-OWNER-TRANSFER-CONFLICT`，冲突返回 `result_status='conflict'`、`retryable=true`，并保持 7 字段稳定响应契约。
- 已完成 AC2：重试型冲突不写入幂等回放缓存；同键同载荷成功可重放；同键异载荷保持 `AUTH-409-IDEMPOTENCY-CONFLICT`；冲突后重试可再次执行并返回 accepted。
- 已完成 AC3：`executeOwnerTransferTakeover` 在 mysql/memory store 均使用 precondition + 原子写路径；注入故障验证 owner/membership/role/permission 无半成功脏写。
- 已补齐可观测性：冲突/拒绝/提交等审计事件包含 `request_id/org_id/error_code/retryable/upstream_error_code`，并覆盖冲突后重试关联。
- 已完成契约与门禁同步：OpenAPI owner-transfer 描述更新；路由权限声明保持 `platform.member_admin.operate`；并发重试专项用例纳入回归并通过。
- 代码审查修复：补齐锁返回 `false` 冲突分支的 `upstream_error_code` 审计字段，并新增回归测试覆盖该分支，确保冲突审计字段集合稳定一致。
- 代码审查修复：`0017` 迁移新增“先清理临时表再建表”防护，避免同连接重试复用旧临时表导致迁移输入集污染。
- 代码审查修复：补齐 `owner_transfer.rejected` 在鉴权失败与载荷校验失败路径的 `upstream_error_code`，并新增回归断言固定字段输出。
- 代码审查修复：收敛 takeover 返回畸形结果路径为单次 rejected 审计，避免重复写审计事件并统一 `retryable/upstream_error_code` 字段；新增 rejected 事件数量断言避免回归。
- 代码审查修复：收敛 owner-transfer 锁后端能力检查，仅在 `acquire/release` 成对存在时使用外部锁，避免单边注入导致本地锁残留冲突；新增回归用例锁定该行为。
- 代码审查修复：补齐 MySQL takeover 在 `left` 成员重入时的 membership 读取列，避免历史归档快照字段缺失；新增回归测试断言历史记录字段完整性。

### Senior Developer Review (AI)

- 审查范围：Story 3.6 相关实现文件（`platform/org.service`、`auth.service`、`auth.store.mysql|memory`、`openapi`、`server`、迁移与对应测试）。
- 结果：已完成对抗式审查并落地修复，未保留未解决的 HIGH/MEDIUM 问题。
- 关键修复：`POST /platform/orgs/owner-transfer` 在锁冲突 `false` 返回路径统一补齐 `upstream_error_code`，并通过测试锁定。
- 关键修复：`0017` 迁移增加临时表预清理，避免重试场景下的临时表脏数据复用风险。
- 关键修复：`POST /platform/orgs/owner-transfer` 在 rejected 审计的鉴权失败/载荷校验失败路径补齐 `upstream_error_code`，保证 rejected 事件字段稳定一致。
- 关键修复：`POST /platform/orgs/owner-transfer` 在 takeover 畸形结果路径避免重复 rejected 审计，保持审计链路单事件可追踪与字段一致。
- 关键修复：`POST /platform/orgs/owner-transfer` 对锁后端采用成对能力门禁（`acquire/release`），避免单边注入造成锁释放偏差与持续冲突。
- 关键修复：`executeOwnerTransferTakeover`（MySQL）在 `left` 成员重入路径补齐归档输入字段，确保 membership history 快照完整可追溯。
- 2026-02-20 自动复核：基于当前工作区变更再次执行 CR 与门禁，未发现新增 HIGH/MEDIUM/LOW 问题；故事状态保持 `done`。

### File List

- `_bmad-output/implementation-artifacts/3-6-负责人变更并发冲突与安全重试.md`
- `_bmad-output/implementation-artifacts/3-5-负责人变更后的接管保障.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/src/modules/platform/org.service.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.org.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.sql`
- `apps/api/migrations/0017_owner_transfer_takeover_role_cleanup.down.sql`

## Change Log

- 2026-02-20：完成 Story 3.6 并发冲突语义收敛、安全重试与幂等协同、事务一致性加固、审计链路补齐、OpenAPI 同步与回归门禁覆盖；状态更新为 `review`。
- 2026-02-20：完成代码审查闭环（CR）；修复锁返回 `false` 冲突分支审计字段缺口，补充冲突审计一致性测试，更新文档状态与文件清单；状态更新为 `done`。
- 2026-02-20：继续二轮审查；修复 `0017` 迁移同连接重试可能复用旧临时表数据的问题，并补充迁移基线断言。
- 2026-02-20：继续三轮审查；修复 rejected 审计在鉴权失败/载荷校验失败路径缺失 `upstream_error_code` 的问题，并补充回归断言。
- 2026-02-20：继续四轮审查；修复 takeover 畸形结果路径重复写 rejected 审计的问题，并补充单次审计字段一致性回归。
- 2026-02-20：继续五轮审查；补充 takeover 畸形结果路径 rejected 事件数量断言（固定为 1），防止重复审计回归。
- 2026-02-20：继续六轮审查；修复 owner-transfer 锁后端单边能力注入导致的本地锁残留风险，新增成对能力门禁与回归测试。
- 2026-02-20：继续七轮审查；修复 MySQL takeover 在 `left` 成员重入路径历史归档字段缺失风险，补齐 membership 查询列并新增回归测试。
- 2026-02-20：自动继续执行代码审查（CR 3-6）；复核 `owner-transfer` 主链路、迁移与回归门禁，未发现新增问题，状态保持 `done`。
