# Story 2.1: 组织创建与初始负责人校验

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 创建组织时必须提交初始管理员手机号,  
so that 每个组织在创建后都可被立即治理与接管。

## Acceptance Criteria

1. 平台管理员发起创建组织时，若未提交初始管理员手机号，系统拒绝创建并返回标准错误码与可理解提示。
2. 平台管理员提交有效组织信息与初始管理员手机号后，系统创建组织并建立负责人治理关系，组织进入可管理状态。
3. 创建过程中若初始管理员手机号已存在用户身份，系统复用既有用户身份，不重复创建全局用户账号。

## Tasks / Subtasks

- [x] 任务 1：组织与负责人关系数据建模落地（AC: 2, 3）
  - [x] 新增迁移（建议 `0008_platform_org_bootstrap.sql`）创建最小可用表结构：`orgs`、`memberships`（或与现有模型等价的数据结构），并建立 `orgs.owner_user_id` 关系约束与必要索引。
  - [x] 保持与现有 `users.phone` 唯一约束一致，确保“手机号唯一身份”可被复用。
  - [x] 提供对应 down migration，保持 `migrate` / `migrate:down` 可回滚一致性。

- [x] 任务 2：实现平台侧创建组织接口（AC: 1, 2）
  - [x] 新增平台组织创建路由（建议 `POST /platform/orgs`），并接入现有路由分发链路（`http-routes.js` + `route-permissions.js`）。
  - [x] 强制校验 `initial_owner_phone` 必填；缺失时返回标准 Problem Details 错误（`application/problem+json`）。
  - [x] 组织创建成功后返回 `org_id`、`owner_user_id`、`request_id` 等最小可追踪字段。

- [x] 任务 3：初始负责人身份复用与治理关系建立（AC: 2, 3）
  - [x] 若手机号已存在：复用已有 `user`，不得重置密码或变更既有凭据。
  - [x] 若手机号不存在：按既有默认密码策略创建用户（仅落 `password_hash`，不落明文），并与组织建立负责人关系。
  - [x] 组织创建 + 负责人关系建立必须在同一事务内提交，失败时整体回滚。

- [x] 任务 4：契约、权限声明与审计闭环（AC: 1, 2）
  - [x] 在 `route-permissions` 中声明新受保护路由权限（建议先复用 `platform.member_admin.operate`，避免破坏当前权限评估器）。
  - [x] 更新 `openapi.js`：新增请求/响应 schema、错误码示例、Problem Details 结构示例。
  - [x] 记录审计事件（至少覆盖：创建成功、校验失败），并包含 `request_id` 与关键主体字段。

- [x] 任务 5：测试与门禁（AC: 1, 2, 3）
  - [x] 新增 API 测试覆盖：必填校验失败、成功创建、新旧手机号复用分支。
  - [x] 新增幂等/重复提交测试（若接口纳入关键写接口幂等范围）。
  - [x] 通过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`。

### Review Follow-ups (AI)

- [x] [AI-Review][Medium] 创建组织 payload 未拒绝未知字段，和 OpenAPI `additionalProperties=false` 契约不一致，已修复为严格校验。 [`apps/api/src/modules/platform/org.service.js`]
- [x] [AI-Review][Medium] `POST /platform/orgs` OpenAPI 缺少已实现的 503 依赖不可用响应契约，已补充响应与示例。 [`apps/api/src/openapi.js`]
- [x] [AI-Review][Low] 组织创建缺少“未知字段/重复创建冲突”负向测试覆盖，已补齐并纳入回归。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][High] 组织创建存储层出现非预期故障时会透传为 500，和 `ORG-503-DEPENDENCY-UNAVAILABLE` 契约不一致；已统一映射为标准 503 问题详情。 [`apps/api/src/modules/platform/org.service.js`]
- [x] [AI-Review][High] 新手机号路径下若“建组织”失败，已创建的 owner 用户未回滚，存在孤立身份残留风险；已接入安全回滚能力。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/src/modules/auth/auth.service.js`]
- [x] [AI-Review][Medium] 缺少“依赖不可用 503”与“失败后 owner 身份回滚”回归测试，已补齐 API 级断言。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `org.service` 通过 `authService._internals.authStore` 访问私有实现，造成模块耦合与替换风险；已改为公共能力 `authService.createOrganizationWithOwner`。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/src/modules/auth/auth.service.js`]
- [x] [AI-Review][Medium] `createOrganizationWithOwner` 未校验事务写入 `affectedRows`，异常情况下可能误报成功；已补充写入结果断言与回归测试。 [`apps/api/src/modules/auth/auth.store.mysql.js`] [`apps/api/test/auth.store.mysql.test.js`]
- [x] [AI-Review][Low] OpenAPI `CreatePlatformOrgResponse` 未声明 `additionalProperties=false`，响应契约过宽；已收紧并补充契约断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 缺少 `org_name` 缺失与 `initial_owner_phone` 格式错误的回归断言，AC1 边界覆盖不足；已补齐 API 级测试。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `POST /platform/orgs` 在路由层与服务层重复调用 `authorizeRoute`，造成重复鉴权开销与审计噪声；已改为优先复用预授权上下文，仅在缺失上下文时回退鉴权。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `org.create.rejected`（payload 校验失败）审计事件未携带可得的 `operator_user_id`，不满足关键主体字段最小集；已补齐操作者提取与记录。 [`apps/api/src/modules/platform/org.service.js`]
- [x] [AI-Review][Medium] `/platform/orgs` 未纳入写接口幂等保护，重复提交会放大重复创建冲突风险；已接入 `Idempotency-Key` 保护与同键冲突语义，并补齐回归。 [`apps/api/src/server.js`] [`apps/api/src/openapi.js`] [`apps/api/test/platform.org.api.test.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` 的 OpenAPI 400 示例缺少 `retryable` 字段，和统一 Problem Details 契约不一致；已补齐并新增幂等错误示例断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][High] 初始负责人身份引导失败时会透传 `AUTH-503-*`，导致 `/platform/orgs` 503 错误码与 OpenAPI 契约漂移；已统一映射为 `ORG-503-DEPENDENCY-UNAVAILABLE` 并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] 初始负责人引导冲突会透传 `AUTH-409-PROVISION-CONFLICT`，与组织创建接口冲突语义不一致；已统一映射为 `ORG-409-ORG-CONFLICT` 并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] 无预授权上下文时，payload 校验先于操作者解析，导致拒绝审计 `operator_user_id` 可能退化为 `unknown`；已调整为先解析操作者再校验并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` 的 `idempotency_store_unavailable` OpenAPI 文案与运行时 503 详情不一致；已对齐文案并新增契约断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `/platform/orgs` OpenAPI 缺少已实现的 `413 Payload Too Large` 响应，契约与运行时行为不一致；已补齐 413 响应与示例。 [`apps/api/src/openapi.js`]
- [x] [AI-Review][Medium] 缺少 `/platform/orgs` 大 payload 场景的 413 运行时回归，`AUTH-413-PAYLOAD-TOO-LARGE` 统一错误码无端到端保护；已补齐 server 级断言。 [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 缺少 `/platform/orgs` OpenAPI 413 示例错误码断言，文档回归保护不足；已补齐契约断言。 [`apps/api/test/server.test.js`]
- [x] [AI-Review][High] `/platform/orgs` 在 payload 校验失败（400）时仍会占用 `Idempotency-Key`，导致同键修正请求被误判冲突；已改为仅缓存可持久语义响应并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `createOrganizationWithOwner` 未接入死锁重试，热点并发下 `ER_LOCK_DEADLOCK` 会直接失败；已接入重试并补齐恢复/耗尽断言。 [`apps/api/src/modules/auth/auth.store.mysql.js`] [`apps/api/test/auth.store.mysql.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` OpenAPI 缺少 401/403 问题详情示例，错误码契约表达不完整；已补齐示例并增加契约断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `org.service` 会信任未标记的外部 `authorizationContext` 并跳过回退鉴权，存在服务层误用绕过风险；已引入内部预授权标记校验，未命中时强制回退 `authorizeRoute`。 [`apps/api/src/server.js`] [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] in-memory `createOrganizationWithOwner` 未对 `org_name` 超长行为对齐 MySQL，测试双后端语义不一致；已补齐 `ER_DATA_TOO_LONG` 对齐。 [`apps/api/src/modules/auth/auth.store.memory.js`] [`apps/api/test/auth.service.test.js`]
- [x] [AI-Review][Low] 缺少“组织创建写入长度异常时 owner 身份回滚”回归保护；已补齐 API 级断言。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] 幂等“非持久响应不缓存”策略被全局应用到 legacy 路由，改变既有接口同键复用语义，存在兼容性回归风险；已改为按路由策略，仅 `/platform/orgs` 启用该释放规则，并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` 的 `Idempotency-Key` OpenAPI 描述仍沿用“同键不同载荷必冲突”笼统语义，与 400 不占键实现不一致；已修正文案并补齐契约断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 预授权上下文字段在 `server.js` 与 `org.service.js` 以魔法字符串重复定义，存在维护漂移风险；已抽取共享常量模块统一引用。 [`apps/api/src/modules/auth/route-preauthorization.js`] [`apps/api/src/server.js`] [`apps/api/src/modules/platform/org.service.js`]
- [x] [AI-Review][Medium] `createPlatformOrgHandlers` 允许在缺少 `createOrg` 依赖时延迟到运行期失败，存在隐式依赖注入风险；已改为构造期 fail-fast 并补齐回归。 [`apps/api/src/modules/platform/org.routes.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `org.service` 的 `_internals.auditTrail` 无限增长，长时间运行存在内存膨胀风险；已增加上限裁剪并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` OpenAPI 的 503 幂等错误示例缺少运行时已返回的 `degradation_reason` 字段，契约表达不完整；已补齐文档示例与断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `createOrg` 将 `initial_owner_phone` 非字符串值误判为“缺失必填”，导致错误码语义漂移；已改为类型敏感校验并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `org_name` 非字符串值会被误归类为“缺失”，错误信息不准确；已改为显式类型校验并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] 预授权标记使用 `Symbol.for` 可被同 key 伪造，服务层存在被动信任风险；已改为进程内私有 `Symbol` 并补齐伪造回归。 [`apps/api/src/modules/auth/route-preauthorization.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `createRouteHandlers` 默认装配路径未复用同一 `authService`，`/platform/orgs` 与幂等审计可能出现依赖实例漂移；已统一共享实例并补齐回归。 [`apps/api/src/http-routes.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `createPlatformOrgHandlers` 在已标记预授权上下文且无 `Authorization` 头时仍强制解析 Bearer，导致内部受信调用误报 401；已按预授权标记放行并补齐回归。 [`apps/api/src/modules/platform/org.routes.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] 回归边界：仅注入 `platformOrgService` 时，`createRouteHandlers` 仍可能退回到新建 `authService`，导致 `/platform/orgs` 与幂等审计实例漂移；已改为优先复用 `platformOrgService._internals.authService` 并补齐回归。 [`apps/api/src/http-routes.js`] [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 回归边界：已标记预授权上下文在携带畸形 `Authorization` 头时仍会触发 Bearer 解析并误报 401；已改为“预授权优先”并补齐回归。 [`apps/api/src/modules/platform/org.routes.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `recordIdempotencyEvent` 对未知 `outcome` 默认归类为 `hit`，会污染幂等命中审计；已改为 `unknown` 分类并补齐回归。 [`apps/api/src/modules/auth/auth.service.js`] [`apps/api/test/auth.service.test.js`]
- [x] [AI-Review][Medium] `createRouteHandlers` 在同时注入 `authService` 与 `platformOrgService` 且二者实例不一致时未 fail-fast，可能导致鉴权/审计与组织创建使用不同服务实例；已增加一致性断言并补齐回归。 [`apps/api/src/http-routes.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 缺少 `/platform/orgs` 在幂等存储不可用时的运行时回归，路由级 503 退化语义缺乏保护；已补齐 API 级断言与审计事件校验。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] 缺少 `/platform/orgs` 在幂等 pending 超时时的运行时回归，`AUTH-503-IDEMPOTENCY-PENDING-TIMEOUT` 与 `degradation_reason` 无端到端保护；已补齐 API 级断言与审计事件校验。 [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `org.routes` 对预授权上下文仅按标记位放行，缺少完整上下文校验，可能错误跳过 Bearer 回退鉴权；已改为通过共享解析器严格校验后再放行。 [`apps/api/src/modules/platform/org.routes.js`] [`apps/api/src/modules/auth/route-preauthorization.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] 默认幂等存储在无显式注入时落到全局单例，跨 handlers 实例会发生状态串扰；已按 `authService/handlers` 作用域隔离默认存储。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 受保护路由未拒绝歧义 `Authorization` 头（多值/逗号拼接），存在鉴权语义不确定性；已在预鉴权前统一拒绝为 `AUTH-401-INVALID-ACCESS`。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][High] `org.service` 未强制依赖 `rollbackProvisionedUserIdentity`，在注入缺失该能力的 `authService` 时会破坏“新建 owner 失败可回滚”原子性；已改为 fail-fast 并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][High] 组织创建写入失败后若 owner 回滚再次失败，接口仍可能返回 409/400 掩盖“部分副作用未清理”；已改为回滚失败统一收敛 `ORG-503-DEPENDENCY-UNAVAILABLE` 并补齐审计与回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Low] `auth.service` 的 `_internals.auditTrail` 无上限，长跑场景存在内存膨胀风险；已增加上限裁剪并补齐回归。 [`apps/api/src/modules/auth/auth.service.js`] [`apps/api/test/auth.service.test.js`]
- [x] [AI-Review][High] `rollbackProvisionedUserIdentity` 会吞掉 guard/delete 失败，导致 `org.service` 的 owner 回滚 fail-closed 在真实 `auth.service` 上可能退化；已改为严格模式下失败即抛错。 [`apps/api/src/modules/auth/auth.service.js`]
- [x] [AI-Review][Medium] `auth.service` 回滚路径使用不存在的 `log.warn`，异常分支会抛出 `TypeError` 并污染错误语义；已统一改为 `log('warn', ...)`。 [`apps/api/src/modules/auth/auth.service.js`]
- [x] [AI-Review][Low] 缺少 owner 身份回滚 guard/delete 失败的严格语义回归，存在未来回归风险；已补齐单测覆盖。 [`apps/api/test/auth.service.test.js`]
- [x] [AI-Review][High] `createRouteHandlers` 在未注入 `dependencyProbe` 时会调用 `undefined` 导致健康检查路径崩溃；已回退默认探针 `checkDependencies` 并补齐回归。 [`apps/api/src/http-routes.js`] [`apps/api/test/http-routes.test.js`]
- [x] [AI-Review][Medium] `health`/`smoke` 对探针异常缺少隔离，`dependencyProbe` 抛错会放大为 500；已改为降级响应并补齐回归。 [`apps/api/src/http-routes.js`] [`apps/api/test/http-routes.test.js`]
- [x] [AI-Review][Low] `health`/`smoke` 未规范化畸形依赖快照，`db/redis` 缺失时会触发 `TypeError`；已增加快照归一化与断言。 [`apps/api/src/http-routes.js`] [`apps/api/test/http-routes.test.js`]

- [x] [AI-Review][Medium] `createApiApp` 全量门禁中 `AUTH-500-INTERNAL` 回归断言仍基于 `/health` 旧语义，导致测试期望与降级实现漂移并触发红灯；已拆分为“/health 降级 503”与“真实全局 500”两类断言。 [`apps/api/test/auth.express.api.test.js`]
- [x] [AI-Review][Medium] `dependencyProbe` 抛错时 `health`/`smoke` 会回显原始异常文本，存在内部错误细节暴露风险；已统一收敛为固定降级详情。 [`apps/api/src/http-routes.js`] [`apps/api/test/http-routes.test.js`] [`apps/api/test/auth.express.api.test.js`]
- [x] [AI-Review][Low] OpenAPI 对 `/health` 与 `/smoke` 的响应结构描述过于宽泛，未显式声明运行时已返回的依赖探针字段（`mode`/`detail`）；已补齐契约并新增断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 未声明路由返回 404 时缺少 `error_code`，Problem Details 契约表达不完整；已补充 `AUTH-404-NOT-FOUND` 并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 声明路径但方法不匹配时返回 404，HTTP 语义不准确且缺少 `Allow` 指示；已改为 405 + `Allow` 头并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `/platform/orgs` 401 OpenAPI 示例文案与运行时漂移，且 `ProblemDetails.required` 未强制 `error_code`；已对齐示例与契约并补齐断言。 [`apps/api/src/openapi.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `x-request-id` 接受多值/逗号拼接时会直接进入链路，存在追踪串线与审计关联不稳定风险；已改为歧义值回退服务端生成 ID 并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `x-request-id` 未清理控制字符，日志与问题详情中的 `request_id` 存在可读性/可审计性风险；已增加净化规则并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `x-request-id` 未设置长度上限，异常长头值会放大日志与响应负载；已统一限制长度并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `createApiApp` 对“声明路径但方法不匹配”请求仍返回 404，和 `dispatchApiRoute` 的 405 + `Allow` 语义漂移；已改为未命中统一走分发链路并补齐回归。 [`apps/api/src/app.js`] [`apps/api/test/auth.express.api.test.js`]
- [x] [AI-Review][Medium] `createApiApp` 的 404 fallback 缺少 `error_code`，与 `ProblemDetails` 契约不一致；已统一收敛为 `AUTH-404-NOT-FOUND` 并补齐回归。 [`apps/api/src/app.js`] [`apps/api/test/auth.express.api.test.js`]
- [x] [AI-Review][Medium] `createApiApp` 直接透传歧义 `x-request-id`（逗号拼接），存在追踪串线风险；已接入 `requestIdFrom` 归一化并补齐回归。 [`apps/api/src/app.js`] [`apps/api/test/auth.express.api.test.js`]
- [x] [AI-Review][Medium] `x-request-id` 仅做净化未校验 header-safe，非法 header 值仍可能进入链路；已增加 `http.validateHeaderValue` 校验并在非法值时回退 UUID。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] `dispatchApiRoute` 显式注入 `requestId` 仍接受逗号歧义值，与 header 归一化策略不一致；已统一按歧义值回退 UUID 并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 幂等退化审计事件缺少 `degradation_reason` 元数据，导致审计记录与 OpenAPI 示例字段不对齐；已补齐 metadata 透传并新增断言。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 预授权符号常量直接导出，测试/调用方可绕过封装构造标记上下文，信任边界暴露面过大；已收敛为仅导出 `markRoutePreauthorizedContext` 工具并替换调用点。 [`apps/api/src/modules/auth/route-preauthorization.js`] [`apps/api/src/server.js`] [`apps/api/test/platform.org.api.test.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `org_name` 仅校验非空与长度，未拒绝控制字符（如换行）导致存储/展示契约不稳定；已补齐服务端校验、OpenAPI 约束与回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/src/openapi.js`] [`apps/api/test/platform.org.api.test.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 依赖探针异常路径仅降级返回但缺少内部日志，故障定位可观测性不足；已补齐带 `request_id` 的 warn 日志。 [`apps/api/src/http-routes.js`]
- [x] [AI-Review][Medium] 幂等写入成功后若 `idempotencyStore.resolve` 失败会被静默吞掉，重放保障退化且缺少审计信号；已补齐降级审计并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] `/platform/orgs` 非持久语义响应在 `releasePending` 失败时缺少可观测性，可能造成同键短时异常占用；已补齐降级审计并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 幂等重放命中未校验缓存响应结构完整性，存储异常污染可能触发非预期响应；已增加 fail-closed 保护并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 幂等缓存条目 `requestHash` 缺失/损坏时会被误判为 `AUTH-409-IDEMPOTENCY-CONFLICT`；已改为按“存储条目损坏”fail-closed 返回 `AUTH-503-IDEMPOTENCY-STORE-UNAVAILABLE` 并补齐 server/API 回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][Medium] `initial_owner_phone` 校验会先 `trim` 再判定，导致含前后空白的手机号被接受，与 OpenAPI `^1\\d{10}$` 严格契约不一致；已改为原值与归一化值必须一致并补齐回归。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]
- [x] [AI-Review][High] `rollbackProvisionedUserIdentity` 将 `deleteUserById` 的非契约返回（如 `{ synced: false }`）误判为回滚成功，owner 回滚 fail-closed 可被绕过；已收紧为仅 `deleted === true` 视为成功，否则显式失败。 [`apps/api/src/modules/auth/auth.service.js`]
- [x] [AI-Review][Medium] MySQL `deleteUserById` 死锁重试耗尽时复用通用 fallback（`{ synced: false, reason: 'db-deadlock' }`）与删除契约不一致，导致上层语义歧义；已改为返回 `{ deleted: false }`。 [`apps/api/src/modules/auth/auth.store.mysql.js`]
- [x] [AI-Review][Low] 缺少“回滚删除结果畸形 fail-closed”与“删除死锁耗尽返回 `deleted=false`”回归保护；已补齐单测。 [`apps/api/test/auth.service.test.js`] [`apps/api/test/auth.store.mysql.test.js`]
- [x] [AI-Review][Medium] `dispatchApiRoute` 未校验 `Idempotency-Key` 头的 header-safe 约束，控制字符头值可能进入幂等链路；已新增统一拒绝并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Medium] 受保护路由未校验 `Authorization` 头的 header-safe 约束，非法头值会进入鉴权分支；已新增统一拒绝并补齐回归。 [`apps/api/src/server.js`] [`apps/api/test/server.test.js`]
- [x] [AI-Review][Low] 缺少“owner 引导 `AuthProblemError` 归一化为 `ORG-503-DEPENDENCY-UNAVAILABLE` 时仍记录拒绝审计”的回归保护；已补齐 `org.create.rejected` + `upstream_error_code` 断言。 [`apps/api/src/modules/platform/org.service.js`] [`apps/api/test/platform.org.api.test.js`]

## Dev Notes
### Developer Context（开发者必须先读）

- 当前代码仍以 `auth` 模块为核心，路由接入为集中式分发（`apps/api/src/http-routes.js` + `apps/api/src/server.js`），本故事应遵循现有结构做增量扩展，避免目录级重构。
- Story 1.9 已完成“手机号用户创建/复用 + 默认密码策略 + 不改既有密码”能力，这正是 Story 2.1 的关键依赖，必须优先复用现有能力与约束。
- 现有平台侧已具备 `platform.member_admin.*` 权限语义与 fail-closed 路由声明校验，本故事新增接口必须先声明权限，再实现处理逻辑。
- 当前项目代码风格为 CommonJS + Node test runner（非 TS Nest Controller 全家桶），请保持与仓库现状一致。
### Technical Requirements（实现硬约束）

- 新接口必须使用统一错误结构：`application/problem+json`，至少包含 `status`、`detail`、`error_code`、`request_id`、`retryable`。
- `initial_owner_phone` 为创建组织必填字段；缺失时返回稳定错误码（建议 `ORG-400-INITIAL-OWNER-PHONE-REQUIRED`，`retryable=false`）。
- 组织创建事务必须保证原子性：`org` 主记录写入、负责人关系建立（`owner_user_id` + 成员关系）任一失败必须整体回滚。
- 初始负责人身份处理规则必须与 Story 1.9 保持一致：
  - 已存在手机号：仅复用用户身份，不改变该用户密码。
  - 不存在手机号：按默认密码策略初始化账号，仅存 `password_hash`。
- 关键写接口建议纳入 `Idempotency-Key` 保护，防止重复提交造成重复组织创建。
- 审计最小集：至少记录 `org.create.succeeded` 与 `org.create.rejected`，并附 `request_id`、`operator_user_id`、`org_id`（成功时）与失败原因。
### Architecture Compliance（架构对齐清单）

- 对齐“平台域/组织域边界强隔离”：组织创建接口属于平台域，仅允许平台域授权上下文调用。
- 遵循受保护路由声明门禁：新增路由必须在 `route-permissions` 声明，否则 `check:route-permissions` 应失败（fail-closed）。
- 外部契约字段继续使用 `snake_case`（如 `initial_owner_phone`、`owner_user_id`、`request_id`）。
- 错误处理继续走统一 Problem Details，不引入第二套错误响应风格。
- 关键状态变更后保持会话一致性原则：若创建流程引入身份/权限新关系，后续故事实现中需考虑 `session_version` 收敛策略衔接。
### Library & Framework Requirements（库与框架要求）

- 当前项目依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-16 最新核验：
  - Node.js（官方发布索引）：LTS `v24.13.1`，Current `v25.6.1`
  - npm registry（`pnpm view`）：`@nestjs/core 11.1.13`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`
  - MySQL 官方版本页：Innovation `9.4.0`，LTS `8.4.6`
- 本故事执行策略：优先遵循仓库已锁定版本，不在 Story 2.1 内发起框架升级；仅在实现时兼容上述最新稳定行为。
### File Structure Requirements（建议变更落点）

- API 路由与分发：
  - `apps/api/src/http-routes.js`（注册新 handler）
  - `apps/api/src/server.js`（路由执行链/幂等路由集合如有）
  - `apps/api/src/route-permissions.js`（新增路由声明与权限码）
- 领域实现（建议新增）：
  - `apps/api/src/modules/platform/org.routes.js`
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/platform/org.store.mysql.js`
- 契约与文档：
  - `apps/api/src/openapi.js`（`POST /platform/orgs` 请求/响应/错误契约）
- 数据迁移：
  - `apps/api/migrations/0008_platform_org_bootstrap.sql`（建议命名）
  - `apps/api/migrations/0008_platform_org_bootstrap.down.sql`（建议命名）
- 测试：
  - `apps/api/test/platform.org.api.test.js`（建议新增）
  - `apps/api/test/server.test.js`（OpenAPI/路由声明回归）
  - `apps/api/test/migrate-baseline.test.js`（迁移脚本结构断言）
### Testing Requirements（测试要求）

- AC1（必填校验）：
  - `initial_owner_phone` 缺失 -> 400 + 标准错误码 + 可理解提示。
- AC2（成功创建）：
  - 有效组织信息 + 初始管理员手机号 -> 创建组织成功，返回 `org_id` 与治理关系字段。
  - 校验 DB 写入：`orgs.owner_user_id` 与成员关系一致。
- AC3（身份复用）：
  - 已存在手机号 -> 复用用户，不新增重复 user，不修改该用户密码哈希。
- 事务一致性：
  - 模拟中途失败，确认组织与负责人关系不会出现半成功数据。
- 权限门禁：
  - 无 `platform` 权限上下文调用创建接口应被拒绝。
- 契约与门禁命令（必须通过）：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`
### Latest Tech Information（2026-02-16）

- Node.js 发布索引显示：`v24.13.1` 为 LTS，`v25.6.1` 为 Current。
- npm registry 最新版本（通过 `pnpm view`）：
  - `@nestjs/core 11.1.13`
  - `typeorm 0.3.28`
  - `mysql2 3.17.2`
  - `ioredis 5.9.3`
- MySQL 官方版本页显示：LTS 线为 `8.4.6`，Innovation 线为 `9.4.0`。
- 结论：本故事无需升级框架，按当前仓库版本实现并保持向最新稳定版本兼容即可。
### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、现有 `apps/api` 代码与迁移。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Story 2.1 completed after adversarial code review round-31 with full gate rerun`

### Project Structure Notes

- 当前仓库 API 主链路以 `auth` 模块为核心，Story 2.1 建议采用“新增平台组织模块 + 低侵入集成”策略。
- 保持 CommonJS、Node test runner、集中式 route dispatch 的现有工程范式，避免在本故事中引入框架重构。
- 若未来扩展到 Story 2.2+，建议把平台治理能力逐步从 `auth` 邻接逻辑拆分到独立 `platform/*` 目录。

### References

- Story 2.1 定义与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.1: 组织创建与初始负责人校验]
- FR10 / FR64 与发布口径  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 组织创建与负责人规则、数据模型约束  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md]
- 架构边界与目录建议  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 组织治理主路径与反馈规范  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 当前实现基线  
  [Source: apps/api/src/http-routes.js]  
  [Source: apps/api/src/server.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/modules/auth/auth.store.mysql.js]
- Node.js Releases  
  [Source: https://nodejs.org/dist/index.json]
- MySQL Release Notes  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]
- MySQL Product Versions  
  [Source: https://www.mysql.com/support/eol-notice.html]
- npm Registry  
  [Source: https://www.npmjs.com/package/@nestjs/core]  
  [Source: https://www.npmjs.com/package/typeorm]  
  [Source: https://www.npmjs.com/package/mysql2]  
  [Source: https://www.npmjs.com/package/ioredis]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-1-组织创建与初始负责人校验`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- loaded artifacts: `epics.md` + `prd.md` + `prd-appendix-legacy-inputs.md` + `architecture.md` + `ux-design-specification.md`
- implemented route: `POST /platform/orgs` with protected scope `platform.member_admin.operate`
- migration added: `apps/api/migrations/0008_platform_org_bootstrap.sql` + `apps/api/migrations/0008_platform_org_bootstrap.down.sql`
- gates passed: `pnpm --dir apps/api check:route-permissions` / `pnpm --dir apps/api test` / `pnpm --dir apps/api lint`
- code-review auto-fix: strict payload contract check + OpenAPI 503 response + org-create negative tests
- code-review follow-up (2026-02-17): map unexpected org-store failures to `ORG-503-DEPENDENCY-UNAVAILABLE`; rollback newly created owner identity on org-create failure; add API regressions for 503 + rollback path
- code-review follow-up (2026-02-17 round-3): decouple org service from auth private internals; enforce transactional affectedRows checks; tighten OpenAPI response schema; add AC boundary regressions
- code-review follow-up (2026-02-17 round-4): remove duplicate authorizeRoute call by reusing pre-authorized context; include operator_user_id in payload-rejected audit event; enable idempotency for `/platform/orgs`; align OpenAPI retryable/idempotency examples with runtime
- code-review follow-up (2026-02-17 round-5): normalize owner-bootstrap upstream `AUTH-*` errors to `/platform/orgs` contract codes (`ORG-503`/`ORG-409`); ensure operator context resolves before payload validation in fallback path; align OpenAPI idempotency-store-unavailable detail with runtime
- code-review follow-up (2026-02-17 round-6): add missing `/platform/orgs` `413` OpenAPI contract and server-level regression coverage for payload-too-large behavior
- code-review follow-up (2026-02-17 round-7): prevent idempotency-key reservation on validation failures; add deadlock retry for org-create transaction;补齐 `/platform/orgs` 401/403 OpenAPI 示例与契约断言
- code-review follow-up (2026-02-17 round-8): harden pre-authorized context trust boundary with internal marker guard; align in-memory org create overflow semantics with MySQL `ER_DATA_TOO_LONG`; add rollback regression for data-too-long path
- code-review follow-up (2026-02-17 round-9): scope idempotency non-cacheable release to `/platform/orgs` only to preserve legacy route semantics; align `/platform/orgs` idempotency OpenAPI wording with runtime; centralize route preauthorization markers into shared symbol constants
- code-review follow-up (2026-02-17 round-10): fail fast on missing platform-org handler dependencies; bound org audit trail growth; align `/platform/orgs` 503 OpenAPI examples with runtime `degradation_reason`
- code-review follow-up (2026-02-17 round-11): tighten `/platform/orgs` payload type validation for `org_name`/`initial_owner_phone`; cap unknown-field detail blast radius; harden preauthorization markers against `Symbol.for` forgery
- code-review follow-up (2026-02-17 round-12): unify default route-handler auth service wiring for `/platform/orgs` and idempotency audit; accept marked preauthorized platform-org calls without Authorization header; add server/platform regression coverage
- code-review follow-up (2026-02-17 round-13): harden preauthorization-overrides-invalid-header edge path; ensure handler wiring reuses `platformOrgService` auth service when explicitly injected; classify unknown idempotency outcomes as `unknown` instead of `hit`
- code-review follow-up (2026-02-17 round-14): fail fast when injected `authService` and `platformOrgService` use different instances; add `/platform/orgs` idempotency degradation regressions for store-unavailable and pending-timeout paths
- code-review follow-up (2026-02-17 round-15): tighten `/platform/orgs` preauthorization trust resolution in route handler; isolate default idempotency stores per auth-service/handlers owner; reject ambiguous `Authorization` headers on protected routes
- code-review follow-up (2026-02-17 round-16): fail fast when rollback capability is missing; fail-closed when owner rollback fails after org-create storage error; bound auth-service audit trail growth
- code-review follow-up (2026-02-17 round-17): enforce strict rollback failure propagation in `rollbackProvisionedUserIdentity`; replace invalid `log.warn` calls with `log('warn', ...)`; add rollback guard/delete failure regressions
- code-review follow-up (2026-02-17 round-18): harden dependency probe wiring for health/smoke (default fallback + throw/malformed normalization); stabilize createServer 500 regressions with preflight-compatible authService stub
- code-review follow-up (2026-02-17 round-20): align unknown-route 404 with `AUTH-404-NOT-FOUND`; return 405 + `Allow` for declared-path unsupported methods; align `/platform/orgs` 401 OpenAPI detail and enforce `ProblemDetails.required` includes `error_code`
- code-review follow-up (2026-02-17 round-21): harden `x-request-id` handling (ambiguous multi-value fallback + control-char sanitization + length cap) and add request-id normalization regressions
- code-review follow-up (2026-02-17 round-23): enforce header-safe `x-request-id` validation and explicit requestId ambiguity fallback; align idempotency degradation audit metadata (`degradation_reason`) with contract
- code-review follow-up (2026-02-17 round-24): encapsulate preauthorization markers behind helper API; reject control characters in `org_name` and align OpenAPI contract; add dependency-probe failure warn logs with `request_id`
- code-review follow-up (2026-02-17 round-25): harden idempotency degradation observability for `resolve/releasePending` failures and fail closed on corrupted replay payload snapshots
- code-review follow-up (2026-02-17 round-26): fail closed on `claimOrRead` corrupted entry and unknown pending state transitions during wait; add route-level regressions for degraded idempotency branches
- code-review follow-up (2026-02-17 round-27): fail closed when idempotency `requestHash` is missing/corrupted to avoid false `AUTH-409-IDEMPOTENCY-CONFLICT`; add server and `/platform/orgs` regression coverage
- code-review follow-up (2026-02-17 round-28): full-scope re-review completed after round-27 fixes; no new high/medium/low findings
- code-review follow-up (2026-02-17 round-31): harden owner rollback delete-result contract to fail-closed (`deleted === true` only); align MySQL `deleteUserById` deadlock fallback to `{ deleted: false }`; add targeted regressions and rerun full gates
- code-review follow-up (2026-02-17 round-32): enforce header-safe validation for `Idempotency-Key` and protected-route `Authorization`; add regression coverage for owner-bootstrap auth problem normalization audit (`upstream_error_code`); update regressions and rerun full gates
- code-review follow-up (2026-02-17 round-33): independent re-review via `prompts:/bmad-bmm-code-review`; no new high/medium/low findings after rerunning route-permission/lint/full-test gates

### Completion Notes List

- [x] Story 2.1 context compiled with AC/tasks/dev guardrails
- [x] Latest technical versions cross-checked against official sources
- [x] Sprint status updated to mark story ready for development
- [x] 新增平台组织创建接口 `POST /platform/orgs`，实现 `initial_owner_phone` 必填校验与统一 Problem Details 返回
- [x] 新增组织建模迁移 `0008`（`orgs` + `memberships`）及 down migration，覆盖 owner 关系约束与索引
- [x] 复用 Story 1.9 默认密码能力：新增 `authService.getOrCreateUserIdentityByPhone`，实现手机号存在复用、不存在创建
- [x] 新增组织创建事务落库 `authStore.createOrganizationWithOwner`，保障组织与负责人关系同事务提交
- [x] 完成契约与权限闭环：`route-permissions`、`openapi`、平台组织审计事件（`org.create.succeeded` / `org.create.rejected`）
- [x] 测试覆盖新增：`platform.org.api.test.js`、`auth.store.mysql.test.js`、`migrate-baseline.test.js`、`route-permissions.test.js`、`server.test.js`
- [x] 代码评审修复：`POST /platform/orgs` 已纳入 `Idempotency-Key` 保护，补齐同键重放与同键异载荷冲突回归
- [x] 代码评审修复：创建组织严格拒绝未知字段，避免请求契约漂移
- [x] 代码评审修复：OpenAPI 补充 `503 ORG-503-DEPENDENCY-UNAVAILABLE` 响应示例，文档与实现对齐
- [x] 代码评审修复：补齐 `platform.org.api` 负向回归（未知字段、重复创建冲突）
- [x] 代码评审修复：组织创建存储异常统一收敛为 `ORG-503-DEPENDENCY-UNAVAILABLE`，避免 500 非契约响应
- [x] 代码评审修复：当 owner 身份为“本次新建”且组织创建失败时，执行安全回滚，避免残留孤立用户
- [x] 代码评审修复：新增 `platform.org.api` 回归（依赖不可用 503、失败后 owner 身份回滚）
- [x] 代码评审修复：移除 `org.service` 对 `authService._internals` 的私有耦合，改用公共能力 `authService.createOrganizationWithOwner`
- [x] 代码评审修复：为组织创建事务新增写入结果断言（`affectedRows`），避免极端场景误报成功
- [x] 代码评审修复：收紧 OpenAPI 组织创建响应契约（`additionalProperties=false`）并补齐 `server.test` 断言
- [x] 代码评审修复：补齐 AC1 边界负向回归（缺失 `org_name`、手机号格式非法）
- [x] 代码评审修复：复用预授权上下文，移除 `/platform/orgs` 路径重复鉴权并补齐回归断言（`authorizeRoute` 单次调用）
- [x] 代码评审修复：payload 校验失败审计事件补齐 `operator_user_id` 字段，满足审计最小集要求
- [x] 代码评审修复：补齐 `/platform/orgs` OpenAPI 的 `retryable` 与幂等冲突/存储异常示例，保持契约与运行时一致
- [x] 代码评审修复：初始负责人身份引导异常不再透传 `AUTH-*`，统一收敛到 `/platform/orgs` 契约错误码（`ORG-503-DEPENDENCY-UNAVAILABLE`、`ORG-409-ORG-CONFLICT`）
- [x] 代码评审修复：无预授权上下文分支先解析操作者再做 payload 校验，避免拒绝审计 `operator_user_id=unknown`
- [x] 代码评审修复：对齐 OpenAPI `idempotency_store_unavailable` 详情文案与运行时，并补齐 `server.test` 断言
- [x] 代码评审修复：补齐 `/platform/orgs` 的 `413 Payload Too Large` OpenAPI 契约与示例，消除文档-运行时漂移
- [x] 代码评审修复：补齐 `/platform/orgs` 大 payload 413 端到端回归与契约断言，锁定 `AUTH-413-PAYLOAD-TOO-LARGE`
- [x] 代码评审修复：幂等层不再缓存 `/platform/orgs` 的 400/401/403 等非持久化客户端错误，避免同键修正请求被误判冲突
- [x] 代码评审修复：`createOrganizationWithOwner` 接入 MySQL 死锁重试机制，并补齐重试恢复与重试耗尽断言
- [x] 代码评审修复：补齐 `/platform/orgs` OpenAPI 401/403 示例，统一错误码契约可读性，并新增 `server.test` 断言
- [x] 代码评审修复：收紧 `/platform/orgs` 预授权上下文信任边界，未命中内部标记时强制回退 `authorizeRoute`
- [x] 代码评审修复：in-memory `createOrganizationWithOwner` 对齐 MySQL 超长错误语义（`ER_DATA_TOO_LONG`）
- [x] 代码评审修复：补齐“长度异常失败时 owner 身份回滚”与“伪造预授权上下文不应绕过鉴权”回归
- [x] 代码评审修复：将“非持久响应不缓存”策略收敛为 `/platform/orgs` 路由级行为，避免影响既有幂等接口语义
- [x] 代码评审修复：对齐 `/platform/orgs` `Idempotency-Key` OpenAPI 文案与运行时行为，并增加契约断言
- [x] 代码评审修复：新增共享预授权常量模块，消除 `server`/`org.service` 魔法字符串重复
- [x] 代码评审修复：`createPlatformOrgHandlers` 增加依赖能力 fail-fast，避免缺失 `createOrg` 时延迟到运行期失败
- [x] 代码评审修复：为 `org.service` 审计轨迹引入上限裁剪，防止长时间运行内存线性增长
- [x] 代码评审修复：补齐 `/platform/orgs` 503 幂等错误示例 `degradation_reason` 字段并新增契约断言
- [x] 代码评审修复：`org_name`/`initial_owner_phone` 非字符串输入改为类型敏感校验，避免误判“缺失必填”
- [x] 代码评审修复：收敛未知字段错误明细长度，避免异常大 payload 触发过长错误详情
- [x] 代码评审修复：预授权标记改为私有 `Symbol`，阻断 `Symbol.for` 同 key 伪造上下文绕过
- [x] 代码评审修复：统一 `createRouteHandlers` 默认依赖装配，确保 `/platform/orgs` 与幂等审计复用同一 `authService` 实例
- [x] 代码评审修复：允许“已标记预授权上下文 + 无 Authorization 头”的平台组织创建内部调用路径，并补齐回归
- [x] 代码评审修复：补齐“已标记预授权上下文 + 畸形 Authorization 头”边界，确保内部受信调用不被无效头误伤
- [x] 代码评审修复：`createRouteHandlers` 在“仅注入 platformOrgService”路径下优先复用其内置 `authService`，消除实例漂移
- [x] 代码评审修复：幂等审计未知 outcome 不再误标记为命中，新增 `auth.idempotency.unknown` 分类与回归断言
- [x] 代码评审修复：`createRouteHandlers` 在同时注入 `authService` 与 `platformOrgService` 且实例不一致时改为构造期 fail-fast，避免依赖分裂
- [x] 代码评审修复：补齐 `/platform/orgs` 幂等退化路径（store unavailable / pending timeout）API 回归，并校验对应审计事件
- [x] 代码评审修复：`org.routes` 仅在预授权上下文被严格校验后才跳过 Bearer 解析，避免不完整标记误绕过回退鉴权
- [x] 代码评审修复：默认幂等存储改为按 `authService/handlers` 作用域隔离，避免跨 handlers 实例状态污染
- [x] 代码评审修复：受保护路由新增歧义 `Authorization` 头拦截（多值/逗号拼接），统一返回 `AUTH-401-INVALID-ACCESS`
- [x] 代码评审修复：`org.service` 强制依赖 `rollbackProvisionedUserIdentity`，缺失时改为 fail-fast，避免回滚能力缺口导致原子性失效
- [x] 代码评审修复：组织写入失败后的 owner 回滚失败改为 fail-closed 返回 `ORG-503-DEPENDENCY-UNAVAILABLE`，并补齐审计与 API 回归
- [x] 代码评审修复：`auth.service` 审计轨迹增加上限裁剪，避免长期运行内存线性增长，并补齐回归
- [x] 代码评审修复：`rollbackProvisionedUserIdentity` 改为严格回滚语义，guard/delete 失败时显式抛错，确保 `org.service` fail-closed 在真实实现上成立
- [x] 代码评审修复：`auth.service` 回滚路径统一使用 `log('warn', ...)`，避免异常分支触发 `log.warn is not a function`
- [x] 代码评审修复：补齐 owner 身份回滚 guard 失败与 delete 失败的严格语义回归测试
- [x] 代码评审修复：`createRouteHandlers` 未显式注入 `dependencyProbe` 时回退默认连通性探针，避免健康路由崩溃
- [x] 代码评审修复：`health`/`smoke` 对探针抛错与畸形结果统一降级处理，避免非预期 500 并补齐回归测试
- [x] 代码评审修复：修正 `server.test` 两个 500 场景的预检注入，改用最小 `authorizeRoute` stub 保持测试意图稳定
- [x] 代码评审修复：修复 `auth.express` 回归中 `/health` 500 旧期望，拆分为“依赖降级 503”与“真实全局异常 500”双路径断言
- [x] 代码评审修复：收敛 `dependencyProbe` 异常详情回显，避免 `health`/`smoke` 暴露原始探针错误文本
- [x] 代码评审修复：补齐 `/health` 与 `/smoke` OpenAPI 响应 schema（含依赖 `mode/detail` 字段）并增加契约断言
- [x] 代码评审修复：未声明路由 404 增补 `AUTH-404-NOT-FOUND` 错误码并补齐 server 回归
- [x] 代码评审修复：声明路径方法不匹配改为 405 并返回 `Allow` 头，补齐语义回归
- [x] 代码评审修复：对齐 `/platform/orgs` 401 OpenAPI 示例文案，并强制 `ProblemDetails.required` 包含 `error_code`
- [x] 代码评审修复：`x-request-id` 多值/逗号歧义不再透传，统一回退服务端生成 request_id，防止追踪串线
- [x] 代码评审修复：统一净化并限制 `x-request-id`（控制字符清理 + 长度上限），降低日志污染与超长 request_id 风险
- [x] 代码评审修复：补齐 request_id 归一化回归（`dispatchApiRoute`/`handleApiRoute` 的歧义头与边界长度场景）
- [x] 代码评审修复：`createApiApp` 将未命中请求统一回收至 `dispatchApiRoute`，修复声明路径方法不匹配返回 404 的语义漂移并返回 `Allow`
- [x] 代码评审修复：`createApiApp` 改用 `requestIdFrom` 归一化 request_id，拒绝歧义 `x-request-id` 透传
- [x] 代码评审修复：补齐 express 路径下 404 `error_code`、405 语义与 request_id 歧义值回退回归
- [x] 代码评审修复：`x-request-id` 新增 header-safe 校验，非法值与显式歧义 `requestId` 统一回退 UUID 并补齐回归
- [x] 代码评审修复：幂等退化审计补齐 `degradation_reason` 元数据，确保运行时审计与 OpenAPI 示例一致
- [x] 代码评审修复：预授权标记改为 helper 封装调用，移除符号常量对外暴露并补齐回归
- [x] 代码评审修复：`org_name` 新增控制字符拒绝规则，联动更新 OpenAPI pattern 与 API/契约回归
- [x] 代码评审修复：依赖探针异常路径补齐内部 warn 日志（含 `request_id`），提升故障排查可观测性
- [x] 代码评审修复：幂等成功写入后的 `resolve` 失败不再静默吞没，新增 `store_unavailable` 审计降级信号并补齐回归
- [x] 代码评审修复：`/platform/orgs` 非持久响应在 `releasePending` 失败时补齐降级审计，避免短时占用问题“不可观测”
- [x] 代码评审修复：幂等重放命中新增响应结构校验，异常缓存命中改为 fail-closed 返回 `AUTH-503-IDEMPOTENCY-STORE-UNAVAILABLE`
- [x] 代码评审修复：幂等条目 `requestHash` 缺失/损坏时不再误判为冲突，统一按存储损坏 fail-closed 为 `AUTH-503-IDEMPOTENCY-STORE-UNAVAILABLE` 并补齐 server/API 回归
- [x] 代码评审修复：`rollbackProvisionedUserIdentity` 仅在 `deleteUserById` 返回 `deleted=true` 时判定成功，删除结果畸形时强制 fail-closed
- [x] 代码评审修复：`deleteUserById` 死锁重试耗尽统一返回 `{ deleted: false }`，与删除语义契约保持一致
- [x] 代码评审修复：补齐“回滚删除结果畸形”与“删除死锁耗尽”回归，并复跑定向与全量门禁通过
- [x] 代码评审修复：补齐 `Idempotency-Key` 与受保护路由 `Authorization` 的 header-safe 校验，非法头值统一拒绝并返回标准错误
- [x] 代码评审修复：owner 身份引导 `AuthProblemError` 归一化为 `ORG-503-DEPENDENCY-UNAVAILABLE` 时补齐拒绝审计回归，保留 `upstream_error_code` 便于追踪
- [x] 代码评审修复：补齐上述边界的 server/API 回归并复跑全量门禁通过

### File List

- apps/api/migrations/0008_platform_org_bootstrap.sql
- apps/api/migrations/0008_platform_org_bootstrap.down.sql
- apps/api/src/http-routes.js
- apps/api/src/app.js
- apps/api/src/server.js
- apps/api/src/route-permissions.js
- apps/api/src/openapi.js
- apps/api/src/modules/auth/route-preauthorization.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/platform/org.routes.js
- apps/api/src/modules/platform/org.constants.js
- apps/api/src/modules/platform/org.service.js
- apps/api/test/migrate-baseline.test.js
- apps/api/test/platform.org.api.test.js
- apps/api/test/http-routes.test.js
- apps/api/test/route-permissions.test.js
- apps/api/test/server.test.js
- apps/api/test/auth.express.api.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/auth.service.test.js
- _bmad-output/implementation-artifacts/2-1-组织创建与初始负责人校验.md
- _bmad-output/implementation-artifacts/sprint-status.yaml

## Change Log

- 2026-02-16: 完成 Story 2.1 开发实现并通过全部门禁；状态更新为 `review`。
- 2026-02-16: 完成代码评审自动修复并复跑门禁；状态更新为 `done`。
- 2026-02-17: 二次代码审查完成，修复 503 契约偏差与 owner 身份回滚缺口，并补齐对应 API 回归测试。
- 2026-02-17: 三次代码审查完成，修复私有实现耦合与事务写入断言缺口，收紧 OpenAPI 响应契约并补齐 AC 边界回归，复跑门禁通过。
- 2026-02-17: 四次代码审查完成，消除重复鉴权、补齐拒绝审计主体字段、接入 `/platform/orgs` 幂等保护，并对齐 OpenAPI 幂等/`retryable` 契约示例。
- 2026-02-17: 五次代码审查完成，收敛 owner 身份引导上游 `AUTH-*` 错误码泄漏、修复无预授权上下文下的拒绝审计主体缺失风险，并对齐 OpenAPI 503 文案与运行时。
- 2026-02-17: 六次代码审查完成，补齐 `/platform/orgs` 的 413 契约与回归，确保 payload-too-large 错误码文档与运行时一致。
- 2026-02-17: 七次代码审查完成，修复 400 场景幂等键占用导致的误冲突，补齐组织创建事务死锁重试能力，并完善 `/platform/orgs` 401/403 OpenAPI 示例与契约断言。
- 2026-02-17: 八次代码审查完成，收紧预授权上下文信任边界、补齐 in-memory 与 MySQL 的组织名超长错误语义一致性，并新增长度异常回滚回归保护。
- 2026-02-17: 九次代码审查完成，将幂等非持久响应释放策略收敛到 `/platform/orgs` 以避免 legacy 语义回归，对齐 `/platform/orgs` 幂等 OpenAPI 文案，并抽取预授权共享常量模块。
- 2026-02-17: 十次代码审查完成，补齐平台组织 handler 依赖 fail-fast、防止 org 审计轨迹无限增长，并对齐 `/platform/orgs` 503 幂等错误示例 `degradation_reason` 字段与运行时。
- 2026-02-17: 十一次代码审查完成，修复 `/platform/orgs` 类型校验误分类、收敛未知字段错误详情长度，并将预授权标记从 `Symbol.for` 切换为私有 `Symbol` 以降低伪造风险。
- 2026-02-17: 十二次代码审查完成，修复 `createRouteHandlers` 默认注入链路的 `authService` 实例漂移问题，并放通“已标记预授权 + 无 Authorization 头”的 `/platform/orgs` 内部调用路径，补齐对应回归后全量门禁通过。
- 2026-02-17: 十三次代码审查完成，修复“已标记预授权 + 畸形 Authorization 头”误报 401 边界，补齐仅注入 `platformOrgService` 的 `authService` 复用路径，并将幂等未知 outcome 从误命中改为 `unknown` 分类，回归与全量门禁通过。
- 2026-02-17: 十四次代码审查完成，新增 `authService`/`platformOrgService` 注入一致性 fail-fast 保护，并补齐 `/platform/orgs` 的幂等退化路径（store unavailable / pending timeout）回归与审计断言。
- 2026-02-17: 十五次代码审查完成，收紧 `/platform/orgs` 预授权上下文解析边界，隔离默认幂等存储实例作用域，并补齐受保护路由歧义 `Authorization` 头拦截与回归。
- 2026-02-17: 十六次代码审查完成，补齐回滚能力缺失 fail-fast、owner 回滚失败 fail-closed 语义，并为 `auth.service` 审计轨迹增加上限裁剪与回归。
- 2026-02-17: 十七次代码审查完成，修复 `rollbackProvisionedUserIdentity` 失败吞没导致的 fail-closed 退化风险，清理无效 `log.warn` 调用并补齐严格回滚失败回归，复跑全量门禁通过。
- 2026-02-17: 十八次代码审查完成，修复 `dependencyProbe` 缺省/异常/畸形输入导致的 health/smoke 崩溃路径，并稳定 createServer 500 回归测试注入方式，复跑门禁通过。
- 2026-02-17: 十九次代码审查完成，修复 `auth.express` 旧 500 断言漂移并拆分健康降级/全局异常回归，收敛探针异常详情回显，同时补齐 `/health` 与 `/smoke` OpenAPI 响应契约并复跑全量门禁通过。
- 2026-02-17: 二十次代码审查完成，修复未知路由 404 缺失错误码与声明路径方法不匹配返回 404 的语义偏差，并对齐 `/platform/orgs` 401 OpenAPI 示例及 ProblemDetails `error_code` 必填契约，复跑门禁通过。
- 2026-02-17: 二十一次代码审查完成，修复 `x-request-id` 多值/逗号歧义透传、控制字符未净化与超长值无上限问题，并补齐 request_id 归一化回归后复跑门禁通过。
- 2026-02-17: 二十二次代码审查完成，修复 `createApiApp` 在 404/405 与 request_id 归一化上的语义漂移，补齐 express 回归并复跑全量门禁通过。
- 2026-02-17: 二十三次代码审查完成，补齐 `x-request-id` header-safe 约束与显式 `requestId` 歧义兜底，并对齐幂等退化审计 `degradation_reason` 元数据，复跑关键回归与门禁通过。
- 2026-02-17: 二十四次代码审查完成，收敛预授权标记导出面、补齐 `org_name` 控制字符校验与 OpenAPI 对齐，并增加依赖探针异常内部日志，复跑目标回归与门禁通过。
- 2026-02-17: 二十五次代码审查完成，补齐幂等 `resolve/releasePending` 失败降级审计与损坏重放缓存 fail-closed 防御，并新增 server 回归后复跑全量门禁通过。
- 2026-02-17: 二十六次代码审查完成，修复 `claimOrRead` 损坏条目与 `waitForResolved` 未知状态误判超时问题，统一收敛为幂等存储损坏 fail-closed，并复跑全量门禁通过。
- 2026-02-17: 二十七次代码审查完成，修复幂等条目 `requestHash` 缺失/损坏被误判冲突问题，统一收敛为 `AUTH-503-IDEMPOTENCY-STORE-UNAVAILABLE`，补齐 server 与 `/platform/orgs` 回归并复跑全量门禁通过。
- 2026-02-17: 二十八次代码审查完成（2-1 全量范围复审）；复跑 `check:route-permissions`、`lint`、`test` 与关键定向回归，未发现新增问题。
- 2026-02-17: 二十九次代码审查完成，修复 `/platform/orgs` 对 `initial_owner_phone` 的空白裁剪放行问题，收敛为与 OpenAPI 严格一致的手机号校验并补齐 API 回归。
- 2026-02-17: 三十次代码审查完成（2-1 全量范围复审）；复跑 `check:route-permissions`、`lint`、`test` 与关键定向回归，未发现新增问题。
- 2026-02-17: 三十一次代码审查完成，修复 owner 回滚删除结果误判成功与 `deleteUserById` 死锁耗尽返回契约漂移问题，补齐回归并复跑全量门禁通过。
- 2026-02-17: 三十二次代码审查完成，补齐 `Idempotency-Key`/`Authorization` 的 header-safe 防护与 owner 引导 `AuthProblemError` 归一化审计回归，修正回归断言并复跑全量门禁通过。
- 2026-02-17: 三十三次代码审查完成（独立复审）；按 `prompts:/bmad-bmm-code-review` 重新审查并复跑 `check:route-permissions`、`lint`、`test`，无新增问题。
- 2026-02-17: 三十四次代码审查完成（独立复审）；复跑 `check:route-permissions`、`lint`、`test`，无新增问题。

## Senior Developer Review (AI)

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: 非预期存储故障返回 500 与 OpenAPI 503 契约不一致（已修复）
  - High: 组织创建失败后可能残留本次新建 owner 身份（已修复）
  - Medium: 缺少 503 与回滚路径回归测试（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.store.mysql.test.js test/migrate-baseline.test.js test/route-permissions.test.js test/server.test.js`

### Senior Developer Review (AI) - Round 3

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `org.service` 依赖 `authService._internals.authStore` 私有实现，模块耦合风险高（已修复）
  - Medium: 组织创建事务未校验写入条数，极端分支可能误报成功（已修复）
  - Low: OpenAPI 组织创建响应未限制额外字段，契约过宽（已修复）
  - Low: 缺少 AC1 关键边界用例（`org_name` 缺失、手机号格式非法）（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.store.mysql.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 4

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `/platform/orgs` 路径存在重复鉴权调用，造成冗余权限计算与审计噪声（已修复）
  - Medium: payload 校验失败审计缺失 `operator_user_id`，审计主体字段不完整（已修复）
  - Medium: `/platform/orgs` 未纳入幂等保护，重复提交风险未收敛（已修复）
  - Low: `/platform/orgs` OpenAPI 400 示例缺失 `retryable` 字段（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 5

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: owner 身份引导依赖故障会透传 `AUTH-503-*`，导致 `/platform/orgs` 契约错误码漂移（已修复）
  - Medium: owner 身份引导冲突会透传 `AUTH-409-PROVISION-CONFLICT`，与组织创建冲突语义不一致（已修复）
  - Medium: 无预授权上下文分支先校验 payload，导致拒绝审计 `operator_user_id` 可能退化为 `unknown`（已修复）
  - Low: OpenAPI `idempotency_store_unavailable` 示例文案与运行时 503 详情不一致（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 6

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `/platform/orgs` OpenAPI 未声明运行时已存在的 413 响应，契约与实现存在漂移（已修复）
  - Medium: 缺少 `/platform/orgs` payload-too-large 运行时回归，统一错误码 `AUTH-413-PAYLOAD-TOO-LARGE` 无保护（已修复）
  - Low: 缺少 `/platform/orgs` OpenAPI 413 示例断言，文档回归防护不足（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 7

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: `/platform/orgs` 在 400 校验失败后仍占用 `Idempotency-Key`，会把后续同键修正请求误判为冲突（已修复）
  - Medium: 组织创建事务未接入死锁重试，`ER_LOCK_DEADLOCK` 可能导致关键治理写路径脆弱（已修复）
  - Low: `/platform/orgs` OpenAPI 缺少 401/403 示例，问题详情错误码契约表达不完整（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.store.mysql.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 8

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `org.service` 会信任未标记预授权上下文，存在服务层误用绕过鉴权风险（已修复）
  - Medium: in-memory 组织创建未对齐 MySQL `ER_DATA_TOO_LONG` 语义，双后端行为不一致（已修复）
  - Low: 缺少“长度异常失败触发 owner 身份回滚”回归保护（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 9

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: 幂等“非持久响应不缓存”策略全局生效会改变 legacy 路由同键语义，存在兼容性回归风险（已修复）
  - Low: `/platform/orgs` 幂等 OpenAPI 描述与运行时行为存在漂移（已修复）
  - Low: 预授权标记常量在多模块重复定义，维护漂移风险高（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 10

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `createPlatformOrgHandlers` 在依赖缺失时未 fail-fast，错误暴露过晚（已修复）
  - Low: `org.service` 审计轨迹无上限，长时运行有内存增长风险（已修复）
  - Low: `/platform/orgs` 503 幂等错误示例缺少 `degradation_reason`，与运行时字段不一致（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 11

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `/platform/orgs` 把 `initial_owner_phone` 非字符串误判为“缺失必填”，错误码语义不准确（已修复）
  - Low: `/platform/orgs` 对 `org_name` 非字符串输入返回“缺失”语义，错误提示不精确（已修复）
  - Low: 预授权标记基于 `Symbol.for`，存在同 key 伪造上下文被信任风险（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 12

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `createRouteHandlers` 默认分支会让 `/platform/orgs` 与 `recordAuthIdempotencyEvent` 走不同 `authService` 实例，存在依赖漂移风险（已修复）
  - Medium: `createPlatformOrgHandlers` 在内部预授权调用且无 Authorization 头时仍会触发 Bearer 解析失败，导致误报 401（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 13

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: 预授权调用在携带畸形 `Authorization` 头时仍触发 Bearer 解析并误报 401（已修复）
  - Medium: 仅注入 `platformOrgService` 时 `createRouteHandlers` 未优先复用其 `authService`，存在服务实例漂移风险（已修复）
  - Low: 幂等审计未知 `outcome` 默认记录为 `hit`，会污染命中统计（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js test/auth.service.test.js`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 14

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `createRouteHandlers` 在同时注入 `authService` 与 `platformOrgService` 且实例不一致时未 fail-fast，可能造成依赖分裂（已修复）
  - Medium: 缺少 `/platform/orgs` 幂等存储不可用路径的 API 级回归，503 退化语义无路由级保护（已修复）
  - Low: 缺少 `/platform/orgs` 幂等 pending 超时路径的 API 级回归，错误码与退化原因字段无端到端保护（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 15

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `org.routes` 仅依据预授权标记放行，未验证上下文完整性，可能导致 Bearer 回退鉴权被错误跳过（已修复）
  - Medium: 默认幂等存储回退为全局单例，跨 handlers 实例存在状态串扰风险（已修复）
  - Medium: 受保护路由未拒绝歧义 `Authorization` 头，鉴权语义不确定（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js test/route-permissions.test.js`
  - `pnpm --dir apps/api exec node --test test/auth.api.test.js test/server.test.js`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 16

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: `org.service` 对 `rollbackProvisionedUserIdentity` 仅“可选依赖”，在注入缺失时会破坏 owner 回滚原子性（已修复）
  - High: 组织写入失败后 owner 回滚再次失败时仍返回 409/400，掩盖部分副作用清理失败风险（已修复）
  - Low: `auth.service` 审计轨迹无上限，长期运行存在内存膨胀风险（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 17

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: `rollbackProvisionedUserIdentity` 吞掉 guard/delete 失败，`org.service` fail-closed 在真实实现上可能退化（已修复）
  - Medium: 回滚异常路径调用不存在的 `log.warn`，会抛出 `TypeError` 污染错误语义（已修复）
  - Low: 缺少回滚 guard/delete 失败回归，严格语义无测试保护（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.service.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 18

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: `createRouteHandlers` 未注入 `dependencyProbe` 时会调用 `undefined`，健康检查路径运行期崩溃（已修复）
  - Medium: `health`/`smoke` 未隔离探针异常，依赖探针抛错会放大为 500 而非降级状态（已修复）
  - Low: `health`/`smoke` 未处理畸形探针快照，`db/redis` 缺失会触发 `TypeError`（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/http-routes.test.js test/server.test.js test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 19

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `createApiApp` 的 `AUTH-500-INTERNAL` 回归断言仍绑定 `/health` 旧行为，导致全量测试与当前降级语义冲突（已修复）
  - Medium: `dependencyProbe` 抛错时会向调用方回显原始异常文本，存在内部错误细节暴露风险（已修复）
  - Low: `/health` 与 `/smoke` OpenAPI 未显式描述运行时依赖字段（`mode`/`detail`），契约表达不完整（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/http-routes.test.js test/server.test.js test/auth.express.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 20

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: 未声明路由 404 缺少 `error_code`，与统一 Problem Details 契约不一致（已修复）
  - Medium: 声明路径方法不匹配返回 404 而非 405，HTTP 语义与客户端诊断不完整（已修复）
  - Low: `/platform/orgs` 401 OpenAPI 示例文案与运行时不一致，且 `ProblemDetails` 必填未显式约束 `error_code`（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 21

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `x-request-id` 多值/逗号拼接会直接进入请求链路，存在 request_id 串线与审计关联不稳定风险（已修复）
  - Low: `x-request-id` 未清理控制字符，`request_id` 存在日志可读性与审计质量风险（已修复）
  - Low: `x-request-id` 未限制长度，异常长 header 会放大日志/响应体积（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 22

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `createApiApp` 对声明路径方法不匹配仍返回 404，和路由分发层 405 语义不一致（已修复）
  - Medium: `createApiApp` 404 fallback 缺少 `error_code`，不满足统一 Problem Details 契约（已修复）
  - Medium: `createApiApp` 会透传歧义 `x-request-id`，存在追踪串线风险（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 23

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `x-request-id` 缺少 header-safe 校验，非标准值可能污染 request_id 传播与审计关联（已修复）
  - Low: `dispatchApiRoute` 显式 `requestId` 参数未拒绝逗号歧义值，和 header 归一化策略不一致（已修复）
  - Medium: 幂等退化审计事件未透传 `degradation_reason`，与契约示例字段存在漂移（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api exec node --test --test-name-pattern "parser and fallback error responses include access-control-allow-origin" test/auth.express.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 24

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Low: 预授权符号常量直接导出导致封装泄漏，信任边界暴露面偏大（已修复）
  - Medium: `org_name` 未拒绝控制字符，输入契约与展示稳定性存在风险（已修复）
  - Low: 依赖探针异常缺少内部日志，降级路径可观测性不足（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/server.test.js test/http-routes.test.js`
  - `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 25

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: 幂等写入成功后 `idempotencyStore.resolve` 失败会被静默吞没，缺少降级审计与可观测性（已修复）
  - Medium: `/platform/orgs` 非持久响应在 `releasePending` 失败时缺少降级信号，可能造成同键短时占用问题难定位（已修复）
  - Low: 幂等重放命中未校验缓存响应结构，异常缓存污染场景缺少 fail-closed 防御（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 26

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `claimOrRead` 返回 `action=existing` 但 `entry` 解析失败时，当前分支会误归类为 `pending_timeout`，应按存储异常 fail-closed 为 `store_unavailable`（已修复）
  - Medium: `waitForResolved` 轮询阶段若条目状态从 `pending` 变为未知值，原逻辑会误判超时；现统一按“条目损坏”fail-closed 并记录降级审计（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`

### Senior Developer Review (AI) - Round 27

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: 幂等 `claimOrRead/read` 条目若 `requestHash` 缺失或损坏，会被误判为 `AUTH-409-IDEMPOTENCY-CONFLICT`，导致“存储损坏”语义漂移（已修复）
  - Medium: `/platform/orgs` 路由缺少“损坏 `requestHash`”端到端回归，幂等 fail-closed 语义无 API 级保护（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 28

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Approved
- Findings:
  - None (High 0 / Medium 0 / Low 0)
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js`
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 29

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `/platform/orgs` 对 `initial_owner_phone` 会先 `trim` 再校验，含前后空白手机号可被接受，和 OpenAPI `^1\\d{10}$` 契约不一致（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 30

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Approved
- Findings:
  - None (High 0 / Medium 0 / Low 0)
- Validation:
  - `pnpm --dir apps/api exec node --test test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 31

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - High: `rollbackProvisionedUserIdentity` 将畸形 `deleteUserById` 返回误判为成功，可能绕过 owner 回滚 fail-closed（已修复）
  - Medium: `deleteUserById` 死锁重试耗尽返回非删除契约对象，导致回滚语义不稳定（已修复）
  - Low: 缺少删除结果畸形与死锁耗尽路径回归测试（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 32

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Changes Requested -> Fixed in same pass
- Findings:
  - Medium: `Idempotency-Key` 缺少 header-safe 校验，畸形头值可能进入幂等链路（已修复）
  - Medium: 受保护路由 `Authorization` 缺少 header-safe 校验，非法头值可能进入鉴权分支（已修复）
  - Low: 缺少“owner 引导 `AuthProblemError` 归一化为 `ORG-503` 时仍写拒绝审计”回归保护（已修复）
- Validation:
  - `pnpm --dir apps/api exec node --test test/server.test.js test/platform.org.api.test.js`
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 33

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Approved
- Findings:
  - None (High 0 / Medium 0 / Low 0)
- Validation:
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Senior Developer Review (AI) - Round 34

- Review Date: 2026-02-17
- Reviewer: 老大（AI 协作执行）
- Outcome: Approved
- Findings:
  - None (High 0 / Medium 0 / Low 0)
- Validation:
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`
