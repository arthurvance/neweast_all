# Story 1.2: 密码登录、会话刷新与当前会话登出

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台或组织用户,  
I want 使用手机号+密码登录，并可刷新与登出当前会话,  
so that 我可以稳定访问系统且会话生命周期可控。

## Acceptance Criteria

1. 用户状态可用且手机号/密码正确时，密码登录成功并签发 `access token + refresh token`，响应包含会话标识信息用于链路追踪。
2. 用户不存在、密码错误或用户状态不可用时，系统拒绝登录并返回统一错误码与标准提示，且不泄露账号存在性。
3. 刷新会话成功后返回新的 `access token + refresh token`，旧 refresh token 立即失效（rotation 生效）。
4. 存在多并发会话时，`logout` 仅撤销当前会话 token，其他会话保持有效。
5. 已完成身份校验的用户修改密码成功后，系统更新密码哈希并要求重新登录；后续认证仅接受新密码。

## Tasks / Subtasks

- [x] 完成认证契约与错误语义定义 (AC: 1,2,3,4,5)
  - [x] 在 OpenAPI 中补齐密码登录、refresh、logout、修改密码接口契约（ 请求/响应/错误示例）
  - [x] 统一 Problem Details + 业务错误码映射，确保失败语义一致且不暴露账号存在性
- [x] 完成认证数据模型与持久化实现 (AC: 1,3,4,5)
  - [x] 基于 TypeORM migration 增加会话与 refresh token 持久化结构（含 状态、过期时间、轮转关联字段）
  - [x] 密码仅保存哈希，日志与审计输出中禁止明文凭据
- [x] 实现密码登录主链路 (AC: 1,2)
  - [x] 校验手机号、密码哈希、用户状态并签发 JWT（RS256）
  - [x] 登录成功写入会话记录并返回 `request_id` / 会话标识
- [x] 实现 refresh rotation 与重放处置基线 (AC: 3)
  - [x] refresh 成功后生成新 token 对并使旧 token 立即失效
  - [x] 对已失效/已轮转 token 的再次使用返回统一未授权响应并记录审计事 件
- [x] 实现当前会话登出与改密后重登 (AC: 4,5)
  - [x] `logout` 仅撤销当前会话，不影响同用户其他会话
  - [x] 修改密码成功后使当前认证会话失效并要求重新登录（仅新密码可用）
- [x] 完成测试与回归门禁 (AC: 1,2,3,4,5)
  - [x] 单元测试覆盖：密码校验、token 签发、rotation、logout 范围控制、改密后认证
  - [x] API/E2E 覆盖：错误语义一致性、并发会话下当前会话登出、旧 refresh token 失效验证

### Review Follow-ups (AI)



- [x] [AI-Review][High] 移除运行态默认种子账号/默认凭据登录能力，改为仅允许受控初始化通道注入用户 [apps/api/src/modules/auth/auth.service.js:11]

- [x] [AI-Review][High] 将认证会话与 refresh token 从内存 Map 迁移到数 据库持久化读写，确保与 migration 表结构一致 [apps/api/src/modules/auth/auth.service.js:224]

- [x] [AI-Review][Medium] 对齐 OpenAPI 与真实错误语义：为 `/auth/login`、`/auth/refresh` 增加 400 `AUTH-400-INVALID-PAYLOAD` 响应契约 [apps/api/src/openapi.js:61]

- [x] [AI-Review][Medium] 增补基于 Nest/Express 实际启动路径的 API 集成测试，避免仅覆盖 `handleApiRoute` 造成测试漂移 [apps/api/test/auth.api.test.js:3]

- [x] [AI-Review][High] Commit untracked implementation and test files: `apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/test/auth.express.api.test.js` [git status]

- [x] [AI-Review][High] Update `auth.express.api.test.js` to use `testcontainers` or a real MySQL instance instead of injecting `seedUsers` (which forces in-memory store), ensuring `auth.store.mysql.js` is actually exercised by tests. [apps/api/test/auth.express.api.test.js]

- [x] [AI-Review][Medium] Update Story File List to include modified infrastructure files: `docker-compose.yml` and `tools/smoke.js`. [docker-compose.yml]

- [x] [AI-Review][Low] Enhance replay defense: When a refresh token replay is detected, consider revoking the *entire* session chain (all descendant tokens) to mitigate risk from a stolen token. [apps/api/src/modules/auth/auth.service.js]
- [x] [AI-Review][Medium] Verify and ensure `docker-compose.yml` and `tools/smoke.js` are listed in the 'File List' section of the story, as they were modified during implementation.

### Review Follow-ups (AI-Round 2)

- [x] [AI-Review][High] 引入数据库事务支持，确保 refresh rotation 操作（更新旧 token、创建新 token、关联 rotation）的原子性 [apps/api/src/modules/auth/auth.service.js:467]
- [x] [AI-Review][High] 将修改密码与撤销全部用户会话包装在同一个数据库事务中，防止改密后旧会话残留 [apps/api/src/modules/auth/auth.service.js:558]
- [x] [AI-Review][Medium] 优化 `assertValidAccessSession` 的性能风险：确认数据库索引支持或引入极短时间的会话状态缓存 [apps/api/src/modules/auth/auth.service.js:379]
- [x] [AI-Review][Medium] 统一 MySQL 时间戳精度处理：在 migration 中使用 `TIMESTAMP(3)` 并确保代码中 UNIX 时间戳转换不丢失精度 [apps/api/src/modules/auth/auth.store.mysql.js:155]
- [x] [AI-Review][Low] 增强 JWT 密钥管理：在多实例部署环境下，强制使用外部注入的固定密钥对或持久化 JWKS [apps/api/src/modules/auth/auth.service.js:309]
- [x] [AI-Review][Low] 完善审计追踪：在登录失败事件中记录尝试登录的手机号（脱敏处理），以便追踪恶意暴力破解 [apps/api/src/modules/auth/auth.service.js:321]

### Review Follow-ups (AI-Round 3)

- [x] [AI-Review][Medium] 解决多实例缓存一致性风险：评估 800ms 缓存空窗期对会话撤销的影响，或在 `AUTH_MULTI_INSTANCE` 模式下引入更严格的失效策略 [apps/api/src/modules/auth/auth.service.js:424]
- [x] [AI-Review][Medium] 优化 `refresh` 链路原子性：确保 JWT 签发逻辑在数据库事务确认之后执行，防止数据库更新失败但 Token 已泄露 [apps/api/src/modules/auth/auth.service.js:504]
- [x] [AI-Review][Low] 统一审计元数据：在 `refresh`、`changePassword` 等所有认证失败路径中补齐脱敏上下文（如 `phone_masked` 或 `session_id`） [apps/api/src/modules/auth/auth.service.js:458]
- [x] [AI-Review][Low] 增强脱敏逻辑鲁棒性：优化 `maskPhone` 以适配不同长度的标识符，避免超短号码导致的脱敏异常 [apps/api/src/modules/auth/auth.service.js:217]

### Review Follow-ups (AI-Round 4)

- [x] [AI-Review][High] Story File List 与 git 现实不一致：列出了 `_bmad-output/implementation-artifacts/1-2-密码登录-会话刷新与当前会话登出.md` 与 `_bmad-output/implementation-artifacts/sprint-status.yaml`，但当前工作树无对应变更证据 [git diff --name-only]
- [x] [AI-Review][High] Problem Details 契约漂移：`openapi` 将 `error_code` 定义在 `extensions` 下，但运行时响应为顶层字段，违反“统一错误语义”任务声明 [apps/api/src/openapi.js:548]
- [x] [AI-Review][High] Story 状态一致性错误：故事头部状态为 `done`，而 sprint 跟踪仍为 `review`，文档状态不可信 [ _bmad-output/implementation-artifacts/sprint-status.yaml:45 ]
- [x] [AI-Review][Medium] 有 11 个已变更文件未记录在 Story File List（含 OTP/Web 相关改动），变更透明性不足 [git diff --name-only]
- [x] [AI-Review][Medium] 测试门禁可误绿：`auth.express.api.test.js` 在 MySQL 不可达时直接 `t.skip`，导致“API/E2E 覆盖已完成”无法稳定验证 [apps/api/test/auth.express.api.test.js:136]

### Review Follow-ups (AI-Round 5)

- [x] [AI-Review][High] 门禁状态与 Story 状态冲突：当前 `Status: review` 但执行 `pnpm nx test` 结果为失败（5 failing tests），不满足进入评审态条件 [apps/api/test/auth.express.api.test.js:294]
- [x] [AI-Review][High] 任务勾选不实：`完成测试与回归门禁` 已勾选，但全量测试未通过（MySQL/Redis 集成链路失败） [ _bmad-output/implementation-artifacts/1-2-密码登录-会话刷新与当前会话登出.md:38 ]
- [x] [AI-Review][Medium] Story 1.2 可追踪性退化：File List 混入 Story 1.3 OTP/Web 文件，超出本故事 AC 范围，降低审查可读性与归责精度 [ _bmad-output/implementation-artifacts/1-2-密码登录-会话刷新与当前会话登出.md:179 ]
- [x] [AI-Review][Medium] Redis 集成门禁仍可被环境变量绕过：`ALLOW_INTEGRATION_SKIPS=true` 时会跳过 Redis 用例，仍存在误绿通道 [apps/api/test/auth.otp.redis.api.test.js:33]

## Dev Notes

- Story 1.1 已完成基座与占位，当前故事应在既有 `apps/api/src/modules/auth` 基础上演进，避免重新搭建认证框架。
- 认证/会话基线必须遵循架构：JWT（RS256）+ refresh rotation + replay detection + `session_version` 协同收敛。
- 错误输出统一走 Problem Details，禁止在控制器或路由内定义分散错误格式。
- 会话并发策略必须满足“允许多会话并发，logout 仅当前会话失效”。
- 改密后应确保旧凭据不可继续认证，且重新登录后获得新会话。

### Project Structure Notes

- API 实现建议集中在：
  - `apps/api/src/modules/auth/*`（登录/刷新/登出/改密路由与服务）
  - `apps/api/src/common/problem-details.js`（统一错误响应复用）
  - `apps/api/src/openapi.js`（契约补全）
  - `apps/api/migrations/*`（会话与 token 相关结构）
- 基础设施复用现有连接层，不新增旁路数据库/缓存访问入口。

### References

- Story 定义与验收标准: [Source: _bmad-output/planning-artifacts/epics.md#Story 1.2]
- 相关 FR（FR1/FR3/FR4/FR5/FR67）: [Source: _bmad-output/planning-artifacts/prd.md#认证与访问入口]
- 会话并发与 logout 约束: [Source: _bmad-output/planning-artifacts/prd.md#FR67]
- 安全与会话架构约束（JWT/rotation/session_version）: [Source: _bmad-output/planning-artifacts/architecture.md#Authentication & Security]
- API 错误模型与统一输出约束: [Source: _bmad-output/planning-artifacts/architecture.md#API & Communication Patterns]
- 模块与目录边界: [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries]
- Story 1.1 既有实现上下文: [Source: _bmad-output/implementation-artifacts/1-1-基座初始化与全-docker-本地环境.md]

## Dev Agent Record

### Agent Model Used

gpt-5-codex

### Debug Log References

- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm nx lint`
- `pnpm nx test`
- `pnpm nx build`
- `pnpm nx smoke`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- `docker compose up -d mysql`
- `docker compose up -d redis`
- `docker compose ps mysql redis`

### Completion Notes List

- 已完成密码登录、refresh rotation、当前会话 logout、改密后重登四条认证主链路，输出 `request_id` 与 `session_id` 供追踪。
- 新增统一认证错误码映射并复用 Problem Details 输出：登录失败统一 `AUTH-401-LOGIN-FAILED`，refresh 失效/重放统一 `AUTH-401-INVALID-REFRESH`，避免账号存在性泄露。
- 新增 `auth_sessions` 与 `refresh_tokens` migration（状态、过期、轮转关联字段），并将 migration runner 升级为按版本顺序执行全部 SQL 文件。
- 登录/刷新使用 RS256 JWT；refresh rotation 后旧 token 立即失效，重复使用触发拒绝并记录审计事件。
- 支持多并发会话；`logout` 仅撤销当前会话，其他会话可继续 refresh。
- 修改密码后递增会话版本并失效既有会话，旧密码无法继续认证，仅新密码可登录。
- 已补齐 OpenAPI 契约（login/refresh/logout/change-password 请求响应与错误示例）并新增单元+API 级测试覆盖关键场景。
- 已移除认证服务默认种子账号：运行态不再自动注入 `13800000000/Passw0rd!`，仅允许受控初始化通道（`seedUsers` 或 `authStore` 注入）提供账号。
- 已新增 `auth.store.mysql` 持久化实现并将 `createApiApp` 默认认证路径切换为 MySQL 存储，`auth_sessions`/`refresh_tokens` 改为数据库读写与轮转关联更新。
- 已新增基于 `createApiApp + Express route handler` 的集成测试覆盖，验证 `/auth/login`、`/auth/refresh` 在真实启动路径下的 400 契约与 refresh replay 拒绝行为。
- 已完成回归门禁：`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`、`pnpm nx lint`、`pnpm nx test`、`pnpm nx build`、`pnpm nx smoke` 全通过。
- 已补充 smoke Docker 拉镜像瞬时失败重试能力（`SMOKE_DOCKER_COMPOSE_UP_ATTEMPTS`、`SMOKE_DOCKER_COMPOSE_UP_RETRY_DELAY_MS`），并修复 `mysql:8.4` 启动参数兼容性后验证 `pnpm nx smoke` 通过。
- 已将 `auth.express.api.test.js` 改为真实 MySQL 后端集成路径：不再注入 `seedUsers`，通过 `createApiApp` 默认 MySQL store 验证登录/refresh/replay。
- 已在 refresh replay 场景增加整会话撤销：当检测到已轮转/已撤销 token 重放时，撤销当前会话全部活跃 refresh token 链。
- 已将先前 3 个未跟踪文件加入版本控制索引（不再是 untracked）：`auth.store.mysql.js`、`auth.store.memory.js`、`auth.express.api.test.js`。
- 已为 MySQL client 增加事务执行能力，并在 MySQL auth store 中落地 `rotateRefreshToken` / `updateUserPasswordAndRevokeSessions` 原子接口。
- 已将 refresh rotation 与改密撤销链路切换为事务优先路径，避免旧 token 更新与新 token 写入、改密与会话撤销之间出现中间态。
- 已为 access 会话校验新增极短 TTL 会话缓存（默认 800ms），并在 `AUTH_MULTI_INSTANCE` 模式自动禁用缓存以避免跨实例失效窗口。
- 已新增 `0003_auth_timestamp_precision.sql`，统一 `auth_sessions`/`refresh_tokens` 为 `TIMESTAMP(3)`，并将 refresh 过期时间改为毫秒精度读写。
- 已增强 JWT 密钥治理：支持外部注入固定密钥对，且在 `AUTH_MULTI_INSTANCE=true` 时强制要求外部密钥。
- 已增强登录失败审计：新增脱敏手机号字段 `phone_masked`，用于暴力破解追踪。
- 已优化 refresh 流程顺序：先完成数据库 rotation 事务，再签发并返回新 JWT，避免数据库失败时 token 先行生成风险。
- 已补齐失败审计元数据：`refresh`/`changePassword` 拒绝路径统一记录 `session_id_hint` 或 `phone_masked`。
- 已增强 `maskPhone` 对超短标识符的鲁棒性，避免脱敏异常。
- 已移除 `auth.express.api.test.js` 的 `ALLOW_INTEGRATION_SKIPS/t.skip` 旁路；MySQL 不可用时测试直接失败，避免 API/E2E 门禁误绿。
- 已复核 Problem Details 契约与运行时一致性：`ProblemDetails.error_code` 为顶层字段且无 `extensions` 属性（`pnpm nx test` 通过相关断言）。
- 已将 Story File List 与当前工作树变更对齐，补齐 OTP 与 Web 相关变更文件，解决文档与 git 现实漂移。
- 已将故事状态与 sprint 状态同步更新为 `review`，并以完整回归通过作为收口门禁。
- 已移除 `auth.otp.redis.api.test.js` 的 `ALLOW_INTEGRATION_SKIPS/t.skip` 旁路；Redis 不可用时测试直接失败，消除误绿入口。
- 已在 MySQL/Redis 均健康前提下重跑 `pnpm nx test`，结果 `api 34/34`、`web 3/3` 全通过，门禁与评审态一致。
- 已按 Story 1.2 AC 范围收敛 File List，仅保留密码登录/refresh/logout/改密相关实现与测试文件，移除 OTP/Web 混入项。

### File List

- apps/api/migrations/0003_auth_timestamp_precision.sql
- apps/api/src/app.js
- apps/api/src/config/env.js
- apps/api/src/http-routes.js
- apps/api/src/infrastructure/connectivity.js
- apps/api/src/infrastructure/mysql-client.js
- apps/api/src/modules/auth/auth.routes.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/openapi.js
- apps/api/src/server.js
- apps/api/test/auth.api.test.js
- apps/api/test/auth.express.api.test.js
- apps/api/test/auth.service.test.js
- apps/api/test/server.test.js
- docker-compose.yml
- tools/smoke.js

### Change Log

- 2026-02-11: 完成 Story 1.2 认证与会话实现（密码登录、refresh rotation、当前会话登出、改密后重登），补齐 OpenAPI 与 migration，并通过 lint/test/build；受环境限制 smoke 未能连接本机 Docker daemon。
- 2026-02-11: Addressed code review findings - 4 items resolved（移除默认凭据、会话与 refresh 持久化、OpenAPI 400 契约补齐、Nest/Express 启动路径集成测试补齐）。
- 2026-02-12: Addressed additional code review findings - 4 items resolved（未跟踪文件纳入版本控制索引、Express 集成测试切换真实 MySQL store、File List 补全 docker/smoke 基础设施文件、refresh replay 触发整会话链撤销）。
- 2026-02-12: Addressed AI-Round-2 findings - 6 items resolved（refresh/change-password 事务化、会话短缓存、TIMESTAMP(3)+毫秒精度、多实例外部 JWT 密钥强制、登录失败手机号脱敏审计）。
- 2026-02-12: Addressed AI-Round-3 findings - 4 items resolved（多实例缓存自动禁用、refresh 先事务后签发、失败审计元数据统一、maskPhone 鲁棒性增强）。
- 2026-02-12: 第四轮代码审查未通过；新增 5 条 Follow-ups（3 High, 2 Medium），状态回退为 in-progress。
- 2026-02-12: Addressed AI-Round-4 findings - 5 items resolved（移除 auth.express.api.test.js 可跳过门禁、校验 ProblemDetails 契约一致性、同步 Story/sprint 状态、补齐 File List 与 git 变更一致）。
- 2026-02-12: 第五轮代码审查未通过；新增 4 条 Follow-ups（2 High, 2 Medium），状态回退为 in-progress。
- 2026-02-12: Addressed AI-Round-5 findings - 4 items resolved（移除 Redis 测试跳过旁路、恢复并验证全量回归门禁通过、收敛 Story 1.2 File List 范围、同步状态至 review）。

### Senior Developer Review (AI) - Round 4

- Reviewer: 老大
- Date: 2026-02-12
- Outcome: Changes Requested
- Findings Summary: 3 High, 2 Medium
- Evidence:
  - Git vs Story 差异：`IN_GIT_NOT_IN_STORY = 11`，`IN_STORY_NOT_IN_GIT = 2`
  - `apps/api/src/openapi.js` 的 `ProblemDetails` schema 使用 `extensions.error_code`，与 `buildProblemDetails` 顶层 `error_code` 输出不一致
  - `pnpm nx test` 结果存在 5 个 skip（MySQL/Redis 集成链路）

### Senior Developer Review (AI) - Round 5

- Reviewer: 老大
- Date: 2026-02-12
- Outcome: Changes Requested
- Findings Summary: 2 High, 2 Medium
- Evidence:
  - `pnpm nx test` 当前失败：`pass 29 / fail 5 / skipped 0`
  - 失败用例：`test/auth.express.api.test.js` 3 项（MySQL backend unavailable），`test/auth.otp.redis.api.test.js` 2 项（Redis integration unavailable）
  - Story 任务“完成测试与回归门禁”仍为 `[x]`
  - `apps/api/test/auth.otp.redis.api.test.js` 保留 `ALLOW_INTEGRATION_SKIPS` 跳过分支
