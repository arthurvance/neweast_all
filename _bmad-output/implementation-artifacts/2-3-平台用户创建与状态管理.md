# Story 2.3: 平台用户创建与状态管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 创建平台用户并维护其可用状态,  
so that 平台治理团队可以持续维护操作人员池。

## Acceptance Criteria

1. **Given** 平台管理员提交新平台用户信息  
   **When** 创建请求通过校验  
   **Then** 系统创建或复用用户身份并建立平台成员关系  
   **And** 返回可追踪的用户标识
2. **Given** 平台用户处于启用状态  
   **When** 管理员将其禁用  
   **Then** 用户状态立即变为禁用  
   **And** 禁用后仅平台域（`platform`）权限计算即时失效，组织域（`tenant`）不受影响
3. **Given** 平台用户处于禁用状态  
   **When** 管理员重新启用  
   **Then** 用户状态恢复可用  
   **And** 平台域（`platform`）权限按当前绑定重新生效，组织域（`tenant`）保持原状态

## Tasks / Subtasks

- [x] 任务 1：新增平台用户治理入口并复用既有“按手机号创建/复用”能力（AC: 1）
  - [x] 新增平台域用户治理路由（建议：`POST /platform/users`），由平台模块承接治理语义。
  - [x] 路由处理器必须复用现有 `authService.provisionPlatformUserByPhone`（或等效能力），禁止复制一套用户创建逻辑。
  - [x] 统一返回 `user_id`、`created_user`、`reused_existing_user`、`request_id`，并保持 `application/problem+json` 错误语义一致。
  - [x] 保留 `Idempotency-Key` 语义（同键同载荷重放返回首次结果；同键异载荷返回冲突）。

- [x] 任务 2：实现平台用户状态治理能力（AC: 2, 3）
  - [x] 新增状态治理路由（建议：`POST /platform/users/status`），最小字段：`user_id`、`status`（`active|disabled`），可选 `reason`。
  - [x] 在服务层实现状态切换编排：参数校验、目标用户存在性校验、状态空转（no-op）稳定语义、异常映射。
  - [x] 状态从 `active -> disabled` 时必须立即触发平台域（`platform`）权限失效路径（服务端最终判定生效），并触发平台域会话收敛。
  - [x] 状态从 `disabled -> active` 时恢复平台域可用性，但不得越权授予未绑定权限，也不得影响组织域（`tenant`）访问语义。

- [x] 任务 3：落实会话一致性与审计闭环（AC: 2, 3）
  - [x] 用户状态变更后执行域内会话收敛：仅撤销该用户 `platform` 域活动会话/refresh token，不跨域影响 `tenant`。
  - [x] 审计最小事件集：`platform.user.status.updated`（成功）与 `platform.user.status.rejected`（失败）。
  - [x] 审计字段至少包含：`request_id`、`operator_user_id`、`target_user_id`、`previous_status`、`next_status`、`error_code`（失败时）。

- [x] 任务 4：补齐契约与门禁声明（AC: 1, 2, 3）
  - [x] 更新 OpenAPI：新增/补齐平台用户创建与状态接口的请求体、响应体、错误示例（400/401/403/404/409/503）。
  - [x] 更新 `route-permissions` 声明，确保平台域权限码与 scope 一致，且通过 `check:route-permissions`。
  - [x] 继续使用外部字段 `snake_case`，并通过映射层隔离内部命名。

- [x] 任务 5：回归测试与双存储一致性验证（AC: 1, 2, 3）
  - [x] API 回归：创建成功（新用户）、创建成功（复用用户）、禁用成功、启用成功、目标不存在、权限不足、非法载荷。
  - [x] 语义回归：禁用后平台域权限即时失效且 tenant 域保持可用；启用后平台域权限按当前绑定恢复。
  - [x] 幂等回归：同键同载荷重放一致、同键异载荷冲突。
  - [x] 存储一致性回归：MySQL 与 in-memory 在“仅 platform 域状态切换 + 域内会话收敛”语义上保持一致。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`。

### Review Follow-ups (AI)

- [x] [AI-Review][High] 修复 `provisionPlatformUserByPhone` 预授权上下文透传缺失，避免空 access token 触发错误二次鉴权 [apps/api/src/modules/auth/auth.service.js:3577]
- [x] [AI-Review][Medium] 修复平台用户治理在上游鉴权抛出非 `AuthProblemError` 时误报 403 的语义偏差，统一映射为 503 依赖退化 [apps/api/src/modules/platform/user.service.js:266]
- [x] [AI-Review][Medium] 修复平台用户状态治理对存储层异常状态的 400 误映射，改为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` [apps/api/src/modules/auth/auth.service.js:3049]
- [x] [AI-Review][Medium] 修复 `createRouteHandlers` 在同时注入 `platformOrgService` 与 `platformUserService` 时缺少跨服务 `authService` 一致性校验，避免鉴权链路分叉 [apps/api/src/http-routes.js:26]
- [x] [AI-Review][Low] 补齐 `POST /platform/users` 的 503 OpenAPI 示例，覆盖实现中已返回的 `USR-503-DEPENDENCY-UNAVAILABLE` 语义 [apps/api/src/openapi.js:1810]
- [x] [AI-Review][Low] 补齐 `POST /platform/users/status` 的 503 OpenAPI 示例，覆盖透传 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 语义 [apps/api/src/openapi.js:2045]
- [x] [AI-Review][Medium] 修复 `createUser` 在上游返回缺失 `user_id` 时未记录 rejected 审计的问题，补齐失败可追踪性 [apps/api/src/modules/platform/user.service.js:340]
- [x] [AI-Review][High] 修复 `updateUserStatus` 未校验上游返回 `user_id` 与请求目标一致的问题，避免跨目标错误状态回写语义 [apps/api/src/modules/platform/user.service.js:497]
- [x] [AI-Review][Medium] 修复 `updateUserStatus` 对上游非法状态结果的 503 语义降级，统一映射为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` [apps/api/src/modules/platform/user.service.js:521]
- [x] [AI-Review][High] 修复组织状态切换后租户域访问缓存未即时失效导致短窗口内旧会话仍可放行的问题，状态变更时清空访问会话缓存 [apps/api/src/modules/auth/auth.service.js:969]
- [x] [AI-Review][Medium] 修复 Story 2.3 `File List` 与 git 实际变更不一致，补齐规划文档与前序 Story 联动修改记录 [_bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md:333]
- [x] [AI-Review][Low] 修复 OpenAPI `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 示例文案与实际返回 detail 不一致的问题 [apps/api/src/openapi.js:2052]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 1.9 已交付平台侧“按手机号创建/复用用户”能力（`/auth/platform/member-admin/provision-user`）；Story 2.3 必须在此基础上构建“平台治理入口 + 用户状态治理”，禁止重复造轮子。
- Story 2.2 已建立“状态变更 -> 会话收敛 -> 审计”主路径；Story 2.3 需复用同一防线，避免出现“状态已禁用但历史会话仍可用”回归。
- 当前 API 采用静态路由声明 + 权限声明门禁（fail-closed），新增路由必须同步声明并通过预检。
- Epic 2 后续故事（2.4/2.5）会继续扩展平台角色与权限树，本故事应保持向后兼容，不预埋破坏性重构。

### Technical Requirements（实现硬约束）

- 统一错误契约：`application/problem+json`，至少包含 `status`、`detail`、`error_code`、`request_id`、`retryable`（适用时）。
- 平台用户创建必须复用现有身份创建/复用逻辑，避免出现两套密码策略与用户初始化分叉。
- 平台用户状态允许值仅 `active|disabled`（兼容输入 `enabled` 时统一归一到 `active` 的策略需显式约定并测试）。
- 用户状态变更必须触发会话一致性收敛（仅 `platform` 域会话/refresh 失效处理，不影响 `tenant` 域）。
- 权限即时失效必须由服务端最终判定保证，不能依赖前端本地缓存。
- 关键写接口须支持 `Idempotency-Key`，并沿用当前幂等冲突语义。
- 所有状态变更必须记录审计事件，并保留前后状态与操作者信息。

### Architecture Compliance（架构对齐清单）

- 严格保持平台域/组织域边界：平台用户治理仅在 `platform` scope 下执行，不得越域影响 `tenant` 权限边界判定。
- 路由声明、权限声明、处理器实现必须三位一体同步更新，避免“声明有/实现无”或“实现有/声明无”。
- 外部 API 字段统一 `snake_case`；内部逻辑使用既有命名风格，跨层必须走显式映射。
- 关键状态变更需可追踪：`request_id` 全链路贯穿，审计事件可回放。
- MySQL 与 in-memory 两条存储实现必须保持行为一致，防止测试环境与运行环境语义漂移。

### Library & Framework Requirements（库与框架要求）

- 仓库当前依赖（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-17 实时核验（官方源）：
  - Node.js 最新稳定：`v25.6.1`
  - Node.js 最新 LTS：`v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 release notes 可见至 `8.4.8`
- 本故事策略：不做框架升级，仅按当前仓库锁定版本做增量实现并保证兼容。

### File Structure Requirements（建议变更落点）

- 平台用户模块（新增）：
  - `apps/api/src/modules/platform/user.constants.js`
  - `apps/api/src/modules/platform/user.routes.js`
  - `apps/api/src/modules/platform/user.service.js`
- 路由与门禁（修改）：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
- 复用与编排（按需要修改）：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约（修改）：
  - `apps/api/src/openapi.js`
- 测试（新增/修改）：
  - `apps/api/test/platform.user.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- AC1：平台用户创建
  - 新手机号：创建用户成功并建立平台关系，返回可追踪 `user_id`。
  - 已存在手机号：复用用户成功，不改写既有凭据。
- AC2：启用 -> 禁用
  - 状态立即切换为 `disabled`。
  - 平台域（`platform`）权限即时失效（受保护平台接口拒绝访问）。
  - 组织域（`tenant`）访问保持可用。
  - 关联会话收敛成功（仅 `platform` 域会话/refresh 语义符合预期）。
- AC3：禁用 -> 启用
  - 状态恢复 `active`。
  - 平台域（`platform`）权限按当前角色绑定恢复，不出现越权。
  - 组织域（`tenant`）访问语义保持不变。
- 错误与幂等
  - 非法参数、目标不存在、权限不足、依赖退化、同键异载荷冲突均返回稳定错误语义。
- 门禁与一致性
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence

- 来自 Story 2.2 的关键经验：
  - 新能力必须“实现 + OpenAPI + 回归测试”同步交付。
  - 状态治理不能停留在数据写入，必须带来真实访问效果变化。
  - 会话收敛是状态治理的安全底线，不能省略。
  - 审计字段必须完整且语义稳定（特别是前后状态与错误码）。
- 对 Story 2.3 的直接约束：
  - 不新建平行的错误码体系或幂等语义。
  - 不绕开既有授权与路由门禁机制。
  - 不引入大规模目录重构。

### Git Intelligence Summary

- 最近 5 次提交表明平台治理能力集中在以下热点：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/modules/platform/*`
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可执行结论：
  - 本故事应走“平台模块新增 + auth 模块复用 + 契约/测试联动”路线。
  - 优先做可回归增量，不做框架迁移或仓库结构调整。

### Latest Tech Information（2026-02-17）

- Node.js 官方发布索引：Latest `v25.6.1`；Latest LTS `v24.13.1`。
- npm registry 最新版本：`@nestjs/core 11.1.13`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`。
- MySQL 8.4 release notes 当前可见最新条目 `8.4.8`。
- 结论：本故事以稳定增量为主，不执行依赖升级；重点放在状态治理语义与安全回归覆盖。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 当前故事上下文来源：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、Story 2.2 文档、当前代码与最近提交历史。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed with all findings fixed and quality gates passing`

### Project Structure Notes

- 现状仅有 `modules/platform/org.*`，本故事建议新增 `modules/platform/user.*`，与组织治理平级，保持平台治理模块清晰边界。
- 路由仍采用静态映射，不引入动态路径匹配框架改造。
- 若变更触达 `auth.store`，必须同时维护 MySQL 与 in-memory 行为一致性。

### References

- Epic 2 / Story 2.3（用户故事与 AC）  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.3: 平台用户创建与状态管理]
- FR13/FR14 与平台治理能力  
  [Source: _bmad-output/planning-artifacts/prd.md#平台治理能力（Platform Governance）]
- 关键状态变更会话收敛与用户状态语义  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Data Model Baseline]
- 架构边界、命名/结构/流程一致性  
  [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries]
- 平台治理交互与反馈一致性规则  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Journey Patterns]
- 前序故事经验  
  [Source: _bmad-output/implementation-artifacts/2-2-组织状态治理-启用-禁用.md]
- 现有平台能力与路由基线  
  [Source: apps/api/src/modules/auth/auth.routes.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/modules/platform/org.routes.js]  
  [Source: apps/api/src/modules/platform/org.service.js]  
  [Source: apps/api/src/http-routes.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/openapi.js]
- 版本核验来源  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Senior Developer Review (AI)

### Round 1（2026-02-17）

- 已发现并修复平台用户状态治理的域边界问题：目标用户必须具备 `platform` 域访问，否则返回 `AUTH-404-USER-NOT-FOUND`。
- 已补齐权限不足回归：新增 `POST /platform/users` 与 `POST /platform/users/status` 的 `AUTH-403-FORBIDDEN` API 用例。
- 已补齐服务层回归：新增“tenant-only 用户不可被平台状态接口治理”的 `auth.service` 用例。

### Round 2（2026-02-17）

- 独立重新读取 story 与变更文件并重跑完整门禁后，本轮无问题输出。

### Round 3（2026-02-17）

- 已修复平台用户审计日志中的明文手机号泄露风险：`platform.user.*` 事件改为记录脱敏手机号（如 `138****0041`）。
- 已修复状态治理错误映射问题：`POST /platform/users/status` 对非 404 的上游 `AuthProblemError` 改为透传，避免被错误降级为 `USR-503-DEPENDENCY-UNAVAILABLE`。
- 已补齐防回归测试：新增手机号脱敏断言与“非 404 上游错误透传”用例。

### Round 4（2026-02-17）

- 已修复 `provisionPlatformUserByPhone` 包装层未透传 `authorizedRoute` 的缺陷，确保预授权上下文可在无 access token 场景下稳定复用。
- 已修复平台用户治理鉴权链路的异常映射：非 `AuthProblemError` 上游故障不再误报 403，统一返回 `USR-503-DEPENDENCY-UNAVAILABLE`。
- 已修复平台用户状态治理对存储层异常状态的错误语义：不再返回 400，统一映射为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`。
- 已补齐防回归测试并重跑完整门禁（`check:route-permissions` / `lint` / `test`）全通过。

### Round 5（2026-02-17）

- 已修复 `createRouteHandlers` 在同时注入 `platformOrgService` 与 `platformUserService` 且未显式注入 `authService` 时的漏检问题：若两者底层 `authService` 不一致，启动即 fail-fast。
- 已补齐 OpenAPI 契约示例与实现对齐：`POST /platform/users` 增加 `USR-503-DEPENDENCY-UNAVAILABLE` 示例；`POST /platform/users/status` 增加 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 示例。
- 已补齐防回归测试（`server.test` 新增 fail-fast 与 503 示例断言）并通过相关测试与门禁复核。

### Round 6（2026-02-17）

- 已修复 `createUser` 在上游返回缺失 `user_id` 时仅抛错未审计的问题：新增 rejected 审计事件并记录 `PLATFORM-USER-PROVISION-RESULT-MISSING-USER-ID`。
- 已修复 `updateUserStatus` 未验证上游 `user_id` 一致性的缺陷：若目标不一致即返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`，并记录 `upstream_target_user_id`。
- 已修复 `updateUserStatus` 对上游非法状态回包的泛化 `USR-503` 映射：改为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 并补齐降级原因。
- 已补齐防回归测试并重跑完整门禁（`check:route-permissions` / `lint` / `test`）全通过。

### Round 7（2026-02-17）

- 独立复核 Story 2.3 的实现与测试证据：逐项核对 AC、任务清单、File List 与 git 变更，未发现新的功能/语义回归问题。
- 复核门禁结果：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test` 均通过。
- 结论：维持 `done`，本轮无新增 Review Follow-up。

### Round 8（2026-02-17）

- 已修复组织状态治理的即时收敛缺口：当租户域访问已被缓存时，`updateOrganizationStatus` 变更后将清空访问会话缓存，避免 TTL 窗口内旧会话继续放行。
- 已补齐防回归测试：在“先 tenant authorize 缓存命中，再 disable 组织”场景下，旧 access token 会被立即拒绝（401）。
- 已修复契约文案漂移：`/platform/users/status` 的 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED` 示例 detail 与实现保持一致。
- 已修复文档追踪漂移：Story 2.3 `File List` 补齐本轮 git 发现的遗漏文件，保证审查可追踪性。

### Round 9（2026-02-17）

- 按 `CR 2-3` 指令执行独立复核：重新核对 AC、Tasks、File List 与 git 变更，未发现新增功能/语义回归问题。
- 复跑门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test` 全通过。
- 结论：维持 `done`，本轮无新增 Review Follow-up。

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-3-平台用户创建与状态管理`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- loaded artifacts: `epics.md` + `prd.md` + `prd-appendix-legacy-inputs.md` + `architecture.md` + `ux-design-specification.md`
- previous story analyzed: `_bmad-output/implementation-artifacts/2-2-组织状态治理-启用-禁用.md`
- recent git commits analyzed: `819a4b1`, `7e753cb`, `d7b34e0`, `b62b0e1`, `1567461`
- live version checks: `pnpm view` + `nodejs.org/dist/index.json` + MySQL 8.4 release notes
- red-green test command: `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/route-permissions.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/server.test.js`
- quality gates: `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`
- review round 1 fix verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.user.api.test.js`
- review round 2 independent verification: `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`
- review round 3 fix verification: `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/auth.service.test.js`
- review round 4 fix verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.user.api.test.js` + `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`
- review round 5 fix verification: `pnpm --dir apps/api exec node --test test/server.test.js` + `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/route-permissions.test.js test/server.test.js` + `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint`
- review round 6 fix verification: `pnpm --dir apps/api exec node --test test/platform.user.api.test.js` + `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`
- review round 8 fix verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.user.api.test.js test/auth.store.mysql.test.js test/route-permissions.test.js test/server.test.js` + `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`
- review round 9 independent verification: `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/route-permissions.test.js test/server.test.js` + `pnpm --dir apps/api check:route-permissions` + `pnpm --dir apps/api lint` + `pnpm --dir apps/api test`

### Completion Notes List

- [x] 已完成 Story 2.3 上下文聚合与约束落地文档生成
- [x] 已完成架构/PRD/UX/前序故事/近期提交的交叉分析
- [x] 已完成最新技术版本核验并形成实施策略（不升级，仅增量实现）
- [x] 已新增平台用户治理模块：`POST /platform/users` 与 `POST /platform/users/status`，并复用 `authService.provisionPlatformUserByPhone`
- [x] 已实现平台用户状态切换编排与异常映射，支持 `enabled -> active` 归一化和 no-op 稳定语义
- [x] 已在 MySQL / in-memory 双存储实现 `updatePlatformUserStatus`，仅收敛 `platform` 域会话/refresh（不影响 `tenant` 域）
- [x] 已完成审计闭环：`platform.user.status.updated` / `platform.user.status.rejected` 及关键审计字段落地
- [x] 已完成 OpenAPI、route-permissions、server/idempotency 路由声明联动更新
- [x] 已补齐 API/服务/存储/门禁/OpenAPI 回归测试，且全量测试与 lint/门禁通过
- [x] 已修复平台用户状态治理域边界：非 platform 域用户返回 `AUTH-404-USER-NOT-FOUND`
- [x] 已补齐 `POST /platform/users` 与 `POST /platform/users/status` 的权限不足（403）回归测试
- [x] 已修复平台用户审计事件手机号明文输出，统一脱敏记录
- [x] 已修复平台用户状态治理的非 404 上游错误映射，保持原始错误语义
- [x] 已补齐对应回归测试（手机号脱敏 + 上游错误透传）
- [x] 已修复 `provisionPlatformUserByPhone` 预授权上下文透传缺失（`authorizedRoute`）导致的空 token 二次鉴权风险
- [x] 已修复平台用户治理对非 `AuthProblemError` 鉴权异常的 403 误映射，改为 503 依赖退化语义
- [x] 已修复平台用户状态治理对存储层异常状态的 400 误映射，改为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`
- [x] 已补齐 Round 4 回归测试并确认全量门禁通过
- [x] 已修复 `createRouteHandlers` 对 `platformOrgService` 与 `platformUserService` 的跨服务 `authService` 一致性漏检
- [x] 已补齐 `/platform/users` 与 `/platform/users/status` 的 503 OpenAPI 示例，使契约与实现返回错误码一致
- [x] 已补齐 Round 5 回归测试并确认相关门禁复核通过
- [x] 已修复 `createUser` 对上游异常成功回包（缺失 `user_id`）的审计漏记问题，并补齐失败追踪字段
- [x] 已修复 `updateUserStatus` 上游 `user_id` 不一致未拦截问题，新增一致性校验与降级语义
- [x] 已修复 `updateUserStatus` 对上游非法状态结果的错误码语义，统一为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`
- [x] 已补齐 Round 6 回归测试并确认完整门禁复核通过
- [x] 已修复组织状态切换后访问缓存即时失效缺口，并补齐“缓存命中后禁用立即拒绝”回归测试
- [x] 已修复 `/platform/users/status` 的平台快照降级示例文案与实现 detail 漂移
- [x] 已补齐 Story 2.3 File List 与 git 实际变更对齐项（规划文档与前序 story 联动变更）
- [x] 已完成 Round 9 独立复核（无新增问题）并复跑门禁通过

### File List

- _bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md
- _bmad-output/implementation-artifacts/2-2-组织状态治理-启用-禁用.md
- _bmad-output/implementation-artifacts/sprint-status.yaml
- _bmad-output/planning-artifacts/epics.md
- _bmad-output/planning-artifacts/prd.md
- apps/api/src/modules/platform/user.constants.js
- apps/api/src/modules/platform/user.routes.js
- apps/api/src/modules/platform/user.service.js
- apps/api/src/http-routes.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/openapi.js
- apps/api/src/route-permissions.js
- apps/api/src/server.js
- apps/api/test/platform.user.api.test.js
- apps/api/test/auth.service.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/route-permissions.test.js
- apps/api/test/server.test.js

## Change Log

- 2026-02-17: 完成 Story 2.3 实现，新增平台用户创建与状态治理接口、状态收敛链路、审计事件、契约与门禁声明，并补齐全套回归测试与质量门禁。
- 2026-02-17: 执行两轮独立 `bmad-bmm-code-review` 式审查并修复，新增平台域边界保护与权限不足回归测试，复审无问题。
- 2026-02-17: Round 3 复审修复审计脱敏与错误映射语义问题，并补齐对应回归测试。
- 2026-02-17: Round 4 复审修复预授权透传缺失、鉴权异常误映射与状态异常误映射问题，并完成全量门禁复核通过。
- 2026-02-17: Round 5 复审修复跨服务 `authService` 一致性漏检，并补齐平台用户治理 503 OpenAPI 示例契约与回归测试。
- 2026-02-17: Round 6 复审修复上游异常成功回包审计漏记、状态治理上游目标不一致拦截缺失与非法状态错误码语义问题，并完成全量门禁复核通过。
- 2026-02-17: Round 7 独立复核无新增问题，门禁复跑通过，状态维持 `done`。
- 2026-02-17: 语义收敛补充：平台用户 `disabled` 仅影响 `platform` 域；组织侧 `disabled` 仅影响 `tenant` 域，并同步 PRD/AC/OpenAPI/错误码文案与回归测试。
- 2026-02-17: Round 8 复审修复组织状态治理的访问缓存即时失效缺口，补齐缓存命中场景回归测试，并同步修正文档 File List 与 OpenAPI 示例文案一致性。
- 2026-02-17: Round 9 独立复核无新增问题，复跑 `check:route-permissions` / `lint` / `test` 全通过，状态维持 `done`。
