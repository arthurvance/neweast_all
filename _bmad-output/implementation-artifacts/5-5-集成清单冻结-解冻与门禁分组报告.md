# Story 5.5: 集成清单冻结-解冻与门禁分组报告

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 发布负责人,  
I want 在发布窗口执行集成清单冻结/解冻并输出门禁分组报告,  
so that 集成发布节奏稳定且风险可控。

## Acceptance Criteria

1. **Given** 发布窗口开始  
   **When** 操作者执行集成清单冻结  
   **Then** 非授权变更被阻断  
   **And** 冻结状态可审计与可回滚
2. **Given** 发布验证完成  
   **When** 操作者执行解冻  
   **Then** 集成配置恢复可变更状态  
   **And** 保留冻结/解冻完整审计轨迹
3. **Given** 回归门禁执行结束  
   **When** 输出验证结果  
   **Then** 系统按能力分组生成结果报告  
   **And** 报告可用于发布决策与复盘归档

## Tasks / Subtasks

- [x] 任务 1：落地“集成清单冻结状态”持久化模型与迁移（AC: 1, 2）
  - [x] 新增迁移（建议 `0024_platform_integration_freeze_control.sql` 与 down）定义冻结控制表，至少覆盖：`freeze_id`、`status(active|released)`、`freeze_reason`、`rollback_reason`、`frozen_at`、`released_at`、`frozen_by_user_id`、`released_by_user_id`、`request_id`、`traceparent`、`created_at`、`updated_at`。
  - [x] 增加“同一时刻最多一个 active 冻结窗口”的数据库约束（唯一键/等价约束），防止并发重复冻结。
  - [x] 迁移测试补齐到 `apps/api/test/migrate-baseline.test.js`，确保 schema、索引、down 语义稳定。

- [x] 任务 2：在 store 层实现冻结/解冻读写能力（MySQL + memory）并保持 fail-closed（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.store.mysql.js` 增加冻结状态读写方法（查询当前冻结、执行冻结、执行解冻、查询最近冻结记录）。
  - [x] 在 `apps/api/src/modules/auth/auth.store.memory.js` 提供同语义实现，避免测试环境和生产语义漂移。
  - [x] 对冻结记录读取结果执行结构化校验；任何畸形数据统一映射 `503`（fail-closed）。

- [x] 任务 3：新增平台侧冻结治理 API（AC: 1, 2）
  - [x] 新增模块文件：
    - `apps/api/src/modules/platform/integration-freeze.constants.js`
    - `apps/api/src/modules/platform/integration-freeze.routes.js`
    - `apps/api/src/modules/platform/integration-freeze.service.js`
  - [x] 建议最小接口集合：
    - `GET /platform/integrations/freeze`（查询当前冻结状态与最近窗口）
    - `POST /platform/integrations/freeze`（执行冻结）
    - `POST /platform/integrations/freeze/release`（执行解冻）
  - [x] 冻结/解冻写接口要求 `Idempotency-Key` 保护，重复请求返回一致结果。
  - [x] 冻结冲突（已有 active 窗口）与解冻冲突（无 active 窗口）返回可识别 `409` 语义。

- [x] 任务 4：把冻结门禁接入集成变更链路（AC: 1）
  - [x] 在 `apps/api/src/modules/platform/integration.service.js` 为配置类写操作（create/update/lifecycle）增加“冻结态阻断”检查。
  - [x] 在 `apps/api/src/modules/platform/integration-contract.service.js` 为会改变契约状态的写操作（如 create/activate）增加冻结态阻断检查；只读和发布校验读取接口保持可用。
  - [x] 阻断响应统一 Problem Details：含 `error_code`、`request_id`、`traceparent`、`retryable=false` 与冻结上下文（`freeze_id`、`frozen_at`）。

- [x] 任务 5：复用现有门禁聚合器输出“集成发布窗口分组报告”（AC: 3）
  - [x] 在 `tools/release-gate-report.js` 复用既有分组框架，新增“integration-release-window”分组（或等价命名），映射 `FR56`、`FR58`。
  - [x] 新增脚本（建议）`apps/api/scripts/check-integration-freeze-gate.js`：校验冻结状态、关键校验链路与审计证据完整性，并输出结构化 JSON（供 release-gate-report 聚合）。
  - [x] 失败原因分类补齐：如 `integration-freeze-not-active`、`integration-freeze-state-malformed`、`integration-freeze-audit-missing`，并保持 deterministic 输出。
  - [x] 报告继续输出到 `artifacts/release-gates/`（JSON + Markdown），阻断规则保持“任一 blocking 组失败 -> blocking=true”。

- [x] 任务 6：接线路由分发、权限声明、幂等保护与 OpenAPI（AC: 1, 2, 3）
  - [x] 在 `apps/api/src/http-routes.js` 挂载 integration-freeze handlers 并注入 service。
  - [x] 在 `apps/api/src/server.js` 新增 route key 分发与 idempotency 保护集合（冻结/解冻写接口）。
  - [x] 在 `apps/api/src/route-permissions.js` 声明冻结查询/冻结/解冻受保护路由及权限码（读 `platform.member_admin.view`，写 `platform.member_admin.operate`）。
  - [x] 在 `apps/api/src/openapi.js` 增加冻结治理路径、schema、示例与错误语义（400/403/404/409/503）。
  - [x] 通过 `pnpm --dir apps/api check:route-permissions`。

- [x] 任务 7：审计与 runbook（AC: 1, 2, 3）
  - [x] 审计事件至少覆盖：
    - `platform.integration.freeze.activated`
    - `platform.integration.freeze.released`
    - `platform.integration.freeze.change_blocked`
  - [x] 事件必须支持按 `request_id` 检索，包含 `before_state/after_state` 或等价状态差异。
  - [x] 新增 runbook：`docs/runbooks/integration/freeze-unfreeze-release-gate.md`，包含冻结前置检查、门禁报告审阅、解冻步骤、回滚策略。

- [x] 任务 8：测试与回归门禁（AC: 1, 2, 3）
  - [x] 新增 `apps/api/test/platform.integration.freeze.api.test.js`：覆盖冻结成功、重复冻结冲突、解冻成功、无 active 解冻冲突、权限拒绝、审计查询。
  - [x] 扩展 `apps/api/test/platform.integration.api.test.js` 与 `apps/api/test/platform.integration.contract.api.test.js`：验证冻结期间配置写操作被阻断。
  - [x] 扩展 `apps/api/test/http-routes.test.js`、`apps/api/test/route-permissions.test.js`、`apps/api/test/release-gate-report.test.js`：验证接线、权限声明与分组报告阻断语义。
  - [x] 必过命令：
    - [x] `pnpm --dir apps/api check:route-permissions`
    - [x] `pnpm --dir apps/api lint`
    - [x] `pnpm --dir apps/api test`
    - [x] `node tools/release-gate-report.js`

### Review Follow-ups (AI)

- [x] [AI-Review][Medium] `OpenAPI` 在集成/契约写接口缺少冻结阻断 `409` 语义示例，已补齐 `INT-409-INTEGRATION-FREEZE-BLOCKED` 与冻结上下文字段。`[apps/api/src/openapi.js]`
- [x] [AI-Review][Medium] 发布门禁分组 `integration-release-window` 的 `fr_mapping` 未对齐 Story 5.5（应覆盖 `FR56`、`FR58`），已修正并同步测试断言。`[tools/release-gate-report.js]`
- [x] [AI-Review][Medium] 故事记录与真实实现漂移（状态/任务勾选/File List），已完成状态回写与变更清单同步。`[_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md]`
- [x] [AI-Review][High] Story 内部状态漂移：顶层 `Status: done` 与 “Story Completion Status” 的 `ready-for-dev` 冲突，已统一回写为 `done`。`[_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md]`
- [x] [AI-Review][Medium] `File List` 缺少真实变更文件 `apps/api/test/auth.store.mysql.test.js`，已补齐。`[_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md]`
- [x] [AI-Review][Medium] `File List` 缺少真实变更文件 `apps/api/test/auth.store.memory.freeze.test.js`，已补齐。`[_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md]`
- [x] [AI-Review][Low] Debug Log References 缺失 `pnpm --dir apps/api lint` 执行记录，已补齐。`[_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md]`

## Dev Notes

### Developer Context（开发者先读）

- 4.6 已交付通用“发布门禁分组报告”引擎，5.3 已把“契约一致性”接入该引擎，5.4 已交付失败重试/恢复闭环。5.5 不应重写聚合器，应在现有链路上追加“冻结窗口治理”能力。
- 当前仓库不存在冻结/解冻实现（`freeze|unfreeze` 无现成业务模块）；本故事核心是“新增冻结控制面 + 接入既有发布门禁”。
- 实施时优先保证 fail-closed：冻结状态不确定、依赖不可用、审计写入异常都不能被静默放行。

### Story Foundation（来自 Epic 5 全局上下文）

- 直接覆盖：`FR56`（集成清单冻结/解冻）、`FR58`（按能力分组输出发布门禁结果）。
- 关联约束：
  - `NFR14`：冻结/解冻写操作必须幂等防重。
  - `NFR15`：冻结与阻断链路保留 `request_id/traceparent`。
  - `NFR17`：上线前需形成 Integration DoD 证据链（含门禁报告与恢复路径）。
- 跨故事依赖：
  - 复用 `5.1` 集成目录与生命周期治理；
  - 复用 `5.2/5.3` 契约治理与一致性门禁；
  - 复用 `4.6` `tools/release-gate-report.js` 分组聚合与证据归档。

### Technical Requirements（硬约束）

- 冻结语义：
  - 发布窗口冻结后，非“冻结控制面”配置变更写路径必须阻断；
  - 读取与发布验证查询路径保持可用，确保门禁可执行与可审阅。
- 解冻语义：
  - 解冻后配置写操作恢复；
  - 必须保留完整冻结窗口链路（谁在何时因何冻结/解冻，关联 request_id）。
- 错误与幂等：
  - 冻结冲突/解冻冲突使用 `409`，依赖异常使用 `503`；
  - 冻结/解冻写接口进入 `IDEMPOTENCY_PROTECTED_ROUTE_KEYS`，并与现有冲突语义一致（`AUTH-409-IDEMPOTENCY-CONFLICT`）。
- 报告语义：
  - 分组报告必须包含冻结相关门禁分组结果；
  - 报告产物可用于发布决策和复盘归档（JSON + Markdown + evidence paths）。

### Architecture Compliance（架构对齐清单）

- 遵循 `architecture.md` 的 API 约束：REST + OpenAPI + Problem Details，受保护路由必须显式声明权限码。
- 遵循发布门禁约束：继续复用 `tools/release-gate-report.js` 统一聚合，避免平行第二套门禁脚本体系。
- 遵循可观测约束：冻结/解冻/阻断事件必须可按 `request_id` 检索，并能关联到发布门禁结果与 runbook。
- 遵循 fail-closed：冻结状态读取异常时，写路径默认阻断，不得降级为“允许写入”。

### Library & Framework Requirements（版本核验）

- 当前仓库（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 外部最新核验（2026-02-22）：
  - Node.js LTS：`v24.13.1`（Krypton）
  - Node.js Current：`v25.6.1`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS patch：`8.4.8`
- 本故事决策：不做依赖升级，优先交付冻结控制与门禁分组闭环。

### File Structure Requirements（建议变更落点）

- 新增（建议）：
  - `apps/api/migrations/0024_platform_integration_freeze_control.sql`
  - `apps/api/migrations/0024_platform_integration_freeze_control.down.sql`
  - `apps/api/src/modules/platform/integration-freeze.constants.js`
  - `apps/api/src/modules/platform/integration-freeze.routes.js`
  - `apps/api/src/modules/platform/integration-freeze.service.js`
  - `apps/api/scripts/check-integration-freeze-gate.js`
  - `apps/api/test/platform.integration.freeze.api.test.js`
  - `docs/runbooks/integration/freeze-unfreeze-release-gate.md`
- 修改（建议）：
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/modules/platform/integration.service.js`
  - `apps/api/src/modules/platform/integration-contract.service.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `tools/release-gate-report.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/release-gate-report.test.js`
  - `apps/api/test/platform.integration.api.test.js`
  - `apps/api/test/platform.integration.contract.api.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（必须覆盖）

- 冻结/解冻主流程：
  - 冻结成功后可查询 active 冻结窗口；
  - 重复冻结触发 409；
  - 解冻成功后恢复 mutable 状态；
  - 无 active 冻结直接解冻触发 409。
- 阻断语义：
  - 冻结期间目录与契约配置写操作被阻断；
  - 阻断响应包含冻结上下文（`freeze_id`、`frozen_at`）与 request 追踪字段。
- 分组报告：
  - 新增冻结分组在失败时能准确触发 `blocking=true`；
  - 失败原因分类稳定可解析（避免输出格式抖动导致误分类）。
- fail-closed：
  - 冻结状态读取畸形、store 异常、审计依赖异常均返回 `503` 或按策略阻断，不得默许放行。

### Previous Story Intelligence（来自 5.4 / 5.3 / 4.6）

- 来自 5.4：
  - 维持 MySQL 与 memory store 双实现同语义，避免测试与线上行为偏差。
  - 对并发状态流转场景优先使用原子更新与冲突语义，避免重复消费或重复状态推进。
- 来自 5.3：
  - 门禁失败分类要优先解析结构化结果，避免把运行时故障误判为业务阻断。
  - 读依赖结果要做严格结构校验，异常统一 fail-closed（`503`）。
- 来自 4.6：
  - 必须复用 `tools/release-gate-report.js` 分组聚合能力与证据链校验，避免“重造门禁”。
  - 报告输出顺序和字段应保持稳定，便于审计比对与自动化解析。

### Git Intelligence Summary（最近提交模式）

- `076ca7b`：交付集成重试/恢复重放闭环（Story 5.4）。
- `10fb93f`：交付契约一致性发布门禁（Story 5.3）。
- `1115abb`：交付契约版本治理（Story 5.2）。
- `974a0d4`：交付集成目录生命周期治理（Story 5.1）。
- 实施规律：先落迁移/store，再接 service/routes，再补 route-permissions/openapi/门禁脚本与测试。

### Latest Tech Information（外部核验）

- Node Release Index：`https://nodejs.org/download/release/index.json`
  - LTS `v24.13.1`（2026-02-09）
  - Current `v25.6.1`（2026-02-09）
- npm Registry：
  - `https://registry.npmjs.org/@nestjs/core` -> latest `11.1.14`
  - `https://registry.npmjs.org/typeorm` -> latest `0.3.28`
  - `https://registry.npmjs.org/mysql2` -> latest `3.17.4`
  - `https://registry.npmjs.org/ioredis` -> latest `5.9.3`
- MySQL 8.4 Release Notes：`https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`（最新 8.4.8）

### Project Structure Notes

- 现有集成治理主干已集中在 `apps/api/src/modules/platform/integration*.{constants,routes,service}.js`；新能力应延续相同模块边界。
- 门禁报告产物统一位于 `artifacts/release-gates/`，不要新增分散归档目录。
- 现有 runbook 目录已存在 `docs/runbooks/integration/`，冻结/解冻流程应纳入该目录并与契约/恢复 runbook 对齐。

### Project Context Reference

- `**/project-context.md`：未找到（空匹配）。
- 本故事主要上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
  - `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
  - `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`
  - `_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`
  - `_bmad-output/implementation-artifacts/5-4-失败重试-恢复与再处理闭环.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review metadata synchronized with implementation evidence and current git reality.`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 5 / Story 5.5，NFR13-NFR17）
- `_bmad-output/planning-artifacts/prd.md`（FR56、FR58、Integration Freeze Gate）
- `_bmad-output/planning-artifacts/architecture.md`（PR Quality Gates、CI/CD baseline、runbook/evidence）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（Journey 6 运维闭环与门禁结果核对）
- `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
- `_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`
- `_bmad-output/implementation-artifacts/5-4-失败重试-恢复与再处理闭环.md`
- `apps/api/src/modules/platform/integration.constants.js`
- `apps/api/src/modules/platform/integration.routes.js`
- `apps/api/src/modules/platform/integration.service.js`
- `apps/api/src/modules/platform/integration-contract.constants.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/modules/platform/integration-recovery.constants.js`
- `apps/api/src/modules/platform/integration-recovery.service.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/scripts/check-integration-contract-consistency.js`
- `tools/release-gate-report.js`
- `apps/api/test/platform.integration.api.test.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/test/platform.integration.recovery.api.test.js`
- `apps/api/test/release-gate-report.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `docs/runbooks/integration/contract-version-rollout.md`
- `docs/runbooks/integration/retry-recovery-replay.md`
- `https://nodejs.org/download/release/index.json`
- `https://registry.npmjs.org/@nestjs/core`
- `https://registry.npmjs.org/typeorm`
- `https://registry.npmjs.org/mysql2`
- `https://registry.npmjs.org/ioredis`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（CLI）

### Debug Log References

- `git status --porcelain`
- `git diff --name-only`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api exec node --test test/platform.integration.freeze.api.test.js test/platform.integration.api.test.js test/platform.integration.contract.api.test.js test/release-gate-report.test.js test/http-routes.test.js test/route-permissions.test.js test/server.test.js test/migrate-baseline.test.js test/check-integration-freeze-gate.script.test.js`
- `pnpm --dir apps/api check:integration-freeze-gate`
- `node tools/release-gate-report.js`
- `docker compose ps`

### Completion Notes List

- 已完成冻结治理链路（迁移 + store + API + 路由权限 + 幂等保护）并验证冻结期间写操作阻断、解冻恢复与审计留痕。
- 已完成发布门禁分组接入（`integration-release-window`）与脚本校验链路，并生成 release-gate 报告。
- 已修复审查发现：补齐 OpenAPI 冻结阻断 `409` 示例、修正 release-gate `FR` 映射、同步故事记录与文件清单。
- 已执行并通过关键验证：`check:route-permissions`、`lint`、Story 5.5 定向测试集、`check:integration-freeze-gate`、`node tools/release-gate-report.js`。

### File List

- `_bmad-output/implementation-artifacts/5-5-集成清单冻结-解冻与门禁分组报告.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/package.json`
- `apps/api/migrations/0024_platform_integration_freeze_control.sql`
- `apps/api/migrations/0024_platform_integration_freeze_control.down.sql`
- `apps/api/scripts/check-integration-freeze-gate.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/platform/integration-freeze.constants.js`
- `apps/api/src/modules/platform/integration-freeze.routes.js`
- `apps/api/src/modules/platform/integration-freeze.service.js`
- `apps/api/src/modules/platform/integration.service.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/auth.store.memory.freeze.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/check-integration-freeze-gate.script.test.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/platform.integration.api.test.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/test/platform.integration.freeze.api.test.js`
- `apps/api/test/release-gate-report.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `docs/runbooks/integration/freeze-unfreeze-release-gate.md`
- `tools/release-gate-report.js`
