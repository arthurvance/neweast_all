# Story 4.7: 用户软删除会话撤销

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 发布与运维负责人,  
I want 在用户软删除时撤销该用户全部 refresh token,  
so that 离职/失效账号不会继续持有有效会话。

## Acceptance Criteria

1. **Given** 用户被软删除  
   **When** 删除事务完成  
   **Then** 系统撤销该用户全部 refresh token  
   **And** 该用户历史会话后续访问被拒绝
2. **Given** 用户软删除动作执行完成  
   **When** 审计与追踪链路记录事件  
   **Then** 可检索到会话撤销结果与 request_id 关联信息  
   **And** 该链路可用于后续排障与审计取证

## Tasks / Subtasks

- [x] 任务 1：定义“用户软删除”入口与语义边界（AC: 1, 2）
  - [x] 新增独立软删除入口（建议：`DELETE /platform/users/:user_id`），避免复用 `POST /platform/users/status` 造成“平台域禁用”与“全域软删除”语义混淆。
  - [x] 固化幂等语义：对已软删除用户重复请求返回稳定 no-op，不重复产生副作用。
  - [x] 软删除动作要求返回统一结果字段：`user_id`、`previous_status`、`current_status`、`revoked_session_count`、`revoked_refresh_token_count`、`request_id`。

- [x] 任务 2：实现 MySQL 事务级软删除级联与全域 token 撤销（AC: 1）
  - [x] 在 `apps/api/src/modules/auth/auth.store.mysql.js` 增加专用写路径（建议：`softDeleteUser`），并保持单事务提交、失败全回滚。
  - [x] 行为要求：
    - 将用户状态收敛为软删除状态（当前实现建议仍使用 `users.status='disabled'`）。
    - 同步失效用户关系数据（至少覆盖 `auth_user_tenants`、`memberships`、`auth_user_platform_roles`、`auth_tenant_membership_roles` 的活跃关系）。
    - 撤销该用户全部活跃 `auth_sessions`（不限 `entry_domain`）与全部活跃 `refresh_tokens`。
  - [x] 输出级联统计字段并校验为非负整数；异常值必须 fail-closed。
  - [x] 保留 `deleteUserById` 仅用于“预配回滚”语义，不得用于本故事软删除主路径。

- [x] 任务 3：实现 in-memory 与 service 编排一致性（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.store.memory.js` 实现与 MySQL 同语义 `softDeleteUser`，避免测试环境与生产语义漂移。
  - [x] 在 `apps/api/src/modules/auth/auth.service.js` 新增编排方法（建议：`softDeleteUser`）：
    - 透传 `request_id`、`traceparent`、操作者上下文。
    - 校验 store 返回结构（目标用户一致性、状态合法性、统计字段合法性）。
    - 失败映射为统一 Problem Details（包含 `error_code` 与 `retryable` 语义）。
  - [x] 软删除成功后清理会话缓存（`invalidateSessionCacheByUserId`）以消除旧会话缓存放行窗口。

- [x] 任务 4：补齐平台治理入口、路由声明与 OpenAPI 契约（AC: 2）
  - [x] `apps/api/src/modules/platform/user.constants.js`：新增软删除路径与 route key 常量。
  - [x] `apps/api/src/modules/platform/user.routes.js` 与 `apps/api/src/modules/platform/user.service.js`：新增 handler/service，复用现有 preauthorized context 解析链路。
  - [x] `apps/api/src/http-routes.js`、`apps/api/src/server.js`：注册并分发新路由，确保 `traceparent` 正确透传。
  - [x] `apps/api/src/route-permissions.js`：声明新受保护路由，权限码沿用 `platform.member_admin.operate`，scope=`platform`。
  - [x] `apps/api/src/openapi.js`：新增接口 schema、错误示例与幂等键说明，保持 `application/problem+json` 契约一致。

- [x] 任务 5：审计与追踪闭环（AC: 2）
  - [x] 持久化审计事件（建议：`auth.platform.user.soft_deleted` / `platform.user.soft_deleted`），必须记录：
    - `request_id`、`traceparent`、`actor_user_id`、`actor_session_id`
    - `target_user_id`
    - `before_state`/`after_state`
    - `revoked_session_count`、`revoked_refresh_token_count`
  - [x] 保证审计查询接口可按 `request_id` 检索到该事件，并与错误/日志链路关联。

- [x] 任务 6：测试与发布门禁（AC: 1, 2）
  - [x] `apps/api/test/auth.store.mysql.test.js`：覆盖全域会话/refresh 撤销、级联统计、幂等重复软删除。
  - [x] `apps/api/test/auth.service.test.js`：覆盖返回结构异常 fail-closed、审计写失败映射、缓存收敛。
  - [x] `apps/api/test/platform.user.api.test.js`：覆盖成功、404、403、503、幂等重放与 `traceparent` 透传。
  - [x] 负向回归：软删除后旧 `access_token` 访问受保护接口被拒绝，旧 `refresh_token` 换发被拒绝。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复 `users.status=disabled` 时软删除提前 no-op 造成的会话残留风险，强制继续执行全域会话/refresh 撤销与关系收敛（`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][HIGH] 对齐 in-memory 存储语义，`disabled` 用户仍执行全量级联与会话撤销，避免测试环境与生产环境漂移（`apps/api/src/modules/auth/auth.store.memory.js`）。
- [x] [AI-Review][MEDIUM] 增补回归：覆盖“disabled 但存在活跃会话/refresh”脏数据场景，验证 softDelete 仍 fail-closed 收敛（`apps/api/test/auth.store.mysql.test.js`, `apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复 `access_token` 校验链路未对 `users.status` fail-closed 的风险：当软删除后出现“disabled + stale active session”脏数据时，`authorizeRoute` 仍强制返回 `AUTH-401-INVALID-ACCESS`，并记录 `disposition_reason=user-status-disabled`（`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 加固 softDelete no-op 分支：即便 `previous_status=current_status=disabled` 且撤销量为 0，也强制清理目标用户 access-session cache，避免极端脏缓存窗口误放行（`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 补齐 `user_id` 长度上限（64）校验与契约对齐，防止超长路径参数进入治理与审计链路（`apps/api/src/modules/platform/user.service.js`, `apps/api/src/modules/auth/auth.service.js`, `apps/api/src/openapi.js`）。
- [x] [AI-Review][LOW] 幂等归一化补强：对 `DELETE /platform/users/:user_id` 的 idempotency route params 做规范化，补充 percent-encoded 变体回归用例，确保同语义请求稳定重放（`apps/api/src/server.js`, `apps/api/test/platform.user.api.test.js`）。

## Dev Notes

### Developer Context（开发者先读）

- Story 2.3 当前语义是“平台用户状态治理仅影响 `platform` 域”，已落地在 `POST /platform/users/status`；4.7 需新增“全域软删除级联”能力，不能直接篡改 2.3 既有语义。
- Story 3.7 已验证“软删除级联 + 审计 + fail-closed + 双存储一致性”模式，可直接复用同类实现与测试策略。
- 当前 `auth.store.mysql.deleteUserById` / `auth.store.memory.deleteUserById` 用于预配回滚（物理删除），不是业务软删除路径。
- 认证与会话链路已具备 `revokeAllUserSessions`、`session_version` 收敛与审计基础，优先复用既有原语，禁止平行造轮子。

### Technical Requirements（硬约束）

- 直接覆盖：`FR78`。
- 强关联：`FR79`（历史会话失效）与 `FR80`（统一错误码与可重试语义）。
- 用户软删除后必须满足：
  - 用户全部活跃 refresh token 被撤销（不区分 platform/tenant 域）。
  - 历史会话后续访问被拒绝（access/refresh 双链路都不可继续）。
  - 动作幂等且可重试，重复执行结果稳定。
- 保持 Problem Details 契约：`status`、`detail`、`error_code`、`request_id`、`retryable`。
- 审计必须可检索可追踪：`request_id` 必返，`traceparent` 尽可能透传，不得伪造。

### Architecture Compliance（架构对齐清单）

- 模块职责：
  - `modules/platform/user.*`：入口编排、鉴权上下文、错误映射。
  - `modules/auth/auth.service.js`：领域编排、结果规范化、审计协调。
  - `modules/auth/auth.store.mysql.js|memory.js`：事务级级联与数据一致性。
- 禁止绕过：
  - 不得绕过 `route-permissions` 静态声明。
  - 不得在路由层拼装非标准错误结构。
  - 不得引入与现有模型冲突的新“软删除状态语义”而不提供迁移与回归。
- 会话一致性要求：
  - 软删除后必须收敛全域会话。
  - 必须触发会话缓存失效，避免短窗口误放行。

### Library & Framework Requirements（库与运行时）

- 当前仓库基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新核验（2026-02-22）：
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - Node.js Latest LTS: `v24.13.1 (Krypton)`，Latest Current: `v25.6.1`
- 本故事建议：不做依赖升级，优先交付软删除一致性与会话撤销语义；版本升级拆分为独立维护任务。

### File Structure Requirements（建议变更落点）

- 平台入口与契约：
  - `apps/api/src/modules/platform/user.constants.js`
  - `apps/api/src/modules/platform/user.routes.js`
  - `apps/api/src/modules/platform/user.service.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
- 领域与存储：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 测试：
  - `apps/api/test/platform.user.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/route-permissions.test.js`

### Testing Requirements（必须覆盖）

- AC1（软删除后全域撤销）：
  - 用户所有活跃 refresh token 均被撤销。
  - 软删除前签发的 access token 对受保护接口返回未授权。
  - 软删除重复执行保持幂等、返回稳定统计。
- AC2（审计与追踪）：
  - 审计事件包含 `request_id` 且可查询。
  - `traceparent` 在入口到持久审计链路不丢失（缺失时显式 `null`）。
- 回归要求：
  - 不破坏 Story 2.3 既有“平台状态治理仅影响 platform 域”语义。
  - MySQL 与 in-memory 语义一致。
  - 门禁命令全通过：`check:route-permissions`、`lint`、`test`。

### Previous Story Intelligence（来自 4.6）

- 失败语义必须 fail-closed，不能使用“回退拼接旧证据/旧状态”的宽松策略。
- 结果字段与输出顺序要稳定，避免审计和自动化解析抖动。
- 关键链路要显式绑定 `request_id` 与可追踪元数据，避免“实现成功但不可审计”的假完成。
- 在提交结构上沿用“先语义与契约、再测试、最后流水线集成”的节奏，可降低回归风险。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交聚焦治理能力硬化与 fail-closed 补强，热点文件稳定集中在：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/platform/*`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可复用实施顺序：
  1. 先落地 store/service 语义与错误映射；
  2. 再补路由契约与权限声明；
  3. 最后补齐 API/服务/存储回归并跑全门禁。

### Latest Tech Information（外部核验）

- npm registry（2026-02-22）：
  - `@nestjs/core@11.1.14`
  - `typeorm@0.3.28`
  - `mysql2@3.17.4`
  - `ioredis@5.9.3`
- Node.js dist（2026-02-22）：
  - Latest Current: `v25.6.1`（2026-02-09）
  - Latest LTS: `v24.13.1`（2026-02-09）
- MySQL 8.4 Release Notes：
  - 最新 LTS 节点为 `8.4.8`（2026-01-20）
- 结论：当前技术栈满足本故事实现，无需引入框架升级变更面。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文主要来源：
  - `_bmad-output/planning-artifacts/epics.md`（Story 4.7）
  - `_bmad-output/planning-artifacts/prd.md`（FR78/FR79/删除级联门禁）
  - `_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`（用户软删除级联矩阵）
  - `_bmad-output/planning-artifacts/architecture.md`（模块边界与会话一致性）
  - `_bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md`
  - `_bmad-output/implementation-artifacts/3-7-组织软删除级联一致性.md`
  - `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`已完成用户软删除全域会话撤销实现、审计追踪闭环与门禁验证；代码评审问题（disabled 残留会话场景）已修复并回归通过。`

### References

- `_bmad-output/planning-artifacts/epics.md`（`Epic 4 / Story 4.7`）
- `_bmad-output/planning-artifacts/prd.md`（`FR78`, `FR79`, `删除级联一致性门禁`）
- `_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`（`Deletion Cascade Matrix`）
- `_bmad-output/planning-artifacts/architecture.md`（`Architectural Boundaries`, `Authentication & Security`）
- `_bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md`
- `_bmad-output/implementation-artifacts/3-7-组织软删除级联一致性.md`
- `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
- `apps/api/src/modules/platform/user.service.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `https://nodejs.org/dist/index.json`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`
- `https://www.npmjs.com/package/@nestjs/core`
- `https://www.npmjs.com/package/typeorm`
- `https://www.npmjs.com/package/mysql2`
- `https://www.npmjs.com/package/ioredis`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/platform.user.api.test.js test/route-permissions.test.js test/server.test.js test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/platform.user.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.user.api.test.js test/server.test.js`

### Completion Notes List

- 新增 `DELETE /platform/users/:user_id` 平台用户软删除入口，保持与 `POST /platform/users/status` 语义隔离。
- 在 MySQL/in-memory store 实现 `softDeleteUser` 原子级联：禁用用户与关系、撤销全域活跃 session/refresh token、记录持久化审计事件。
- 在 auth service 增加 `softDeleteUser` 编排与 fail-closed 结果校验，补齐 traceparent/request_id 透传、审计补偿与会话缓存失效。
- 在平台 user 模块、路由分发、权限声明、OpenAPI 契约完成端到端接入。
- 修复审计元数据脱敏误伤：保留 `*_count` 聚合字段（避免 `revoked_refresh_token_count` 被错误脱敏）。
- 调整软删除路由幂等 scope：同一 Idempotency-Key 跨不同 `user_id` 返回 `AUTH-409-IDEMPOTENCY-CONFLICT`。
- 目标回归与全量门禁均通过：`check:route-permissions`、`lint`、`test`。
- 代码评审修复：当目标用户已是 `disabled` 但仍残留活跃会话/refresh token 时，softDelete 不再提前 no-op，而是继续执行全域收敛并输出真实撤销量。
- 代码评审修复：`assertValidAccessSession` 对 `user.status` 增加 fail-closed 校验，避免“disabled + stale active session”脏数据绕过 `authorizeRoute`。
- 代码评审加固：`softDeleteUser` no-op 分支也会清理用户 access-session cache，并新增回归用例验证缓存收敛。
- 代码评审加固：新增 `user_id` 64 长度上限校验（platform service + auth service）并同步 OpenAPI `maxLength` 契约。
- 代码评审加固：补充 `DELETE /platform/users/:user_id` percent-encoded 路径幂等重放回归，避免路径变体影响一致性。

### File List

- `apps/api/src/modules/platform/user.constants.js`
- `apps/api/src/modules/platform/user.routes.js`
- `apps/api/src/modules/platform/user.service.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/src/openapi.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/test/platform.user.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/auth.service.test.js`
- `_bmad-output/implementation-artifacts/4-7-用户软删除会话撤销.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-22：实现并接入平台用户软删除全链路能力（存储、服务、路由、权限、OpenAPI、测试），并通过全部发布门禁。
- 2026-02-22：代码评审修复“disabled 用户残留活跃会话/refresh token 时被提前 no-op”问题，补齐 MySQL/in-memory 一致性与回归测试。
- 2026-02-22：代码评审修复 access 校验 fail-open 边界：当用户已软删除但会话被脏数据重建时，`authorizeRoute` 仍拒绝并输出 `user-status-disabled` 审计原因。
- 2026-02-22：代码评审加固 softDelete 边界（no-op 清缓存、`user_id` 长度上限、幂等路径变体回归），并重新通过 `check:route-permissions`、`lint`、`test`。
