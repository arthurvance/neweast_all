# Story 3.3: 组织权限树与成员角色分配

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 组织负责人或组织管理员,  
I want 配置组织角色权限树并给成员分配 1 到 5 个角色,  
so that 成员在组织内获得精确且可控的权限。

## Acceptance Criteria

1. **Given** 组织管理员配置角色权限树  
   **When** 保存配置  
   **Then** 系统保存最终授权结果  
   **And** 前端可保持父子联动展示一致
2. **Given** 管理员为成员分配 1 到 5 个组织角色  
   **When** 分配请求成功  
   **Then** 系统建立成员角色绑定  
   **And** 成员权限按当前有效角色即时重算
3. **Given** 成员角色被禁用或移除  
   **When** 成员访问受保护能力  
   **Then** 系统按最新权限判定  
   **And** 无权限访问被一致拒绝

## Tasks / Subtasks

- [x] 任务 1：交付组织角色权限树配置 API（AC: 1）
  - [x] 新增 tenant 角色权限树接口：`GET /tenant/roles/:role_id/permissions`、`PUT /tenant/roles/:role_id/permissions`。
  - [x] 仅接受并持久化“最终授权权限码集合（叶子权限点）”，不保存前端父子半选中间态（对齐 FR74）。
  - [x] 权限码仅允许来自服务端清单且必须属于 `tenant.*` 命名空间；未知权限码、跨域权限码统一拒绝（对齐 FR26/FR70/FR73）。
  - [x] 对 `permission_codes` 做去重、控制字符拒绝、上限约束（建议 `<=64`），并保证读写结果稳定有序。
  - [x] 受保护角色定义仍不可编辑/删除（继承 Story 3.2），但权限授予配置允许按策略执行。

- [x] 任务 2：交付成员角色分配 API（AC: 2）
  - [x] 新增成员角色绑定接口：`GET /tenant/members/:membership_id/roles`、`PUT /tenant/members/:membership_id/roles`。
  - [x] `PUT` 请求仅接受 `role_ids`，并强制 1-5 个、去重、同租户、`scope=tenant`、状态可分配（建议仅 `active`）。
  - [x] 成员角色绑定必须锚定 `membership_id`（不是仅 `user_id + tenant_id`），确保重入组新关系与历史关系隔离。
  - [x] 绑定写入必须原子替换（replace 语义）并支持幂等重放；参数冲突保持稳定 Problem Details。

- [x] 任务 3：实现权限并集重算与即时生效（AC: 2, 3）
  - [x] 角色权限树变更或成员角色绑定变更后，按“成员有效角色并集”重算组织权限上下文。
  - [x] 禁用角色、移除绑定、成员非激活状态不得贡献有效权限（对齐 FR29/FR50/FR75）。
  - [x] 更新后必须让后续鉴权即时读取新结果；对已登录会话执行收敛策略（`session_version` 或等价 tenant 会话撤销）（对齐 FR30/FR79）。
  - [x] 依赖异常一律 fail-closed 返回稳定 `503`，禁止 silent fail-open。

- [x] 任务 4：对齐路由声明、幂等语义与 OpenAPI 契约（AC: 1, 2, 3）
  - [x] 在 `route-permissions` 为新增受保护路由声明 `permission_code` 与 `scope=tenant`，并通过 `check:route-permissions`。
  - [x] 将新增写接口纳入幂等保护范围，保持“仅 `retryable=true` 的 409 不缓存”策略一致。
  - [x] OpenAPI 补齐新增路径、请求响应 schema、错误示例（400/401/403/404/409/413/503）和 `retryable` 语义。
  - [x] 保持外部字段 `snake_case`，内部实现沿既有命名与分层。

- [x] 任务 5：交付回归矩阵与门禁（AC: 1, 2, 3）
  - [x] AC1：权限树保存/读取一致、非法权限码拒绝、跨域权限码拒绝、空集合清空行为明确。
  - [x] AC2：成员角色 1-5 约束、重复角色、跨租户角色、禁用角色、不存在角色、非法 `membership_id` 全覆盖。
  - [x] AC3：角色禁用或解绑后访问即时收敛，未授权操作一致拒绝（`AUTH-403-FORBIDDEN` 或等价语义）。
  - [x] 安全回归：租户上下文伪造、路径参数畸形、下游返回畸形记录均 fail-closed。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 成员角色绑定读取链路对下游畸形 `role_ids` 存在静默过滤风险，未满足 fail-closed；已改为严格校验并在异常时返回 `503`。[`apps/api/src/modules/auth/auth.service.js:4661`]
- [x] [AI-Review][HIGH] 成员角色绑定读取链路未强制 1-5 上限，可能放大历史脏数据；已增加超限拒绝并统一降级语义。[`apps/api/src/modules/auth/auth.service.js:4661`]
- [x] [AI-Review][HIGH] 成员角色绑定写入结果对下游畸形 `role_ids` 存在静默过滤风险；已改为写后结果严格校验，不合法即 fail-closed。[`apps/api/src/modules/auth/auth.service.js:4721`]
- [x] [AI-Review][MEDIUM] 缺少对上述 fail-closed 场景的直接单测；已补 4 条回归用例覆盖读取/写入的畸形与超上限返回。[`apps/api/test/auth.service.test.js:8409`]
- [x] [AI-Review][HIGH] 成员角色绑定读取链路未校验“角色目录 tenant 一致性”，跨租户脏绑定可能被透传；已增加目录一致性校验并在异常时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4732`]
- [x] [AI-Review][HIGH] 成员角色绑定写入链路未校验“写后结果与请求集合一致”，存在下游静默丢失风险；已增加严格集合一致性校验，不一致即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4916`]
- [x] [AI-Review][MEDIUM] 角色权限授予写入链路未校验“写后权限码合法性与请求一致性”，存在畸形回包透传风险；已增加 tenant 权限码合法性与集合一致性校验。[`apps/api/src/modules/auth/auth.service.js:4654`]
- [x] [AI-Review][HIGH] 组织成员角色绑定 API 层对下游缺失/畸形 `role_ids` 仍可能静默降级为空数组，存在 fail-open 风险；已改为严格结构校验并统一 fail-closed `503`。[`apps/api/src/modules/tenant/member.service.js:385`]
- [x] [AI-Review][HIGH] 组织成员角色绑定写入 API 层未校验“回包角色集合与请求集合一致性”，存在下游静默丢失透传风险；已增加集合一致性校验，不一致即 fail-closed `503`。[`apps/api/src/modules/tenant/member.service.js:1386`]
- [x] [AI-Review][MEDIUM] 组织角色权限树 API 层对下游畸形 `permission_codes` / `affected_user_count` 缺少强校验，可能返回伪成功响应；已增加读写双向严格校验并统一 fail-closed `503`。[`apps/api/src/modules/tenant/role.service.js:443`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantMemberRoleBindings` 未校验写后 `membership_id` 与请求一致，可能掩盖下游串写；已新增强校验，不一致即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4934`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantRolePermissionGrants` 未校验写后 `role_id` 与请求一致，可能掩盖下游错写；已新增强校验，不一致即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4623`]
- [x] [AI-Review][MEDIUM] 服务层成员角色结果标准化对非字符串 `role_ids` 存在隐式字符串化风险，未满足严格 fail-closed；已改为强类型校验并补充定向回归用例。[`apps/api/src/modules/auth/auth.service.js:4728`]
- [x] [AI-Review][MEDIUM] 组织角色权限树写接口允许 `permission_codes` 前后空白字符，和 OpenAPI/幂等语义存在偏差；已改为严格拒绝前后空白输入。[`apps/api/src/modules/tenant/role.service.js:427`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantRolePermissionGrants` 对下游 `affected_user_ids` 缺少强类型校验，存在会话缓存失效对象错误风险；已改为严格数组/字符串校验并在畸形时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4706`]
- [x] [AI-Review][MEDIUM] 服务层 `replaceTenantRolePermissionGrants` 对下游 `affected_user_count` 缺少非负整数与一致性校验，可能透传畸形统计；已补齐严格校验并在异常时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4730`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantMemberRoleBindings` 对下游 `affected_user_ids` / `affected_user_count` 仍存在宽松处理，可能掩盖依赖层畸形返回；已新增强类型与计数一致性校验并统一 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:5017`]
- [x] [AI-Review][MEDIUM] 组织成员角色绑定写路由缺少“retryable/non-retryable 409”幂等缓存语义回归，存在策略回归盲区；已补 2 条定向测试覆盖。[`apps/api/test/tenant.member.api.test.js:1875`]
- [x] [AI-Review][MEDIUM] 组织角色权限授予写路由缺少“retryable/non-retryable 409”幂等缓存语义回归，存在策略回归盲区；已补 2 条定向测试覆盖。[`apps/api/test/tenant.role.api.test.js:1976`]
- [x] [AI-Review][HIGH] 服务层租户权限变更写链路在依赖回包缺失 `affected_user_ids` / `affected_user_count` 时仍可能返回成功，存在会话缓存失效不完整风险；已改为缺失即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4730`][`apps/api/src/modules/auth/auth.service.js:5050`]
- [x] [AI-Review][MEDIUM] 服务层平台角色权限读取对依赖返回空权限码存在静默过滤，未满足严格 fail-closed；已改为检测到空/非法权限码即拒绝并降级 `503`。[`apps/api/src/modules/auth/auth.service.js:2841`][`apps/api/test/auth.service.test.js:3218`]
- [x] [AI-Review][MEDIUM] 服务层租户角色权限读取对依赖返回空权限码存在静默过滤，可能掩盖下游脏数据；已改为检测到空/非法权限码即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:3012`][`apps/api/test/auth.service.test.js:8468`]
- [x] [AI-Review][HIGH] 成员角色绑定写入链路未限制 `membership` 必须处于 `active`，可对 `disabled/left` 关系写入角色绑定；已改为仅允许 active 成员关系分配并统一按 `404` 处理，避免失效关系被意外授权。[`apps/api/src/modules/auth/auth.service.js:4986`][`apps/api/test/auth.service.test.js:8468`]
- [x] [AI-Review][MEDIUM] 租户角色目录依赖返回同 `role_id` 重复记录时存在静默覆盖风险，可能导致校验非确定；已增加重复检测并 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:2934`][`apps/api/test/auth.service.test.js:8539`]
- [x] [AI-Review][MEDIUM] 租户角色权限 grants 依赖返回同 `role_id` 多条记录时会“后写覆盖前写”，存在权限读取丢失风险；已改为重复条目直接 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:3033`][`apps/api/test/auth.service.test.js:8583`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantMemberRoleBindings` 对依赖返回 `affected_user_ids = null` 存在宽松容忍，会将畸形回包当作空列表处理；已改为强制数组类型校验并在异常时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4110`][`apps/api/test/auth.service.test.js:9049`]
- [x] [AI-Review][HIGH] 服务层 `replaceTenantRolePermissionGrants` 对依赖返回 `affected_user_ids = null` 存在同类宽松容忍，可能掩盖下游错误；已改为强制数组类型校验并在异常时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4110`][`apps/api/test/auth.service.test.js:9295`]
- [x] [AI-Review][MEDIUM] 服务层写链路对依赖 `affected_user_count` 采用 `Number()` 强转，`null/非 number` 可能被误判为合法计数；已改为严格非负整数（number 类型）校验并补齐回归用例。[`apps/api/src/modules/auth/auth.service.js:4144`][`apps/api/test/auth.service.test.js:9079`][`apps/api/test/auth.service.test.js:9325`]
- [x] [AI-Review][HIGH] 成员角色绑定写链路存在 TOCTOU 风险：服务层预检后若成员关系被并发置为 `disabled/left`，存储层仍可能写入绑定；已在 memory/mysql 存储层补充事务内 `membership=active` 强校验，并在服务层将该竞态映射为稳定 `404`。[`apps/api/src/modules/auth/auth.store.memory.js:1884`][`apps/api/src/modules/auth/auth.store.mysql.js:3820`][`apps/api/src/modules/auth/auth.service.js:5029`]
- [x] [AI-Review][HIGH] 成员角色绑定写链路存在 TOCTOU 风险：服务层预检后若角色被并发禁用或迁出租户，存储层可能接受旧请求写入；已在 memory/mysql 存储层补充事务内“`scope=tenant` + `tenant_id` 一致 + `status=active`”校验，并映射为稳定 `404 role not found`。[`apps/api/src/modules/auth/auth.store.memory.js:1918`][`apps/api/src/modules/auth/auth.store.mysql.js:3868`][`apps/api/src/modules/auth/auth.service.js:5035`]
- [x] [AI-Review][MEDIUM] 缺少上述并发竞态语义回归；已补 4 条定向测试，覆盖服务层语义映射与 MySQL 存储层事务内拒绝路径。[`apps/api/test/auth.service.test.js:8503`][`apps/api/test/auth.service.test.js:8564`][`apps/api/test/auth.store.mysql.test.js:3541`]
- [x] [AI-Review][MEDIUM] OpenAPI `GET /tenant/members/{membership_id}/roles` 缺少 Problem Details 错误示例，前端无法稳定映射 400/401/403/404/503 错误动作；已补齐示例并新增契约断言。[`apps/api/src/openapi.js:1602`][`apps/api/test/server.test.js:765`]
- [x] [AI-Review][MEDIUM] OpenAPI `PUT /tenant/members/{membership_id}/roles` 缺少幂等冲突/服务降级示例，且 404 未覆盖 `role not found` 分支；已补齐 400/401/403/404/409/413/503 示例与断言。[`apps/api/src/openapi.js:1671`][`apps/api/test/server.test.js:775`]
- [x] [AI-Review][MEDIUM] OpenAPI `/tenant/roles/{role_id}/permissions`（GET/PUT）缺少错误示例与 `retryable` 语义覆盖，契约可执行性不足；已补齐 400/401/403/404/409/413/503 示例并新增断言。[`apps/api/src/openapi.js:2091`][`apps/api/test/server.test.js:795`]
- [x] [AI-Review][HIGH] `auth.store.mysql` 租户权限码严格校验链路引用了未定义的 `CONTROL_CHAR_PATTERN`，导致运行时 `ReferenceError` 并掩盖预期 fail-closed 语义；已补齐常量定义并恢复稳定错误路径。[`apps/api/src/modules/auth/auth.store.mysql.js:13`]
- [x] [AI-Review][HIGH] MySQL 存储层 tenant 角色权限 grants 读取在畸形/重复权限码与意外 `role_id` 行场景存在静默容忍风险；已将 `loadActiveTenantRoleGrantCodesByRoleIdsTx`、`listTenantRolePermissionGrants` 与 `listTenantRolePermissionGrantsByRoleIds` 升级为严格校验并统一 fail-closed。[`apps/api/src/modules/auth/auth.store.mysql.js:1006`][`apps/api/test/auth.store.mysql.test.js:3625`]
- [x] [AI-Review][MEDIUM] 角色权限变更后的受影响成员收敛集合需保持“仅 active membership”语义；已在 memory/mysql 存储层统一仅对 `active/enabled` 关系执行快照重算与会话收敛。[`apps/api/src/modules/auth/auth.store.memory.js:2180`][`apps/api/src/modules/auth/auth.store.mysql.js:2416`]
- [x] [AI-Review][HIGH] 组织成员角色绑定读取 API 层对下游回包 `role_ids` 存在“前后空白被静默 trim”风险，可能掩盖依赖层脏数据；已改为前后空白即 fail-closed `503`。[`apps/api/src/modules/tenant/member.service.js:408`][`apps/api/test/tenant.member.api.test.js:1986`]
- [x] [AI-Review][HIGH] 组织角色权限树读取 API 层对下游 `permission_codes` 存在“前后空白被静默 trim”风险，可能透传非规范权限码；已改为前后空白即 fail-closed `503`。[`apps/api/src/modules/tenant/role.service.js:467`][`apps/api/test/tenant.role.api.test.js:2116`]
- [x] [AI-Review][MEDIUM] 服务层写链路对依赖返回 `affected_user_ids` 仍存在“前后空白 user_id 被静默 trim”容忍，可能掩盖依赖数据质量问题；已改为严格拒绝并统一 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4129`][`apps/api/test/auth.service.test.js:9172`][`apps/api/test/auth.service.test.js:9450`]
- [x] [AI-Review][HIGH] 组织成员角色绑定读取 API 层对下游回包 `membership_id` 仍存在“前后空白被静默 trim”容忍，可能掩盖依赖层脏数据；已改为严格匹配并在异常时 fail-closed `503`。[`apps/api/src/modules/tenant/member.service.js:1217`][`apps/api/test/tenant.member.api.test.js:2010`]
- [x] [AI-Review][HIGH] 组织成员角色绑定写入 API 层对下游回包 `membership_id` 存在同类空白容忍，可能将畸形回包误判为成功；已改为严格匹配并统一降级 `503`。[`apps/api/src/modules/tenant/member.service.js:1357`][`apps/api/test/tenant.member.api.test.js:2061`]
- [x] [AI-Review][HIGH] 组织角色权限树读取 API 层对下游回包 `role_id` 存在“前后空白被静默 trim”容忍，可能掩盖依赖侧标识污染；已改为严格匹配并在异常时 fail-closed `503`。[`apps/api/src/modules/tenant/role.service.js:1444`][`apps/api/test/tenant.role.api.test.js:2160`]
- [x] [AI-Review][HIGH] 组织角色权限树写入 API 层对下游回包 `role_id` 存在同类空白容忍，可能将错写结果误判为成功；已改为严格匹配并统一降级 `503`。[`apps/api/src/modules/tenant/role.service.js:1611`][`apps/api/test/tenant.role.api.test.js:2251`]
- [x] [AI-Review][MEDIUM] 组织角色权限树写入 API 层对下游回包 `affected_user_count` 仍使用 `Number()` 宽松强转，字符串数字会被误接纳；已升级为严格 `number` 类型校验并补充定向回归。[`apps/api/src/modules/tenant/role.service.js:495`][`apps/api/test/tenant.role.api.test.js:2298`]
- [x] [AI-Review][HIGH] in-memory 存储层 `replaceTenantRolePermissionGrantsAndSyncSnapshots` 在中途快照重算失败时存在“部分写入 + 提前会话收敛”风险；已改为失败全量回滚（grants + membership snapshot）并在全部成功后统一执行会话收敛，补充 2 条定向回归验证原子性与会话保持。[`apps/api/src/modules/auth/auth.store.memory.js:2277`][`apps/api/test/auth.service.test.js:9419`]
- [x] [AI-Review][MEDIUM] 服务层 `listTenantRolePermissionGrants` 对入参 `role_id` 仍存在隐式 `trim` 容忍，前后空白会被静默接纳并进入目录查询；已升级为严格地址化校验（前后空白/控制字符/非法格式/超长统一 `400`）。[`apps/api/src/modules/auth/auth.service.js:875`][`apps/api/test/auth.service.test.js:10439`]
- [x] [AI-Review][MEDIUM] 服务层 `replaceTenantRolePermissionGrants` 对入参 `role_id` 缺少地址化格式前置校验，畸形标识可能被映射为误导性 `404`；已补齐严格入参校验并新增定向回归。[`apps/api/src/modules/auth/auth.service.js:4672`][`apps/api/test/auth.service.test.js:10459`]
- [x] [AI-Review][MEDIUM] 服务层 `list/replaceTenantMemberRoleBindings` 对 `membership_id` 仍存在隐式 `trim` 容忍，违反 fail-closed 一致性；已改为前后空白即 `400` 并补充 2 条回归。[`apps/api/src/modules/auth/auth.service.js:864`][`apps/api/test/auth.service.test.js:10483`]
- [x] [AI-Review][HIGH] 服务层 `replacePlatformRolePermissionGrants` 原子写分支未强制校验回包 `role_id` 与请求一致，可能掩盖下游串写；已补齐严格匹配并在异常时 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4412`][`apps/api/test/auth.service.test.js:3753`]
- [x] [AI-Review][HIGH] 服务层平台角色权限原子写分支对回包 `permission_codes` 存在宽松容忍（空白/非法码/重复），存在脏数据透传风险；已改为严格校验并要求与请求集合一致，异常统一 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4424`][`apps/api/test/auth.service.test.js:3793`]
- [x] [AI-Review][HIGH] 服务层平台角色权限原子写分支未强制要求 `affected_user_ids` / `affected_user_count` 元数据显式返回，可能导致会话收敛不完整；已改为元数据缺失即 fail-closed `503`。[`apps/api/src/modules/auth/auth.service.js:4462`][`apps/api/test/auth.service.test.js:3833`]
- [x] [AI-Review][MEDIUM] 平台原子写回包 `affected_user_count` 缺少严格非负整数与计数一致性校验，可能误接纳畸形统计；已补齐强校验并补充定向回归，同时 MySQL 存储层显式回传 `affectedUserCount`。[`apps/api/src/modules/auth/auth.service.js:4483`][`apps/api/src/modules/auth/auth.store.mysql.js:2389`][`apps/api/test/auth.service.test.js:3871`]
- [x] [AI-Review][HIGH] `PATCH /tenant/members/:membership_id/status` 幂等路由变体未对 `membership_id` 做规范化，大小写路径变体可绕过同键冲突检测；已新增幂等专用参数规范化（`membership_id -> lower-case`）并收敛同键冲突语义。[`apps/api/src/server.js:618`][`apps/api/src/server.js:1484`]
- [x] [AI-Review][HIGH] `PUT /tenant/members/:membership_id/roles` 存在同类幂等路由变体绕过风险；已复用同一规范化逻辑，确保路径大小写变体落入同一幂等作用域。[`apps/api/src/server.js:618`][`apps/api/src/server.js:1484`]
- [x] [AI-Review][MEDIUM] 成员状态更新/成员角色绑定缺少“`membership_id` 路径规范化幂等”回归，导致该风险无法被自动门禁捕获；已补 2 条定向回归并验证通过。[`apps/api/test/tenant.member.api.test.js:1729`][`apps/api/test/tenant.member.api.test.js:2016`]
- [x] [AI-Review][HIGH] `membership_id` 在幂等层已做 `lower-case` 归一化，但 API/服务层仍按原值透传，导致跨层语义不一致（同一大小写变体可能出现“幂等冲突已命中、业务查找未命中”）；已统一在 API 与 auth 服务层按同一规则归一化后再入库/查找。[`apps/api/src/modules/tenant/member.service.js:303`][`apps/api/src/modules/auth/auth.service.js:864`]
- [x] [AI-Review][MEDIUM] 成员状态更新与成员角色绑定接口缺少“非幂等路径也做 `membership_id` 小写归一化”的直接回归，存在未来回退盲区；已补 3 条 API 回归覆盖 `PATCH/GET/PUT` 三条链路。[`apps/api/test/tenant.member.api.test.js:1691`][`apps/api/test/tenant.member.api.test.js:1935`][`apps/api/test/tenant.member.api.test.js:2031`]
- [x] [AI-Review][MEDIUM] auth 服务层缺少“`membership_id` 大小写输入归一化”回归，导致 store 语义漂移风险无法被自动门禁捕获；已补 2 条服务层定向用例锁定 `list/replace` 行为一致性。[`apps/api/test/auth.service.test.js:10685`]
- [x] [AI-Review][HIGH] 组织成员列表标准化在 `camelCase` 键存在但值为 `undefined/null` 时会屏蔽有效 `snake_case` 字段，导致正常下游回包被误判为依赖畸形并返回 `503`；已将字段解析改为“优先非空值、再回退键存在值”。[`apps/api/src/modules/tenant/member.service.js:61`]
- [x] [AI-Review][HIGH] 组织角色目录字段解析存在同类“`camelCase undefined` 覆盖 `snake_case`”问题，会把合法目录项误降级为 `503`；已在目录字段解析中应用同一优先级策略并补回归。[`apps/api/src/modules/tenant/role.service.js:513`][`apps/api/test/tenant.role.api.test.js:144`]
- [x] [AI-Review][HIGH] 平台角色权限授予链路的 `role_id` 候选解析存在同类 shadow 错误，`roleId: undefined` 会吞掉 `role_id`，触发错误的快照降级；已修复解析顺序并新增服务层回归。[`apps/api/src/modules/auth/auth.service.js:142`][`apps/api/test/auth.service.test.js:3322`]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 3.1 已完成成员生命周期与 `membership_id` 主键语义；Story 3.3 必须在“成员关系主键锚定”基础上做角色绑定，禁止退回 `user_id + tenant_id` 绑定。
- Story 3.2 已完成 tenant 角色目录治理（`/tenant/roles`）与受保护角色约束；Story 3.3 是其直接后续，必须复用既有 `tenant/role.*` 分层与 fail-closed 审计风格。
- Story 2.5 已完成平台侧“权限树 + 角色分配 + 快照收敛”全链路，Story 3.3 推荐按同构模式在 tenant 域落地（但数据边界必须 tenant 化）。
- 当前租户权限判定来源为 `findTenantPermissionByUserAndTenantId`（`auth_user_tenants.can_*`）；本故事应将角色绑定并集结果稳定汇聚到该判定入口，避免新增平行鉴权源。

### Technical Requirements（实现硬约束）

- FR22：组织角色权限树可配置，且保存的是最终授权结果。
- FR23：成员角色分配数量强约束为 1-5。
- FR26 / FR70：tenant 域仅解析 `tenant.*`，不得由 `platform.*` 提升 tenant 能力。
- FR29 / FR50 / FR75：禁用角色不参与权限计算，变更后立即生效。
- FR30 / FR79：权限关键状态变更后会话必须收敛，不允许旧权限继续放行。
- FR72 / FR73：新增受保护接口必须显式声明权限码并通过发布前门禁。
- 统一错误语义：`application/problem+json` + `error_code` + `request_id` + `retryable`（适用时）。

### Architecture Compliance（架构对齐清单）

- 模块边界：
  - `modules/tenant/*` 负责租户治理编排。
  - `modules/auth/*` 负责鉴权事实、权限快照与会话收敛。
  - 路由层仅负责参数转发与鉴权上下文透传。
- 数据边界：
  - 角色目录继续使用 `platform_role_catalog(scope=tenant, tenant_id=...)`。
  - 角色权限授予与成员角色绑定应有独立关系表，支持原子 replace 与审计追踪。
- 一致性边界：
  - MySQL 与 memory store 语义保持一致（字段约束、排序、冲突语义、回包结构）。
  - 下游结果必须做完整性校验（tenant 一致、状态合法、关键标识完整），异常统一 503。
- 交互边界：
  - 权限树后端仅保存最终授权码；前端父子联动仅做展示/编辑态，不进入后端事实层。

### Library & Framework Requirements（库与框架要求）

- 仓库当前基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-19 官方源核验（用于实现时参考，不要求本故事内升级）：
  - Node.js Latest LTS: `v24.13.1 (Krypton)`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - Redis OSS Latest: `8.6.0`
  - MySQL 8.4 最新可见补丁：`8.4.8`
- 本故事策略：先在当前锁定版本完成功能闭环，依赖升级单列后续维护故事。

### File Structure Requirements（建议变更落点）

- 迁移（新增，命名可按实际顺序调整）：
  - `apps/api/migrations/0014_tenant_role_permission_grants.sql`
  - `apps/api/migrations/0014_tenant_role_permission_grants.down.sql`
  - `apps/api/migrations/0015_auth_tenant_membership_roles.sql`
  - `apps/api/migrations/0015_auth_tenant_membership_roles.down.sql`
- tenant 模块（修改/新增）：
  - `apps/api/src/modules/tenant/role.constants.js`
  - `apps/api/src/modules/tenant/role.routes.js`
  - `apps/api/src/modules/tenant/role.service.js`
  - `apps/api/src/modules/tenant/member.constants.js`
  - `apps/api/src/modules/tenant/member.routes.js`
  - `apps/api/src/modules/tenant/member.service.js`
- 鉴权与存储（修改）：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 路由与契约（修改）：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/openapi.js`
- 测试（新增/修改）：
  - `apps/api/test/tenant.role.api.test.js`
  - `apps/api/test/tenant.member.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（测试要求）

- AC1（权限树）：
  - 读取权限树：角色存在且 tenant 匹配时返回 `permission_codes` 与可配置清单。
  - 写入权限树：仅保存最终授权结果；重复写入幂等一致；非法权限码与跨域权限码拒绝。
  - 禁用角色权限树可按策略配置且读取一致（不破坏 Story 3.2 的“定义不可编辑/删除”）。
- AC2（成员角色分配）：
  - `role_ids` 1-5 成功；0、>5、重复、跨租户、禁用角色、不存在角色全部失败并语义稳定。
  - 绑定关系与 `membership_id` 强一致；重入后新 `membership_id` 不继承旧绑定。
  - 并发重复提交幂等：同键同载荷返回首次结果，同键异载荷冲突。
- AC3（即时生效）：
  - 角色禁用或解绑后，受保护接口访问按最新权限拒绝。
  - 更新后 tenant 权限上下文可立即读取最新并集结果。
  - 会话收敛生效：旧会话不能继续使用过期权限。
- 负向与健壮性：
  - 畸形路径参数、重复 query、控制字符输入、下游畸形回包全部 fail-closed。
  - 跨租户数据污染检测：返回结果的 `tenant_id` 必须与 active tenant 一致。

### Previous Story Intelligence

- 来自 Story 3.1：
  - 成员关系生命周期与重入语义已经固化，`membership_id` 是 tenant 关系事实锚点。
  - tenant member 链路对下游数据完整性采用严格 fail-closed，Story 3.3 必须保持同级别安全阈值。
- 来自 Story 3.2：
  - tenant role 模块已形成成熟的 `constants + routes + service` 分层与审计模式。
  - `active_tenant_id` 只信任服务端上下文，且预授权上下文兼容 snake/camel 字段。
  - 角色目录查询/更新已内建多层次完整性校验，Story 3.3 应复用这些 guardrails。
- 来自 Story 2.5：
  - “权限树授予 + 分配 + 快照收敛”的实现路径可直接迁移到 tenant 域，重点是替换数据边界与权限码集合。

### Git Intelligence Summary

- 最近 5 次提交标题：
  - `feat(api): complete story 3.2 tenant role governance and review closure`
  - `feat(api): implement tenant member lifecycle and auth enhancements`
  - `feat(api): 完成 Story 2.6 平台侧负责人变更入口与回归`
  - `feat(api): implement story 2.5 platform role permission grants`
  - `feat(api): deliver story 2.4 platform role governance and constraints`
- 近 5 次提交共同特征：
  - 高频改动集中在 `modules/auth/*`、`modules/tenant/*`、`route-permissions.js`、`server.js`、`openapi.js`、`test/*`。
  - 交付模式是“小步增量 + 契约同步 + 回归先行”；每次都同步实现、权限声明、幂等与测试。
  - 高风险语义统一按 fail-closed 收敛，且通过大量定向回归锁住行为。

### Latest Tech Information（2026-02-19）

- 官方源核验结果：
  - Node.js LTS: `v24.13.1`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - `antd`: `6.3.0`
  - `@tanstack/react-query`: `5.90.21`
  - `zustand`: `5.0.11`
  - Redis OSS: `8.6.0`
  - MySQL 8.4 最新可见补丁：`8.4.8`
- 本地运行时快照：
  - `node -v` = `v25.2.1`
- 结论：
  - 本故事以当前仓库依赖版本完成交付，避免在高风险授权链路上叠加升级变量。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md`
  - `_bmad-output/implementation-artifacts/3-2-组织角色管理.md`
  - 最近 5 次 git 提交与现有代码结构

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Story 3.3 code review completed: adversarial findings fixed（新增“camel/snake 字段 shadow 兼容修复 + 定向回归”），并完成定向与全量门禁。`

### Project Structure Notes

- 当前实现已具备 tenant 成员治理（3.1）与 tenant 角色目录治理（3.2）；3.3 的最小破坏路径是“在既有模块上增量增加权限树与成员角色绑定能力”。
- 推荐采用与平台侧一致的三段式实现：
  - 角色权限授予事实表
  - 成员角色绑定事实表
  - 快照/会话收敛链路
- 由于现有 tenant 权限上下文仍是 `can_*` 布尔快照，本故事需明确“权限码 -> 布尔快照”映射策略，避免出现“写了权限树但鉴权不认”的断层。

### References

- Epic 3 / Story 3.3（用户故事与验收标准）  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 3.3: 组织权限树与成员角色分配]
- FR22 / FR23 需求定义  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 双域边界、权限树仅落最终授权、角色禁用即时失效、会话收敛  
  [Source: _bmad-output/planning-artifacts/prd.md]  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md]
- 架构边界与实现一致性规则  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- UX 约束（列表工作台 + Modal/Drawer + message + loading 防重复）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事实现经验  
  [Source: _bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md]  
  [Source: _bmad-output/implementation-artifacts/3-2-组织角色管理.md]  
  [Source: _bmad-output/implementation-artifacts/2-5-平台权限树配置与角色分配生效.md]
- 当前代码基线  
  [Source: apps/api/src/modules/tenant/role.service.js]  
  [Source: apps/api/src/modules/tenant/member.service.js]  
  [Source: apps/api/src/modules/platform/role.service.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/modules/auth/auth.store.mysql.js]  
  [Source: apps/api/src/modules/auth/auth.store.memory.js]  
  [Source: apps/api/src/openapi.js]  
  [Source: apps/api/src/route-permissions.js]
- 最新版本核验来源（官方）  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]  
  [Source: https://registry.npmjs.org/antd/latest]  
  [Source: https://registry.npmjs.org/@tanstack/react-query/latest]  
  [Source: https://registry.npmjs.org/zustand/latest]  
  [Source: https://api.github.com/repos/redis/redis/releases/latest]  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js`
- `pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`

### Completion Notes List

- 已交付 tenant 角色权限树读写接口：`GET/PUT /tenant/roles/:role_id/permissions`，仅接受并持久化最终授权 `permission_codes`（叶子权限点）。
- 已实现权限码输入约束：仅允许服务端清单中的 `tenant.*`，拒绝跨域与未知权限码；并对控制字符、重复值、上限做统一校验。
- 已交付成员角色绑定接口：`GET/PUT /tenant/members/:membership_id/roles`，绑定事实锚定 `membership_id`，并落实 1-5 角色强约束。
- 已实现成员角色 replace 语义与幂等重放一致性，同键异载荷冲突保持稳定 Problem Details 输出。
- 已打通角色权限树与成员角色绑定变更后的权限并集重算，禁用角色/解绑/非激活成员均不贡献有效权限。
- 已落实会话收敛与即时生效路径，权限变更后后续鉴权读取最新组织权限上下文。
- 已对齐新增路由权限声明与 OpenAPI 契约，维持 `snake_case` 外部字段与 `retryable` 语义一致。
- 已补齐 Story 3.3 回归矩阵（权限树、角色分配、即时生效、安全 fail-closed）并全部通过门禁。
- 已完成代码评审修复：成员角色绑定读写结果从“静默过滤”升级为“严格校验 + fail-closed”，防止畸形下游数据被吞掉。
- 已新增 4 条直接回归用例，覆盖成员角色绑定读取/写入结果的畸形 `role_ids` 与超上限场景。
- 已补充第二轮审查加固：成员角色绑定增加“tenant 目录一致性 + 写后结果严格一致”校验，角色权限授予增加“写后权限码合法性 + 结果一致性”校验。
- 已新增 3 条直接回归用例，覆盖跨租户脏角色绑定透传、写后角色集合不一致、写后权限码集合不一致三类 fail-closed 场景。
- 已补充第三轮审查加固：tenant API 层成员角色绑定读写改为“下游回包结构严格校验 + 角色集合一致性校验”，杜绝静默降级为成功响应。
- 已补充第三轮审查加固：tenant API 层角色权限树读写增加“权限码集合合法性 + `affected_user_count` 非负整数”强校验，畸形回包统一 fail-closed。
- 已新增 4 条定向回归用例，覆盖成员角色绑定读写畸形回包与角色权限树读写畸形回包场景。
- 已补充第四轮审查加固：auth 服务层新增“成员角色写后 `membership_id` 一致性校验”与“角色授权写后 `role_id` 一致性校验”，不一致统一 fail-closed `503`。
- 已补充第四轮审查加固：auth 服务层成员角色标准化改为严格字符串类型校验，杜绝非字符串 `role_ids` 被隐式字符串化透传。
- 已新增 3 条定向回归用例，覆盖非字符串 `role_ids`、成员角色写后 `membership_id` 不一致、角色授权写后 `role_id` 不一致三类场景。
- 已补充第五轮审查加固：tenant 角色权限树写接口新增 `permission_codes` 前后空白字符严格拒绝，避免契约与幂等语义偏差。
- 已补充第五轮审查加固：auth 服务层新增 tenant 角色权限写后 `affected_user_ids` 强类型校验与 `affected_user_count` 非负整数/一致性校验，异常统一 fail-closed `503`。
- 已新增 4 条定向回归用例，覆盖权限码前后空白拒绝、`affected_user_ids` 畸形、`affected_user_count` 非法与计数不一致场景。
- 已补充第六轮审查加固：auth 服务层成员角色绑定写入新增 `affected_user_ids` 强类型与 `affected_user_count` 一致性校验，依赖畸形返回统一 fail-closed `503`。
- 已新增 4 条定向回归用例，覆盖成员角色绑定写链路 `affected_user_ids` / `affected_user_count` 畸形，以及两条新增 PUT 路由 retryable/non-retryable `409` 幂等缓存语义。
- 已补充第七轮审查加固：auth 服务层 tenant 写链路新增“`affected_user_ids` + `affected_user_count` 元数据缺失即 fail-closed”约束，避免依赖回包降级导致会话缓存失效不完整。
- 已补充第七轮审查加固：auth 服务层平台/租户角色权限读取链路对空权限码从“静默过滤”升级为“严格拒绝 + 统一 503”。
- 已新增 4 条定向回归用例，覆盖平台/租户权限读取空权限码以及 tenant 写链路缺失 affected-user 元数据场景。
- 已补充第八轮审查加固：成员角色绑定写入新增“membership 必须 active”硬校验，`disabled/left` 成员关系统一按不存在处理并拒绝分配。
- 已补充第八轮审查加固：租户角色目录与租户权限 grants 读取新增“同 role 重复记录 fail-closed”保护，防止依赖异常被静默覆盖。
- 已新增 3 条定向回归用例，覆盖非 active 成员关系拒绝分配、角色目录重复记录、权限 grants 重复记录三类场景。
- 已补充第九轮审查加固：auth 服务层将 `affected_user_ids` 与 `affected_user_count` 从“宽松容忍/数值强转”升级为“严格类型校验 + fail-closed”，阻断 `null` 等畸形依赖回包被误接纳。
- 已新增 4 条定向回归用例，覆盖成员角色绑定与角色权限授予写链路的 `affected_user_ids = null` 与 `affected_user_count = null` 场景。

- 已补充第十轮对抗审查加固：成员角色绑定写链路在 memory/mysql 存储层新增事务内 `membership=active` 强校验，阻断预检与写入间竞态导致的失效关系越权写入。
- 已补充第十轮对抗审查加固：成员角色绑定写链路在 memory/mysql 存储层新增事务内角色有效性校验（`scope=tenant`、`tenant_id` 一致、`status=active`），并在服务层映射为稳定 `404 role not found` 语义。
- 已新增 4 条定向回归用例，覆盖服务层竞态语义映射与 MySQL 存储层事务内拒绝路径（非 active membership、disabled role）。
- 已补充第十一轮对抗审查加固：补齐新增成员角色绑定与角色权限授予接口的 OpenAPI Problem Details 示例（400/401/403/404/409/413/503）与 `retryable` 语义，修复 `PUT /tenant/members/{membership_id}/roles` 的 404 契约遗漏（`role not found`）。
- 已新增 1 组契约断言回归（`test/server.test.js`），锁定上述 OpenAPI 示例字段、错误码与幂等降级语义不回退。
- 已补充第十二轮对抗审查加固：修复 `auth.store.mysql` 中 tenant 权限码严格校验链路未定义常量导致的 `ReferenceError`，恢复读链路稳定 fail-closed 行为。
- 已补充第十二轮对抗审查加固：memory/mysql 存储层 tenant grants 读取与写后收敛路径统一升级为严格校验（畸形/重复权限码、意外 role 行、仅 active membership 收敛）。
- 已新增 3 条 MySQL 存储层定向回归，覆盖畸形权限码、重复权限码、意外 role 行三类 fail-closed 场景（`test/auth.store.mysql.test.js`）。
- 已补充第十三轮对抗审查加固：tenant 成员角色读取与 tenant 角色权限读取链路统一补齐“回包前后空白即 fail-closed”约束，阻断依赖层脏数据被静默 trim 接纳。
- 已补充第十三轮对抗审查加固：auth 服务层写链路 `affected_user_ids` 升级为“前后空白严格拒绝”，统一保持 dependency payload 严格校验语义。
- 已新增 4 条定向回归用例，覆盖成员角色读取空白 `role_ids`、角色权限读取空白 `permission_codes`、成员角色写链路空白 `affected_user_ids`、角色权限写链路空白 `affected_user_ids` 场景。
- 已补充第十四轮对抗审查加固：tenant 成员角色读写 API 层新增 `membership_id` 严格回包校验，前后空白一律视为依赖畸形并 fail-closed `503`。
- 已补充第十四轮对抗审查加固：tenant 角色权限读写 API 层新增 `role_id` 严格回包校验，前后空白一律视为依赖畸形并 fail-closed `503`。
- 已补充第十四轮对抗审查加固：tenant 角色权限写 API 层将 `affected_user_count` 从 `Number()` 宽松强转升级为严格 `number` 非负整数校验。
- 已新增 5 条定向回归用例，覆盖成员角色读写 `membership_id` 空白、角色权限读写 `role_id` 空白、`affected_user_count` 字符串计数场景。
- 已补充第十五轮对抗审查加固：auth 服务层租户权限 grants 读取链路新增依赖回包 `role_id` 严格校验，拒绝前后空白 `role_id` 透传。
- 已补充第十五轮对抗审查加固：auth 服务层租户权限 grants 读写链路新增依赖回包 `permission_codes` 严格校验，拒绝前后空白与重复码值的宽松容忍。
- 已补充第十五轮对抗审查加固：auth 服务层成员角色绑定写链路新增依赖回包 `membership_id/role_ids` 严格校验，拒绝前后空白被 `trim` 后误接纳。
- 已新增 7 条定向回归用例，覆盖租户权限 grants 读/写与成员角色绑定写回执中的 `role_id`、`permission_codes`、`membership_id`、`role_ids` 前后空白场景。
- 已补充第十六轮对抗审查加固：auth 服务层 `loadValidatedTenantRoleCatalogEntries` 对依赖回包 `status/scope/tenant_id` 升级为严格字符串校验，拒绝前后空白与控制字符并统一 fail-closed。
- 已补充第十六轮对抗审查加固：tenant 角色目录字段畸形与业务语义（禁用、跨租户、非 tenant scope）完成解耦，畸形回包稳定映射 `503`，业务不匹配保留 `404`。
- 已新增 3 条定向回归用例，覆盖成员角色绑定写、角色权限读取、角色权限写入三条链路的 `scope/status/tenant_id` 前后空白场景。
- 已补充第十七轮对抗审查加固：修复 in-memory 存储层 tenant 角色授权写链路在“多成员快照重算中途失败”场景下的部分写入风险，升级为 grants 与成员权限快照全量回滚，并将 tenant 会话收敛延后到全量成功后执行。
- 已新增 2 条定向回归用例，覆盖“中途失败回滚后 grants/快照保持原值”与“失败回滚不误撤销 tenant 会话”场景（`test/auth.service.test.js`）。
- 已补充第十八轮对抗审查加固：auth 服务层 tenant 角色权限读写与成员角色绑定读写统一升级为“入参主键 strict 校验”（`role_id`/`membership_id` 前后空白、控制字符、非法格式、超长一律拒绝），消除隐式 trim 容忍。
- 已新增 4 条定向回归用例，覆盖 `list/replaceTenantRolePermissionGrants` 与 `list/replaceTenantMemberRoleBindings` 的主键空白/畸形输入场景（`test/auth.service.test.js`）。
- 已补充第十九轮对抗审查加固：平台角色权限原子写回执升级为 strict fail-closed（`role_id` 严格一致、`permission_codes` 合法且与请求一致、`affected_user_ids`/`affected_user_count` 元数据必须显式返回并严格一致）。
- 已新增 4 条定向回归用例，覆盖平台角色权限原子写回执 `role_id` 不一致、权限码前后空白、缺失 affected-user 元数据、affected-user 计数不一致场景（`test/auth.service.test.js`）。
- 已补充 MySQL 存储层平台角色权限原子写回包 `affectedUserCount` 显式字段，保持服务层原子路径与分步路径语义一致。
- 已补充第二十轮对抗审查加固：修复成员治理幂等路由在 `membership_id` 大小写路径变体下的作用域漂移，新增幂等专用 `membership_id` 规范化（仅影响幂等指纹，不改变业务入参语义）。
- 已新增 2 条定向回归用例，覆盖 `PATCH /tenant/members/:membership_id/status` 与 `PUT /tenant/members/:membership_id/roles` 的 canonicalized path idempotency 冲突语义。
- 已完成本轮门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（62/62）与 `pnpm --dir apps/api test`（818/818）。
- 已补充第二十一轮对抗审查加固：统一 `membership_id` 在成员治理 API 与 auth 服务层的大小写归一化规则，消除“幂等层与业务层归一化口径不一致”导致的查找漂移风险。
- 已新增 5 条定向回归用例，覆盖 API `PATCH/GET/PUT` 三条链路与 auth 服务层 `list/replace` 两条链路的 `membership_id` 归一化行为。
- 已完成本轮门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js`（290/290）与 `pnpm --dir apps/api test`（823/823）。
- 已补充第二十二轮对抗审查加固：修复 tenant member/tenant role/auth service 三处字段解析在 `camelCase` 影子键为 `undefined/null` 时错误屏蔽 `snake_case` 的缺陷，避免合法下游回包被误判为 fail-closed `503`。
- 已新增 3 条定向回归用例，覆盖成员列表、角色目录、平台角色权限授予三条链路的 snake/camel shadow fallback 场景。
- 已完成本轮门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（66/66）、`pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`（52/52）、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（226/226）与 `pnpm --dir apps/api test`（826/826）。

### File List

- `_bmad-output/implementation-artifacts/3-3-组织权限树与成员角色分配.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0014_tenant_role_permission_grants.sql`
- `apps/api/migrations/0014_tenant_role_permission_grants.down.sql`
- `apps/api/migrations/0015_auth_tenant_membership_roles.sql`
- `apps/api/migrations/0015_auth_tenant_membership_roles.down.sql`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/tenant/member.constants.js`
- `apps/api/src/modules/tenant/member.routes.js`
- `apps/api/src/modules/tenant/member.service.js`
- `apps/api/src/modules/tenant/role.constants.js`
- `apps/api/src/modules/tenant/role.routes.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/tenant.member.api.test.js`
- `apps/api/test/tenant.role.api.test.js`

### Change Log

- 2026-02-19：完成 Story 3.3 实现收口并进入 `review`，交付组织权限树与成员角色分配全链路（接口、鉴权并集重算、会话收敛、契约、幂等与回归）；门禁通过 `check:route-permissions`、`lint`、`test`（730/730）。
- 2026-02-19：完成 Story 3.3 代码评审闭环并更新为 `done`；修复成员角色绑定读写链路 fail-closed 缺口，补充 4 条定向回归测试；门禁通过 `check:route-permissions`、`lint`、`test`（734/734）。
- 2026-02-19：完成 Story 3.3 第二轮对抗审查闭环；新增 3 项服务层结果一致性校验并补充 3 条定向回归测试；门禁通过 `check:route-permissions`、`lint`、`test`（737/737）。
- 2026-02-19：完成 Story 3.3 第三轮对抗审查闭环；补齐 tenant API 层下游回包强校验（成员角色绑定与角色权限树），新增 4 条定向回归测试；门禁通过 `test`（741/741）。
- 2026-02-19：完成 Story 3.3 第四轮对抗审查闭环；补齐 auth 服务层写后主键一致性校验（`membership_id` / `role_id`）与非字符串 `role_ids` 强校验，新增 3 条定向回归测试；门禁通过 `pnpm --dir apps/api exec node --test test/auth.service.test.js`、`pnpm --dir apps/api test`（744/744）。
- 2026-02-19：完成 Story 3.3 第五轮对抗审查闭环；新增 tenant 权限码前后空白拒绝、服务层 `affected_user_ids`/`affected_user_count` 严格校验与定向回归；门禁通过 `pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.role.api.test.js`（224/224）。
- 2026-02-19：完成 Story 3.3 第六轮对抗审查闭环；补齐成员角色绑定写链路 `affected_user_ids`/`affected_user_count` 严格校验，并新增成员角色绑定/角色权限授予 PUT 路由的 retryable/non-retryable `409` 幂等缓存语义回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js`（282/282）与 `pnpm --dir apps/api test`（754/754）。
- 2026-02-19：完成 Story 3.3 第七轮对抗审查闭环；补齐 auth 服务层“依赖回包缺失 affected-user 元数据”强约束，并将平台/租户权限读取链路空权限码处理升级为 fail-closed；新增 4 条定向回归，门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（188/188）与 `pnpm --dir apps/api test`（758/758）。
- 2026-02-19：完成 Story 3.3 第八轮对抗审查闭环；补齐“非 active membership 禁止角色分配”与“角色目录/权限 grants 重复记录 fail-closed”3 项修复，新增 3 条定向回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（191/191）与 `pnpm --dir apps/api test`（761/761）。
- 2026-02-19：完成 Story 3.3 第九轮对抗审查闭环；修复 auth 服务层对 `affected_user_ids`/`affected_user_count` 的 `null` 与非严格类型容忍问题，统一升级为 fail-closed 强校验；新增 4 条定向回归，门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（195/195）与 `pnpm --dir apps/api test`（765/765）。
- 2026-02-19：完成 Story 3.3 第十轮对抗审查闭环；修复成员角色绑定写链路 TOCTOU 缺口（存储层事务内 `membership=active` 与角色有效性双重校验）并补齐服务层错误语义映射，新增 4 条定向回归；门禁通过 `pnpm --dir apps/api exec node --test test/auth.service.test.js`（197/197）、`pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（80/80）与 `pnpm --dir apps/api test`（769/769）。
- 2026-02-19：完成 Story 3.3 第十一轮对抗审查闭环；补齐新增接口 OpenAPI Problem Details 示例与 `retryable` 语义（成员角色绑定、角色权限授予），并修复成员角色绑定写接口 404 契约遗漏；门禁通过 `pnpm --dir apps/api exec node --test test/server.test.js`（65/65）、`pnpm --dir apps/api lint` 与 `pnpm --dir apps/api test`（769/769）。
- 2026-02-19：完成 Story 3.3 第十二轮对抗审查闭环；修复 MySQL tenant grants 严格校验链路 `CONTROL_CHAR_PATTERN` 运行时缺失，补齐 grants 读取畸形/重复/意外 role 行 fail-closed 保护，并对受影响成员收敛统一限定 `active/enabled`；门禁通过 `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（83/83）、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（197/197）、`pnpm --dir apps/api check:route-permissions` 与 `pnpm --dir apps/api lint`。
- 2026-02-19：完成 Story 3.3 第十三轮对抗审查闭环；修复 tenant API 层与 auth 服务层对依赖回包前后空白字段（`role_ids`/`permission_codes`/`affected_user_ids`）的静默 trim 容忍，统一升级为严格 fail-closed；新增 4 条定向回归并通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js`（300/300）与 `pnpm --dir apps/api test`（777/777）。
- 2026-02-19：完成 Story 3.3 第十四轮对抗审查闭环；补齐 tenant API 层 `membership_id/role_id` 回包空白容忍缺口并将 `affected_user_count` 升级为严格 number 校验，新增 5 条定向回归；门禁通过 `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/tenant.role.api.test.js`（105/105）与 `pnpm --dir apps/api test`（782/782）。
- 2026-02-19：完成 Story 3.3 第十五轮对抗审查闭环；补齐 auth 服务层租户权限 grants 与成员角色绑定写链路对依赖回包前后空白字段（`role_id`/`permission_codes`/`membership_id`/`role_ids`）的 trim 容忍缺口，统一升级为严格 fail-closed；新增 7 条定向回归并通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（207/207）、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js`（312/312）与 `pnpm --dir apps/api test`（789/789）。
- 2026-02-19：完成 Story 3.3 第十六轮对抗审查闭环；修复 tenant 角色目录依赖回包 `status/scope/tenant_id` 的 trim 容忍缺口并按“畸形数据 503、业务不匹配 404”收敛语义，新增 3 条定向回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（213/213）、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/tenant.role.api.test.js`（318/318）与 `pnpm --dir apps/api test`（795/795）。
- 2026-02-20：完成 Story 3.3 第十七轮对抗审查闭环；修复 in-memory tenant 角色授权写链路在快照重算中途失败时的原子性缺口（全量回滚 + 会话收敛延后），并补齐 2 条定向回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（215/215）与 `pnpm --dir apps/api test`（808/808）。
- 2026-02-20：完成 Story 3.3 第十八轮对抗审查闭环；修复 auth 服务层 tenant 角色权限与成员角色绑定链路的入参主键 trim 容忍（`role_id`/`membership_id`），升级为 strict fail-closed `400` 并补齐 4 条定向回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（219/219）与 `pnpm --dir apps/api test`（812/812）。
- 2026-02-20：完成 Story 3.3 第十九轮对抗审查闭环；补齐平台角色权限原子写回执 fail-closed 校验（`role_id`/`permission_codes`/`affected_user_ids`/`affected_user_count`）并在 MySQL 原子写回包新增 `affectedUserCount` 显式字段；新增 4 条定向回归，门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（223/223）、`pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（88/88）与 `pnpm --dir apps/api test`（816/816）。
- 2026-02-20：完成 Story 3.3 第二十轮对抗审查闭环；修复成员状态更新与成员角色绑定写路由在 `membership_id` 大小写路径变体下的幂等作用域漂移（同键可被绕过），新增幂等专用参数规范化并补 2 条定向回归；门禁通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（62/62）与 `pnpm --dir apps/api test`（818/818）。
- 2026-02-20：完成 Story 3.3 第二十一轮对抗审查闭环；修复成员治理链路 `membership_id` 归一化口径不一致（幂等层已 canonicalize，但 API/auth 服务层未统一）导致的跨层语义漂移风险；新增 5 条定向回归并通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js`（290/290）与 `pnpm --dir apps/api test`（823/823）。
- 2026-02-20：完成 Story 3.3 第二十二轮对抗审查闭环；修复 tenant member/tenant role/auth service 三处 camel/snake 字段解析 shadow 缺陷（`camelCase undefined/null` 错误覆盖 `snake_case`），新增 3 条定向回归并通过 `pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（66/66）、`pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`（52/52）、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（226/226）与 `pnpm --dir apps/api test`（826/826）。

### Senior Developer Review (AI)

- 审查范围：`apps/api/src/modules/tenant/member.service.js`、`apps/api/src/modules/tenant/role.service.js`、`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/tenant.member.api.test.js`、`apps/api/test/tenant.role.api.test.js`、`apps/api/test/auth.service.test.js`（并对照 Story 3.3 AC、Tasks 与本轮 git 变更清单）。
- 结论：本轮新增 3 项高优先级问题并已修复（camel/snake 字段 shadow fallback 缺陷）；累计 71 项问题均已闭环，当前无遗留 action item。
- 核验结果：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（66/66）、`pnpm --dir apps/api exec node --test test/tenant.role.api.test.js`（52/52）、`pnpm --dir apps/api exec node --test test/auth.service.test.js`（226/226）与 `pnpm --dir apps/api test`（826/826）全部通过。
