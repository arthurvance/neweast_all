# Story 5.4: 失败重试、恢复与再处理闭环

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 运维负责人,  
I want 集成失败后自动重试并支持恢复再处理,  
so that 外部依赖波动不会造成持续业务中断。

## Acceptance Criteria

1. **Given** 外部调用发生可重试失败  
   **When** 系统执行重试策略  
   **Then** 按指数退避与抖动重试  
   **And** 超过阈值进入可追踪失败队列
2. **Given** 失败请求进入待恢复状态  
   **When** 操作者执行再处理或人工重放  
   **Then** 系统可再次投递并记录处理结果  
   **And** 全过程保留追踪标识与审计证据

## Tasks / Subtasks

- [x] 任务 1：落地“失败重试/恢复队列”持久化模型（AC: 1, 2）
  - [x] 新增迁移 `apps/api/migrations/0023_platform_integration_retry_recovery.sql`（及 down）。
  - [x] 新增重试/恢复主表（建议命名 `platform_integration_retry_recovery_queue`），至少覆盖：
    - [x] `recovery_id`（主键）
    - [x] `integration_id`、`contract_type`、`contract_version`
    - [x] `request_id`、`traceparent`、`idempotency_key`
    - [x] `attempt_count`、`max_attempts`、`next_retry_at`、`last_attempt_at`
    - [x] `status`（`pending|retrying|succeeded|failed|dlq|replayed`）
    - [x] `failure_code`、`failure_detail`、`last_http_status`、`retryable`
    - [x] `payload_snapshot`、`response_snapshot`
    - [x] `created_at`、`updated_at`、`created_by_user_id`、`updated_by_user_id`
  - [x] 索引至少覆盖：`(status, next_retry_at)`、`(integration_id, status)`、`request_id`。
  - [x] 约束：同一业务幂等语义下不得产生重复可执行任务（防重复投递）。

- [x] 任务 2：实现 store 层（MySQL + in-memory）并保持 fail-closed 语义一致（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.store.mysql.js` 新增重试队列 CRUD/状态迁移方法。
  - [x] 在 `apps/api/src/modules/auth/auth.store.memory.js` 实现同名同语义方法，避免测试环境漂移。
  - [x] 对读取结果做结构化严格校验；畸形数据统一抛错并映射 `503`。
  - [x] 对并发 claim/replay 加锁或原子状态变更，避免重复消费。

- [x] 任务 3：实现重试编排与再处理执行器（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/integration/` 新增重试编排模块（建议：`delivery-retry-orchestrator.js`）。
  - [x] 重试判定严格遵循架构约束：仅 `408/429/5xx` 与可识别瞬时网络错误进入自动重试。
  - [x] 退避策略：指数退避 + jitter；默认最大重试次数不超过 5（与 NFR13 对齐）。
  - [x] 超过阈值后状态进入 `dlq`，并保留完整失败上下文用于人工重放。
  - [x] 执行链路必须保留并透传 `request_id` / `traceparent`。

- [x] 任务 4：提供恢复/人工重放治理 API（AC: 2）
  - [x] 新增平台侧恢复模块：
    - [x] `apps/api/src/modules/platform/integration-recovery.constants.js`
    - [x] `apps/api/src/modules/platform/integration-recovery.routes.js`
    - [x] `apps/api/src/modules/platform/integration-recovery.service.js`
  - [x] 建议接口：
    - [x] `GET /platform/integrations/:integration_id/recovery/queue`（查看失败/待恢复队列）
    - [x] `POST /platform/integrations/:integration_id/recovery/queue/:recovery_id/replay`（人工重放）
  - [x] replay 写接口纳入 `Idempotency-Key` 保护，防止重复重放。

- [x] 任务 5：接线路由、权限声明、幂等与契约（AC: 1, 2）
  - [x] 在 `apps/api/src/http-routes.js` 接入 recovery handlers。
  - [x] 在 `apps/api/src/server.js` 增加路由分发并纳入 `IDEMPOTENCY_PROTECTED_ROUTE_KEYS`。
  - [x] 在 `apps/api/src/route-permissions.js` 声明受保护路由（建议：读 `platform.member_admin.view`，写 `platform.member_admin.operate`）。
  - [x] 执行并通过 `pnpm --dir apps/api check:route-permissions`。

- [x] 任务 6：补齐 OpenAPI 与错误语义（AC: 1, 2）
  - [x] 在 `apps/api/src/openapi.js` 增加 recovery queue/replay 路径、schema、示例。
  - [x] Problem Details 字段保持一致：`error_code`、`request_id`、`traceparent`、`retryable`。
  - [x] 覆盖典型错误：
    - [x] 非法参数（400）
    - [x] 目标不存在（404）
    - [x] 状态冲突/重放冲突（409）
    - [x] 依赖异常 fail-closed（503）

- [x] 任务 7：审计与运行手册（AC: 2）
  - [x] 审计事件至少覆盖：
    - [x] `platform.integration.recovery.retry_scheduled`
    - [x] `platform.integration.recovery.retry_exhausted`
    - [x] `platform.integration.recovery.replayed`
    - [x] `platform.integration.recovery.reprocess_succeeded|failed`
  - [x] 事件必须可按 `request_id` 查询，且包含 `before_state/after_state` 或等价关键状态差异。
  - [x] 新增 runbook：`docs/runbooks/integration/retry-recovery-replay.md`（DLQ 处理、人工重放、回滚路径）。

- [x] 任务 8：测试与回归门禁（AC: 1, 2）
  - [x] 新增 `apps/api/test/platform.integration.recovery.api.test.js`（自动重试、入队、DLQ、重放）。
  - [x] 扩展 `apps/api/test/auth.store.mysql.test.js`（并发 claim、状态迁移原子性、fail-closed）。
  - [x] 扩展 `apps/api/test/http-routes.test.js`、`apps/api/test/route-permissions.test.js`、`apps/api/test/migrate-baseline.test.js`。
  - [x] 必过命令：
    - [x] `pnpm --dir apps/api check:route-permissions`
    - [x] `pnpm --dir apps/api lint`
    - [x] `pnpm --dir apps/api test`

### Review Follow-ups (AI)

- [x] [AI-Review][MEDIUM] 修复终态记录污染：同去重键重复投递不再覆盖 `succeeded/replayed` 终态记录内容（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`）。
- [x] [AI-Review][MEDIUM] 修复退避上界越界：`jitter` 后延迟值增加 `maxDelay` 钳制，避免超过配置上限（`apps/api/src/modules/integration/delivery-retry-orchestrator.js`）。
- [x] [AI-Review][MEDIUM] 补齐回归覆盖：新增重试编排器测试、终态去重不可变测试、重试耗尽落入 `dlq` 测试（`apps/api/test/integration.delivery-retry-orchestrator.test.js`、`apps/api/test/platform.integration.recovery.api.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] 修复人工重放后不可再处理：`replay` 会重置 `attempt_count` 并允许 `replayed` 状态再次进入 claim 处理流程（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`）。
- [x] [AI-Review][MEDIUM] 修复处理审计与返回值 `previous_status` 错报：`processNextRecoveryQueueItem` 改为使用 claim 返回的真实前态（`apps/api/src/modules/platform/integration-recovery.service.js`）。
- [x] [AI-Review][MEDIUM] 修复 Story 变更清单遗漏：补录 `apps/api/test/platform.integration.recovery.service.test.js`（`_bmad-output/implementation-artifacts/5-4-失败重试-恢复与再处理闭环.md`）。

## Dev Notes

### Developer Context（开发者先读）

- Story 5.1 已交付集成目录与生命周期能力；Story 5.2/5.3 已交付契约版本治理与一致性门禁。本故事应复用既有目录、契约、幂等、审计能力，不重建第二套链路。
- 当前仓库已有 `modules/integration/contract-resolver.js`，但尚无“失败重试/恢复队列”完整落地；5.4 的核心是把“失败治理闭环”补齐并可运营化。
- 延续近三条集成故事的实现风格：严格输入校验、结构化结果校验、依赖异常 fail-closed、审计可追踪。

### Story Foundation（来自 Epic 5 上下文）

- 直接目标：落实 `FR39`（失败重试、恢复、再处理闭环）。
- 强关联约束：
  - `NFR13`：重试必须是指数退避 + jitter，且受最大重试阈值约束。
  - `NFR14`：写操作必须幂等防重，不得重复副作用。
  - `NFR15`：全链路必须可追踪（`request_id` / `traceparent`）。
  - `NFR17`：需要形成可演练、可归档的恢复证据链。

### Technical Requirements（硬约束）

- 自动重试仅允许命中可重试失败类型（`408/429/5xx` + 可识别瞬时网络错误），禁止对业务确定性失败盲重试。
- 重试策略需支持“按集成配置可调 + 默认安全值”：
  - 默认 `max_attempts <= 5`
  - 指数退避 + jitter
  - 可追踪每次尝试与最终落点
- 超阈值后必须进入可查询失败队列（DLQ 语义），支持人工重放或再处理。
- 人工重放必须是幂等写路径；同一幂等键与同载荷重放不应产生重复执行。
- 失败与恢复全过程必须有审计证据，且能按 `request_id` 关联。

### Architecture Compliance（架构对齐清单）

- 遵循 `architecture.md` 集成模式：同步 API + 异步事件/Webhook 双通道，失败链路必须具备重试、DLQ、人工重放 runbook。
- API 与错误模型维持现有风格：REST + OpenAPI + Problem Details。
- 受保护路由必须在 `route-permissions.js` 声明；缺失声明应被门禁阻断。
- 写接口纳入服务器幂等保护集合，保持与 5.1/5.2/5.3 一致。

### Library & Framework Requirements（版本核验）

- 当前仓库版本（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 外部最新核验（2026-02-22）：
  - Node.js LTS：`v24.13.1`（Krypton），Current：`v25.6.1`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS 最新 patch：`8.4.8`
- 本故事决策：不做依赖升级；优先在既有栈落地失败治理闭环。

### File Structure Requirements（建议变更落点）

- 新增（建议）：
  - `apps/api/migrations/0023_platform_integration_retry_recovery.sql`
  - `apps/api/migrations/0023_platform_integration_retry_recovery.down.sql`
  - `apps/api/src/modules/platform/integration-recovery.constants.js`
  - `apps/api/src/modules/platform/integration-recovery.routes.js`
  - `apps/api/src/modules/platform/integration-recovery.service.js`
  - `apps/api/src/modules/integration/delivery-retry-orchestrator.js`
  - `apps/api/test/platform.integration.recovery.api.test.js`
  - `docs/runbooks/integration/retry-recovery-replay.md`
- 修改：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（必须覆盖）

- 自动重试：
  - 可重试失败自动调度重试。
  - 非可重试失败直接进入失败态，不进入自动重试。
  - 重试次数与退避策略符合配置与默认上限。
- 失败队列与重放：
  - 超阈值进入 DLQ 并可查询。
  - replay 成功后状态可收敛并可审计。
  - replay 幂等重放语义稳定（同键同载荷返回一致结果）。
- fail-closed：
  - store 返回畸形数据、并发状态异常、依赖错误均应统一 503。
- 审计追踪：
  - 关键事件可按 `request_id` 查询，且状态变化可追踪。

### Previous Story Intelligence（来自 5.3 / 5.2 / 5.1）

- Story 5.3 复用点：
  - 保持“读取结果结构化校验 + fail-closed 503”策略，禁止静默容错。
  - 保持 idempotency 冲突语义一致（`AUTH-409-IDEMPOTENCY-CONFLICT`）。
  - 审计事件命名采用 `platform.integration.*` 风格，并保留 `request_id`。
- Story 5.2 复用点：
  - 集成执行前必须与契约版本状态对齐，避免“无效契约版本继续执行”。
- Story 5.1 复用点：
  - 生命周期 `active` 才允许生产调用；其余状态应拒绝并进入明确语义。
  - `retry_policy` / `idempotency_policy` 字段已在目录模型中存在，应直接复用。

### Git Intelligence Summary（最近 5 次提交）

- `10fb93f`：Story 5.3 完成，核心文件集中于 `integration-contract.*`、`openapi.js`、`route-permissions.js`、`server.js`、门禁脚本与测试。
- `1115abb`：Story 5.2 完成，新增契约版本迁移、契约解析器与兼容评估能力。
- `974a0d4`：Story 5.1 完成，新增集成目录迁移与生命周期治理 API。
- 实施规律：
  - 先落 store/migration，再接 service/routes，再补 OpenAPI/门禁/测试。
  - 每个写路径都同步补齐权限声明、幂等、审计与 fail-closed 回归。

### Latest Tech Information（外部核验）

- Node 官方发布索引：`https://nodejs.org/download/release/index.json`
  - LTS：`v24.13.1`（2026-02-09）
  - Current：`v25.6.1`（2026-02-09）
- npm Registry：
  - `https://registry.npmjs.org/@nestjs/core` -> latest `11.1.14`（2026-02-17）
  - `https://registry.npmjs.org/typeorm` -> latest `0.3.28`（2025-12-03）
  - `https://registry.npmjs.org/mysql2` -> latest `3.17.4`（2026-02-20）
  - `https://registry.npmjs.org/ioredis` -> latest `5.9.3`（2026-02-12）
- MySQL 8.4 release notes：`https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`（最新检测 `8.4.8`）

### Project Context Reference

- `**/project-context.md`：未找到（空匹配）。
- 本故事主要上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
  - `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`
  - `_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`已完成 Story 5.4 实现与全量回归验证，待代码评审。`

### References

- `_bmad-output/planning-artifacts/epics.md`
- `_bmad-output/planning-artifacts/prd.md`
- `_bmad-output/planning-artifacts/architecture.md`
- `_bmad-output/planning-artifacts/ux-design-specification.md`
- `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
- `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`
- `_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`
- `apps/api/src/modules/platform/integration.service.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/modules/integration/contract-resolver.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/server.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.integration.api.test.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/scripts/check-integration-contract-consistency.js`
- `tools/release-gate-report.js`
- `docs/runbooks/integration/contract-version-rollout.md`
- `https://nodejs.org/download/release/index.json`
- `https://registry.npmjs.org/@nestjs/core`
- `https://registry.npmjs.org/typeorm`
- `https://registry.npmjs.org/mysql2`
- `https://registry.npmjs.org/ioredis`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（CLI）

### Debug Log References

- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 已新增失败重试/恢复队列迁移（`0023`）与主流程编排器，支持指数退避 + jitter、重试阈值与 DLQ 收敛。
- 已补齐 MySQL 与 memory store 的 recovery queue 方法，并保持结构化校验与 fail-closed（`503`）语义一致。
- 已新增平台治理 API：失败队列查询与人工重放，写接口接入幂等保护并覆盖冲突语义。
- 已完成 `http-routes` / `server` / `route-permissions` / `openapi` 全链路接线与契约补齐。
- 已新增 runbook：`docs/runbooks/integration/retry-recovery-replay.md`，覆盖 DLQ 处理与人工重放操作路径。
- 已补齐回归测试（API、store、迁移、路由接线、权限、OpenAPI）并通过门禁命令。
- 代码评审追加修复：终态记录去重重投不可变保护（MySQL + memory）。
- 代码评审追加修复：退避 `jitter` 后延迟值强制不超过 `maxDelay`。
- 代码评审追加测试：重试编排器单测、终态不可变回归、`dlq` 耗尽路径回归。
- 代码评审追加修复：人工重放后恢复项可再次进入处理队列（重置 `attempt_count` 且 `replayed` 可被 claim）。
- 代码评审追加修复：`processNextRecoveryQueueItem` 的 `previous_status` 现返回真实前态，不再固定为 `retrying`。
- 代码评审追加补录：Story `File List` 增补 `apps/api/test/platform.integration.recovery.service.test.js`。

## Senior Developer Review (AI)

- Reviewer: 老大（AI）
- Date: 2026-02-22
- Outcome: Approve
- Findings Resolved:
  - [MEDIUM] 终态队列记录在去重重投时可能被二次写入污染，已修复。
  - [MEDIUM] 退避 `jitter` 计算后可能超过 `maxDelay` 上限，已修复。
  - [MEDIUM] 重试编排/终态不可变/耗尽落 `dlq` 路径缺少直接测试，已补齐。
  - [HIGH] 人工重放记录未能再次进入处理链路（`replayed` 未参与 claim 且重放不重置尝试计数），已修复。
  - [MEDIUM] `processNextRecoveryQueueItem` 输出 `previous_status` 与真实前态不一致，已修复。
  - [MEDIUM] Story File List 漏记已变更测试文件，已补齐。
- Validation:
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### File List

- `_bmad-output/implementation-artifacts/5-4-失败重试-恢复与再处理闭环.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0023_platform_integration_retry_recovery.sql`
- `apps/api/migrations/0023_platform_integration_retry_recovery.down.sql`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/integration/delivery-retry-orchestrator.js`
- `apps/api/src/modules/integration/index.js`
- `apps/api/src/modules/platform/integration-recovery.constants.js`
- `apps/api/src/modules/platform/integration-recovery.routes.js`
- `apps/api/src/modules/platform/integration-recovery.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/integration.delivery-retry-orchestrator.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/platform.integration.recovery.api.test.js`
- `apps/api/test/platform.integration.recovery.service.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `docs/runbooks/integration/retry-recovery-replay.md`

### Change Log

- 2026-02-22：完成 Story 5.4 实现、回归测试与文档回填，状态更新为 `review`。
- 2026-02-22：完成代码评审自动修复与补测（3 项 MEDIUM），状态更新为 `done`。
- 2026-02-22：复审追加修复（重放可再处理、`previous_status` 前态正确性、File List 漏项补录），并通过全量 `pnpm --dir apps/api test`。
