# Story 3.7: 组织软删除级联一致性

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台治理操作者,
I want 组织软删除后自动失效成员、组织角色与角色绑定,
so that 不会残留可用关系导致安全风险。

## Acceptance Criteria

1. **Given** 组织被标记软删除
   **When** 级联处理触发
   **Then** 组织下成员、组织角色与角色绑定同步失效
   **And** 不再参与后续权限计算
2. **Given** 组织被软删除后仍有历史会话
   **When** 会话访问组织域资源
   **Then** 系统拒绝访问
   **And** 返回统一未授权语义

## Tasks / Subtasks

- [x] 任务 1：收敛“组织软删除”语义到现有组织状态链路（AC: 1, 2）
  - [x] 明确并固定实现语义：当前模型以 `orgs.status = disabled` 承载“软删除”语义，不新增并行状态值。
  - [x] 在 `POST /platform/orgs/status` 链路内补充软删除级联分支，保持 Problem Details 错误契约稳定（`ORG-*` + `request_id`）。
  - [x] 保持幂等行为：对已软删除组织重复请求返回 no-op 语义且不产生脏写。

- [x] 任务 2：实现成员关系级联失效（AC: 1, 2）
  - [x] 在 `auth.store.mysql.updateOrganizationStatus` 中，对目标组织的成员关系执行状态失效（`memberships` 与 `auth_user_tenants` 同步收敛）。
  - [x] 保障与现有成员状态模型一致（`active/disabled/left`），避免引入新状态破坏既有查询条件。
  - [x] 对受影响成员执行租户域会话与 refresh token 撤销，复用当前 `tenant-membership-status-changed` / `org-status-changed` 语义并保证一致。

- [x] 任务 3：实现组织角色与角色绑定级联失效（AC: 1）
  - [x] 对 `platform_role_catalog` 中 `scope='tenant' AND tenant_id=org_id` 的角色执行失效（状态改为 `disabled`）。
  - [x] 对 `auth_tenant_membership_roles` 执行安全失效策略（删除或等价失效），确保软删除后不存在可生效绑定。
  - [x] 确保权限计算查询在软删除后无法通过旧绑定恢复权限（含缓存失效）。

- [x] 任务 4：审计与可观测补齐（AC: 1, 2）
  - [x] 在 `auth` 与 `platform` 审计事件中增加级联结果元数据：受影响成员数、角色数、绑定数、会话撤销数。
  - [x] 对级联异常使用 fail-closed：返回 `ORG-503-DEPENDENCY-UNAVAILABLE`，并记录 `upstream_error_code`。
  - [x] 保证 request_id 贯穿，支持“软删除动作 -> 级联处理 -> 会话拒绝”链路追踪。

- [x] 任务 5：测试与门禁覆盖（AC: 1, 2）
  - [x] `apps/api/test/auth.store.mysql.test.js`：新增组织软删除后成员/角色/绑定级联失效与会话撤销断言。
  - [x] `apps/api/test/platform.org.api.test.js`：新增组织软删除 API 路径、幂等重复请求、异常映射与审计字段断言。
  - [x] `apps/api/test/auth.service.test.js`：新增服务层结果形状校验、缓存收敛与 no-op 行为断言。
  - [x] `apps/api/test/server.test.js`：必要时同步 OpenAPI 描述与错误示例断言。

- [x] 任务 6：内存存储与本地模式一致性（AC: 1, 2）
  - [x] `auth.store.memory.updateOrganizationStatus` 与 MySQL 行为保持一致（成员/角色/绑定/会话级联语义一致）。
  - [x] 防止 memory 与 mysql 在回归中产生行为漂移，确保测试双后端通过。

### Review Follow-ups (AI)

- [x] [AI-Review][MEDIUM] 明确“软删除=disabled”是否为本阶段唯一语义，避免未来引入 `deleted` 状态导致查询条件分叉与回归风险。
- [x] [AI-Review][MEDIUM] 若选择“角色绑定删除”策略，需确认是否保留足够历史证据（审计/历史表）以满足追溯需求。
- [x] [AI-Review][LOW] 增加级联统计字段上限与脱敏规则，避免异常大组织导致审计载荷膨胀。
- [x] [AI-Review][HIGH] 平台组织状态接口对级联统计字段改为严格校验并 fail-closed，避免依赖返回畸形计数时被静默归零。
- [x] [AI-Review][MEDIUM] 修正 `affected_membership_count` 口径，仅统计成员关系实际失效用户，不再把仅用于会话撤销的 owner 计入成员数。
- [x] [AI-Review][MEDIUM] MySQL 软删除租户角色级联时补齐 `updated_by_user_id` 写入，保证与内存实现和审计语义一致。

## Dev Notes

### Developer Context（开发者必须先读）

- Story 3.1-3.6 已建立组织成员治理、组织角色治理、角色授权绑定、负责人接管与并发重试基线；本故事是生命周期“软删除级联一致性”收口，不是重建 RBAC 模型。
- 现有 `POST /platform/orgs/status` 已具备组织状态变更与会话撤销框架，是本故事首选扩展点。
- 当前系统已对 tenant 域权限计算做“成员状态 + 组织状态 + 角色状态”联合约束，本故事必须把“状态失效”与“关系失效”同时落地，防止残留活跃关系。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR77`；协同约束：`FR79`、`FR80`。
- 软删除后必须满足：
  - 成员关系不可用（`memberships` / `auth_user_tenants` 不再 active-like）。
  - 组织角色不可用（tenant 角色状态失效）。
  - 角色绑定不可生效（删除或等价失效，且权限计算不得命中）。
- 历史会话访问 tenant 资源必须被拒绝，维持统一未授权语义（`AUTH-403-*` 系列按既有契约映射）。
- 保持关键写一致性：幂等、冲突可识别、失败 fail-closed，不允许半级联成功。

### Architecture Compliance（架构对齐清单）

- 模块边界保持：
  - `modules/platform/org.service.js` 负责入口编排、错误映射、审计事件。
  - `modules/auth/auth.service.js` 负责领域编排与结果校验。
  - `modules/auth/auth.store.mysql.js|memory.js` 负责事务级级联与数据一致性。
- Problem Details 必须继续由统一错误结构输出，不得在路由层引入旁路错误格式。
- 关键身份/权限状态变化后需触发会话收敛（session invalidation）。
- 级联处理应优先复用既有能力（成员状态更新、权限快照同步、会话撤销函数），避免重复造轮子。

### Library & Framework Requirements（库与框架要求）

- 当前工程版本（`apps/api/package.json`）：
  - `@nestjs/core` `11.1.13`
  - `typeorm` `^0.3.28`
  - `mysql2` `^3.17.0`
  - `ioredis` `5.9.2`
- 最新稳定校验（2026-02-20）：
  - `@nestjs/core` `11.1.14`
  - `typeorm` `0.3.28`
  - `mysql2` `3.17.4`
  - `ioredis` `5.9.3`
  - Node.js LTS `v24.13.1 (Krypton)`
- 本故事优先交付一致性能力，不要求版本升级；如升级仅允许 patch 级并需回归关键链路。

### File Structure Requirements（建议变更落点）

- 平台入口与契约：
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/platform/org.routes.js`
  - `apps/api/src/openapi.js`
- 领域编排与一致性：
  - `apps/api/src/modules/auth/auth.service.js`
- 数据级联（核心）：
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 如需 schema/迁移：
  - `apps/api/migrations/*.sql`
- 测试：
  - `apps/api/test/platform.org.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（必须覆盖）

- AC1：
  - 组织软删除后，成员关系状态失效、tenant 角色状态失效、角色绑定失效。
  - 软删除后权限计算不再命中该组织残留关系。
- AC2：
  - 软删除前签发的 tenant 会话访问组织域资源被拒绝，返回统一未授权语义。
  - 对应 refresh token 被撤销，不能继续换发访问令牌。
- 回归与鲁棒性：
  - 重复软删除请求 no-op 且结果稳定。
  - 级联任一步骤失败时整体 fail-closed，不产生半成功状态。
  - MySQL 与 memory 双后端语义一致。

### Previous Story Intelligence（跨故事关键信息）

- Story 3.6 已将高风险链路的“冲突可识别 + 可重试 + 全成功/全回滚 + 审计字段一致”打磨到发布级，本故事应沿用同一质量标准。
- 近期实现已固定 Problem Details、`request_id`、`upstream_error_code`、幂等行为；3.7 不得破坏这些公共契约。
- 3.3/3.4/3.6 的改动轨迹显示：`auth.store.mysql.js` + `platform.org.service.js` + 对应测试是治理类故事主路径，应优先在既有模块扩展。

### Git Intelligence Summary（最近 5 次提交模式）

- 最近 5 次提交持续聚焦租户治理域：成员生命周期、角色治理、成员角色绑定、负责人并发。
- 高频变更文件稳定集中于：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 模式结论：先收敛领域语义与事务边界，再补契约与门禁测试；本故事沿用该顺序风险最低。

### Latest Tech Information（外部最新信息）

- Node.js 当前 LTS 线为 `v24.13.1 (Krypton)`，与当前工程 `>=24` 约束兼容。
- MySQL 8.4 LTS 版本线最新发布包含 `8.4.8`（2026-01-20）。
- MySQL `GET_LOCK(name, timeout)` 语义保持：成功 `1`、超时 `0`、错误 `NULL`；锁为会话级，不随事务自动释放。
- 结合当前工程依赖现状，建议 3.7 以业务一致性实现为主，避免在同一故事内混入非必要大版本变更。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文以以下文档为准：`epics.md`、`prd.md`、`architecture.md`、`ux-design-specification.md`、`3-6` 故事文档。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review follow-ups fixed and verified with targeted test suites + lint`

### References

- 用户故事与验收条件：`_bmad-output/planning-artifacts/epics.md`（Epic 3 / Story 3.7）
- FR 与发布门禁：`_bmad-output/planning-artifacts/prd.md`（FR77, FR79, 删除级联一致性）
- 架构边界与错误契约：`_bmad-output/planning-artifacts/architecture.md`
- 交互与反馈一致性：`_bmad-output/planning-artifacts/ux-design-specification.md`
- 上一故事经验：`_bmad-output/implementation-artifacts/3-6-负责人变更并发冲突与安全重试.md`
- 现有实现落点：
  - `apps/api/src/modules/platform/org.service.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/openapi.js`
- 外部技术来源：
  - Node.js dist index：`https://nodejs.org/dist/index.json`
  - MySQL 8.4 Release Notes：`https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`
  - MySQL Locking Functions：`https://dev.mysql.com/doc/refman/8.4/en/locking-functions.html`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js --test-name-pattern "updateOrganizationStatus"`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js --test-name-pattern "updateOrganizationStatus"`
- `pnpm --dir apps/api exec node --test test/platform.org.api.test.js --test-name-pattern "POST /platform/orgs/status"`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`

### Completion Notes List

- 已在 `auth.store.mysql.updateOrganizationStatus` 完成软删除级联：`memberships`、`auth_user_tenants`、`platform_role_catalog(scope=tenant)`、`auth_tenant_membership_roles` 与租户会话/refresh 收敛。
- 已在 `auth.store.memory.updateOrganizationStatus` 对齐同语义级联，防止 memory/mysql 漂移。
- 已在 `auth.service` 与 `platform/org.service` 增加级联统计审计字段，并保持 `ORG-* + request_id + upstream_error_code` 契约。
- 已完成相关门禁回归并通过全量 `apps/api` 测试与 lint。
- CR 修复：`platform/org.service` 对级联统计字段改为严格依赖校验，遇到异常值返回 `ORG-503-DEPENDENCY-UNAVAILABLE` 并审计 `upstream_error_code`。
- CR 修复：`auth.store.mysql|memory.updateOrganizationStatus` 的 `affected_membership_count` 改为仅统计实际成员关系失效用户，owner 仅用于会话撤销集合。
- CR 修复：`auth.store.mysql.updateOrganizationStatus` 失效 tenant 角色时写入 `updated_by_user_id`。
- 新增并通过回归测试：`test/platform.org.api.test.js`（malformed cascade count fail-closed）与 `test/auth.store.mysql.test.js`（owner 不计入成员计数口径、角色失效更新人字段）。

### File List

- `_bmad-output/implementation-artifacts/3-7-组织软删除级联一致性.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/platform/org.service.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/platform.org.api.test.js`

## Change Log

- 2026-02-20：创建 Story 3.7 上下文文档并标记 `ready-for-dev`，完成级联一致性实现护栏、测试矩阵与参考资料汇总。
- 2026-02-20：完成组织软删除级联实现与双后端一致性改造；补齐审计统计字段与 fail-closed 行为；相关测试与 lint 全通过，状态更新为 `review`。
- 2026-02-20：执行 CR 自动续跑并完成修复：补齐 MySQL 角色失效 `updated_by_user_id`、修正 `affected_membership_count` 口径、平台层级联计数改为严格校验 fail-closed；新增回归测试并通过，状态更新为 `done`。
