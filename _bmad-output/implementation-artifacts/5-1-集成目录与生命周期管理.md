# Story 5.1: 集成目录与生命周期管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 授权操作者,  
I want 维护外部集成目录与生命周期状态,  
so that 外部系统接入可管理、可审计、可演进。

## Acceptance Criteria

1. **Given** 授权操作者创建或更新集成配置  
   **When** 提交方向、协议、鉴权与策略信息  
   **Then** 系统保存集成规格  
   **And** 配置变更进入审计记录
2. **Given** 操作者切换集成生命周期状态  
   **When** 状态流转请求合法  
   **Then** 系统完成状态更新  
   **And** 状态变化对调用策略即时生效

## Tasks / Subtasks

- [x] 任务 1：落地集成目录数据模型与生命周期状态机（AC: 1, 2）
  - [x] 新增迁移 `apps/api/migrations/0021_platform_integration_catalog.sql`（及 down）：创建 `platform_integration_catalog`（目录主表）。
  - [x] 字段至少覆盖：`integration_id`、`code/code_normalized`、`name`、`direction`、`protocol`、`auth_mode`、`endpoint/base_url`、`timeout_ms`、`retry_policy`、`idempotency_policy`、`version_strategy`、`runbook_url`、`lifecycle_status`、`lifecycle_reason`、`created_by_user_id`、`updated_by_user_id`、`created_at`、`updated_at`。
  - [x] 状态机定义并固化（建议）：`draft -> active|retired`，`active -> paused|retired`，`paused -> active|retired`，`retired` 终态。
  - [x] “即时生效”语义固化：`active` 之外状态统一视为不可调用（为 Story 5.2/5.4 复用）。

- [x] 任务 2：实现 store 层（MySQL + in-memory）并保持语义一致（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.store.mysql.js` 新增目录 CRUD 与生命周期变更方法（严格参数校验 + 事务）。
  - [x] 在 `apps/api/src/modules/auth/auth.store.memory.js` 实现同名同语义方法，避免本地与持久化行为漂移。
  - [x] 唯一性约束（`code_normalized`）冲突映射到 409，依赖异常映射到 fail-closed 503。
  - [x] 生命周期变更返回统一结果字段：`previous_status`、`current_status`、`effective_invocation_enabled`。

- [x] 任务 3：实现平台治理 API（AC: 1, 2）
  - [x] 新增 `apps/api/src/modules/platform/integration.constants.js`、`apps/api/src/modules/platform/integration.routes.js`、`apps/api/src/modules/platform/integration.service.js`。
  - [x] 建议接口：
    - `GET /platform/integrations`（列表/筛选）
    - `GET /platform/integrations/:integration_id`（详情）
    - `POST /platform/integrations`（创建）
    - `PATCH /platform/integrations/:integration_id`（更新规格）
    - `POST /platform/integrations/:integration_id/lifecycle`（状态流转）
  - [x] 所有 payload 使用“白名单字段 + 严格字符串 + 控制字符拒绝 + 枚举约束”策略，沿用现有平台模块风格。

- [x] 任务 4：接线路由、权限声明与幂等保护（AC: 1, 2）
  - [x] 在 `apps/api/src/http-routes.js` 注入 integration handler/service，与现有 platform 模块保持同构接线。
  - [x] 在 `apps/api/src/server.js` 路由表新增上述接口分发，并将写接口纳入 `IDEMPOTENCY_PROTECTED_ROUTE_KEYS`。
  - [x] 在 `apps/api/src/route-permissions.js` 声明所有受保护路由（建议：读接口 `platform.member_admin.view`，写接口 `platform.member_admin.operate`）。
  - [x] 执行并通过 `check:route-permissions`，保证 FR72（受保护接口权限声明）不回归。

- [x] 任务 5：补齐 OpenAPI 契约与错误码（AC: 1, 2）
  - [x] 在 `apps/api/src/openapi.js` 新增 path/schema/examples，覆盖目录字段、生命周期请求体、分页筛选与错误示例。
  - [x] 新增/复用错误码并保持 Problem Details 一致结构：`error_code`、`request_id`、`traceparent`、`retryable`。
  - [x] 典型错误覆盖：参数非法（400）、资源不存在（404）、状态流转冲突（409）、依赖降级（503）。

- [x] 任务 6：审计与追踪闭环（AC: 1, 2）
  - [x] 通过 `auth.service.recordAuditEvent`（或等价入口）记录 `platform.integration.created/updated/lifecycle_changed`。
  - [x] 审计字段至少包含：`request_id`、`traceparent`、`actor_user_id`、`actor_session_id`、`target_type`、`target_id`、`before_state`、`after_state`。
  - [x] 确保 `GET /platform/audit/events` 可按 `request_id/traceparent` 查询到本故事关键写操作（复用 Story 4.2 能力）。

- [x] 任务 7：测试与门禁（AC: 1, 2）
  - [x] 新增 `apps/api/test/platform.integration.api.test.js`：覆盖创建、更新、详情、列表、合法/非法状态流转、幂等重放。
  - [x] 扩展 `apps/api/test/auth.store.mysql.test.js` 与（必要时）`apps/api/test/auth.service.test.js`：覆盖唯一冲突、事务回滚、fail-closed。
  - [x] 扩展 `apps/api/test/route-permissions.test.js`、`apps/api/test/http-routes.test.js`、`apps/api/test/migrate-baseline.test.js`：覆盖路由声明、分发与迁移基线。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 为 `integration_id` 增加 `<=64` 的严格校验，修复 API/契约不一致（可提交 65 长度标识）问题。[`apps/api/src/modules/platform/integration.service.js:502`]
- [x] [AI-Review][HIGH] 为 MySQL 与 in-memory store 增加 `integrationId` 长度 fail-closed，避免双后端语义漂移。[`apps/api/src/modules/auth/auth.store.mysql.js:3181`]
- [x] [AI-Review][MEDIUM] 生命周期变更响应增加 `previous_status/current_status/effective_invocation_enabled` 严格校验，依赖返回畸形数据时改为 503 fail-closed。[`apps/api/src/modules/platform/integration.service.js:1289`]
- [x] [AI-Review][MEDIUM] MySQL 读取 `timeout_ms=0` 改为 fail-closed（与 `timeout_ms >= 1` 契约一致）。[`apps/api/src/modules/auth/auth.store.mysql.js:423`]
- [x] [AI-Review][HIGH] MySQL `find/list` 读取路径对畸形目录行存在“返回 null/静默过滤”行为，可能误报 404 或吞掉坏数据；已改为抛错并统一走 503 fail-closed。[`apps/api/src/modules/auth/auth.store.mysql.js:3158`]
- [x] [AI-Review][MEDIUM] store 层对 `code/name/protocol/auth_mode/endpoint/base_url/version_strategy/runbook_url/lifecycle_reason` 缺少长度上限约束，存在与 OpenAPI/DDL 契约漂移风险；已在 MySQL + memory 补齐严格校验。[`apps/api/src/modules/auth/auth.store.mysql.js:3266`, `apps/api/src/modules/auth/auth.store.memory.js:503`]
- [x] [AI-Review][MEDIUM] `GET /platform/integrations` 的 `protocol/auth_mode/keyword` 长度上限未按契约校验；已补齐并新增回归测试。[`apps/api/src/modules/platform/integration.service.js:451`, `apps/api/test/platform.integration.api.test.js`]
- [x] [AI-Review][MEDIUM] `GET /platform/integrations` 对 `page_size > 100` 曾执行静默截断，和契约“非法参数应 400”不一致；已改为严格拒绝并新增回归测试。[`apps/api/src/modules/platform/integration.service.js:429`, `apps/api/test/platform.integration.api.test.js:436`]
- [x] [AI-Review][MEDIUM] MySQL store 对目录读取结果“非数组”场景未统一 fail-closed；已在 `list/find/update/lifecycle` 读取路径补齐形态校验并抛错，避免畸形依赖响应穿透到业务层。[`apps/api/src/modules/auth/auth.store.mysql.js:3158`, `apps/api/src/modules/auth/auth.store.mysql.js:3203`, `apps/api/src/modules/auth/auth.store.mysql.js:3537`, `apps/api/src/modules/auth/auth.store.mysql.js:3839`, `apps/api/test/auth.store.mysql.test.js:6760`]
- [x] [AI-Review][MEDIUM] MySQL 列表检索 `keyword` 未转义 `%/_/\\`，会放大匹配范围并与 in-memory 子串语义漂移；已补齐 LIKE 转义并统一 `LOWER(name)` 比较路径。[`apps/api/src/modules/auth/auth.store.mysql.js:186`, `apps/api/src/modules/auth/auth.store.mysql.js:3124`, `apps/api/test/auth.store.mysql.test.js:6910`]
- [x] [AI-Review][MEDIUM] 服务层对 store 返回 `created_at/updated_at` 缺少严格校验，异常时间可穿透响应；已改为 fail-closed 503 并新增回归测试。[`apps/api/src/modules/platform/integration.service.js:143`, `apps/api/src/modules/platform/integration.service.js:391`, `apps/api/test/platform.integration.api.test.js:548`]
- [x] [AI-Review][MEDIUM] 服务层 `mapIntegrationRecord` 对返回字段长度/控制字符校验不足，可能突破 OpenAPI 契约；已补齐严格校验并新增回归测试。[`apps/api/src/modules/platform/integration.service.js:312`, `apps/api/test/platform.integration.api.test.js:596`]
- [x] [AI-Review][MEDIUM] 生命周期响应对 `effective_invocation_enabled` 与 `current_status/lifecycle_status` 一致性校验不足，显式返回值可与状态机语义冲突；已补齐冲突判定并 fail-closed 503。[`apps/api/src/modules/platform/integration.service.js:1410`, `apps/api/test/platform.integration.api.test.js:548`]

## Dev Notes

### Developer Context（开发者先读）

- 当前仓库尚未存在 `modules/integration` 业务实现目录；平台治理 API 一侧建议先按既有模式落在 `modules/platform/*`，避免一次性跨层重构。
- Story 4.2 已完成 `request_id/traceparent` 全链路能力（含 `common/trace-context.js`），本故事必须复用，禁止再造追踪字段。
- Story 4.6 已形成发布门禁分组报告与证据绑定机制；本故事新增门禁必须可归档、可阻断。
- Story 4.7 的经验仍适用：失败语义必须 fail-closed，且 MySQL 与 in-memory 行为一致。

### Story Foundation（来自 Epic 5 全局上下文）

- Epic 5 目标：外部集成全生命周期治理（目录、契约版本、变更校验、失败恢复、冻结门禁）。
- Story 5.1 是 Epic 5 起点，产出“可管理目录 + 生命周期状态”基础事实源，供 5.2~5.5 复用。
- 后续故事边界（避免越界）：
  - 5.2：版本化契约交互与兼容管理。
  - 5.3：变更前契约一致性校验。
  - 5.4：失败重试/恢复/再处理闭环。
  - 5.5：冻结/解冻与门禁分组报告。

### Technical Requirements（硬约束）

- 直接覆盖：`FR36`、`FR37`、`FR55`。
- 强关联：`FR44`（追踪关联）、`FR72`（权限声明）、`FR80`（错误语义一致性）。
- NFR 对齐：`NFR13`~`NFR17`（集成治理基线）与 `NFR15`（`request_id/traceparent`）。
- 集成规格字段必须覆盖 PRD“集成规格模板”核心项：方向、协议、鉴权、超时、重试、幂等、版本策略、runbook。
- 本故事不实现真实外部调用执行器（outbound/inbound runtime），但必须提供“状态可判定可调用”的同步语义（`effective_invocation_enabled`）。

### Architecture Compliance（架构对齐清单）

- API 风格与契约：REST + OpenAPI + Problem Details（与 `architecture.md` 一致）。
- 模块边界：平台治理入口在 `modules/platform`；鉴权、审计与持久化复用 `auth.service` / `auth.store.*` 既有边界。
- 追踪字段：所有写接口和审计事件必须贯穿 `request_id` + `traceparent`（复用 `trace-context`）。
- 权限声明：每个受保护接口必须在 `route-permissions.js` 声明，否则阻断。
- 迁移规则：仅通过 `apps/api/migrations/*` + `migrate-baseline` 管理 schema，禁止手工改库。

### Library & Framework Requirements（版本核验）

- 当前仓库（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新核验（2026-02-22）：
  - Node.js Latest LTS：`v24.13.1`（Krypton），Latest Current：`v25.6.1`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS 最新检测：`8.4.8`
- 本故事建议：不做依赖升级，优先交付集成目录与生命周期治理主线；升级可拆独立维护任务。

### File Structure Requirements（建议变更落点）

- 新增：
  - `apps/api/src/modules/platform/integration.constants.js`
  - `apps/api/src/modules/platform/integration.routes.js`
  - `apps/api/src/modules/platform/integration.service.js`
  - `apps/api/migrations/0021_platform_integration_catalog.sql`
  - `apps/api/migrations/0021_platform_integration_catalog.down.sql`
  - `apps/api/test/platform.integration.api.test.js`
- 修改：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（必须覆盖）

- AC1（规格维护）：
  - 创建/更新目录成功路径与字段白名单校验。
  - 方向/协议/鉴权/策略字段非法输入 fail-closed（400）。
  - `code_normalized` 冲突返回稳定 409。
- AC2（生命周期）：
  - 合法状态流转成功，返回 `previous_status/current_status/effective_invocation_enabled`。
  - 非法流转（含终态继续流转）返回稳定 409。
  - 生命周期变更后“可调用标识”即时变化可观测。
- 审计追踪：
  - 审计记录可按 `request_id` / `traceparent` 查询。
  - `before_state` / `after_state` 完整，便于回放与追责。
- 门禁：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence（跨 Epic 复用）

- 来自 `4-2`：trace 上下文必须沿 `server -> http-routes -> service -> store/audit` 透传，避免“日志与审计断链”。
- 来自 `4-6`：证据必须与本次运行绑定，测试报告缺失/陈旧要 fail-closed。
- 来自 `4-7`：状态变更与撤销类写路径必须优先保证事务一致 + 幂等语义稳定。

### Git Intelligence Summary（最近提交模式）

- 最近提交集中在 `auth.service`、`auth.store.mysql`、`platform/*`、`openapi.js`、`apps/api/test/*`。
- 推荐实施顺序：
  1. 先落地 migration + store 语义；
  2. 再接平台 service/routes + server/route-permissions；
  3. 最后补 OpenAPI 与全量回归。

### Latest Tech Information（外部核验）

- Node 官方发行索引（2026-02-22 查询）：LTS `v24.13.1`、Current `v25.6.1`。
- npm Registry（2026-02-22 查询）：
  - `@nestjs/core@11.1.14`
  - `typeorm@0.3.28`
  - `mysql2@3.17.4`
  - `ioredis@5.9.3`
- MySQL 官方 8.4 Release Notes：最新检测 `8.4.8`。

### Project Context Reference

- 未发现 `**/project-context.md`（空匹配）。
- 本故事上下文主要来源：
  - `_bmad-output/planning-artifacts/epics.md`（Epic 5 / Story 5.1）
  - `_bmad-output/planning-artifacts/prd.md`（Integration Requirements、FR36/37/55、NFR13-17）
  - `_bmad-output/planning-artifacts/architecture.md`（集成模式、模块边界、追踪与契约门禁）
  - `_bmad-output/planning-artifacts/ux-design-specification.md`（反馈一致性与操作防重）
  - `_bmad-output/implementation-artifacts/4-2-请求追踪关联与跨链路可观测.md`
  - `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
  - `_bmad-output/implementation-artifacts/4-7-用户软删除会话撤销.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`已完成代码审查、问题修复与全量门禁回归，AC1/AC2 均已验证通过。`

### References

- `_bmad-output/planning-artifacts/epics.md`（`Epic 5` / `Story 5.1`）
- `_bmad-output/planning-artifacts/prd.md`（`Integration Requirements`、`FR36/FR37/FR55`、`NFR13-NFR17`）
- `_bmad-output/planning-artifacts/architecture.md`（`Integration pattern`、`Project Structure & Boundaries`、`PR Quality Gates`）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（`列表工作台 + Modal/Drawer + 统一反馈`）
- `_bmad-output/implementation-artifacts/4-2-请求追踪关联与跨链路可观测.md`
- `_bmad-output/implementation-artifacts/4-6-发布前回归门禁分组报告.md`
- `_bmad-output/implementation-artifacts/4-7-用户软删除会话撤销.md`
- `apps/api/src/modules/platform/system-config.service.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/platform/user.service.js`
- `apps/api/src/server.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/common/trace-context.js`
- `https://nodejs.org/download/release/index.json`
- `https://registry.npmjs.org/@nestjs/core`
- `https://registry.npmjs.org/typeorm`
- `https://registry.npmjs.org/mysql2`
- `https://registry.npmjs.org/ioredis`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`

## Senior Developer Review (AI)

### Outcome

- 决议：`Approve`（已完成修复后复检）
- Git vs Story Discrepancies：`0`
- Findings（修复前）：`3 High / 10 Medium / 0 Low`

### Findings（已修复）

1. HIGH：创建接口允许 `integration_id` 超过 64，违背 OpenAPI/DDL 契约并导致后端语义不一致。已修复并补测。(`apps/api/src/modules/platform/integration.service.js:502`, `apps/api/test/platform.integration.api.test.js`)
2. HIGH：store 层未统一约束 `integrationId` 长度，memory 与 mysql 存在潜在漂移。已在双 store 增加 fail-closed。(`apps/api/src/modules/auth/auth.store.mysql.js:168`, `apps/api/src/modules/auth/auth.store.memory.js:312`)
3. MEDIUM：生命周期响应对 `previous_status/current_status` 缺少有效性校验，依赖返回异常元数据时仍可能 200。已改为 fail-closed 503。(`apps/api/src/modules/platform/integration.service.js:1289`, `apps/api/test/platform.integration.api.test.js`)
4. MEDIUM：MySQL 读取层对 `timeout_ms=0` 未 fail-closed，与 API 输入约束不一致。已修复并补测。(`apps/api/src/modules/auth/auth.store.mysql.js:423`, `apps/api/test/auth.store.mysql.test.js`)
5. HIGH：MySQL 目录读取路径在畸形行场景会“返回 null/静默过滤”，导致 API 误报 404 或隐藏坏数据。已改为抛错并统一映射 503 fail-closed。(`apps/api/src/modules/auth/auth.store.mysql.js:3158`, `apps/api/src/modules/auth/auth.store.mysql.js:3201`)
6. MEDIUM：store 层除 `integrationId` 外缺少字段长度上限约束，存在与 OpenAPI/DDL 契约漂移风险。已在 MySQL + memory 增加完整长度校验。(`apps/api/src/modules/auth/auth.store.mysql.js:3266`, `apps/api/src/modules/auth/auth.store.memory.js:503`)
7. MEDIUM：列表筛选 `protocol/auth_mode/keyword` 未按契约校验最大长度，过长输入未被 400 拒绝。已补齐校验并新增 API 回归。(`apps/api/src/modules/platform/integration.service.js:451`, `apps/api/test/platform.integration.api.test.js:411`)
8. MEDIUM：列表筛选 `page_size > 100` 先前被静默截断为 100，违反契约“非法参数即 400”的 fail-closed 语义。已改为严格拒绝并补齐回归。(`apps/api/src/modules/platform/integration.service.js:429`, `apps/api/test/platform.integration.api.test.js:436`)
9. MEDIUM：MySQL store 在目录读取 query 返回“非数组”时校验不完整，可能把依赖畸形结果延迟为非预期异常。已在 `list/find/update/lifecycle` 读取路径统一 fail-closed。(`apps/api/src/modules/auth/auth.store.mysql.js:3158`, `apps/api/src/modules/auth/auth.store.mysql.js:3203`, `apps/api/src/modules/auth/auth.store.mysql.js:3537`, `apps/api/src/modules/auth/auth.store.mysql.js:3839`, `apps/api/test/auth.store.mysql.test.js:6760`)
10. MEDIUM：MySQL 目录列表 `keyword` 直接拼接 LIKE 模式，未转义 `%/_/\\`，会把“字面查询”误扩成通配匹配并与 in-memory 语义漂移。已增加 SQL LIKE 转义并统一 `LOWER(name)` 比较。(`apps/api/src/modules/auth/auth.store.mysql.js:186`, `apps/api/src/modules/auth/auth.store.mysql.js:3124`, `apps/api/test/auth.store.mysql.test.js:6910`)
11. MEDIUM：服务层对目录记录时间戳转换过于宽松，异常时间值可进入 API 响应，不满足 fail-closed。已改为严格 ISO 校验，异常即 503。(`apps/api/src/modules/platform/integration.service.js:143`, `apps/api/src/modules/platform/integration.service.js:391`, `apps/api/test/platform.integration.api.test.js:548`)
12. MEDIUM：服务层目录映射对上游返回字段（长度、控制字符、可选字段形态）校验不足，存在契约越界风险。已在 `mapIntegrationRecord` 增加全量约束并补测。(`apps/api/src/modules/platform/integration.service.js:312`, `apps/api/test/platform.integration.api.test.js:596`)
13. MEDIUM：生命周期响应对 `effective_invocation_enabled` 的显式值未验证与 `current_status/lifecycle_status` 一致，可能返回“状态已暂停但仍可调用”的矛盾结果。已补齐一致性校验并在冲突时 fail-closed 503。(`apps/api/src/modules/platform/integration.service.js:1410`, `apps/api/test/platform.integration.api.test.js:548`)

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `git status --short`
- `cat _bmad/bmm/config.yaml`
- `cat _bmad/bmm/workflows/4-implementation/dev-story/workflow.yaml`
- `cat _bmad/bmm/workflows/4-implementation/dev-story/instructions.xml`
- `cat _bmad-output/implementation-artifacts/sprint-status.yaml`
- `sed -n '1,260p' _bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
- `sed -n '1,260p' apps/api/migrations/0021_platform_integration_catalog.sql`
- `sed -n '1,260p' apps/api/migrations/0021_platform_integration_catalog.down.sql`
- `sed -n '1,360p' apps/api/src/modules/platform/integration.service.js`
- `sed -n '1,280p' apps/api/src/http-routes.js`
- `sed -n '1,280p' apps/api/src/server.js`
- `sed -n '1,280p' apps/api/src/route-permissions.js`
- `sed -n '1,360p' apps/api/src/openapi.js`
- `sed -n '1,320p' apps/api/test/migrate-baseline.test.js`
- `sed -n '1,360p' apps/api/test/http-routes.test.js`
- `sed -n '1,380p' apps/api/test/route-permissions.test.js`
- `node --test --test-force-exit test/http-routes.test.js`
- `node --test --test-force-exit test/auth.store.mysql.test.js`
- `node --test --test-force-exit test/platform.integration.api.test.js`
- `node --test --test-force-exit test/route-permissions.test.js`
- `node --test --test-force-exit test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 已新增迁移 `0021_platform_integration_catalog`（含 down），落地目录主表、唯一键与生命周期查询索引。
- 已在 `auth.store.mysql.js` 与 `auth.store.memory.js` 实现目录 CRUD、生命周期状态机、冲突映射与 `effective_invocation_enabled` 返回。
- 已新增平台治理模块：`integration.constants.js`、`integration.routes.js`、`integration.service.js`，实现白名单 payload 校验、Problem Details 映射与权限校验。
- 已完成接线：`http-routes.js`、`server.js`、`route-permissions.js`，并将写接口纳入幂等保护。
- 已补充 OpenAPI：新增 `/platform/integrations*` 路径、请求/响应 schema、分页筛选参数及 400/404/409/503 错误示例。
- 已新增/扩展测试：
  - 新增 `apps/api/test/platform.integration.api.test.js`（创建/更新/详情/列表/合法非法流转/幂等重放/审计追踪）。
  - 扩展 `apps/api/test/auth.store.mysql.test.js`（目录创建、唯一冲突、生命周期冲突、审计写失败 fail-closed）。
  - 扩展 `apps/api/test/http-routes.test.js`、`apps/api/test/route-permissions.test.js`、`apps/api/test/migrate-baseline.test.js`。
- 已完成审查修复：
  - 拒绝超长 `integration_id`（API + store 双层约束）。
  - 生命周期响应 metadata 严格校验并 fail-closed。
  - MySQL 读取 `timeout_ms=0` fail-closed 与契约对齐。
  - MySQL 目录读取遇畸形行由“null/过滤”改为抛错，统一 503 fail-closed。
  - store 层补齐目录字段长度上限约束（MySQL + in-memory 一致）。
  - 列表筛选 `protocol/auth_mode/keyword` 补齐长度上限校验并新增用例。
  - 列表筛选 `page_size` 改为严格上限校验（`>100` 直接 400，不再静默截断）。
  - MySQL 目录读取路径补齐“query 结果非数组” fail-closed（`list/find/update/lifecycle` 一致）。
  - MySQL 列表 `keyword` 检索补齐 LIKE 转义（`%/_/\\`）并统一 `LOWER(name)` 比较，消除 wildcard 放大与后端语义漂移。
  - 服务层目录映射补齐 `created_at/updated_at` 严格 ISO 校验，异常时间字段统一 fail-closed 503。
  - 服务层目录映射补齐长度与控制字符校验（含 code/name/protocol/auth_mode/可选字符串），防止 store 畸形数据穿透 API 契约。
  - 生命周期响应补齐 `effective_invocation_enabled` 与状态机一致性校验，显式冲突时统一 fail-closed 503。
- 门禁执行结果：
  - `pnpm --dir apps/api check:route-permissions` ✅
  - `pnpm --dir apps/api lint` ✅
  - `pnpm --dir apps/api test` ✅（1113 passed, 0 failed）

### File List

- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
- `apps/api/migrations/0021_platform_integration_catalog.sql`
- `apps/api/migrations/0021_platform_integration_catalog.down.sql`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/platform/integration.constants.js`
- `apps/api/src/modules/platform/integration.routes.js`
- `apps/api/src/modules/platform/integration.service.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.integration.api.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/migrate-baseline.test.js`

## Change Log

- 2026-02-22：完成 Story 5.1 集成目录与生命周期治理实现，补齐 OpenAPI 契约与测试，门禁全通过并转入 `review`。
- 2026-02-22：完成 CR 自动审查与修复（4 项问题已闭环），补充 fail-closed 回归用例后门禁全通过，状态更新为 `done`。
- 2026-02-22：继续 5-1 审查并完成第二轮修复（新增 1 High + 2 Medium 已闭环），补齐 store 长度约束、读取路径 fail-closed 与列表筛选长度校验，门禁复跑全通过（1107 passed）。
- 2026-02-22：继续 5-1 审查并完成第三轮修复（新增 2 Medium 已闭环），补齐 `page_size` 严格上限拒绝与 MySQL 非数组结果 fail-closed，门禁复跑全通过（1109 passed）。
- 2026-02-22：继续 5-1 审查并完成第四轮修复（新增 3 Medium 已闭环），补齐 MySQL `keyword` LIKE 转义、服务层时间戳严格校验与返回字段契约校验，门禁复跑全通过（1112 passed）。
- 2026-02-22：继续 5-1 审查并完成第五轮修复（新增 1 Medium 已闭环），补齐生命周期响应 `effective_invocation_enabled` 与状态一致性 fail-closed 校验并新增回归测试，门禁复跑全通过（1113 passed）。
