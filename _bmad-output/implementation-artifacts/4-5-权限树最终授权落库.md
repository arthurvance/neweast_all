# Story 4.5: 权限树最终授权落库

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 权限治理操作者,  
I want 权限树保存时仅持久化最终授权结果,  
so that 权限数据结构简洁且与判定逻辑一致。

## Acceptance Criteria

1. **Given** 管理员在权限树上进行父子节点联动操作  
   **When** 保存权限配置  
   **Then** 系统仅保存最终授权权限点  
   **And** 不持久化冗余中间态节点
2. **Given** 保存后重新加载权限树  
   **When** 前端展示权限配置  
   **Then** 可正确还原授权状态  
   **And** 展示行为与落库数据一致

## Tasks / Subtasks

- [x] 任务 1：固化“仅最终授权结果”输入与归一化策略（AC: 1）
  - [x] 在 `platformRole.replaceRolePermissions` 与 `tenantRole.replaceRolePermissions` 路径统一执行严格归一化：仅接受 `platform.*` / `tenant.*` 权限码、去重、排序、大小写无关比较。
  - [x] 明确拒绝权限树中间态节点标识（非合法权限码）进入写链路，保持 `400 invalid payload` 语义稳定。
  - [x] 保证写入前后对比使用规范化后的权限码集合，禁止“输入看似成功但服务端持久化集合漂移”。

- [x] 任务 2：后端落库仅保留最终授权点（AC: 1）
  - [x] 平台域：确保 `platform_role_permission_grants` 仅存最终授权权限码，不新增中间节点字段/记录。
  - [x] 组织域：确保 `tenant_role_permission_grants` 仅存最终授权权限码，不新增中间节点字段/记录。
  - [x] 若发现历史脏数据（重复、未知码、非规范码），提供一次性修复脚本或迁移并纳入发布说明。

- [x] 任务 3：读链路可重建权限树展示状态（AC: 2）
  - [x] `GET /platform/roles/{role_id}/permissions` 与 `GET /tenant/roles/{role_id}/permissions` 返回的 `permission_codes` 必须可直接映射为树的最终选中节点。
  - [x] `available_permission_codes` 仅来自当前权限目录基线，用于前端重建父子联动展示，不把中间态写入数据库。
  - [x] 前端（若在本迭代实现）按“目录 + 已授权最终节点”重建 checked/half-checked，保证刷新后表现一致。

- [x] 任务 4：权限快照与会话收敛保持一致（AC: 2）
  - [x] 权限写入后继续执行受影响用户/成员快照同步，确保下一次受保护请求按最新授权判定。
  - [x] 平台域与组织域都保持 fail-closed：下游返回异常/结构脏载荷时拒绝放行，不输出“看似成功”的写结果。
  - [x] 会话失效策略保持现有规则，不引入跨域误撤销。

- [x] 任务 5：契约、审计、门禁一致性（AC: 1, 2）
  - [x] OpenAPI 明确 `permission_codes` 语义为“最终授权权限点集合”，并补充父子联动保存/回读示例。
  - [x] 审计事件 `auth.platform_role_permission_grants.updated` / `auth.tenant_role_permission_grants.updated` 保留 before/after 权限集。
  - [x] 保持 `route-permissions` 声明覆盖完整；任何新增保护路由需通过 `check:route-permissions`。

- [x] 任务 6：测试与发布门禁（AC: 1, 2）
  - [x] API 回归：保存包含重复/大小写差异输入时，返回与落库均为规范化后的最终授权集合。
  - [x] API 回归：保存后立即读取，`permission_codes` 与展示所需状态一致。
  - [x] 负向回归：未知权限码、跨域权限码、脏载荷均被拒绝且错误码稳定。
  - [x] Store 回归：MySQL 与 memory store 在“仅存最终授权码”语义一致。
  - [x] 门禁必过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

- [x] Review Follow-ups (AI)
  - [x] [AI-Review][HIGH] 平台域 `PUT /platform/roles/:role_id/permissions` 在权限目录返回畸形载荷时必须写前 fail-closed，禁止任何写操作。[`apps/api/src/modules/platform/role.service.js:968`]
  - [x] [AI-Review][HIGH] 组织域 `PUT /tenant/roles/:role_id/permissions` 在权限目录返回畸形载荷时必须写前 fail-closed，禁止任何写操作。[`apps/api/src/modules/tenant/role.service.js:1707`]
  - [x] [AI-Review][MEDIUM] 迁移 `0020` 清洗时保留 `created_by_user_id` / `updated_by_user_id` 审计溯源字段。[`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:21`]
  - [x] [AI-Review][MEDIUM] 重复/大小写差异权限码应执行归一化去重而非直接拒绝，保持“最终授权结果”输入语义一致。[`apps/api/src/modules/platform/role.service.js:378`]
  - [x] [AI-Review][HIGH] 平台域授权 grant 读取链路不得静默过滤脏数据（无效/重复/越界 role 行），应与组织域一致 fail-closed，避免脏载荷被“清洗后放行”。[`apps/api/src/modules/auth/auth.store.mysql.js:2795`]
  - [x] [AI-Review][MEDIUM] grant 读取链路中 `role_id` 大小写漂移（如大写脏行）不得静默归一化，应 fail-closed 拒绝，避免非规范主键数据被掩盖。[`apps/api/src/modules/auth/auth.store.mysql.js:692`]
  - [x] [AI-Review][HIGH] `auth.service` 平台 grant 聚合读取不得忽略“请求外 role_id”与大写 `role_id` 漂移，需在服务层 fail-closed，避免非 MySQL 实现/桩载荷被静默吞掉。[`apps/api/src/modules/auth/auth.service.js:3670`]
  - [x] [AI-Review][HIGH] `auth.service` 平台/组织 grant 聚合读取不得对重复或大写权限码静默去重，需按脏载荷处理并拒绝。[`apps/api/src/modules/auth/auth.service.js:3702`]
  - [x] [AI-Review][MEDIUM] `listTenantMemberRoleBindings` 角色 ID 归一化不得接受大写脏值，需拒绝 case-drift 并返回依赖不可用。[`apps/api/src/modules/auth/auth.service.js:7361`]
  - [x] [AI-Review][HIGH] 迁移 `0020` 清洗在临时归一化结果为空时不得执行全表清空；改为 `EXISTS` 守护删除 + `ON DUPLICATE KEY UPDATE`，避免极端脏数据场景的误清空风险。[`apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql:61`]
  - [x] [AI-Review][MEDIUM] 平台域权限读/写接口返回应在服务层最终排序，避免依赖层返回顺序漂移导致响应不稳定。[`apps/api/src/modules/platform/role.service.js:878`]
  - [x] [AI-Review][MEDIUM] 组织域权限读/写接口返回应在服务层最终排序，避免依赖层返回顺序漂移导致响应不稳定。[`apps/api/src/modules/tenant/role.service.js:1615`]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 4.4 已完成“受保护角色约束 + 角色禁用即时失效”的防线；4.5 重点是权限树保存语义本身：**只存最终授权码，不存中间态**。
- 本仓当前 API 已采用 `permission_codes` + `available_permission_codes` 双字段模型，4.5 需要把这套模型固化为不可歧义的“存储/读取契约”。
- 当前 `apps/web` 尚未形成完整业务页面与权限树实现，故 4.5 主战场在 API 与契约；若补前端应遵循既有 UX 规则（Modal/Drawer/message/loading 防重）。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR74`（权限树仅保留最终授权结果）。
- 强相关：`FR49`、`FR50`、`FR72`、`FR73`、`FR75`、`FR80`。
- 关键 NFR：`NFR6`（域隔离）、`NFR7`（受保护接口声明覆盖）、`NFR22`（验证证据归档）。

### Architecture Compliance（架构对齐清单）

- 统一遵循 Problem Details 错误结构，禁止新增第二套错误返回语义。
- 平台域与组织域权限码命名空间强隔离，禁止跨域权限码混入写链路。
- 鉴权入口继续走 `route-permissions` 与统一授权路径，禁止 controller 私有绕过。
- 权限变更后的快照同步与会话收敛不能回退，保持 fail-closed。

### Library & Framework Requirements（库与框架要求）

- 仓库当前（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新 registry 核验（2026-02-21）：
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
- 本故事聚焦行为一致性与数据语义，不要求先行依赖升级；如升级须单独评估回归范围。

### File Structure Requirements（建议变更落点）

- API 读写语义与入参归一化：
  - `apps/api/src/modules/platform/role.service.js`
  - `apps/api/src/modules/tenant/role.service.js`
- 权限写入与快照同步主链路：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约与授权门禁：
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/http-routes.js`
- 迁移（若需要清理历史脏数据）：
  - `apps/api/migrations/*`
- 测试：
  - `apps/api/test/platform.role.api.test.js`
  - `apps/api/test/tenant.role.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（必须覆盖）

- AC1（仅持久化最终授权点）
  - 输入包含重复、大小写差异时，最终持久化集合去重且规范化。
  - 输入包含中间态节点或未知权限码时，明确失败并返回稳定错误语义。
- AC2（回读可还原）
  - 保存后 `GET` 返回的 `permission_codes` 与持久化一致。
  - `available_permission_codes` 与权限目录一致，且 `permission_codes ⊆ available_permission_codes`。
  - 平台/组织两域均验证，不允许跨域权限码误入。
- 回归门禁
  - `check:route-permissions`、`lint`、`test` 全绿，并附关键用例结果。

### Previous Story Intelligence（来自 4.4）

- 先 fail-closed 再谈可用性：依赖异常/载荷脏数据必须拒绝，避免权限误放行。
- 契约、实现、测试必须同批更新；任何单边修改都会造成权限语义漂移。
- MySQL 与 memory store 语义必须一致，避免测试环境通过、生产行为偏移。
- 审计字段（before/after、request_id、affected counts）必须持续可追踪。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交聚焦：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/platform/role.service.js`
  - `apps/api/src/modules/tenant/role.service.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/{auth.service,platform.role.api,tenant.role.api,server}.test.js`
- 可执行建议：沿用“服务层严格校验 + store 原子更新 + 审计同步 + 回归加固”的节奏推进 4.5。

### Latest Tech Information（外部核验）

- npm registry（2026-02-21）显示：
  - `@nestjs/core@11.1.14`
  - `typeorm@0.3.28`
  - `mysql2@3.17.4`
  - `ioredis@5.9.3`
- 本地 Node 运行时当前为 `v25.2.1`，与架构文档建议的 Node 24 LTS 基线存在差异；CI/发布建议使用统一 LTS 基线执行门禁。

### Project Structure Notes

- 当前仓库 `apps/web` 仍是基础骨架，4.5 优先保证后端契约与权限语义稳定。
- 若同迭代补前端权限树，须遵循 UX 既定容器/反馈规则：`Modal`、`Drawer(size)`、`message`、提交按钮 loading 防重复。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 当前故事上下文依据：
  - `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.5）
  - `_bmad-output/planning-artifacts/prd.md`（FR74、NFR6、NFR7、NFR22）
  - `_bmad-output/planning-artifacts/architecture.md`（Problem Details、权限声明门禁、模块边界）
  - `_bmad-output/planning-artifacts/ux-design-specification.md`（统一反馈与交互约束）
  - `_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`（前序实现与复盘）

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review findings closed: write path + grant read path now enforce end-to-end fail-closed (store + service), including unexpected role rows, duplicate/case-drift permission codes, and tenant membership role_id case-drift rejection.`

### References

- `_bmad-output/planning-artifacts/epics.md`（`Epic 4` / `Story 4.5`）
- `_bmad-output/planning-artifacts/prd.md`（`FR74`、`NFR6`、`NFR7`、`NFR22`）
- `_bmad-output/planning-artifacts/architecture.md`（`Process Patterns`、`API Boundaries`、`Requirements Mapping`）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（交互一致性与反馈规范）
- `_bmad-output/implementation-artifacts/4-4-受保护角色约束与角色状态失效.md`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/openapi.js`
- `apps/api/package.json`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/tenant.role.api.test.js test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/tenant.role.api.test.js`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test --test-name-pattern "listPlatformRolePermissionGrants" test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test --test-name-pattern "listPlatformRolePermissionGrants|listTenantRolePermissionGrants|listTenantMemberRoleBindings" test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 平台与组织角色权限写入路径统一为“严格最终授权码”归一化：仅接受域内权限码、大小写无关去重、排序后持久化，拒绝前后空白/控制字符/中间态脏码。
- `replaceRolePermissions` 增加目录基线预校验：未知权限码在写入前稳定返回 `400 invalid payload`，避免“请求成功但落库集合漂移”。
- 新增迁移 `0020_permission_grants_final_authorization_cleanup`，一次性清洗历史授权脏数据（重复、大小写混杂、未知码、跨域/跨租户错配），并显式 no-op down 文件。
- OpenAPI 补齐“最终授权权限点集合”语义说明与读写示例，明确 `permission_codes` 与 `available_permission_codes` 的重建关系。
- 复审修复：平台/组织权限写入在权限目录畸形载荷下写前 fail-closed，避免“先写后报错”。
- 复审修复：`0020` 迁移保留 `created_by_user_id` / `updated_by_user_id` 审计溯源字段，避免清洗后归零。
- 复审修复：平台/组织 `permission_codes` 输入在重复/大小写差异场景执行归一化去重并稳定返回规范化结果集合。
- 继续复审修复：平台域授权 grant 读取从“静默过滤”收敛为“严格校验+fail-closed”（MySQL + memory store），并补齐平台 store 脏数据回归。
- 新增平台/组织 API 负向与归一化回归（权限目录畸形载荷时写前拒绝、重复权限码去重）并扩展迁移基线测试。
- 继续复审修复：MySQL grant/绑定读取链路对 `role_id` 大小写漂移执行 fail-closed（拒绝静默归一化），并新增 store 回归覆盖 platform/tenant 双域及租户成员角色绑定读取。
- 门禁复验：`check:route-permissions`、`lint`、`test` 全部通过（全量 `1022 passed`，专项 `120 passed`）。
- 三次复审加固：`auth.service` grant 聚合读取新增严格校验（unexpected role_id、role_id 大小写漂移、权限码重复/大小写漂移均 fail-closed），并将租户成员角色绑定读取补齐 case-drift 拒绝。
- 新增服务层回归：平台/组织 grant 聚合脏载荷拒绝与租户成员角色绑定大写 role_id 拒绝（`auth.service.test` 相关分组 `24 passed`，全文件 `293 passed`）。
- 四次复审修复：`0020` 迁移改为“`EXISTS` 守护删除 + `ON DUPLICATE KEY UPDATE` 回填”，避免归一化结果为空时误清空授权表。
- 四次复审修复：平台/组织权限读写接口统一输出排序后的 `permission_codes` / `available_permission_codes`，消除响应顺序漂移。
- 新增回归：`platform.role.api`、`tenant.role.api` 增加 deterministic sort 用例；`migrate-baseline` 增加迁移守护 SQL 断言。
- 门禁复验：`check:route-permissions`、`lint`、`test` 通过（全量 `1029 passed`，专项 `138 passed`）。
- 五次复审（`CR 4-5 自动继续`）：对账 Story 与 git 变更清单一致，未发现新增 HIGH/MEDIUM 问题；门禁复核 `check:route-permissions`、`lint`、`test` 全绿（全量 `1012 passed`）。

### File List

- `_bmad-output/implementation-artifacts/4-5-权限树最终授权落库.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.sql`
- `apps/api/migrations/0020_permission_grants_final_authorization_cleanup.down.sql`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/tenant/role.service.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/openapi.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/platform.role.api.test.js`
- `apps/api/test/tenant.role.api.test.js`

## Senior Developer Review (AI)

### Outcome

- Approve（复审问题已修复并验证通过）

### Findings Closed

- [HIGH] 权限目录畸形载荷场景下，平台域写接口需要写前 fail-closed，防止错误语义漂移与潜在写入副作用。
- [HIGH] 权限目录畸形载荷场景下，组织域写接口需要写前 fail-closed，防止错误语义漂移与潜在写入副作用。
- [MEDIUM] `0020` 迁移不应抹除授权变更操作者溯源字段，需保留 `created_by_user_id` / `updated_by_user_id`。
- [MEDIUM] 重复/大小写差异权限码输入应与 Story 的“归一化去重”语义一致，不应直接 `400` 拒绝。
- [HIGH] 平台域授权 grant 读取链路需与组织域一致 fail-closed，不能静默过滤无效/重复/越界 grant 行。
- [MEDIUM] grant 读取链路需拒绝 `role_id` 大小写漂移脏行，避免静默 lower-case 归一化掩盖数据异常。
- [HIGH] `auth.service` 平台 grant 聚合读取需拒绝 unexpected role 行与大写 `role_id` 漂移，避免跨实现下脏数据被静默吞掉。
- [HIGH] `auth.service` 平台/组织 grant 聚合读取需拒绝重复或大写权限码，避免“清洗后放行”。
- [MEDIUM] `listTenantMemberRoleBindings` 需拒绝大写 `role_id` 漂移，保持 tenant 绑定读取 fail-closed 一致性。
- [HIGH] `0020` 迁移需避免“临时归一化为空时全表清空”的误删风险，清洗删除必须受临时结果 `EXISTS` 条件守护。
- [MEDIUM] 平台域权限读/写接口响应需做最终排序，保证 `permission_codes` 与 `available_permission_codes` 输出稳定。
- [MEDIUM] 组织域权限读/写接口响应需做最终排序，保证 `permission_codes` 与 `available_permission_codes` 输出稳定。

### Validation Evidence

- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（120 passed）
- `pnpm --dir apps/api exec node --test --test-name-pattern "listPlatformRolePermissionGrants" test/auth.service.test.js`（2 passed）
- `pnpm --dir apps/api exec node --test --test-name-pattern "listPlatformRolePermissionGrants|listTenantRolePermissionGrants|listTenantMemberRoleBindings" test/auth.service.test.js`（24 passed）
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`（293 passed）
- `pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/tenant.role.api.test.js test/migrate-baseline.test.js`（138 passed）
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`（1012 passed）

## Change Log

- 2026-02-21：完成 Story 4.5 开发并进入 review，交付“仅最终授权结果落库”严格归一化、历史脏数据清洗迁移、OpenAPI 契约增强与回归测试加固。
- 2026-02-21：完成 AI 复审闭环，修复权限目录畸形回包下的写前 fail-closed 缺口，补齐平台/组织双域回归测试，并增强迁移审计字段保留策略。
- 2026-02-21：继续复审并修复重复权限码输入语义偏差，平台/组织写入链路改为“归一化去重后持久化”，并同步契约与回归测试。
- 2026-02-21：继续复审并修复平台域授权 grant 读取静默过滤问题；MySQL + memory store 改为严格校验并 fail-closed，补齐平台 store 脏数据回归。
- 2026-02-21：继续复审并修复 grant/绑定读取中 `role_id` 大小写漂移静默归一化问题；MySQL store 改为 fail-closed，并补齐 platform/tenant/tenant-membership 三类脏数据回归。
- 2026-02-21：二次复审完成，未发现新的 HIGH/MEDIUM 问题；门禁复核 `check:route-permissions`、`lint`、`test` 持续全绿。
- 2026-02-21：三次复审加固服务层读取防线：`auth.service` 拒绝 unexpected role 行、`role_id` 大小写漂移、权限码重复/大小写漂移；并补齐租户成员角色绑定读取的 case-drift 拒绝与回归测试。
- 2026-02-21：四次复审修复迁移与响应稳定性问题：`0020` 增加 `EXISTS` 守护删除与 `ON DUPLICATE KEY UPDATE` 回填；平台/组织权限读写输出统一排序，并新增对应 API/迁移回归；门禁复验全绿（`1029 passed`）。
- 2026-02-21：五次复审（`CR 4-5 自动继续`）完成：对账 Story 与 git 变更一致、未发现新增 HIGH/MEDIUM 问题；门禁复核 `check:route-permissions`、`lint`、`test` 全绿（`1012 passed`）。
