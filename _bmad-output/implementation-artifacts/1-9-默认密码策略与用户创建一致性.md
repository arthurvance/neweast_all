# Story 1.9: 默认密码策略与用户创建一致性

Status: done  
Story ID: 1.9  
Story Key: 1-9-默认密码策略与用户创建一致性

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台治理操作者,  
I want 新建用户与导入既有用户遵循统一默认密码与安全存储规则,  
so that 用户开通流程可控且不破坏既有账号安全状态。

## Acceptance Criteria

1. **Given** 创建系统内不存在的手机号用户  
   **When** 平台或组织侧发起创建  
   **Then** 系统按默认密码策略初始化账号  
   **And** 仅保存密码哈希，不保存明文密码

2. **Given** 将已存在手机号用户加入平台或组织  
   **When** 创建流程完成  
   **Then** 系统保持该用户原密码不变  
   **And** 新增关系只影响成员/角色绑定，不影响原认证凭据

3. **Given** 新建用户首次登录  
   **When** 用户使用初始化凭据完成登录  
   **Then** 系统统一不强制改密并允许进入正常会话流程  
   **And** 错误与成功提示采用统一语义

## Tasks / Subtasks

- [x] 任务 1：统一“按手机号建档/复用”服务原语（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.service.js` 抽象单一入口（例如 `provisionUserByPhone`），显式区分“新建用户”与“复用既有用户”分支
  - [x] 新建分支必须仅写入 `password_hash`；任何日志、审计、响应严禁出现明文密码
  - [x] 复用分支必须显式断言不改写 `users.password_hash`，仅写入成员关系/角色关系
  - [x] 与 `apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js` 保持语义一致

- [x] 任务 2：固化首次登录策略（统一不强制改密）（AC: 1, 3）
  - [x] 按受控配置读取默认密码（`auth.default_password`）；不提供“首登强制改密”配置入口
  - [x] 默认密码配置按敏感配置处理（密文存储 + 运行时解密）；缺失或解密失败走 fail-closed
  - [x] 新建用户首登统一无需改密，且该行为在 API/会话层可稳定断言
  - [x] 不在本故事中引入 hash 算法迁移，沿用现有 `pbkdf2` 路径并保持参数强度不下降

- [x] 任务 3：接入现有高风险创建链路并避免重复实现（AC: 1, 2, 3）
  - [x] 将“负责人变更/自动建档”及后续用户治理入口统一复用任务 1 的服务原语，避免多处分叉
  - [x] 保持双域边界不被削弱：平台域操作不直接提升组织域权限，组织域同理
  - [x] 不引入与本故事无关的跨模块重构，改动范围保持在 `modules/auth` 与必要契约层

- [x] 任务 4：契约与错误语义对齐（AC: 3）
  - [x] 新增或调整接口时，同步更新 `apps/api/src/openapi.js` 与 `apps/api/src/route-permissions.js`
  - [x] 错误返回保持 Problem Details 结构与统一错误码语义（含 `request_id`，并与现有 `AUTH-*` 体系一致）
  - [x] 对关键失败分支（配置缺失、非法入参、重复请求冲突）补齐可测试的契约示例

- [x] 任务 5：测试与门禁（AC: 1, 2, 3）
  - [x] 单元测试：覆盖“新建写 hash / 复用不改密 / 首登统一不强制改密 / 配置异常 fail-closed / 不泄露明文”
  - [x] 集成测试：覆盖 MySQL 路径与 Express 路径，确保 store 与 service 行为一致
  - [x] 回归门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`

- [x] Review Follow-ups (AI)
  - [x] [AI-Review][MEDIUM] tenant provision 的 `tenant_name` 缺少长度约束，MySQL 持久化路径存在 data-too-long 退化为 500 的风险；已在 service 层补齐校验并统一映射为 `AUTH-400-INVALID-PAYLOAD`。[apps/api/src/modules/auth/auth.service.js:498]
  - [x] [AI-Review][MEDIUM] AC2（租户路径“复用既有用户不改密”）在 API 与 Express/MySQL 链路缺少直接断言；已补齐端到端与服务层回归用例。[apps/api/test/auth.api.test.js:1637]
  - [x] [AI-Review][LOW] OpenAPI 对 `tenant_name` 未声明长度上限，契约与 `VARCHAR(128)` 存储约束不一致；已补充 `maxLength: 128`。[apps/api/src/openapi.js:1364]
  - [x] [AI-Review][MEDIUM] provision-user 新接口的 OpenAPI 未声明 `413`，与运行时 JSON body-limit 行为不一致；已补齐 tenant/platform 两条路径的 `AUTH-413-PAYLOAD-TOO-LARGE` 契约。[apps/api/src/openapi.js]
  - [x] [AI-Review][LOW] OpenAPI 回归仅断言 provision-user 的 `409/503`，缺少 `413` 断言；已补 server 级契约回归用例。[apps/api/test/server.test.js]
  - [x] [AI-Review][LOW] `auth.user.provision.config_failed` 审计 detail 直出异常 message，语义不稳定且可能暴露底层实现细节；已改为稳定 detail + `failure_reason` 并补回归断言。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] 平台建档并发窗口可能出现“关系已被并发请求创建但仍返回 200”语义漂移；已收敛为仅 `inserted=true` 才成功，其他路径统一返回 `AUTH-409-PROVISION-CONFLICT`，并补竞态回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] in-memory `createTenantMembershipForUser` 仅按 active 判重，与 MySQL 唯一键语义不一致导致环境分叉；已统一为同 `user_id + tenant_id` 一律判重冲突，并补 service 回归。[apps/api/src/modules/auth/auth.store.memory.js]
  - [x] [AI-Review][LOW] MySQL `createTenantMembershipForUser` 对空白 `tenant_name` 未归一化为 `null`，存在噪声数据风险；已补 trim/null 归一化并补存储层回归。[apps/api/src/modules/auth/auth.store.mysql.js]
  - [x] [AI-Review][LOW] OpenAPI 回归缺少 tenant provision 的 `409/503` 断言，契约覆盖不完整；已补 server 契约断言。[apps/api/test/server.test.js]
  - [x] [AI-Review][HIGH] MySQL 域授予在 `auth_user_domain_access` 存在 disabled 记录时无法重激活，tenant provision 在特定状态下可能“成员关系已写入但返回 409”；已改为 `ON DUPLICATE KEY UPDATE` 重激活并补存储层回归。[apps/api/src/modules/auth/auth.store.mysql.js]
  - [x] [AI-Review][MEDIUM] tenant provision 直接接受请求体 `tenant_name`，可与当前 active tenant 名称不一致，存在数据污染风险；已改为 canonical tenant name 对齐，不匹配返回 `AUTH-400-INVALID-PAYLOAD`，并补 service/API 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] 新增敏感配置变量未同步到 `.env.example` 与 `docker-compose.yml`，默认本地运行下 provision-user 接口易长期 503；已补齐配置入口与示例占位。[.env.example]
  - [x] [AI-Review][MEDIUM] platform provision 路径对请求体 `tenant_name` 静默忽略，易掩盖调用方参数错误并造成契约误用；已改为显式拒绝并返回 `AUTH-400-INVALID-PAYLOAD`，补齐 service/API/Express 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][LOW] OpenAPI 对 platform provision 复用 tenant 请求 schema，文档允许 `tenant_name` 与运行时意图不一致；已拆分为 `ProvisionPlatformUserRequest` 并补契约断言。[apps/api/src/openapi.js]
  - [x] [AI-Review][LOW] store 层可在“用户不存在”时创建租户关系（缺少前置用户存在校验），存在潜在孤儿关系数据风险；已在 memory/MySQL 双存储补齐 fail-closed 校验与回归测试。[apps/api/src/modules/auth/auth.store.mysql.js]
  - [x] [AI-Review][HIGH] 平台/租户 provision 在“新建用户后、关系绑定失败”场景缺少补偿回滚，可能留下可登录但无有效关系的孤儿账号；已新增 `deleteUserById` 并在 service 冲突路径执行回滚。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] tenant provision 在“成员关系已插入但 tenant 域授予失败”时会返回 409 且保留副作用（关系残留），不满足 fail-closed；已新增 `removeTenantMembershipForUser` 并在失败路径回滚关系。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] active tenant canonical name 缺失时，tenant provision 对调用方 `tenant_name` 采取静默忽略，契约语义不明确且易掩盖调用方数据问题；已改为 fail-closed 返回 `AUTH-400-INVALID-PAYLOAD`。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] active tenant canonical name 缺失时，仅在调用方显式提交 `tenant_name` 才会 fail-closed，遗漏“未提交 tenant_name 的同类绕过路径”；已统一为 canonical 缺失即拒绝，并补 service/API 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][LOW] API 层缺少“canonical tenant name 缺失 + 未提交 `tenant_name`”的端到端断言，存在回归盲区；已补 `auth.api.test` 覆盖该分支。[apps/api/test/auth.api.test.js]
  - [x] [AI-Review][LOW] in-memory `deleteUserById` 未清理平台角色事实与权限快照缓存，回滚/删除后可能残留脏状态；已补齐缓存清理并补回归断言。[apps/api/src/modules/auth/auth.store.memory.js]
  - [x] [AI-Review][HIGH] 新建用户在并发建档冲突路径会无条件回滚删除，可能误删“另一并发请求已成功建立关系”的有效账号；已在回滚前增加域/关系副作用守卫，仅在无副作用时执行删除，并补并发回归。[apps/api/src/modules/auth/auth.service.js:2697]
  - [x] [AI-Review][MEDIUM] tenant provision 在“成员关系已写入后，域授予步骤抛异常”时缺少兜底回滚，可能残留半完成关系；已对异常路径统一回滚 `removeTenantMembershipForUser` 并补回归。[apps/api/src/modules/auth/auth.service.js:2844]
  - [x] [AI-Review][MEDIUM] tenant provision 对空白 `tenant_name` 会静默归一为未传，掩盖调用方入参错误并绕过显式校验语义；已改为 fail-closed（400），并同步 OpenAPI 与 API/service 回归。[apps/api/src/modules/auth/auth.service.js:514]
  - [x] [AI-Review][HIGH] MySQL `deleteUserById` 采用多条独立删除语句且未开启事务，异常中断时会产生“部分回滚”数据不一致；已改为单事务执行并补回归断言。[apps/api/src/modules/auth/auth.store.mysql.js]
  - [x] [AI-Review][HIGH] tenant provision 失败补偿仅回滚成员关系，不回滚 tenant 域访问，可能残留“无关系但有 tenant 域”脏状态；已新增 `removeTenantDomainAccessForUser` 并在回滚路径联动执行，补 service/store 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] 新建用户并发冲突场景会返回失败但实际关系已由并发请求落库，响应语义与最终状态不一致；已新增冲突后状态复核并在“关系已成立”时返回成功，补 service 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][LOW] OpenAPI `ProvisionPlatformUserRequest` 未限制额外字段，文档层仍允许 `tenant_name` 等误用字段；已为 provision 请求 schema 增加 `additionalProperties: false` 收敛契约边界。[apps/api/src/openapi.js]
  - [x] [AI-Review][LOW] 敏感配置解密 key 仅基于单次 `SHA-256` 派生，低熵口令抗离线猜解能力偏弱；已升级为 PBKDF2 派生并保留 legacy v1 派生兼容，补回归覆盖。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] provision 平台/租户接口运行时未拒绝未知请求体字段，和 OpenAPI `additionalProperties: false` 存在契约漂移；已在 service 层补齐 payload 白名单校验并补 service/API 回归。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][MEDIUM] 默认密码解密在每次 provision 调用都重复执行 PBKDF2 key 派生，存在可避免的 CPU 开销；已改为 service 初始化时预派生 key 并复用。[apps/api/src/modules/auth/auth.service.js]
  - [x] [AI-Review][LOW] `tenant_name` 仅按 trim 后长度校验，原始 payload 长度可超过 128 但仍通过，和 OpenAPI `maxLength: 128` 语义不一致；已补原始长度 fail-closed 校验与回归测试。[apps/api/src/modules/auth/auth.service.js]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 1.8 已将鉴权主链路收敛到 `modules/auth`，并完成多轮 CR 的 fail-closed 加固；Story 1.9 必须沿用同一工程策略，避免“另起一套用户创建逻辑”。
- 当前代码主改动热区集中在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js` 与 `apps/api/test/auth*.test.js`，本故事应继续增量演进，不做目录级重构。
- 本故事是后续平台/组织用户治理能力的基线能力，重点是“密码初始化一致性 + 复用不改密 + 策略可控”，不是一次性交付完整用户管理后台。

### Technical Requirements（实现硬约束）

- 新建用户：手机号不存在时创建用户并应用默认密码策略，且仅持久化 `password_hash`。
- 既有用户复用：手机号已存在时禁止改写密码，只允许写关系层（成员/角色）数据。
- 首登策略：统一不强制改密，不提供管理员配置入口；行为需可测试、可回归。
- 配置安全：默认密码配置按敏感配置处理（密文存储 + 环境密钥解密）；禁止仓库存储明文密钥。
- 错误处理：保持 Problem Details + 统一错误码，不返回裸错误字符串。
- 安全基线：沿用现有 `pbkdf2` 哈希路径，不降低参数强度；避免在本故事引入哈希算法迁移风险。

### Architecture Compliance（架构对齐清单）

- 改动边界以 `apps/api/src/modules/auth/*` 为主，必要时补 `openapi` 与 `route-permissions`，不跨模块扩散。
- 保持 REST + OpenAPI 契约优先，运行时行为与文档同步更新。
- 保持 MySQL 与内存存储实现语义一致，防止测试通过但运行时分叉。
- 持续执行 fail-closed：配置异常、参数异常、状态异常时拒绝请求并留痕。
- 保持双域边界约束（`platform.*`/`tenant.*`）不被本故事弱化。

### Library & Framework Requirements（库与框架要求）

- 项目当前基线：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-15 最新核验：
  - Node.js：`v25.6.1`（Current），`v24.13.1`（LTS）
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.1`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS：`8.4.8`（2026-01-20）
- 密码存储实践参考：OWASP Password Storage Cheat Sheet（Argon2id 优先；PBKDF2 可用但需保持足够参数强度）。

### File Structure Requirements（建议变更落点）

- 核心实现：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 接口与契约（按需）：
  - `apps/api/src/modules/auth/auth.routes.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`
- 测试：
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/auth.api.test.js`
  - `apps/api/test/auth.express.api.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- 单元测试（必须）：
  - 新建用户写入 hash，且不出现明文密码外泄
  - 复用既有用户不改写 `password_hash`
  - 首登统一不强制改密行为可稳定断言
  - 默认密码配置缺失/非法/解密失败时 fail-closed
- 集成测试（必须）：
  - MySQL 路径验证“新建 vs 复用”分支语义
  - Express/API 路径验证错误结构、错误码与 `request_id` 一致性
- 回归门禁（必须）：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Previous Story Intelligence

- 来自 Story 1.8：
  - 多轮 CR 表明：输入校验、权限校验、错误映射必须 service/store 双层防护，且必须防止 fail-open。
  - 契约与实现要同步（`openapi`、`route-permissions`、`auth*.test.js` 一起改），否则极易出现“运行时已变，文档未变”回归风险。
  - 改动应保持在 `modules/auth` 热区，避免不必要跨模块重构导致评审成本与风险飙升。
- 来自 Story 1.7：
  - 双存储一致性与审计字段完整性是发布门禁高频问题；本故事继续沿用同样的测试深度与日志约束。

### Git Intelligence Summary

- 最近 5 次提交持续集中在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js`、`apps/api/src/route-permissions.js`、`apps/api/test/auth*.test.js`。
- 结论：Story 1.9 推荐采用“小步增量 + 契约同步 + 全量回归”的同路径策略，不引入目录重排和大范围重构。

### Latest Tech Information（2026-02-15）

- Node.js：`v25.6.1`（Current），`v24.13.1`（LTS）
- MySQL 8.4 LTS：`8.4.8`（2026-01-20）
- npm registry：
  - `@nestjs/core 11.1.13`
  - `typeorm 0.3.28`
  - `mysql2 3.17.1`
  - `ioredis 5.9.3`
- 安全参考：OWASP 密码存储建议（Argon2id 优先；使用 PBKDF2 时需保持参数强度并防止降级）。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文基于：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、Story 1.7/1.8 与当前代码基线。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Story 1.9 code review completed; all review findings fixed with regression evidence`

### Project Structure Notes

- 当前 API 公开路由主要集中在 `/auth/*`；本故事新增能力优先以“可复用服务原语 + 必要契约补齐”方式推进，避免一次性扩散到完整治理模块。
- 代码组织以 `modules/auth` 为中心，配套 `openapi` 与 `route-permissions` 一起演进，确保门禁一致通过。

### References

- Story 1.9 定义与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 1.9: 默认密码策略与用户创建一致性]
- FR59/FR60/FR61 需求陈述  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 默认密码与复用规则（详细）  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Default Password Provisioning Rules (Detailed)]
- 架构约束（会话、安全、契约、结构）  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- 反馈一致性与错误语义 UX 约束  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事情报  
  [Source: _bmad-output/implementation-artifacts/1-7-refresh-rotation-重放识别与并发会话策略.md]  
  [Source: _bmad-output/implementation-artifacts/1-8-关键状态变更触发-session-version-会话收敛.md]
- Node.js Releases  
  [Source: https://nodejs.org/dist/index.json]
- MySQL 8.4 Release Notes  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]
- OWASP Password Storage Cheat Sheet  
  [Source: https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html]

## Senior Developer Review (AI)

### Review Summary

- Review Scope: `apps/api/src/**`, `apps/api/test/**`（仅 Story 1.9 相关改动）
- Git vs Story File List Discrepancy: `0`
- Findings: `3 High` / `15 Medium` / `10 Low`（均已在本次 review 内修复）

### Review Findings (Resolved)

- `MEDIUM` 已修复：`tenant_name` 长度校验缺失，可能触发持久化层 data-too-long 并返回 500；已改为 service 层 fail-closed 入参校验 + 400 映射。[apps/api/src/modules/auth/auth.service.js:498]
- `MEDIUM` 已修复：租户路径“复用既有用户不改密”缺少 API 与 Express/MySQL 断言，存在回归盲区；已补齐服务/API/Express 三层测试。[apps/api/test/auth.service.test.js:3611]
- `MEDIUM` 已修复：provision-user 两条新增接口在 OpenAPI 漏声明 `413` 响应，契约与运行时 body-limit 行为不一致；已补 `AUTH-413-PAYLOAD-TOO-LARGE` 示例。[apps/api/src/openapi.js]
- `MEDIUM` 已修复：平台建档并发竞态下，关系可能已被并发请求创建但当前请求仍返回 200；已改为“仅 inserted=true 视为成功”，其余统一返回 `AUTH-409-PROVISION-CONFLICT` 并补竞态回归。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：in-memory 仅按 active 判重 tenant 关系，与 MySQL 唯一键语义不一致；已统一为同 `user_id + tenant_id` 一律判重冲突并补回归测试。[apps/api/src/modules/auth/auth.store.memory.js]
- `LOW` 已修复：OpenAPI 未声明 `tenant_name` 长度上限，契约与存储约束不一致；已补 `maxLength: 128`。[apps/api/src/openapi.js:1364]
- `LOW` 已修复：OpenAPI 回归未覆盖 provision-user 的 `413` 响应，存在契约回归盲区；已补 `server.test` 断言。[apps/api/test/server.test.js]
- `LOW` 已修复：配置解密失败审计事件 detail 直接拼接异常 message，语义不稳定；已改为稳定 detail 与 `failure_reason`，并补 service 断言。[apps/api/test/auth.service.test.js]
- `LOW` 已修复：MySQL `createTenantMembershipForUser` 对空白 `tenant_name` 缺少归一化，存在噪声数据风险；已补 trim/null 归一化与存储层断言。[apps/api/src/modules/auth/auth.store.mysql.js]
- `LOW` 已修复：tenant provision 的 `409/503` OpenAPI 回归断言缺失；已补 server 契约断言防止契约漂移。[apps/api/test/server.test.js]
- `HIGH` 已修复：MySQL 域授予对 disabled 记录未做重激活，导致 tenant provision 在关系已写入后仍可能返回冲突；已改为 domain access upsert 重激活语义，并补 `ensureDefault/ensureTenant` 回归测试。[apps/api/src/modules/auth/auth.store.mysql.js]
- `MEDIUM` 已修复：tenant provision 可接收与 active tenant 不一致的 `tenant_name`，存在租户名称污染风险；已新增 canonical 名称校验，不匹配统一返回 `AUTH-400-INVALID-PAYLOAD`，并补 service/API 双层断言。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：敏感配置新变量未出现在运行示例配置中，易导致本地/测试环境误配；已补齐 `.env.example` 与 `docker-compose.yml` 环境变量入口。[docker-compose.yml]
- `MEDIUM` 已修复：platform provision 对请求体 `tenant_name` 静默忽略，调用方携带错误字段时无法及时暴露；已改为 service 层显式拒绝并统一返回 `AUTH-400-INVALID-PAYLOAD`，补齐 service/API/Express 回归。[apps/api/src/modules/auth/auth.service.js]
- `LOW` 已修复：OpenAPI 对 platform provision 复用 tenant 请求 schema，契约允许 `tenant_name` 与运行时意图不一致；已拆分 `ProvisionPlatformUserRequest` 并补 server 契约断言。[apps/api/src/openapi.js]
- `LOW` 已修复：store 层在用户不存在时缺少租户关系写入前置校验，存在潜在孤儿关系数据风险；已在 memory/MySQL 双存储补齐 fail-closed 校验并补回归。[apps/api/src/modules/auth/auth.store.mysql.js]
- `HIGH` 已修复：provision 在“新建用户后关系绑定失败”场景缺少补偿回滚，可能残留孤儿账号并造成状态不一致；已新增 store 级 `deleteUserById` 并在 service 冲突分支执行清理，补齐回归断言。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：tenant provision 在成员关系已写入但 tenant 域授予失败时会返回 409 且残留关系副作用；已新增 `removeTenantMembershipForUser` 并在失败路径回滚，确保冲突语义与持久层结果一致。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：active tenant canonical name 缺失时对 `tenant_name` 采取静默忽略，导致契约语义不明确；已改为 fail-closed（400）并补 service/API 回归断言。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：active tenant canonical name 缺失时，tenant provision 仅在调用方提交 `tenant_name` 时拒绝，未覆盖“省略 `tenant_name` 的同类绕过”；已统一为 canonical 缺失即 fail-closed，并补 service/API 回归断言。[apps/api/src/modules/auth/auth.service.js]
- `LOW` 已修复：API 回归缺少“canonical tenant name 缺失 + 未提交 `tenant_name`”断言，存在契约回归盲区；已补 `auth.api.test` 端到端回归用例。[apps/api/test/auth.api.test.js]
- `LOW` 已修复：in-memory `deleteUserById` 未同步清理 `platformRolesByUserId/platformPermissionsByUserId`，删除后可能残留角色事实与权限快照；已补清理逻辑与回归测试。[apps/api/src/modules/auth/auth.store.memory.js]
- `HIGH` 已修复：新建用户在并发建档冲突路径会无条件回滚删除，可能误删“另一并发请求已成功建立关系”的有效账号；已在回滚前增加域/关系副作用守卫，并补并发回归测试。[apps/api/src/modules/auth/auth.service.js:2697]
- `MEDIUM` 已修复：tenant provision 在“成员关系已写入后，域授予步骤抛异常”时缺少兜底回滚，可能残留半完成关系；已对异常路径统一回滚 `removeTenantMembershipForUser` 并补回归测试。[apps/api/src/modules/auth/auth.service.js:2844]
- `MEDIUM` 已修复：tenant provision 对空白 `tenant_name` 会静默归一为未传，掩盖调用方入参错误；已改为 fail-closed（400），并同步 OpenAPI 与 API/service 回归测试。[apps/api/src/modules/auth/auth.service.js:514]
- `MEDIUM` 已修复：platform/tenant provision 运行时未拒绝未知 JSON 字段，与 OpenAPI `additionalProperties: false` 不一致；已在 service 层新增 payload 白名单校验并补 service/API 回归断言。[apps/api/src/modules/auth/auth.service.js]
- `MEDIUM` 已修复：默认密码解密每次请求重复执行 PBKDF2 派生，存在可避免的 CPU 成本；已改为 service 启动时预派生密钥并复用。[apps/api/src/modules/auth/auth.service.js]
- `LOW` 已修复：`tenant_name` 长度仅按 trim 后校验，原始 payload 可超长且通过；已补原始长度上限校验并补 service/API 回归断言。[apps/api/src/modules/auth/auth.service.js]

### Verification

- `pnpm --dir apps/api check:route-permissions` ✅
- `pnpm --dir apps/api lint` ✅
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.api.test.js` ✅
- `pnpm --dir apps/api test` ✅（333/333）

### Outcome

- Decision: `Approve`
- Story Status: `done`

### Re-review (2026-02-16)

- Scope: `apps/api/src/**`、`apps/api/test/**` 与 Story 1.9 `File List` 对齐复核（Git 差异 `20` 文件，差异数 `0`）。
- Findings: `0`（未发现新增 High/Medium/Low 问题；历史问题均保持已修复状态）。
- Verification: `pnpm --dir apps/api check:route-permissions` ✅, `pnpm --dir apps/api lint` ✅, `pnpm --dir apps/api test` ✅（`333/333`）。
- Residual Risk: 并发语义已由单进程测试覆盖，但尚无跨进程/高并发压测证据（建议在集成环境补充压力回归）。

## Dev Agent Record

### Agent Model Used

gpt-5-codex

### Debug Log References

- `cat _bmad-output/implementation-artifacts/sprint-status.yaml`
- `cat _bmad-output/planning-artifacts/epics.md`
- `cat _bmad-output/planning-artifacts/prd.md`
- `cat _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
- `cat _bmad-output/planning-artifacts/architecture.md`
- `cat _bmad-output/planning-artifacts/ux-design-specification.md`
- `cat _bmad-output/implementation-artifacts/1-8-关键状态变更触发-session-version-会话收敛.md`
- `git log --oneline -n 5`
- `git log -n 5 --name-status --pretty=format:'COMMIT %H%nAUTHOR %an%nDATE %ad%nSUBJECT %s%n' --date=iso`
- `pnpm view @nestjs/core version`
- `pnpm view typeorm version`
- `pnpm view mysql2 version`
- `pnpm view ioredis version`
- `node -e "fetch('https://nodejs.org/dist/index.json')..."`
- `curl -s https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`
- `curl -s https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/auth.api.test.js test/server.test.js`
- `git status --porcelain`
- `git diff --name-only`
- `git -c core.quotePath=false diff --stat`
- `git -c core.quotePath=false diff -- apps/api/src/modules/auth/auth.service.js`
- `git -c core.quotePath=false diff -- apps/api/src/modules/auth/auth.store.memory.js`
- `git -c core.quotePath=false diff -- apps/api/src/modules/auth/auth.store.mysql.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.api.test.js test/server.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js test/server.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.api.test.js test/auth.express.api.test.js`
- `pnpm --dir apps/api exec node --test --test-force-exit test/server.test.js test/route-permissions.test.js`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.service.test.js test/auth.api.test.js`

### Completion Notes List

- ✅ 在 `auth.service` 新增用户建档服务原语（平台/租户两条入口），显式区分“新建用户（写入 hash）”与“复用用户（不改密）”，并统一错误码语义。
- ✅ 在 `auth.store.memory` 与 `auth.store.mysql` 新增 `createUserByPhone` / `createTenantMembershipForUser`，并统一 domain access 兜底判定语义（仅检查 `platform` 域行）。
- ✅ 新增敏感配置解密链路：默认密码改为密文配置 + 运行时解密；配置缺失/解密失败统一 fail-closed 返回 `AUTH-503-PROVISION-CONFIG-UNAVAILABLE`。
- ✅ 新增平台/租户建档 API 路由、路由权限声明与 OpenAPI 契约（含 400/401/403/409/413/503 分支）并保持 Problem Details 结构一致。
- ✅ 补齐 service/store/api/express/server/route-permissions 全链路测试，覆盖“新建写 hash、复用不改密、重复关系冲突、配置异常 fail-closed、首登不强制改密”。
- ✅ CR 修复：补齐 `tenant_name` 长度与非法入参 fail-closed 校验，避免持久化层越界导致 500。
- ✅ CR 修复：补齐租户路径“复用不改密”与超长 `tenant_name` 的 service/API/Express 回归断言。
- ✅ CR 修复：补齐 provision-user 的 `413` OpenAPI 契约与 server 断言，消除 body-limit 契约回归盲区。
- ✅ CR 修复：将 provisioning 配置失败审计改为稳定 failure reason（不直出底层异常 message），并补 service 回归断言。
- ✅ CR 修复：平台建档并发竞态下，关系已存在仍可能返回 200；已收敛为 `inserted=true` 才成功，其余统一 `AUTH-409-PROVISION-CONFLICT`，并补竞态回归。
- ✅ CR 修复：in-memory 与 MySQL 的 tenant 关系判重语义不一致；已统一为 `user_id + tenant_id` 一律判重冲突并补回归测试。
- ✅ CR 修复：`createTenantMembershipForUser` 对空白 `tenant_name` 统一 trim/null 归一化，避免噪声数据写入，并补存储层回归断言。
- ✅ CR 修复：`auth_user_domain_access` 在 disabled 行存在时由 `INSERT IGNORE` 升级为 `ON DUPLICATE KEY UPDATE` 重激活，避免 tenant provision “关系已写入但返回 409”语义漂移，并补存储层回归。
- ✅ CR 修复：tenant provision 增加 active tenant canonical name 对齐校验，阻断不一致 `tenant_name` 写入，并补 service/API 回归。
- ✅ CR 修复：补齐 `.env.example` 与 `docker-compose.yml` 的敏感配置环境变量入口，降低默认运行误配风险。
- ✅ CR 修复：platform provision 显式拒绝 `tenant_name` 入参（不再静默忽略），统一返回 `AUTH-400-INVALID-PAYLOAD`，并补 service/API/Express 回归用例。
- ✅ CR 修复：OpenAPI 拆分 platform/tenant provision 请求 schema，收紧 platform 契约并补 server 契约断言。
- ✅ CR 修复：memory/MySQL `createTenantMembershipForUser` 补齐“用户存在性”前置校验，避免潜在孤儿关系写入，并补存储层与内存实现回归。
- ✅ CR 修复：provision 失败补偿新增 `deleteUserById` / `removeTenantMembershipForUser`，修复“新建用户或新建成员关系后返回 409 但残留副作用”的一致性问题，并补 service/API 回归。
- ✅ CR 修复：active tenant canonical name 缺失时，tenant provision 由“静默忽略调用方 `tenant_name`”收敛为 fail-closed（`AUTH-400-INVALID-PAYLOAD`），避免契约语义歧义。
- ✅ 增量 CR 修复：canonical tenant name 缺失场景补齐“未提交 `tenant_name`”同类 fail-closed 分支，阻断绕过路径并补 service/API 回归。
- ✅ 增量 CR 修复：in-memory `deleteUserById` 补齐平台角色事实/权限快照缓存清理，避免删除后残留内存脏状态，并补回归测试。
- ✅ 增量 CR 修复：并发建档冲突路径新增“回滚前副作用守卫”，避免误删并发已成功建立关系的有效账号，并补 service 回归。
- ✅ 增量 CR 修复：tenant 域授予步骤抛异常时统一回滚已写入成员关系，避免残留半完成关系，并补 service 回归。
- ✅ 增量 CR 修复：tenant provision 对空白 `tenant_name` 改为 fail-closed（400），并同步 OpenAPI schema 与 API/service 契约回归。
- ✅ 门禁通过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`（323/323）、`pnpm --dir apps/api lint`。
- ✅ 增量 CR 修复：MySQL `deleteUserById` 改为事务执行，避免删除链路中断导致部分回滚状态；补 `auth.store.mysql.test` 事务序列回归。
- ✅ 增量 CR 修复：tenant 回滚路径新增 `removeTenantDomainAccessForUser`，修复“成员关系已回滚但 tenant 域残留”风险；补 service/store 回归。
- ✅ 增量 CR 修复：新建用户并发冲突场景新增“冲突后状态复核”，在关系已由并发请求落库时返回成功语义，避免失败响应与最终状态分叉。
- ✅ 增量 CR 修复：provision 请求 OpenAPI schema 收紧为 `additionalProperties: false`，消除 platform 请求体误字段契约歧义。
- ✅ 增量 CR 修复：敏感配置 key 派生升级为 PBKDF2（保留 legacy 兼容）并补兼容回归。
- ✅ 门禁通过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`（327/327）。
- ✅ 增量 CR 修复：provision 运行时补齐请求体字段白名单校验（拒绝未知字段）并同步 service/API 回归，消除与 OpenAPI `additionalProperties: false` 的契约漂移。
- ✅ 增量 CR 修复：默认密码解密 key 改为 service 初始化阶段预派生并复用，避免每次 provision 重复 PBKDF2 派生开销。
- ✅ 增量 CR 修复：`tenant_name` 补齐原始 payload 长度上限校验（不仅 trim 后长度），与 OpenAPI `maxLength: 128` 语义对齐并补回归。
- ✅ 门禁通过：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`（333/333）。

### File List

- _bmad-output/implementation-artifacts/1-9-默认密码策略与用户创建一致性.md
- _bmad-output/implementation-artifacts/sprint-status.yaml
- .env.example
- apps/api/src/app.js
- apps/api/src/config/env.js
- apps/api/src/http-routes.js
- apps/api/src/modules/auth/auth.routes.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/src/openapi.js
- apps/api/src/route-permissions.js
- apps/api/src/server.js
- apps/api/test/auth.api.test.js
- apps/api/test/auth.express.api.test.js
- apps/api/test/auth.service.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/route-permissions.test.js
- apps/api/test/server.test.js
- docker-compose.yml

### Change Log

- 2026-02-15：创建 Story 1.9 开发上下文文档并初始化为 `ready-for-dev`。
- 2026-02-15：完成默认密码密文配置解密、统一用户建档原语、平台/租户建档接口与权限契约落地，补齐双存储一致性实现与测试覆盖。
- 2026-02-15：完成回归门禁（`check:route-permissions`、`test`、`lint`）并将 Story 状态更新为 `review`。
- 2026-02-15：完成 CR 修复（`tenant_name` 非法入参防护、租户复用不改密链路补测、OpenAPI 长度约束对齐），并将 Story 状态更新为 `done`。
- 2026-02-15：增量 CR 修复：补齐 provision-user `413` OpenAPI 契约与 server 断言；收敛 provisioning 配置失败审计为稳定 `failure_reason` 语义，并完成全量门禁回归。
- 2026-02-16：增量 CR 修复：收敛 platform provision 并发关系竞态为确定性 `409`；统一 in-memory/MySQL tenant 判重语义并补 `tenant_name` 归一化；补齐 tenant provision `409/503` 契约断言并完成全量门禁回归。
- 2026-02-16：增量 CR 修复：补齐 domain access disabled 行重激活（upsert）以消除 tenant provision 部分成功冲突；新增 tenant canonical name 对齐校验；同步 `.env.example`/`docker-compose.yml` 敏感配置入口，并完成全量门禁回归。
- 2026-02-16：增量 CR 修复：platform provision 改为拒绝 `tenant_name` 非法入参；OpenAPI 拆分 platform/tenant 请求 schema；store 层补齐“用户不存在时禁止创建租户关系”校验，并完成全量门禁回归。
- 2026-02-16：增量 CR 修复：补齐 provision 失败补偿回滚（删除新建用户、撤销新建租户关系）；canonical tenant name 缺失时改为 fail-closed（400）；完成 `check:route-permissions`、`lint`、`test`（316/316）回归。
- 2026-02-16：增量 CR 修复：补齐 canonical tenant name 缺失 + 未提交 `tenant_name` 的 fail-closed 分支；补齐 in-memory 删除用户后的平台角色/权限快照清理；完成 `check:route-permissions`、`lint`、`test`（319/319）回归。
- 2026-02-16：增量 CR 修复：并发 conflict 路径新增“回滚前副作用守卫”避免误删并发已成功账号；tenant 域授予异常路径统一回滚成员关系；tenant provision 空白 `tenant_name` 改为 fail-closed 并同步 OpenAPI 与 API/service 回归；完成 `test`（323/323）回归。
- 2026-02-16：增量 CR 修复：MySQL `deleteUserById` 事务化、tenant 回滚联动清理 tenant 域访问、新建用户并发冲突成功态收敛、provision OpenAPI schema 收紧（`additionalProperties: false`）、敏感配置 key 派生升级为 PBKDF2（兼容 legacy）；完成 `check:route-permissions`、`lint`、`test`（327/327）回归。
- 2026-02-16：增量 CR 修复：provision 运行时补齐 payload 白名单校验（拒绝未知字段）、默认密码解密 key 预派生复用、`tenant_name` 原始长度 fail-closed 校验；完成 `check:route-permissions`、`lint`、`test`（333/333）回归。
- 2026-02-16：CR 复评（Story 1.9）：基于当前工作区差异重跑 `check:route-permissions`、`lint`、`test`（333/333），未发现新增问题，状态保持 `done`。
