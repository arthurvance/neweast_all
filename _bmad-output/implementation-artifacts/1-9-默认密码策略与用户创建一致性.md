# Story 1.9: 默认密码策略与用户创建一致性

Status: ready-for-dev  
Story ID: 1.9  
Story Key: 1-9-默认密码策略与用户创建一致性

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台治理操作者,  
I want 新建用户与导入既有用户遵循统一默认密码与安全存储规则,  
so that 用户开通流程可控且不破坏既有账号安全状态。

## Acceptance Criteria

1. **Given** 创建系统内不存在的手机号用户  
   **When** 平台或组织侧发起创建  
   **Then** 系统按默认密码策略初始化账号  
   **And** 仅保存密码哈希，不保存明文密码

2. **Given** 将已存在手机号用户加入平台或组织  
   **When** 创建流程完成  
   **Then** 系统保持该用户原密码不变  
   **And** 新增关系只影响成员/角色绑定，不影响原认证凭据

3. **Given** 新建用户首次登录  
   **When** 用户使用初始化凭据完成登录  
   **Then** 系统统一不强制改密并允许进入正常会话流程  
   **And** 错误与成功提示采用统一语义

## Tasks / Subtasks

- [ ] 任务 1：统一“按手机号建档/复用”服务原语（AC: 1, 2）
  - [ ] 在 `apps/api/src/modules/auth/auth.service.js` 抽象单一入口（例如 `provisionUserByPhone`），显式区分“新建用户”与“复用既有用户”分支
  - [ ] 新建分支必须仅写入 `password_hash`；任何日志、审计、响应严禁出现明文密码
  - [ ] 复用分支必须显式断言不改写 `users.password_hash`，仅写入成员关系/角色关系
  - [ ] 与 `apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js` 保持语义一致

- [ ] 任务 2：固化首次登录策略（统一不强制改密）（AC: 1, 3）
  - [ ] 按受控配置读取默认密码（`auth.default_password`）；不提供“首登强制改密”配置入口
  - [ ] 默认密码配置按敏感配置处理（密文存储 + 运行时解密）；缺失或解密失败走 fail-closed
  - [ ] 新建用户首登统一无需改密，且该行为在 API/会话层可稳定断言
  - [ ] 不在本故事中引入 hash 算法迁移，沿用现有 `pbkdf2` 路径并保持参数强度不下降

- [ ] 任务 3：接入现有高风险创建链路并避免重复实现（AC: 1, 2, 3）
  - [ ] 将“负责人变更/自动建档”及后续用户治理入口统一复用任务 1 的服务原语，避免多处分叉
  - [ ] 保持双域边界不被削弱：平台域操作不直接提升组织域权限，组织域同理
  - [ ] 不引入与本故事无关的跨模块重构，改动范围保持在 `modules/auth` 与必要契约层

- [ ] 任务 4：契约与错误语义对齐（AC: 3）
  - [ ] 新增或调整接口时，同步更新 `apps/api/src/openapi.js` 与 `apps/api/src/route-permissions.js`
  - [ ] 错误返回保持 Problem Details 结构与统一错误码语义（含 `request_id`，并与现有 `AUTH-*` 体系一致）
  - [ ] 对关键失败分支（配置缺失、非法入参、重复请求冲突）补齐可测试的契约示例

- [ ] 任务 5：测试与门禁（AC: 1, 2, 3）
  - [ ] 单元测试：覆盖“新建写 hash / 复用不改密 / 首登统一不强制改密 / 配置异常 fail-closed / 不泄露明文”
  - [ ] 集成测试：覆盖 MySQL 路径与 Express 路径，确保 store 与 service 行为一致
  - [ ] 回归门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`

## Dev Notes

### Developer Context（开发者必须先读）

- Story 1.8 已将鉴权主链路收敛到 `modules/auth`，并完成多轮 CR 的 fail-closed 加固；Story 1.9 必须沿用同一工程策略，避免“另起一套用户创建逻辑”。
- 当前代码主改动热区集中在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js` 与 `apps/api/test/auth*.test.js`，本故事应继续增量演进，不做目录级重构。
- 本故事是后续平台/组织用户治理能力的基线能力，重点是“密码初始化一致性 + 复用不改密 + 策略可控”，不是一次性交付完整用户管理后台。

### Technical Requirements（实现硬约束）

- 新建用户：手机号不存在时创建用户并应用默认密码策略，且仅持久化 `password_hash`。
- 既有用户复用：手机号已存在时禁止改写密码，只允许写关系层（成员/角色）数据。
- 首登策略：统一不强制改密，不提供管理员配置入口；行为需可测试、可回归。
- 配置安全：默认密码配置按敏感配置处理（密文存储 + 环境密钥解密）；禁止仓库存储明文密钥。
- 错误处理：保持 Problem Details + 统一错误码，不返回裸错误字符串。
- 安全基线：沿用现有 `pbkdf2` 哈希路径，不降低参数强度；避免在本故事引入哈希算法迁移风险。

### Architecture Compliance（架构对齐清单）

- 改动边界以 `apps/api/src/modules/auth/*` 为主，必要时补 `openapi` 与 `route-permissions`，不跨模块扩散。
- 保持 REST + OpenAPI 契约优先，运行时行为与文档同步更新。
- 保持 MySQL 与内存存储实现语义一致，防止测试通过但运行时分叉。
- 持续执行 fail-closed：配置异常、参数异常、状态异常时拒绝请求并留痕。
- 保持双域边界约束（`platform.*`/`tenant.*`）不被本故事弱化。

### Library & Framework Requirements（库与框架要求）

- 项目当前基线：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-15 最新核验：
  - Node.js：`v25.6.1`（Current），`v24.13.1`（LTS）
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.1`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS：`8.4.8`（2026-01-20）
- 密码存储实践参考：OWASP Password Storage Cheat Sheet（Argon2id 优先；PBKDF2 可用但需保持足够参数强度）。

### File Structure Requirements（建议变更落点）

- 核心实现：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 接口与契约（按需）：
  - `apps/api/src/modules/auth/auth.routes.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`
- 测试：
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/auth.api.test.js`
  - `apps/api/test/auth.express.api.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`

### Testing Requirements（测试要求）

- 单元测试（必须）：
  - 新建用户写入 hash，且不出现明文密码外泄
  - 复用既有用户不改写 `password_hash`
  - 首登统一不强制改密行为可稳定断言
  - 默认密码配置缺失/非法/解密失败时 fail-closed
- 集成测试（必须）：
  - MySQL 路径验证“新建 vs 复用”分支语义
  - Express/API 路径验证错误结构、错误码与 `request_id` 一致性
- 回归门禁（必须）：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Previous Story Intelligence

- 来自 Story 1.8：
  - 多轮 CR 表明：输入校验、权限校验、错误映射必须 service/store 双层防护，且必须防止 fail-open。
  - 契约与实现要同步（`openapi`、`route-permissions`、`auth*.test.js` 一起改），否则极易出现“运行时已变，文档未变”回归风险。
  - 改动应保持在 `modules/auth` 热区，避免不必要跨模块重构导致评审成本与风险飙升。
- 来自 Story 1.7：
  - 双存储一致性与审计字段完整性是发布门禁高频问题；本故事继续沿用同样的测试深度与日志约束。

### Git Intelligence Summary

- 最近 5 次提交持续集中在 `apps/api/src/modules/auth/*`、`apps/api/src/openapi.js`、`apps/api/src/route-permissions.js`、`apps/api/test/auth*.test.js`。
- 结论：Story 1.9 推荐采用“小步增量 + 契约同步 + 全量回归”的同路径策略，不引入目录重排和大范围重构。

### Latest Tech Information（2026-02-15）

- Node.js：`v25.6.1`（Current），`v24.13.1`（LTS）
- MySQL 8.4 LTS：`8.4.8`（2026-01-20）
- npm registry：
  - `@nestjs/core 11.1.13`
  - `typeorm 0.3.28`
  - `mysql2 3.17.1`
  - `ioredis 5.9.3`
- 安全参考：OWASP 密码存储建议（Argon2id 优先；使用 PBKDF2 时需保持参数强度并防止降级）。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文基于：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、Story 1.7/1.8 与当前代码基线。

### Story Completion Status

- Story 文档状态：`ready-for-dev`
- Completion Note：`Ultimate context engine analysis completed - comprehensive developer guide created`

### Project Structure Notes

- 当前 API 公开路由主要集中在 `/auth/*`；本故事新增能力优先以“可复用服务原语 + 必要契约补齐”方式推进，避免一次性扩散到完整治理模块。
- 代码组织以 `modules/auth` 为中心，配套 `openapi` 与 `route-permissions` 一起演进，确保门禁一致通过。

### References

- Story 1.9 定义与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 1.9: 默认密码策略与用户创建一致性]
- FR59/FR60/FR61 需求陈述  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 默认密码与复用规则（详细）  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Default Password Provisioning Rules (Detailed)]
- 架构约束（会话、安全、契约、结构）  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- 反馈一致性与错误语义 UX 约束  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事情报  
  [Source: _bmad-output/implementation-artifacts/1-7-refresh-rotation-重放识别与并发会话策略.md]  
  [Source: _bmad-output/implementation-artifacts/1-8-关键状态变更触发-session-version-会话收敛.md]
- Node.js Releases  
  [Source: https://nodejs.org/dist/index.json]
- MySQL 8.4 Release Notes  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]
- OWASP Password Storage Cheat Sheet  
  [Source: https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html]

## Dev Agent Record

### Agent Model Used

gpt-5-codex

### Debug Log References

- `cat _bmad-output/implementation-artifacts/sprint-status.yaml`
- `cat _bmad-output/planning-artifacts/epics.md`
- `cat _bmad-output/planning-artifacts/prd.md`
- `cat _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
- `cat _bmad-output/planning-artifacts/architecture.md`
- `cat _bmad-output/planning-artifacts/ux-design-specification.md`
- `cat _bmad-output/implementation-artifacts/1-8-关键状态变更触发-session-version-会话收敛.md`
- `git log --oneline -n 5`
- `git log -n 5 --name-status --pretty=format:'COMMIT %H%nAUTHOR %an%nDATE %ad%nSUBJECT %s%n' --date=iso`
- `pnpm view @nestjs/core version`
- `pnpm view typeorm version`
- `pnpm view mysql2 version`
- `pnpm view ioredis version`
- `node -e "fetch('https://nodejs.org/dist/index.json')..."`
- `curl -s https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`
- `curl -s https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html`

### Completion Notes List

- [ ] 待开发实现

### File List

- _bmad-output/implementation-artifacts/1-9-默认密码策略与用户创建一致性.md
