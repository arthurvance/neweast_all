# Story 2.4: 平台角色管理与受保护角色约束

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,  
I want 管理平台角色并保护系统关键角色不被编辑或删除,  
so that 平台权限模型既可演进又不破坏安全基线。

## Acceptance Criteria

1. **Given** 平台管理员管理普通平台角色  
   **When** 执行创建、编辑、删除  
   **Then** 系统按规则允许操作  
   **And** 保持角色编码唯一与可追踪
2. **Given** 管理员尝试编辑或删除受保护系统角色  
   **When** 请求到达服务端  
   **Then** 系统拒绝操作  
   **And** 返回标准错误码与说明
3. **Given** 受保护角色仅允许授权分配  
   **When** 管理员执行分配流程  
   **Then** 系统允许分配到符合条件用户  
   **And** 不允许修改该角色定义本身

## Tasks / Subtasks

- [x] 任务 1：实现平台角色目录治理 API（AC: 1, 2）
  - [x] 在 `platform` 模块新增角色治理入口（建议 `POST /platform/roles`、`PATCH /platform/roles/:role_id`、`DELETE /platform/roles/:role_id`、`GET /platform/roles`）。
  - [x] 明确角色模型最小字段：`role_id`、`code`、`name`、`status`、`is_system`、`created_at`、`updated_at`（字段命名遵循外部 `snake_case`）。
  - [x] 角色编码必须唯一（建议大小写不敏感唯一），冲突返回稳定 409 语义。
  - [x] 列表返回可追踪字段（至少包含 `role_id`、`code`、`name`、`status`、`created_at`、`request_id`）。

- [x] 任务 2：落实受保护角色约束（AC: 2, 3）
  - [x] 固化受保护角色判定（至少包含 `sys_admin`，建议通过常量集中维护，避免散落硬编码）。
  - [x] 对受保护角色执行编辑/删除时统一拒绝，返回 `application/problem+json` 标准错误结构。
  - [x] 拒绝语义必须可测试、可回归，不依赖前端拦截。
  - [x] 审计记录需包含操作者、目标角色、请求 ID、失败原因。

- [x] 任务 3：对齐“可分配但不可改定义”的边界（AC: 3）
  - [x] 保持受保护角色可通过既有授权分配路径分配给符合条件用户（当前基线：`POST /auth/platform/role-facts/replace`）。
  - [x] 在分配链路增加角色定义合法性校验（角色存在、状态允许、作用域为 `platform`）。
  - [x] 明确本故事边界：仅交付“角色目录 + 受保护约束”；完整“权限树配置 + 平台用户多角色分配生效”由 Story 2.5 继续交付。

- [x] 任务 4：补齐契约与权限门禁声明（AC: 1, 2, 3）
  - [x] 更新 OpenAPI：新增平台角色治理 API 请求/响应与错误示例（400/401/403/404/409/503）。
  - [x] 更新 `route-permissions`：所有新增受保护接口显式声明权限码与 scope（`platform`）。
  - [x] 保持写接口幂等策略一致（关键写接口支持 `Idempotency-Key`；同键冲突语义稳定）。

- [x] 任务 5：测试与回归门禁（AC: 1, 2, 3）
  - [x] API 回归：普通角色创建/编辑/删除成功；角色编码冲突；目标角色不存在。
  - [x] 受保护回归：`sys_admin` 编辑/删除被拒绝；分配流程允许并返回稳定语义。
  - [x] 安全回归：无权限调用返回 `AUTH-403-FORBIDDEN`；未声明权限接口被门禁阻断。
  - [x] 一致性回归：OpenAPI、路由声明、实现行为三方一致。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复参数化路由的幂等键跨资源串扰：`PATCH/DELETE /platform/roles/:role_id` 已将 `route params` 纳入幂等作用域与请求哈希。`apps/api/src/server.js`
- [x] [AI-Review][HIGH] 修复角色分配校验绕过：角色目录可用时始终执行存在性/状态/scope 校验，不再因“仅系统角色”跳过。`apps/api/src/modules/auth/auth.service.js`
- [x] [AI-Review][MEDIUM] 对齐 in-memory 与 MySQL 的 `role_id` 大小写唯一性语义，阻断 `RoleCase`/`rolecase` 双写。`apps/api/src/modules/auth/auth.store.memory.js`
- [x] [AI-Review][MEDIUM] 补齐回归：新增“参数化路由幂等隔离”“仅 `sys_admin` 存在时未知角色分配拒绝”测试。`apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 补齐回归：新增 `role_id` 大小写冲突测试，覆盖 memory/mysql 语义一致性。`apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 修复全量回归用例基线：`role-facts` 幂等回放用例改用目录内合法角色，避免被新校验误伤。`apps/api/test/auth.api.test.js`
- [x] [AI-Review][HIGH] 修复角色目录缺表时的 fail-open：`replacePlatformRoleFacts` 在 `platform_role_catalog` 不可用时改为 fail-closed，返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`。`apps/api/src/modules/auth/auth.service.js`
- [x] [AI-Review][MEDIUM] 补齐 `platform_role_catalog` 缺表回归：新增服务层测试，校验 `degradation_reason=platform-role-catalog-unavailable`。`apps/api/test/auth.service.test.js`
- [x] [AI-Review][LOW] 补齐 OpenAPI 契约一致性：`DELETE /platform/roles/{role_id}` 增加 `413` 响应声明并补充回归断言。`apps/api/src/openapi.js` `apps/api/test/server.test.js`
- [x] [AI-Review][HIGH] 修复角色目录校验能力缺失时的 fail-open：`enforceRoleCatalogValidation=true` 且 store 不支持 `findPlatformRoleCatalogEntriesByRoleIds` 时改为 fail-closed，返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`（`degradation_reason=platform-role-catalog-lookup-unsupported`）。`apps/api/src/modules/auth/auth.service.js` `apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 统一角色目录查询异常语义：`findPlatformRoleCatalogEntriesByRoleIds` 非缺表异常统一映射为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`（`degradation_reason=platform-role-catalog-query-failed`），避免 500 泄露。`apps/api/src/modules/auth/auth.service.js` `apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 纠正冲突错误码粒度：`role_id` 冲突不再误报 `ROLE-409-CODE-CONFLICT`，新增并落地 `ROLE-409-ROLE-ID-CONFLICT`，同步 in-memory 冲突目标标注与 OpenAPI/回归。`apps/api/src/modules/platform/role.service.js` `apps/api/src/modules/auth/auth.store.memory.js` `apps/api/src/openapi.js` `apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][HIGH] 修复“空角色集”场景目录校验 fail-open：`enforceRoleCatalogValidation=true` 且 `roles=[]` 时也强制探测角色目录依赖，不再绕过缺表/查询异常（统一返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`）。`apps/api/src/modules/auth/auth.service.js`
- [x] [AI-Review][MEDIUM] 补齐回归：新增服务层测试，覆盖“`roles=[]` + 目录缺表”必须 fail-closed（`degradation_reason=platform-role-catalog-unavailable`）。`apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 修复 MySQL 迁移基线回归遗漏：`createApiApp` 官方迁移启动用例补齐 `0008/0009`，并在重建前显式清理 `platform_role_catalog` 依赖表。`apps/api/test/auth.express.api.test.js`
- [x] [AI-Review][HIGH] 收紧 `role_id` 输入约束并与可寻址规则对齐：新增可寻址模式校验并统一小写规范化，阻断空白与 `/` 等不可寻址值进入目录。`apps/api/src/modules/platform/role.service.js` `apps/api/src/openapi.js`
- [x] [AI-Review][MEDIUM] 路径参数在路由层显式 URL 解码后再传递给 service，修复 `%20`/`%2F`/`%2E` 等编码值误判问题。`apps/api/src/route-permissions.js` `apps/api/src/server.js`
- [x] [AI-Review][LOW] MySQL 目录查询性能优化：移除 `LOWER(role_id)` 热路径比较，改为规范化 `role_id` 后的可索引等值查询。`apps/api/src/modules/auth/auth.store.mysql.js` `apps/api/src/modules/auth/auth.service.js` `apps/api/src/modules/auth/auth.store.memory.js`
- [x] [AI-Review][MEDIUM] 补齐回归：新增“非法/不可寻址 `role_id` 被拒绝”“编码路径参数可命中资源”与解码单元断言，补齐契约模式检查。`apps/api/test/platform.role.api.test.js` `apps/api/test/route-permissions.test.js` `apps/api/test/server.test.js`
- [x] [AI-Review][HIGH] 收敛参数化路由匹配：`/platform/roles//:role_id` 等连续斜杠异常路径不再被折叠命中，统一返回 `AUTH-404-NOT-FOUND`。`apps/api/src/route-permissions.js` `apps/api/test/platform.role.api.test.js` `apps/api/test/route-permissions.test.js`
- [x] [AI-Review][MEDIUM] 修复 `:role_id` 规范化前后不一致导致的幂等绕过：`PATCH/DELETE /platform/roles/:role_id` 在路由层先对 `role_id` 做 `trim+lowercase` 再参与幂等作用域。`apps/api/src/server.js`
- [x] [AI-Review][MEDIUM] 补齐回归：新增“大小写/空白编码路径变体”幂等冲突断言，阻断同资源多形态路径绕过。`apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][HIGH] 修复 `roles=[]` 场景“仅 count 能力”隐式放行：`enforceRoleCatalogValidation=true` 时统一要求目录查询能力，避免空负载路径在 lookup 缺失下 fail-open。`apps/api/src/modules/auth/auth.service.js` `apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 修复参数化路由对非法 URL 编码的过宽匹配：`%E0%A4%A` 等损坏编码不再命中 `:role_id` 处理链路，统一返回 `AUTH-404-NOT-FOUND`。`apps/api/src/route-permissions.js` `apps/api/test/route-permissions.test.js` `apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 修复参数化路由对编码斜杠值的过宽匹配：`%2F` 解码后不再作为合法 `:role_id` 命中，阻断路径语义歧义。`apps/api/src/route-permissions.js` `apps/api/test/route-permissions.test.js`
- [x] [AI-Review][HIGH] 收紧参数化路由解码段安全性：`%20role_id` / `role_id%20` / `%09` 等解码后含前后空白或控制字符的参数段不再命中 `:role_id` 路由。`apps/api/src/route-permissions.js` `apps/api/test/route-permissions.test.js` `apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 修复 `DELETE /platform/roles/:role_id` 幂等哈希与契约不一致：删除路由请求哈希忽略请求体漂移，仅基于资源与作用域判定幂等冲突。`apps/api/src/server.js` `apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 修复平台角色状态契约漂移：`POST/PATCH /platform/roles` 不再接受未声明别名 `status=enabled`，与 OpenAPI 的 `active|disabled` 严格一致。`apps/api/src/modules/platform/role.service.js` `apps/api/test/platform.role.api.test.js`
- [x] [AI-Review][MEDIUM] 修复静态路由的非规范路径放行：`/platform/roles/` 与 `/platform/roles//` 统一按未命中返回 `AUTH-404-NOT-FOUND`，避免路径变体旁路。`apps/api/src/server.js` `apps/api/src/route-permissions.js` `apps/api/test/platform.role.api.test.js` `apps/api/test/route-permissions.test.js`
- [x] [AI-Review][LOW] 补齐回归覆盖：新增“状态别名拒绝”“静态路由尾斜杠/重复斜杠拒绝”及 `createServer` 非规范尾斜杠拒绝测试，阻断契约与路由规范回归。`apps/api/test/platform.role.api.test.js` `apps/api/test/route-permissions.test.js` `apps/api/test/server.test.js`

## Dev Notes

### Developer Context（开发者必须先读）

- Story 2.3 已交付平台用户治理（`/platform/users`、`/platform/users/status`）与平台域会话收敛路径；Story 2.4 需延续相同错误语义、审计口径与路由门禁机制。
- 当前代码已存在平台角色事实替换接口 `POST /auth/platform/role-facts/replace`，可用于“分配流程”基线；Story 2.4 不应重复发明第二套用户角色分配协议。
- 角色治理需严格保持 `platform`/`tenant` 双域边界，不得将平台角色能力泄漏到组织域。
- Story 2.5 将交付权限树配置与角色分配生效，本故事应避免提前引入大规模重构导致后续故事无法平滑衔接。

### Technical Requirements（实现硬约束）

- 统一错误契约：`application/problem+json`，至少包含 `status`、`detail`、`error_code`、`request_id`、`retryable`（适用时）。
- 新增受保护接口必须显式声明权限码，否则视为门禁失败（fail-closed）。
- 外部 API 字段统一 `snake_case`；内部命名保持现有风格，通过显式映射层转换。
- 角色编码唯一性必须由服务端最终保证（数据库唯一约束 + 服务层冲突映射双保险）。
- 受保护角色（`sys_admin`）仅允许授权分配，不允许编辑或删除定义本身。
- 关键写操作应保持幂等语义一致，避免重复提交导致重复副作用。
- 审计最小字段建议包含：`request_id`、`operator_user_id`、`target_role_id`、`action`、`result`、`error_code`（失败时）。

### Architecture Compliance（架构对齐清单）

- 后端能力落在 `apps/api/src/modules/platform/role.*`（与 `org.*` / `user.*` 平级），避免把平台治理逻辑散落到 `http-routes.js`。
- 鉴权与授权仍通过现有统一链路（`route-permissions` + `authorizeRoute`），不要在 controller/handler 内实现私有鉴权分支。
- 模块间通信遵循 service 边界，禁止跨模块直接操作 repository/store 私有实现。
- 与角色分配链路（`auth.service`）的联动通过显式 service 调用完成，避免绕过会话收敛与审计逻辑。
- 保持 Problem Details、请求追踪 ID、权限声明门禁与 OpenAPI 契约的一致性。

### Library & Framework Requirements（库与框架要求）

- 仓库当前基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-18 实时核验（官方源）：
  - Node.js Latest: `v25.6.1`
  - Node.js Latest LTS: `v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 release notes 可见至 `8.4.8`
- 本故事策略：不做依赖升级；在现有锁定版本上完成平台角色治理能力，保证可回归增量交付。

### File Structure Requirements（建议变更落点）

- 平台角色模块（新增）：
  - `apps/api/src/modules/platform/role.constants.js`
  - `apps/api/src/modules/platform/role.routes.js`
  - `apps/api/src/modules/platform/role.service.js`
- 路由与门禁（修改）：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
- 认证联动（按需修改）：
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约（修改）：
  - `apps/api/src/openapi.js`
- 迁移（建议新增，若当前缺失角色目录存储）：
  - `apps/api/migrations/0009_platform_role_catalog.sql`
  - `apps/api/migrations/0009_platform_role_catalog.down.sql`
- 测试（新增/修改）：
  - `apps/api/test/platform.role.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（测试要求）

- AC1：普通角色治理
  - 创建角色成功，返回可追踪 `role_id`。
  - 编辑角色成功（仅普通角色）。
  - 删除角色成功（仅普通角色，语义可为软删除）。
  - 角色编码冲突返回稳定 409。
- AC2：受保护角色约束
  - 编辑 `sys_admin` 被拒绝，错误码与文案稳定。
  - 删除 `sys_admin` 被拒绝，错误码与文案稳定。
  - 无权限调用返回 403 且不泄露内部实现细节。
- AC3：受保护角色可分配
  - 通过分配流程可为符合条件用户分配 `sys_admin`。
  - 分配成功不应修改 `sys_admin` 角色定义本身。
  - 非法分配（角色不存在/状态不允许）返回稳定错误语义。
- 回归与门禁
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence

- 来自 Story 2.3 的直接经验：
  - 平台治理能力交付必须同步覆盖“实现 + OpenAPI + 回归测试 + route-permissions 声明”。
  - 鉴权链路需统一复用 `authorizeRoute`/预授权上下文，避免出现同一接口双重鉴权分叉。
  - 平台域治理需严格维持域边界，不得影响 `tenant` 域语义。
  - 关键失败路径必须审计可追踪，且错误映射不能随意降级。
- 对 Story 2.4 的约束：
  - 不新增第二套平台角色分配协议。
  - 不绕开现有 `AuthProblemError` 与 Problem Details 返回范式。
  - 不进行破坏性目录重构或框架升级。

### Git Intelligence Summary

- 最近 5 次提交热点集中在：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/modules/platform/*`
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*`
- 可执行结论：
  - Story 2.4 推荐沿用“平台模块新增 + auth 模块联动 + 契约/测试同步”路线。
  - 应采用小步增量与强回归策略，避免大改影响已完成的 2.1/2.2/2.3 能力。

### Latest Tech Information（2026-02-18）

- Node.js 官方发布索引：
  - Latest: `v25.6.1`
  - Latest LTS: `v24.13.1`（Krypton）
- npm registry 最新版本：
  - `@nestjs/core 11.1.14`
  - `typeorm 0.3.28`
  - `mysql2 3.17.2`
  - `ioredis 5.9.3`
- MySQL 8.4 release notes 当前可见至 `8.4.8`。
- 结论：本故事保持依赖版本稳定，重点放在角色治理语义、受保护约束与回归覆盖，而非升级框架。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 当前故事上下文来源：
  - `epics.md`
  - `prd.md`
  - `prd-appendix-legacy-inputs.md`
  - `architecture.md`
  - `ux-design-specification.md`
  - 前序故事 `2-3-平台用户创建与状态管理.md`
  - 最近 5 次 git 提交历史与当前代码结构

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`本轮 CR 新增 2 项 follow-up（1 HIGH、1 MEDIUM）已全部修复并补齐回归；累计门禁通过（check:route-permissions/lint/test）。`

### Project Structure Notes

- 当前仓库已形成 `platform/org`、`platform/user` 双模块模式；Story 2.4 建议新增 `platform/role` 并保持同级组织方式。
- 现有 `auth/platform/role-facts/replace` 已具备角色事实替换与权限快照同步能力，建议作为“分配流程”基线复用。
- 当前迁移仅见 `auth_user_platform_roles`，若实施角色目录治理需新增迁移并保证 MySQL/in-memory 行为一致。

### References

- Epic 2 / Story 2.4（用户故事与 AC）  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.4: 平台角色管理与受保护角色约束]
- FR15 / FR66（平台角色治理与受保护角色约束）  
  [Source: _bmad-output/planning-artifacts/prd.md#平台治理能力（Platform Governance）]
- 受保护角色与角色模型细则  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md#Database Entity Field Catalog (Detailed)]
- 架构边界、命名与门禁规则  
  [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries]
- UX 一致性交互约束（列表/Modal/Drawer/message/loading）  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Journey Patterns]
- 前序故事经验  
  [Source: _bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md]
- 当前实现基线（平台用户治理与角色事实分配）  
  [Source: apps/api/src/modules/platform/user.routes.js]  
  [Source: apps/api/src/modules/platform/user.service.js]  
  [Source: apps/api/src/modules/auth/auth.routes.js]  
  [Source: apps/api/src/modules/auth/auth.service.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/openapi.js]
- 版本核验来源（官方）  
  [Source: https://nodejs.org/dist/index.json]  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-4-平台角色管理与受保护角色约束`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- loaded artifacts: `epics.md` + `prd.md` + `prd-appendix-legacy-inputs.md` + `architecture.md` + `ux-design-specification.md`
- previous story analyzed: `_bmad-output/implementation-artifacts/2-3-平台用户创建与状态管理.md`
- recent git commits analyzed: `fbea8a5`, `c1927c8`, `819a4b1`, `7e753cb`, `d7b34e0`
- live version checks: `nodejs.org/dist/index.json` + `pnpm view` + MySQL 8.4 release notes

### Completion Notes List

- [Dev] 新增 `platform/role` 模块并接入 `GET/POST/PATCH/DELETE /platform/roles`，实现角色目录治理与标准 Problem Details 错误映射。
- [Dev] 引入受保护系统角色约束（`sys_admin` 不可编辑/删除），并补齐角色治理审计事件（操作者、目标角色、请求 ID、失败原因）。
- [Dev] 扩展 auth service/store（memory + mysql）支持 `platform_role_catalog`，新增 0009 迁移与默认 `sys_admin` 种子。
- [Dev] 在 `POST /auth/platform/role-facts/replace` 增加角色目录合法性校验（存在/状态/scope），保持受保护角色可分配边界。
- [Dev] 同步更新 OpenAPI、`route-permissions`、`server` 参数化路由匹配与写接口幂等声明。
- [Dev] 新增与更新测试：平台角色 API、路由权限声明、服务对齐、迁移基线、auth express 稳定性修复；门禁通过：`check:route-permissions`、`lint`、`test`。
- [Dev] 已修复代码审查提出的 6 项问题：幂等参数化隔离、目录校验绕过、memory/mysql `role_id` 一致性、两类回归缺口、全量测试基线修正。
- [Dev] 本轮代码审查补充修复：角色目录缺表改为 fail-closed（503）、补齐缺表回归测试、补齐 `DELETE /platform/roles/{role_id}` 的 OpenAPI `413` 契约与断言。
- [Dev] 本轮复审补充修复：角色目录校验能力缺失与查询异常统一 fail-closed（503）；新增 `ROLE-409-ROLE-ID-CONFLICT` 区分 `role_id/code` 冲突并同步契约与回归。
- [Dev] 本轮复审补充修复：`roles=[]` 也执行目录依赖可用性探测并 fail-closed；新增对应服务层回归；补齐 express“官方迁移启动”用例对 `0008/0009` 的覆盖与清理顺序。
- [Dev] 本轮复审补充修复：`role_id` 可寻址约束（服务+OpenAPI）落地、路由参数 URL 解码下沉到路由层、MySQL 目录查询去 `LOWER(role_id)` 并改为规范化等值匹配，补齐 API/路由/契约回归；修复 express 全量回归中的 `orgs -> users` 外键清理顺序。
- [Dev] 本轮 CR 补充修复：参数化路由拒绝连续斜杠空段；`role_id` 在幂等作用域前统一 `trim+lowercase`，阻断大小写/空白编码路径变体绕过；补齐对应回归并全量门禁通过。
- [Dev] 本轮 CR 补充修复：`roles=[]` 下目录校验统一要求 lookup 能力；参数化路由新增“非法编码/编码斜杠”拒绝策略并补齐回归。
- [Dev] 本轮 CR 补充修复：参数化路由新增“解码后前后空白/控制字符”拒绝策略；`DELETE /platform/roles/:role_id` 幂等哈希忽略请求体漂移并补齐回归。
- [Dev] 本轮 CR 补充修复：平台角色 `status` 输入与 OpenAPI 严格对齐（拒绝 `enabled` 别名）；静态路由拒绝尾斜杠/重复斜杠非规范路径，并补齐 API/路由层回归。

### File List

- `apps/api/migrations/0009_platform_role_catalog.sql`
- `apps/api/migrations/0009_platform_role_catalog.down.sql`
- `apps/api/src/modules/platform/role.constants.js`
- `apps/api/src/modules/platform/role.routes.js`
- `apps/api/src/modules/platform/role.service.js`
- `apps/api/src/modules/auth/auth.routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.role.api.test.js`
- `apps/api/test/auth.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/auth.express.api.test.js`
- `_bmad-output/implementation-artifacts/2-4-平台角色管理与受保护角色约束.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

## Senior Developer Review (AI)

### Reviewer

- 老大（AI） on 2026-02-17
- 老大（AI） on 2026-02-18
- 老大（AI） on 2026-02-18（CR re-run）

### Outcome

- Approved

### Findings (Historical, Resolved)

1. [HIGH] 参数化路由幂等键跨资源串扰：`routeKey` 使用模板路径（`:role_id`），且 `requestHash` 仅基于 `body`。同一用户在不同 `role_id` 上复用同一个 `Idempotency-Key` 时，可能命中错误资源的历史响应。证据：`apps/api/src/server.js:489` `apps/api/src/server.js:1106` `apps/api/src/server.js:1602`
2. [HIGH] AC3 部分未达成：`replacePlatformRoleFacts` 打开了目录校验，但服务层在 `roleCatalogCount <= SYSTEM_PLATFORM_ROLE_IDS.size` 时直接跳过，导致仅存在 `sys_admin` 时可分配不存在角色。证据：`apps/api/src/modules/auth/auth.routes.js:174` `apps/api/src/modules/auth/auth.service.js:2445`
3. [MEDIUM] 后端语义不一致：in-memory store 用大小写敏感键判重 `role_id`，但更新/删除查询按大小写不敏感匹配，和 MySQL 唯一约束行为不一致，存在“本地通过、线上冲突”风险。证据：`apps/api/src/modules/auth/auth.store.memory.js:1034` `apps/api/src/modules/auth/auth.store.memory.js:1064`
4. [MEDIUM] 回归缺口：当前新增测试未覆盖上述两个高风险边界（参数化路由幂等隔离、无自定义角色时未知角色分配拒绝）。证据：`apps/api/test/platform.role.api.test.js:69` `apps/api/test/platform.role.api.test.js:206`

### Findings (Current Re-review, Resolved)

1. [HIGH] `enforceRoleCatalogValidation=true` 时，若 store 未实现 `findPlatformRoleCatalogEntriesByRoleIds` 会直接跳过校验，形成 fail-open。已改为 fail-closed，返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`（`platform-role-catalog-lookup-unsupported`）。证据：`apps/api/src/modules/auth/auth.service.js:2421` `apps/api/src/modules/auth/auth.service.js:2429` `apps/api/test/auth.service.test.js:2487`
2. [MEDIUM] 角色目录查询非缺表异常此前会冒泡成 500，错误语义不稳定。已统一映射为 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`（`platform-role-catalog-query-failed`）。证据：`apps/api/src/modules/auth/auth.service.js:2460` `apps/api/test/auth.service.test.js:2530`
3. [MEDIUM] `role_id` 冲突误映射为 `ROLE-409-CODE-CONFLICT`，不利于调用方定位。已新增 `ROLE-409-ROLE-ID-CONFLICT` 并同步内存 store 冲突目标、OpenAPI 与回归。证据：`apps/api/src/modules/platform/role.service.js:174` `apps/api/src/modules/auth/auth.store.memory.js:104` `apps/api/src/openapi.js:1331` `apps/api/test/platform.role.api.test.js:207`

### Findings (Latest Re-review, Resolved)

1. [HIGH] `enforceRoleCatalogValidation=true` 时，`roles=[]` 会提前返回，导致目录缺表/查询故障未被探测，形成空负载路径 fail-open。已改为“空角色集也探测目录依赖可用性”，统一缺表/查询异常语义。证据：`apps/api/src/modules/auth/auth.service.js:2421` `apps/api/src/modules/auth/auth.service.js:2460` `apps/api/test/auth.service.test.js:2487`
2. [MEDIUM] 缺少“空角色集 + 目录缺表”回归，先前 fail-open 不会被测试拦截。已新增服务层回归并断言 `platform-role-catalog-unavailable`。证据：`apps/api/test/auth.service.test.js:2487`
3. [MEDIUM] MySQL 集成“官方迁移启动”用例未覆盖 0008/0009，且未先清理 `platform_role_catalog`，迁移基线验证与当前故事落地不一致。已补齐迁移链并修正清理顺序。证据：`apps/api/test/auth.express.api.test.js:2551`

### Findings (2026-02-17 CR, Resolved on 2026-02-18)

1. [HIGH] `role_id` 可接受不可寻址字符，导致“创建成功但无法按资源路径更新/删除”的数据可达性缺陷。服务端仅校验长度与控制字符，未限制 URI 保留字符；OpenAPI 同步放宽为 `.*\S.*`。证据：`apps/api/src/modules/platform/role.service.js:239` `apps/api/src/modules/platform/role.service.js:248` `apps/api/src/openapi.js:3054`
2. [MEDIUM] 路由参数提取未执行 URL 解码，编码路径值会原样进入业务层比对，造成误判 404。证据：`apps/api/src/server.js:55` `apps/api/src/server.js:57` `apps/api/src/route-permissions.js:59` `apps/api/src/route-permissions.js:71`
3. [LOW] MySQL 角色目录读取与锁定查询使用 `LOWER(role_id)`，在数据量增长时会增加查询成本并削弱索引利用。证据：`apps/api/src/modules/auth/auth.store.mysql.js:1226` `apps/api/src/modules/auth/auth.store.mysql.js:1257` `apps/api/src/modules/auth/auth.store.mysql.js:1375` `apps/api/src/modules/auth/auth.store.mysql.js:1474`
4. [MEDIUM] 当前回归未覆盖“不可寻址 `role_id` + 编码路径参数”边界，导致上述缺陷可在全绿测试下漏检。证据：`apps/api/test/platform.role.api.test.js:81` `apps/api/test/platform.role.api.test.js:136` `apps/api/test/platform.role.api.test.js:180`

### Findings (2026-02-18 CR, Resolved)

1. [HIGH] `role_id` 可寻址规则已收紧：创建/更新/删除入口统一执行 `^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$` 校验并规范化小写，阻断“可创建不可寻址”数据。证据：`apps/api/src/modules/platform/role.service.js:18` `apps/api/src/modules/platform/role.service.js:59` `apps/api/src/modules/platform/role.service.js:253` `apps/api/src/openapi.js:30` `apps/api/src/openapi.js:3055`
2. [MEDIUM] 路径参数已在路由层解码：`extractRoutePathParams` 对参数段执行 `decodeURIComponent`，编码路径可正确命中资源。证据：`apps/api/src/route-permissions.js:38` `apps/api/src/route-permissions.js:82` `apps/api/test/platform.role.api.test.js:252` `apps/api/test/route-permissions.test.js:181`
3. [LOW] MySQL 目录查询性能风险已消除：`find/update/delete` 全部改为规范化 `role_id` 的等值/IN 查询，移除 `LOWER(role_id)` 热路径。证据：`apps/api/src/modules/auth/auth.store.mysql.js:49` `apps/api/src/modules/auth/auth.store.mysql.js:1228` `apps/api/src/modules/auth/auth.store.mysql.js:1259` `apps/api/src/modules/auth/auth.store.mysql.js:1377` `apps/api/src/modules/auth/auth.store.mysql.js:1476`
4. [MEDIUM] 回归缺口已补齐：新增非法 `role_id` 拒绝、编码路径参数行为、OpenAPI `role_id` 模式断言，并修复 express 全量回归的外键清理顺序。证据：`apps/api/test/platform.role.api.test.js:210` `apps/api/test/platform.role.api.test.js:252` `apps/api/test/server.test.js:112` `apps/api/test/auth.express.api.test.js:438`

### Findings (2026-02-18 CR, Resolved - Path Canonicalization)

1. [HIGH] 参数化路由匹配会折叠连续斜杠空段，导致 `/platform/roles//demo_role` 被错误命中 `PATCH /platform/roles/:role_id` 并执行写操作。已在路由匹配层拒绝连续斜杠路径。证据：`apps/api/src/route-permissions.js:26` `apps/api/src/route-permissions.js:50` `apps/api/test/platform.role.api.test.js:404` `apps/api/test/route-permissions.test.js:191`
2. [MEDIUM] `:role_id` 在业务层会做 `trim+lowercase`，但幂等作用域此前使用未规范化路径参数，导致同资源大小写/空白编码变体可绕过 `AUTH-409-IDEMPOTENCY-CONFLICT`。已在分发层先规范化 `role_id` 再参与幂等作用域。证据：`apps/api/src/server.js:496` `apps/api/src/server.js:1992` `apps/api/test/platform.role.api.test.js:439`
3. [MEDIUM] 缺少上述异常路径与规范化幂等边界回归，缺陷可在全绿门禁下漏检。已补充 API 与路由声明回归。证据：`apps/api/test/platform.role.api.test.js:404` `apps/api/test/platform.role.api.test.js:439` `apps/api/test/route-permissions.test.js:191`

### Findings (2026-02-18 CR, Resolved - Catalog Validation & Path Decode Hardening)

1. [HIGH] `enforceRoleCatalogValidation=true` 且 `roles=[]` 时，如果 store 仅暴露 `countPlatformRoleCatalogEntries` 而缺少 `findPlatformRoleCatalogEntriesByRoleIds`，会被错误放行。已改为统一要求 lookup 能力，缺失时返回 `AUTH-503-PLATFORM-SNAPSHOT-DEGRADED`（`platform-role-catalog-lookup-unsupported`）。证据：`apps/api/src/modules/auth/auth.service.js` `apps/api/test/auth.service.test.js`
2. [MEDIUM] 参数化路由在路径参数 URL 解码失败时仍可继续匹配并下沉到业务层，造成错误分类不稳定。已改为 decode 失败直接判定“路由不匹配”。证据：`apps/api/src/route-permissions.js` `apps/api/test/route-permissions.test.js` `apps/api/test/platform.role.api.test.js`
3. [MEDIUM] 参数化路由此前允许 `%2F` 编码斜杠值匹配 `:role_id`，存在路径语义歧义。已改为“解码后含 `/` 的参数段不匹配路由”。证据：`apps/api/src/route-permissions.js` `apps/api/test/route-permissions.test.js`

### Findings (2026-02-18 CR, Resolved - Decoded Segment Hygiene & DELETE Idempotency)

1. [HIGH] 参数化路由此前仅校验“可解码/不含 `/`”，未拒绝解码后前后空白与控制字符；`%20role_id`、`role_id%20`、`%09` 仍可能命中 `:role_id` 并进入业务层。已在匹配与提取阶段统一收紧为“非空、无前后空白、无控制字符、无 `/`”。证据：`apps/api/src/route-permissions.js:52` `apps/api/src/route-permissions.js:75` `apps/api/test/route-permissions.test.js:207` `apps/api/test/route-permissions.test.js:221` `apps/api/test/platform.role.api.test.js:462`
2. [MEDIUM] `DELETE /platform/roles/:role_id` 幂等冲突判定此前包含请求体，导致同资源同 `Idempotency-Key` 的 body 漂移请求错误返回 `AUTH-409-IDEMPOTENCY-CONFLICT`。已将 DELETE 路由纳入“请求哈希忽略 body”集合，仅按 `route_params` 判定。证据：`apps/api/src/server.js:127` `apps/api/src/server.js:1136` `apps/api/test/platform.role.api.test.js:571`

### Findings (2026-02-18 CR, Resolved - Status Contract & Static Path Canonicalization)

1. [MEDIUM] 平台角色治理实现接受 `status=enabled` 别名，但 OpenAPI 契约仅声明 `active|disabled`，存在契约漂移风险。已收紧 `POST/PATCH /platform/roles` 输入校验，拒绝未声明别名并保持输出语义稳定。证据：`apps/api/src/modules/platform/role.service.js` `apps/api/test/platform.role.api.test.js`
2. [MEDIUM] 静态路由存在非规范路径放行：`/platform/roles/` 与 `/platform/roles//` 会被折叠命中，未严格 fail-closed。已在路由分发层增加非规范路径短路拒绝，统一返回 `AUTH-404-NOT-FOUND`。证据：`apps/api/src/server.js` `apps/api/test/platform.role.api.test.js`
3. [LOW] 缺少“状态别名拒绝 + 静态路径规范化拒绝”回归，导致上述问题可在全绿门禁下漏检。已新增 API、路由声明与 `createServer` 回归。证据：`apps/api/test/platform.role.api.test.js` `apps/api/test/route-permissions.test.js` `apps/api/test/server.test.js`

### Findings (2026-02-18 CR Re-run, No New Issues)

- 本轮对 Story 2.4 关联实现与测试进行复审，未发现新增 HIGH/MEDIUM/LOW 问题。
- 关键核验：AC 与任务声明、route-permissions 声明门禁、lint、全量 test（530/530）均通过。

### Validation Notes

- 已执行：`pnpm --dir apps/api exec node --test test/auth.service.test.js`（通过）
- 已执行：`pnpm --dir apps/api exec node --test --test-name-pattern="createApiApp boots with auth schema created only from official migrations" test/auth.express.api.test.js`（通过）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/route-permissions.test.js test/server.test.js`（通过）
- 已执行：`pnpm --dir apps/api exec node --test test/auth.service.test.js test/platform.role.api.test.js test/route-permissions.test.js test/server.test.js`（通过）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/auth.service.test.js test/server.test.js`（通过）
- 已执行：`pnpm --dir apps/api check:route-permissions`（通过）
- 已执行：`pnpm --dir apps/api lint`（通过）
- 已执行：`pnpm --dir apps/api test`（通过）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/auth.service.test.js test/route-permissions.test.js test/server.test.js`（通过，228/228）
- 已执行：`pnpm --dir apps/api check:route-permissions`（通过，Route permission declaration check passed）
- 已执行：`pnpm --dir apps/api lint`（通过，Lint passed (51 files checked)）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/route-permissions.test.js test/server.test.js test/auth.store.mysql.test.js`（通过，165/165）
- 已执行：`pnpm --dir apps/api test`（通过，516/516）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/route-permissions.test.js`（通过，46/46）
- 已执行：`pnpm --dir apps/api check:route-permissions`（通过，Route permission declaration check passed）
- 已执行：`pnpm --dir apps/api lint`（通过，Lint passed (51 files checked)）
- 已执行：`pnpm --dir apps/api test`（通过，516/516）
- 已执行：`pnpm --dir apps/api exec node --test test/platform.role.api.test.js test/route-permissions.test.js test/server.test.js`（通过）
- 已执行：`pnpm --dir apps/api exec node --test test/route-permissions.test.js test/platform.role.api.test.js`（通过，56/56）
- 已执行：`pnpm --dir apps/api exec node --test test/server.test.js`（通过，59/59）
- 已执行：`pnpm --dir apps/api check:route-permissions`（通过，Route permission declaration check passed）
- 已执行：`pnpm --dir apps/api lint`（通过，Lint passed (51 files checked)）
- 额外复现 1：同一 `Idempotency-Key` 连续删除 `/platform/roles/role_a` 与 `/platform/roles/role_b`，第二次返回 `role_a` 响应并命中 `auth.idempotency.hit`
- 额外复现 2：仅系统角色存在时，`POST /auth/platform/role-facts/replace` 可将不存在角色写入，返回 200
- 额外复现 3：创建 `role_id='role with space'` 返回 200，但对 `/platform/roles/role%20with%20space` 执行 PATCH 返回 404（`ROLE-404-ROLE-NOT-FOUND`）。
- 额外复现 4：创建 `role_id='role/with/slash'` 返回 200，但对 `/platform/roles/role%2Fwith%2Fslash` 执行 PATCH 返回 404（`ROLE-404-ROLE-NOT-FOUND`）。
- 已执行：`pnpm --dir apps/api check:route-permissions`（通过，Route permission declaration check passed）
- 已执行：`pnpm --dir apps/api lint`（通过，Lint passed (51 files checked)）
- 已执行：`pnpm --dir apps/api test`（通过，530/530）

### Change Log

- 2026-02-18: CR re-run（Story 2.4）完成；未发现新增问题；门禁复核通过：`check:route-permissions`、`lint`、`test`（530/530）。
- 2026-02-18: CR closed 3 additional findings（平台角色 `status` 拒绝未声明别名 `enabled`、静态路由拒绝尾斜杠/重复斜杠非规范路径、补齐对应回归）；门禁通过：`node --test test/route-permissions.test.js test/platform.role.api.test.js`、`node --test test/server.test.js`、`check:route-permissions`、`lint`。
- 2026-02-18: CR closed 2 additional findings（参数化路由拒绝解码后前后空白/控制字符参数段命中、`DELETE /platform/roles/:role_id` 幂等哈希忽略 body 漂移）；补齐回归并通过针对性测试。
- 2026-02-18: CR closed 3 additional findings（`roles=[]` 在 count-only store 下 lookup 能力缺失放行、参数段非法 URL 编码命中、参数段编码斜杠命中）；补齐 `auth.service/route-permissions/platform.role.api` 回归并保持门禁通过。
- 2026-02-18: CR closed 3 additional findings（参数化路由连续斜杠命中、`role_id` 路径变体幂等绕过、对应回归缺口）；新增路径规范化与幂等规范化回归，门禁通过：`check:route-permissions`、`lint`、`test`（516/516）。
- 2026-02-18: Re-review closed all 4 open findings（`role_id` 可寻址约束、路径参数 URL 解码、MySQL `role_id` 查询可索引优化、对应回归缺口）；门禁通过：`check:route-permissions`、`lint`、`test`（516/516）；故事状态更新为 `done`。
- 2026-02-17: New CR run found 4 open issues（`role_id` 可寻址约束缺失、路径参数未解码、MySQL `LOWER(role_id)` 查询性能风险、对应回归缺口）；状态更新为 `in-progress`，已新增 follow-up。
- 2026-02-18: Re-review fixed 3 additional issues（`roles=[]` 目录探测 fail-open、对应缺表回归缺口、express 官方迁移启动未覆盖 0008/0009），补齐回归并保持状态 `done`。
- 2026-02-17: Added Senior Developer Review findings and AI follow-up action items; story status set to `in-progress`.
- 2026-02-17: Resolved all 6 review issues, added regression coverage, and moved story status back to `review`.
- 2026-02-17: Re-review fixed 3 remaining issues（缺表 fail-open、OpenAPI 413 漏项、File List 漏报），补充回归并将故事状态更新为 `done`。
- 2026-02-17: Re-review fixed 3 additional issues（角色目录能力缺失 fail-open、目录查询异常 500 泄露、`role_id`/`code` 冲突错误码混淆），补齐回归并保持状态 `done`。
