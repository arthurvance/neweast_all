# Story 4.3: 受控系统配置治理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 授权操作者,  
I want 维护受控系统配置并可审计,  
so that 安全策略变更可控且可追踪。

## Acceptance Criteria

1. **Given** 授权操作者更新受控配置  
   **When** 配置校验通过  
   **Then** 系统保存新配置并记录变更审计  
   **And** 配置生效范围与版本可追踪
2. **Given** 未授权用户尝试修改受控配置  
   **When** 请求提交  
   **Then** 系统拒绝请求  
   **And** 返回统一权限错误语义

## Tasks / Subtasks

- [x] 任务 1：建立受控配置持久化与版本模型（AC: 1）
  - [x] 新增迁移脚本（建议 `0019_*`）创建受控配置表，至少覆盖：`config_key`、`encrypted_value`、`version`、`updated_by_user_id`、`updated_at`、`status`（可选）与审计辅助字段。
  - [x] `config_key` 使用唯一约束并限制为白名单可治理项（首批必须包含 `auth.default_password`）。
  - [x] 更新流程使用乐观并发（`expected_version`）防止覆盖写，冲突时返回可识别错误。
  - [x] 明确数据语义：库内只存密文，不存明文配置值。

- [x] 任务 2：落地平台侧受控配置 API（AC: 1, 2）
  - [x] 新增平台域路由（建议 `GET /platform/system-configs/:config_key`、`PUT /platform/system-configs/:config_key`）。
  - [x] `PUT` 仅接受白名单键与受控 payload，拒绝未知 key、空值、非法版本参数。
  - [x] 响应遵循现有成功结构 `{ data, meta? }` 与 Problem Details 错误结构，不引入第二套响应契约。
  - [x] 保留 `request_id`、`traceparent` 贯穿（沿用 4.2 已完成链路）。

- [x] 任务 3：权限声明与授权判定接线（AC: 2）
  - [x] 在 `route-permissions` 为新增接口声明受保护路由，不允许漏声明。
  - [x] 引入受控配置权限码（建议：`platform.system_config.view`、`platform.system_config.operate`），并与 scope=`platform` 对齐。
  - [x] 在授权评估器中补齐上述权限码判定，保持 fail-closed。
  - [x] 补充权限清单/角色授权初始化逻辑，确保可赋权、可测、可回归。

- [x] 任务 4：与默认密码策略链路对接（AC: 1）
  - [x] 将 `auth.default_password` 的读取来源从“仅环境变量”升级为“受控配置优先 + 明确降级语义”。
  - [x] 复用现有密文信封与解密逻辑（`enc:v1` + AES-256-GCM + PBKDF2 派生）以避免重复造轮子。
  - [x] 严格保持 `NFR24/NFR25`：不落明文、不回显明文、不在日志/审计中写入敏感明文。
  - [x] 受控配置不可用时延续可观测降级语义（现有 `default-password-config-unavailable` 风格）。

- [x] 任务 5：审计与可追踪性闭环（AC: 1, 2）
  - [x] 对配置变更写入审计事件：操作者、对象 key、变更前后版本、结果、`request_id`、`traceparent`。
  - [x] `before/after` 仅记录安全元数据（版本、更新时间、操作者、策略摘要），不得记录明文秘密。
  - [x] 未授权访问和校验失败同样产生日志/审计记录，便于追责与排障。
  - [x] 与 4.1/4.2 对齐：审计可按域查询，链路可跨日志/审计/错误响应关联。

- [x] 任务 6：OpenAPI 与错误码契约补齐（AC: 1, 2）
  - [x] 更新 `openapi.js`：新增受控配置接口 schema、请求/响应示例、错误响应示例。
  - [x] 新增并固化冲突/未授权/依赖降级语义（如版本冲突、权限不足、配置依赖不可用）。
  - [x] 确保错误响应全部走 Problem Details 并含 `request_id`、`traceparent`（可空）稳定字段。

- [x] 任务 7：测试与门禁（AC: 1, 2）
  - [x] 新增 API 回归：授权写成功、未授权拒绝、版本冲突、非法 key/payload、审计落库与查询可见。
  - [x] 新增服务层测试：白名单校验、并发写保护、密文保护（不泄漏明文）。
  - [x] 新增路由权限声明测试：防止新增受保护路由漏声明或 scope 错配。
  - [x] 全量通过 `pnpm --dir apps/api lint` 与 `pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复受控配置更新失败时的审计重复落库：`system-config.service` 与 `auth.service` 双路径同时写入 `auth.system_config.update.rejected`，导致单次失败产生重复审计事件；已移除服务层重复持久化并补 API 回归断言（`apps/api/src/modules/platform/system-config.service.js`、`apps/api/test/system-config.api.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 `encrypted_value` 校验过宽问题：此前仅校验“非空字符串”，会接收无效密文并把错误延迟到后续解密链路；已收紧为 `enc:v1` 密文信封格式校验并补服务/API 回归（`apps/api/src/modules/platform/system-config.service.js`、`apps/api/test/system-config.service.test.js`、`apps/api/test/system-config.api.test.js`）。
- [x] [AI-Review][MEDIUM] 修复默认密码配置读取语义漂移：运行时受控配置 `status=disabled` 仍会被当作可用值，同时 mock backend 路径未绑定运行时 authStore；已改为 `disabled` 自动降级环境变量并补 provider 回归（`apps/api/src/app.js`、`apps/api/test/app.sensitive-config-provider.test.js`）。
- [x] [AI-Review][HIGH] 修复 `platform.system_config.*` 授权与 `member_admin` 快照耦合导致的越权风险：系统配置路由原先可被 `member_admin` 权限旁路授权，且 MySQL 角色授予映射会把 `system_config` 误并入 `member_admin`；已改为显式 `system_config` 授权查询并补“仅 member_admin 也拒绝”回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/system-config.api.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] 修复系统配置授权查询未过滤禁用角色目录的问题：`hasPlatformPermissionByUserId` 现要求角色目录满足 `scope=platform`、`tenant_id=''` 且 `status in ('active','enabled')`，避免禁用目录角色继续授权（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/test/auth.store.mysql.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 修复系统配置写入接口 409 冲突的幂等键占用问题：将 `/platform/system-configs/:config_key` 的 409 归入非缓存状态，保证版本冲突不会保留幂等键（`apps/api/src/server.js`、`apps/api/test/server.test.js`）。

## Dev Notes

### Developer Context（开发者必须先读）

- Epic 4 的上下文顺序是：`4.1 审计落库与按域查询` → `4.2 request_id/traceparent 跨链路贯穿` → `4.3 受控配置治理`。本故事必须直接复用 4.1/4.2 能力，不可另起一套审计/追踪机制。
- 当前默认密码策略读取点已存在：
  - `apps/api/src/app.js` 通过 `createEnvSensitiveConfigProvider` 提供 `auth.default_password` 密文。
  - `apps/api/src/modules/auth/auth.service.js` 通过 `resolveDefaultProvisioningPassword` 解密并校验策略。
- 当前缺口：缺少“可治理、可版本追踪、可按权限控制”的系统配置管理接口与持久化模型。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR46`（受控系统配置治理）。
- 强相关：`FR42/FR45`（关键配置变更审计 + before/after 保留）。
- NFR 约束：
  - `NFR24`：默认密码配置必须受保护存储并通过环境密钥解密。
  - `NFR25`：明文密码/敏感值不得存储、返回、记录到日志审计。
  - `NFR22`：必须提供可归档验证证据（测试报告、门禁记录）。

### Architecture Compliance（架构对齐清单）

- API 契约：REST + OpenAPI，错误统一 Problem Details（不新增第二套错误结构）。
- 权限门禁：新增受保护接口必须声明权限码并通过 route-permission preflight。
- 追踪一致性：沿用 4.2 的 `request_id`/`traceparent` 传递、回写、审计关联规则。
- 数据边界：迁移脚本版本化；禁止手工改库；配置写入需可审计、可追踪、可冲突识别。
- 模块边界：优先落在 `platform` 模块与现有 `auth store` 能力边界内，避免跨模块 repository 互调。

### Library & Framework Requirements（库与框架要求）

- 当前工程版本（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `ioredis`: `5.9.2`
  - `mysql2`: `^3.17.0`
- 最新稳定核验（2026-02-21）：
  - Node.js LTS：`v24.13.1`（Krypton，发布日期 2026-02-09）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `ioredis`: `5.9.3`
  - `mysql2`: `3.17.4`
- 本故事优先保证行为正确与契约一致，不以依赖升级为交付前置条件；若升级版本，必须补齐回归。

### File Structure Requirements（建议变更落点）

- 迁移：
  - `apps/api/migrations/0019_system_sensitive_configs.sql`
  - `apps/api/migrations/0019_system_sensitive_configs.down.sql`
- 路由与服务（建议新增）：
  - `apps/api/src/modules/platform/system-config.constants.js`
  - `apps/api/src/modules/platform/system-config.routes.js`
  - `apps/api/src/modules/platform/system-config.service.js`
- 主接线与契约：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
- 既有能力复用点（重点改造）：
  - `apps/api/src/app.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 测试：
  - `apps/api/test/system-config.api.test.js`
  - `apps/api/test/system-config.service.test.js`
  - `apps/api/test/route-permissions.test.js`（新增断言）
  - `apps/api/test/auth.service.test.js`（默认密码策略来源切换回归）

### Testing Requirements（必须覆盖）

- AC1：
  - 授权写入成功、版本递增、版本冲突可识别。
  - 审计记录可查询，且 `request_id`/`traceparent` 可关联。
  - 受控配置生效范围与版本元数据可追踪。
- AC2：
  - 未授权访问稳定拒绝，错误语义统一（Problem Details）。
  - 路由权限声明存在且 scope 正确，漏声明必须被门禁阻断。
- 安全回归：
  - 不返回/记录明文敏感值。
  - 审计 before/after 不含明文 secrets。
  - 解密失败/缺配置时返回受控降级语义。

### Previous Story Intelligence（来自 4.2）

- 追踪字段必须 fail-closed 且跨层一致：`server -> routes -> service -> store -> audit -> Problem Details`。
- 所有关键链路改动都要同步更新 OpenAPI 与回归测试，避免契约/实现漂移。
- 修复顺序实践有效：先打通分发接线，再固化持久层/审计，最后补契约与测试门禁。
- 4.2 已证明并发与重放场景容易出现“字段错绑”；4.3 的版本冲突与审计写入必须优先覆盖并发回归。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交集中于 `4.1` 与 `4.2` 的“审计 + 追踪 + 权限 + 契约 + 回归”闭环。
- 高频改动路径：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/modules/auth/*.js`
  - `apps/api/src/modules/audit/*.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/*.test.js`
- 对 4.3 的直接启示：沿用同一实现节奏（路由声明 -> 服务逻辑 -> 存储层 -> 审计 -> OpenAPI -> 测试），降低回归成本。

### Latest Tech Information（外部最新信息）

- Node.js 官方发布索引显示 LTS 线为 `v24.13.1`（Krypton，2026-02-09）。
- npm registry 显示：
  - `@nestjs/core` 最新 `11.1.14`
  - `typeorm` 最新 `0.3.28`
  - `ioredis` 最新 `5.9.3`
  - `mysql2` 最新 `3.17.4`
- 本故事涉及敏感配置治理，优先关注“契约稳定 + 安全语义 + 审计可追踪”，再考虑依赖升级。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文依据：
  - `epics.md`（Epic 4 / Story 4.3）
  - `prd.md`（FR46、NFR24、NFR25）
  - `architecture.md`（Problem Details、权限声明门禁、审计与可追踪约束）
  - `4-2-请求追踪关联与跨链路可观测.md`（上一故事可复用实现经验）

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review findings fixed; lint and full test suite passed.`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.3）
- `_bmad-output/planning-artifacts/prd.md`（FR46，NFR24，NFR25）
- `_bmad-output/planning-artifacts/architecture.md`（API 契约、错误模型、审计与门禁约束）
- `_bmad-output/implementation-artifacts/4-2-请求追踪关联与跨链路可观测.md`（追踪与审计落地经验）
- `apps/api/src/app.js`（现有环境密文配置提供方）
- `apps/api/src/modules/auth/auth.service.js`（默认密码策略读取与解密逻辑）
- `apps/api/src/route-permissions.js`（受保护路由声明与权限门禁）
- `apps/api/src/openapi.js`（契约单一事实源）

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/system-config.service.test.js test/system-config.api.test.js test/route-permissions.test.js test/server.test.js test/migrate-baseline.test.js`（pass）
- `pnpm --dir apps/api lint`（pass）
- `pnpm --dir apps/api test`（初次失败：`test/auth.express.api.test.js` 平台创建用户场景返回 503）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`（修复后 pass，`51/51`）
- `pnpm --dir apps/api test`（最终 pass，`969/969`）
- `pnpm --dir apps/api exec node --test test/app.sensitive-config-provider.test.js test/system-config.service.test.js test/system-config.api.test.js`（pass）
- `pnpm --dir apps/api lint`（pass，`73 files checked`）
- `pnpm --dir apps/api test`（pass，`974/974`）
- `node --test apps/api/test/auth.store.mysql.test.js apps/api/test/system-config.api.test.js`（pass，`117/117`）
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js test/server.test.js`（pass，`465/465`）

### Completion Notes List

- 已完成 4.3 受控系统配置治理主链路：新增 `system_sensitive_configs` 迁移、平台配置读写路由/服务、权限声明与 OpenAPI 契约，并接入审计与追踪字段。
- 已将默认密码来源升级为“受控配置优先 + 环境变量降级”，复用既有密文信封解密链路并保持敏感值不回显。
- 已补齐服务/API/路由权限/迁移基线回归测试；全量质量门禁通过（`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`）。
- 已修复 express 集成回归：补齐测试库迁移与受控配置种子数据，校正迁移依赖顺序，消除平台创建用户场景 503。
- 已完成本轮 CR 自动修复：消除冲突写失败审计重复落库、收紧密文信封格式校验、修正运行时 `disabled` 配置降级语义并补充回归测试。
- 已完成后续 CR 修复：系统配置权限从 `member_admin` 快照判定改为显式 `platform.system_config.*` 授权判定，并在 MySQL store 与 API 回归中验证“仅 member_admin 不可访问系统配置”。
- 已完成本轮 CR 续修：补齐系统配置权限查询对角色目录 `status/scope/tenant` 约束，并修正系统配置写入 409 冲突的幂等键占用策略；新增服务层与分发层回归验证。

### Senior Developer Review (AI)

- [HIGH] 单次版本冲突会落两条 `auth.system_config.update.rejected` 审计事件，破坏追踪唯一性；已修复并补断言（`apps/api/src/modules/platform/system-config.service.js`、`apps/api/test/system-config.api.test.js`）。
- [MEDIUM] `encrypted_value` 缺少密文信封格式校验，会把无效输入推迟为运行时解密故障；已收紧 payload 校验并补测试（`apps/api/src/modules/platform/system-config.service.js`、`apps/api/test/system-config.service.test.js`）。
- [MEDIUM] 运行时默认密码读取未尊重 `status=disabled`，且 mock 路径未接 runtime store，导致“受控配置优先 + 降级语义”在部分路径失效；已修复并补回归（`apps/api/src/app.js`、`apps/api/test/app.sensitive-config-provider.test.js`）。
- [HIGH] `platform.system_config.*` 授权此前复用 `member_admin` 快照，存在权限边界漂移与越权窗口；已改为显式系统配置权限查询，并补充 MySQL store 与 API 反向用例（`apps/api/src/modules/auth/auth.service.js`、`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/system-config.api.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [HIGH] `hasPlatformPermissionByUserId` 曾允许命中禁用或非平台角色目录，存在系统配置权限越权窗口；已补目录状态/域过滤并新增服务+MySQL 回归（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.service.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [MEDIUM] `/platform/system-configs/:config_key` 的 409 版本冲突此前会占用幂等键，不符合“非持久响应不占键”语义；已将 409 归入非缓存集合并补分发层回归（`apps/api/src/server.js`、`apps/api/test/server.test.js`）。

### File List

- `_bmad-output/implementation-artifacts/4-3-受控系统配置治理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0019_system_sensitive_configs.down.sql`
- `apps/api/migrations/0019_system_sensitive_configs.sql`
- `apps/api/src/app.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/platform/system-config.constants.js`
- `apps/api/src/modules/platform/system-config.routes.js`
- `apps/api/src/modules/platform/system-config.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/app.sensitive-config-provider.test.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/system-config.api.test.js`
- `apps/api/test/system-config.service.test.js`

## Change Log

- 2026-02-21：完成 Story 4.3 主体实现，交付受控系统配置持久化、平台配置治理 API、权限接线、默认密码链路对接与 OpenAPI 契约更新。
- 2026-02-21：新增并通过系统配置服务/API/路由权限/迁移基线回归测试，覆盖授权写入、未授权拒绝、版本冲突、非法入参与审计关联。
- 2026-02-21：修复 express 集成回归（默认密码受控配置读取与测试迁移依赖），最终 `apps/api` lint 与全量测试均通过。
- 2026-02-21：完成 CR 自动修复：去除更新失败审计重复落库、收紧 `enc:v1` 密文信封校验、修正运行时 `disabled` 配置降级与 mock runtime store 绑定；`apps/api` lint 与全量测试 `974/974` 通过。
- 2026-02-21：完成 CR 续修：系统配置权限查询增加角色目录状态/范围约束，且将系统配置 409 版本冲突纳入幂等非缓存状态；定向回归 `465/465` 通过。
