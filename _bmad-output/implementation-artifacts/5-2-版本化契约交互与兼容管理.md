# Story 5.2: 版本化契约交互与兼容管理

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 集成开发者,
I want 按版本化契约执行外部接口交互并维护兼容策略,
so that 集成升级可控且不破坏现网调用。

## Acceptance Criteria

1. **Given** 系统对接外部 API 或事件协议  
   **When** 执行接口调用  
   **Then** 请求与响应遵循声明的版本化契约  
   **And** 契约版本变更被记录与可追踪
2. **Given** 引入新接口版本  
   **When** 执行兼容性评估  
   **Then** 系统可判定向后兼容状态  
   **And** 不兼容版本需阻断直接上线

## Tasks / Subtasks

- [x] 任务 1：落地“契约版本 + 兼容评估”数据模型（AC: 1, 2）
  - [x] 新增迁移 `apps/api/migrations/0022_platform_integration_contract_versions.sql`（及 down）：创建契约版本主表（建议 `platform_integration_contract_versions`）与兼容评估记录表（建议 `platform_integration_contract_compatibility_checks`）。
  - [x] 契约版本表至少覆盖：`integration_id`、`contract_type`（`openapi|event`）、`contract_version`、`schema_ref`、`schema_checksum`、`status`（`candidate|active|deprecated|retired`）、`is_backward_compatible`、`compatibility_notes`、`created_by_user_id`、`updated_by_user_id`、`created_at`、`updated_at`。
  - [x] 兼容评估表至少覆盖：`integration_id`、`baseline_version`、`candidate_version`、`evaluation_result`（`compatible|incompatible`）、`breaking_change_count`、`diff_summary`、`request_id`、`checked_by_user_id`、`checked_at`。
  - [x] 约束：`(integration_id, contract_type, contract_version)` 唯一；仅允许 `active` 契约参与“生产交互执行”。

- [x] 任务 2：实现 store 层契约能力（MySQL + in-memory 语义一致）（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/auth/auth.store.mysql.js` 增加契约版本 CRUD、兼容评估写入、激活版本切换、最新激活版本读取能力。
  - [x] 在 `apps/api/src/modules/auth/auth.store.memory.js` 实现同名同语义方法，保证本地与持久化一致。
  - [x] 继续沿用 fail-closed：依赖返回畸形数据、时间字段异常、关键枚举不合法时统一转 `503`。
  - [x] 禁止静默截断/静默容错（沿用 5.1 修复经验）。

- [x] 任务 3：扩展平台治理 API 与权限声明（AC: 1, 2）
  - [x] 新增（或拆分）契约治理路由/服务（建议 `apps/api/src/modules/platform/integration-contract.routes.js`、`integration-contract.service.js`、`integration-contract.constants.js`）。
  - [x] 建议接口：
    - `GET /platform/integrations/:integration_id/contracts`
    - `POST /platform/integrations/:integration_id/contracts`
    - `POST /platform/integrations/:integration_id/contracts/compatibility-check`
    - `POST /platform/integrations/:integration_id/contracts/:contract_version/activate`
  - [x] 在 `apps/api/src/route-permissions.js` 为新增受保护路由声明权限码，并通过 `check:route-permissions`。
  - [x] 在 `apps/api/src/server.js` 将新增写接口纳入幂等保护键集合（沿用已有 `Idempotency-Key` 机制）。

- [x] 任务 4：实现“按版本化契约执行交互”的运行时守卫（AC: 1）
  - [x] 新增 `apps/api/src/modules/integration/`（建议至少包含 `contract-resolver.js`），统一按 `version_strategy` 解析“本次调用应使用的契约版本”。
  - [x] 对出站调用与入站回调校验入口，记录“实际使用契约版本”，并确保与激活版本一致；不一致时 fail-closed。
  - [x] 将契约执行与目录生命周期联动：`lifecycle_status != active` 时禁止生产交互执行（复用 5.1 `effective_invocation_enabled` 语义）。

- [x] 任务 5：兼容性评估与上线阻断策略（AC: 2）
  - [x] 实现兼容评估结果模型：至少输出 `compatible|incompatible` 与 breaking 细项摘要。
  - [x] 对“不兼容版本激活”实施阻断（返回稳定冲突语义，建议 409 + 明确 `error_code`）。
  - [x] 将“通过兼容评估后才能激活”的规则固化在服务层，禁止仅靠前端控制。
  - [x] 本故事只实现“版本兼容判定与阻断”；Story 5.3 再实现“发布前全量契约一致性门禁流程”。

- [x] 任务 6：OpenAPI 契约、错误码与审计追踪补齐（AC: 1, 2）
  - [x] 更新 `apps/api/src/openapi.js`：新增契约版本与兼容评估相关 path/schema/example。
  - [x] 补齐错误语义：`integration_contract_not_found`、`integration_contract_incompatible`、`integration_contract_activation_blocked` 等，保持 Problem Details 结构一致。
  - [x] 审计事件至少覆盖：`platform.integration.contract.created`、`platform.integration.contract.compatibility_evaluated`、`platform.integration.contract.activated`。
  - [x] 所有审计与错误响应都必须带 `request_id`，可透传 `traceparent`。

- [x] 任务 7：测试与门禁（AC: 1, 2）
  - [x] 新增 `apps/api/test/platform.integration.contract.api.test.js`：覆盖创建版本、列表、兼容评估、激活、阻断路径。
  - [x] 扩展 store 测试：覆盖唯一冲突、非法状态、畸形依赖返回、MySQL 与 memory 语义一致。
  - [x] 扩展 `apps/api/test/route-permissions.test.js`、`apps/api/test/http-routes.test.js`、`apps/api/test/migrate-baseline.test.js`。
  - [x] 必过门禁：
    - `pnpm --dir apps/api check:route-permissions`
    - `pnpm --dir apps/api lint`
    - `pnpm --dir apps/api test`

- [x] Review Follow-ups (AI)
  - [x] [AI-Review][HIGH] 修复激活路径 `baseline_version` 可伪造导致兼容评估绕过的问题，并补充阻断回归测试。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复兼容评估与激活路径部分 store 读取异常未统一映射的问题，确保稳定返回 Problem Details `503`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复集成不存在时错误码与契约不一致问题，统一为 `integration_contract_not_found` 并返回 `integration_id`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复 MySQL 激活路径未锁定同一 `integration_id + contract_type` 全量契约行导致并发双活风险，补充作用域锁回归断言。(`apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/test/auth.store.mysql.test.js`)
  - [x] [AI-Review][MEDIUM] 修复 `version_strategy` 在 malformed/unsupported/缺少 header|query 值时静默回退 `active` 的 fail-open 问题，改为 fail-closed。(`apps/api/src/modules/integration/contract-resolver.js`, `apps/api/src/modules/integration/index.js`, `apps/api/test/integration.contract-resolver.test.js`)
  - [x] [AI-Review][MEDIUM] 修复兼容评估 `diff_summary` 超长输入被误映射为 `503` 的语义错误，改为稳定 `400 integration_contract_invalid_payload` 并补齐回归。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复迁移 `idx_platform_integration_contract_active_lookup` 与活跃契约查询排序列不一致（`created_at` vs `updated_at`）导致索引失配问题。(`apps/api/migrations/0022_platform_integration_contract_versions.sql`, `apps/api/test/migrate-baseline.test.js`)
  - [x] [AI-Review][MEDIUM] 修复兼容评估最新记录查询缺少 `(baseline_version, candidate_version)` 复合索引导致大表扫描风险。(`apps/api/migrations/0022_platform_integration_contract_versions.sql`, `apps/api/test/migrate-baseline.test.js`)
  - [x] [AI-Review][LOW] 修复 OpenAPI `schema_checksum` 正则仅允许小写与服务端可接受大小写不一致的问题，统一为大小写十六进制。(`apps/api/src/openapi.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复激活路径将“畸形 active 契约读取结果”误判为“无 active 基线”导致兼容校验绕过的 fail-open 问题，改为稳定 `503` 阻断。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复兼容评估路径将“畸形 baseline/candidate 读取结果”误判为可用记录的问题，改为稳定 `503` fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复激活路径将“畸形 candidate 读取结果”误映射为 `404 not found` 的语义偏差，统一为依赖异常 `503`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复激活路径将“畸形 latest compatibility check 读取结果”误判为 `missing_compatibility_check` 的语义漂移，改为稳定 `503` fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复兼容评估在 `diff_summary` 为数组且未显式传 `breaking_change_count` 时默认 `0` 导致的 fail-open 误判，改为按数组长度推导 breaking 数。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复运行时契约解析在显式传入畸形 `requestedContractVersion` 时静默回退 `active` 的 fail-open 问题，改为 `requested_version_invalid` fail-closed。(`apps/api/src/modules/integration/contract-resolver.js`, `apps/api/test/integration.contract-resolver.test.js`)
  - [x] [AI-Review][HIGH] 修复契约治理服务未校验“integration catalog 读取结果 identity”导致查错集成仍可能返回 200 的 fail-open 风险，改为 identity 不一致统一 `503` fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复契约读取/兼容评估读取/激活结果未校验查询键一致性导致“键不匹配但结构合法”记录可被误接受的问题，统一增加 identity 校验并阻断为 `503`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复契约创建路径未校验 store 回包 `status` 与请求一致导致可绕过激活流程直接产出 `active` 契约的 fail-open 风险，统一对创建结果做状态一致性校验并阻断为 `503`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复契约创建路径未校验 store 回包 `schema_ref/schema_checksum/is_backward_compatible/compatibility_notes` 与请求一致导致错误载荷被 200 接受的完整性风险，新增创建结果载荷一致性校验并 fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复兼容评估允许 `breaking_change_count` 与 `diff_summary` 推导结果不一致导致可伪造 `compatible` 结论的 fail-open 风险，改为一致性校验并在冲突时稳定返回 `400`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复 `diff_summary.breaking_change_count` 允许负数/非整数并被静默归零的问题，改为严格校验非法即 `400`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复兼容评估 `breaking_change_count` 未限制上界导致超出 `INT UNSIGNED` 时语义漂移风险，新增上界校验并稳定返回 `400`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复兼容评估结果 `diff_summary` 比较对 JSON 键顺序敏感导致误报不一致的问题，改为 canonical JSON 比较并补齐回归。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][HIGH] 修复兼容评估结果 `diff_summary` 在不可序列化（如循环引用）时可能异常逸出导致响应不稳定的问题，改为安全序列化并统一 `503` fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)
  - [x] [AI-Review][MEDIUM] 修复激活路径 latest compatibility check 读回未限制 `diff_summary` 长度导致畸形超长结果可被接受的问题，新增长度上限校验并统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js`, `apps/api/test/platform.integration.contract.api.test.js`)

## Dev Notes

### Developer Context（开发者先读）

- Story 5.1 已落地“集成目录 + 生命周期状态机 + 审计 + OpenAPI + 幂等保护”基线；5.2 必须复用其路径与语义，禁止重建第二套目录模型。
- 5.1 的审查经验表明，最易回归的问题是“静默容错/静默截断/双后端语义漂移”；5.2 继续严格执行 fail-closed。
- 5.2 的边界：
  - 本故事完成“版本化契约交互 + 兼容管理 + 激活阻断”。
  - 不实现 Story 5.3 的发布前全量契约一致性门禁编排。
  - 不实现 Story 5.4 的重试/DLQ/人工重放闭环。
  - 不实现 Story 5.5 的冻结/解冻与分组报告。

### Story Foundation（来自 Epic 5 全局上下文）

- Epic 5 目标：外部集成治理闭环（目录、契约版本、一致性校验、恢复、发布门禁）。
- Story 5.1 已完成“可管理目录与生命周期事实源”，5.2 在此基础上实现“可执行的版本化契约与兼容阻断”。
- 当前故事直接覆盖：`FR38`、`FR40`、`FR57`。
- 强依赖/强关联：
  - Story 5.1（目录与生命周期事实源）
  - Story 5.3（将复用 5.2 兼容评估结果做发布前一致性门禁）
  - Story 5.4（将复用 5.2 的激活契约版本执行失败恢复）

### Technical Requirements（硬约束）

- FR 映射：
  - `FR38`：按版本化契约执行外部 API/Event 交互。
  - `FR40`：对新版本执行兼容判定并管理升级策略。
  - `FR57`：记录并追踪契约版本变更历史。
- NFR 映射（PRD Integration）：
  - `NFR13`：可重试错误策略与后续恢复闭环可扩展（本故事先保留策略位与契约表达）。
  - `NFR14`：写操作幂等去重（所有写接口继续走幂等保护）。
  - `NFR15`：`request_id/traceparent` 全链路可追踪。
  - `NFR16`：接口变更必须进入契约一致性与版本治理流程（本故事先落“版本兼容判定 + 激活阻断”）。
  - `NFR17`：Integration DoD 的契约治理条目可被验证与归档。
- 契约与兼容判定最小规则：
  - 契约版本必须唯一且可追溯（写审计 + 查询可回放）。
  - 非兼容版本不得进入 `active`。
  - 运行时选择的契约版本必须与当前激活版本一致，不允许“请求用 v2 / 记录标 v1”。

### Architecture Compliance（架构对齐清单）

- API 契约：REST + OpenAPI（单一事实源）+ Problem Details 错误结构。
- 模块边界：
  - 平台治理入口继续在 `modules/platform/*`。
  - 契约执行解析能力放入 `modules/integration/*`（新建模块，不与平台治理耦合）。
  - 模块间通信通过 service 接口，禁止跨模块 repository 互调。
- 命名与格式：
  - 外部字段 `snake_case`，内部 `camelCase`，必须经过显式映射层。
  - 写接口继续 `Idempotency-Key` 与审计事件必达。
- 安全与可观测：
  - 权限声明漏配即阻断。
  - 全链路保留 `request_id` 与 `traceparent`。

### Library & Framework Requirements（版本核验）

- 当前仓库（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新核验（2026-02-22）：
  - Node.js LTS：`v24.13.1 (Krypton)`，Current：`v25.6.1`
  - `@nestjs/core`: `11.1.14`（官方 release：2026-02-17，含 fastify middleware CVE 修复）
  - `typeorm`: `0.3.28`（稳定 latest；`0.4.0-alpha.1` 仍为 alpha，不用于本故事）
  - `mysql2`: `3.17.4`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 LTS：最新检测 `8.4.8`
- 本故事决策：不在 5.2 中做依赖升级，先确保契约版本治理闭环交付；依赖升级单列维护任务。

### File Structure Requirements（建议变更落点）

- 新增：
  - `apps/api/migrations/0022_platform_integration_contract_versions.sql`
  - `apps/api/migrations/0022_platform_integration_contract_versions.down.sql`
  - `apps/api/src/modules/platform/integration-contract.constants.js`
  - `apps/api/src/modules/platform/integration-contract.routes.js`
  - `apps/api/src/modules/platform/integration-contract.service.js`
  - `apps/api/src/modules/integration/contract-resolver.js`
  - `apps/api/src/modules/integration/index.js`
  - `apps/api/test/platform.integration.contract.api.test.js`
  - `docs/runbooks/integration/contract-version-rollout.md`
- 修改：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（必须覆盖）

- AC1（版本化契约执行）：
  - 已激活版本可被解析并用于调用决策。
  - 请求/响应记录可回溯到具体 `contract_version`。
  - `lifecycle_status != active` 时交互执行被拒绝。
- AC2（兼容评估与阻断）：
  - 新版本兼容评估可输出明确结果与摘要。
  - `incompatible` 结果下激活请求被稳定阻断（409）。
  - 兼容评估与激活操作都有审计记录。
- 回归重点（来自 5.1）：
  - 参数上限严格校验，不得静默截断。
  - MySQL 与 in-memory 在异常路径返回一致。
  - store/service 在依赖畸形返回场景统一 fail-closed 503。
- 门禁命令：
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api lint`
  - `pnpm --dir apps/api test`

### Previous Story Intelligence（来自 Story 5.1）

- 5.1 已验证的高价值模式：
  - 平台集成治理 API 接线模式已成熟（`integration.constants/routes/service` + `http-routes/server/route-permissions`）。
  - 审计事件写入失败统一 fail-closed，避免“业务成功但审计缺失”。
  - 列表与详情查询严格输入校验，`page_size` 超限必须 400，不可静默修正。
- 5.1 已踩坑并修复的风险，5.2 必须继承：
  - 禁止 MySQL 读取异常时“返回 null/过滤坏数据”；必须显式失败。
  - 禁止 store 与 service 在长度上限、控制字符、时间字段上出现契约漂移。
  - 生命周期语义与响应字段必须一致（避免 `status` 与 `effective_invocation_enabled` 矛盾）。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交集中在：`apps/api/src/modules/platform/*`、`auth.store.*`、`openapi.js`、`route-permissions.js` 与 `apps/api/test/*`。
- 建议实施顺序：
  1. 迁移与 store 语义先落地；
  2. 再接平台契约治理 service/routes 与权限声明；
  3. 最后补 OpenAPI、回归测试与门禁执行。
- 这能最大化复用 5.1 代码路径并减少“先接 API 再返工存储层”的重复劳动。

### Latest Tech Information（外部核验）

- Node 官方发行索引（2026-02-22）：LTS `v24.13.1`，Current `v25.6.1`。
- npm Registry（2026-02-22）：
  - `@nestjs/core@11.1.14`
  - `typeorm@0.3.28`
  - `mysql2@3.17.4`
  - `ioredis@5.9.3`
- GitHub 官方 release（2026-02-22 查询）：
  - Nest `v11.1.14`（2026-02-17）包含 fastify middleware CVE 修复项。
  - TypeORM `0.3.28`（2025-12-03）仍为稳定主线。
  - mysql2 `v3.17.4`（2026-02-20）、ioredis `v5.9.3`（2026-02-12）为最新 patch。
- MySQL 8.4 官方发布说明：最新检测 `8.4.8`。

### Project Context Reference

- 未发现 `**/project-context.md`（空匹配）。
- 本故事上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`（Epic 5 / Story 5.2）
  - `_bmad-output/planning-artifacts/prd.md`（Integration Requirements、FR38/FR40/FR57、NFR13-NFR17）
  - `_bmad-output/planning-artifacts/architecture.md`（API & Communication Patterns、Architectural Boundaries、Requirements Mapping）
  - `_bmad-output/planning-artifacts/ux-design-specification.md`（反馈一致性、防重复提交、冲突可重试语义）
  - `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`已完成十四轮自动代码审查修复（并发/策略/语义/索引/契约文档一致性/畸形读取与 identity 漂移 fail-closed、breaking 计数一致性与上界约束、兼容评估写回载荷与 request_id 一致性、latest compatibility check 读回一致性校验、retired 候选激活阻断前置、activation_blocked reason 归一化、diff_summary canonical 比较与不可序列化防护、latest check diff_summary 长度上限复核）并复跑全量门禁，AC1/AC2 持续通过。`

### References

- `_bmad-output/planning-artifacts/epics.md`（`Epic 5` / `Story 5.2`）
- `_bmad-output/planning-artifacts/prd.md`（`Integration Requirements`、`FR38/FR40/FR57`、`NFR13-NFR17`）
- `_bmad-output/planning-artifacts/architecture.md`（`API & Communication Patterns`、`Architectural Boundaries`、`Requirements to Structure Mapping`）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（`Feedback Patterns`、`Form Patterns`）
- `_bmad-output/implementation-artifacts/5-1-集成目录与生命周期管理.md`
- `apps/api/src/modules/platform/integration.constants.js`
- `apps/api/src/modules/platform/integration.routes.js`
- `apps/api/src/modules/platform/integration.service.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `https://nodejs.org/download/release/index.json`
- `https://registry.npmjs.org/@nestjs/core`
- `https://registry.npmjs.org/typeorm`
- `https://registry.npmjs.org/mysql2`
- `https://registry.npmjs.org/ioredis`
- `https://github.com/nestjs/nest/releases/tag/v11.1.14`
- `https://github.com/typeorm/typeorm/releases/tag/0.3.28`
- `https://github.com/sidorares/node-mysql2/releases/tag/v3.17.4`
- `https://github.com/redis/ioredis/releases/tag/v5.9.3`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`

## Senior Developer Review (AI)

### Outcome

- 决议：`Approve`（修复后复检通过）
- Git vs Story Discrepancies：`0`
- Findings（本轮修复前）：`1 High / 2 Medium / 0 Low`

### Findings（已修复）

1. MEDIUM：迁移索引 `idx_platform_integration_contract_active_lookup` 使用 `created_at`，但活跃契约查询按 `updated_at DESC, contract_id DESC` 读取，导致索引排序失配并放大热路径查询成本。已调整索引列顺序并补齐基线断言。(`apps/api/migrations/0022_platform_integration_contract_versions.sql:22`, `apps/api/test/migrate-baseline.test.js:606`)
2. MEDIUM：兼容评估最新记录查询按 `(integration_id, contract_type, baseline_version, candidate_version, checked_at, check_id)` 过滤+排序，但迁移索引缺少 `baseline_version/candidate_version`，存在大表扫描风险。已升级复合索引并补齐基线断言。(`apps/api/migrations/0022_platform_integration_contract_versions.sql:50`, `apps/api/test/migrate-baseline.test.js:619`)
3. LOW：OpenAPI `schema_checksum` 正则仅允许小写十六进制，而服务端会规范化并接受大写输入，契约文档与实现不一致。已统一为大小写十六进制模式并补齐回归。(`apps/api/src/openapi.js:48`, `apps/api/test/platform.integration.contract.api.test.js:276`)

### Findings（本轮新增并已修复）

1. HIGH：激活路径将“读取到畸形 active 契约记录”误判为“当前无 active 基线”，导致可绕过兼容评估直接激活候选版本。已在服务层对 `findLatestActivePlatformIntegrationContractVersion` 的畸形返回执行 fail-closed 并稳定映射 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:1135`, `apps/api/test/platform.integration.contract.api.test.js:940`)
2. MEDIUM：兼容评估路径对 baseline/candidate 的读取仅做“是否存在”判断，遇到畸形记录仍继续写入评估结果，导致容错语义偏向 fail-open。已新增结构校验，畸形记录统一阻断为 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:1007`, `apps/api/test/platform.integration.contract.api.test.js:781`)
3. MEDIUM：激活路径对候选契约读取到畸形记录时返回 `404`，会误导调用方判断为“资源不存在”而非“依赖读异常”。已统一语义为 `INT-503-DEPENDENCY-UNAVAILABLE`。(`apps/api/src/modules/platform/integration-contract.service.js:1122`, `apps/api/test/platform.integration.contract.api.test.js:859`)

### Findings（继续审查新增并已修复）

1. MEDIUM：激活路径把“latest compatibility check 读取结果畸形”与“未找到评估记录”混为同一 `409 missing_compatibility_check`，掩盖依赖异常。已区分 `null` 与 malformed，后者统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:1208`, `apps/api/test/platform.integration.contract.api.test.js:1123`)
2. HIGH：兼容评估在 `diff_summary` 为数组且未传 `breaking_change_count` 时默认 0，可能把包含 breaking 项的候选版本误判为 `compatible`。已改为按数组长度推导 breaking 数。(`apps/api/src/modules/platform/integration-contract.service.js:561`, `apps/api/test/platform.integration.contract.api.test.js:943`)
3. MEDIUM：运行时契约解析对显式传入但格式畸形的 `requestedContractVersion` 静默回退 `active`，属于 fail-open。已改为抛出 `ERR_INTEGRATION_CONTRACT_STRATEGY_INVALID`（`requested_version_invalid`）。(`apps/api/src/modules/integration/contract-resolver.js:126`, `apps/api/test/integration.contract-resolver.test.js:90`)

### Findings（第六轮新增并已修复）

1. HIGH：契约治理服务对 `findPlatformIntegrationCatalogEntryByIntegrationId` 返回值仅校验生命周期枚举，未校验 `integration_id` 与请求参数一致性；当依赖返回“结构合法但 identity 不匹配”的记录时，列表接口可错误返回 `200`（fail-open）。已在 `getIntegrationEntry` 增加 identity 校验，不一致统一 `503 integration-catalog-record-invalid`。(`apps/api/src/modules/platform/integration-contract.service.js:862`, `apps/api/test/platform.integration.contract.api.test.js:781`)
2. MEDIUM：契约版本读取/兼容评估读取/激活结果仅做结构校验，未校验查询键一致性，导致“键不匹配但结构合法”记录可被误接受并继续流程。已在服务层统一增加 contract/check identity 校验并 fail-closed。(`apps/api/src/modules/platform/integration-contract.service.js:448`, `apps/api/src/modules/platform/integration-contract.service.js:1274`, `apps/api/test/platform.integration.contract.api.test.js:913`)

### Findings（第七轮新增并已修复）

1. HIGH：契约创建路径仅校验回包 identity（integration/type/version），未校验 `status` 与请求一致；当依赖异常返回 `status=active` 时，接口会错误返回 `200` 并直接落地激活态契约，绕过“必须走 activate 流程”的治理约束。已在创建结果校验中加入 `status` 一致性检查并 fail-closed 为 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:1053`, `apps/api/test/platform.integration.contract.api.test.js:317`)

### Findings（第八轮新增并已修复）

1. MEDIUM：契约创建路径对 store 回包只做 identity+status 校验，未核对 `schema_ref/schema_checksum/is_backward_compatible/compatibility_notes` 与请求一致性；依赖异常可使错误契约载荷被接口以 `200` 接受，造成治理记录完整性偏差。已新增创建结果载荷一致性校验，任一关键字段不一致统一 `503 integration-contract-create-result-invalid`。(`apps/api/src/modules/platform/integration-contract.service.js:525`, `apps/api/src/modules/platform/integration-contract.service.js:1084`, `apps/api/test/platform.integration.contract.api.test.js:379`)

### Findings（第九轮新增并已修复）

1. HIGH：兼容评估路径优先信任显式 `breaking_change_count`，当其与 `diff_summary`（数组或 `breaking_changes`）不一致时可被伪造为 `compatible`，存在 fail-open 风险。已新增显式值与推导值一致性校验，冲突统一 `400 integration_contract_invalid_payload`。(`apps/api/src/modules/platform/integration-contract.service.js:660`, `apps/api/test/platform.integration.contract.api.test.js:1459`)
2. MEDIUM：`diff_summary.breaking_change_count` 对负数/非整数未 fail-closed，而是被隐式视作 `0`，可能掩盖真实破坏性变更。已改为严格校验，非法值稳定返回 `400`。(`apps/api/src/modules/platform/integration-contract.service.js:683`, `apps/api/test/platform.integration.contract.api.test.js:1547`)
3. MEDIUM：`breaking_change_count` 缺少上界约束，超过 MySQL `INT UNSIGNED` 可导致持久层语义漂移（memory 可过、MySQL 可能异常）。已补充上界 `4294967295` 校验，统一前置阻断为 `400`。(`apps/api/src/modules/platform/integration-contract.service.js:25`, `apps/api/test/platform.integration.contract.api.test.js:1636`)

### Findings（第十轮新增并已修复）

1. MEDIUM：`breaking_change_count` 解析逻辑对 `null` 等非 number 类型未先行 fail-closed，`Number(null)` 可被隐式归零，导致输入语义漂移。已在 `parseCount` 增加“仅接受有限 number”约束，非法值统一 `400 integration_contract_invalid_payload`。(`apps/api/src/modules/platform/integration-contract.service.js:714`, `apps/api/test/platform.integration.contract.api.test.js:642`)
2. HIGH：兼容评估写入后仅校验记录 identity，未校验 `breaking_change_count/diff_summary` 与请求载荷一致性；依赖返回“结构合法但结果被篡改”时会被错误接受。已新增写回载荷一致性校验，任一关键字段漂移统一 `503 integration-contract-compatibility-result-invalid`。(`apps/api/src/modules/platform/integration-contract.service.js:525`, `apps/api/src/modules/platform/integration-contract.service.js:1333`, `apps/api/test/platform.integration.contract.api.test.js:433`)
3. MEDIUM：兼容评估结果映射阶段会用当前请求 `request_id` 覆盖存储返回值，掩盖“回包 request_id 不一致”异常，导致异常记录可被误判为正常。已改为保留存储 `request_id` 并纳入一致性校验，不一致统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:406`, `apps/api/src/modules/platform/integration-contract.service.js:442`, `apps/api/test/platform.integration.contract.api.test.js:535`)

### Findings（第十一轮新增并已修复）

1. HIGH：激活路径读取 latest compatibility check 后仅基于 `evaluation_result` 判定是否放行，未校验其与 `breaking_change_count` 的语义一致性；当依赖返回 `evaluation_result=compatible` 且 `breaking_change_count>0` 时可被错误放行。已新增读回一致性校验，冲突统一 `503 integration-contract-compatibility-check-read-result-malformed`。(`apps/api/src/modules/platform/integration-contract.service.js:767`, `apps/api/src/modules/platform/integration-contract.service.js:1555`, `apps/api/test/platform.integration.contract.api.test.js:2119`)
2. MEDIUM：激活路径未对 latest compatibility check 的 `breaking_change_count` 执行上界约束复核，超出 `INT UNSIGNED` 范围的畸形记录可被当作“结构合法”继续处理。已补齐读回上界校验（`4294967295`），超范围统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:773`, `apps/api/test/platform.integration.contract.api.test.js:2244`)
3. MEDIUM：激活路径未复核 latest compatibility check 的 `diff_summary` 推导与显式 `breaking_change_count` 一致性，`diff_summary` 显示 breaking 但显式计数为 0 的记录可被误接受。已复用 breaking 推导一致性逻辑做读回校验，不一致统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:783`, `apps/api/test/platform.integration.contract.api.test.js:2367`)

### Findings（第十二轮新增并已修复）

1. MEDIUM：激活路径在候选版本已是 `retired` 时仍先读取 latest compatibility check，导致本应确定性的 `retired_version` 业务阻断受兼容性依赖可用性影响（依赖异常时会漂移为 `503`）。已将 `retired` 阻断前置到兼容性查询之前，并新增回归保证不会触发该依赖读取。(`apps/api/src/modules/platform/integration-contract.service.js:1516`, `apps/api/test/platform.integration.contract.api.test.js:1030`)

### Findings（第十三轮新增并已修复）

1. MEDIUM：store 层 `ERR_PLATFORM_INTEGRATION_CONTRACT_ACTIVATION_BLOCKED` 的 `reason` 使用连字符（如 `retired-version`），而服务层语义为下划线（如 `retired_version`）；在并发/依赖路径下会产生响应 reason 漂移。已在 `mapStoreError` 增加 reason 归一化，统一输出 snake_case，并补充回归覆盖。(`apps/api/src/modules/platform/integration-contract.service.js:262`, `apps/api/src/modules/platform/integration-contract.service.js:286`, `apps/api/test/platform.integration.contract.api.test.js:1136`)

### Findings（第十四轮新增并已修复）

1. MEDIUM：兼容评估写回一致性校验对 `diff_summary` 使用原始 `JSON.stringify`，对象键顺序变化会被误判为不一致并错误返回 `503`。已改为 canonical JSON 序列化比较，确保语义等价结果稳定通过。(`apps/api/src/modules/platform/integration-contract.service.js:65`, `apps/api/src/modules/platform/integration-contract.service.js:580`, `apps/api/test/platform.integration.contract.api.test.js:642`)
2. HIGH：`diff_summary` 若来自异常依赖并含循环引用，序列化时可能抛异常导致不稳定错误路径。已新增安全 canonical 序列化并在不可序列化时统一 fail-closed 为 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:90`, `apps/api/src/modules/platform/integration-contract.service.js:599`, `apps/api/test/platform.integration.contract.api.test.js:752`)
3. MEDIUM：激活路径读取 latest compatibility check 时未复核 `diff_summary` 长度上限，畸形超长回包可被当作合法记录继续参与决策。已在读回映射阶段增加长度校验，超限统一 `503`。(`apps/api/src/modules/platform/integration-contract.service.js:417`, `apps/api/src/modules/platform/integration-contract.service.js:1594`, `apps/api/test/platform.integration.contract.api.test.js:2950`)

### Validation

- `pnpm --dir apps/api check:route-permissions` ✅
- `pnpm --dir apps/api lint` ✅
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js` ✅（33 passed, 0 failed）
- `pnpm --dir apps/api test` ✅（1163 passed, 0 failed）

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `git status --porcelain`
- `rg -n "scope lock malformed|ORDER BY contract_id ASC" apps/api/src/modules/auth/auth.store.mysql.js apps/api/test/auth.store.mysql.test.js`
- `rg -n "ERR_INTEGRATION_CONTRACT_STRATEGY_INVALID|strategy_malformed|strategy_header_missing|strategy_unsupported" apps/api/src/modules/integration/contract-resolver.js apps/api/test/integration.contract-resolver.test.js`
- `rg -n "MAX_DIFF_SUMMARY_LENGTH|diff_summary 超长|oversized diff_summary" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/integration.contract-resolver.test.js test/platform.integration.contract.api.test.js test/auth.store.mysql.test.js`
- `rg -n "idx_platform_integration_contract_active_lookup|idx_platform_integration_contract_checks_lookup" apps/api/migrations/0022_platform_integration_contract_versions.sql apps/api/test/migrate-baseline.test.js`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `rg -n "missing_compatibility_check|integration-contract-compatibility-check-read-result-malformed|resolveBreakingChangeCount" apps/api/src/modules/platform/integration-contract.service.js`
- `rg -n "requested_version_invalid|hasExplicitRequestedVersion" apps/api/src/modules/integration/contract-resolver.js apps/api/test/integration.contract-resolver.test.js`
- `rg -n "matchesExpectedContractLookup|matchesExpectedCompatibilityCheckLookup|integration-catalog-record-invalid" apps/api/src/modules/platform/integration-contract.service.js`
- `rg -n "catalog-mismatch|candidate-mismatch" apps/api/test/platform.integration.contract.api.test.js`
- `rg -n "integration-contract-create-result-invalid|status: parsedPayload.status" apps/api/src/modules/platform/integration-contract.service.js`
- `rg -n "create status mismatches requested status" apps/api/test/platform.integration.contract.api.test.js`
- `rg -n "matchesExpectedCreateContractPayload|schemaChecksum" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/integration.contract-resolver.test.js test/platform.integration.contract.api.test.js`
- `rg -n "MAX_BREAKING_CHANGE_COUNT|breaking_change_count 与 diff_summary 不一致|diff_summary.breaking_change_count 与 diff_summary.breaking_changes 不一致" apps/api/src/modules/platform/integration-contract.service.js`
- `rg -n "count-mismatch|summary-negative|breaking-count-overflow" apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `rg -n "normalizeActivationBlockedReason|ERR_PLATFORM_INTEGRATION_CONTRACT_ACTIVATION_BLOCKED|retired-version" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions && pnpm --dir apps/api lint && pnpm --dir apps/api test`
- `rg -n "retired_version|findLatestPlatformIntegrationContractCompatibilityCheck" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions && pnpm --dir apps/api lint && pnpm --dir apps/api test`
- `rg -n "hasConsistentCompatibilityCheckEvaluation|integration-contract-compatibility-check-read-result-malformed" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `rg -n "latest compatibility check marks compatible with non-zero|latest compatibility check breaking_change_count overflows|latest compatibility check diff_summary inference mismatches" apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `rg -n "matchesExpectedCompatibilityResultPayload|integration-contract-compatibility-result-invalid|requestIdInRecord|parseCount\\(" apps/api/src/modules/platform/integration-contract.service.js apps/api/test/platform.integration.contract.api.test.js`
- `rg -n "check-count-mismatch|check-request-id-mismatch|breaking-count-null" apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `rg -n "toCanonicalJsonValue|serializeCanonicalJson|mapCompatibilityCheckRecord|matchesExpectedCompatibilityResultPayload|MAX_DIFF_SUMMARY_LENGTH" apps/api/src/modules/platform/integration-contract.service.js`
- `rg -n "semantically equivalent diff_summary|non-serializable|latest compatibility check diff_summary exceeds max length" apps/api/test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`

### Completion Notes List

- 完成契约版本与兼容评估迁移（`0022` up/down），并补齐迁移基线测试。
- 完成 MySQL 与 in-memory store 的契约版本 CRUD、兼容评估写入、最新激活版本查询、激活切换与审计事件写入。
- 完成平台契约治理 API（列表/创建/兼容评估/激活）、路由接线、权限声明与写接口幂等保护接入。
- 完成运行时契约解析守卫模块（`modules/integration/contract-resolver.js`），覆盖生命周期阻断与版本不一致 fail-closed。
- 完成 OpenAPI path/schema/error_code 补齐与审计语义对齐。
- 新增并扩展测试：契约 API 主流程与阻断路径、运行时守卫测试、路由权限/接线测试、迁移测试；门禁全通过。
- 激活规则调整：移除 store 层 `is_backward_compatible` 硬阻断，统一由服务层“兼容评估结果”决定是否允许激活，避免双重判定漂移。
- 完成自动 CR 修复：阻断 `baseline_version` 绕过激活、补齐 store 读取异常统一映射、统一 `integration_contract_not_found` 错误语义。
- 新增 3 个回归测试（基线绕过阻断、兼容评估依赖失败映射、集成不存在错误码），并通过单测验证。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1133 passed, 0 failed`）。
- 完成二轮自动 CR 修复：MySQL 激活作用域加锁防并发双活、`version_strategy` 全路径 fail-closed、`diff_summary` 超长稳定映射 `400`。
- 新增 3 个回归测试（激活作用域锁顺序、策略 malformed/缺参拒绝、超长 diff_summary 拒绝），并通过定向与全量回归。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1138 passed, 0 failed`）。
- 完成三轮自动 CR 修复：`0022` 迁移索引与查询路径对齐（活跃契约与兼容评估读取）、OpenAPI `schema_checksum` 大小写契约一致化。
- 新增 2 个迁移索引断言与 1 个契约 API 回归（大写 checksum 接收+归一化），并通过定向与全量回归。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1139 passed, 0 failed`）。
- 完成四轮自动 CR 修复：契约治理服务对畸形 baseline/candidate/active 读取结果改为严格 fail-closed（`503`），修复激活与兼容评估路径的隐式绕过风险。
- 新增 3 个契约 API 回归（baseline/candidate 畸形读取阻断、candidate 畸形读取阻断、active 畸形读取阻断），并通过定向回归（`13 passed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1142 passed, 0 failed`）。
- 完成五轮自动 CR 修复：latest compatibility check 畸形读取语义改为 `503`、`diff_summary` 数组 breaking 判定由 0 修正为长度推导、显式畸形 `requestedContractVersion` 改为 fail-closed。
- 新增 2 个契约 API 回归 + 1 个 resolver 回归，并通过定向回归（`23 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1145 passed, 0 failed`）。
- 完成六轮自动 CR 修复：补齐 integration/contract/check 读取结果 identity 一致性校验，阻断“键不匹配但结构合法”记录导致的 fail-open。
- 新增 2 个契约 API 回归（integration catalog mismatch、candidate lookup identity mismatch），并通过定向回归（`25 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1147 passed, 0 failed`）。
- 完成七轮自动 CR 修复：补齐契约创建回包 `status` 与请求一致性校验，阻断 store 异常回包导致的“未激活即 active” fail-open。
- 新增 1 个契约 API 回归（create result status mismatch），并通过定向回归（`26 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1148 passed, 0 failed`）。
- 完成八轮自动 CR 修复：补齐契约创建回包关键载荷（`schema_ref/schema_checksum/is_backward_compatible/compatibility_notes`）一致性校验，阻断错误契约载荷被 200 接受。
- 新增 1 个契约 API 回归（create result schema_checksum mismatch），并通过定向回归（`27 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1149 passed, 0 failed`）。
- 完成九轮自动 CR 修复：补齐兼容评估 breaking 数的一致性与上界校验，阻断“显式计数伪造兼容”“负数计数静默归零”“超范围计数语义漂移”三类风险。
- 新增 3 个契约 API 回归（`breaking_change_count` 与 `diff_summary` 冲突拒绝、负数 `diff_summary.breaking_change_count` 拒绝、`breaking_change_count` 溢出拒绝），并通过定向回归（`22 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1113 passed, 0 failed`）。
- 完成十轮自动 CR 修复：补齐兼容评估写回结果 `breaking_change_count/diff_summary/request_id` 一致性校验，并收紧 `breaking_change_count` 类型约束（拒绝 `null` 隐式归零）。
- 新增 3 个契约 API 回归（写回 `breaking_change_count` 漂移阻断、写回 `request_id` 漂移阻断、`breaking_change_count=null` 拒绝），并通过定向回归（`25 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1155 passed, 0 failed`）。
- 完成十一轮自动 CR 修复：补齐激活路径 latest compatibility check 的读回一致性校验（`evaluation_result`/`breaking_change_count`/`diff_summary` 联动与上界复核），阻断结构合法但语义畸形记录导致的放行风险。
- 新增 3 个契约 API 回归（`compatible + non-zero breaking_count` 阻断、breaking_count 溢出阻断、`diff_summary` 推导与显式计数冲突阻断），并通过定向回归（`28 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1158 passed, 0 failed`）。
- 完成十二轮自动 CR 修复：将 `retired` 候选版本激活阻断前置到兼容性检查查询之前，消除“确定性业务阻断依赖外部检查可用性”导致的语义漂移。
- 新增 1 个契约 API 回归（`retired` 候选激活不触发 latest compatibility check 读取，稳定返回 `retired_version`），并通过定向回归（`29 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1159 passed, 0 failed`）。
- 完成十三轮自动 CR 修复：统一 store 抛出的 `activation_blocked` reason 语义为 snake_case，消除连字符/下划线混用导致的响应漂移。
- 新增 1 个契约 API 回归（store 抛出 `retired-version` 时接口稳定返回 `retired_version`），并通过定向回归（`30 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1160 passed, 0 failed`）。
- 完成十四轮自动 CR 修复：引入 `diff_summary` canonical JSON 比较、防御不可序列化 `diff_summary` 的稳定 fail-closed、补齐 latest compatibility check `diff_summary` 长度上限复核。
- 新增 3 个契约 API 回归（键顺序等价比较通过、不可序列化 `diff_summary` 统一 `503`、latest check `diff_summary` 超长阻断），并通过定向回归（`33 passed, 0 failed`）。
- 复跑全量门禁：`check:route-permissions`、`lint`、`test` 全通过（`1163 passed, 0 failed`）。

### File List

- `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0022_platform_integration_contract_versions.sql`
- `apps/api/migrations/0022_platform_integration_contract_versions.down.sql`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/platform/integration-contract.constants.js`
- `apps/api/src/modules/platform/integration-contract.routes.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/modules/integration/contract-resolver.js`
- `apps/api/src/modules/integration/index.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/server.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/openapi.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/test/integration.contract-resolver.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `docs/runbooks/integration/contract-version-rollout.md`

## Change Log

- 2026-02-22：完成 Story 5.2 版本化契约治理实现（迁移、store、API、运行时守卫、OpenAPI、测试与门禁），故事状态更新为 `review`。
- 2026-02-22：执行自动 CR（Story 5.2），修复 2 High + 1 Medium 问题（基线绕过、异常映射、错误码对齐），复跑全量门禁通过，故事状态更新为 `done`。
- 2026-02-22：执行二轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（激活并发双活锁、`version_strategy` fail-open、`diff_summary` 超长语义），复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行三轮自动 CR（Story 5.2），修复 2 Medium + 1 Low 问题（迁移索引失配、兼容查询索引缺口、OpenAPI checksum 大小写契约漂移），复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行四轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（畸形 active/baseline/candidate 读取未 fail-closed），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行五轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（latest compatibility check 畸形读取语义、`diff_summary` 数组 breaking 判定、显式畸形 requested version fail-open），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行六轮自动 CR（Story 5.2），修复 1 High + 1 Medium 问题（integration/contract/check 读取 identity 未校验导致 fail-open），新增 2 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行七轮自动 CR（Story 5.2），修复 1 High 问题（契约创建回包 status 未校验导致可绕过 activate 流程），新增 1 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行八轮自动 CR（Story 5.2），修复 1 Medium 问题（契约创建回包关键载荷未校验导致错误契约可被接受），新增 1 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行九轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（breaking 数与 `diff_summary` 冲突可伪造兼容、负数计数静默归零、计数上界缺失），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行十轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（兼容评估写回结果 payload/request_id 一致性缺失、`breaking_change_count=null` 隐式归零），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行十一轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（latest compatibility check 读回一致性缺失：`evaluation_result` 与 `breaking_change_count/diff_summary` 语义漂移、计数上界缺失），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行十二轮自动 CR（Story 5.2），修复 1 Medium 问题（`retired` 候选激活阻断顺序导致依赖耦合），新增 1 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行十三轮自动 CR（Story 5.2），修复 1 Medium 问题（store `activation_blocked` reason 风格不一致导致响应语义漂移），新增 1 条回归并复跑全量门禁通过，状态保持 `done`。
- 2026-02-22：执行十四轮自动 CR（Story 5.2），修复 1 High + 2 Medium 问题（`diff_summary` 键序敏感误判、不支持序列化回包导致不稳定错误路径、latest compatibility check `diff_summary` 超长未阻断），新增 3 条回归并复跑全量门禁通过，状态保持 `done`。
