# Story 5.3: 集成变更前契约一致性校验

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 发布负责人,
I want 在外部集成变更前执行契约一致性校验,
so that 不一致变更在上线前被阻断。

## Acceptance Criteria

1. **Given** 集成配置或契约发生变更
   **When** 进入发布前校验
   **Then** 系统执行契约一致性检查
   **And** 失败结果阻断发布并输出差异明细
2. **Given** 契约检查通过
   **When** 进入后续发布流程
   **Then** 变更可继续执行
   **And** 校验结果存档用于审计

## Tasks / Subtasks

- [x] 任务 1：实现“发布前契约一致性校验”入口（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/platform/integration-contract.constants.js` 增加一致性校验路由常量（建议：`POST /platform/integrations/:integration_id/contracts/consistency-check`）。
  - [x] 在 `apps/api/src/modules/platform/integration-contract.routes.js` 接入 handler，复用既有 `resolveAccessToken` / preauthorized 语义。
  - [x] 在 `apps/api/src/modules/platform/integration-contract.service.js` 新增 `checkConsistency`（或等价命名），并与 `evaluateCompatibility/activateContract` 共用输入校验与 fail-closed 映射策略。

- [x] 任务 2：落地一致性判定算法（AC: 1）
  - [x] 必检项：`integration_id`、`contract_type`、`baseline_version`、`candidate_version`、最新兼容评估记录、候选契约状态。
  - [x] 判定规则：
    - [x] 缺少最新兼容评估记录时阻断（不可放行）。
    - [x] `evaluation_result != compatible` 时阻断并返回 breaking 差异摘要。
    - [x] 基线/候选读取结果与查询键不一致、或记录结构畸形时统一 `503` fail-closed。
    - [x] 不得仅依据 `is_backward_compatible` 字段放行，必须以“最新一致性评估结果”作为阻断依据。
  - [x] 输出结构至少包含：`check_result`、`blocking`、`failure_reason`、`breaking_change_count`、`diff_summary`、`request_id`、`checked_at`。

- [x] 任务 3：发布门禁接入（AC: 1, 2）
  - [x] 在 `tools/release-gate-report.js` 增加“Integration Contract Consistency”阻断组（建议映射 `FR41`、`FR58`）。
  - [x] 新增或接入检查命令（建议脚本）：`apps/api/scripts/check-integration-contract-consistency.js`，用于在发布门禁阶段执行一致性检查并输出可归档结果。
  - [x] 保证门禁语义：一致性失败 -> `blocking=true`；一致性通过 -> 允许进入后续流程。

- [x] 任务 4：OpenAPI、错误码与审计补齐（AC: 1, 2）
  - [x] 在 `apps/api/src/openapi.js` 增加一致性校验 path/schema/examples（成功/阻断/依赖异常）。
  - [x] 错误语义沿用 Problem Details：返回 `error_code`、`request_id`、`traceparent`、`retryable`。
  - [x] 失败场景需包含可读差异信息（至少 `baseline_version/candidate_version/breaking_change_count` 与阻断原因）。
  - [x] 记录审计事件（建议：`platform.integration.contract.consistency_checked`），保证可按 `request_id` 查询。

- [x] 任务 5：权限声明与幂等一致性（AC: 1, 2）
  - [x] 在 `apps/api/src/route-permissions.js` 为新增受保护接口声明权限码（保持 `platform.member_admin.operate` 语义一致）。
  - [x] 在 `apps/api/src/server.js` 将一致性校验写接口纳入幂等保护（与现有契约治理写接口保持一致）。
  - [x] `check:route-permissions` 必须通过，禁止漏声明发布。

- [x] 任务 6：测试与回归门禁（AC: 1, 2）
  - [x] 扩展 `apps/api/test/platform.integration.contract.api.test.js`：覆盖通过、阻断、缺少兼容记录、依赖畸形、幂等重放。
  - [x] 扩展 `apps/api/test/route-permissions.test.js` 与 `apps/api/test/http-routes.test.js`：覆盖路由声明与接线。
  - [x] 扩展 `apps/api/test/release-gate-report.test.js`：覆盖新增门禁组的阻断语义与证据输出。
  - [x] 若新增持久化结构，扩展 `apps/api/test/migrate-baseline.test.js`。
  - [x] 必过命令：
    - [x] `pnpm --dir apps/api check:route-permissions`
    - [x] `pnpm --dir apps/api lint`
    - [x] `pnpm --dir apps/api test`

### Review Follow-ups (AI)

- [x] [AI-Review][Medium] 门禁脚本各检查项补齐 `request_id` 回填，避免审计证据链缺失请求标识。`apps/api/scripts/check-integration-contract-consistency.js`
- [x] [AI-Review][Low] 门禁失败分类对 `"blocking":true` 采用空白无关匹配，避免输出格式变化导致误分类。`tools/release-gate-report.js`
- [x] [AI-Review][Medium] Story 文档状态与完成状态统一为 `done`，消除 `review/ready-for-dev` 自相矛盾。`_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`
- [x] [AI-Review][High] 一致性校验新增 active baseline 对齐约束，阻断 `baseline_version` 与当前 active 版本不一致的绕过路径。`apps/api/src/modules/platform/integration-contract.service.js`
- [x] [AI-Review][Low] 门禁失败分类区分运行时异常与业务阻断，避免 `consistency.runtime` 被误标记为 `blocked`。`tools/release-gate-report.js`
- [x] [AI-Review][Medium] 门禁失败分类改为优先解析 consistency gate 结构化结果，避免 setup 类失败被误归类为 `blocked`。`tools/release-gate-report.js`
- [x] [AI-Review][Low] 门禁失败分类补齐 `baseline_version_mismatch/candidate_status_invalid` 等业务阻断原因识别，降低漏判风险。`tools/release-gate-report.js`
- [x] [AI-Review][Low] 门禁脚本断言改为安全 JSON 校验并捕获 validator 异常，避免单条校验抛错导致整次检查中断。`apps/api/scripts/check-integration-contract-consistency.js`

## Dev Notes

### Developer Context（开发者先读）

- Story 5.2 已完成契约版本、兼容评估、激活阻断与大量 fail-closed 修复；5.3 必须复用这些能力，不重建第二套契约判定链。
- 本故事核心价值是“发布前阻断与差异明细”，不是再次实现版本管理本身。
- 输出必须可被发布门禁消费，并形成审计留痕。

### Story Foundation（来自 Epic 5 全局上下文）

- Epic 5 目标：外部集成治理闭环（目录、版本、一致性校验、恢复、发布门禁）。
- Story 5.3 直接覆盖 `FR41`，并与 `FR58`（发布门禁分组报告）形成强依赖。
- 与相邻故事关系：
  - 依赖 Story 5.1（目录/生命周期）与 Story 5.2（兼容评估与激活阻断）。
  - 为 Story 5.5（冻结/解冻与门禁报告）提供可复用的一致性校验结果。

### Technical Requirements（硬约束）

- FR/NFR 约束：
  - `FR41`：集成变更前必须执行契约一致性校验。
  - `NFR16`：外部接口变更必须经过契约一致性与版本治理流程。
  - `NFR17`：一致性结果需纳入 Integration DoD 证据链。
  - `NFR36`：OpenAPI 必须完整覆盖新增接口与错误示例。
  - `NFR15`：一致性校验链路保留 `request_id/traceparent`。
- 判定语义约束：
  - 一致性检查失败必须阻断发布，不允许降级放行。
  - 阻断结果必须可解释（返回差异摘要与 failure_reason）。
  - 依赖返回畸形数据时统一 fail-closed（`503`），禁止静默容错。
- 审计约束：
  - 每次一致性检查都必须可追踪到发起人、目标集成、候选版本与结果。

### Architecture Compliance（架构对齐清单）

- 模块边界：
  - 平台接口落在 `apps/api/src/modules/platform/*`。
  - 存储能力复用 `apps/api/src/modules/auth/auth.store.mysql.js` 与 `apps/api/src/modules/auth/auth.store.memory.js`。
- 契约风格：REST + OpenAPI + Problem Details。
- 权限声明：新增受保护路由必须进入 `apps/api/src/route-permissions.js`。
- 幂等写接口：一致性检查若为写路径，必须纳入 `Idempotency-Key` 保护。
- 失败策略：沿用 5.2 的 identity 校验、canonical diff 校验、上界校验与 fail-closed 模式。

### Library & Framework Requirements（版本核验）

- 当前仓库（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 最新官方源核验（2026-02-22）：
  - Node.js Current: `v25.6.1`（2026-02-09）
  - Node.js LTS: `v24.13.1`（2026-02-09，Krypton）
  - `@nestjs/core`: `11.1.14`（2026-02-17）
  - `typeorm`: `0.3.28`（2025-12-03）
  - `mysql2`: `3.17.4`（2026-02-20）
  - `ioredis`: `5.9.3`（2026-02-12）
  - MySQL 8.4 LTS: `8.4.8`（2026-01-13）
- 本故事决策：不做依赖升级，优先交付一致性门禁主线。

### File Structure Requirements（建议变更落点）

- 预计修改：
  - `apps/api/src/modules/platform/integration-contract.constants.js`
  - `apps/api/src/modules/platform/integration-contract.routes.js`
  - `apps/api/src/modules/platform/integration-contract.service.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/test/platform.integration.contract.api.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/http-routes.test.js`
  - `apps/api/test/release-gate-report.test.js`
  - `docs/runbooks/integration/contract-version-rollout.md`
  - `tools/release-gate-report.js`
- 可选新增（按实现方案）：
  - `apps/api/scripts/check-integration-contract-consistency.js`
  - `apps/api/migrations/0023_*`（仅当需要持久化独立一致性快照时）

### Testing Requirements（必须覆盖）

- 一致性通过：
  - 返回 200，`check_result=passed`，并可进入后续发布流程。
- 一致性阻断：
  - 缺少兼容评估记录、评估不兼容、版本不一致、候选状态非法时返回阻断（409）并附差异信息。
- 依赖异常：
  - store 返回结构畸形或键不一致时返回 `503` fail-closed。
- 审计与追踪：
  - 审计事件可按 `request_id` 查询，且包含 `baseline/candidate/result` 元数据。
- 门禁联动：
  - `tools/release-gate-report.js` 新增分组在失败时可使 `blocking=true`。

### Previous Story Intelligence（来自 Story 5.2）

- 不可省略的护栏：
  - 严格 identity 校验（查询键与回包键必须一致）。
  - `diff_summary` 使用 canonical 比较，避免键顺序导致误判。
  - `breaking_change_count` 与 `diff_summary` 推导结果必须一致。
  - 对畸形 baseline/candidate/active/check 记录统一 `503`，禁止降级为“未找到”。
- 语义一致性：
  - `activation_blocked` reason 已统一 snake_case；5.3 新增 reason 需沿用同一风格。
  - 禁止把“确定性业务阻断”建立在不稳定依赖可用性之上。

### Git Intelligence Summary（最近提交模式）

- 最近相关提交：
  - `1115abb feat(api): complete story 5-2 integration contract governance`
  - `974a0d4 feat(api): implement story 5.1 integration catalog lifecycle governance`
- 代码变更集中在：
  - `apps/api/src/modules/platform/integration-contract.*`
  - `apps/api/src/modules/auth/auth.store.*`
  - `apps/api/src/openapi.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/test/platform.integration.contract.api.test.js`
- 推荐实施顺序：
  1. 先补 service 判定与错误语义；
  2. 再接路由/权限/OpenAPI；
  3. 最后接发布门禁与回归测试。

### Latest Tech Information（外部核验）

- Node 官方发布索引：Current `v25.6.1`，LTS `v24.13.1`（Krypton）。
- npm registry latest：`@nestjs/core@11.1.14`、`typeorm@0.3.28`、`mysql2@3.17.4`、`ioredis@5.9.3`。
- MySQL 8.4 release notes：当前 8.4 系列最新为 `8.4.8`。
- 本故事不做升级，仅记录版本事实，避免实现期间误用过时信息。

### Project Context Reference

- `**/project-context.md` 未找到（空匹配）。
- 主要上下文来源：
  - `_bmad-output/planning-artifacts/epics.md`
  - `_bmad-output/planning-artifacts/prd.md`
  - `_bmad-output/planning-artifacts/architecture.md`
  - `_bmad-output/planning-artifacts/ux-design-specification.md`
  - `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`已完成实现、代码审查修复与回归验证；满足 Story 5.3 交付要求。`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 5 / Story 5.3）
- `_bmad-output/planning-artifacts/prd.md`（FR41、NFR16、NFR17、NFR36）
- `_bmad-output/planning-artifacts/architecture.md`（API & Communication Patterns、Project Structure & Boundaries）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（Feedback Patterns、Form Patterns）
- `_bmad-output/implementation-artifacts/5-2-版本化契约交互与兼容管理.md`
- `apps/api/src/modules/platform/integration-contract.constants.js`
- `apps/api/src/modules/platform/integration-contract.routes.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/modules/integration/contract-resolver.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/http-routes.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/test/release-gate-report.test.js`
- `docs/runbooks/integration/contract-version-rollout.md`
- `tools/release-gate-report.js`
- `https://nodejs.org/download/release/index.json`
- `https://registry.npmjs.org/@nestjs/core`
- `https://registry.npmjs.org/typeorm`
- `https://registry.npmjs.org/mysql2`
- `https://registry.npmjs.org/ioredis`
- `https://dev.mysql.com/doc/relnotes/mysql/8.4/en/`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（CLI）

### Debug Log References

- `pnpm --dir apps/api exec node --test test/http-routes.test.js test/route-permissions.test.js test/platform.integration.contract.api.test.js test/release-gate-report.test.js`
- `pnpm --dir apps/api exec node --test test/check-integration-contract-consistency.script.test.js test/release-gate-report.test.js`
- `pnpm --dir apps/api exec node --test test/platform.integration.contract.api.test.js test/check-integration-contract-consistency.script.test.js test/release-gate-report.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api check:integration-contract-consistency`

### Completion Notes List

- 已新增 `POST /platform/integrations/:integration_id/contracts/consistency-check` 路由常量、handler 接线与服务实现，统一沿用 fail-closed 校验策略与 Problem Details 语义。
- 已落地一致性判定：缺少最新兼容记录阻断、最新评估不兼容阻断、候选状态非法阻断、依赖记录畸形统一 `503`；输出覆盖 `check_result/blocking/failure_reason/breaking_change_count/diff_summary/request_id/checked_at`。
- 已新增审计事件 `platform.integration.contract.consistency_checked`，支持按 `request_id` 查询；通过/阻断路径均记录。
- 已将一致性检查接口纳入权限声明与幂等保护，并补齐 OpenAPI path/schema/examples（成功/阻断/依赖异常）。
- 已新增发布门禁脚本 `apps/api/scripts/check-integration-contract-consistency.js`，并在 `tools/release-gate-report.js` 增加阻断组 `integration-contract-consistency`（FR41/FR58）。
- 已扩展 API/路由权限/路由接线/门禁分组测试，且通过全量回归。
- 已完成代码审查修复：门禁脚本检查项补齐 `request_id`，并增强失败详情可读性。
- 已修复门禁失败分类对 `"blocking": true` 空格敏感问题，并补充回归测试覆盖压缩 JSON 场景。
- 已修复一致性校验基线绕过风险：当 `baseline_version` 非当前 active 基线时，返回 `integration_contract_consistency_blocked`（`failure_reason=baseline_version_mismatch`）。
- 已补充 fail-closed 回归：active 基线读取结果畸形时返回 `503`（`integration-contract-active-read-result-malformed`）。
- 已细化发布门禁分类：`consistency.runtime` 运行时异常归类为 `integration-contract-consistency-check-failed`，与业务阻断原因分离。
- 已修复发布门禁误分类：一致性门禁失败原因改为优先基于结构化报告判定，避免 setup 失败被误标记为业务阻断。
- 已补齐一致性阻断原因覆盖：新增 `baseline_version_mismatch/candidate_status_invalid` 的稳定识别与回归断言。
- 已增强门禁脚本健壮性：validator 异常改为记录失败细节而非直接抛出，并在非 JSON 响应场景保持可诊断输出。

### File List

- `_bmad-output/implementation-artifacts/5-3-集成变更前契约一致性校验.md`
- `apps/api/package.json`
- `apps/api/scripts/check-integration-contract-consistency.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/platform/integration-contract.constants.js`
- `apps/api/src/modules/platform/integration-contract.routes.js`
- `apps/api/src/modules/platform/integration-contract.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/http-routes.test.js`
- `apps/api/test/check-integration-contract-consistency.script.test.js`
- `apps/api/test/platform.integration.contract.api.test.js`
- `apps/api/test/release-gate-report.test.js`
- `apps/api/test/route-permissions.test.js`
- `docs/runbooks/integration/contract-version-rollout.md`
- `tools/release-gate-report.js`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-22：完成 Story 5.3 全量实现与测试回归，状态更新为 `review`。
- 2026-02-22：完成代码审查修复与回归验证，状态更新为 `done`。
- 2026-02-22：追加审查修复 baseline mismatch 绕过风险，并补齐相关回归测试与 OpenAPI 示例。
- 2026-02-22：追加审查修复发布门禁失败分类，区分运行时异常与业务阻断并补齐回归测试。
- 2026-02-22：追加审查修复 consistency gate 误分类与脚本断言脆弱性，补齐结构化分类与容错回归测试。
