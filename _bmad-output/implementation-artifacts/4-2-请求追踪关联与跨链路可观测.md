# Story 4.2: 请求追踪关联与跨链路可观测

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 运维与安全团队,  
I want 关键业务操作与集成交互共享追踪标识,  
so that 可从单次请求快速定位全链路行为。

## Acceptance Criteria

1. **Given** 任一关键业务请求进入系统  
   **When** 请求经过内部服务与外部集成链路  
   **Then** `request_id` 与 `trace` 标识全链路透传  
   **And** 日志、审计、错误响应可相互关联
2. **Given** 请求跨同步与异步通道  
   **When** 事件进入队列或回调  
   **Then** 追踪标识被保留  
   **And** 可用于后续回放与故障定位

## Tasks / Subtasks

- [x] 任务 1：统一追踪上下文模型与入站规范（AC: 1, 2）
  - [x] 在 `apps/api/src/server.js` 增加统一 trace 上下文解析函数，明确 `request_id` 与 `traceparent` 的规范化规则（非法值 fail-closed 为 `null`，`request_id` 保持现有安全归一策略）。
  - [x] 对于缺失 `traceparent` 的入站请求，定义并落地“可追踪但不伪造上游链路”的策略（推荐：生成服务端根 traceparent 并明确采样位；或明确 fallback 标记并写入 metadata，二选一且全链路一致）。
  - [x] 在请求生命周期内统一携带 `{ requestId, traceparent }`，避免路由分发层遗漏参数透传。

- [x] 任务 2：补齐同步链路关联输出（AC: 1）
  - [x] 所有 Problem Details 错误响应保留 `request_id`，并补充 `traceparent`（可空但必须稳定字段）。
  - [x] 关键成功响应与错误响应均回写 `X-Request-Id` 响应头；若存在 `traceparent`，回写 `traceparent` 响应头。
  - [x] 日志输出统一携带 `request_id`，并在可用时输出 `traceparent`，禁止仅在部分模块输出。

- [x] 任务 3：补齐审计查询与追踪过滤能力（AC: 1）
  - [x] 扩展 `GET /platform/audit/events` 与 `GET /tenant/audit/events` 支持 `traceparent` 过滤（与现有 `request_id` 过滤并存）。
  - [x] 在 `apps/api/src/modules/audit/audit.service.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js` 增加参数校验与查询条件，保持 tenant 边界不被绕过。
  - [x] 更新 `apps/api/src/openapi.js` 中审计查询参数与 schema 示例，保证契约与实现一致。

- [x] 任务 4：定义异步/集成链路追踪信封（AC: 2）
  - [x] 在 `apps/api/src/infrastructure` 或 `apps/api/src/common` 增加通用 trace context helper（建议 `trace-context.js`），提供 `inject` / `extract` 能力，用于 HTTP 出站、Webhook、队列消息。
  - [x] 约束异步消息最小追踪字段：`event_id`、`request_id`、`traceparent`、`occurred_at`、`schema_version`，与架构文档事件最小字段对齐。
  - [x] 预留 DLQ/重放场景字段保持策略：重放不得丢失原始 `request_id` 与 `traceparent`，如需新增重放追踪 id，必须并列存储不覆盖原值。

- [x] 任务 5：接线关键业务写链路与集成入口（AC: 1, 2）
  - [x] 盘点并修补当前仍可能漏传 `traceparent` 的分发路径（`server.js` -> `http-routes.js` -> `*.routes.js` -> `*.service.js` -> `auth.service.js`）。
  - [x] 对后续集成能力（Epic 5）预置追踪接入点：所有 outbound client 调用入口必须接收 trace context，不得在业务函数内临时拼装。
  - [x] 对关键业务链路（组织创建、负责人变更、角色/成员状态写入）确认追踪字段在日志 + 审计 + 错误响应三处可交叉定位。

- [x] 任务 6：测试与门禁（AC: 1, 2）
  - [x] 新增/扩展 `apps/api/test/server.test.js`：验证响应头 `X-Request-Id` 与 `traceparent` 回写、非法 header 归一行为、Problem Details 包含追踪字段。
  - [x] 新增/扩展 `apps/api/test/audit.api.test.js`：验证 `traceparent` 过滤查询、分页组合、tenant 越权隔离。
  - [x] 新增 `apps/api/test/trace-context.test.js`（或同等测试）：验证同步 HTTP 与异步消息 trace context 的 inject/extract 规则。
  - [x] 在现有高风险链路回归中加入“日志/审计/错误响应三点关联同一 request_id+traceparent”断言，避免只测单点。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 统一 `traceparent` 版本校验大小写语义：拒绝 `FF` 等 forbidden version 变体，并输出规范化小写值（`apps/api/src/server.js`）。
- [x] [AI-Review][MEDIUM] 修复日志与 Problem Details 字段覆盖风险，防止 `extra/extensions` 覆盖规范化后的 `request_id/traceparent`（`apps/api/src/common/logger.js`、`apps/api/src/common/problem-details.js`）。
- [x] [AI-Review][MEDIUM] 修复 trace-context helper 在“入站 traceparent 存在但无效”时误生成 fallback 的行为，保持 fail-closed（`apps/api/src/common/trace-context.js`）。
- [x] [AI-Review][HIGH] 修复 `createApiApp` 解析器/全局异常路径的追踪关联缺口：确保 Problem Details 与响应头同步回写 `x-request-id/traceparent`（`apps/api/src/app.js`、`apps/api/test/auth.express.api.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 OpenAPI 审计查询 `traceparent` 正则与实现不一致：契约升级为大小写兼容十六进制（`apps/api/src/openapi.js`、`apps/api/test/server.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧日志输出 `traceparent` 语义：非法字符串统一 fail-closed 为 `null`，避免脏链路标识落盘（`apps/api/src/common/logger.js`、`apps/api/test/logger.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧 Problem Details `traceparent` 语义：仅允许 W3C 合法值，非法值不再透传到错误响应（`apps/api/src/common/problem-details.js`、`apps/api/test/problem-details.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧审计查询依赖输出校验：依赖层返回非法 `traceparent` 时 fail-closed 为 503，避免污染审计关联链路（`apps/api/src/modules/audit/audit.service.js`、`apps/api/test/audit.service.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧 `auth.service` 审计写入 `traceparent` 语义：从“字符串归一”升级为 W3C fail-closed，非法值不再写入审计持久层（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧 `auth.service.listAuditEvents` 的 `traceparent` 过滤参数校验：非法值前置拒绝为 `AUTH-400-INVALID-PAYLOAD`，避免错误输入劣化为依赖异常（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 统一 `auth.store.memory/mysql` 审计记录与过滤路径的 `traceparent` 归一策略：统一 W3C 规范化并在非法过滤参数时 fail-closed（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][MEDIUM] 修复 `auth.store.mysql` 审计时间格式语义漂移：持久化使用 MySQL DATETIME 格式，API 输出保持 ISO-8601，避免 `occurred_at` 跨实现不一致（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 `auth.store.mysql` 对 MySQL DATETIME 字符串的时区歧义解析：显式按 UTC 解析 `YYYY-MM-DD HH:mm:ss(.SSS)`，避免非 UTC 运行环境下 `occurred_at` 输出漂移（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] 修复 `trace-context.inject` 在 HTTP 注入时对无效/缺失 `traceparent` 保留旧 header 的问题：清理大小写变体后再按规范回写，避免脏链路标识泄漏（`apps/api/src/common/trace-context.js`、`apps/api/test/trace-context.test.js`）。
- [x] [AI-Review][MEDIUM] 收紧 `trace-context.extract` 对多值 `x-request-id/traceparent` 的 fail-closed 语义：拒绝歧义头并保持 fallback 规则一致，避免关联链路被伪造（`apps/api/src/common/trace-context.js`、`apps/api/test/trace-context.test.js`）。
- [x] [AI-Review][MEDIUM] 统一 `request_id` 类型契约：`logger`/`ProblemDetails` 对非标识值归一为 `request_id_unset`，防止对象值污染日志与错误响应（`apps/api/src/common/logger.js`、`apps/api/src/common/problem-details.js`、`apps/api/test/logger.test.js`、`apps/api/test/problem-details.test.js`）。
- [x] [AI-Review][HIGH] 修复认证入口链路 `traceparent` 透传断点：补齐 `server -> http-routes -> auth.routes -> auth.service` 在 `login/otp/send/otp/login/refresh/logout` 路径的透传与审计继承绑定，避免同一请求在日志与审计中出现链路断裂（`apps/api/src/server.js`、`apps/api/src/http-routes.js`、`apps/api/src/modules/auth/auth.routes.js`、`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/server.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复 `auth.service` 基于全局 `Map<request_id, traceparent>` 的并发串链风险：同一 `request_id` 并发请求会发生 `traceparent` 覆盖导致审计事件误关联；已改为 `AsyncLocalStorage` 上下文继承并新增并发回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复幂等重放响应体的 `traceparent` 旧值泄漏：`withPatchedResponseRequestId` 仅重写 `request_id` 会导致重放时“响应头 traceparent=当前请求、响应体 traceparent=首请求”；已扩展为同步重绑响应体 `traceparent` 并新增回归（`apps/api/src/server.js`、`apps/api/test/server.test.js`）。
- [x] [AI-Review][MEDIUM] 修复幂等退化审计事件 `traceparent` 透传缺口：`server` 在 `emitAuthIdempotencyAuditEvent` 向 `auth.service.recordIdempotencyEvent` 传递链路追踪字段，确保幂等退化日志可与错误响应同链路关联（`apps/api/src/server.js`、`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/server.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 修复 OpenAPI `ProblemDetails` 契约稳定字段偏差：`traceparent` 调整为必备且可空（required + nullable），与实现“稳定字段”语义一致（`apps/api/src/openapi.js`、`apps/api/test/server.test.js`）。

## Dev Notes

### Developer Context（开发者必须先读）

- Story 4.1 已完成审计持久化与按域查询，`audit_events` 已包含 `request_id` 与 `traceparent` 字段；4.2 不要重复造审计模型，重点是“跨链路关联一致性”。
- 当前代码已实现大量 `traceparent` 参数透传，但模式仍以手工参数传递为主，遗漏风险主要发生在 `server` 分发层与新加路由接线阶段。
- 当前仓库尚未落地 `modules/integration` 与 `events/*` 目录实现，4.2 需先定义并固化追踪信封规范，给 Epic 5 实现留出稳定接口。

### Technical Requirements（实现硬约束）

- 直接覆盖：`FR44`（关键业务操作与集成交互关联到可追踪请求标识）。
- 同步满足：
  - `NFR15`：集成链路追踪字段覆盖率（`request_id`/`traceparent`）`>=99%`。
  - `NFR22`：验证证据必须可归档（测试报告与回归证据）。
- 追踪字段约束：
  - `request_id`：始终可用，输出到日志、审计、错误响应。
  - `traceparent`：遵循 W3C Trace Context，允许为空但不允许脏值。
  - 禁止新增并行追踪字段命名（如 `traceId`、`trace_id`）破坏一致性，若需要展示可由 `traceparent` 解析派生但不替代原字段。

### Architecture Compliance（架构对齐清单）

- 必须对齐 `architecture.md` 中的 `request_id / traceparent 全链路贯穿` 约束。
- 必须遵循事件模式最小字段（`event_id`、`request_id`、`occurred_at`、`schema_version`、`data`）并在 4.2 增补 `traceparent` 不破坏兼容。
- 错误输出继续走 Problem Details，禁止新增第二套错误结构。
- tenant 边界保持 fail-closed：任何 trace 查询或关联能力不得绕过现有域隔离规则。

### Library & Framework Requirements（库与框架要求）

- 当前工程版本（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `ioredis`: `5.9.2`
- 最新稳定核验（2026-02-21）：
  - Node 24 LTS 最新：`v24.13.1`
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `ioredis`: `5.9.3`
  - `@opentelemetry/api`: `1.9.0`
  - `@opentelemetry/sdk-node`: `0.212.0`
- 本故事不强制引入 OpenTelemetry SDK；若引入必须在故事内补齐依赖评估与回归基线，不得破坏现有请求处理链路。

### File Structure Requirements（建议变更落点）

- 追踪上下文与分发：
  - `apps/api/src/server.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/common/problem-details.js`
  - `apps/api/src/common/logger.js`
- 审计查询扩展：
  - `apps/api/src/modules/audit/audit.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 契约文档：
  - `apps/api/src/openapi.js`
- 新增通用能力（建议）：
  - `apps/api/src/common/trace-context.js`（或 `apps/api/src/infrastructure/trace-context.js`）
- 测试：
  - `apps/api/test/server.test.js`
  - `apps/api/test/audit.api.test.js`
  - `apps/api/test/auth.service.test.js`（必要时）
  - `apps/api/test/trace-context.test.js`（新增建议）

### Testing Requirements（必须覆盖）

- AC1 覆盖：
  - 入站 header 归一、响应头回写、Problem Details 追踪字段、日志字段完整性。
  - 同一业务请求可在日志、审计、错误响应三处通过 `request_id` + `traceparent` 关联。
- AC2 覆盖：
  - 异步信封（队列/Webhook）提取与透传规则。
  - 重放场景中原始追踪字段保持不丢失。
- 回归门禁：
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`
  - 目标测试建议至少包含：`server.test.js`、`audit.api.test.js`、`auth.service.test.js`。

### Previous Story Intelligence（来自 4.1）

- 高风险教训 1：业务成功前提前 `return` 会导致审计落库遗漏，4.2 所有追踪写入必须保持 fail-closed 或明确降级语义。
- 高风险教训 2：`traceparent` 最容易在分发层丢失，必须优先检查 `server.js` 与 `http-routes.js` 的参数接线。
- 高风险教训 3：仅补业务代码不足以兜底，必须有回归用例显式断言 `request_id/traceparent` 持久化与透传。

### Git Intelligence Summary（最近提交模式）

- 最近 5 次提交集中在：`auth.service`、`auth.store.mysql/memory`、`server/http-routes`、`openapi`、`apps/api/test/*`。
- 变更模式稳定：先修分发透传，再补持久化审计，最后补契约与回归测试。
- 对 4.2 的直接启示：实现应继续走“路由接线 -> 领域服务 -> 持久层 -> OpenAPI -> 回归测试”顺序，减少回归反复。

### Latest Tech Information（外部最新信息）

- W3C Trace Context 推荐规范仍以 `traceparent` / `tracestate` 为跨服务追踪标准（Recommendation）。
- Node.js 当前 LTS 线为 v24，最新补丁 `v24.13.1`；仓库 `>=24.0.0` 约束与之兼容。
- 若后续接入 OTel，需注意 API 稳定包与 SDK 版本线差异（`@opentelemetry/api` 与 `@opentelemetry/sdk-node` 不同节奏），避免误判兼容性。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 本故事上下文依据：
  - `epics.md`（Epic 4 / Story 4.2）
  - `prd.md`（FR44 / NFR15）
  - `architecture.md`（通信模式与可观测约束）
  - `ux-design-specification.md`（Journey 6 运维闭环字段）
  - `4-1-审计事件记录与按域查询.md`（上一故事经验）

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Code review completed with adversarial findings resolved and regression gates passing.`

### References

- `_bmad-output/planning-artifacts/epics.md`（Epic 4 / Story 4.2）
- `_bmad-output/planning-artifacts/prd.md`（FR44、NFR15）
- `_bmad-output/planning-artifacts/architecture.md`（request_id/traceparent 全链路、事件模式、异步通道约束）
- `_bmad-output/planning-artifacts/ux-design-specification.md`（Journey 6 最小可观测字段契约）
- `_bmad-output/implementation-artifacts/4-1-审计事件记录与按域查询.md`（上一故事实现与复盘）
- `https://www.w3.org/TR/trace-context/`
- `https://nodejs.org/en/about/previous-releases`
- `https://nodejs.org/dist/index.json`
- `https://www.npmjs.com/package/@opentelemetry/api`
- `https://www.npmjs.com/package/@opentelemetry/sdk-node`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `pnpm --dir apps/api exec node --test test/server.test.js test/audit.api.test.js test/trace-context.test.js`（初次失败，定位 `auth.service` 未透传 `traceparent` 过滤参数，修复后通过）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "express critical password change|express platform role-facts replace converges" test/auth.express.api.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/logger.test.js test/problem-details.test.js test/trace-context.test.js test/server.test.js`（pass）
- `pnpm --dir apps/api exec node --test --test-name-pattern "createApiApp parser and fallback error responses include access-control-allow-origin|createApiApp global error handler includes AUTH-500-INTERNAL error_code" test/auth.express.api.test.js`（pass）
- `pnpm --dir apps/api exec node --test test/logger.test.js test/problem-details.test.js test/trace-context.test.js test/audit.service.test.js test/audit.api.test.js test/server.test.js`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`（pass）
- `pnpm --dir apps/api test`（pass，`947/947`）
- `pnpm --dir apps/api lint`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "updatePlatformUserStatus fail-closes invalid traceparent in persisted audit event|listAuditEvents rejects invalid traceparent filter with AUTH-400-INVALID-PAYLOAD" test/auth.service.test.js`（pass）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`949/949`）
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.store.mysql.test.js`（pass，`109/109`）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "recordAuditEvent persists MySQL datetime but returns ISO occurred_at|listAuditEvents normalizes MySQL datetime string occurred_at payloads to ISO-8601 output" test/auth.store.mysql.test.js`（pass）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`951/951`）
- `pnpm --dir apps/api exec node --test test/trace-context.test.js test/logger.test.js test/problem-details.test.js`（pass）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`954/954`）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "dispatchApiRoute forwards traceparent to auth login handler|login audit events include traceparent when provided" test/server.test.js test/auth.service.test.js`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/server.test.js test/auth.service.test.js test/auth.api.test.js test/auth.express.api.test.js`（pass，`446/446`）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`956/956`）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "sendOtp keeps traceparent isolated for concurrent same request_id" test/auth.service.test.js`（初次失败，定位同 `request_id` 并发下 `traceparent` 串链；修复后通过）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "sendOtp keeps traceparent isolated for concurrent same request_id|login audit events include traceparent when provided" test/auth.service.test.js`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/server.test.js test/auth.service.test.js test/auth.api.test.js test/auth.express.api.test.js`（pass，`447/447`）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`957/957`）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "dispatchApiRoute rebinds replayed response traceparent to current request trace context" test/server.test.js`（初次失败，定位幂等重放响应体 `traceparent` 复用首请求值；修复后通过）
- `pnpm --dir apps/api exec node --test --test-force-exit --test-name-pattern "dispatchApiRoute rebinds replayed response traceparent to current request trace context|dispatchApiRoute preserves legacy auth idempotency reservation for non-5xx responses" test/server.test.js`（pass）
- `pnpm --dir apps/api exec node --test --test-force-exit test/server.test.js test/auth.service.test.js test/auth.api.test.js test/auth.express.api.test.js`（pass，`448/448`）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test`（pass，`958/958`）
- `pnpm --dir apps/api exec node --test test/server.test.js test/auth.service.test.js`（pass，`348/348`）
- `pnpm --dir apps/api lint`（pass，`67 files checked`）
- `pnpm --dir apps/api test | rg "^ℹ (tests|pass|fail)"`（pass，`958/958`）

### Senior Developer Review (AI)

- [HIGH] `traceparent` forbidden version 校验存在大小写绕过，`FF` 变体可被错误接收；已修复为统一小写归一后校验并补测试（`apps/api/src/server.js`、`apps/api/test/server.test.js`）。
- [MEDIUM] `logger` 与 `ProblemDetails` 在对象展开顺序上可被扩展字段覆盖规范化追踪字段；已修复为最终字段强制落盘并补测试（`apps/api/src/common/logger.js`、`apps/api/src/common/problem-details.js`、`apps/api/test/logger.test.js`、`apps/api/test/problem-details.test.js`）。
- [MEDIUM] `trace-context.extract` 在无效入站 `traceparent` 且开启 fallback 时会误生成新链路；已修复为仅“缺失字段”才生成 fallback，并补 fail-closed 测试（`apps/api/src/common/trace-context.js`、`apps/api/test/trace-context.test.js`）。
- [HIGH] Express 运行时 `createApiApp` 的解析器/全局异常分支未稳定输出 `traceparent`，导致错误路径无法与日志/审计统一关联；已修复并补 express 回归（`apps/api/src/app.js`、`apps/api/test/auth.express.api.test.js`）。
- [MEDIUM] OpenAPI 中审计查询 `traceparent` pattern 仅小写，与实现接受大小写输入不一致；已修复契约与回归（`apps/api/src/openapi.js`、`apps/api/test/server.test.js`）。
- [MEDIUM] `logger.log` 对字符串 `traceparent` 仅做 trim 未做规范校验，存在脏值落日志风险；已修复为复用统一 W3C 归一并补负向测试（`apps/api/src/common/logger.js`、`apps/api/test/logger.test.js`）。
- [MEDIUM] `buildProblemDetails` 对字符串 `traceparent` 仅做 trim 未做规范校验，存在脏值透传风险；已修复为复用统一 W3C 归一并补负向测试（`apps/api/src/common/problem-details.js`、`apps/api/test/problem-details.test.js`）。
- [MEDIUM] `audit.service` 对依赖层返回的事件 `traceparent` 缺少规范校验，可能把非法值带到审计查询响应；已修复为 fail-closed 并新增单测（`apps/api/src/modules/audit/audit.service.js`、`apps/api/test/audit.service.test.js`）。
- [MEDIUM] `auth.service.recordPersistentAuditEvent` 对 `traceparent` 仅做字符串归一，非法值存在入库风险；已修复为统一 W3C 归一并新增负向回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [MEDIUM] `auth.service.listAuditEvents` 对非法 `traceparent` 过滤参数缺少前置校验，错误输入会劣化为依赖异常语义；已修复为返回 `AUTH-400-INVALID-PAYLOAD` 并新增单测（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [MEDIUM] `auth.store.memory/mysql` 在审计 `traceparent` 的存储与过滤路径上归一规则不统一；已统一为 W3C 规范化并在非法过滤参数时 fail-closed（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [MEDIUM] `auth.store.mysql` 在审计时间字段上混用了“入库格式”和“输出格式”，导致 `occurred_at` 在字符串行数据下可能输出为 MySQL DATETIME 而非 ISO；已修复为“入库 DATETIME、输出 ISO”并新增回归（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [MEDIUM] `auth.store.mysql` 对 `YYYY-MM-DD HH:mm:ss(.SSS)` 的隐式 `Date` 解析依赖运行时时区，非 UTC 环境可能造成 `occurred_at` 输出漂移；已修复为显式 UTC 解析并新增回归（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [HIGH] `trace-context.inject` 在 HTTP 注入分支会保留 `target` 内已存在的 `traceparent`（含大小写变体），当当前链路 `traceparent` 无效时会泄漏旧链路标识；已修复为注入前先移除 `x-request-id/traceparent` 的大小写变体并补回归（`apps/api/src/common/trace-context.js`、`apps/api/test/trace-context.test.js`）。
- [MEDIUM] `trace-context.extract` 对 HTTP 多值头（数组/重复头）未 fail-closed，可能接受首值造成追踪关联歧义；已修复为歧义输入直接拒绝并沿用 fallback 策略（`apps/api/src/common/trace-context.js`、`apps/api/test/trace-context.test.js`）。
- [MEDIUM] `logger` 与 `buildProblemDetails` 的 `request_id` 允许非字符串对象透传，违反错误与日志契约；已修复为统一归一为字符串（非法时 `request_id_unset`）并补测试（`apps/api/src/common/logger.js`、`apps/api/src/common/problem-details.js`、`apps/api/test/logger.test.js`、`apps/api/test/problem-details.test.js`）。
- [HIGH] 认证入口链路 `server -> http-routes -> auth.routes -> auth.service` 在 `login/otp/send/otp/login/refresh/logout` 分发中缺少统一 `traceparent` 透传，导致请求主链路与认证审计事件可能断链；已补齐路由签名与 service 绑定策略，并新增路由透传+审计继承回归（`apps/api/src/server.js`、`apps/api/src/http-routes.js`、`apps/api/src/modules/auth/auth.routes.js`、`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/server.test.js`、`apps/api/test/auth.service.test.js`）。
- [HIGH] `auth.service` 通过全局 `Map<request_id, traceparent>` 继承追踪上下文，在同 `request_id` 并发请求下会发生覆盖串链，导致审计事件 `traceparent` 错绑；已替换为 `AsyncLocalStorage` 请求上下文继承并补并发回归（`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/auth.service.test.js`）。
- [HIGH] 幂等重放在响应体层面仅重写 `request_id`、未重写 `traceparent`，导致 replay 命中时出现“响应头 traceparent 与响应体 traceparent 不一致”并泄漏首请求链路；已修复 `withPatchedResponseRequestId` 同步重绑 `traceparent` 并补回归（`apps/api/src/server.js`、`apps/api/test/server.test.js`）。
- [MEDIUM] 幂等退化审计事件缺少 `traceparent`，导致退化事件难以与同请求错误响应做跨日志关联；已补齐 `emitAuthIdempotencyAuditEvent -> recordIdempotencyEvent` 的 `traceparent` 传递并新增回归（`apps/api/src/server.js`、`apps/api/src/modules/auth/auth.service.js`、`apps/api/test/server.test.js`、`apps/api/test/auth.service.test.js`）。
- [MEDIUM] OpenAPI `ProblemDetails` 未将 `traceparent` 标记为 required，导致契约层面对“稳定字段”约束弱化；已修复 required 集合并补契约断言（`apps/api/src/openapi.js`、`apps/api/test/server.test.js`）。

### Completion Notes List

- 在 `server.js` 完成统一 trace 上下文解析与透传：非法 `traceparent` fail-closed 为 `null`，缺失时生成服务端根 `traceparent`，并统一回写 `x-request-id`/`traceparent` 响应头。
- 在 `problem-details.js` 与 `logger.js` 建立稳定追踪字段输出：Problem Details 固定包含 `traceparent`（可空），结构化日志固定包含 `traceparent`（可空）。
- 扩展审计查询链路支持 `traceparent` 过滤：`audit.service` 参数校验、`auth.service` 参数透传、`auth.store.mysql/memory` 查询条件与 tenant 边界保持 fail-closed。
- 新增通用 `trace-context` helper，覆盖 HTTP/异步信封 inject/extract 与 replay 保留策略，满足最小字段约束（`event_id/request_id/traceparent/occurred_at/schema_version`）。
- 更新 OpenAPI 契约：审计查询新增 `traceparent` 参数，`ProblemDetails` schema 新增 `traceparent` 字段并保持可空。
- 修复 MySQL 严格模式下 `audit_events.occurred_at` 写入/筛选时间格式，统一为 `YYYY-MM-DD HH:mm:ss.SSS`，消除 `er_truncated_wrong_value` 导致的 503。
- 新增/扩展回归覆盖 `server.test.js`、`audit.api.test.js`、`trace-context.test.js`、`auth.express.api.test.js`，并通过全量测试与 lint。
- 代码审查阶段修复 3 项问题：`traceparent` 大小写版本绕过、日志/错误结构字段覆盖风险、helper 对无效追踪头误生成 fallback；新增 `logger/problem-details` 测试并升级回归到 `947/947`。
- 二次审查补齐 Express 路径追踪一致性：`createApiApp` 在 parser/global-error 分支统一回写 `x-request-id/traceparent`，并修正歧义 `x-request-id` 回退策略。
- 修正 OpenAPI `traceparent` 查询参数模式为大小写兼容，消除契约与实现偏差。
- 三次深审继续收敛 `traceparent` 数据质量：统一对日志、Problem Details、审计依赖输出执行 W3C fail-closed 归一；新增 `audit.service` 单测并确认全量 `947/947` + lint 通过。
- 四次深审继续收敛 auth 审计链路：统一 `auth.service` 与 `auth.store.memory/mysql` 的 `traceparent` 写入/过滤归一策略，非法 `traceparent` 过滤参数改为 `AUTH-400-INVALID-PAYLOAD`，并新增 `auth.service` 负向用例；全量回归 `949/949` + lint 通过。
- 五次深审修复 `auth.store.mysql` 审计时间输出一致性：将 `occurred_at` 规范为“存储层 DATETIME 格式、接口层 ISO-8601 格式”，新增 `auth.store.mysql` 双向回归（写入参数/查询输出），确认全量 `951/951` + lint 通过。
- 六次深审修复 MySQL DATETIME 时区歧义：`auth.store.mysql` 对字符串时间改为显式 UTC 解析，避免非 UTC 运行环境输出漂移；补充针对性回归并确认全量 `951/951` + lint 通过。
- 七次深审收敛 trace helper 与输出契约：修复 HTTP 注入旧 `traceparent` 泄漏、收紧多值头 fail-closed、统一 `request_id` 类型约束；新增/扩展 `trace-context/logger/problem-details` 回归并确认全量 `954/954` + lint 通过。
- 八次深审补齐认证入口链路 trace 透传：修复 `login/otp/send/otp/login/refresh/logout` 在分发到认证服务时的 `traceparent` 断点，并通过 `request_id -> traceparent` 绑定保证认证审计事件继承同链路追踪；新增 `server/auth.service` 回归并确认全量 `956/956` + lint 通过。
- 九次深审修复并发串链：将 `auth.service` 的追踪继承从全局 `request_id` 映射改为 `AsyncLocalStorage`，消除同 `request_id` 并发场景 `traceparent` 覆盖；新增并发回归并确认全量 `957/957` + lint 通过。
- 十次深审修复幂等重放响应体链路错绑：为 replay 命中路径补齐 `traceparent` 重写，确保响应头与响应体统一绑定当前请求链路；新增 server 回归并确认全量 `958/958` + lint 通过。
- 十一次深审修复幂等退化审计链路断点：补齐 `recordAuthIdempotencyEvent` 的 `traceparent` 透传，确保幂等退化事件可与同请求错误响应按 `request_id+traceparent` 关联；同步修复 OpenAPI `ProblemDetails` 将 `traceparent` 标记为 required+nullable，并确认全量 `958/958` + lint 通过。

### File List

- `_bmad-output/implementation-artifacts/4-2-请求追踪关联与跨链路可观测.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/src/server.js`
- `apps/api/src/common/problem-details.js`
- `apps/api/src/common/logger.js`
- `apps/api/src/common/trace-context.js`
- `apps/api/src/app.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/audit/audit.service.js`
- `apps/api/src/modules/auth/auth.routes.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/openapi.js`
- `apps/api/test/server.test.js`
- `apps/api/test/audit.api.test.js`
- `apps/api/test/trace-context.test.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/problem-details.test.js`
- `apps/api/test/logger.test.js`
- `apps/api/test/audit.service.test.js`

## Change Log

- 2026-02-21：完成 Story 4.2 主体实现，统一 `request_id/traceparent` 入站规范、响应头回写、Problem Details 与日志关联字段，并新增异步链路 `trace-context` helper。
- 2026-02-21：完成审计查询 `traceparent` 过滤（平台域/组织域）与 OpenAPI 契约同步，补齐 server/audit/trace-context 回归测试。
- 2026-02-21：修复 MySQL `audit_events.occurred_at` 时间格式兼容性问题并清理临时调试，`pnpm --dir apps/api test` 与 `pnpm --dir apps/api lint` 全通过。
- 2026-02-21：代码审查修复 `traceparent` 大小写版本绕过、字段覆盖风险、invalid-trace fallback 偏差；新增 `logger/problem-details` 回归并确认 `947/947` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 Express parser/global-error 链路追踪缺口与 OpenAPI traceparent 契约偏差，回归 `947/947` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复日志/Problem Details/审计依赖输出的 `traceparent` 脏值透传风险；新增 `audit.service` fail-closed 单测，回归 `947/947` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 auth 审计链路 `traceparent` 归一缺口：`auth.service` 写入/查询参数前置校验、`auth.store.memory/mysql` 存储与过滤统一 W3C fail-closed；新增 `auth.service` 负向回归，确认 `949/949` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 `auth.store.mysql` 审计时间格式语义漂移：持久化层保持 MySQL DATETIME，查询输出统一 ISO-8601；新增 `auth.store.mysql` 回归，确认 `951/951` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 `auth.store.mysql` 对 MySQL DATETIME 字符串的时区歧义解析：统一按 UTC 解析，避免 `occurred_at` 在非 UTC 运行环境漂移；补充针对性回归并确认 `951/951` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 trace helper 与输出契约缺口：收紧 `trace-context` 的 HTTP 注入/提取 fail-closed 语义，统一 `logger/problem-details` 的 `request_id` 字符串契约；新增回归并确认 `954/954` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复认证入口链路 `traceparent` 透传断点：补齐 `server/http-routes/auth.routes/auth.service` 在 `login/otp/send/otp/login/refresh/logout` 的透传与审计继承绑定；新增 `server/auth.service` 回归并确认 `956/956` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复 `auth.service` 并发追踪串链：将 `request_id` 映射继承替换为 `AsyncLocalStorage`，消除同 `request_id` 并发下 `traceparent` 覆盖；新增并发回归并确认 `957/957` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复幂等重放响应体 `traceparent` 旧值泄漏：`withPatchedResponseRequestId` 从仅重写 `request_id` 升级为同步重绑 `traceparent`；新增 replay 回归并确认 `958/958` + lint 通过。
- 2026-02-21：继续 4-2 深审并修复幂等退化审计 `traceparent` 透传缺口，同时将 OpenAPI `ProblemDetails.traceparent` 契约升级为 required+nullable；新增 `server/auth.service` 回归并确认全量 `958/958` + lint 通过。
