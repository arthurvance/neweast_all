# Story 3.1: 组织成员管理与身份复用

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 组织负责人或组织管理员,  
I want 在组织内创建与维护成员并复用全局用户身份,  
so that 组织人员治理可持续且不产生重复身份。

## Acceptance Criteria

1. **Given** 组织管理员新增成员手机号  
   **When** 手机号已存在全局用户身份  
   **Then** 系统复用该用户身份创建组织成员关系  
   **And** 不重复创建用户主档
2. **Given** 同一用户加入多个组织  
   **When** 维护其组织关系  
   **Then** 每个组织拥有独立成员关系与角色绑定  
   **And** 组织间状态互不污染
3. **Given** 成员被离组后再次加入  
   **When** 重新入组流程完成  
   **Then** 系统形成新的有效成员关系  
   **And** 历史关系保留用于审计追踪
4. **Given** 组织成员状态需要被治理（FR20）  
   **When** 组织管理员执行启用/禁用变更  
   **Then** 系统更新成员关系状态并即时生效  
   **And** 该变更仅影响组织域访问，不影响平台域访问

## Tasks / Subtasks

- [x] 任务 1：交付组织成员治理 API 面（AC: 1, 2, 4）
  - [x] 新增 tenant 成员治理路由（建议：`GET /tenant/members`、`POST /tenant/members`、`PATCH /tenant/members/:membership_id/status`），并保持与现有 `Problem Details`、鉴权、幂等语义一致。
  - [x] 受保护接口统一声明 `tenant.member_admin.operate` / `tenant.member_admin.view`，`scope=tenant`。
  - [x] 所有 tenant 写接口仅信任服务端会话中的 `active_tenant_id`，禁止从请求体/查询参数直接采信租户上下文。
  - [x] 与现有 `POST /auth/tenant/member-admin/provision-user` 保持兼容（可保留为适配入口），避免一次性破坏现网调用。

- [x] 任务 2：实现“身份复用优先”的成员创建链路（AC: 1）
  - [x] 创建成员时先按手机号查全局 `users`，存在则复用 `user_id`，不存在再创建用户主档。
  - [x] 复用既有用户身份时不得修改密码与认证凭据（对齐 FR60）。
  - [x] 新建用户时仅初始化密码哈希，不落明文，并沿用默认密码策略读取链路（对齐 FR59）。
  - [x] 审计事件至少覆盖：成员创建成功、身份复用成功、创建拒绝（含 `request_id`、操作者、tenant、目标手机号）。

- [x] 任务 3：补齐“可重入组 + 保留历史”的成员关系模型（AC: 2, 3）
  - [x] 修复当前 `auth_user_tenants` 单行唯一关系模型无法保留历史的问题（当前 `uk_auth_user_tenants_user_tenant` 会阻断“新关系”）。
  - [x] 设计并落地“一个用户同一组织最多 1 条活跃关系 + 多条历史关系可留存”的数据模型（推荐使用成员关系生命周期字段或历史表）。
  - [x] 重新入组必须生成新的有效关系标识（新 `membership_id`/等价标识），旧关系保留并可审计。
  - [x] 确保 MySQL 与内存 store 语义一致，避免本地/集成行为漂移。

- [x] 任务 4：实现成员状态治理与会话收敛（AC: 4）
  - [x] 交付成员状态更新能力（启用/禁用，及后续离组前置能力），状态变更后即时影响组织域权限判定。
  - [x] 禁用或离组后，撤销该成员在 tenant 域的活跃会话与 refresh token；平台域会话不受影响。
  - [x] 组织禁用与成员禁用语义保持一致：tenant 入口拒绝，错误码稳定可映射。
  - [x] 变更后 `tenant_options` 与 `tenant_permission_context` 必须可即时读到最新状态。

- [x] 任务 5：保证跨组织独立性与后续故事可扩展性（AC: 2, 3）
  - [x] 同一 `user_id` 在不同 `tenant_id` 的成员状态、角色绑定、权限上下文必须隔离，不允许相互污染。
  - [x] 为 Story 3.2/3.3 预留稳定关系主键（成员角色绑定必须锚定“成员关系”，而非仅 `user_id+tenant_id`）。
  - [x] 约束“禁用角色不参与权限计算”与“组织角色并集计算”的数据读取入口，避免后续返工。

- [x] 任务 6：契约、门禁与回归矩阵（AC: 1-4）
  - [x] OpenAPI 补齐新增接口请求/响应/错误示例（400/401/403/404/409/413/503），并明确 `retryable` 语义。
  - [x] 路由权限声明必须通过 `check:route-permissions`，杜绝漏声明受保护接口。
  - [x] 回归至少覆盖：身份复用、跨组织隔离、离组重入、成员状态切换、tenant 会话收敛、幂等冲突、错误码映射一致性。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 已修复 `createRouteHandlers` 对 `tenantMemberService` 的 `authService` 一致性校验失效：`member.service` 暴露 `_internals.authService`，并新增 mismatch 回归，防止注入不同鉴权实例导致路由授权语义漂移。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][MEDIUM] 已将 `membership_id` 上限统一收敛为 `64`（与 `auth_user_tenants.membership_id VARCHAR(64)` 对齐），消除请求校验与 OpenAPI 契约漂移。`apps/api/src/modules/tenant/member.service.js`, `apps/api/src/openapi.js`, `apps/api/test/server.test.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 Story `File List` 漏记文件：`apps/api/test/auth.express.api.test.js`，修复“Git 变更与文档声明不一致”问题。`_bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md`
- [x] [AI-Review][HIGH] 已将历史表 `archived_reason` 与契约对齐为 `VARCHAR(256)`，消除合法 `reason` 输入导致的写历史退化。`apps/api/migrations/0012_tenant_member_lifecycle.sql:120`
- [x] [AI-Review][HIGH] 已将 `auth_user_tenant_membership_history` 缺失场景改为 fail-closed，返回稳定依赖不可用错误。`apps/api/src/modules/auth/auth.store.mysql.js:332`, `apps/api/src/modules/auth/auth.store.mysql.js:643`, `apps/api/src/modules/auth/auth.store.mysql.js:690`, `apps/api/test/auth.store.mysql.test.js:3002`
- [x] [AI-Review][HIGH] 已修复 `updateTenantMembershipStatus` SQL 占位符与参数数量不一致问题（9 placeholders / 9 params），避免 MySQL 执行期错误。`apps/api/src/modules/auth/auth.store.mysql.js:3520`, `apps/api/src/modules/auth/auth.store.mysql.js:3534`, `apps/api/test/auth.store.mysql.test.js:3009`
- [x] [AI-Review][MEDIUM] 已修复禁用后权限快照丢失问题：禁用不再清零 `can_*`，恢复 active 后可按最新授权恢复。`apps/api/src/modules/auth/auth.store.memory.js:1389`, `apps/api/src/modules/auth/auth.store.mysql.js:3522`, `apps/api/test/auth.service.test.js:7796`, `apps/api/test/auth.store.mysql.test.js:3009`
- [x] [AI-Review][MEDIUM] 已补齐真实回归（非 stub）：覆盖历史表 fail-closed 与禁用→恢复权限快照保留。`apps/api/test/auth.store.mysql.test.js:2955`, `apps/api/test/auth.service.test.js:7796`
- [x] [AI-Review][HIGH] 已修复旧库兼容路径首请求误判 `AUTH-404-TENANT-MEMBERSHIP-NOT-FOUND`：`membership_id` 字段缺失时，同请求内立即回退 legacy 更新分支。`apps/api/src/modules/auth/auth.store.mysql.js:3349`, `apps/api/src/modules/auth/auth.store.mysql.js:3453`, `apps/api/src/modules/auth/auth.store.mysql.js:3483`
- [x] [AI-Review][MEDIUM] 已补齐 MySQL store 回归：覆盖“首请求遇到 missing lifecycle columns 时立即 fallback 且状态更新成功”。`apps/api/test/auth.store.mysql.test.js:2955`
- [x] [AI-Review][MEDIUM] 已补齐 MySQL store 回归：覆盖 fallback 锁存行为（首错后后续请求不再探测 lifecycle 列）。`apps/api/test/auth.store.mysql.test.js:3033`
- [x] [AI-Review][HIGH] 已修复 `left -> active` 重入时历史权限快照复活问题：重入更新关系时强制清零 `can_*`，避免旧权限跨关系泄露。`apps/api/src/modules/auth/auth.store.memory.js:1361`, `apps/api/src/modules/auth/auth.store.mysql.js:3507`
- [x] [AI-Review][MEDIUM] 已补齐双实现真实回归：覆盖重入后权限快照清零（service + mysql store），防止后续回归。`apps/api/test/auth.service.test.js:7891`, `apps/api/test/auth.store.mysql.test.js:3228`
- [x] [AI-Review][MEDIUM] 已修复 OpenAPI 契约描述偏差：`PATCH /tenant/members/{membership_id}/status` 的 `409` 描述更新为“成员状态冲突或幂等冲突”，并加断言防回退。`apps/api/src/openapi.js:1140`, `apps/api/test/server.test.js:404`
- [x] [AI-Review][HIGH] 已修复 MySQL legacy 回退下“duplicate + left”误判冲突导致无法重入组：改为激活历史关系并清零 `can_*` 权限快照；覆盖“缺列回退锁存后可重入”回归。`apps/api/src/modules/auth/auth.store.mysql.js:2603`, `apps/api/src/modules/auth/auth.store.mysql.js:2665`, `apps/api/src/modules/auth/auth.store.mysql.js:2819`, `apps/api/test/auth.store.mysql.test.js:500`
- [x] [AI-Review][HIGH] 已修复 MySQL lifecycle 缺列回退路径在 `left -> active` 时权限快照复活：legacy 更新分支改为显式清零 `can_*`，防止旧权限跨关系复用。`apps/api/src/modules/auth/auth.store.mysql.js:3412`
- [x] [AI-Review][MEDIUM] 已补齐 MySQL store 回归：覆盖 lifecycle 缺列回退 + `left -> active` 场景，断言 legacy 路径会清零 `can_*`。`apps/api/test/auth.store.mysql.test.js:3110`
- [x] [AI-Review][MEDIUM] 已补齐 OpenAPI 契约完整性：`GET /tenant/members` 补充 `400/404/409/413` 响应声明，并新增 server 契约断言。`apps/api/src/openapi.js:940`, `apps/api/test/server.test.js:386`
- [x] [AI-Review][HIGH] 已修复成员创建后置关系查询异常未统一映射/审计问题：补充查询失败捕获与稳定 `AUTH-503-TENANT-MEMBER-DEPENDENCY-UNAVAILABLE` 返回，避免非预期 500 语义漂移。`apps/api/src/modules/tenant/member.service.js:532`, `apps/api/test/tenant.member.api.test.js:300`
- [x] [AI-Review][MEDIUM] 已补齐 `membership_id` 输入约束（长度上限 + 控制字符拒绝），并同步 OpenAPI path/schema 上限，降低超长路径输入风险。`apps/api/src/modules/tenant/member.service.js:196`, `apps/api/src/openapi.js:1103`, `apps/api/test/tenant.member.api.test.js:514`
- [x] [AI-Review][MEDIUM] 已补齐 `POST /tenant/members` 在 retryable 409 下“不缓存失败结果”的幂等回归，避免后续实现改动导致冲突结果被错误缓存。`apps/api/test/tenant.member.api.test.js:408`
- [x] [AI-Review][HIGH] 按“新项目无兼容负担”决策移除 MySQL lifecycle 缺列 legacy fallback，成员关系写路径改为 lifecycle-only fail-closed，避免与 AC3（重入生成新关系）语义冲突。`apps/api/src/modules/auth/auth.store.mysql.js:2560`, `apps/api/src/modules/auth/auth.store.mysql.js:3098`, `apps/api/test/auth.store.mysql.test.js:500`
- [x] [AI-Review][MEDIUM] `GET /tenant/members` 新增分页输入（`page`/`page_size`）并默认 `1/50`、上限 `200`，消除全量读取风险。`apps/api/src/modules/tenant/member.service.js:281`, `apps/api/src/server.js:94`, `apps/api/test/tenant.member.api.test.js:171`
- [x] [AI-Review][MEDIUM] 对齐 memory/mysql 列表排序语义（`joined_at DESC, membership_id DESC`），并修复内存排序对非法时间值的非确定性比较。`apps/api/src/modules/auth/auth.store.memory.js:1271`, `apps/api/src/modules/auth/auth.store.mysql.js:3064`
- [x] [AI-Review][MEDIUM] 补齐 tenant member 三条接口 OpenAPI 错误示例与列表分页契约（含 `TenantMemberListResponse.page/page_size`），并新增 server 契约断言。`apps/api/src/openapi.js:936`, `apps/api/src/openapi.js:3974`, `apps/api/test/server.test.js:389`
- [x] [AI-Review][HIGH] 已修复成员创建链路在下游返回缺失 `user_id` 时未写“创建拒绝”审计的问题：补齐 rejected 审计后返回稳定 `AUTH-503-TENANT-MEMBER-DEPENDENCY-UNAVAILABLE`，避免审计断点。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `GET /tenant/members` 重复 query 参数（如 `page=1&page=2`）被静默采信首值的歧义问题：查询解析保留多值并触发参数校验失败，避免歧义输入漂移。`apps/api/src/server.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 OpenAPI `membership_id` 控制字符约束（path 参数 + 响应 schema），与运行时校验保持一致并新增契约断言防回退。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][HIGH] 已修复 `GET /tenant/members` 对下游返回租户关系的信任边界缺口：新增 `tenant_id` 一致性校验，发现跨租户记录即 fail-closed 返回稳定 503，避免错误下游数据跨租户泄露。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `POST /tenant/members` 对关系查询结果完整性校验不足：强校验 `membership_id/user_id/tenant_id` 与目标身份、当前租户一致，不一致即拒绝并审计。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `PATCH /tenant/members/:membership_id/status` 对下游返回结果的信任过度：补齐结果字段完整性与租户一致性校验，异常结果统一映射稳定 503 并记录拒绝审计。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `GET /tenant/members` 对下游畸形成员记录的 fail-open：移除“静默过滤”策略，改为检测缺失关键字段/非法状态后 fail-closed 返回稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `PATCH /tenant/members/:membership_id/status` 对下游缺失 `tenant_id` 的放行问题：移除 `tenant_id` 回退逻辑，缺失即拒绝并审计。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `POST /tenant/members` 对下游缺失/非法 `status` 的默认回退：改为严格完整性校验，异常响应统一映射稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `POST /tenant/members` 对下游返回 `status=left` 的 fail-open：成员创建结果强制要求 `active`，异常结果统一 fail-closed 为稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `PATCH /tenant/members/:membership_id/status` 对下游状态回包校验不足：新增“状态枚举合法性 + 与请求目标状态一致性”校验，异常回包 fail-closed 为稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 memory store 在 `left -> active` 重入时 `tenant_name` 未刷新导致的 memory/mysql 语义漂移：重入路径改为使用 canonical `tenantName` 覆写并补齐回归。`apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 `PATCH /tenant/members/:membership_id/status` 对下游回包关系标识信任过度：新增 `membership_id` 格式与“必须等于请求目标关系”双重校验，异常回包统一 fail-closed 为稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `GET /tenant/members` 对下游手机号字段信任过度：新增手机号格式校验（`^1\\d{10}$`），畸形记录统一 fail-closed 返回稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `POST /tenant/members` 对下游身份复用标记信任过度：强制 `created_user` 与 `reused_existing_user` 互斥且至少一个为 true，异常结果统一 fail-closed 返回稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `GET /tenant/members` 对下游非数组返回的 fail-open：当依赖返回 payload shape 异常时不再静默降级为空列表，统一 fail-closed 返回稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `POST /tenant/members` 对下游 identity flag 缺失的放行：`created_user`/`reused_existing_user` 必须显式为布尔值，缺失或类型异常统一拒绝并审计。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `POST /tenant/members` 对成员查询手机号不一致结果的放行：新增“下游关系手机号必须等于请求手机号”一致性校验，异常结果统一 fail-closed 返回稳定 503。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复成员关系状态归一化 fail-open：当 store 返回不支持状态值时不再默认回退 `active`，改为 fail-closed 返回稳定 `AUTH-503-TENANT-MEMBER-DEPENDENCY-UNAVAILABLE`；并在 memory/mysql 状态更新路径对既有非法状态直接拒绝。`apps/api/src/modules/auth/auth.service.js`, `apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 写接口幂等作用域仍按 session 隔离的问题：`POST/PATCH /tenant/members*` 纳入 user 级幂等作用域（保留 tenant 维度），确保同用户跨会话重放仍返回首次语义。`apps/api/src/server.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `auth.service.listTenantMembers` 对 store 非数组返回的 fail-open：下游返回 shape 异常时改为统一 fail-closed 返回稳定 503，避免“异常结果伪装为空列表”。`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 已修复 OpenAPI 契约漏项：`POST /tenant/members` 补齐 `404 AUTH-404-ORG-NOT-FOUND` 响应及示例，并新增 server 契约断言防回退。`apps/api/src/openapi.js`, `apps/api/test/server.test.js`
- [x] [AI-Review][HIGH] 已修复 `auth.service.listTenantMembers` 对畸形成员记录的静默过滤（missing membership/user/tenant/phone）：改为 service 层 fail-closed 返回稳定 503，避免异常数据被“吞掉”。`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 `auth.service.listTenantMembers` 缺失 tenant 一致性防线：新增 `tenant_id` 必须等于请求租户校验，跨租户结果统一 fail-closed 返回稳定 503。`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][MEDIUM] 已修复 `GET /tenant/members` 对空分页参数（`page=`/`page_size=`）的静默回退：改为严格参数校验并返回 `AUTH-400-INVALID-PAYLOAD`。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 成员写接口幂等作用域在 `authorizeRoute` 返回 camelCase 租户字段（`activeTenantId`）时的隔离缺口：`resolveIdempotencyActorScope` 统一兼容 snake/camel 与嵌套会话上下文，避免跨租户错误重放。`apps/api/src/server.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 legacy provision 路由对非 `AuthProblemError` 异常的语义漂移：`platform/tenant provision-user` 统一将未知依赖异常映射为稳定 503 ProblemDetails（`AUTH-503-PROVISION-CONFIG-UNAVAILABLE`）。`apps/api/src/modules/auth/auth.routes.js`, `apps/api/test/auth.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 Story `File List` 漏记文件：`apps/api/src/modules/auth/auth.routes.js`、`apps/api/test/auth.api.test.js`，修复“Git 变更与文档声明不一致”问题。`_bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md`
- [x] [AI-Review][HIGH] 已修复 membership 状态归一化剩余 fail-open：memory/mysql store 的“读取/状态变更”路径不再将空状态默认为 `active`，统一改为严格校验并 fail-closed。`apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/test/auth.store.mysql.test.js`
- [x] [AI-Review][HIGH] 已修复 `updateTenantMembershipStatus` 对空 `nextStatus` 的隐式接受：空值现在在 store 层直接拒绝，避免状态写入语义漂移。`apps/api/src/modules/auth/auth.store.memory.js`, `apps/api/src/modules/auth/auth.store.mysql.js`, `apps/api/test/auth.store.mysql.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 `auth.service.find/listTenantMembers` 的 `membership_id` 结构化校验（控制字符/格式），并补充 fail-closed 回归，避免畸形关系标识透传。`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 `parseRequestQuery` 使用普通对象导致的 `__proto__` 参数校验绕过与原型污染风险：查询对象改为 `Object.create(null)`，`GET /tenant/members?__proto__=...` 现在稳定返回 `AUTH-400-INVALID-PAYLOAD`。`apps/api/src/server.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant member 写接口对 `409` 一刀切“不缓存”导致的幂等语义漂移：`POST/PATCH /tenant/members*` 改为“仅 `retryable=true` 的 409 不缓存”，非 retryable 409 现可按同键同载荷重放。`apps/api/src/server.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐回归：覆盖 `__proto__` 查询参数拒绝、`POST /tenant/members` 与 `PATCH /tenant/members/:membership_id/status` 的 non-retryable 409 幂等缓存行为。`apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 tenant 成员路由对 camelCase 鉴权上下文的兼容缺口：`route-preauthorization` 与 `member.service` 统一支持 `userId/sessionId/activeTenantId/entryDomain`，避免合法会话被误判 `AUTH-403-NO-DOMAIN`。`apps/api/src/modules/auth/route-preauthorization.js`, `apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][HIGH] 已修复 `PATCH /tenant/members/:membership_id/status` 在 `left -> active` 重入场景对“新 membership_id”结果的误拒绝：仅在非重入场景要求回包关系标识与请求一致，重入可返回新关系标识。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已补齐 `auth.service.updateTenantMemberStatus` 输入前置校验：拒绝含控制字符的 `membership_id` 与非法 `reason`（控制字符/空白），避免异常值下探 store 后语义漂移为 503。`apps/api/src/modules/auth/auth.service.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 `PATCH /tenant/members/:membership_id/status` 重入语义漂移：`left -> active` 场景现在强制要求回包为“新 membership_id”，防止旧关系标识被重用并违背 AC3。`apps/api/src/modules/tenant/member.service.js`, `apps/api/src/modules/auth/auth.service.js`, `apps/api/test/tenant.member.api.test.js`, `apps/api/test/auth.service.test.js`
- [x] [AI-Review][HIGH] 已修复 `GET /tenant/members` 对可选字段的 fail-open：下游返回非字符串 `tenant_name` 或非法 `joined_at/left_at` 时统一 fail-closed 为稳定 503，避免畸形数据透传。`apps/api/src/modules/tenant/member.service.js`, `apps/api/test/tenant.member.api.test.js`
- [x] [AI-Review][MEDIUM] 已收紧 `membership_id` 契约（拒绝空白字符）并同步 OpenAPI/回归，避免标识规范漂移。`apps/api/src/modules/tenant/member.service.js`, `apps/api/src/modules/auth/auth.service.js`, `apps/api/src/openapi.js`, `apps/api/test/server.test.js`, `apps/api/test/auth.service.test.js`

## Dev Notes

### Developer Context（开发者必须先读）

- 当前仓库尚无 `modules/tenant`；tenant 成员相关能力主要集中在 `auth.service` 的 `provisionTenantUserByPhone` 及 `auth_user_tenants` 查询链路。
- 已有 tenant 基础能力：`/auth/tenant/options`、`/auth/tenant/switch`、`/auth/tenant/switch`、`/auth/tenant/member-admin/provision-user`。
- 当前 `auth_user_tenants` 唯一键为 `(user_id, tenant_id)`，只能表达“单一关系”，无法原生满足“离组后重入并保留历史关系”。
- 当前 `memberships` 表已存在于组织治理基线中，但 tenant 权限上下文仍主要读取 `auth_user_tenants`，本故事需要统一关系事实源，避免双写漂移。

### Technical Requirements（实现硬约束）

- 双域边界：tenant 成员治理只影响 tenant 域；不得影响 platform 域访问能力。
- 组织上下文：最终 tenant 判定仅信任服务端 `active_tenant_id` 与有效成员关系。
- 失败语义：统一 `application/problem+json` + 稳定 `error_code` + `retryable`。
- 幂等语义：关键写接口支持 `Idempotency-Key`，同键同载荷重放一致、同键异载荷冲突。
- 安全基线：不得存储/返回明文密码；默认密码读取链路缺失时 fail-closed。
- 时间语义：DB/API 使用 UTC；前端展示 `Asia/Shanghai`（保持现有约束）。

### Architecture Compliance（架构对齐清单）

- 模块边界：推荐新增 `modules/tenant/member.*` 承载成员治理编排；`auth.service` 作为认证与会话领域能力复用。
- 契约边界：外部字段维持 `snake_case`，内部逻辑保持现有命名风格。
- 路由边界：新增受保护接口必须同时完成 `http-routes`、`server`、`route-permissions`、`openapi` 四处对齐。
- 数据边界：成员关系事实源必须唯一，避免 `memberships` 与 `auth_user_tenants` 无规则并存。
- 回归边界：memory/mysql store 必须同语义，通过同一组 API 与 service 回归。

### Library & Framework Requirements（库与框架要求）

- 仓库当前 API 基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`（range）
  - `mysql2`: `3.17.x`（range）
  - `ioredis`: `5.9.2`
- 2026-02-18 实时核验（官方源）
  - Node.js Latest: `v25.6.1`
  - Node.js Latest LTS: `v24.13.1`（Krypton）
  - `@nestjs/core`: `11.1.14`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - Redis OSS: `8.6.0`
  - MySQL 8.4 Latest patch: `8.4.8`
- 本故事策略：不做版本升级，先在当前锁定依赖上完成成员关系模型与治理能力交付。

### File Structure Requirements（建议变更落点）

- 建议新增：
  - `apps/api/src/modules/tenant/member.constants.js`
  - `apps/api/src/modules/tenant/member.routes.js`
  - `apps/api/src/modules/tenant/member.service.js`
- 建议修改：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
- 建议新增迁移：
  - `apps/api/migrations/0012_tenant_member_lifecycle.sql`
  - `apps/api/migrations/0012_tenant_member_lifecycle.down.sql`
- 建议新增/修改测试：
  - `apps/api/test/tenant.member.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/route-permissions.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/migrate-baseline.test.js`

### Testing Requirements（测试要求）

- AC1（身份复用）：
  - 已存在手机号复用全局用户成功；不重复建 `users`；密码不被改写。
  - 不存在手机号新建用户成功；仅保存密码哈希。
- AC2（跨组织独立）：
  - 同一用户加入两个组织后，状态与权限上下文互不影响。
- AC3（离组后重入）：
  - 离组后重入生成新有效关系；历史关系可查询且不可参与实时权限计算。
- AC4（成员状态治理）：
  - 成员禁用后 tenant 域访问拒绝且会话收敛；恢复后可按最新授权恢复访问。
- 安全与门禁：
  - route-permissions 完整声明。
  - Problem Details 错误结构与错误码映射稳定。
  - Idempotency-Key 重放/冲突语义稳定。

### Latest Tech Information（2026-02-18）

- Node.js 官方发布索引：Latest `v25.6.1`，Latest LTS `v24.13.1`。
- npm registry：`@nestjs/core 11.1.14`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`。
- Redis 官方 GitHub Release：`8.6.0`。
- MySQL 官方 8.4 Release Notes：最新补丁可见 `8.4.8`。

### Project Context Reference

- 需求来源：`_bmad-output/planning-artifacts/epics.md`（Epic 3 / Story 3.1）
- 业务约束：`_bmad-output/planning-artifacts/prd.md`（FR19/FR20/FR32/FR33/FR34）
- 数据与契约细则：`_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
- 架构约束：`_bmad-output/planning-artifacts/architecture.md`
- 交互与反馈约束：`_bmad-output/planning-artifacts/ux-design-specification.md`
- 代码现状：`apps/api/src/modules/auth/auth.service.js`、`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/route-permissions.js`
- 项目上下文文件：未发现 `**/project-context.md`

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`CR 3-1 follow-ups 已闭环：修复重入场景旧 membership_id 复用、补齐 tenant member 列表可选字段完整性 fail-closed、收紧 membership_id 空白字符契约；通过 check:route-permissions、lint、apps/api test（679/679）。`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- sprint status update: `3-1-组织成员管理与身份复用 -> in-progress`
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js`（155/155）
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.api.test.js`（46/46）
- added regression: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（11/11）
- targeted verification: `pnpm --dir apps/api exec node --test test/route-permissions.test.js`（44/44）
- targeted verification: `pnpm --dir apps/api exec node --test test/server.test.js`（60/60）
- gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- gate checks: `pnpm --dir apps/api test`（通过，616/616）
- review remediation verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/auth.service.test.js`（226/226）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，619/619）
- re-review verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（72/72）
- re-review gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- re-review gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- re-review gate checks: `pnpm --dir apps/api test`（通过，621/621）
- sprint status update: `3-1-组织成员管理与身份复用 -> done`
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js`（157/157）
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（73/73）
- targeted verification: `pnpm --dir apps/api exec node --test test/server.test.js`（60/60）
- gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- gate checks: `pnpm --dir apps/api test`（通过，623/623）
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（74/74）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，604/604）
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js test/server.test.js`（135/135）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/route-permissions.test.js test/server.test.js`（347/347）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，625/625）
- targeted verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（14/14）
- targeted verification: `pnpm --dir apps/api exec node --test test/server.test.js`（60/60）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，628/628）
- targeted verification: `pnpm --dir apps/api exec node --test test/server.test.js test/tenant.member.api.test.js test/auth.store.mysql.test.js`（151/151）
- targeted verification: `pnpm --dir apps/api exec node --test test/auth.express.api.test.js --test-name-pattern "express tenant provision-user reuses existing user without mutating password hash and rejects duplicate relationship requests"`（关键用例通过）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，630/630）
- targeted verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/auth.store.mysql.test.js test/route-permissions.test.js test/server.test.js`（352/352）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，633/633）
- targeted verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/server.test.js`（81/81）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，628/628）
- targeted verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（22/22）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，638/638）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（25/25）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，641/641）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js`（186/186）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，645/645）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（31/31）
- targeted verification: `pnpm --dir apps/api exec node --test test/server.test.js`（62/62）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，648/648）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（34/34）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，651/651）
- review remediation verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js --test-name-pattern "findTenantMembershipByUserAndTenantId fails closed|listTenantMembers fails closed"`（160/160）
- review remediation verification: `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`（75/75）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（34/34）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，653/653）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/server.test.js`（258/258）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，655/655）
- review remediation verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js`（163/163）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（37/37）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，659/659）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.api.test.js`（86/86）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，662/662）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（43/43）
- review remediation verification: `pnpm --dir apps/api exec node --test test/auth.service.test.js --test-name-pattern "updateTenantMemberStatus"`（167/167）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，674/674）
- review remediation verification: `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/server.test.js`（277/277）
- review remediation gate checks: `pnpm --dir apps/api check:route-permissions`（通过）
- review remediation gate checks: `pnpm --dir apps/api lint`（通过，55 files checked）
- review remediation gate checks: `pnpm --dir apps/api test`（通过，679/679）

### Completion Notes List

- ✅ 新增 tenant 成员治理路由：`GET /tenant/members`、`POST /tenant/members`、`PATCH /tenant/members/:membership_id/status`，并完成鉴权、幂等、Problem Details 对齐。
- ✅ `auth.service` 增加成员关系查询/列表/状态治理能力，补齐 `AUTH-404-TENANT-MEMBERSHIP-NOT-FOUND` 与 `AUTH-503-TENANT-MEMBER-DEPENDENCY-UNAVAILABLE` 语义。
- ✅ `auth.store.memory` / `auth.store.mysql` 完成成员关系生命周期模型（`membership_id`、`joined_at`、`left_at`）与“离组后重入生成新关系”语义，并保持双实现一致。
- ✅ 新增迁移：`0012_tenant_member_lifecycle.sql` / `0012_tenant_member_lifecycle.down.sql`，支撑生命周期字段与历史关系留存表。
- ✅ OpenAPI、route-permissions、server 路由执行表已对齐，tenant member 写接口纳入幂等保护与冲突缓存策略控制。
- ✅ 新增 `tenant.member.api` 回归，并补齐 `route-permissions` 与 `server` 的新路径断言，覆盖新接口契约与幂等行为。
- ✅ 修复历史留存 fail-open：`auth_user_tenant_membership_history` 缺失时改为 fail-closed，并返回稳定错误码。
- ✅ 修复 MySQL 成员状态更新 SQL 参数占位符数量不一致问题，避免运行时 SQL 执行错误。
- ✅ 修复禁用后权限快照丢失：禁用不再清零 `can_*`，恢复 active 后权限上下文可按最新授权恢复。
- ✅ 补齐真实回归测试（非 stub）：新增 MySQL store 与 auth.service 级别用例覆盖关键修复路径。
- ✅ 修复旧库兼容路径首请求误判 404：`updateTenantMembershipStatus` 遇 lifecycle 列缺失时同请求回退 legacy 分支，并新增两条回归覆盖“首请求 fallback”与“fallback 锁存”。
- ✅ 修复 `left -> active` 重入权限复活：memory/mysql 双存储在“新关系重入”路径统一清零 `can_*`，避免历史权限跨关系复用。
- ✅ 补齐重入权限清零回归：新增 auth.service 与 mysql store 用例，覆盖“新 membership_id + 权限清零”语义。
- ✅ 修正 OpenAPI 409 契约文案与实际行为一致，并新增 server 契约断言，避免回归到“仅幂等冲突”描述。
- ✅ 修复 MySQL legacy 回退下“duplicate + left”重入组冲突：`createTenantMembershipForUser` 在回退模式下对 `left` 关系执行激活并清零 `can_*`，避免旧库场景误报冲突与权限遗留。
- ✅ 修复 MySQL lifecycle 缺列回退路径 `left -> active` 权限复活：legacy 更新分支显式清零 `can_*`，避免旧权限跨关系复用。
- ✅ 补齐 legacy 回退重入权限清零回归：新增 mysql store 用例覆盖 `ER_BAD_FIELD_ERROR` 后 `left -> active` 清零逻辑。
- ✅ 补齐 `GET /tenant/members` OpenAPI 标准错误响应集（400/404/409/413）并新增 server 契约断言，满足故事契约完整性约束。
- ✅ 修复成员创建后置关系查询异常路径：`findTenantMembershipByUserAndTenantId` 失败时统一映射为稳定 503 并记录审计事件，避免语义漂移为 500。
- ✅ 补齐 `membership_id` 输入约束：新增长度上限与控制字符校验，并同步 OpenAPI `membership_id` maxLength 约束。
- ✅ 补齐 `POST /tenant/members` retryable 409 幂等回归：验证同幂等键重试时不会缓存失败冲突结果。
- ✅ 按新项目策略移除 MySQL lifecycle 缺列兼容回退，改为 lifecycle-only fail-closed，杜绝 legacy 路径语义漂移。
- ✅ `GET /tenant/members` 完成分页化（`page`/`page_size`）并补齐非法查询参数回归，避免 tenant 大表全量扫描。
- ✅ 补齐 tenant member OpenAPI：新增分页 query 参数、`TenantMemberListResponse.page/page_size`、三条接口全套 ProblemDetails 示例。
- ✅ 修复 `tenantMemberService` 鉴权实例对齐校验失效：`member.service` 暴露 `_internals.authService`，并补齐 `createRouteHandlers` mismatch 回归。
- ✅ 统一 `membership_id` 长度契约为 `64`：请求校验、OpenAPI path/schema、回归边界用例保持一致。
- ✅ 修复 Story 文档文件清单漂移：补记 `apps/api/test/auth.express.api.test.js`。
- ✅ 修复成员创建链路审计断点：`provisionTenantUserByPhone` 下游异常返回缺失 `user_id` 时，补齐 `tenant.member.create.rejected` 审计并返回稳定 503。
- ✅ 修复 `GET /tenant/members` 重复 query 参数歧义：`page=1&page=2` 不再静默采信，改为参数校验失败返回 400。
- ✅ 补齐 OpenAPI `membership_id` 控制字符约束：path 参数与成员相关 schema 统一 `pattern`，并新增 server 契约断言。
- ✅ 修复 `GET /tenant/members` 下游结果信任边界：新增 `tenant_id` 一致性校验，跨租户记录 fail-closed 并返回稳定 503。
- ✅ 修复 `POST /tenant/members` 关系查询结果完整性缺口：强校验 `membership_id/user_id/tenant_id` 与目标身份、当前租户一致。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 下游结果信任过度：补齐字段完整性与租户一致性校验，异常统一映射稳定 503。
- ✅ 修复 `GET /tenant/members` 畸形成员记录静默过滤：缺失关键字段/非法状态改为 fail-closed，避免数据污染被掩盖。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 缺失 `tenant_id` 放行：移除 fallback，严格要求下游返回完整租户关系。
- ✅ 修复 `POST /tenant/members` 缺失 `status` 回退为 `active`：改为严格完整性校验并返回稳定 503。
- ✅ 修复 `POST /tenant/members` 状态校验 fail-open：创建结果若非 `active`（如 `left`）将统一 fail-closed 返回稳定 503。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 状态回包校验缺口：补齐“状态枚举合法 + 与请求目标状态一致”双重校验。
- ✅ 修复 memory store 重入关系 `tenant_name` 漂移：`left -> active` 时刷新为 canonical `tenantName`，与 MySQL 语义保持一致。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 下游关系标识信任缺口：回包 `membership_id` 必须合法且与请求目标一致，否则 fail-closed 返回稳定 503。
- ✅ 修复 `GET /tenant/members` 畸形手机号记录放行：新增 `phone` 格式校验（`^1\\d{10}$`），异常记录统一 fail-closed。
- ✅ 修复 `POST /tenant/members` 下游身份复用标记不一致放行：`created_user` 与 `reused_existing_user` 必须互斥且至少一个为 true。
- ✅ 修复 `GET /tenant/members` 下游非数组 payload 静默降级：异常 shape 统一 fail-closed 返回稳定 503，避免错误结果被伪装为空列表。
- ✅ 修复 `POST /tenant/members` 对 identity flag 缺失的放行：`created_user`/`reused_existing_user` 必须显式布尔值，缺失统一拒绝并审计。
- ✅ 修复 `POST /tenant/members` 下游手机号不一致关系放行：关系查询结果 `phone` 必须与请求手机号一致，不一致统一 fail-closed 返回稳定 503。
- ✅ 修复成员关系状态归一化 fail-open：`findTenantMembershipByUserAndTenantId/listTenantMembers` 遇非法 `status` 不再默认为 `active`，统一 fail-closed；`updateTenantMembershipStatus` 对既有非法状态直接拒绝，避免数据污染继续传播。
- ✅ 修复 tenant member 写接口幂等作用域漂移：`POST/PATCH /tenant/members*` 改为 user 级幂等作用域（保留 tenant 维度），保证同用户跨会话重放一致返回首次语义。
- ✅ 修复 `auth.service.listTenantMembers` 非数组下游结果 fail-open：依赖返回 shape 异常不再静默降级为空列表，统一 fail-closed 返回稳定 503。
- ✅ 补齐 OpenAPI 契约：`POST /tenant/members` 新增 `404 AUTH-404-ORG-NOT-FOUND` 响应与示例，并新增 server 断言防回退。
- ✅ 修复 `auth.service.listTenantMembers` 对畸形成员记录的静默过滤：成员关键字段缺失或手机号非法时改为 fail-closed，避免异常记录被吞并伪装为“空列表”。
- ✅ 修复 `auth.service.listTenantMembers` 跨租户结果缺失防线：新增 service 层 `tenant_id` 一致性校验，跨租户结果统一映射稳定 503。
- ✅ 修复 `GET /tenant/members` 对空分页参数的静默回退：`page=`/`page_size=` 现在返回 `AUTH-400-INVALID-PAYLOAD`，与参数契约保持一致。
- ✅ 修复 tenant 写接口在 `activeTenantId` alias 上下文下幂等作用域缺口：同 `Idempotency-Key` 跨租户请求不再错误重放首租户响应。
- ✅ 修复 legacy `platform/tenant provision-user` 未知依赖异常语义漂移：统一映射为稳定 503 ProblemDetails（`AUTH-503-PROVISION-CONFIG-UNAVAILABLE`）。
- ✅ 补齐回归与门禁：新增 `tenant.member.api` + `auth.api` 三条修复用例并通过 `check:route-permissions`、`lint`、`apps/api test`（662/662）。
- ✅ 修复 membership 状态归一化剩余 fail-open：memory/mysql store 读取与状态更新路径不再将空状态视为 `active`，统一 fail-closed。
- ✅ 修复 `updateTenantMembershipStatus` 空 `nextStatus` 被隐式接受的问题：在 store 层前置拒绝，避免状态更新语义漂移。
- ✅ 补齐 `auth.service.find/listTenantMembers` 的 `membership_id` 控制字符/格式校验与回归用例，保证畸形标识统一映射稳定 503。
- ✅ 修复 tenant 成员路由对 camelCase 鉴权上下文的兼容缺口：`route-preauthorization` 与 `member.service` 统一支持 `userId/sessionId/activeTenantId/entryDomain`，避免合法上下文被误判为无租户域权限。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 在 `left -> active` 重入时误拒绝新关系标识：重入场景允许返回新 `membership_id`，保持 AC3“新关系”语义。
- ✅ 补齐 `auth.service.updateTenantMemberStatus` 输入前置校验：拒绝控制字符 `membership_id` 与非法 `reason`，避免异常值下探 store 后语义漂移。
- ✅ 修复 `PATCH /tenant/members/:membership_id/status` 重入关系标识 fail-open：`left -> active` 现在必须返回新 `membership_id`，避免旧关系标识被复用。
- ✅ 修复 `GET /tenant/members` 对可选字段 `tenant_name/joined_at/left_at` 的完整性放行：畸形字段统一 fail-closed 返回稳定 503。
- ✅ 收紧 `membership_id` 契约（禁空白字符）并同步 OpenAPI 与 service 层校验，降低标识规范漂移风险。

### File List

- `apps/api/src/modules/tenant/member.constants.js`
- `apps/api/src/modules/tenant/member.routes.js`
- `apps/api/src/modules/tenant/member.service.js`
- `apps/api/src/http-routes.js`
- `apps/api/src/modules/auth/auth.routes.js`
- `apps/api/src/modules/auth/route-preauthorization.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/src/openapi.js`
- `apps/api/migrations/0012_tenant_member_lifecycle.sql`
- `apps/api/migrations/0012_tenant_member_lifecycle.down.sql`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/auth.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/tenant.member.api.test.js`
- `_bmad-output/implementation-artifacts/3-1-组织成员管理与身份复用.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Change Log

- 2026-02-18：完成 Story 3.1 实现与回归收口（tenant 成员治理 API、身份复用链路、成员关系生命周期与重入、成员状态治理与 tenant 会话收敛），并通过 `check:route-permissions`、`lint`、`apps/api test` 全量门禁，状态更新为 `review`。
- 2026-02-18：执行 Code Review（CR 3-1），发现 4 项问题（2 HIGH / 2 MEDIUM）；新增 `Review Follow-ups (AI)` 并将状态回退为 `in-progress`。
- 2026-02-18：执行 CR 3-1 问题闭环修复（历史写入 fail-closed、`archived_reason` 长度对齐、禁用恢复权限快照保留、SQL 参数占位符修复），补充真实回归并通过 `check:route-permissions`、`lint`、`apps/api test`（619/619），状态更新为 `done`。
- 2026-02-18：执行 CR 3-1 复核，新增发现 3 项（1 HIGH / 2 MEDIUM）：修复 MySQL 旧库兼容路径首请求 fallback 误判 404，并补齐首请求 fallback 与 fallback 锁存回归；通过 `check:route-permissions`、`lint`、`apps/api test`（621/621），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（二次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复 `left -> active` 重入权限快照复活（memory/mysql），补齐双实现回归，并修正 tenant 成员状态 `409` OpenAPI 契约文案；通过 `lint`、`apps/api test`（623/623），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（三次），新增发现 1 项（1 HIGH）：修复 MySQL legacy 回退在 duplicate+left 场景误判冲突（改为激活关系并清零权限快照），补齐锁存回退场景回归；通过 `check:route-permissions`、`lint`、`apps/api test`（604/604），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（四次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复 MySQL lifecycle 缺列回退下 `left -> active` 权限快照复活、补齐 legacy 回退重入清零回归、补齐 `GET /tenant/members` 契约错误响应集（400/404/409/413）；通过 `check:route-permissions`、`lint`、`apps/api test`（625/625），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（五次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复成员创建后置查询异常未稳定映射问题、补齐 `membership_id` 输入约束并同步 OpenAPI 上限、补齐 `POST /tenant/members` retryable 409 幂等不缓存回归；通过 `check:route-permissions`、`lint`、`apps/api test`（628/628），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（六次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复 `tenantMemberService` 鉴权实例对齐校验失效、统一 `membership_id` 64 长度契约并补齐边界回归、修复 Story File List 漏记 `auth.express.api.test.js`；并完成定向回归验证通过。
- 2026-02-18：执行 CR 3-1 复核（七次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复成员创建缺失 `user_id` 分支审计断点、修复 `GET /tenant/members` 重复 query 参数歧义采信、补齐 OpenAPI `membership_id` 控制字符约束并新增契约断言；通过 `check:route-permissions`、`lint`、`apps/api test`（628/628），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（八次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 tenant member list/create/status 三条链路对下游结果的完整性/租户一致性信任边界缺口，统一 fail-closed 返回稳定 503 并补齐回归；通过 `check:route-permissions`、`lint`、`apps/api test`（638/638），状态保持 `done`。
- 2026-02-18：执行 CR 3-1 复核（九次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 tenant member `list/create/status` 对下游畸形返回的剩余 fail-open（list 静默过滤、create 缺失 status 回退、status 缺失 tenant_id 回退），并补齐回归；通过 `check:route-permissions`、`lint`、`apps/api test`（641/641），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 `POST /tenant/members` 对非 active 关系结果放行、修复 `PATCH /tenant/members/:membership_id/status` 对非法/不一致状态回包放行、修复 memory store 重入 `tenant_name` 与 MySQL 语义漂移；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（645/645），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十一次），新增发现 3 项（1 HIGH / 2 MEDIUM）：修复 `PATCH /tenant/members/:membership_id/status` 回包 `membership_id` 一致性缺口、修复 `GET /tenant/members` 对畸形手机号结果放行、修复 `POST /tenant/members` 对身份复用标记不一致结果放行；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（648/648），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十二次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 `GET /tenant/members` 对下游非数组 payload 静默放行、修复 `POST /tenant/members` 对 identity flag 缺失放行、修复 `POST /tenant/members` 对手机号不一致关系回包放行；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（651/651），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十三次），新增发现 1 项（1 HIGH）：修复成员关系状态归一化 fail-open（service 层 find/list 对非法 `status` 统一 fail-closed，memory/mysql store 状态更新拒绝既有非法状态），并补齐回归；通过 `check:route-permissions`、`lint`、`apps/api test`（653/653），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十四次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 tenant member 写接口幂等 session-scope 漂移（跨会话同用户重放不一致）、修复 `auth.service.listTenantMembers` 对非数组下游返回的 fail-open、补齐 `POST /tenant/members` 缺失的 404 OpenAPI 契约；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（655/655），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十五次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 `auth.service.listTenantMembers` 对畸形成员静默过滤、修复 `auth.service.listTenantMembers` 跨租户结果缺失 service 层防线、修复 `GET /tenant/members` 对空分页参数的静默回退；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（659/659），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十六次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 tenant member 写接口在 `activeTenantId` alias 下的幂等跨租户重放缺口、修复 legacy `platform/tenant provision-user` 对未知异常未稳定映射的问题、补齐 Story File List 漏记 `auth.routes.js` 与 `auth.api.test.js`；补齐回归并通过 `check:route-permissions`、`lint`、`apps/api test`（662/662），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十七次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 memory/mysql store 对空 membership 状态的 fail-open、修复 `updateTenantMembershipStatus` 空 `nextStatus` 隐式接受、补齐 `auth.service.find/listTenantMembers` 的 `membership_id` 严格校验；补齐回归并通过 `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js`（243/243）、`check:route-permissions`、`lint`、`apps/api test`（667/667），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十八次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 `parseRequestQuery` 普通对象导致的 `__proto__` 查询参数校验绕过与原型污染风险；修复 tenant member 写接口 non-retryable 409 未缓存导致的幂等语义漂移；补齐 `__proto__` + non-retryable 409 回归并通过 `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（41/41）、`check:route-permissions`、`lint`、`apps/api test`（670/670），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（十九次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 tenant 成员路由对 camelCase 鉴权上下文兼容缺口（`userId/sessionId/activeTenantId/entryDomain`）、修复 `PATCH /tenant/members/:membership_id/status` 在 `left -> active` 重入时误拒绝新 `membership_id`、补齐 `auth.service.updateTenantMemberStatus` 输入前置校验；补齐回归并通过 `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`（43/43）、`pnpm --dir apps/api exec node --test test/auth.service.test.js --test-name-pattern "updateTenantMemberStatus"`（167/167）、`check:route-permissions`、`lint`、`apps/api test`（674/674），状态保持 `done`。
- 2026-02-19：执行 CR 3-1 复核（二十次），新增发现 3 项（2 HIGH / 1 MEDIUM）：修复 `left -> active` 重入仍可复用旧 `membership_id` 的语义缺口、修复 `GET /tenant/members` 对畸形 `tenant_name/joined_at/left_at` 的 fail-open、收紧 `membership_id` 空白字符契约并同步 OpenAPI/回归；通过 `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/server.test.js`（277/277）、`check:route-permissions`、`lint`、`apps/api test`（679/679），状态保持 `done`。

### Senior Developer Review (AI)

- Reviewer: 老大（AI）
- Date: 2026-02-19
- Outcome: Approved
- Summary: 本轮复核新增发现已闭环修复（HIGH 2 / MEDIUM 1）：修复重入场景旧 `membership_id` 复用缺口、修复 tenant member 列表对 `tenant_name/joined_at/left_at` 畸形字段的 fail-open、收紧 `membership_id` 空白字符契约并同步 OpenAPI 与回归；故事保持 done。
- Verification:
  - `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js test/auth.service.test.js test/server.test.js`：通过（277/277）
  - `pnpm --dir apps/api check:route-permissions`：通过
  - `pnpm --dir apps/api lint`：通过（55 files checked）
  - `pnpm --dir apps/api test`：通过（679/679）
