# Story 2.2: 组织状态治理（启用/禁用）

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 平台管理员,
I want 维护组织启用与禁用状态,
so that 我可以对组织可用性进行平台级治理。

## Acceptance Criteria

1. **Given** 目标组织当前为启用状态  
   **When** 平台管理员执行禁用  
   **Then** 组织状态更新为禁用  
   **And** 组织域（`tenant`）访问按规则受限，平台域（`platform`）不受影响
2. **Given** 目标组织当前为禁用状态  
   **When** 平台管理员执行启用  
   **Then** 组织状态更新为启用  
   **And** 符合权限的成员可恢复组织域（`tenant`）访问，平台域（`platform`）保持原状态
3. **Given** 状态变更发生  
   **When** 请求完成  
   **Then** 变更记录进入审计  
   **And** 返回统一成功/失败语义

## Tasks / Subtasks

- [x] 任务 1：新增平台组织状态治理接口与契约（AC: 1, 2, 3）
  - [x] 新增静态路由（建议：`POST /platform/orgs/status`），避免引入路径参数匹配机制改造。
  - [x] 请求体最小字段：`org_id`、`status`（`active|disabled`）；可选：`reason`（审计备注）。
  - [x] 响应体最小字段：`org_id`、`previous_status`、`current_status`、`request_id`。
  - [x] OpenAPI 补齐 200/400/401/403/404/409/503 问题详情与示例，保持 `application/problem+json` 一致语义。

- [x] 任务 2：实现组织状态变更服务与存储事务（AC: 1, 2）
  - [x] 在 `apps/api/src/modules/platform/org.service.js` 新增 `updateOrgStatus`（或等效命名）入口。
  - [x] 在 MySQL 与内存存储层同时补齐组织状态更新能力，保持双存储行为一致（测试基线要求）。
  - [x] 对状态空转（如已是 `disabled` 再禁用）定义稳定语义：显式返回 no-op 成功，或返回稳定冲突错误码（二选一，需与 OpenAPI 对齐）。
  - [x] 非预期依赖故障统一映射为 `ORG-503-DEPENDENCY-UNAVAILABLE`，避免 500 透传。

- [x] 任务 3：落实“禁用即受限、启用即恢复”的组织域访问控制（AC: 1, 2）
  - [x] 服务端最终判定必须纳入组织状态（仅靠客户端上下文不足）。
  - [x] 明确并实现受限策略：禁用组织后，相关组织域（`tenant`）访问不可继续通过（`tenant options`/`tenant scoped authorize` 至少一处强约束，建议双重约束），且平台域（`platform`）访问不受影响。
  - [x] 启用组织后，符合条件成员可恢复组织域（`tenant`）访问。
  - [x] 关键状态变更触发会话收敛（仅撤销 `tenant` 域会话/refresh，不做跨域收敛）并与现有认证链路约束一致。

- [x] 任务 4：审计与幂等治理闭环（AC: 3）
  - [x] 审计最小事件：`org.status.updated`（成功）与 `org.status.rejected`（失败），记录 `request_id`、`operator_user_id`、`org_id`、`previous_status`、`next_status`、`error_code`（失败时）。
  - [x] 将新路由纳入 `Idempotency-Key` 防重放保护（参考 `POST /platform/orgs` 已落地模式）。
  - [x] 明确“可持久响应缓存/非持久响应不占键”策略并保持与现有幂等框架一致。

- [x] 任务 5：门禁与回归测试（AC: 1, 2, 3）
  - [x] API 回归：禁用成功、启用成功、组织不存在、权限不足、非法载荷、依赖降级、幂等重放/冲突。
  - [x] 访问限制回归：组织禁用后，组织域访问被拒绝；启用后恢复。
  - [x] 审计回归：成功/失败事件字段完整且错误码一致。
  - [x] 契约回归：OpenAPI 示例与运行时字段（`error_code`、`retryable`、`request_id`）一致。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api test`、`pnpm --dir apps/api lint`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 收紧 MySQL 组织状态守卫查询：移除 `o.id IS NULL` 放行条件，避免孤儿租户关系绕过组织状态约束。 [apps/api/src/modules/auth/auth.store.mysql.js]
- [x] [AI-Review][MEDIUM] 补齐 `org.status.rejected` 审计字段一致性：失败事件统一记录 `previous_status` 与 `next_status`。 [apps/api/src/modules/platform/org.service.js]
- [x] [AI-Review][MEDIUM] 增补回归测试，锁定组织守卫 SQL 与失败审计字段，防止回归。 [apps/api/test/auth.store.mysql.test.js] [apps/api/test/platform.org.api.test.js]
- [x] [AI-Review][MEDIUM] 对齐 in-memory 与 MySQL 组织守卫语义：`orgs` 目录存在时对孤儿租户关系 fail-closed，避免双存储行为漂移。 [apps/api/src/modules/auth/auth.store.memory.js] [apps/api/test/auth.service.test.js]

## Dev Notes

### Developer Context（开发者必须先读）

- Story 2.1 已在平台域引入 `orgs` + `memberships` 与 `POST /platform/orgs` 主链路；Story 2.2 必须在该实现上增量扩展，不做目录级重构。
- 当前 API 路由分发为“静态路径映射 + route-permissions 预检 fail-closed”，不要为本故事引入动态路由匹配框架改造。
- 当前项目代码风格为 CommonJS + Node test runner；保持与仓库现状一致。
- Story 2.1 的高频修复点集中在：契约漂移、幂等语义、依赖故障映射、回滚与审计完整性。Story 2.2 需要沿用这些防线，避免重复踩坑。

### Technical Requirements（实现硬约束）

- 统一错误结构：`application/problem+json`，至少包含 `status`、`detail`、`error_code`、`request_id`、`retryable`。
- 组织状态枚举与现有实现保持一致：`active|disabled`（与 `apps/api/migrations/0008_platform_org_bootstrap.sql` 当前定义对齐）。
- 新接口必须走平台域受保护路由，权限码沿用 `platform.member_admin.operate`（除非你在本故事显式引入更细粒度权限并同步全链路）。
- 组织禁用后必须落实“仅组织域（`tenant`）访问受限”这一业务结果，不能只更新 `orgs.status` 而不影响鉴权路径，也不得误伤平台域（`platform`）。
- 关键状态变更需要落实会话一致性策略（仅 `tenant` 域会话/refresh 收敛），避免“组织已禁用但历史 tenant 会话仍可用”的安全漏洞。
- 非预期依赖故障禁止直接透传 500；需统一收敛稳定错误码（推荐 `ORG-503-DEPENDENCY-UNAVAILABLE`）。
- 新增关键写接口需接入 `Idempotency-Key`（与现有 `server.js` 幂等中间层策略一致）。

### Architecture Compliance（架构对齐清单）

- 保持平台域/组织域边界隔离：状态治理入口在平台域，组织域仅承接结果。
- 路由声明与权限声明必须同步更新并通过 `check:route-permissions`（漏声明应 fail-closed）。
- 外部契约字段继续使用 `snake_case`。
- 存储层实现必须保持 in-memory 与 MySQL 语义一致（项目当前测试体系依赖双实现对齐）。
- 审计链路应可追踪“谁在什么时间把哪个组织从什么状态改成什么状态”。

### Library & Framework Requirements（库与框架要求）

- 仓库当前依赖基线（`apps/api/package.json`）：
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `^0.3.28`
  - `mysql2`: `^3.17.0`
  - `ioredis`: `5.9.2`
- 2026-02-17 核验（官方源）：
  - Node.js：Latest `v25.6.1`，Latest LTS `v24.13.1`
  - `@nestjs/core`: `11.1.13`
  - `typeorm`: `0.3.28`
  - `mysql2`: `3.17.2`
  - `ioredis`: `5.9.3`
  - MySQL 8.4 release notes 当前可见至 `8.4.8`
- 本故事策略：不做框架升级，按仓库已锁定版本实现，并确保行为兼容当前稳定版本约束。

### File Structure Requirements（建议变更落点）

- 平台组织模块：
  - `apps/api/src/modules/platform/org.constants.js`
  - `apps/api/src/modules/platform/org.routes.js`
  - `apps/api/src/modules/platform/org.service.js`
- 路由与门禁：
  - `apps/api/src/http-routes.js`
  - `apps/api/src/server.js`
  - `apps/api/src/route-permissions.js`
- 存储层（双实现对齐）：
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/modules/auth/auth.service.js`（若需会话收敛编排能力）
- 契约：
  - `apps/api/src/openapi.js`
- 测试：
  - `apps/api/test/platform.org.api.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`

### Testing Requirements（测试要求）

- AC1：启用 -> 禁用
  - 成功更新 `orgs.status=disabled`
  - 组织域（`tenant`）访问被限制（至少覆盖一个 tenant 入口 + 一个 tenant 受保护路由）
  - 平台域（`platform`）访问保持可用（不受组织状态切换直接影响）
- AC2：禁用 -> 启用
  - 成功更新 `orgs.status=active`
  - 符合条件成员恢复组织域（`tenant`）访问
  - 平台域（`platform`）访问语义保持不变
- AC3：审计 + 统一语义
  - 成功/失败均有可追踪审计事件
  - 响应错误语义统一（Problem Details + `error_code` + `retryable`）
- 幂等与并发
  - 同键同载荷重放语义一致
  - 同键异载荷返回冲突（若沿用现有幂等冲突语义）
- 回归门禁（必须）
  - `pnpm --dir apps/api check:route-permissions`
  - `pnpm --dir apps/api test`
  - `pnpm --dir apps/api lint`

### Previous Story Intelligence

- Story 2.1 的核心经验：
  - 任何新接口都要“实现 + OpenAPI + 回归”三位一体，不可只改其一。
  - 依赖故障与边界异常必须 fail-closed，避免 500 漂移与副作用残留。
  - 幂等能力要覆盖真实退化路径（store unavailable/pending timeout/corrupted entry）。
  - 预授权上下文必须校验信任边界，不能因内部标记处理不当绕过鉴权。
- 对 Story 2.2 的直接约束：
  - 不要新增一套独立错误语义。
  - 不要绕开既有 idempotency 守卫。
  - 不要忽略审计字段完整性（尤其 `operator_user_id`、`request_id`、状态前后值）。

### Git Intelligence Summary

- 最近 5 次提交显示工作重心持续在：
  - `apps/api/src/server.js`
  - `apps/api/src/http-routes.js`
  - `apps/api/src/openapi.js`
  - `apps/api/src/modules/auth/*`
  - `apps/api/src/modules/platform/*`
  - `apps/api/test/*`
- 结论：
  - Story 2.2 应沿用“平台组织模块 + 鉴权主链路 + 契约测试联动”策略。
  - 避免引入全局框架迁移或目录重排，优先在现有热点模块做可回归增量。

### Latest Tech Information（2026-02-17）

- Node.js 官方发布索引显示：Latest `v25.6.1`，Latest LTS `v24.13.1`。
- npm registry 最新版本：`@nestjs/core 11.1.13`、`typeorm 0.3.28`、`mysql2 3.17.2`、`ioredis 5.9.3`。
- MySQL 8.4 官方 release notes 当前可见最新条目 `8.4.8`。
- 结论：本故事无需升级依赖，重点是契约一致性、状态治理语义和安全回归覆盖。

### Project Context Reference

- 未发现 `**/project-context.md`。
- 本故事上下文来源：`epics.md`、`prd.md`、`prd-appendix-legacy-inputs.md`、`architecture.md`、`ux-design-specification.md`、Story 2.1 文档、当前代码与最近提交历史。

### Story Completion Status

- Story 文档状态：`done`
- Completion Note：`Story 2.2 completed with full gate rerun and legacy-schema compatibility fallback`

### Project Structure Notes

- API 当前是集中式路由分发，不支持动态路径参数匹配；新增接口建议保持静态路径。
- 平台组织能力目前由 `modules/platform/org.*` 承接，优先在该边界内扩展。
- 如需触达会话收敛，请复用 `auth.store` 既有会话/refresh 撤销机制，避免再造一套会话失效流程。

### References

- Story 2.2 定义与 AC  
  [Source: _bmad-output/planning-artifacts/epics.md#Story 2.2: 组织状态治理（启用/禁用）]
- FR11 与统一验收口径（AC1/AC2/AC3）  
  [Source: _bmad-output/planning-artifacts/prd.md]
- 组织状态、会话收敛、服务端最终组织域判定规则  
  [Source: _bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md]
- 架构边界与工程约束  
  [Source: _bmad-output/planning-artifacts/architecture.md]
- 组织治理主路径交互与反馈一致性  
  [Source: _bmad-output/planning-artifacts/ux-design-specification.md]
- 前序故事经验（Story 2.1）  
  [Source: _bmad-output/implementation-artifacts/2-1-组织创建与初始负责人校验.md]
- 当前实现基线  
  [Source: apps/api/src/modules/platform/org.service.js]  
  [Source: apps/api/src/modules/platform/org.routes.js]  
  [Source: apps/api/src/server.js]  
  [Source: apps/api/src/route-permissions.js]  
  [Source: apps/api/src/openapi.js]  
  [Source: apps/api/migrations/0008_platform_org_bootstrap.sql]
- Node.js Releases  
  [Source: https://nodejs.org/dist/index.json]
- npm Registry Latest Metadata  
  [Source: https://registry.npmjs.org/@nestjs/core/latest]  
  [Source: https://registry.npmjs.org/typeorm/latest]  
  [Source: https://registry.npmjs.org/mysql2/latest]  
  [Source: https://registry.npmjs.org/ioredis/latest]
- MySQL 8.4 Release Notes  
  [Source: https://dev.mysql.com/doc/relnotes/mysql/8.4/en/]

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- create-story workflow target: `2-2-组织状态治理-启用-禁用`
- sprint status auto-discovery source: `_bmad-output/implementation-artifacts/sprint-status.yaml`
- loaded artifacts: `epics.md` + `prd.md` + `prd-appendix-legacy-inputs.md` + `architecture.md` + `ux-design-specification.md`
- previous story analyzed: `_bmad-output/implementation-artifacts/2-1-组织创建与初始负责人校验.md`
- recent git commits analyzed: `7e753cb`, `d7b34e0`, `b62b0e1`, `1567461`, `b2db603`
- gates: `pnpm --dir apps/api check:route-permissions` / `pnpm --dir apps/api lint` / `pnpm --dir apps/api test`
- targeted reruns: `pnpm --dir apps/api exec node --test test/platform.org.api.test.js test/auth.store.mysql.test.js test/auth.service.test.js`
- compatibility reruns: `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`
- code-review loop (round 1): findings fixed in `auth.store.mysql.js` + `org.service.js`, then targeted rerun passed
- code-review loop (round 2): independent rerun + full gates (`check:route-permissions`/`lint`/`test`) all passed
- code-review loop (round 3): independent rerun发现 in-memory 存储在组织守卫场景下与 MySQL 语义不一致（孤儿租户关系误放行），已修复并补充回归测试
- code-review loop (round 4): 独立复审重新读取 story/代码并重跑 `check:route-permissions`、`lint`、`test`，无新增问题输出
- code-review loop (round 5): 按 `prompts:/bmad-bmm-code-review` 独立复审流程重新读取 prompt/workflow/story，并重跑 `check:route-permissions`、`lint`、`test`，无新增问题输出

### Completion Notes List

- [x] 新增 `POST /platform/orgs/status` 路由、服务入口、错误码映射与审计字段
- [x] OpenAPI 补齐 `/platform/orgs/status` 200/4xx/5xx 契约与问题详情示例
- [x] MySQL 与内存存储同时实现组织状态更新能力，状态空转按 no-op 成功返回
- [x] 组织状态接入租户最终判定（tenant options / tenant permission / domain access 统一受组织状态约束）
- [x] 组织状态关键变更触发域内会话收敛（仅 tenant 会话/refresh 收敛，不跨域影响 platform）
- [x] 路由接入 `Idempotency-Key` 幂等保护并覆盖重放/冲突语义
- [x] 新增并通过 API/store/service/server 级回归测试
- [x] 修复 MySQL 认证最小表场景下 `orgs` 缺失导致 500 的兼容性回归（自动降级到 legacy tenant 查询）
- [x] 完成全量门禁通过：`check:route-permissions`、`lint`、`test`
- [x] 审查修复：MySQL 组织守卫去除 `o.id IS NULL` 放行条件，防止孤儿租户关系误放行
- [x] 审查修复：`org.status.rejected` 失败审计补齐 `previous_status` / `next_status`
- [x] 审查修复回归：新增 SQL/audit 字段断言并通过定向+全量测试
- [x] 审查修复：in-memory 组织守卫新增“org 目录存在时 fail-closed，legacy 无 org 数据时兼容放行”策略，避免与 MySQL 行为漂移
- [x] 独立复审（round 5）：重新读取审查上下文并重跑全量门禁，未产生新增审查问题

### File List

- apps/api/src/modules/platform/org.constants.js
- apps/api/src/modules/platform/org.routes.js
- apps/api/src/modules/platform/org.service.js
- apps/api/src/openapi.js
- apps/api/src/server.js
- apps/api/src/http-routes.js
- apps/api/src/route-permissions.js
- apps/api/src/modules/auth/auth.service.js
- apps/api/src/modules/auth/auth.store.memory.js
- apps/api/src/modules/auth/auth.store.mysql.js
- apps/api/test/platform.org.api.test.js
- apps/api/test/auth.service.test.js
- apps/api/test/auth.store.mysql.test.js
- apps/api/test/server.test.js
- apps/api/test/route-permissions.test.js
- _bmad-output/implementation-artifacts/2-2-组织状态治理-启用-禁用.md
- _bmad-output/implementation-artifacts/sprint-status.yaml
