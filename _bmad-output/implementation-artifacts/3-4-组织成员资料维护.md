# Story 3.4: 组织成员资料维护

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 组织负责人或组织管理员,  
I want 维护成员组织内资料（显示名、部门等）,  
so that 成员信息在组织治理中保持准确可用。

## Acceptance Criteria

1. **Given** 管理员提交成员资料更新  
   **When** 字段校验通过  
   **Then** 系统保存组织内资料变更  
   **And** 变更可在列表与详情中一致展示
2. **Given** 更新请求字段不符合约束  
   **When** 请求提交  
   **Then** 系统拒绝并返回字段级错误  
   **And** 不影响其他已存有效资料

## Tasks / Subtasks

- [x] 任务 1：交付成员资料查询/更新 API（AC: 1, 2）
  - [x] 新增详情查询接口（建议）：`GET /tenant/members/:membership_id`，返回成员资料与关系状态。
  - [x] 新增资料更新接口（建议）：`PATCH /tenant/members/:membership_id/profile`，更新 `display_name`、`department_name`。
  - [x] 写接口纳入 `Idempotency-Key` 语义，保持“同键同载荷重放一致、同键异载荷冲突”。
  - [x] 外部字段保持 `snake_case`，错误响应统一 Problem Details（含 `error_code/retryable/request_id`）。

- [x] 任务 2：落地字段规则与存储一致性（AC: 1, 2）
  - [x] 严格执行字段约束：`display_name` 必填、1-64、禁止控制字符；`department_name` 可空、最大 128、禁止控制字符与纯空白。
  - [x] 资料更新必须锚定 `membership_id`（不能按 `user_id+tenant_id` 直接更新），并校验与当前 `active_tenant_id` 一致。
  - [x] 更新后列表与详情读取应来自同一事实源，避免“列表已更新、详情旧值”漂移。
  - [x] 不影响成员状态、角色绑定与会话收敛链路（本故事仅资料字段变更）。

- [x] 任务 3：保持 fail-closed 与安全边界（AC: 2）
  - [x] 下游返回畸形结构、跨租户数据、主键不一致时统一 fail-closed 返回 `503`（不静默容忍）。
  - [x] 参数错误返回字段级 `400`，成员关系不存在返回 `404`，无权限保持 `403` 语义稳定。
  - [x] tenant 域最终租户判定仅信任服务端上下文，禁止客户端透传租户标识覆盖。

- [x] 任务 4：审计与可追踪性（AC: 1, 2）
  - [x] 审计事件至少覆盖：资料读取成功/拒绝、资料更新成功/拒绝。
  - [x] 审计元数据包含：`request_id`、操作者、`tenant_id`、`membership_id`、变更字段摘要（脱敏/最小化）。
  - [x] 写接口冲突与重试路径保留可追踪信息，便于排障。

- [x] 任务 5：契约与权限声明对齐（AC: 1, 2）
  - [x] `route-permissions` 新增/更新受保护路由声明：查看用 `tenant.member_admin.view`，更新用 `tenant.member_admin.operate`。
  - [x] OpenAPI 补齐新增路径、请求/响应 schema、错误示例（400/401/403/404/409/413/503）与 `retryable` 语义。
  - [x] 对齐 `membership_id`、`display_name`、`department_name` 的格式约束，避免运行时与契约漂移。

- [x] 任务 6：回归矩阵与门禁（AC: 1, 2）
  - [x] API 回归：成功更新、字段非法、`membership_id` 非法、成员不存在、跨租户、权限不足、幂等冲突。
  - [x] 服务层回归：下游畸形回包（缺字段/错类型/主键不一致）统一 fail-closed。
  - [x] 契约回归：OpenAPI 新增路径与错误示例完整性断言。
  - [x] 必过门禁：`pnpm --dir apps/api check:route-permissions`、`pnpm --dir apps/api lint`、`pnpm --dir apps/api test`。

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] 修复 `PATCH /tenant/members/:membership_id/profile` 在省略 `department_name` 时误清空部门字段的问题（`apps/api/src/modules/tenant/member.service.js`、`apps/api/src/modules/auth/auth.service.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：省略 `department_name` 时保持原部门值，且审计 `changed_fields` 仅包含 `display_name`（`apps/api/test/tenant.member.api.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][MEDIUM] 清理 OpenAPI 中不可达的 409 示例，避免契约与运行时语义漂移（`apps/api/src/openapi.js`、`apps/api/test/server.test.js`）。
- [x] [AI-Review][HIGH] 修复 `findTenantMembershipByMembershipIdAndTenantId` 在 memory/mysql store 未返回 `phone` 导致详情读取链路 fail-closed 503 的问题（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][MEDIUM] 补充 `membership_id` 详情读取事实源回归：覆盖 memory store 正向投影与 mysql 查询投影（`apps/api/test/auth.service.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] 修复 store 层对 `display_name/department_name` 的隐式 trim 纠正，避免脏数据被“修正后接纳”而绕过服务层 fail-closed 校验（`apps/api/src/modules/auth/auth.store.memory.js`、`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：in-memory seed 含前后空白资料字段时应返回 `503`，以及 mysql store 读取保持原始资料字段值（`apps/api/test/auth.service.test.js`、`apps/api/test/auth.store.mysql.test.js`）。
- [x] [AI-Review][HIGH] 修复 MySQL 成员读取链路使用 `INNER JOIN users` 导致异常关联被静默过滤（误判为不存在/漏数）的问题，改为 `LEFT JOIN` 以保证服务层可按 fail-closed 处理（`apps/api/src/modules/auth/auth.store.mysql.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：覆盖详情读取/成员列表/资料更新回读三条查询的 `LEFT JOIN` 行为，并验证缺失用户关联时 service 侧稳定返回 `503`（`apps/api/test/auth.store.mysql.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复 `auth.service` 角色绑定读写入口仅校验 membership 存在/状态、未校验 membership 结构完整性的问题，避免缺失 `phone` 等异常关系被误接纳并继续执行（`apps/api/src/modules/auth/auth.service.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：角色绑定读写在 membership lookup 返回缺失 `phone` 的异常记录时必须 fail-closed 返回 `503`（`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复资料更新 store 仅拦截“空手机号”却未拦截“格式异常手机号”导致潜在“写入后再 503”窗口的问题：在写前锁定校验与回读校验统一执行严格手机号校验，异常即事务内 fail-closed（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：覆盖 mysql store 锁定行手机号含前导空白时必须写前拦截，以及 service 对异常手机号返回的 fail-closed 语义（`apps/api/test/auth.store.mysql.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复资料更新在“仅改 `display_name` 且历史 `department_name` 脏值”时可能出现“写入后再 503”窗口的问题：store 在省略 `department_name` 更新时先校验现存部门字段严格合法，不合法则写前 fail-closed（`apps/api/src/modules/auth/auth.store.mysql.js`、`apps/api/src/modules/auth/auth.store.memory.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：覆盖 mysql 锁定行脏部门值写前拦截，以及 service 层验证“失败不应发生 display_name 变更”语义（`apps/api/test/auth.store.mysql.test.js`、`apps/api/test/auth.service.test.js`）。
- [x] [AI-Review][HIGH] 修复启动期 schema 预检遗漏 `auth_user_tenants` 关键字段（`membership_id/display_name/department_name/joined_at/left_at`）的问题，避免缺迁移时运行期才暴露 5xx（`apps/api/src/app.js`）。
- [x] [AI-Review][MEDIUM] 统一 `auth.express` 预检测试中的 `auth_user_tenants` 必需列基线，消除多处硬编码列清单漂移风险（`apps/api/test/auth.express.api.test.js`）。
- [x] [AI-Review][MEDIUM] 补充回归：新增“缺失 profile 列应启动即失败”用例，覆盖 `display_name/department_name` 缺列场景（`apps/api/test/auth.express.api.test.js`）。

## Dev Notes

### Developer Context（开发者必须先读）

- Story 3.1 已落地成员关系生命周期与 `membership_id` 事实锚点；本故事必须复用该主键语义。
- Story 3.2 已完成组织角色治理；Story 3.3 已完成权限树与成员角色绑定并大量加固 fail-closed。
- 当前 `tenant member` 模块已有接口：`GET/POST /tenant/members`、`PATCH /tenant/members/:membership_id/status`、`GET/PUT /tenant/members/:membership_id/roles`，尚无资料维护专用接口。
- 本故事要在现有稳定语义上增量交付，禁止回退既有幂等/权限/错误模型。

### Technical Requirements（实现硬约束）

- 业务字段约束（来源于 PRD 附录）：
  - `display_name`: `VARCHAR(64)`，组织内显示名，必填。
  - `department_name`: `VARCHAR(128)`，组织内部门，可选。
- 资料更新属于成员治理写操作，必须：
  - 走受保护路由；
  - 保持 Problem Details 错误语义；
  - 保持幂等语义；
  - 审计留痕。
- AC1 的“列表与详情一致”必须有可验证实现路径：
  - 列表返回包含最新资料字段；
  - 详情读取同一事实源；
  - 更新后立即可见（同请求链路后读一致）。

### Architecture Compliance（架构对齐清单）

- 命名与格式：
  - 外部 API 字段 `snake_case`；内部实现可 `camelCase`，经显式映射层转换。
  - 错误结构固定为 Problem Details 扩展：`type/title/status/detail/code(refer error_code)/retryable/request_id`。
- 安全与边界：
  - tenant 域只信任服务端 `active_tenant_id`。
  - 控制器层不吞错，异常统一映射。
  - 下游畸形数据不得静默过滤，保持 fail-closed。
- 流程一致性：
  - 写接口接入幂等中间件。
  - 受保护路由必须声明权限并通过 `check:route-permissions`。

### Library & Framework Requirements（最新信息）

- 本仓库当前依赖基线：
  - `@nestjs/core 11.1.13`（可对齐到 `11.1.14` patch）
  - `typeorm 0.3.28`（当前最新同为 `0.3.28`）
  - `mysql2 ^3.17.0`（最新 `3.17.3`）
  - `ioredis 5.9.2`（最新 `5.9.3`）
  - Node 引擎要求：`>=24.0.0`，Node LTS 最新为 `v24.13.1`
- 安全提示（2026-02-20 本地审计）：
  - `typeorm > glob > minimatch@9.0.5` 命中 `GHSA-3ppc-4f35-3m26`（ReDoS，高危）。
  - 本故事实现中需避免直接引入该链路风险扩散；建议在后续技术债故事中升级/覆盖到 `minimatch >=10.2.1`。

### File Structure Requirements（建议变更落点）

- 重点修改：
  - `apps/api/src/modules/tenant/member.constants.js`
  - `apps/api/src/modules/tenant/member.routes.js`
  - `apps/api/src/modules/tenant/member.service.js`
  - `apps/api/src/modules/auth/auth.service.js`
  - `apps/api/src/modules/auth/auth.store.memory.js`
  - `apps/api/src/modules/auth/auth.store.mysql.js`
  - `apps/api/src/route-permissions.js`
  - `apps/api/src/server.js`
  - `apps/api/src/openapi.js`
- 测试与门禁：
  - `apps/api/test/tenant.member.api.test.js`
  - `apps/api/test/auth.service.test.js`
  - `apps/api/test/auth.store.mysql.test.js`
  - `apps/api/test/server.test.js`
  - `apps/api/test/route-permissions.test.js`

### Testing Requirements（必须覆盖）

- AC1 正向：
  - 成员资料更新成功并可在列表/详情读取到最新值。
  - 支持 `department_name` 可空写入与再次更新。
- AC2 负向：
  - `display_name` 为空、超长、控制字符；
  - `department_name` 超长、控制字符；
  - 非法 `membership_id`、成员不存在、越租户访问。
- 稳定性与安全：
  - 幂等同键重放一致、同键异载荷冲突。
  - 下游畸形回包统一 `503` fail-closed。
  - 错误码与 `retryable` 映射稳定。

### Previous Story Intelligence（来自 Story 3.3）

- `membership_id` 在路由层、服务层、幂等层必须统一规范化与严格校验。
- 下游回包字段不能“trim 后接纳”或“缺失时默认值兜底”，需要严格 fail-closed。
- 路由声明、OpenAPI 示例、幂等策略回归必须同步提交，避免契约与行为漂移。
- 高频改动集中在 `modules/tenant/*`、`modules/auth/*`、`server.js`、`openapi.js`、`route-permissions.js` 与对应测试。

### Git Intelligence Summary（最近 5 次提交模式）

- 最近提交持续聚焦：`tenant/member`、`tenant/role`、`auth.service/store`、`openapi`、`route-permissions`、回归测试。
- 交付模式已稳定为：
  - 先实现能力；
  - 再做多轮 fail-closed 加固；
  - 最后补齐契约与门禁回归。
- 本故事建议沿用同一节奏，避免“只改功能不补护栏”。

### Project Context Reference

- 未发现 `project-context.md`（`**/project-context.md` 无匹配）。
- 以 `_bmad-output/planning-artifacts/*` 与已完成故事文档作为当前上下文基线。

### References

- 史诗与故事定义：`_bmad-output/planning-artifacts/epics.md`
- 架构约束：`_bmad-output/planning-artifacts/architecture.md`
- 产品需求与 NFR：`_bmad-output/planning-artifacts/prd.md`
- 字段字典与前端清单：`_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md`
- 交互规范：`_bmad-output/planning-artifacts/ux-design-specification.md`
- 上一故事经验：`_bmad-output/implementation-artifacts/3-3-组织权限树与成员角色分配.md`
- 现有成员模块：`apps/api/src/modules/tenant/member.constants.js`、`apps/api/src/modules/tenant/member.routes.js`、`apps/api/src/modules/tenant/member.service.js`
- 现有契约与权限声明：`apps/api/src/openapi.js`、`apps/api/src/route-permissions.js`

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex (CLI)

### Debug Log References

- `pnpm --dir apps/api exec node --test test/tenant.member.api.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js`
- `pnpm --dir apps/api exec node --test test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test test/server.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/tenant.member.api.test.js test/server.test.js`
- `pnpm --dir apps/api exec node --test test/auth.service.test.js test/auth.store.mysql.test.js`
- `pnpm --dir apps/api exec node --test test/route-permissions.test.js`
- `pnpm --dir apps/api exec node --test test/migrate-baseline.test.js`
- `pnpm --dir apps/api check:route-permissions`
- `pnpm --dir apps/api lint`
- `pnpm --dir apps/api test`
- `pnpm --dir apps/api exec node --test --test-force-exit test/auth.express.api.test.js`

### Senior Developer Review (AI)

- 首轮审查发现 3 项问题：1 项 HIGH（字段被误清空导致数据漂移风险）+ 2 项 MEDIUM（回归覆盖缺口、OpenAPI 契约漂移）。
- 继续审查新增 2 项问题：1 项 HIGH（详情事实源缺失 `phone` 导致 fail-closed）+ 1 项 MEDIUM（对应回归缺口）。
- 继续审查再新增 2 项问题：1 项 HIGH（store 层隐式 trim 绕过 fail-closed）+ 1 项 MEDIUM（对应回归缺口）。
- 继续审查再新增 2 项问题：1 项 HIGH（`INNER JOIN users` 吞异常关联导致 fail-open）+ 1 项 MEDIUM（对应回归缺口）。
- 继续审查再新增 2 项问题：1 项 HIGH（角色绑定读写入口未严格校验 membership 结构）+ 1 项 MEDIUM（对应回归缺口）。
- 继续审查再新增 2 项问题：1 项 HIGH（资料更新 store 对异常手机号依赖校验不充分，存在潜在“写后失败”窗口）+ 1 项 MEDIUM（对应回归缺口）。
- 继续审查再新增 2 项问题：1 项 HIGH（仅改 `display_name` 时历史脏 `department_name` 可触发“写后失败”窗口）+ 1 项 MEDIUM（对应回归缺口）。
- 本轮复审新增 3 项问题：1 项 HIGH（启动期 schema 预检漏检成员资料关键列）+ 2 项 MEDIUM（预检测试列基线漂移风险、缺失 profile 缺列回归）。
- 问题均已修复并补充回归，当前无遗留 HIGH/MEDIUM。
- 全量门禁复验通过：`check:route-permissions`、`lint`、`test`。

### Completion Notes List

- 已交付成员资料查询/更新接口：`GET /tenant/members/:membership_id`、`PATCH /tenant/members/:membership_id/profile`，并接入写接口幂等。
- 已在 tenant member / auth service / memory+mysql store 打通资料字段事实源，确保列表/详情/更新一致。
- 已新增并应用迁移 `0016_auth_tenant_member_profile_fields`（`display_name`、`department_name`）。
- 已补齐 OpenAPI、路由权限声明与 server 契约断言，覆盖 400/401/403/404/409/413/503 语义。
- 已补充服务层与存储层 fail-closed 回归，并修复全量回归中暴露的 MySQL 迁移链/外键顺序问题。
- 已修复 `department_name` 省略时的误清空问题，并新增对应 API/Service 回归测试。
- 已移除 OpenAPI 不可达 409 示例并同步契约测试断言。
- 已修复 `findTenantMembershipByMembershipIdAndTenantId` 在 memory/mysql store 未返回 `phone` 的事实源缺口，并补齐对应回归测试。
- 已修复 store 层对资料字段的隐式 trim 纠正行为，改为读取链路透传原始值并由服务层统一执行 fail-closed 校验。
- 已修复 MySQL 成员读取链路 `INNER JOIN users` 的异常关联吞没问题（改为 `LEFT JOIN`），确保缺失用户关联不会误判为“成员不存在”，由服务层统一 fail-closed。
- 已修复角色绑定读写入口对 membership 结构校验缺失的问题：在执行角色绑定读写前统一校验 membership 记录完整性，缺失关键字段时返回 `503` fail-closed。
- 已修复资料更新 store 对异常手机号依赖校验不充分的问题：锁定行与回读行均执行严格手机号校验，异常关系在事务内 fail-closed，避免潜在“写后失败”窗口。
- 已修复资料更新在省略 `department_name` 更新时的历史脏部门值窗口：新增写前严格校验，避免“display_name 已写入但接口返回 503”的不一致状态。
- 已补齐 `createApiApp` 启动期 `auth_user_tenants` 必需字段预检，新增 `membership_id/display_name/department_name/joined_at/left_at` fail-fast 校验。
- 已统一并补强 `auth.express` 预检测试列基线与缺列回归，确保 profile 列缺失时启动立即失败。
- 门禁全部通过：`check:route-permissions`、`lint`、`test`。

### File List

- `_bmad-output/implementation-artifacts/3-4-组织成员资料维护.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `apps/api/migrations/0016_auth_tenant_member_profile_fields.sql`
- `apps/api/migrations/0016_auth_tenant_member_profile_fields.down.sql`
- `apps/api/src/http-routes.js`
- `apps/api/src/app.js`
- `apps/api/src/modules/auth/auth.service.js`
- `apps/api/src/modules/auth/auth.store.memory.js`
- `apps/api/src/modules/auth/auth.store.mysql.js`
- `apps/api/src/modules/tenant/member.constants.js`
- `apps/api/src/modules/tenant/member.routes.js`
- `apps/api/src/modules/tenant/member.service.js`
- `apps/api/src/openapi.js`
- `apps/api/src/route-permissions.js`
- `apps/api/src/server.js`
- `apps/api/test/auth.express.api.test.js`
- `apps/api/test/auth.service.test.js`
- `apps/api/test/auth.store.mysql.test.js`
- `apps/api/test/migrate-baseline.test.js`
- `apps/api/test/route-permissions.test.js`
- `apps/api/test/server.test.js`
- `apps/api/test/tenant.member.api.test.js`
