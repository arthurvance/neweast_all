---
stepsCompleted:
  - 1
  - 2
  - 3
  - 4
inputDocuments:
  - '_bmad-output/planning-artifacts/prd.md'
  - '_bmad-output/planning-artifacts/architecture.md'
  - '_bmad-output/planning-artifacts/ux-design-specification.md'
  - '_bmad-output/planning-artifacts/prd-appendix-legacy-inputs.md'
  - '_bmad-output/planning-artifacts/ux-color-themes.html'
---

# neweast - Epic Breakdown

## Overview

This document provides the complete epic and story breakdown for neweast, decomposing the requirements from the PRD, UX Design if it exists, and Architecture requirements into implementable stories.

## Requirements Inventory

### Functional Requirements

FR1: 用户可以使用手机号+密码登录系统。
FR2: 用户可以使用手机号+验证码登录系统。
FR3: 用户可以刷新登录会话并保持访问连续性。
FR4: 用户可以退出当前会话。
FR5: 用户可以修改密码并在会话更新后重新登录。
FR6: 系统可以根据登录入口识别访问域（平台域或组织域）。
FR7: 多组织用户可以在登录后选择目标组织再进入工作台。
FR8: 组织用户可以在会话内切换组织。
FR9: 系统可以在用户无有效域权限时拒绝进入对应域，并返回错误码 `AUTH-403-NO-DOMAIN` 与标准提示文案。
FR10: 平台管理员可以创建组织并指定组织负责人。
FR11: 平台管理员可以维护组织状态（启用/禁用）。
FR12: 平台管理员可以变更组织负责人。
FR13: 平台管理员可以创建与维护平台用户。
FR14: 平台管理员可以维护平台用户状态。
FR15: 平台管理员可以创建与维护平台角色（受保护系统角色除外编辑/删除）。
FR16: 平台管理员可以配置平台角色权限树。
FR17: 平台管理员可以向平台用户分配1 至 5 个平台角色。
FR18: 新增平台成员在分配1 至 5 个平台角色后，可以进入平台并执行授权范围内操作。
FR19: 组织负责人/组织管理员可以创建与维护组织成员。
FR20: 组织负责人/组织管理员可以维护组织成员状态。
FR21: 组织负责人/组织管理员可以创建与维护组织角色（受保护系统角色除外编辑/删除）。
FR22: 组织负责人/组织管理员可以配置组织角色权限树。
FR23: 组织负责人/组织管理员可以向组织成员分配1 至 5 个组织角色。
FR24: 组织负责人/组织管理员可以维护成员的组织内资料（如显示名、部门）。
FR25: 负责人变更后，新负责人可以立即完成组织治理接管。
FR26: 系统可以维护平台域与组织域独立的权限命名空间与授权边界。
FR27: 系统可以按有效权限控制菜单、按钮与受保护操作的可访问性。
FR28: 系统可以对未授权访问执行一致性拒绝。
FR29: 系统可以在权限计算中排除禁用角色。
FR30: 系统可以在角色或授权变更后即时反映最新访问结果。
FR31: 系统可以阻止仅平台身份且无组织关系的用户进入组织工作台。
FR32: 系统可以在组织新增成员时复用已存在全局用户身份。
FR33: 系统可以为同一用户在不同组织维护独立成员关系与角色绑定。
FR34: 系统可以在成员离组后支持后续重新入组并形成新的有效成员关系。
FR35: 系统可以在组织负责人变更时自动完成必要的成员关系与角色关系补齐。
FR36: 系统可以支持入站与出站的外部系统通信能力。
FR37: 授权操作者可以为外部系统维护集成规格信息（方向、协议、鉴权、策略等）。
FR38: 系统可以按版本化集成契约（OpenAPI/Event）执行外部接口交互。
FR39: 系统可以对集成失败执行重试、恢复与再处理闭环。
FR40: 系统可以对外部接口能力执行版本兼容管理。
FR41: 系统可以在外部集成变更前执行契约一致性校验。
FR42: 系统可以记录认证、授权变更、负责人变更、关键配置变更等审计事件。
FR43: 授权操作者可以按平台域/组织域查询审计事件。
FR44: 系统可以将关键业务操作与集成交互关联到可追踪请求标识。
FR45: 系统可以保留关键变更的前后状态用于追责与排障。
FR46: 授权操作者可以维护受控系统配置（如默认密码策略项）。
FR47: 系统可以对受保护系统角色实施不可编辑/不可删除约束。
FR48: 系统可以在发布前执行并输出关键能力回归结果（P0、集成链路、核心旅程）。
FR49: 系统可以按平台域角色并集计算平台用户有效权限（不使用显式 deny）。
FR50: 系统可以在角色状态变更后即时重算并生效用户有效权限。
FR51: 系统可以仅基于服务端上下文确定组织域有效租户并拒绝伪造租户上下文。
FR52: 系统可以对关键写接口执行幂等判定并返回一致结果。
FR53: 系统可以识别并处置 refresh token 重放行为。
FR54: 系统可以对负责人变更并发冲突返回可识别冲突结果并支持安全重试。
FR55: 授权操作者可以管理外部集成生命周期状态。
FR56: 授权操作者可以执行外部集成清单冻结与解冻。
FR57: 系统可以记录并追踪集成契约版本变更历史。
FR58: 系统可以执行发布前能力回归门禁并输出按能力分组的结果。
FR59: 系统可以在创建不存在用户时按默认密码策略初始化账号，并仅保存密码哈希。
FR60: 系统可以在将已存在手机号用户加入平台或组织时保持该用户密码不变。
FR61: 系统可以支持新建用户首次登录不强制改密，且不提供管理员配置入口。
FR62: 系统可以对认证相关接口按手机号维度执行限流并在超限时拒绝请求。
FR63: 系统可以对密码登录、验证码登录、验证码发送实施独立限流计数。
FR64: 平台管理员可以在创建组织时提交初始管理员手机号；未提交时系统必须拒绝创建并返回标准错误码。
FR65: 系统可以在负责人变更后确保新负责人具备组织治理所需最小权限，且旧负责人权限不自动移除。
FR66: 系统可以将 `sys_admin` 角色定义为受保护角色，仅允许授权分配，不允许编辑或删除。
FR67: 系统可以支持同一用户多会话并发，且 `logout` 仅撤销当前会话。
FR68: 系统可以支持平台入口与组织入口并行访问，并确保两入口能力边界一致受控。
FR69: 系统可以在关键写接口支持幂等请求语义，并对重复请求返回一致结果。
FR70: 系统可以在组织域鉴权中使用服务端确认的有效租户上下文进行最终访问判定。
FR71: 系统可以在负责人变更并发场景下返回可识别冲突结果，并支持安全重试。
FR72: 系统可以要求每个受保护接口声明权限标识，缺失声明时拒绝发布与运行。
FR73: 系统可以维护统一权限清单并在启动时执行幂等同步。
FR74: 系统可以在权限树保存时仅保留最终授权结果，并支持前端父子节点联动展示。
FR75: 系统可以在角色状态变更为禁用后立即使其权限失效，并保留历史绑定记录。
FR76: 系统可以在负责人变更前校验组织与新负责人状态，不满足条件时拒绝变更。
FR77: 系统可以在组织软删除时同步失效成员、组织角色与角色绑定关系。
FR78: 系统可以在用户软删除时撤销该用户全部 refresh token。
FR79: 系统可以在权限或身份关键状态变化后使历史会话失效，并对失效会话返回未授权响应。
FR80: 系统可以维护统一错误码体系，并提供可重试语义分层与前端动作映射。

### NonFunctional Requirements

NFR1: 核心 API 在常规核心负载下满足 P95 <= 300ms。
NFR2: 关键用户路径（登录、组织创建、角色授权、负责人变更）在交互侧保持可接受响应，不出现持续阻塞。
NFR3: 关键查询与列表能力在分页条件下保持稳定响应。
NFR4: 全链路通信必须使用 TLS。
NFR5: 敏感数据在存储与传输过程中必须受保护（如密码、令牌、敏感配置）。
NFR6: 平台域与组织域权限边界必须强隔离，不得出现越域授权生效。
NFR7: 受保护接口默认拒绝未声明授权规则的访问。
NFR8: Refresh token 重放必须可识别并触发统一处置。
NFR9: MVP 期服务可用性目标 >= 99.5%。
NFR10: 故障恢复 MTTR <= 30 分钟。
NFR11: P0 相关故障告警发现时长 MTTD <= 5 分钟。
NFR12: 关键事务链路（负责人变更）必须满足全成功/全回滚一致性。
NFR13: 外部集成调用对可重试错误支持重试，并采用指数退避 + jitter。
NFR14: 写操作集成必须具备幂等保障与去重策略。
NFR15: 集成链路必须具备端到端可追踪标识（request_id / traceparent）。
NFR16: 外部接口变更必须通过契约一致性校验与版本治理流程。
NFR17: 外部集成上线必须满足 Integration DoD（合同测试、监控告警、恢复演练）。
NFR18: 架构支持从 MVP 向多组织规模增长时横向扩展，不以重写核心权限模型为前提。
NFR19: 组织与成员规模增长时，权限计算与组织切换能力保持可用且可观测。
NFR20: Web 端核心管理流程满足基础可访问性要求（键盘可达、语义化反馈、可识别错误提示）。
NFR21: 关键操作反馈不依赖单一视觉信号，提供文本可理解提示。
NFR22: 每个关键 NFR 都必须定义对应验证证据与验收归档（压测报告、安全测试、回归结果、演练记录）。
NFR23: 权限关键路径在 10x 目标规模增长场景需通过基线压测验证。
NFR24: 默认密码配置必须以受保护配置形式存储，并通过环境密钥进行解密使用。
NFR25: 系统不得存储、返回或记录明文密码，日志与审计中需对敏感凭据脱敏。
NFR26: 认证相关限流采用滑动窗口算法，限流维度为手机号。
NFR27: 针对同一手机号，密码登录与验证码登录限流阈值为 1 分钟内最多 10 次（分别计数）；验证码发送实施 60 秒严格冷却期。
NFR28: 登录接口超限策略为立即拒绝本次请求，不设置额外冷却时间；验证码发送接口执行严格冷却。
NFR29: 验证码有效期固定为 15 分钟，并在过期后不可再用于登录。
NFR30: 验证码发送按钮倒计时必须基于服务端剩余时间恢复，避免刷新后失真。
NFR31: 会话策略支持无限并发会话，`logout` 不影响其它会话。
NFR32: 数据库存储统一 UTC，API 时间字段统一 UTC 返回。
NFR33: 前端展示时间统一转换为 `Asia/Shanghai` 并使用统一格式输出。
NFR34: 密码规则最小约束为长度 `>= 6`，MVP 不强制复杂度、不限制历史复用、不要求新旧密码不同。
NFR35: 认证失败反馈采用统一外显语义（禁用状态可单独提示），验证码错误/过期/已使用对外统一文案。
NFR36: OpenAPI 必须完整覆盖请求字段、响应结构、枚举、分页、错误码与主要错误示例。
NFR37: 上线最小可观测基线必须覆盖鉴权失败率、越权拒绝率、负责人变更失败率。
NFR38: 上线前必须完成最小灾备基线（备份频率、恢复流程、至少一次恢复演练留档）。

### Additional Requirements

- Starter Template（Epic 1 Story 1 约束）：必须以 Nx Monorepo (React + Vite + NestJS + pnpm) 作为初始化基线，并将工作区初始化作为首个实现故事。
- 运行时与主栈：Node.js 24 LTS、MySQL 8.4 LTS、TypeORM、Redis。
- API 契约：REST + OpenAPI（契约单一事实源）+ Problem Details 错误结构。
- 安全与会话基线：JWT（RS256）+ refresh rotation + replay detection + session_version，关键身份/权限变更需即时失效历史会话。
- 双域授权硬约束：platform/tenant 权限命名空间与授权边界强隔离；组织域最终租户判定仅信任服务端上下文。
- 权限声明门禁：每个受保护接口必须声明权限标识，漏声明必须阻断发布与运行。
- 权限清单治理：统一权限清单在启动时执行幂等同步，权限树保存仅保留最终授权结果。
- 写接口一致性：关键写操作需统一幂等语义、冲突可识别、支持安全重试。
- 集成模式：同步 API + 异步事件/Webhook 双通道；需支持指数退避重试、DLQ、人工重放 runbook。
- 可观测性：request_id / traceparent 全链路贯穿；审计需覆盖认证、授权、负责人变更、关键配置变更，保留 before/after。
- 数据与迁移：迁移脚本版本化并纳入 CI 门禁，禁止手工修改线上 schema；软删除与级联一致性需可验证。
- 认证策略细则：手机号维度限流（滑动窗口）；验证码有效期与按钮倒计时需由服务端剩余时间驱动。
- 会话并发策略：支持无限并发会话，logout 仅撤销当前会话，不提供 logout-all。
- 前端交互容器：列表工作台 + Modal/Drawer + message 的统一交互骨架，不引入页面级特例。
- 提交流程统一：提交按钮必须 loading 防重，回车提交同样遵循防重复。
- 反馈一致性：字段错误使用字段级提示，不与全局 message 重复叠加；失败语义采用“原因 + 请稍后重试”。
- 详情展示约束：Web 端详情统一 Drawer，使用 size 属性，不使用自定义 width。
- 响应式策略：Desktop-first，断点采用 AntD 默认体系（Mobile <768, Tablet 768-1023, Desktop >=1024）。
- 可访问性策略：以 AntD 组件能力实现 WCAG AA 基线（键盘可达、焦点可见、语义反馈一致、文本可辨识）。
- 测试与发布门禁：Chrome 为发布前强约束；关键链路/关键交互需覆盖自动化与人工验证。
- 视觉主题约束：采用 Ant Design 默认语义色体系，不自定义品牌色板。
- 部署路径：本地优先（Docker Compose）→ 容器化云部署（阿里云/腾讯云）。

### FR Coverage Map

FR1: Epic 1 - 密码登录
FR2: Epic 1 - 验证码登录
FR3: Epic 1 - 会话刷新
FR4: Epic 1 - 退出登录
FR5: Epic 1 - 修改密码后重登
FR6: Epic 1 - 入口域识别
FR7: Epic 1 - 多组织登录后选择
FR8: Epic 1 - 会话内切换组织
FR9: Epic 1 - 无域权限拒绝与标准错误码
FR10: Epic 2 - 创建组织并指定负责人
FR11: Epic 2 - 组织状态维护
FR12: Epic 2 - 变更组织负责人
FR13: Epic 2 - 平台用户治理
FR14: Epic 2 - 平台用户状态治理
FR15: Epic 2 - 平台角色治理
FR16: Epic 2 - 平台权限树配置
FR17: Epic 2 - 平台用户角色分配
FR18: Epic 2 - 新平台成员入平台与授权动作
FR19: Epic 3 - 组织成员治理
FR20: Epic 3 - 组织成员状态治理
FR21: Epic 3 - 组织角色治理
FR22: Epic 3 - 组织权限树配置
FR23: Epic 3 - 组织成员角色分配
FR24: Epic 3 - 成员组织资料维护
FR25: Epic 3 - 负责人变更后立即接管
FR26: Epic 1 - 双域权限命名空间与边界
FR27: Epic 1 - 菜单/按钮/操作可访问控制
FR28: Epic 1 - 未授权一致性拒绝
FR29: Epic 1 - 禁用角色不参与权限计算
FR30: Epic 1 - 变更后权限即时生效
FR31: Epic 1 - 仅平台身份不可进组织工作台
FR32: Epic 3 - 新增成员复用全局身份
FR33: Epic 3 - 跨组织独立成员关系与角色绑定
FR34: Epic 3 - 离组后可重新入组
FR35: Epic 3 - 负责人变更自动补齐关系
FR36: Epic 5 - 入站/出站集成通信
FR37: Epic 5 - 集成规格维护
FR38: Epic 5 - 版本化集成契约交互
FR39: Epic 5 - 集成失败重试与恢复
FR40: Epic 5 - 外部接口版本兼容管理
FR41: Epic 5 - 集成变更前契约校验
FR42: Epic 4 - 审计事件记录
FR43: Epic 4 - 按域查询审计事件
FR44: Epic 4 - 业务与集成交互可追踪关联
FR45: Epic 4 - 关键变更前后状态留痕
FR46: Epic 4 - 受控系统配置治理
FR47: Epic 4 - 受保护系统角色不可编辑/删除
FR48: Epic 4 - 发布前关键能力回归输出
FR49: Epic 1 - 平台角色并集权限计算
FR50: Epic 1 - 角色状态变更后即时重算生效
FR51: Epic 1 - 服务端租户上下文最终判定
FR52: Epic 1 - 关键写接口幂等判定
FR53: Epic 1 - Refresh token 重放识别处置
FR54: Epic 3 - 负责人变更并发冲突与安全重试
FR55: Epic 5 - 集成生命周期状态管理
FR56: Epic 5 - 集成清单冻结/解冻
FR57: Epic 5 - 集成契约版本变更追踪
FR58: Epic 5 - 集成能力回归门禁分组输出
FR59: Epic 1 - 默认密码策略初始化并仅存哈希
FR60: Epic 1 - 既有用户加入不改密码
FR61: Epic 1 - 首登不强制改密且不可配置
FR62: Epic 1 - 认证链路手机号限流
FR63: Epic 1 - 三类认证动作独立限流计数
FR64: Epic 2 - 创建组织必须初始管理员手机号
FR65: Epic 3 - 负责人变更后最小治理权限保障
FR66: Epic 2 - sys_admin 受保护角色约束
FR67: Epic 1 - 多会话并发与 logout 仅当前会话
FR68: Epic 1 - 平台/组织双入口并行访问
FR69: Epic 1 - 关键写接口重复请求一致返回
FR70: Epic 1 - 组织域服务端有效租户鉴权
FR71: Epic 3 - 负责人并发场景冲突可识别可重试
FR72: Epic 1 - 受保护接口必须声明权限标识
FR73: Epic 1 - 统一权限清单启动幂等同步
FR74: Epic 4 - 权限树仅保留最终授权结果
FR75: Epic 4 - 角色禁用后权限立即失效
FR76: Epic 3 - 负责人变更前置状态校验
FR77: Epic 3 - 组织软删除级联失效
FR78: Epic 4 - 用户软删除撤销全部 refresh token
FR79: Epic 1 - 关键状态变化使历史会话失效
FR80: Epic 1 - 统一错误码与前端动作映射

## Epic List

### Epic 1: 认证与访问控制基线及双入口体验
用户可以安全登录、稳定续期、在平台域/组织域正确进入与切换，并获得一致的权限判定与拒绝语义。
**FRs covered:** FR1, FR2, FR3, FR4, FR5, FR6, FR7, FR8, FR9, FR26, FR27, FR28, FR29, FR30, FR31, FR49, FR50, FR51, FR52, FR53, FR59, FR60, FR61, FR62, FR63, FR67, FR68, FR69, FR70, FR72, FR73, FR79, FR80
**Implementation note:** Story 1.1 必须先完成 Nx Monorepo 初始化（React + Vite + NestJS + pnpm）以及认证/权限契约基础骨架。

### Epic 2: 平台治理与组织开通
平台管理员可以完成组织开通、平台成员与平台角色治理，确保新平台成员可进入平台并执行授权动作。
**FRs covered:** FR10, FR11, FR12, FR13, FR14, FR15, FR16, FR17, FR18, FR64, FR66

### Epic 3: 组织治理与负责人安全接管
组织负责人/管理员可以完成成员与角色治理，且在负责人变更与生命周期场景下保持可接管、可恢复、一致性安全。
**FRs covered:** FR19, FR20, FR21, FR22, FR23, FR24, FR25, FR32, FR33, FR34, FR35, FR54, FR65, FR71, FR76, FR77

### Epic 4: 审计追踪、系统治理与发布门禁
系统可以提供可追溯审计、受控配置与发布前治理门禁，保证运营可见、可控、可回归。
**FRs covered:** FR42, FR43, FR44, FR45, FR46, FR47, FR48, FR74, FR75, FR78

### Epic 5: 外部集成互操作与集成发布门禁
授权操作者可以管理外部集成全生命周期，系统可执行契约一致性、版本治理、失败恢复与集成发布门禁。
**FRs covered:** FR36, FR37, FR38, FR39, FR40, FR41, FR55, FR56, FR57, FR58

### NFR Ownership Map

- Epic 1（认证与访问控制基线）：NFR1-NFR8, NFR24-NFR35
- Epic 2（平台治理与组织开通）：NFR20-NFR21（平台治理主路径的可访问性与反馈一致性）
- Epic 3（组织治理与负责人接管）：NFR9-NFR12
- Epic 4（审计追踪与系统治理）：NFR22-NFR23, NFR36-NFR38
- Epic 5（外部集成互操作）：NFR13-NFR19

## Epic 1: 认证与访问控制基线及双入口体验

用户可以安全登录、稳定续期、在平台域/组织域正确进入与切换，并获得一致的权限判定与拒绝语义。

### Story 1.1: 基座初始化与全 Docker 本地环境

As a 开发者,
I want 使用 Nx 初始化项目并通过 Docker 一键拉起全部本地环境,
So that 我可以在一致环境下立即开始认证与权限能力开发而不依赖本机手工安装。
**FRs:** FR1, FR2, FR3, FR72, FR80

**Acceptance Criteria:**

**Given** 新仓库为空且机器仅安装了 Docker / Docker Compose
**When** 执行项目初始化命令
**Then** 仓库生成 Nx Monorepo（包含 apps/web 与 apps/api）
**And** 依赖管理、基础脚本与目录结构可正常执行（lint/test/build 命令可运行）

**Given** 已存在 docker-compose 配置
**When** 执行 `docker compose up -d`
**Then** web、api、mysql、redis 四个服务均成功启动
**And** 服务健康检查通过，容器可稳定重启并保持可用

**Given** API 服务在 Docker 中启动
**When** API 读取环境变量并建立基础连接
**Then** API 可连接 MySQL 与 Redis
**And** 连接失败时输出标准化错误日志（含 request_id 占位能力）

**Given** 数据层采用 TypeORM migration 机制
**When** 执行 migration 初始化命令
**Then** migration 流程可在 Docker 环境内执行成功
**And** 本故事不创建与未来故事无关的业务表，仅建立后续故事可扩展的迁移基线

**Given** 契约优先要求已确认
**When** 访问 API 契约与错误响应骨架
**Then** OpenAPI 文档入口可访问，且包含基础认证模块占位
**And** 错误响应骨架采用 Problem Details 结构占位，供后续故事增量实现

**Given** 本地 Docker 环境已启动
**When** 执行最小认证链路 smoke（web -> api -> db/redis）
**Then** 端到端请求闭环可成功执行
**And** 产出可归档的 smoke 结果记录

**Given** CI 运行 Story 1.1 对应流水线
**When** 触发基础门禁
**Then** 至少包含 lint/build/test/smoke 四类结果
**And** 任一失败阻断合并

### Story 1.2: 密码登录、会话刷新与当前会话登出

As a 平台或组织用户,
I want 使用手机号+密码登录，并可刷新与登出当前会话,
So that 我可以稳定访问系统且会话生命周期可控。
**FRs:** FR1, FR3, FR4, FR5, FR67

**Acceptance Criteria:**

**Given** 用户状态可用且手机号/密码正确
**When** 用户发起密码登录
**Then** 系统签发 access token 与 refresh token
**And** 返回统一成功响应（含会话标识信息，供后续链路追踪）

**Given** 用户不存在、密码错误或用户状态不可用
**When** 用户发起密码登录
**Then** 系统拒绝登录并返回统一错误码与标准提示
**And** 响应不泄露账号存在性等敏感信息

**Given** refresh token 处于有效状态
**When** 用户发起刷新会话
**Then** 系统返回新的 access token 与 refresh token
**And** 旧 refresh token 立即失效（rotation 生效）

**Given** 用户存在多个并发会话
**When** 用户在某一会话执行 logout
**Then** 系统仅撤销当前会话对应 token
**And** 其他会话保持有效（不触发全量登出）

**Given** 用户已完成身份校验并提交修改密码请求
**When** 新密码满足策略并保存成功
**Then** 系统更新密码哈希并要求该用户重新登录
**And** 后续认证仅接受新密码

### Story 1.3: 验证码登录与发送频控

As a 平台或组织用户,
I want 使用手机号+验证码登录并遵循统一频控规则,
So that 我可以在不使用密码时安全完成登录且系统可抵御短信滥用。
**FRs:** FR2, FR62, FR63

**Acceptance Criteria:**

**Given** 用户请求发送验证码且手机号格式合法
**When** 用户触发验证码发送
**Then** 系统按手机号维度写入发送记录并返回统一响应
**And** 倒计时以服务端剩余时间为准，刷新页面后可恢复

**Given** 同一手机号在 1 分钟内超过发送阈值
**When** 用户继续请求发送验证码
**Then** 系统立即拒绝请求并返回限流错误码
**And** 审计日志记录限流类别与时间戳

**Given** 用户提交验证码登录请求且验证码有效
**When** 系统校验验证码（未过期、未使用）
**Then** 系统签发 access token 与 refresh token
**And** 该验证码标记为已使用，不可重复登录

**Given** 验证码错误、过期或已使用
**When** 用户提交验证码登录
**Then** 系统拒绝登录并返回统一外显失败语义
**And** 服务端日志保留细分失败原因用于审计与排障

### Story 1.4: 双入口域识别与组织选择/切换

As a 多组织用户,
I want 系统根据入口识别访问域，并在登录后支持组织选择与会话内切换,
So that 我能在正确域上下文进入工作台并减少误入与越域操作。
**FRs:** FR6, FR7, FR8, FR9, FR68

**Acceptance Criteria:**

**Given** 用户从平台入口或组织入口发起登录
**When** 登录成功
**Then** 系统按入口识别并绑定目标访问域（platform/tenant）
**And** 若无对应域有效权限则拒绝进入并返回 `AUTH-403-NO-DOMAIN`

**Given** 用户在组织域存在多个有效组织关系
**When** 登录成功进入组织域
**Then** 系统展示组织选择页并要求用户选择目标组织后进入工作台
**And** 选择结果进入服务端会话上下文用于后续鉴权

**Given** 用户在组织域仅有一个有效组织关系
**When** 登录成功
**Then** 系统可直接进入该组织工作台
**And** 会话中仍提供“切换组织”入口并可回到组织选择页

**Given** 用户在会话内切换组织
**When** 选择新的目标组织
**Then** 系统更新会话中的组织上下文并即时生效
**And** 页面权限可见性与可操作性按新组织权限重算

### Story 1.5: 菜单/按钮/API 访问控制与统一拒绝语义

As a 平台或组织用户,
I want 系统基于有效权限同时控制菜单、按钮和受保护 API,
So that 前后端权限语义一致，不会出现“看得见但不能做”或“越权放行”。
**FRs:** FR27, FR28, FR72, FR73

**Acceptance Criteria:**

**Given** 用户登录并进入任一域工作台
**When** 前端渲染导航与页面操作区
**Then** 系统仅展示用户有权访问的菜单与按钮
**And** 不可访问能力不渲染或置灰且行为一致

**Given** 用户调用受保护 API 且具备权限声明对应权限
**When** 请求到达服务端
**Then** 服务端允许请求并返回成功结果
**And** 权限判定基于服务端有效会话与权限快照执行

**Given** 用户调用受保护 API 但无对应权限
**When** 请求到达服务端
**Then** 服务端统一拒绝并返回标准错误码与问题详情结构
**And** 拒绝结果可被前端映射为统一可理解提示

**Given** 某受保护接口缺失权限声明
**When** 执行启动自检或发布门禁
**Then** 系统判定为失败并阻断运行/发布
**And** 输出缺失声明接口清单供修复

### Story 1.6: 双域权限边界与服务端租户最终判定

As a 平台与组织治理操作者,
I want 平台域与组织域权限命名空间强隔离，并由服务端最终判定租户上下文,
So that 系统可以稳定防止跨域越权与伪造租户上下文访问。
**FRs:** FR26, FR29, FR31, FR49, FR51, FR70

**Acceptance Criteria:**

**Given** 平台域权限与组织域权限并存
**When** 用户在平台域执行操作
**Then** 系统仅使用 platform 命名空间权限参与判定
**And** tenant 命名空间权限不会提升平台域访问能力

**Given** 用户在组织域执行操作
**When** 请求携带组织上下文
**Then** 系统仅信任服务端确认的有效租户上下文进行最终鉴权
**And** 对客户端伪造租户标识的请求一律拒绝

**Given** 用户仅具平台身份且无组织成员关系
**When** 用户尝试进入组织工作台或访问组织域接口
**Then** 系统拒绝访问并返回统一错误语义
**And** 不会因为平台高权限而越过组织域边界

**Given** 角色状态或授权关系发生变化
**When** 用户再次访问受保护能力
**Then** 系统按最新有效权限进行判定
**And** 禁用角色不参与权限计算

**Given** 平台用户被分配多个平台角色
**When** 系统计算平台域有效权限
**Then** 按角色权限并集得到最终可访问能力
**And** 不使用显式 deny 规则覆盖并集结果

**Given** 用户仅具组织身份且无平台域权限
**When** 用户尝试进入平台工作台或访问平台域接口
**Then** 系统拒绝访问并返回统一错误语义
**And** 不会因为组织高权限而越过平台域边界

**Given** 组织用户在同一组织被分配多个组织角色
**When** 系统计算该组织下有效权限
**Then** 按组织角色权限并集得到最终可访问能力
**And** 不使用显式 deny 规则覆盖并集结果

**Given** 平台域权限与组织域权限并存
**When** 用户在组织域执行操作
**Then** 系统仅使用 tenant 命名空间权限参与判定
**And** platform 命名空间权限不会提升组织域访问能力

### Story 1.7: Refresh Rotation、重放识别与并发会话策略

As a 系统安全治理方,
I want refresh token 轮换、重放识别与并发会话策略统一生效,
So that 认证链路在高风险场景下仍可保持安全一致性与可恢复性。
**FRs:** FR53, FR67

**Acceptance Criteria:**

**Given** 用户使用有效 refresh token 刷新会话
**When** 刷新请求成功
**Then** 系统签发新的 refresh token 并立即使旧 token 失效
**And** 新旧 token 关系可追踪用于审计

**Given** 已失效或已使用的 refresh token 被再次提交
**When** 系统收到刷新请求
**Then** 系统识别为重放行为并拒绝请求
**And** 返回统一错误码并记录安全事件

**Given** 同一用户存在多个并发会话
**When** 其中一个会话执行刷新或登出
**Then** 仅影响当前会话 token 链路
**And** 其他并发会话保持有效

**Given** 重放或异常刷新事件发生
**When** 安全审计系统接收事件
**Then** 事件包含用户标识、会话标识、request_id 与发生时间
**And** 可用于后续告警与排障追踪

### Story 1.8: 关键状态变更触发 session_version 会话收敛

As a 平台安全治理方,
I want 在身份/权限关键状态变化后通过 session_version 使历史会话失效,
So that 系统可以确保权限变更即时收敛，避免旧会话继续越权访问。
**FRs:** FR30, FR50, FR79

**Acceptance Criteria:**

**Given** 用户角色、权限绑定或账户关键状态发生变更
**When** 变更事务提交成功
**Then** 系统递增对应主体的 session_version
**And** 该版本变化可在后续鉴权链路读取并生效

**Given** 用户持有变更前签发的旧会话 token
**When** 用户访问任一受保护接口
**Then** 服务端识别 session_version 不匹配并拒绝访问
**And** 返回统一未授权响应与标准错误语义

**Given** 关键状态变更后用户重新登录或刷新成功
**When** 新会话建立
**Then** 新会话绑定最新 session_version
**And** 后续访问按最新权限正常放行

### Story 1.9: 默认密码策略与用户创建一致性

As a 平台治理操作者,
I want 新建用户与导入既有用户遵循统一默认密码与安全存储规则,
So that 用户开通流程可控且不破坏既有账号安全状态。
**FRs:** FR59, FR60, FR61

**Acceptance Criteria:**

**Given** 创建系统内不存在的手机号用户
**When** 平台或组织侧发起创建
**Then** 系统按默认密码策略初始化账号
**And** 仅保存密码哈希，不保存明文密码

**Given** 将已存在手机号用户加入平台或组织
**When** 创建流程完成
**Then** 系统保持该用户原密码不变
**And** 新增关系只影响成员/角色绑定，不影响原认证凭据

**Given** 新建用户首次登录
**When** 用户使用初始化凭据完成登录
**Then** 系统统一不强制改密并允许进入正常会话流程
**And** 错误与成功提示采用统一语义

### Story 1.10: 认证错误码与可重试语义统一映射

As a 前后端协作开发者,
I want 认证与鉴权失败返回统一错误码和 retryable 语义,
So that 前端可以稳定映射动作，运维可以快速定位问题。
**FRs:** FR9, FR52, FR62, FR63, FR69, FR80

**Acceptance Criteria:**

**Given** 认证或鉴权链路出现失败
**When** 服务端返回错误响应
**Then** 响应采用统一错误码体系与 Problem Details 结构
**And** 包含可重试语义分层字段供前端动作映射

**Given** 密码错误、验证码错误、验证码过期或已使用
**When** 用户收到失败提示
**Then** 外显文案遵循统一口径
**And** 服务端日志保留细分失败原因用于审计

**Given** 认证接口触发限流
**When** 返回超限响应
**Then** 返回标准限流错误码
**And** 前端可基于错误码展示一致反馈与引导

**Given** 客户端对关键写接口携带幂等键并重复提交请求
**When** 重复请求在幂等窗口内到达
**Then** 系统返回与首次请求一致的结果语义
**And** 不产生重复写入副作用

**Layered Acceptance Groups（全部通过才视为完成）：**

- Layer A（FR9, FR80）：Problem Details + 统一错误码契约完整性
- Layer B（FR62, FR63）：认证限流反馈与前端动作映射一致性
- Layer C（FR52, FR69）：关键写接口幂等重复请求一致语义

**Given** 认证与鉴权契约回归执行
**When** Layer A 用例运行
**Then** 错误结构与错误码通过契约校验
**And** 未通过项阻断 Story 完成

**Given** 认证限流场景回归执行
**When** Layer B 用例运行
**Then** 限流错误码与反馈映射符合预期
**And** 未通过项阻断 Story 完成

**Given** 幂等重复提交场景回归执行
**When** Layer C 用例运行
**Then** 重复请求返回一致结果且无重复写入
**And** 未通过项阻断 Story 完成

## Epic 2: 平台治理与组织开通

平台管理员可以完成组织开通、平台成员与平台角色治理，确保新平台成员可进入平台并执行授权动作。

### Story 2.1: 组织创建与初始负责人校验

As a 平台管理员,
I want 创建组织时必须提交初始管理员手机号,
So that 每个组织在创建后都可被立即治理与接管。
**FRs:** FR10, FR64

**Acceptance Criteria:**

**Given** 平台管理员发起创建组织
**When** 未提交初始管理员手机号
**Then** 系统拒绝创建
**And** 返回标准错误码与可理解提示

**Given** 平台管理员提交有效组织信息与初始管理员手机号
**When** 创建请求成功
**Then** 系统创建组织并建立负责人治理关系
**And** 组织进入可管理状态

**Given** 创建过程中涉及用户身份复用
**When** 初始管理员手机号已存在用户身份
**Then** 系统复用既有用户身份
**And** 不重复创建全局用户账号

### Story 2.2: 组织状态治理（启用/禁用）

As a 平台管理员,
I want 维护组织启用与禁用状态,
So that 我可以对组织可用性进行平台级治理。
**FRs:** FR11

**Acceptance Criteria:**

**Given** 目标组织当前为启用状态
**When** 平台管理员执行禁用
**Then** 组织状态更新为禁用
**And** 组织域（`tenant`）访问按规则受限，平台域（`platform`）不受影响

**Given** 目标组织当前为禁用状态
**When** 平台管理员执行启用
**Then** 组织状态更新为启用
**And** 符合权限的成员可恢复组织域（`tenant`）访问，平台域（`platform`）保持原状态

**Given** 状态变更发生
**When** 请求完成
**Then** 变更记录进入审计
**And** 返回统一成功/失败语义

### Story 2.3: 平台用户创建与状态管理

As a 平台管理员,
I want 创建平台用户并维护其可用状态,
So that 平台治理团队可以持续维护操作人员池。
**FRs:** FR13, FR14

**Acceptance Criteria:**

**Given** 平台管理员提交新平台用户信息
**When** 创建请求通过校验
**Then** 系统创建或复用用户身份并建立平台成员关系
**And** 返回可追踪的用户标识

**Given** 平台用户处于启用状态
**When** 管理员将其禁用
**Then** 用户状态立即变为禁用
**And** 禁用后平台域（`platform`）权限计算即时失效，组织域（`tenant`）不受影响

**Given** 平台用户处于禁用状态
**When** 管理员重新启用
**Then** 用户状态恢复可用
**And** 平台域（`platform`）权限按当前绑定重新生效，组织域（`tenant`）保持原状态

### Story 2.4: 平台角色管理与受保护角色约束

As a 平台管理员,
I want 管理平台角色并保护系统关键角色不被编辑或删除,
So that 平台权限模型既可演进又不破坏安全基线。
**FRs:** FR15, FR66

**Acceptance Criteria:**

**Given** 平台管理员管理普通平台角色
**When** 执行创建、编辑、删除
**Then** 系统按规则允许操作
**And** 保持角色编码唯一与可追踪

**Given** 管理员尝试编辑或删除受保护系统角色
**When** 请求到达服务端
**Then** 系统拒绝操作
**And** 返回标准错误码与说明

**Given** 受保护角色仅允许授权分配
**When** 管理员执行分配流程
**Then** 系统允许分配到符合条件用户
**And** 不允许修改该角色定义本身

### Story 2.5: 平台权限树配置与角色分配生效

As a 平台管理员,
I want 配置平台角色权限树并向平台用户分配角色,
So that 新老平台成员都能在授权范围内执行操作。
**FRs:** FR16, FR17, FR18

**Acceptance Criteria:**

**Given** 平台管理员编辑角色权限树
**When** 保存权限配置
**Then** 系统持久化最终授权结果
**And** 权限变更可被后续鉴权即时读取

**Given** 平台管理员向用户分配 1 到 5 个平台角色
**When** 分配请求通过校验
**Then** 系统完成角色绑定
**And** 用户有效权限按并集模型重算

**Given** 新增平台成员已完成角色分配
**When** 该成员登录平台入口
**Then** 成员可以进入平台并执行授权范围内动作
**And** 超出权限范围操作被一致拒绝

### Story 2.6: 平台侧负责人变更入口

As a 平台管理员,
I want 在平台侧发起组织负责人变更,
So that 组织治理责任可以被安全移交，并与 Epic 3 的接管闭环通过明确契约衔接。
**FRs:** FR12

**Acceptance Criteria:**

**Given** 平台管理员具备负责人变更权限
**When** 发起负责人变更请求
**Then** 系统进入受控变更流程
**And** 变更结果返回可识别状态

**Given** 负责人变更请求不满足前置条件
**When** 系统校验失败
**Then** 系统拒绝变更
**And** 返回标准错误码与可恢复提示

**Given** Story 2.6 已进入交付验收
**When** 评估本故事完成边界
**Then** 本故事仅交付平台侧发起入口与请求校验能力
**And** 不承诺在 Epic 2 内完成接管闭环能力

**Given** 平台侧发起负责人变更请求
**When** 进入跨 Epic 协作链路
**Then** 输出固定契约字段：`request_id`、`org_id`、`old_owner_user_id`、`new_owner_user_id`、`result_status`、`error_code`、`retryable`
**And** 并发冲突返回可识别冲突语义并支持安全重试

**Given** 负责人变更请求全链路执行
**When** 关键节点发生状态变化
**Then** 审计最小事件集必须完整：发起、校验失败、冲突、成功提交
**And** 自动入组/自动授权/接管完成能力在 Epic 3 对应故事验收，不在 Story 2.6 内实现

### Story 2.7: 平台治理前端工作台（平台用户管理 + 平台角色管理）

As a 平台管理员,
I want 在平台入口使用统一治理工作台完成平台用户与平台角色管理,
So that 平台治理能力可以在前端完整落地并可直接验收。
**FRs:** FR13, FR14, FR15, FR16, FR17, FR18, FR27

**Acceptance Criteria:**

**Given** 平台管理员进入平台工作台并打开“平台用户管理”
**When** 执行列表、筛选、分页、创建与状态切换
**Then** 前端完成对应治理操作并返回可追踪结果
**And** 新建/编辑使用 Modal，详情使用 Drawer

**Given** 平台管理员进入“平台角色管理”
**When** 执行角色创建、编辑、删除（受保护角色除外）
**Then** 前端与服务端约束保持一致
**And** 受保护角色仅允许授权分配，不允许修改角色定义

**Given** 平台管理员配置平台角色权限树并向平台用户分配 1 到 5 个角色
**When** 保存与分配请求成功
**Then** 用户平台域权限即时生效
**And** 超出权限范围的操作被一致拒绝

**Given** Story 2.7 进入交付验收
**When** 执行真实 Chrome Playwright 前端回归
**Then** 用户管理、角色管理、权限分配关键路径全部通过
**And** 失败项阻断 Story 完成

## Epic 3: 组织治理与负责人安全接管

组织负责人/管理员可以完成成员与角色治理，且在负责人变更与生命周期场景下保持可接管、可恢复、一致性安全。

### Story 3.1: 组织成员管理与身份复用

As a 组织负责人或组织管理员,
I want 在组织内创建与维护成员并复用全局用户身份,
So that 组织人员治理可持续且不产生重复身份。
**FRs:** FR19, FR20, FR32, FR33, FR34

**Acceptance Criteria:**

**Given** 组织管理员新增成员手机号
**When** 手机号已存在全局用户身份
**Then** 系统复用该用户身份创建组织成员关系
**And** 不重复创建用户主档

**Given** 同一用户加入多个组织
**When** 维护其组织关系
**Then** 每个组织拥有独立成员关系与角色绑定
**And** 组织间状态互不污染

**Given** 成员被离组后再次加入
**When** 重新入组流程完成
**Then** 系统形成新的有效成员关系
**And** 历史关系保留用于审计追踪

### Story 3.2: 组织角色管理

As a 组织负责人或组织管理员,
I want 创建和维护组织角色,
So that 组织内权限模型能贴合业务分工。
**FRs:** FR21

**Acceptance Criteria:**

**Given** 组织管理员提交角色创建信息
**When** 校验通过
**Then** 系统创建组织角色
**And** 角色可用于后续授权分配

**Given** 组织管理员编辑或删除普通组织角色
**When** 请求符合约束
**Then** 系统允许操作
**And** 变更记录进入审计

**Given** 角色处于禁用或删除条件不满足
**When** 请求不合法
**Then** 系统拒绝操作
**And** 返回标准错误信息

### Story 3.3: 组织权限树与成员角色分配

As a 组织负责人或组织管理员,
I want 配置组织角色权限树并给成员分配 1 到 5 个角色,
So that 成员在组织内获得精确且可控的权限。
**FRs:** FR22, FR23

**Acceptance Criteria:**

**Given** 组织管理员配置角色权限树
**When** 保存配置
**Then** 系统保存最终授权结果
**And** 前端可保持父子联动展示一致

**Given** 管理员为成员分配 1 到 5 个组织角色
**When** 分配请求成功
**Then** 系统建立成员角色绑定
**And** 成员权限按当前有效角色即时重算

**Given** 成员角色被禁用或移除
**When** 成员访问受保护能力
**Then** 系统按最新权限判定
**And** 无权限访问被一致拒绝

### Story 3.4: 组织成员资料维护

As a 组织负责人或组织管理员,
I want 维护成员组织内资料（显示名、部门等）, 
So that 成员信息在组织治理中保持准确可用。
**FRs:** FR24

**Acceptance Criteria:**

**Given** 管理员提交成员资料更新
**When** 字段校验通过
**Then** 系统保存组织内资料变更
**And** 变更可在列表与详情中一致展示

**Given** 更新请求字段不符合约束
**When** 请求提交
**Then** 系统拒绝并返回字段级错误
**And** 不影响其他已存有效资料

### Story 3.5: 负责人变更后的接管保障

As a 新任组织负责人,
I want 在负责人变更后立即具备最小治理权限并完成接管,
So that 组织治理不会因交接中断。
**FRs:** FR25, FR35, FR65, FR76

**Acceptance Criteria:**

**Given** 负责人变更请求通过前置状态校验
**When** 变更事务提交成功
**Then** 系统完成负责人身份切换
**And** 自动补齐必要成员关系与角色关系

**Given** 新负责人完成切换
**When** 访问组织治理能力
**Then** 新负责人具备最小治理权限并可立即执行管理动作
**And** 旧负责人权限不自动移除（按策略保留）

**Given** 组织状态或新负责人状态不满足前置条件
**When** 发起变更
**Then** 系统拒绝变更
**And** 返回可识别错误码与原因

### Story 3.6: 负责人变更并发冲突与安全重试

As a 平台治理操作者,
I want 负责人变更在并发场景下返回可识别冲突并支持安全重试,
So that 高风险链路可恢复且保持事务一致性。
**FRs:** FR54, FR71

**Acceptance Criteria:**

**Given** 同一组织存在并发负责人变更请求
**When** 请求同时到达
**Then** 系统仅允许一个请求成功
**And** 其余请求返回可识别冲突结果

**Given** 请求因并发冲突失败
**When** 操作者按指引重试
**Then** 系统支持安全重试并保持结果一致
**And** 不产生重复或脏关系写入

**Given** 变更链路执行中发生异常
**When** 事务结束
**Then** 系统满足全成功或全回滚
**And** 审计中可追踪冲突与恢复过程

### Story 3.7: 组织软删除级联一致性

As a 平台治理操作者,
I want 组织软删除后自动失效成员、组织角色与角色绑定,
So that 不会残留可用关系导致安全风险。
**FRs:** FR77

**Acceptance Criteria:**

**Given** 组织被标记软删除
**When** 级联处理触发
**Then** 组织下成员、组织角色与角色绑定同步失效
**And** 不再参与后续权限计算

**Given** 组织被软删除后仍有历史会话
**When** 会话访问组织域资源
**Then** 系统拒绝访问
**And** 返回统一未授权语义

### Story 3.8: 组织治理前端工作台（组织成员管理 + 组织角色管理）

As a 组织负责人或组织管理员,
I want 在组织入口使用统一治理工作台完成成员与角色治理,
So that 组织治理能力在前端形成可执行闭环。
**FRs:** FR19, FR20, FR21, FR22, FR23, FR24, FR27, FR30

**Acceptance Criteria:**

**Given** 组织管理员进入“成员管理”
**When** 执行列表、筛选、分页、新增、状态切换与资料维护
**Then** 前端页面能力与服务端契约一致
**And** 新建/编辑使用 Modal，详情使用 Drawer

**Given** 组织管理员进入“角色管理”
**When** 执行角色创建、编辑、删除与权限树配置
**Then** 权限树仅保存最终授权结果（叶子权限）
**And** 前端保持父子联动展示一致

**Given** 管理员为成员分配 1 到 5 个组织角色
**When** 分配请求成功
**Then** 成员权限按并集即时生效
**And** 越权访问被一致拒绝并可追踪

**Given** Story 3.8 进入交付验收
**When** 执行真实 Chrome Playwright 前端回归
**Then** 成员治理、角色治理、权限分配关键路径全部通过
**And** 失败项阻断 Story 完成

#### Frontend Validation Gate（适用于 Story 2.7 与 Story 3.8）

- 必须在真实 Chrome 下执行 Playwright（非仿真浏览器）。
- 最小覆盖集合必须包含：
  - 列表加载、筛选、分页
  - 新建与编辑（Modal）
  - 详情查看（Drawer）
  - 状态切换与错误语义映射
  - 权限树分配/角色分配（含越权拒绝）
- 门禁失败不得将 Story 标记为 `done`。
- 测试结果必须归档到 implementation artifacts（测试结果与关键日志/截图引用）。

## Epic 4: 审计追踪、系统治理与发布门禁

系统可以提供可追溯审计、受控配置与发布前治理门禁，保证运营可见、可控、可回归。

### Story 4.1: 审计事件记录与按域查询

As a 审计操作者,
I want 系统记录关键治理事件并支持按平台域/组织域查询,
So that 事故追责和排障分析有完整证据链。
**FRs:** FR42, FR43, FR45

**Acceptance Criteria:**

**Given** 认证、授权变更、负责人变更或关键配置变更发生
**When** 事件落库
**Then** 审计记录包含动作主体、对象、时间、结果与 before/after
**And** 记录可按 request_id 关联检索

**Given** 审计操作者按域和条件查询
**When** 执行查询请求
**Then** 系统返回对应域的事件列表
**And** 结果支持分页、筛选与时间范围过滤

### Story 4.2: 请求追踪关联与跨链路可观测

As a 运维与安全团队,
I want 关键业务操作与集成交互共享追踪标识,
So that 可从单次请求快速定位全链路行为。
**FRs:** FR44

**Acceptance Criteria:**

**Given** 任一关键业务请求进入系统
**When** 请求经过内部服务与外部集成链路
**Then** request_id 与 trace 标识全链路透传
**And** 日志、审计、错误响应可相互关联

**Given** 请求跨同步与异步通道
**When** 事件进入队列或回调
**Then** 追踪标识被保留
**And** 可用于后续回放与故障定位

### Story 4.3: 受控系统配置治理

As a 授权操作者,
I want 维护受控系统配置并可审计,
So that 安全策略变更可控且可追踪。
**FRs:** FR46

**Acceptance Criteria:**

**Given** 授权操作者更新受控配置
**When** 配置校验通过
**Then** 系统保存新配置并记录变更审计
**And** 配置生效范围与版本可追踪

**Given** 未授权用户尝试修改受控配置
**When** 请求提交
**Then** 系统拒绝请求
**And** 返回统一权限错误语义

### Story 4.4: 受保护角色约束与角色状态失效

As a 平台治理操作者,
I want 对受保护系统角色实施不可编辑/删除约束，并在角色禁用后权限立即失效,
So that 核心权限模型安全稳定。
**FRs:** FR47, FR75

**Acceptance Criteria:**

**Given** 操作者尝试编辑或删除受保护系统角色
**When** 请求执行
**Then** 系统拒绝操作
**And** 返回标准错误码与原因

**Given** 某角色状态变更为禁用
**When** 变更提交成功
**Then** 该角色不再参与权限计算并立即生效
**And** 历史绑定关系保留用于审计

### Story 4.5: 权限树最终授权落库

As a 权限治理操作者,
I want 权限树保存时仅持久化最终授权结果,
So that 权限数据结构简洁且与判定逻辑一致。
**FRs:** FR74

**Acceptance Criteria:**

**Given** 管理员在权限树上进行父子节点联动操作
**When** 保存权限配置
**Then** 系统仅保存最终授权权限点
**And** 不持久化冗余中间态节点

**Given** 保存后重新加载权限树
**When** 前端展示权限配置
**Then** 可正确还原授权状态
**And** 展示行为与落库数据一致

### Story 4.6: 发布前回归门禁分组报告

As a 发布与运维负责人,
I want 发布前自动输出关键能力回归结果并形成分组报告,
So that 发布质量可验证且未通过能力可直接阻断上线。
**FRs:** FR48

**Acceptance Criteria:**

**Given** 发布流程进入门禁阶段
**When** 执行关键能力回归
**Then** 系统输出按能力分组的结果报告
**And** 未通过门禁则阻断发布

**Given** 发布门禁结果生成完成
**When** 发布负责人审阅门禁报告
**Then** 可按能力分组定位失败项并确定阻断原因
**And** 门禁结果可归档用于发布复盘

### Story 4.7: 用户软删除会话撤销

As a 发布与运维负责人,
I want 在用户软删除时撤销该用户全部 refresh token,
So that 离职/失效账号不会继续持有有效会话。
**FRs:** FR78

**Acceptance Criteria:**

**Given** 用户被软删除
**When** 删除事务完成
**Then** 系统撤销该用户全部 refresh token
**And** 该用户历史会话后续访问被拒绝

**Given** 用户软删除动作执行完成
**When** 审计与追踪链路记录事件
**Then** 可检索到会话撤销结果与 request_id 关联信息
**And** 该链路可用于后续排障与审计取证

## Epic 5: 外部集成互操作与集成发布门禁

授权操作者可以管理外部集成全生命周期，系统可执行契约一致性、版本治理、失败恢复与集成发布门禁。

### Story 5.1: 集成目录与生命周期管理

As a 授权操作者,
I want 维护外部集成目录与生命周期状态,
So that 外部系统接入可管理、可审计、可演进。
**FRs:** FR36, FR37, FR55

**Acceptance Criteria:**

**Given** 授权操作者创建或更新集成配置
**When** 提交方向、协议、鉴权与策略信息
**Then** 系统保存集成规格
**And** 配置变更进入审计记录

**Given** 操作者切换集成生命周期状态
**When** 状态流转请求合法
**Then** 系统完成状态更新
**And** 状态变化对调用策略即时生效

### Story 5.2: 版本化契约交互与兼容管理

As a 集成开发者,
I want 按版本化契约执行外部接口交互并维护兼容策略,
So that 集成升级可控且不破坏现网调用。
**FRs:** FR38, FR40, FR57

**Acceptance Criteria:**

**Given** 系统对接外部 API 或事件协议
**When** 执行接口调用
**Then** 请求与响应遵循声明的版本化契约
**And** 契约版本变更被记录与可追踪

**Given** 引入新接口版本
**When** 执行兼容性评估
**Then** 系统可判定向后兼容状态
**And** 不兼容版本需阻断直接上线

### Story 5.3: 集成变更前契约一致性校验

As a 发布负责人,
I want 在外部集成变更前执行契约一致性校验,
So that 不一致变更在上线前被阻断。
**FRs:** FR41

**Acceptance Criteria:**

**Given** 集成配置或契约发生变更
**When** 进入发布前校验
**Then** 系统执行契约一致性检查
**And** 失败结果阻断发布并输出差异明细

**Given** 契约检查通过
**When** 进入后续发布流程
**Then** 变更可继续执行
**And** 校验结果存档用于审计

### Story 5.4: 失败重试、恢复与再处理闭环

As a 运维负责人,
I want 集成失败后自动重试并支持恢复再处理,
So that 外部依赖波动不会造成持续业务中断。
**FRs:** FR39

**Acceptance Criteria:**

**Given** 外部调用发生可重试失败
**When** 系统执行重试策略
**Then** 按指数退避与抖动重试
**And** 超过阈值进入可追踪失败队列

**Given** 失败请求进入待恢复状态
**When** 操作者执行再处理或人工重放
**Then** 系统可再次投递并记录处理结果
**And** 全过程保留追踪标识与审计证据

### Story 5.5: 集成清单冻结/解冻与门禁分组报告

As a 发布负责人,
I want 在发布窗口执行集成清单冻结/解冻并输出门禁分组报告,
So that 集成发布节奏稳定且风险可控。
**FRs:** FR56, FR58

**Acceptance Criteria:**

**Given** 发布窗口开始
**When** 操作者执行集成清单冻结
**Then** 非授权变更被阻断
**And** 冻结状态可审计与可回滚

**Given** 发布验证完成
**When** 操作者执行解冻
**Then** 集成配置恢复可变更状态
**And** 保留冻结/解冻完整审计轨迹

**Given** 回归门禁执行结束
**When** 输出验证结果
**Then** 系统按能力分组生成结果报告
**And** 报告可用于发布决策与复盘归档
