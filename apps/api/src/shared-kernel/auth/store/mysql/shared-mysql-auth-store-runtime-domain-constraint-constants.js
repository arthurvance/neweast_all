'use strict';

const {
  KNOWN_PLATFORM_PERMISSION_CODES,
  KNOWN_TENANT_PERMISSION_CODES,
  TENANT_USER_MANAGEMENT_VIEW_PERMISSION_CODE,
  TENANT_USER_MANAGEMENT_OPERATE_PERMISSION_CODE,
  TENANT_ROLE_MANAGEMENT_VIEW_PERMISSION_CODE,
  TENANT_ROLE_MANAGEMENT_OPERATE_PERMISSION_CODE,
  ROLE_MANAGEMENT_PERMISSION_CODE_KEY_SET
} = require('../../../../modules/auth/permission-catalog');

const DEFAULT_DEADLOCK_RETRY_CONFIG = Object.freeze({
  maxRetries: 2,
  baseDelayMs: 20,
  maxDelayMs: 200,
  jitterMs: 20
});
const DEFAULT_MAX_ATOMIC_ROLE_PERMISSION_AFFECTED_USERS = 100;
const MYSQL_DUP_ENTRY_ERRNO = 1062;
const CONTROL_CHAR_PATTERN = /[\u0000-\u001F\u007F]/;
const ROLE_ID_ADDRESSABLE_PATTERN = /^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$/;
const VALID_ORG_STATUS = new Set(['active', 'disabled']);
const VALID_PLATFORM_USER_STATUS = new Set(['active', 'disabled']);
const VALID_SYSTEM_SENSITIVE_CONFIG_STATUS = new Set(['active', 'disabled']);
const ALLOWED_SYSTEM_SENSITIVE_CONFIG_KEYS = new Set(['auth.default_password']);
const VALID_PLATFORM_ROLE_CATALOG_STATUS = new Set(['active', 'disabled']);
const VALID_PLATFORM_ROLE_CATALOG_SCOPE = new Set(['platform', 'tenant']);
const VALID_PLATFORM_INTEGRATION_DIRECTION = new Set([
  'inbound',
  'outbound',
  'bidirectional'
]);
const VALID_PLATFORM_INTEGRATION_LIFECYCLE_STATUS = new Set([
  'draft',
  'active',
  'paused',
  'retired'
]);
const VALID_PLATFORM_INTEGRATION_CONTRACT_TYPE = new Set([
  'openapi',
  'event'
]);
const VALID_PLATFORM_INTEGRATION_CONTRACT_STATUS = new Set([
  'candidate',
  'active',
  'deprecated',
  'retired'
]);
const VALID_PLATFORM_INTEGRATION_CONTRACT_EVALUATION_RESULT = new Set([
  'compatible',
  'incompatible'
]);
const VALID_PLATFORM_INTEGRATION_RECOVERY_STATUS = new Set([
  'pending',
  'retrying',
  'succeeded',
  'failed',
  'dlq',
  'replayed'
]);
const VALID_PLATFORM_INTEGRATION_FREEZE_STATUS = new Set([
  'active',
  'released'
]);
const MAX_PLATFORM_INTEGRATION_ID_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_CODE_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_NAME_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_PROTOCOL_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_AUTH_MODE_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_ENDPOINT_LENGTH = 512;
const MAX_PLATFORM_INTEGRATION_BASE_URL_LENGTH = 512;
const MAX_PLATFORM_INTEGRATION_VERSION_STRATEGY_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_RUNBOOK_URL_LENGTH = 512;
const MAX_PLATFORM_INTEGRATION_LIFECYCLE_REASON_LENGTH = 256;
const MAX_PLATFORM_INTEGRATION_CONTRACT_VERSION_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_CONTRACT_SCHEMA_REF_LENGTH = 512;
const MAX_PLATFORM_INTEGRATION_CONTRACT_SCHEMA_CHECKSUM_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_CONTRACT_COMPATIBILITY_NOTES_LENGTH = 4096;
const MAX_PLATFORM_INTEGRATION_CONTRACT_DIFF_SUMMARY_LENGTH = 65535;
const MAX_PLATFORM_INTEGRATION_CONTRACT_REQUEST_ID_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_RECOVERY_ID_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_RECOVERY_IDEMPOTENCY_KEY_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_RECOVERY_FAILURE_CODE_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_RECOVERY_FAILURE_DETAIL_LENGTH = 65535;
const MAX_PLATFORM_INTEGRATION_RECOVERY_TRACEPARENT_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_RECOVERY_REASON_LENGTH = 256;
const MAX_PLATFORM_INTEGRATION_RECOVERY_LIST_LIMIT = 200;
const MAX_PLATFORM_INTEGRATION_FREEZE_ID_LENGTH = 64;
const MAX_PLATFORM_INTEGRATION_FREEZE_REASON_LENGTH = 256;
const MAX_PLATFORM_INTEGRATION_FREEZE_REQUEST_ID_LENGTH = 128;
const MAX_PLATFORM_INTEGRATION_FREEZE_TRACEPARENT_LENGTH = 128;
const MAX_OPERATOR_USER_ID_LENGTH = 64;
const PLATFORM_INTEGRATION_DEFAULT_TIMEOUT_MS = 3000;
const MAX_PLATFORM_INTEGRATION_TIMEOUT_MS = 300000;
const DEFAULT_PLATFORM_INTEGRATION_RECOVERY_CLAIM_LEASE_MS = Math.min(
  5 * 60 * 1000,
  MAX_PLATFORM_INTEGRATION_TIMEOUT_MS
);
const VALID_TENANT_MEMBERSHIP_STATUS = new Set(['active', 'disabled', 'left']);
const MAX_TENANT_USER_DISPLAY_NAME_LENGTH = 64;
const MAX_TENANT_USER_DEPARTMENT_NAME_LENGTH = 128;
const MAX_PLATFORM_ROLE_CODE_LENGTH = 64;
const MAX_PLATFORM_ROLE_NAME_LENGTH = 128;
const MAINLAND_PHONE_PATTERN = /^1\d{10}$/;
const KNOWN_PLATFORM_PERMISSION_CODE_SET = new Set(KNOWN_PLATFORM_PERMISSION_CODES);
const KNOWN_TENANT_PERMISSION_CODE_SET = new Set(KNOWN_TENANT_PERMISSION_CODES);
const PLATFORM_ROLE_MANAGEMENT_PERMISSION_CODE_SET = ROLE_MANAGEMENT_PERMISSION_CODE_KEY_SET;
const OWNER_TRANSFER_LOCK_TIMEOUT_SECONDS_MAX = 30;
const OWNER_TRANSFER_LOCK_NAME_PREFIX = 'neweast:owner-transfer:';
const OWNER_TRANSFER_TAKEOVER_ROLE_ID_PREFIX = 'sys_admin__';
const OWNER_TRANSFER_TAKEOVER_ROLE_ID_DIGEST_LENGTH = 24;
const OWNER_TRANSFER_TAKEOVER_ROLE_CODE = 'sys_admin';
const OWNER_TRANSFER_TAKEOVER_ROLE_NAME = '管理员';
const OWNER_TRANSFER_TAKEOVER_REQUIRED_PERMISSION_CODES = Object.freeze([
  TENANT_USER_MANAGEMENT_VIEW_PERMISSION_CODE,
  TENANT_USER_MANAGEMENT_OPERATE_PERMISSION_CODE,
  TENANT_ROLE_MANAGEMENT_VIEW_PERMISSION_CODE,
  TENANT_ROLE_MANAGEMENT_OPERATE_PERMISSION_CODE
]);
const AUDIT_EVENT_ALLOWED_DOMAINS = new Set(['platform', 'tenant']);
const AUDIT_EVENT_ALLOWED_RESULTS = new Set(['success', 'rejected', 'failed']);
const AUDIT_EVENT_REDACTION_KEY_PATTERN =
  /(password|token|secret|credential|private[_-]?key|access[_-]?key|api[_-]?key|signing[_-]?key)/i;
const AUDIT_EVENT_REDACTION_COUNT_KEY_PATTERN = /_count$/i;
const MAX_AUDIT_QUERY_PAGE_SIZE = 200;
const MYSQL_AUDIT_DATETIME_PATTERN =
  /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,6}))?$/;

module.exports = {
  DEFAULT_DEADLOCK_RETRY_CONFIG,
  DEFAULT_MAX_ATOMIC_ROLE_PERMISSION_AFFECTED_USERS,
  MYSQL_DUP_ENTRY_ERRNO,
  CONTROL_CHAR_PATTERN,
  ROLE_ID_ADDRESSABLE_PATTERN,
  VALID_ORG_STATUS,
  VALID_PLATFORM_USER_STATUS,
  VALID_SYSTEM_SENSITIVE_CONFIG_STATUS,
  ALLOWED_SYSTEM_SENSITIVE_CONFIG_KEYS,
  VALID_PLATFORM_ROLE_CATALOG_STATUS,
  VALID_PLATFORM_ROLE_CATALOG_SCOPE,
  VALID_PLATFORM_INTEGRATION_DIRECTION,
  VALID_PLATFORM_INTEGRATION_LIFECYCLE_STATUS,
  VALID_PLATFORM_INTEGRATION_CONTRACT_TYPE,
  VALID_PLATFORM_INTEGRATION_CONTRACT_STATUS,
  VALID_PLATFORM_INTEGRATION_CONTRACT_EVALUATION_RESULT,
  VALID_PLATFORM_INTEGRATION_RECOVERY_STATUS,
  VALID_PLATFORM_INTEGRATION_FREEZE_STATUS,
  MAX_PLATFORM_INTEGRATION_ID_LENGTH,
  MAX_PLATFORM_INTEGRATION_CODE_LENGTH,
  MAX_PLATFORM_INTEGRATION_NAME_LENGTH,
  MAX_PLATFORM_INTEGRATION_PROTOCOL_LENGTH,
  MAX_PLATFORM_INTEGRATION_AUTH_MODE_LENGTH,
  MAX_PLATFORM_INTEGRATION_ENDPOINT_LENGTH,
  MAX_PLATFORM_INTEGRATION_BASE_URL_LENGTH,
  MAX_PLATFORM_INTEGRATION_VERSION_STRATEGY_LENGTH,
  MAX_PLATFORM_INTEGRATION_RUNBOOK_URL_LENGTH,
  MAX_PLATFORM_INTEGRATION_LIFECYCLE_REASON_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_VERSION_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_SCHEMA_REF_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_SCHEMA_CHECKSUM_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_COMPATIBILITY_NOTES_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_DIFF_SUMMARY_LENGTH,
  MAX_PLATFORM_INTEGRATION_CONTRACT_REQUEST_ID_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_ID_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_IDEMPOTENCY_KEY_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_FAILURE_CODE_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_FAILURE_DETAIL_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_TRACEPARENT_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_REASON_LENGTH,
  MAX_PLATFORM_INTEGRATION_RECOVERY_LIST_LIMIT,
  MAX_PLATFORM_INTEGRATION_FREEZE_ID_LENGTH,
  MAX_PLATFORM_INTEGRATION_FREEZE_REASON_LENGTH,
  MAX_PLATFORM_INTEGRATION_FREEZE_REQUEST_ID_LENGTH,
  MAX_PLATFORM_INTEGRATION_FREEZE_TRACEPARENT_LENGTH,
  MAX_OPERATOR_USER_ID_LENGTH,
  PLATFORM_INTEGRATION_DEFAULT_TIMEOUT_MS,
  MAX_PLATFORM_INTEGRATION_TIMEOUT_MS,
  DEFAULT_PLATFORM_INTEGRATION_RECOVERY_CLAIM_LEASE_MS,
  VALID_TENANT_MEMBERSHIP_STATUS,
  MAX_TENANT_USER_DISPLAY_NAME_LENGTH,
  MAX_TENANT_USER_DEPARTMENT_NAME_LENGTH,
  MAX_PLATFORM_ROLE_CODE_LENGTH,
  MAX_PLATFORM_ROLE_NAME_LENGTH,
  MAINLAND_PHONE_PATTERN,
  KNOWN_PLATFORM_PERMISSION_CODE_SET,
  KNOWN_TENANT_PERMISSION_CODE_SET,
  PLATFORM_ROLE_MANAGEMENT_PERMISSION_CODE_SET,
  OWNER_TRANSFER_LOCK_TIMEOUT_SECONDS_MAX,
  OWNER_TRANSFER_LOCK_NAME_PREFIX,
  OWNER_TRANSFER_TAKEOVER_ROLE_ID_PREFIX,
  OWNER_TRANSFER_TAKEOVER_ROLE_ID_DIGEST_LENGTH,
  OWNER_TRANSFER_TAKEOVER_ROLE_CODE,
  OWNER_TRANSFER_TAKEOVER_ROLE_NAME,
  OWNER_TRANSFER_TAKEOVER_REQUIRED_PERMISSION_CODES,
  AUDIT_EVENT_ALLOWED_DOMAINS,
  AUDIT_EVENT_ALLOWED_RESULTS,
  AUDIT_EVENT_REDACTION_KEY_PATTERN,
  AUDIT_EVENT_REDACTION_COUNT_KEY_PATTERN,
  MAX_AUDIT_QUERY_PAGE_SIZE,
  MYSQL_AUDIT_DATETIME_PATTERN
};
