#!/usr/bin/env node

const fs = require('node:fs');
const path = require('node:path');
const {
  listPlatformPermissionCatalogItems,
  listTenantPermissionCatalogItems
} = require('../../api/src/modules/auth/permission-catalog');

const OUTPUT_FILE = path.resolve(
  __dirname,
  '../src/features/auth/generated-permission-catalog.js'
);
const TENANT_PERMISSION_CATALOG_EXTENSIONS = Object.freeze([
  {
    code: 'tenant.account_management.view',
    scope: 'tenant',
    group_key: 'account_management',
    action_key: 'view',
    label_key: 'permission.tenant.account_management.view',
    order: 310,
    assignable: true
  },
  {
    code: 'tenant.account_management.operate',
    scope: 'tenant',
    group_key: 'account_management',
    action_key: 'operate',
    label_key: 'permission.tenant.account_management.operate',
    order: 320,
    assignable: true
  }
]);

const normalizeCatalogItem = (item = {}) => ({
  code: String(item.code || '').trim().toLowerCase(),
  scope: String(item.scope || '').trim().toLowerCase(),
  group_key: String(item.group_key || '').trim().toLowerCase(),
  action_key: String(item.action_key || '').trim().toLowerCase(),
  label_key: String(item.label_key || '').trim(),
  order: Number.isFinite(Number(item.order)) ? Number(item.order) : 0,
  assignable: Boolean(item.assignable)
});

const toGroupActionMap = ({ catalogItems = [], scope }) => {
  const normalizedScope = String(scope || '').trim().toLowerCase();
  const map = {};

  for (const item of catalogItems) {
    if (item.scope !== normalizedScope) {
      continue;
    }
    if (!item.group_key || !item.action_key || !item.code) {
      continue;
    }
    if (!Object.prototype.hasOwnProperty.call(map, item.group_key)) {
      map[item.group_key] = {};
    }
    map[item.group_key][item.action_key] = item.code;
  }

  const sortedMap = {};
  for (const groupKey of Object.keys(map).sort((left, right) => left.localeCompare(right))) {
    const actions = map[groupKey] || {};
    sortedMap[groupKey] = {};
    for (const actionKey of Object.keys(actions).sort((left, right) => left.localeCompare(right))) {
      sortedMap[groupKey][actionKey] = actions[actionKey];
    }
  }

  return sortedMap;
};

const serialize = (value) => JSON.stringify(value, null, 2);
const mergeCatalogItemsByCode = ({ baseItems = [], extensionItems = [] }) => {
  const mergedByCode = new Map();
  for (const item of [...baseItems, ...extensionItems]) {
    const normalizedItem = normalizeCatalogItem(item);
    if (!normalizedItem.code) {
      continue;
    }
    mergedByCode.set(normalizedItem.code, normalizedItem);
  }
  return [...mergedByCode.values()].sort((left, right) => {
    if (left.order !== right.order) {
      return left.order - right.order;
    }
    return left.code.localeCompare(right.code);
  });
};

const main = () => {
  const platformCatalogItems = mergeCatalogItemsByCode({
    baseItems: listPlatformPermissionCatalogItems({
      includeUnassignable: true
    })
  });
  const tenantCatalogItems = mergeCatalogItemsByCode({
    baseItems: listTenantPermissionCatalogItems({
      includeTenantContextCodes: true,
      includeUnassignable: true
    }),
    extensionItems: TENANT_PERMISSION_CATALOG_EXTENSIONS
  });

  const platformPermissionCodeByGroupAction = toGroupActionMap({
    catalogItems: platformCatalogItems,
    scope: 'platform'
  });
  const tenantPermissionCodeByGroupAction = toGroupActionMap({
    catalogItems: tenantCatalogItems,
    scope: 'tenant'
  });

  const fileContent = `// AUTO-GENERATED FILE. DO NOT EDIT.
// Generated by: apps/web/scripts/sync-permission-catalog.cjs

const deepFreeze = (value) => {
  if (!value || typeof value !== 'object' || Object.isFrozen(value)) {
    return value;
  }
  Object.freeze(value);
  for (const nextValue of Object.values(value)) {
    deepFreeze(nextValue);
  }
  return value;
};

export const PLATFORM_PERMISSION_CATALOG_ITEMS = deepFreeze(${serialize(platformCatalogItems)});

export const TENANT_PERMISSION_CATALOG_ITEMS = deepFreeze(${serialize(tenantCatalogItems)});

export const PLATFORM_PERMISSION_CODE_BY_GROUP_ACTION = deepFreeze(${serialize(platformPermissionCodeByGroupAction)});

export const TENANT_PERMISSION_CODE_BY_GROUP_ACTION = deepFreeze(${serialize(tenantPermissionCodeByGroupAction)});
`;

  fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
  fs.writeFileSync(OUTPUT_FILE, fileContent, 'utf8');
  process.stdout.write(`permission catalog synced -> ${OUTPUT_FILE}\n`);
};

main();
